<!doctype html>
<html itemscope itemtype="http://schema.org/WebPage" lang="cn" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.115.2">
<link rel="canonical" type="text/html" href="https://bwangel.me/647/docs/">
<link rel="alternate" type="application/rss&#43;xml" href="https://bwangel.me/647/docs/index.xml">
<meta name="robots" content="noindex, nofollow">


<link rel="shortcut icon" href="/647/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/647/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/647/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/647/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/647/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/647/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/647/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/647/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/647/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/647/favicons/android-192x192.png" sizes="192x192">

<title>Documentation | 647 Universe</title>
<meta name="description" content="宇宙很大，生活更大，也许以后还有缘相见">
<meta property="og:title" content="Documentation" />
<meta property="og:description" content="宇宙很大，生活更大，也许以后还有缘相见" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://bwangel.me/647/docs/" /><meta property="og:site_name" content="647号宇宙" />
<meta itemprop="name" content="Documentation">
<meta itemprop="description" content="宇宙很大，生活更大，也许以后还有缘相见"><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Documentation"/>
<meta name="twitter:description" content="宇宙很大，生活更大，也许以后还有缘相见"/>




<link rel="preload" href="/647/scss/main.min.291c723daa8f2fb6b09f56ac9a2ca71406607a4268e1fe586dddad1a8583b4e7.css" as="style">
<link href="/647/scss/main.min.291c723daa8f2fb6b09f56ac9a2ca71406607a4268e1fe586dddad1a8583b4e7.css" rel="stylesheet" integrity="">

<script
  src="https://code.jquery.com/jquery-3.6.3.min.js"
  integrity="sha512-STof4xm1wgkfm7heWqFJVn58Hm3EtS31XFaagaa8VMReCXAkQnJZ+jEy8PCC/iT18dFy95WcExNHFTqLyp72eQ=="
  crossorigin="anonymous"></script>
<link rel="stylesheet" href="/647/css/prism.css"/>

  </head>
  <body class="td-section">
    <header>
      <nav class="td-navbar navbar-dark js-navbar-scroll">
<div class="container-fluid flex-column flex-md-row">
  <a class="navbar-brand" href="/647/"><span class="navbar-brand__logo navbar-logo"><svg id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 500 500" style="enable-background:new 0 0 500 500"><g><path style="fill:#fff" d="M116.8525 421.9722c-5.7041.0-10.3442-4.3127-10.3442-9.6129V88.183c0-5.3002 4.6401-9.6117 10.3442-9.6117H320.858c3.0347.0 9.3959.5498 11.7506 2.6302l.3545.3442 58.905 63.2912c2.3101 2.491 2.9202 8.4928 2.9202 11.3184v256.2039c0 5.3002-4.6407 9.6129-10.3436 9.6129H116.8525z"/><g><g><g><path style="fill:#767676" d="M384.4445 423.2066H116.852c-6.3839.0-11.5786-4.8658-11.5786-10.8474V88.1831c0-5.9804 5.1947-10.8461 11.5786-10.8461h204.0062c.377.0 9.2786.0329 12.568 2.9389l.3947.3833 58.9508 63.337c3.2135 3.4652 3.2514 11.7924 3.2514 12.1593v256.2036C396.0231 418.3408 390.8284 423.2066 384.4445 423.2066zM116.5079 411.9189c.0848.0278.1999.0531.3441.0531h267.5925c.1442.0.2581-.0253.3441-.0531V156.1556c-.0076-.9033-.3593-3.7347-.7034-5.0037l-57.6527-61.9416c-1.4651-.3176-4.4533-.6389-5.5742-.6389H116.852c-.143.0-.2594.024-.3441.0531V411.9189zm267.4533-261.149zM327.0321 89.371v.0013V89.371z"/></g></g></g><g><g><path style="fill:#5b7fc0" d="M189.0874 210.1754l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4473C177.5953 212.627 183.0601 210.1742 189.0874 210.1754zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 234.1722 197.0804 232.033z"/><path style="opacity:.3;fill:#fff" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/><g><defs><path id="SVGID_1_" d="M194.7376 237.6875c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 234.2399 196.1861 236.239 194.7376 237.6875z"/></defs><clipPath id="SVGID_2_"><use xlink:href="#SVGID_1_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_2_);fill:#fff" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/><path style="opacity:.13;clip-path:url(#SVGID_2_);fill:#020202" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/></g><g><defs><path id="SVGID_3_" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/></defs><clipPath id="SVGID_4_"><use xlink:href="#SVGID_3_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_4_);fill:#5b7fc0" d="M172.6595 215.6045c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8475-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 209.1953 176.6171 211.647 172.6595 215.6045z"/></g></g><rect x="198.8952" y="225.1043" style="fill:#5b7fc0" width="122.6266" height="13.8671"/></g><g><path style="fill:#d95140" d="M189.0874 155.7611l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.0249 2.454-11.4897 6.4116-15.4473C177.5953 158.2128 183.0601 155.7599 189.0874 155.7611zm7.993 21.8577c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.2508 181.7667 197.0816 179.758 197.0804 177.6188z"/><path style="opacity:.3;fill:#fff" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/><g><defs><path id="SVGID_5_" d="M194.7376 183.2733c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 179.8256 196.1861 181.8248 194.7376 183.2733z"/></defs><clipPath id="SVGID_6_"><use xlink:href="#SVGID_5_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_6_);fill:#fff" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/><path style="opacity:.13;clip-path:url(#SVGID_6_);fill:#020202" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/></g><g><defs><path id="SVGID_7_" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/></defs><clipPath id="SVGID_8_"><use xlink:href="#SVGID_7_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_8_);fill:#d95140" d="M172.6595 161.1903c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 154.7811 176.6171 157.2327 172.6595 161.1903z"/></g><rect x="198.8952" y="170.69" style="fill:#d95140" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#56a55c" d="M189.5379 264.6147l.0012-.0012c7.7751.0012 15.0294 4.1862 18.932 10.9235 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032-5.8394.0-11.3281-2.2733-15.458-6.4032-4.13-4.13-6.4032-9.6186-6.4056-15.4628.0012-6.0249 2.454-11.4897 6.4116-15.4472C178.0458 267.0663 183.5105 264.6135 189.5379 264.6147zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6538 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.7013 290.6202 197.5321 288.6115 197.5309 286.4723z"/><path style="opacity:.3;fill:#fff" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/><g><defs><path id="SVGID_9_" d="M195.1881 292.1268c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9941 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.5344 288.6792 196.6366 290.6783 195.1881 292.1268z"/></defs><clipPath id="SVGID_10_"><use xlink:href="#SVGID_9_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_10_);fill:#fff" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/><path style="opacity:.13;clip-path:url(#SVGID_10_);fill:#020202" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/></g><g><defs><path id="SVGID_11_" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/></defs><clipPath id="SVGID_12_"><use xlink:href="#SVGID_11_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_12_);fill:#56a55c" d="M173.11 270.0439c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7325-11.1497-10.9151-18.926-10.9151C182.5311 263.6346 177.0676 266.0863 173.11 270.0439z"/></g></g><rect x="199.3456" y="279.5436" style="fill:#56a55c" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#f1bc42" d="M189.0874 318.7208l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3305-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4472C177.5953 321.1724 183.0601 318.7196 189.0874 318.7208zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 342.7176 197.0804 340.5784z"/><path style="opacity:.3;fill:#fff" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/><g><defs><path id="SVGID_13_" d="M194.7376 346.2329c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 342.7853 196.1861 344.7844 194.7376 346.2329z"/></defs><clipPath id="SVGID_14_"><use xlink:href="#SVGID_13_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_14_);fill:#fff" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/><path style="opacity:.13;clip-path:url(#SVGID_14_);fill:#020202" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/></g><g><defs><path id="SVGID_15_" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/></defs><clipPath id="SVGID_16_"><use xlink:href="#SVGID_15_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_16_);fill:#f1bc42" d="M172.6595 324.15c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8474-1.0151-7.6327-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 317.7407 176.6171 320.1924 172.6595 324.15z"/></g></g><rect x="198.8952" y="333.6497" style="fill:#f1bc42" width="122.6266" height="13.8671"/></g></g></svg></span><span class="navbar-brand__name">647 Universe</span></a>
  <div class="td-navbar-nav-scroll ms-md-auto" id="main_navbar">
    <ul class="navbar-nav">
      <li class="nav-item">
        <a class="nav-link active" href="/647/docs/"><span>Docs</span></a>
      </li>
      </ul>
  </div>
  <div class="d-none d-lg-block">
    
  </div>
</div>
</nav>
    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <main class="col-12 col-md-9 col-xl-8 ps-md-5" role="main">
            




<div class="td-content">
<div class="pageinfo pageinfo-primary d-print-none">
<p>

<a href="#" onclick="print();return false;"></a>.
</p><p>
<a href="/647/docs/"></a>.
</p>
</div>



<h1 class="title">Documentation</h1>





    <ul>
    
  
  
  
  

  
    
    
	
<li>1: <a href="#pg-92c27ea962011595550955f7c41b869a">Python</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>1.1: <a href="#pg-3174656f7062052451f0c9f528df376b">Python2 使用 Thrift 为什么会出现 EINTR 错误</a></li>


    
  
    
    
	
<li>1.2: <a href="#pg-8ffc0b133015cfd66db7f485c8157c6b">匹配所有可打印 Ascii 字符的正则</a></li>


    
  
    
    
	
<li>1.3: <a href="#pg-dd6b8c93984d98fe6f8c5851846c88d9">Python Upgrade Importerror</a></li>


    
  
    
    
	
<li>1.4: <a href="#pg-958da66e5791d6c739afd62fdccfea9d">Django的override_settings修饰器浅析</a></li>


    
  
    
    
	
<li>1.5: <a href="#pg-aca9b1506e43349a065aee60cb29920c">Django中import_string的实现</a></li>


    
  

    </ul>
    
  
    
    
	
<li>2: <a href="#pg-06c8412cc3af28159e2513c942e98de4">Life</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>2.1: <a href="#pg-b5975d2a2f61c014357cefc9275fe13f">编程语言很重要</a></li>


    
  
    
    
	
<li>2.2: <a href="#pg-39d58b1f4f522a20e8f96df990ebdab6">如何阅读网络上的小作文</a></li>


    
  

    </ul>
    
  
    
    
	
<li>3: <a href="#pg-3ff1a20d0d0de02c74fbf433a1a36d88">Tools</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>3.1: <a href="#pg-297d99de8aaaafab296dd30fc04b7e20">Mac OSX 使用技巧</a></li>


    
  
    
    
	
<li>3.2: <a href="#pg-5150748bdd00e15c7d1f9160a3f74404">Vagrant 添加挂载目录</a></li>


    
  
    
    
	
<li>3.3: <a href="#pg-0d870642f3ff6fd1df82b10758efa90e">Github 客户端 gh 添加搜索仓库的命令</a></li>


    
  
    
    
	
<li>3.4: <a href="#pg-611e8933475655ab5720b3370081eaf2">Java 抛出UnsupportedEncodingException</a></li>


    
  
    
    
	
<li>3.5: <a href="#pg-9cd99af5426a65caba642cf46c4be99b">Rabbitmq Tutorial 学习笔记</a></li>


    
  

    </ul>
    
  
    
    
	
<li>4: <a href="#pg-52710525e0e85b3607a18dda64e4a590">TCP/IP</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>4.1: <a href="#pg-b18443c3dbf086414f4fb6e642eda08e">混杂模式</a></li>


    
  
    
    
	
<li>4.2: <a href="#pg-2576cf70f23247048e4395173fc49a55">TCP Naggle 算法</a></li>


    
  
    
    
	
<li>4.3: <a href="#pg-989dfb3901123545c6efaa0747a57500">TCP/IP 读书笔记</a></li>


    
  

    </ul>
    
  
    
    
	
<li>5: <a href="#pg-98618c5bda197ea7e031816d02c90466">MySQL</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>5.1: <a href="#pg-1d0f5b011af811d1926541ceaa916c7b">MySQL 修改 root 密码</a></li>


    
  
    
    
	
<li>5.2: <a href="#pg-af7bff7ec8885337795256bace71794f">InnoDB 锁机制</a></li>


    
  
    
    
	
<li>5.3: <a href="#pg-abde27c2366084c3ca6935b6bb833a9e">InnoDB 行记录格式</a></li>


    
  
    
    
	
<li>5.4: <a href="#pg-aff300e3b1167d3a0f03f0927405f9a0">MySQL Character Set support</a></li>


    
  

    </ul>
    
  
    
    
	
<li>6: <a href="#pg-3961477342dbdf6a1d2dee22c35df128">Ubuntu</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>6.1: <a href="#pg-401b386da8551144a94cd399b33e853e">Ubuntu 下 alacritty 终端中安装 nvim-tree 插件</a></li>


    
  
    
    
	
<li>6.2: <a href="#pg-3e581989bbccdb5fda275519f67ba847">Ubuntu 初始化</a></li>


    
  
    
    
	
<li>6.3: <a href="#pg-85ccc389ff28c3fde48540584c68912e">Ubuntu 使用默认的 DNS Server 配置</a></li>


    
  
    
    
	
<li>6.4: <a href="#pg-07ba0697e72dd0ea984005d61f4f73f8">修复 Ubuntu 中 chrome vimium-c 插件失效的问题</a></li>


    
  
    
    
	
<li>6.5: <a href="#pg-828346b319a10bfadd19751af2752ecb">Ubuntu缩小磁盘分区大小</a></li>


    
  

    </ul>
    
  
    
    
	
<li>7: <a href="#pg-871466015f6090c36613870230e285c6">算法</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>7.1: <a href="#pg-9f5dcf38e17fcfeddce9852e9fd7027b">二分查找</a></li>


    
  
    
    
	
<li>7.2: <a href="#pg-21f47c88e34eb924495192f8639a2df6">LeetCode</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>7.2.1: <a href="#pg-5c761828d342b91f1c7dda6244083aee">Leetcode 142: 环形链表 II</a></li>


    
  
    
    
	
<li>7.2.2: <a href="#pg-301653e9504d9bc0694f178fe07fe36e">Leetcode 第343题</a></li>


    
  
    
    
	
<li>7.2.3: <a href="#pg-2a81c7b01891dea88626767b1b355c10">Leetcode 第342题</a></li>


    
  
    
    
	
<li>7.2.4: <a href="#pg-1aeb2a9eda376ee95c011157b6dd23c3">Leetcode 第65题</a></li>


    
  
    
    
	
<li>7.2.5: <a href="#pg-c8534acc911cdb888d719d03fe686713">Leetcode 第2题</a></li>


    
  
    
    
	
<li>7.2.6: <a href="#pg-17e3d91069e260357770bce2053503eb">Leetcode 第3题</a></li>


    
  
    
    
	
<li>7.2.7: <a href="#pg-fa655b923d49cb69e575a767af9184d1">Leetcode 第29题</a></li>


    
  
    
    
	
<li>7.2.8: <a href="#pg-dd111fb175ed5ffbd5348eb2329617bd">Leetcode 第191题</a></li>


    
  
    
    
	
<li>7.2.9: <a href="#pg-99b32d044faa3fce9f3f75a3429e0a8a">Leetcode 第338题</a></li>


    
  
    
    
	
<li>7.2.10: <a href="#pg-080b2406352b570ddfdaa5988aac5880">Leetcode 第151题</a></li>


    
  
    
    
	
<li>7.2.11: <a href="#pg-84ffa092ec053720f155e2f5a14b7b11">Leetcode[258]. Add Digits</a></li>


    
  
    
    
	
<li>7.2.12: <a href="#pg-34baac9a2ee283b8630219993a8f5dfd">Leetcode 第8题</a></li>


    
  
    
    
	
<li>7.2.13: <a href="#pg-e8f4ac0e603f47c82bb66534cf70181c">Leetcode 661题</a></li>


    
  

    </ul>
    
  
    
    
	
<li>7.3: <a href="#pg-1e58c13d4d6af0d346b296fbce0d0972">哈希表学习笔记</a></li>


    
  
    
    
	
<li>7.4: <a href="#pg-bdaba29e3bfa272d95d4990643411484">变态跳台阶问题的解题思路</a></li>


    
  
    
    
	
<li>7.5: <a href="#pg-a0f39954774aeefe139f67aba0845930">Go与数据结构之二叉搜索树</a></li>


    
  
    
    
	
<li>7.6: <a href="#pg-9be646f123e40dbca79fc8fe0683405b">算法复杂度小记</a></li>


    
  

    </ul>
    
  
    
    
	
<li>8: <a href="#pg-b5fadaa3f5f96e8c51757851d7668a4e">Redis</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>8.1: <a href="#pg-452fe98fe10bf583ed0509083a6fa631">Redis 备份恢复的正确步骤</a></li>


    
  
    
    
	
<li>8.2: <a href="#pg-9f184c796063902888d119a9e9dbf239">Redis 主从同步细节</a></li>


    
  
    
    
	
<li>8.3: <a href="#pg-f69785f60caf73840045abeb86206c30">Redis 备份机制</a></li>


    
  
    
    
	
<li>8.4: <a href="#pg-0bff432c35e390c24fb8a4000eb1827a">Redis 集群简介</a></li>


    
  
    
    
	
<li>8.5: <a href="#pg-5e80ba3bff85aef5c731bcf3ecb0922c">Redis 源码阅读之 dict </a></li>


    
  
    
    
	
<li>8.6: <a href="#pg-24908c465f52816f8bd5bc366e5a5645">Redis Sort 命令简介</a></li>


    
  

    </ul>
    
  
    
    
	
<li>9: <a href="#pg-af68ff2ed3e54c426ada6b1cb8e61eaa">Kafka</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>9.1: <a href="#pg-c7b3f27b65643bf045308409a82ca6b8">Consumer</a></li>


    
  
    
    
	
<li>9.2: <a href="#pg-b0db364c520cdda052412caee9f7bb79">Broker</a></li>


    
  
    
    
	
<li>9.3: <a href="#pg-2fabee976deeadba60c4cdb9b8ab43f2">从源码安装 confluent-kafka-python</a></li>


    
  

    </ul>
    
  
    
    
	
<li>10: <a href="#pg-7eb9a6396b5cbd586e9b014377b38023">K8S</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>10.1: <a href="#pg-bd84dd312bc1d349bf04a6cec2f524ce">K8S In Actions</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>10.1.1: <a href="#pg-83a38df0e29a6bce99f61db69b4f4565">11-architecture</a></li>


    
  
    
    
	
<li>10.1.2: <a href="#pg-748bf9642d06918290f08675791b7fee">10-statefulset</a></li>


    
  
    
    
	
<li>10.1.3: <a href="#pg-e4213589dd7386ddf7fc692619b58395">7-configmap-secert</a></li>


    
  
    
    
	
<li>10.1.4: <a href="#pg-b6b4be05877fe20db89592154fb3a5a3">6-volume</a></li>


    
  
    
    
	
<li>10.1.5: <a href="#pg-aaeea77df4520e5dfdc2d4246e2cdb1a">5-service</a></li>


    
  
    
    
	
<li>10.1.6: <a href="#pg-c9372cbe944c20fd9d588bcf483caeef">4-pod-replicaset</a></li>


    
  
    
    
	
<li>10.1.7: <a href="#pg-f304a0762141011be226e59429050213">3-Pod</a></li>


    
  

    </ul>
    
  
    
    
	
<li>10.2: <a href="#pg-78e83ea0e9527f0679f830292a8e4bc6">Pod Tips</a></li>


    
  
    
    
	
<li>10.3: <a href="#pg-7fcccd7bd8aad5aa05b1de7e02521efc">Deployment Tips</a></li>


    
  
    
    
	
<li>10.4: <a href="#pg-aaf94f93d4f526a149b5434d89980c98">K8S 中观察 CPU Throttling 情况的指标</a></li>


    
  
    
    
	
<li>10.5: <a href="#pg-52f25b57aa970b9c8ef121fcdbb83976">进程卡住如何 debug</a></li>


    
  
    
    
	
<li>10.6: <a href="#pg-bb3ef80f413d06f056f401de51d6c418">Review 《How eBPF will solve Service Mesh - Goodbye Sidecars》</a></li>


    
  
    
    
	
<li>10.7: <a href="#pg-ad08524b2d9bf44799deda2288946354">使用 Buildkit 和 Containerd 构建运行容器</a></li>


    
  

    </ul>
    
  
    
    
	
<li>11: <a href="#pg-4aaad1b9f7ee3c127b91ab5b259ce456">Container</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>11.1: <a href="#pg-5dd2bc857390538c171fb56a14e4efb8">Ubuntu 中 Docker 设置容器中 DNS 服务器的地址</a></li>


    
  
    
    
	
<li>11.2: <a href="#pg-ebcaa5066994bddfb13c8bffcd9addae">从 none 开始，用网桥模式启动容器的网络</a></li>


    
  
    
    
	
<li>11.3: <a href="#pg-b711168a3d768a0c419283a9a611a17f">Ubuntu 下安装 Containerd 及配置代理</a></li>


    
  
    
    
	
<li>11.4: <a href="#pg-00dc390d2f975a93f93712be0cac7f2e">Ubuntu 下 Docker 设置 Registry</a></li>


    
  
    
    
	
<li>11.5: <a href="#pg-72ba781c964286a98ded46d175dfee82">Docker 客户端连接远程 Docker Daemon</a></li>


    
  

    </ul>
    
  
    
    
	
<li>12: <a href="#pg-5b8be070e024dee1528ca4106a3ef913">HTTP</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>12.1: <a href="#pg-674980be1abe17a6cece69ef854e0dca">HTTP 协议中带下划线的 header 说明</a></li>


    
  
    
    
	
<li>12.2: <a href="#pg-aed2ff328139f1dc7b767eb1eb9e5077">Nginx proxy_set_header 默认会覆盖上一层的设置</a></li>


    
  
    
    
	
<li>12.3: <a href="#pg-394cadd4f30bcd3b6e1d18482f78d518">如何生成自签名 HTTPS 证书</a></li>


    
  
    
    
	
<li>12.4: <a href="#pg-e441447b9eeecda48a04f52b3f5591d1">HTTP 协议中的分块传输编码</a></li>


    
  
    
    
	
<li>12.5: <a href="#pg-a84e3fde2477368f92e0571415ecdb25">Letsencrypt通过DNS TXT记录来验证域名有效性</a></li>


    
  
    
    
	
<li>12.6: <a href="#pg-b21d7a632564e90b6152ef79c335936f">CentOS 下编译安装 Nginx</a></li>


    
  

    </ul>
    
  
    
    
	
<li>13: <a href="#pg-61067b04bc7fd549be32943b40ec4eac">Prometheus</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>13.1: <a href="#pg-22b5afb7c5e4cb0f2b2c329578af5ecd">Statsd Exporter 如何跳过 prom 的指标检查</a></li>


    
  

    </ul>
    
  
    
    
	
<li>14: <a href="#pg-e5a0a7efb242ec26125e2066bad47362">编码</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>14.1: <a href="#pg-573e3337b8ecb996b3dee636fc080527">ZigZag 变长整数编码</a></li>


    
  

    </ul>
    
  
    
    
	
<li>15: <a href="#pg-0d3382c151725c975fa7e12e83c234f9">WireShark</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>15.1: <a href="#pg-228f2acd9c0ff088f1229559fcdd6503">利用 VirtualBox 和 Ubuntu 22 重现抓包实验</a></li>


    
  

    </ul>
    
  
    
    
	
<li>16: <a href="#pg-fb8915bbd249021082eebe2c7dfd52f0">Golang</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>16.1: <a href="#pg-c374734838a7da2e3834d1091952177f">泛型</a></li>


    
  
    
    
	
<li>16.2: <a href="#pg-8aa7d3f7c05390359a87acf37c95a33b">YAML</a></li>


    
  
    
    
	
<li>16.3: <a href="#pg-52ff3e8194a92d6261809dbeed07036e">Logrus 添加预设字段</a></li>


    
  
    
    
	
<li>16.4: <a href="#pg-16c718411b1484a4cad9a403ef36fc6a">Golang Build 出错: error obtaining VCS status: exit status 128</a></li>


    
  
    
    
	
<li>16.5: <a href="#pg-83df69ae1444d01a6f7c0a195b54857e">pkg/errors 和 go1.13 中 errors 库发展历史</a></li>


    
  
    
    
	
<li>16.6: <a href="#pg-434a02cf1a3ee72f31be04b770f0fabb">Golang 的版本发布计划</a></li>


    
  
    
    
	
<li>16.7: <a href="#pg-3e6373393d3b5fc1fcfcf9263b1f83af">Go gcflags/ldflags 的说明</a></li>


    
  
    
    
	
<li>16.8: <a href="#pg-7635b3151b5123edbeeed45e0cf3d239">Review 《Don’t use Go’s default HTTP client (in production)》</a></li>


    
  
    
    
	
<li>16.9: <a href="#pg-411c7d44b39c2c01f271102f90652135">Go proxy 的说明</a></li>


    
  
    
    
	
<li>16.10: <a href="#pg-e8eaec0059b446cf3655c3f76c3de6b5">Golang 中空数组是否是 nil</a></li>


    
  
    
    
	
<li>16.11: <a href="#pg-5e7f1bf4777000a4a638a29b3b04d48f">Golang 链接时注入额外信息</a></li>


    
  
    
    
	
<li>16.12: <a href="#pg-495e45c0b281c859ecdd31687f35d51b">《Golang Error》学习笔记</a></li>


    
  
    
    
	
<li>16.13: <a href="#pg-6be775a3d57f960eb07e45a142768f29">Go 的调度模型学习笔记</a></li>


    
  
    
    
	
<li>16.14: <a href="#pg-178be9a96e629507fb20f27aff2c9a50">Golang 中的 ServeMux 路由简介</a></li>


    
  
    
    
	
<li>16.15: <a href="#pg-36c9684d6cddd541223c056c73698ec0">Review 《github.com/stretchr/testify》</a></li>


    
  
    
    
	
<li>16.16: <a href="#pg-e9992c55d10cbbee93c95c796a5e0152">Go 并发模式之发布订阅模型</a></li>


    
  
    
    
	
<li>16.17: <a href="#pg-4919bce0c97dc0297f848829c794b4e8">strings.Builder 转换字符串的时候为什么比 bytes.Buffer 要快</a></li>


    
  
    
    
	
<li>16.18: <a href="#pg-e1a7e1284329bbee1f24564b5e0a8a09">Review 《Golang Trick: Export unexport method for test》</a></li>


    
  
    
    
	
<li>16.19: <a href="#pg-933310794a5909e0ef26a5c59969a86e">urfave/cli 学习笔记</a></li>


    
  
    
    
	
<li>16.20: <a href="#pg-635fed7c7f961ced2f2b68e493f04ffb">关于线程同步操作的一道面试题</a></li>


    
  
    
    
	
<li>16.21: <a href="#pg-e7414abf063a165b8718b37f17cb4f2f">Go 调度器的一个无法执行陷阱</a></li>


    
  
    
    
	
<li>16.22: <a href="#pg-fbbcf89e72ac3f247786060b50fa9d08">Go Panic 的触发及恢复过程</a></li>


    
  
    
    
	
<li>16.23: <a href="#pg-4b954ae7a79512193186d57a0ec102ff">线程同步操作面试题使用锁的解法</a></li>


    
  
    
    
	
<li>16.24: <a href="#pg-770a44637da1a99d5af0d32fd0c958e9">Go 的测试</a></li>


    
  
    
    
	
<li>16.25: <a href="#pg-aabb7b6e45359f405fea1a56992f5042">Dependency injection in Golang using higher order functions</a></li>


    
  
    
    
	
<li>16.26: <a href="#pg-c7d2056c34effb010b85e592bf9d77d9">Go 模板</a></li>


    
  
    
    
	
<li>16.27: <a href="#pg-c6e65801f450a5190e19f70c05c579be">Go mod 说明</a></li>


    
  
    
    
	
<li>16.28: <a href="#pg-d5aeefffc066619e66f31549c58e377a">素数生成器</a></li>


    
  
    
    
	
<li>16.29: <a href="#pg-5d60a98a1071c1eb27363bb8fd0863bf">Go 语言的 Type Switch 语句解析</a></li>


    
  
    
    
	
<li>16.30: <a href="#pg-05bc77af5135b5de6472208f6d8b18f0">Go的并发编程简述</a></li>


    
  
    
    
	
<li>16.31: <a href="#pg-9c00886a50ca7b0f720c54623a097403">Go 的反射包浅析</a></li>


    
  
    
    
	
<li>16.32: <a href="#pg-b1b44ecb9640ff866c61f446ee4b46a5">Go 学习笔记</a></li>


    
  

    </ul>
    
  
    
    
	
<li>17: <a href="#pg-f0a22a813c843322c0d360d952e434ce">性能分析</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>17.1: <a href="#pg-38dd3702bb1bcc7da2f55f43923b479a">QPS 和 RT 的关系</a></li>


    
  

    </ul>
    
  
    
    
	
<li>18: <a href="#pg-f65393dbe42ee15e5a5af9e8946cd970">Thrift</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>18.1: <a href="#pg-1af692bb57d127b768eb69b3abc8a667">Thrift golang client 如何设置超时时间</a></li>


    
  
    
    
	
<li>18.2: <a href="#pg-b127652654fb8cc62d6983427adc109f">Thrift 协议学习笔记</a></li>


    
  
    
    
	
<li>18.3: <a href="#pg-1bb16dc0ca8a634867ed72c7e903ba28">Thrft</a></li>


    
  
    
    
	
<li>18.4: <a href="#pg-d3ce439f30c5ecaccd3e7225d6be37c5">翻译《Chapter 1. Introduction to Apache Thrift》</a></li>


    
  

    </ul>
    
  
    
    
	
<li>19: <a href="#pg-e3393de7e8466911640490b15485a33d">规范</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>19.1: <a href="#pg-e0e47e08b609b222268e029cf0817880">日期和时间格式</a></li>


    
  

    </ul>
    
  
    
    
	
<li>20: <a href="#pg-546aa9afbb590e86cfb9df263df9d01c">编辑器</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>20.1: <a href="#pg-e9fb0115d808edb36ba1a3f492e95c4d">Pycharm</a></li>


    
  
    
    
	
<li>20.2: <a href="#pg-79874dcf5fd65d600b8e08e1641d3957">Caps-lock mapping 成 Esc 在 vscode 中不生效</a></li>


    
  

    </ul>
    
  
    
    
	
<li>21: <a href="#pg-5990d373ac824b52e97a76c2b3e2ff2c">Linux</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>21.1: <a href="#pg-1c2b211e34ea807b66d53c40bac236f2">curl</a></li>


    
  
    
    
	
<li>21.2: <a href="#pg-a5f545a950366d730141f62b977f5c24">lsof</a></li>


    
  
    
    
	
<li>21.3: <a href="#pg-69dc1da95bd41a25bf26e181c6ed42e5">DNS</a></li>


    
  
    
    
	
<li>21.4: <a href="#pg-634110a9992b6264c18b7b4beda6f789">在 Ubuntu 22.04 上搭建 NFS Server</a></li>


    
  
    
    
	
<li>21.5: <a href="#pg-dd6083187c74288b0bc340d1a5d75a6f">ls Tips</a></li>


    
  
    
    
	
<li>21.6: <a href="#pg-d666840fe7c4f359e7566250aad67c80">查看信号的快捷键</a></li>


    
  
    
    
	
<li>21.7: <a href="#pg-549a76c189e9345d4226a12a7a7595fd">Review 《File Descriptor Transfer over Unix Domain Sockets》</a></li>


    
  
    
    
	
<li>21.8: <a href="#pg-50e13d0c712358d46277160b2eed624c">Glob 语法解析</a></li>


    
  
    
    
	
<li>21.9: <a href="#pg-efaf8b11c2c533130e7721f968b66120">词法分析器生成工具 Lex 简介</a></li>


    
  
    
    
	
<li>21.10: <a href="#pg-25c9fa87749c3a8b80df79ec7693c21d">【流水账】利用闲置笔记本搭建自己的开发服务器</a></li>


    
  
    
    
	
<li>21.11: <a href="#pg-3b4ec5fedefcf82985dda74fa4bef98c">【非技术】 Arch 下的无线自动断开</a></li>


    
  

    </ul>
    
  

    </ul>


<div class="content">
      <div><a id="td-block-0" class="td-offset-anchor"></a></div>
<section class="row td-box td-box--0 td-box--height-auto">
<div class="col">
<div class="container">
<p class="h1 text-center">宇宙很大，生活更大，也许以后还有缘相见</p>
</div>
</div>
</section>

</div>
</div>


  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-92c27ea962011595550955f7c41b869a">1 - Python</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-3174656f7062052451f0c9f528df376b">1.1 - Python2 使用 Thrift 为什么会出现 EINTR 错误</h1>
    
	<h2 id="eintr-错误是什么">EINTR 错误是什么</h2>
<p>在 <a href="https://man7.org/linux/man-pages/man7/signal.7.html">man 7 signal</a> 中写到，</p>
<blockquote>
<p>If a signal handler is invoked while a system call or library
function call is blocked, then either:</p>
<p>•  the call is automatically restarted after the signal handler
returns; or</p>
<p>•  the call fails with the error EINTR.</p>
</blockquote>
<p>如果一些阻塞的系统调用或库函数调用被信号中断了，会发生以下任一情况</p>
<ol>
<li>在信号处理函数执行完以后，系统调用或库函数调用继续执行</li>
<li>系统调用或库函数调用失败，返回错误码 EINTR</li>
</ol>
<p>具体会发生哪种情况，取决于具体的系统调用接口和是否通过 <a href="https://man7.org/linux/man-pages/man7/signal.7.html">sigaction</a> 设置了 <code>SA_RESTART</code> 标记。</p>
<p>例如</p>
<ul>
<li><code>read</code>, <code>readv</code>, <code>wait</code>, 没有设置超时的 <code>recv</code> 和 <code>send</code> 等调用会受到 <code>SA_RESTART</code> 标记的控制，继续执行或返回 EINTR 错误</li>
<li>设置了超时的 <code>send</code> 和 <code>recv</code>, <code>epoll_wait</code>, <code>poll</code> 等接口不会受到 <code>SA_RESTART</code>，都是直接返回 EINTR 错误码</li>
</ul>
<h2 id="为什么要有-eintr-错误">为什么要有 EINTR 错误</h2>
<p>从上面的 man 文档中可知，<code>EINTR</code> 其实并不是一个错误，只是程序被信号中断了而已。Unix/Linux 系统要设计成中断系统调用，并返回一个错误码呢?</p>
<p>在 <a href="https://peps.python.org/pep-0475/">PEP 475</a> 中说</p>
<blockquote>
<p>Therefore, when a signal is received by a process during the execution of a system call,
the system call can fail with the EINTR error to give the program an opportunity to handle the signal without the restriction on signal-safe functions.</p>
</blockquote>
<p>系统调用返回 <code>EINTR</code> 的设计，让信号处理函数有机会能在不考虑信号安全的情况下编写。</p>
<p>光看这句话看不太明白，后来我又搜索了一下，看到了 StackOverflow 上的一篇回答。</p>
<ul>
<li><a href="https://unix.stackexchange.com/a/253358/191858">What is the rationale behind EINTR?</a></li>
</ul>
<p>这里面说，信号处理函数因为要考虑可重入性，在函数中，很多系统调用都是不能使用的。这就决定了信号处理函数中不能编写复杂的逻辑。</p>
<p>大部分程序的逻辑是，在 signal handler 里面设置一个 flag, 然后主线程再检查 flag, 做出具体操作。</p>
<p>如果程序在系统调用上卡住了，那么 signal handler 设置了 flag 之后，主线程无法及时执行后续操作，相当于信号没有及时处理。</p>
<p>所以 unix 的设计者才定义了 EINTR 这个错误，让系统调用及时结束，将执行权交换给用户程序，及时处理信号。</p>
<h2 id="复现一个-eintr-错误">复现一个 EINTR 错误</h2>
<p>了解了 EINTR 错误的原理后，我们再来看一下 Python2 调用 Thrift 的时候，经常会出现的一个和 EINTR 有关的错误。</p>
<p>我们可以用以下代码复现一下这个错误</p>
<h3 id="代码准备">代码准备</h3>
<ol>
<li>从 <a href="https://github.com/bwangelme/thrift-eintr">github.com/bwangelme/thrift-eintr</a> 克隆代码</li>
<li>在代码目录中，使用 virtualenv 分别创建 venv2 和 venv3 两个 Python 虚拟环境</li>
</ol>
<pre tabindex="0"><code>~/.pyenv/versions/2.7.18/bin/virtualenv venv2
~/.pyenv/versions/3.11.0/bin/virtualenv venv3
</code></pre><p>服务端的代码比较简单，他就是提供了 <code>get_image</code> 接口，读取图片文件并返回文件内容，这里就不过多赘述了。</p>
<p>客户端的代码中主要做了两件事情。</p>
<ol>
<li>处理 SIGUSR1 信号</li>
<li>调用 get_image 接口获取文件</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">signal_handler</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">signum</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">frame</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Receive sig </span><span style="color:#4e9a06">%s</span><span style="color:#4e9a06">&#34;</span> <span style="color:#ce5c00;font-weight:bold">%</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">signum</span><span style="color:#000;font-weight:bold">,))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">():</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># 注册处理信号的 handler</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">signal</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">signal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">signal</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">SIGUSR1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">signal_handler</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># 打印进程 ID</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Start client @ </span><span style="color:#4e9a06">%s</span><span style="color:#4e9a06">&#34;</span> <span style="color:#ce5c00;font-weight:bold">%</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">os</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">getpid</span><span style="color:#000;font-weight:bold">()))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">transport</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">TSocket</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">TSocket</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;localhost&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">9090</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">transport</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">TTransport</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">TBufferedTransport</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">transport</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">protocol</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">TBinaryProtocol</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">TBinaryProtocol</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">transport</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">client</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Calculator</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">Client</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">protocol</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">transport</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">open</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># 调用 thrift 接口</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Start thrift req&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">start</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">time</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">time</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">res</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">client</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">get_image</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">dur</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">time</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">time</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">start</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;get </span><span style="color:#4e9a06">%d</span><span style="color:#4e9a06"> bytes in </span><span style="color:#4e9a06">%s</span><span style="color:#4e9a06">&#34;</span> <span style="color:#ce5c00;font-weight:bold">%</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">res</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">dur</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">__name__</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#39;__main__&#39;</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">try</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">except</span> <span style="color:#000">Thrift</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">TException</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#000">tx</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic"># 遇到错误后打印异常和栈信息</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">tx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tx</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">inner</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">traceback</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">print_exc</span><span style="color:#000;font-weight:bold">()</span>
</span></span></code></pre></div><h3 id="复现错误">复现错误</h3>
<ol>
<li>为了有时间能够发送信号，我们首先调慢 lo 网卡(即 localhost)的发包速度, 这样 <code>get_image</code> 接口就会持续十几秒才结束。</li>
</ol>
<pre tabindex="0"><code># 设置 lo 网卡上发出去的包都有 1000ms 的延迟
ø&gt; sudo tc qdisc add dev lo root netem delay 1000ms

# 使用 list 可以看到我们刚刚创建的规则
ø&gt; sudo tc qdisc list
qdisc netem 8001: dev lo root refcnt 2 limit 1000 delay 1s
...

# 执行完测试函数后，记得删掉这个规则
# ø&gt; sudo tc qdisc del dev lo root
</code></pre><ol start="2">
<li>首先使用 <code>./venv2/bin/python server.py</code> 启动 server,</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>ø&gt; python server.py
</span></span><span style="display:flex;"><span>Starting the server...
</span></span></code></pre></div><p>然后再启动 client</p>
<pre tabindex="0"><code>ø&gt; ./venv2/bin/python client.py

Start client @ 241683
Start thrift req
</code></pre><p>client 启动以后，会打印进程 id <code>241683</code>, <code>Start thrift req</code> 表示开始调用 <code>get_image</code> 接口了。</p>
<p>由于网卡速度很慢，我们 client 会阻塞十几秒。此时我们可以给 client 发送一个 <code>SIGUSR1</code> 信号:</p>
<pre tabindex="0"><code>kill -SIGUSR1 241683
</code></pre><p>client 在收到信号后会处理信号，并抛出一个异常</p>
<pre tabindex="0"><code># 这句表示 SIGUSR1 信号已经处理完了
Receive sig 10

# 打印出来的异常的类型及其值
(TTransportException(&#39;unexpected exception&#39;,), error(4, &#39;Interrupted system call&#39;))

# 抛出异常的栈信息
Traceback (most recent call last):
      File &#34;client.py&#34;, line 50, in &lt;module&gt;
          main()
        File &#34;client.py&#34;, line 43, in main
          res = client.get_image()
        File &#34;gen-py/tutorial/Calculator.py&#34;, line 35, in get_image
          return self.recv_get_image()
        File &#34;gen-py/tutorial/Calculator.py&#34;, line 53, in recv_get_image
          result.read(iprot)
        File &#34;gen-py/tutorial/Calculator.py&#34;, line 178, in read
          self.success = iprot.readBinary()
        File &#34;/home/xuyundong/Github/Python/thrift-eintr/venv2/lib/python2.7/site-packages/thrift/protocol/TBinaryProtocol.py&#34;, line 234, in readBinary
          s = self.trans.readAll(size)
        File &#34;/home/xuyundong/Github/Python/thrift-eintr/venv2/lib/python2.7/site-packages/thrift/transport/TTransport.py&#34;, line 62, in readAll
          chunk = self.read(sz - have)
        File &#34;/home/xuyundong/Github/Python/thrift-eintr/venv2/lib/python2.7/site-packages/thrift/transport/TTransport.py&#34;, line 164, in read
          self.__rbuf = BufferIO(self.__trans.read(max(sz, self.__rbuf_size)))
        File &#34;/home/xuyundong/Github/Python/thrift-eintr/venv2/lib/python2.7/site-packages/thrift/transport/TSocket.py&#34;, line 164, in read
          raise TTransportException(message=&#34;unexpected exception&#34;, inner=e)
      TTransportException: unexpected exception
</code></pre><p>从栈信息我们可以知道，抛出异常的位置是 <code>thrift/transport/TSocket.py:164</code>，它的代码如下</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">read</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">sz</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">try</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">buff</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">handle</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">recv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">sz</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">except</span> <span style="color:#000">socket</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">error</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#000">e</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">e</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">args</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">errno</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">ECONNRESET</span> <span style="color:#204a87;font-weight:bold">and</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#000;font-weight:bold">(</span><span style="color:#000">sys</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">platform</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#39;darwin&#39;</span> <span style="color:#204a87;font-weight:bold">or</span> <span style="color:#000">sys</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">platform</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">startswith</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;freebsd&#39;</span><span style="color:#000;font-weight:bold">))):</span>
</span></span><span style="display:flex;"><span>                <span style="color:#8f5902;font-style:italic"># freebsd and Mach don&#39;t follow POSIX semantic of recv</span>
</span></span><span style="display:flex;"><span>                <span style="color:#8f5902;font-style:italic"># and fail with ECONNRESET if peer performed shutdown.</span>
</span></span><span style="display:flex;"><span>                <span style="color:#8f5902;font-style:italic"># See corresponding comment and code in TSocket::read()</span>
</span></span><span style="display:flex;"><span>                <span style="color:#8f5902;font-style:italic"># in lib/cpp/src/transport/TSocket.cpp.</span>
</span></span><span style="display:flex;"><span>                <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">close</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>                <span style="color:#8f5902;font-style:italic"># Trigger the check to raise the END_OF_FILE exception below.</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">buff</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">elif</span> <span style="color:#000">e</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">args</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">errno</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">ETIMEDOUT</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">raise</span> <span style="color:#000">TTransportException</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">type</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">TTransportException</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">TIMED_OUT</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">message</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;read timeout&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">inner</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">e</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">else</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#8f5902;font-style:italic"># 在这里抛出了异常</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">raise</span> <span style="color:#000">TTransportException</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">message</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;unexpected exception&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">inner</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">e</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">buff</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">raise</span> <span style="color:#000">TTransportException</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">type</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">TTransportException</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">END_OF_FILE</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                                      <span style="color:#000">message</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;TSocket read 0 bytes&#39;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">buff</span>
</span></span></code></pre></div><p>这段代码逻辑就是，client 已经发送完了请求，正在等待 server 返回响应的时候，收到了一个 <code>socket.error</code>, 它的值是</p>
<pre tabindex="0"><code>error(4, &#39;Interrupted system call&#39;)

# 在 python 标准库的 errno.py 文件中也可以看到 4 表示是 EINTR 错误
EINTR = 4
</code></pre><h3 id="python3-中无法复现">python3 中无法复现</h3>
<p>如果我们使用 Python3 启动 client, 再往该进程发送 SIGUSR1 信号，它就不会抛出异常。</p>
<pre tabindex="0"><code>ø&gt; ./venv3/bin/python client.py
Start client @ 241720
Start thrift req
# 收到了两次信号
Receive sig 10
Receive sig 10
get 2745109 bytes in 16.005424737930298
</code></pre><p>EINTR 是什么错误，为什么 Python2 中抛异常，Python3不会抛异常呢，且听我慢慢讲解。</p>
<h2 id="为什么-python2-和-python3-的表现不同">为什么 Python2 和 Python3 的表现不同</h2>
<h3 id="python-的原因">Python 的原因</h3>
<p>Python 在 <a href="https://peps.python.org/pep-0475/">PEP 475</a> 中实现了，在系统调用遇到 EINTR 的时候自动重试。</p>
<p>而且它只在 signal handler 没有抛出异常的时候重试，这样确保信号能够中断程序的执行，不会阻塞在系统调用中。</p>
<p>以下是中断后能够自动重试的函数列表:</p>
<ul>
<li>open() 和 io.open();</li>
<li><a href="https://docs.python.org/3/library/faulthandler.html#module-faulthandler">faulthandler</a> 模块相关的函数;</li>
<li>os 模块的函数: fchdir(), fchmod(), fchown(), fdatasync(), fstat(), fstatvfs(), fsync(), ftruncate(), mkfifo(), mknod(), open(), posix_fadvise(), posix_fallocate(), pread(), pwrite(), read(), readv(), sendfile(), wait3(), wait4(), wait(), waitid(), waitpid(), write(), writev();</li>
<li>特例: os.close() 和 os.dup2() 会忽略 EINTR 错误，并且不会重试</li>
<li>select 函数: devpoll.poll(), epoll.poll(), kqueue.control(), poll.poll(), select();</li>
<li>socket 类相关的函数: accept(), connect() (except for non-blocking sockets), recv(), recvfrom(), recvmsg(), send(), sendall(), sendmsg(), sendto();</li>
<li>signal.sigtimedwait() 和 signal.sigwaitinfo();</li>
<li>time.sleep().</li>
</ul>
<p>但是 PEP 475 仅在 Python 3.5 及之后的版本中生效，在 Python 2.7 的版本中，是没有这个处理逻辑的。</p>
<h3 id="thrift-的原因">Thrift 的原因</h3>
<p>在 Thrift 的 <a href="https://issues.apache.org/jira/browse/THRIFT-617">Issue-617</a> 中，有人提到了在网络 IO 接口中忽略 EINTR 错误的建议。维护者的回答是，这个问题已经在 Python 3.5 中修了，没有提到 Python 2.7 该怎么办。</p>
<p>PEP 475 只管 Python3, thrift 没有针对 Python2 做特殊处理，这就导致了上述错误只会在 Python 2 出现，Python 3 不会出现。</p>
<h2 id="thrift-在-python2-环境中忽略-eintr">thrift 在 Python2 环境中忽略 EINTR</h2>
<p>目前 Python 和 Thrift 官方都无意去处理这个问题，我们可以修改一下 thrift 代码，手动处理 EINTR 错误。我的处理办法很简单，遇到 EINTR 错误，直接重试即可。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-diff" data-lang="diff"><span style="display:flex;"><span><span style="color:#a40000">--- a/lib/py/src/transport/TSocket.py
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#00a000">+++ b/lib/py/src/transport/TSocket.py
</span></span></span><span style="display:flex;"><span><span style="color:#00a000"></span><span style="color:#800080;font-weight:bold">@@ -149,22 +149,26 @@ class TSocket(TSocketBase):
</span></span></span><span style="display:flex;"><span><span style="color:#800080;font-weight:bold"></span>         raise TTransportException(type=TTransportException.NOT_OPEN, message=msg)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>     def read(self, sz):
</span></span><span style="display:flex;"><span><span style="color:#a40000">-        try:
</span></span></span><span style="display:flex;"><span><span style="color:#a40000">-            buff = self.handle.recv(sz)
</span></span></span><span style="display:flex;"><span><span style="color:#a40000">-        except socket.error as e:
</span></span></span><span style="display:flex;"><span><span style="color:#a40000">-            if (e.args[0] == errno.ECONNRESET and
</span></span></span><span style="display:flex;"><span><span style="color:#a40000">-                    (sys.platform == &#39;darwin&#39; or sys.platform.startswith(&#39;freebsd&#39;))):
</span></span></span><span style="display:flex;"><span><span style="color:#a40000">-                # freebsd and Mach don&#39;t follow POSIX semantic of recv
</span></span></span><span style="display:flex;"><span><span style="color:#a40000">-                # and fail with ECONNRESET if peer performed shutdown.
</span></span></span><span style="display:flex;"><span><span style="color:#a40000">-                # See corresponding comment and code in TSocket::read()
</span></span></span><span style="display:flex;"><span><span style="color:#a40000">-                # in lib/cpp/src/transport/TSocket.cpp.
</span></span></span><span style="display:flex;"><span><span style="color:#a40000">-                self.close()
</span></span></span><span style="display:flex;"><span><span style="color:#a40000">-                # Trigger the check to raise the END_OF_FILE exception below.
</span></span></span><span style="display:flex;"><span><span style="color:#a40000">-                buff = &#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#a40000">-            elif e.args[0] == errno.ETIMEDOUT:
</span></span></span><span style="display:flex;"><span><span style="color:#a40000">-                raise TTransportException(type=TTransportException.TIMED_OUT, message=&#34;read timeout&#34;, inner=e)
</span></span></span><span style="display:flex;"><span><span style="color:#a40000">-            else:
</span></span></span><span style="display:flex;"><span><span style="color:#a40000">-                raise TTransportException(message=&#34;unexpected exception&#34;, inner=e)
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#00a000">+        while True:
</span></span></span><span style="display:flex;"><span><span style="color:#00a000">+            try:
</span></span></span><span style="display:flex;"><span><span style="color:#00a000">+                buff = self.handle.recv(sz)
</span></span></span><span style="display:flex;"><span><span style="color:#00a000">+            except socket.error as e:
</span></span></span><span style="display:flex;"><span><span style="color:#00a000">+                if e.args[0] == errno.EINTR:
</span></span></span><span style="display:flex;"><span><span style="color:#00a000">+                    pass
</span></span></span><span style="display:flex;"><span><span style="color:#00a000">+                elif (e.args[0] == errno.ECONNRESET and
</span></span></span><span style="display:flex;"><span><span style="color:#00a000">+                        (sys.platform == &#39;darwin&#39; or sys.platform.startswith(&#39;freebsd&#39;))):
</span></span></span><span style="display:flex;"><span><span style="color:#00a000">+                    # freebsd and Mach don&#39;t follow POSIX semantic of recv
</span></span></span><span style="display:flex;"><span><span style="color:#00a000">+                    # and fail with ECONNRESET if peer performed shutdown.
</span></span></span><span style="display:flex;"><span><span style="color:#00a000">+                    # See corresponding comment and code in TSocket::read()
</span></span></span><span style="display:flex;"><span><span style="color:#00a000">+                    # in lib/cpp/src/transport/TSocket.cpp.
</span></span></span><span style="display:flex;"><span><span style="color:#00a000">+                    self.close()
</span></span></span><span style="display:flex;"><span><span style="color:#00a000">+                    # Trigger the check to raise the END_OF_FILE exception below.
</span></span></span><span style="display:flex;"><span><span style="color:#00a000">+                    buff = &#39;&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#00a000">+                elif e.args[0] == errno.ETIMEDOUT:
</span></span></span><span style="display:flex;"><span><span style="color:#00a000">+                    raise TTransportException(type=TTransportException.TIMED_OUT, message=&#34;read timeout&#34;, inner=e)
</span></span></span><span style="display:flex;"><span><span style="color:#00a000">+                else:
</span></span></span><span style="display:flex;"><span><span style="color:#00a000">+                    raise TTransportException(message=&#34;unexpected exception&#34;, inner=e)
</span></span></span><span style="display:flex;"><span><span style="color:#00a000">+
</span></span></span><span style="display:flex;"><span><span style="color:#00a000"></span>         if len(buff) == 0:
</span></span><span style="display:flex;"><span>             raise TTransportException(type=TTransportException.END_OF_FILE,
</span></span><span style="display:flex;"><span>                                       message=&#39;TSocket read 0 bytes&#39;)
</span></span><span style="display:flex;"><span><span style="color:#800080;font-weight:bold">@@ -185,7 +189,8 @@ class TSocket(TSocketBase):
</span></span></span><span style="display:flex;"><span><span style="color:#800080;font-weight:bold"></span>                 sent += plus
</span></span><span style="display:flex;"><span>                 buff = buff[plus:]
</span></span><span style="display:flex;"><span>             except socket.error as e:
</span></span><span style="display:flex;"><span><span style="color:#a40000">-                raise TTransportException(message=&#34;unexpected exception&#34;, inner=e)
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#00a000">+                if e.args[0] != errno.EINTR:
</span></span></span><span style="display:flex;"><span><span style="color:#00a000">+                    raise TTransportException(message=&#34;unexpected exception&#34;, inner=e)
</span></span></span><span style="display:flex;"><span><span style="color:#00a000"></span>
</span></span><span style="display:flex;"><span>     def flush(self):
</span></span><span style="display:flex;"><span>         pass
</span></span></code></pre></div><h2 id="吐槽">吐槽</h2>
<ul>
<li>PEP 475 是 2014 年的提案，那一年 Python2 还没有停止维护，然后官方在这个 PEP 中直接忽略了 Python2 ，让 Python2 的开发者自己去捕获 EINTR 错误并重试。Python 社区真的不是一个好社区，如果你想开发一个能够维护10年以上的程序，不建议用 Python</li>
<li>Thrift 维护者也没有考虑 Python2 的情况，认为 Python3 已经修了，就万事大吉了，让 Python2 的 client 和 server 多了很多不必要的 TTransportException</li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-8ffc0b133015cfd66db7f485c8157c6b">1.2 - 匹配所有可打印 Ascii 字符的正则</h1>
    
	<hr>
<h2 id="tips">Tips</h2>
<p><code>[ -~]</code> 可以匹配所有的可打印 ascii 字符</p>
<pre tabindex="0"><code>In [1]: import re

In [2]: p = re.compile(&#39;[ -~]&#39;)

In [3]: p.match(&#39;中文&#39;)

In [4]: p.match(&#39;ドウバン&#39;)

In [5]: p.match(&#39;^&amp;#^&amp;@#abcdefdjskla&#39;)
Out[5]: &lt;re.Match object; span=(0, 1), match=&#39;^&#39;&gt;
</code></pre><p>它的原理就是匹配 ASCII 码表中所有从 <code>空格(0x20)</code> 到 <code>-(0x7E)</code> 的字符</p>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com//2021-12-15-191941.png" alt=""></p>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-dd6b8c93984d98fe6f8c5851846c88d9">1.3 - Python Upgrade Importerror</h1>
    
	<blockquote>
<ul>
<li>记一次因 Python 升级导致的 ImportError</li>
</ul>
</blockquote>
<p>我们有一个 Django 应用通过 uwsgi 跑在阿里云的 ECS 上，所用的系统是 Ubuntu 16.04，uwsgi 是通过 supervisord 来管理的，每个应用都在单独的 virtualenv 中运行，这就是大概的软件运行环境。</p>
<p>因为一些软件没有升级，阿里云一直提示存在安全漏洞，所以我就想把 ECS 上的系统升级一下。升级的过程并没有什么什么问题，毕竟用的阿里云自己维护的源，基本上不会出现什么版本依赖之类的问题。</p>
<h1 id="出错场景">出错场景</h1>
<p>升级完成后重新启动 Django 应用，发现应用启动不起来，uwsgi 报错</p>
<pre tabindex="0"><code>from _ssl import HAS_SNI, HAS_ECDH, HAS_NPN, HAS_ALPN, HAS_TLSv1_3
ImportError: cannot import name &#39;HAS_TLSv1_3&#39;
</code></pre><h1 id="原因分析">原因分析</h1>
<h2 id="从异常入手查找原因">从异常入手查找原因</h2>
<p>抛出的异常意思是在<code>_ssl</code>模块中没有<code>HAS_TLSv1_3</code>的属性，于是我就去Python 文档中查询了一下这个属性，它的解释是这样的：</p>
<pre tabindex="0"><code>ssl.HAS_TLSv1_3
Whether the OpenSSL library has built-in support for the TLS 1.3 protocol.

New in version 3.6.3.
</code></pre><p>看到<code>New in version 3.6.3.</code>的字样，再去查系统的升级记录，我发现刚刚执行的升级中就把宿主机的 Python 从3.6.2升级到了3.6.3，此时我隐隐约约觉得就是因为此次升级导致了 uwsgi 启动时的报错。</p>
<p>但我升级的是宿主机的 Python，它又是如何影响到了 Virtualenv 中的 Python 呢？各位别急，我们接着往下挖。</p>
<h2 id="has_tlsv1_3的定义"><code>HAS_TLSv1_3</code>的定义</h2>
<p>我们接着再去看抛出异常的那行代码，它在 Python 的标准库的<code>ssl.py</code>的<a href="https://github.com/python/cpython/blob/v3.6.3/Lib/ssl.py#L118">118行</a>，具体内容如下：</p>
<pre tabindex="0"><code>from _ssl import HAS_SNI, HAS_ECDH, HAS_NPN, HAS_ALPN, HAS_TLSv1_3
</code></pre><p>我们可以看到，抛出异常就是因为Python解释器从<code>_ssl</code>模块中导入<code>HAS_TLSv1_3</code>时，出现了导入异常。</p>
<p>而<code>_ssl</code>模块是用C语言编写的，它被编译进入了Python解释器中，它的代码位于 Python 源码的 <a href="https://github.com/python/cpython/blob/v3.6.3/Lib/ssl.py">Modules/_ssl.c</a> 文件中。</p>
<p>在它的<a href="https://github.com/python/cpython/blob/v3.6.3/Modules/_ssl.c#L5154-L5206">5154-5206</a>行，我们可以看到它对于<code>_ssl</code>模块的定义：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">PyModuleDef</span> <span style="color:#000">_sslmodule</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">PyModuleDef_HEAD_INIT</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;_ssl&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">module_doc</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">PySSL_methods</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87">NULL</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">};</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">PyMODINIT_FUNC</span>
</span></span><span style="display:flex;"><span><span style="color:#000">PyInit__ssl</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">PyObject</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">m</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">r</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// _ssl 模块在这里定义，指针m代表了_ssl模块
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">m</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">PyModule_Create</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">_sslmodule</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">m</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">...</span>
</span></span></code></pre></div><p>而在它的<a href="https://github.com/python/cpython/blob/v3.6.3/Modules/_ssl.c#L5462-L5468">5642-5468</a>行，我们可以看到<code>_ssl</code>模块中对于<code>HAS_TLSv1_3</code>属性的定义：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#if defined(TLS1_3_VERSION) &amp;&amp; !defined(OPENSSL_NO_TLS1_3)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">r</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Py_True</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#else
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">r</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Py_False</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#endif
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">Py_INCREF</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">r</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// 下面这条语句向_ssl模块中添加了布尔值 HAS_TLSv1_3
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">PyModule_AddObject</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">m</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;HAS_TLSv1_3&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">r</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>上述的代码主要就是判断当前系统是否支持 TLS 1.3版本，并向<code>_ssl</code>模块添加了一个布尔值<code>HAS_TLSv1_3</code>来表明当前系统是否支持 TLS 1.3版本。</p>
<h2 id="错误复现">错误复现</h2>
<p>从上面的分析中我们可以看出，我们可以知道三件事情，</p>
<ol>
<li><code>HAS_TLSv1_3</code>这个布尔值是被编译进 Python 解释器中的，</li>
<li>根据 <a href="https://docs.python.org/3/library/ssl.html#ssl.HAS_TLSv1_3">Python 文档</a> 的说明，<code>HAS_TLSv1_3</code>是在 Python 3.6.3中新添加的。</li>
<li>我们将宿主机的 Python 从3.6.2升级到了3.6.3，但是我们的 Virtualenv 仍然使用着 3.6.2 版本的 Python 解释器。</li>
</ol>
<p>知道了以上三点，我们就可以复现出我们的错误场景，梳理出整个出错的流程：</p>
<ul>
<li>uwsgi 启动，使用的是 Virtualenv 中的 3.6.2版本的 Python 解释器</li>
<li>Python 3.6.2 的解释器在某些第三方库中执行了<code>import ssl</code>的语句</li>
<li>由于 Virtualenv 创建的时候并没有将标准库的<code>ssl.py</code>文件一并复制过来，所以 Python 3.6.2 的解释器去系统目录下寻找<code>ssl.py</code>文件并执行</li>
<li>Python 3.6.2 的解释器找到了系统目录下的<code>ssl.py</code>文件，也就是 Python 3.6.3 的系统库文件。</li>
<li>Python 3.6.2 的解释器执行了 Python 3.6.3的库文件<code>ssl.py</code>中的一条导入语句：</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">from</span> <span style="color:#000">_ssl</span> <span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">HAS_SNI</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">HAS_ECDH</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">HAS_NPN</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">HAS_ALPN</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">HAS_TLSv1_3</span>
</span></span></code></pre></div><ul>
<li>Python 3.6.2 的解释器从解释器內建的模块<code>_ssl</code>中导入<code>HAS_TLSv1_3</code></li>
<li>由于 Python 3.6.2 的解释器中并没有定义<code>HAS_TLSv1_3</code>这个布尔值，程序抛出<code>ImportError</code></li>
</ul>
<p>上面这个出错流程也可以用下面这张图来概括:</p>
<p><img src="https://passage-1253400711.cos-website.ap-beijing.myqcloud.com/2019-02-18-2017-10-14-080329.jpg" alt="Import Error"></p>
<h1 id="错误总结">错误总结</h1>
<p>看到这里，我想 Virtualenv 创建时没有复制系统库文件<code>ssl.py</code>过来，是不是因为我没有指定它的 <a href="https://virtualenv.pypa.io/en/stable/reference/#cmdoption-always-copy">&ndash;always-copy</a> 属性，我特意指定了这个属性又来创建了一遍 Virtualenv，发现它还是没有复制<code>ssl.py</code>文件过来。</p>
<p>关于这个问题，我请教了公司的一位大佬。大佬说这样设计其实复合 Virtualenv 的定位，它只是做 Python 第三方库的隔离，并不做 Python 版本的隔离。</p>
<p>所以如果我们以后需要在同一个系统上安装多个 Python 版本的话，还是需要使用 <a href="https://github.com/pyenv/pyenv">pyenv</a> 这样的工具，而不能指望 Virutalenv 的 <a href="https://virtualenv.pypa.io/en/stable/reference/#cmdoption-p">&ndash;python</a> 选项。</p>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-958da66e5791d6c739afd62fdccfea9d">1.4 - Django的override_settings修饰器浅析</h1>
    
	<blockquote>
<ol>
<li>Django的Settings模块代码说明</li>
<li>Django的<code>override_settings</code>修饰器分析</li>
</ol>
</blockquote>
<h2 id="前言">前言</h2>
<p>前两天刚刚看了Django settings的实现，今天又发现了测试工具中有个<code>override_settings</code>修饰器，于是就想从它下手来分析一下Django的<code>settings</code>。</p>
<p>本篇文章主要分析的是<code>override_settings</code>作为修饰器的实现，其作为上下文管理器的部分并未详细分析。</p>
<h2 id="django的settings说明">Django的settings说明</h2>
<p>在分析这个修饰器之前，我们先来了解一下Django的<code>settings</code>是如何实现的， Django的<code>settings</code>的代码存放在<code>django/conf/__init__.py</code>中，其中主要有三个类，<code>LazySettings</code>，<code>Settings</code>和<code>UserSettingsHolder</code>。</p>
<h3 id="settings">Settings</h3>
<p><code>Settings</code>类实现了Django配置的载入和存储功能，在它的<code>__init__</code>函数中，首先从<code>django/conf/global_settings.py</code>文件中导入Django默认的配置，然后再从<code>DJANGO_SETTINGS_MODULE</code>环境变量所指定的配置文件中导入我们项目自定义的配置，然后逐项地检查并添加配置。</p>
<p>需要注意的是，<code>Settings</code>会把我们自定义的配置的名称存放到<code>Settings._explicit_settings</code>集合中，<code>Settings.is_overriden</code>函数就是通过检查<code>Settings._explicit_settings</code>集合，来查看某项配置是否被我们自定义的配置给覆盖掉了。</p>
<h3 id="lazysettings">LazySettings</h3>
<p><code>LazySettings</code>是<code>Settings</code>类的一个代理，或者可以认为是对<code>Settings</code>的一层包裹，它的主要功能就是<code>Lazy</code>，或者叫做懒载入。它把<code>Settings</code>类的实例存放在它的私有变量<code>_wrapped</code>中，初始化的时候，它默认将<code>_wrapped</code>设置为空，只有当从<code>LazySettings</code>中取值的时候(会调用<code>LazySettings.__getattr__</code>函数)，它才会调用<code>_setup</code>函数，实例化一个<code>Settings</code>对象，并从中取出对应的配置项。</p>
<p>我们平常在代码中使用的<code>django.conf.settings</code>对象，就是这个类的实例。</p>
<h3 id="usersettingsholder">UserSettingsHolder</h3>
<p><code>UserSettingsHolder</code>类和上面两个类有些不同，它也是用来存储用户的配置项的，只不过它并不会从<code>django/conf/global_settings.py</code>文件中读取Django默认的配置，它只是单纯地将用户传入的配置存储起来，以供读取。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">__init__</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">default_settings</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    Requests for configuration variables not in this class are satisfied
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    from the module specified in default_settings (if possible).
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    &#34;&#34;&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">__dict__</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#39;_deleted&#39;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">set</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">default_settings</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">default_settings</span>
</span></span></code></pre></div><p>上面就是<code>UserSettingsHolder</code>构造函数，从中我们可以看到，它接收一个<code>default_settings</code>参数，它主要就是从这个参数中获取并存储用户要设置的配置，并不存储Django默认的配置。</p>
<h2 id="override_settings修饰器的分析">override_settings修饰器的分析</h2>
<p>了解完Django的<code>settings</code>的实现以后，我们再来看一下<code>override_settings</code>修饰器。</p>
<p>我们在使用<code>override_settings</code>作为修饰器的时候，通常的形式是这样的:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#5c35cc;font-weight:bold">@override_settings</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">DEBUG</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">False</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">test_some_feature</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">pass</span>
</span></span></code></pre></div><p>上面的代码中修饰器的部分，我们可以使用下面这种方式来理解它:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#000">test_some_feature</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">override_settings</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">DEBUG</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">False</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#000">test_some_feature</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>从上面的形式可以看出，修饰器语法真正调用的是<code>override_settings</code>类的<code>__call__</code>方法，所以我们需要去关注一下<code>override_settings</code>的<code>__call__</code>方法。但是这个方法在<code>override_settings</code>类中并没有实现，它是在它的父类<code>TestContextDecorator</code>中实现的。</p>
<h3 id="testcontextdecorator">TestContextDecorator</h3>
<h4 id="__call__方法"><code>__call__</code>方法</h4>
<p><code>TestContextDecorator</code>类的<code>__call__</code>方法如下所示:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">__call__</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">decorated</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">isinstance</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">decorated</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">type</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">decorate_class</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">decorated</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">elif</span> <span style="color:#000">callable</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">decorated</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">decorate_callable</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">decorated</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">raise</span> <span style="color:#c00;font-weight:bold">TypeError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;Cannot decorate object of type </span><span style="color:#4e9a06">%s</span><span style="color:#4e9a06">&#39;</span> <span style="color:#ce5c00;font-weight:bold">%</span> <span style="color:#204a87">type</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">decorated</span><span style="color:#000;font-weight:bold">))</span>
</span></span></code></pre></div><p>从代码中我们可以看出，这个函数的功能主要就是对被修饰的对象进行了一下鉴别，如果修饰的是类，则调用<code>decorate_class</code>函数，如果修饰的是其他的可调用对象，则调用<code>decorate_callable</code>函数。</p>
<h4 id="decorate_class">decorate_class</h4>
<p>接着我们来看一下<code>decorate_class</code>函数，它的代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">decorate_class</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#3465a4">cls</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">issubclass</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">cls</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">TestCase</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">decorated_setUp</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#3465a4">cls</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">setUp</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">decorated_tearDown</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#3465a4">cls</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">tearDown</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">setUp</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">inner_self</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ce5c00;font-weight:bold">-&gt;</span> <span style="color:#000">context</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">enable</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ce5c00;font-weight:bold">-&gt;</span> <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">attr_name</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ce5c00;font-weight:bold">-&gt;</span>     <span style="color:#204a87">setattr</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">inner_self</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">attr_name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">decorated_setUp</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">inner_self</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">tearDown</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">inner_self</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">decorated_tearDown</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">inner_self</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ce5c00;font-weight:bold">-&gt;</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">disable</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">cls</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">setUp</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">setUp</span>
</span></span><span style="display:flex;"><span>        <span style="color:#3465a4">cls</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">tearDown</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">tearDown</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#3465a4">cls</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">raise</span> <span style="color:#c00;font-weight:bold">TypeError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;Can only decorate subclasses of unittest.TestCase&#39;</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>从上面的代码可以看出，<code>decorate_class</code>函数的针对<code>TestCase</code>类的<code>setUp</code>和<code>tearDown</code>函数添加了一些额外的代码，即我用<code>-&gt;</code>符号标记的部分。</p>
<p>这些代码的主要功能就是在<code>TestCase</code>类初始化的时候调用<code>TestContextDecorator.enable</code>函数，再以<code>self.attr_name</code>的值作为名称，把<code>enable</code>函数的返回值插入到<code>TestCase</code>类的实例中。同时在<code>TestCase</code>类销毁的时候调用<code>TestContextDecorator.disable</code>函数。</p>
<p>我们接着再去查看<code>TestContextDecorator.enable</code>和<code>TestContextDecorator.disable</code>函数，我们发现它们是在<code>override_settings</code>子类中实现的，那我们对于<code>decorate_class</code>的分析就到这里，<code>enable</code>和<code>disable</code>函数在后面分析到<code>override_settings</code>子类的时候会继续分析。</p>
<h4 id="decorate_callable">decorate_callable</h4>
<blockquote>
<p><strong>注意</strong>:
这个函数的代码涉及到了Python的上下文管理器(<code>with</code>语句)的部分知识，如果你可以自己动手写一个上下文管理器的话，继续阅读即可。
如果你对于上下文管理器还有些疑问的话，请参考我的另一篇文章: <a href="/2016/04/25/python%E7%9A%84with%E8%AF%AD%E5%8F%A5/">PEP 343: Python的with语句</a></p>
</blockquote>
<p>分析完了<code>decorate_class</code>函数，我们接着回到<code>TestContextDecorator.__call__</code>方法，接着分析被修饰对象是可调用对象的那一种情况，也就是<code>TestContextDecorator.decorate_callable</code>函数。<code>decorate_callable</code>函数的代码如下所示:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">decorate_callable</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">func</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#5c35cc;font-weight:bold">@wraps</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">func</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">inner</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">args</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#000">kwargs</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">with</span> <span style="color:#3465a4">self</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">kwarg_name</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">kwargs</span><span style="color:#000;font-weight:bold">[</span><span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">kwarg_name</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">context</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">args</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#000">kwargs</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">inner</span>
</span></span></code></pre></div><p>可以看到，<code>decorate_callable</code>函数其实就是一个修饰器，它的主要功能就是将<code>TestContextDecorator</code>的实例作为一个上下文管理器进行了调用，需要注意的是，<code>return</code>语句是被包裹在<code>with</code>语句内的，也就是说，被修饰的函数执行完了以后，才会接着执行上下文管理器的<code>__exit__</code>函数。同时，它还会使用<code>self.kwarg_name</code>的值作为参数名字，将上下文管理器的返回值(也就是<code>__enter__</code>函数的返回值)传入被修饰的函数中。</p>
<p>既然<code>decorate_callable</code>将<code>TestContextDecorator</code>当做一个上下文管理器来使用，我们就需要关注一下它的<code>__enter__</code>和<code>__exit__</code>函数，这两个函数的代码如下所示:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">__enter__</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">enable</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">__exit__</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">exc_type</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">exc_value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">traceback</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">disable</span><span style="color:#000;font-weight:bold">()</span>
</span></span></code></pre></div><p>可以看到，这两个函数的功能，基本上也是调用<code>enable</code>和<code>disable</code>函数。</p>
<h3 id="override_settings">override_settings</h3>
<p>分析完了<code>override_settings</code>的父类，我们接着来分析这个类本身。从上面的分析中我们可以看到，<code>override_settings</code>对于被修饰的类或者函数基本上就是做两件事，类或者函数初始化之前调用<code>enable</code>函数，并将<code>enable</code>函数的返回值传递到被修饰的类或者函数中。然后再在被修饰的类或者函数退出的时候调用<code>disable</code>函数。所以，我们将关注点集中到<code>override_settings</code>类的<code>enable</code>和<code>disable</code>函数上就好了。</p>
<p>首先来说<code>override_settings.enable</code>函数，它的代码如下所示:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">enable</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># Keep this code at the beginning to leave the settings unchanged</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># in case it raises an exception because INSTALLED_APPS is invalid.</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># 注意self.options其实就是`override_settings`类的构造函数中传入的关键字参数kwargs</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#4e9a06">&#39;INSTALLED_APPS&#39;</span> <span style="color:#204a87;font-weight:bold">in</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">options</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">try</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">apps</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">set_installed_apps</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">options</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#39;INSTALLED_APPS&#39;</span><span style="color:#000;font-weight:bold">])</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">except</span> <span style="color:#c00;font-weight:bold">Exception</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">apps</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">unset_installed_apps</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">raise</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># 这个settings._wrapped就是真实保存的设置</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># UserSettingsHolder就是</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">override</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">UserSettingsHolder</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">settings</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">_wrapped</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">new_value</span> <span style="color:#204a87;font-weight:bold">in</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">options</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">items</span><span style="color:#000;font-weight:bold">():</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87">setattr</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">override</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">new_value</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">wrapped</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">settings</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">_wrapped</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">settings</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">_wrapped</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">new_value</span> <span style="color:#204a87;font-weight:bold">in</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">options</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">items</span><span style="color:#000;font-weight:bold">():</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">setting_changed</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">send</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">sender</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">settings</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">_wrapped</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">__class__</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                              <span style="color:#000">setting</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">value</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">new_value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">enter</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">True</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>可以看到<code>enable</code>函数的功能就是在原有的<code>settings</code>配置上，用我们在<code>options</code>中传入的配置覆盖掉原来的配置，并针对修改的配置项发出信号。同时将原来的配置保存到<code>self.wrapped</code>变量中。</p>
<p>接着我们再来看<code>override_settings.disable</code>函数，它的代码如下:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">disable</span><span style="color:#000;font-weight:bold">(</span><span style="color:#3465a4">self</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#4e9a06">&#39;INSTALLED_APPS&#39;</span> <span style="color:#204a87;font-weight:bold">in</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">options</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">apps</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">unset_installed_apps</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">settings</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">_wrapped</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">wrapped</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">del</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">wrapped</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">key</span> <span style="color:#204a87;font-weight:bold">in</span> <span style="color:#3465a4">self</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">options</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">new_value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">getattr</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">settings</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">None</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">setting_changed</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">send</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">sender</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">settings</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">_wrapped</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">__class__</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                              <span style="color:#000">setting</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">value</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">new_value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">enter</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">False</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>这个函数的功能也很简单，将<code>self.wrapped</code>中保存的配置还原，并针对更改的配置发出信号。</p>
<h2 id="总结">总结</h2>
<p>OK，至此，对于<code>override_settings</code>的分析就结束了，它的功能也比较简单，就是在一个作用域中修改配置，并在这个作用域结束的时候将配置还原，如果它修饰的作用域是一个函数的话，由于函数不像类有构造和析构函数，它就使用Python的上下文管理器来实现类的构造和析构函数的功能。</p>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-aca9b1506e43349a065aee60cb29920c">1.5 - Django中import_string的实现</h1>
    
	<blockquote>
<p><strong>摘要</strong>:</p>
<ol>
<li>importlib.import_module 函数的功能</li>
<li>import_string 函数的实现</li>
</ol>
</blockquote>
<h2 id="前言">前言</h2>
<p>今天开始来读 Django 的代码，首先想在 Django 内部设置一个logger用来打印调试日志，结果发现在Django内部，DEBUG日志显示不出来，然后我就想这肯定是Django配置日志的时候，根据logger的名字，来确定了一定的日志级别。</p>
<p>于是我就想看看Django的日志是如何配置的，顺着<code>manage.py</code>中的<code>execute_from_command_line</code>一路往下找，就找到了<code>django.utils.log.configure_logging</code>函数，在这个函数中，第一个就遇到了<code>import_string</code>函数，虽然一眼就能看出，这个函数的功能就是通过字符串来导入相应的函数的，但还是忍不住想要看一下它的实现，千里之行，始于足下，阅读Django源码的过程，就从这个11行的函数开始吧。</p>
<h2 id="python的import_module函数">Python的<code>import_module</code>函数</h2>
<p>函数声明: <code>importlib.import_module(name, package=None)</code></p>
<ol>
<li>从<a href="https://docs.python.org/3/library/importlib.html#importlib.import_module">文档</a>中可以看出，这个函数的主要功能就是导入指定的包或者模块,它并不能导入模块中的类或者函数。</li>
<li>这个函数还支持相对导入，如果要使用相对导入的话，需要设置第二个参数<code>package</code>来确认执行相对导入时的当前路径。</li>
<li>如果你想要在运行时动态导入的话，比如新创建一个Python文件再来导入，需要调用<code>importlib.invalidate_caches</code>函数，来确保让导入系统能够发现新的模块。</li>
</ol>
<h2 id="django的import_string函数">Django的<code>import_string</code>函数</h2>
<p><code>import_string</code>函数的代码如下所示：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">import_string</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dotted_path</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">try</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">module_path</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">class_name</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">dotted_path</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">rsplit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;.&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">except</span> <span style="color:#c00;font-weight:bold">ValueError</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">raise</span> <span style="color:#c00;font-weight:bold">ImportError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;</span><span style="color:#4e9a06">%s</span><span style="color:#4e9a06"> doesn&#39;t look like a module path&#34;</span> <span style="color:#ce5c00;font-weight:bold">%</span> <span style="color:#000">dotted_path</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">module</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">import_module</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">module_path</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">try</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87">getattr</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">module</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">class_name</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">except</span> <span style="color:#c00;font-weight:bold">AttributeError</span> <span style="color:#204a87;font-weight:bold">as</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">raise</span> <span style="color:#c00;font-weight:bold">ImportError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;Module &#34;</span><span style="color:#4e9a06">%s</span><span style="color:#4e9a06">&#34; does not define a &#34;</span><span style="color:#4e9a06">%s</span><span style="color:#4e9a06">&#34; attribute/class&#39;</span> <span style="color:#ce5c00;font-weight:bold">%</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">module_path</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">class_name</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">from</span> <span style="color:#000">err</span>
</span></span></code></pre></div><p>从代码中我们可以看出，这个函数其实很简单，就是首先将要导入的路径名分割成模块名和类名，然后再来从模块中获得到类这个属性，然后就完成了。照着这个思路来看，其实我们导入一个函数也是可以的。</p>
</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-06c8412cc3af28159e2513c942e98de4">2 - Life</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-b5975d2a2f61c014357cefc9275fe13f">2.1 - 编程语言很重要</h1>
    
	<blockquote>
<p>一番暴论</p>
</blockquote>
<hr>
<h2 id="编程语言不仅是语法">编程语言不仅是语法</h2>
<p>在大学时，就一直听到一些言论</p>
<blockquote>
<ol>
<li>学什么编程语言不重要，重要的是理解语言背后的设计思想</li>
<li>学会一门编程语言后，再学其他语言就很容易了，因为语法都是通用的</li>
</ol>
</blockquote>
<p>今日突发奇想，想发表一番暴论，</p>
<blockquote>
<p>语言很重要，重要的是生态和向后兼容</p>
</blockquote>
<h2 id="npm-依赖管理">npm 依赖管理</h2>
<p>学习一门语言不仅仅是为了写 Hello World 或解几个算法题，而是用它去创造一些软件，用软件满足一些人的需求。在今天，我们已经很难从0开始实现一个软件，大部分时候都要依赖框架，库去开发我们的软件。这就涉及到一个问题，X 语言如何管理项目的依赖？</p>
<p>我极度讨厌使用 npm 管理依赖( node_modules 太恶心了)。曾尝试过使用浏览器支持 <a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Guide/Modules">JavaScript Modules</a> 去导入依赖，但后来发现绕过 npm 很难。因为这个社区的大部分人都是使用 npm/yarn 来管理依赖的，你不使用 npm/yarn，使用其他人的库时就会遇到奇怪的问题。<strong>在社区中，你必须要顺应主流，要不然就要比其他人多花费时间。</strong></p>
<p>Python 的依赖管理也同样让人头疼，Python 中有大量的库使用了 C/C++ 语言去调用其他 C/C++ 库，<code>setup.py</code> 中可以声明依赖的 Python 库，但无法声明依赖的 C++ 库。很多 Python 库都是推荐使用 apt/yum/brew 等系统的依赖管理工具来管理其依赖的 C++ 库，这样就增加了复杂度，且也容易让系统出问题。</p>
<h2 id="向后兼容">向后兼容</h2>
<p>我学过的语言中，向后兼容做的最差的就是 Python 和 NodeJS，不同版本之间差异太大，导致项目升级困难。</p>
<p>我任职的公司有个前端项目，每年年底时都会用到它，但每年都会重写一遍，因为重写的成本比较低，之前尝试过在原有项目的基础上改动，但光把项目运行起来就卡了好久。</p>
<p>Python 更不用说，2/3 的兼容性吓跑了很多人，Python 3 版本之间的兼容性也没做到完美，升级 Python 3 版本时，经常会发现某标准库的 API 出现了改动，需要改项目代码。</p>
<p>我遇到的向后兼容做的最好的是 Java 和 Golang，Java 自不必说，字节码都是向后兼容的，这样才保证了 JVM 生态的繁荣。Go 目前还比较年轻，历史包袱少，break changes 几乎没有，最大的黑点就是依赖管理从 GOPATH 迁移到 go module 需要做修改。曾在 twitter 上看到过某人说，自己五年前的一个 Go 项目，用新版本的 Go 编译器 build，仍然能够通过，这种特性真的太让人羡慕了。</p>
<p>一门语言做到向后兼容，会背负很多历史包袱，但也延长了项目的生命周期。语言设计者为了自己方便，做出 break changes。到头来工作量转移到了开发者的头上，如果项目没有用还好，要是项目还在使用的话，就需要开发者花时间去做升级。<strong>人生苦短，远离那些随意做出 break changes 的语言</strong>。</p>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-39d58b1f4f522a20e8f96df990ebdab6">2.2 - 如何阅读网络上的小作文</h1>
    
	<hr>
<h2 id="怎么做网络小作文的阅读理解">怎么做网络小作文的阅读理解</h2>
<p>新闻五要素是：时间、地点、人物、事件、原因。看小作文的时候，五要素略有不同：时间、地点、主语、谓语、宾语。因为不能强求别人知道原因是什么。但是，但是，但是，主谓宾总应该有，时间地点总应该有。</p>
<p>看小作文的步骤</p>
<ul>
<li>第一步，是删除仅表达情绪而不包含有效信息的句子。</li>
<li>第二步，对剩下来的句子删除其中仅仅表达情绪而不包含有效信息的形容词、感叹词、惊叹号等。</li>
<li>第三步，根据剩下来的内容，对每一个描述梳理五要素。要素缺乏的地方，打个问号。</li>
<li>第四步，根据以上过程梳理出来内容，对每一个指控，分析一下利害关系和动机。看看受益者是谁，受损者是谁。看看被指控人是不是受益了，指控者是不是受损了。看看被指控的行为是不是存在动机。</li>
<li>第五步，把第三步中的问号改成各种不同的内容，比如把时间要素分别改为“今天”、“去年”、“大前年”，看看是否会影响你对事情的看法。如果会，就要考虑这些缺失的要素可能是被故意省略的。需要追问一下小作文的作者，这些要素到底是什么。</li>
</ul>
<h2 id="参考链接">参考链接</h2>
<ul>
<li><a href="https://weibo.com/u/1401527553">https://weibo.com/u/1401527553</a></li>
</ul>
</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-3ff1a20d0d0de02c74fbf433a1a36d88">3 - Tools</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-297d99de8aaaafab296dd30fc04b7e20">3.1 - Mac OSX 使用技巧</h1>
    
	<hr>
<h2 id="修改某类文件的默认打开方式">修改某类文件的默认打开方式</h2>
<ol>
<li>获取应用的ID: <code>osascript -e 'id of app &quot;Sublime Text&quot;'</code>，应用的名称可以在<code>/Applications</code>中获取到</li>
<li>安装duti: <code>brew install duti</code></li>
<li>设置某类文件的默认打开方式: <code>duti -s com.sublimetext.3 .py all</code></li>
</ol>
<h2 id="强制退出应用">强制退出应用</h2>
<p><code>Command</code> + <code>Option</code> + <code>Esc</code> 打开活动监视器，选择应用强制退出</p>
<h2 id="为知笔记">为知笔记</h2>
<ul>
<li>笔记内容的存储位置: <code>/Users/michaeltsui/.wiznote/bwangel.me@gmail.com/data/notes</code>，是按照 zip 压缩存储的。解压出来就是 markdown 文件或者HTML文件。</li>
<li><code>~/.wiznote</code> 为为知笔记的数据目录</li>
<li>参考链接：<a href="http://www.wiz.cn/faq/mac/data_dir"> Mac版的笔记数据在哪个目录？</a></li>
</ul>
<h2 id="时间戳">时间戳</h2>
<h3 id="获取时间戳">获取时间戳</h3>
<pre tabindex="0"><code>ø&gt; date +%s
1580006193
</code></pre><h3 id="获取特定时间的时间戳">获取特定时间的时间戳</h3>
<pre tabindex="0"><code>$ date -j -f %Y-%m-%d 2015-09-28 +%s
1443427891
</code></pre><h3 id="时间戳转时间">时间戳转时间</h3>
<pre tabindex="0"><code>ø&gt; date -r 1443429736
Mon Sep 28 16:42:16 CST 2015
</code></pre><h2 id="快捷键">快捷键</h2>
<p><code>SPlayer</code> 会占用 <code>shift+cmd+l</code> 全局快捷键</p>
<h2 id="brew-编译选项">brew 编译选项</h2>
<p>brew 的编译选项需要在 <code>--</code> 后加</p>
<pre tabindex="0"><code>brew install macvim -- --with-override-system-vim --with-lua --with-luajit
</code></pre><ul>
<li><a href="https://github.com/skwp/dotfiles/issues/817">https://github.com/skwp/dotfiles/issues/817</a></li>
<li><a href="https://github.com/Homebrew/homebrew-core/issues/31510">https://github.com/Homebrew/homebrew-core/issues/31510</a></li>
</ul>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-5150748bdd00e15c7d1f9160a3f74404">3.2 - Vagrant 添加挂载目录</h1>
    
	<hr>
<h2 id="tips">Tips</h2>
<p><code>cfg.vm.synced_folder</code> 可以设置挂载目录</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 第一个参数为宿主机目录，第二个参数是虚拟机目录</span>
</span></span><span style="display:flex;"><span>      node.vm.synced_folder <span style="color:#4e9a06">&#34;/Users/michaeltsui/Github/Golang/&#34;</span>, <span style="color:#4e9a06">&#34;/code&#34;</span>
</span></span></code></pre></div><h2 id="参考链接">参考链接</h2>
<ul>
<li><a href="https://stackoverflow.com/a/18529697/5161084">https://stackoverflow.com/a/18529697/5161084</a></li>
<li><a href="https://www.vagrantup.com/docs/synced-folders/basic_usage">https://www.vagrantup.com/docs/synced-folders/basic_usage</a></li>
</ul>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-0d870642f3ff6fd1df82b10758efa90e">3.3 - Github 客户端 gh 添加搜索仓库的命令</h1>
    
	<hr>
<h2 id="tips">Tips</h2>
<pre tabindex="0"><code>gh alias set s &#39;api -X GET search/repositories -f q=&#34;$1&#34; --template &#34;{{range .items}}{{ printf \&#34;%v\\n--------------\\n%v\\n\\n\&#34; .full_name .description }}{{ end }}&#34;&#39;
</code></pre><h2 id="参考链接">参考链接</h2>
<ul>
<li><a href="https://github.com/cli/cli/pull/830#issuecomment-812972624">Gh 添加 repoSearch alias</a></li>
</ul>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-611e8933475655ab5720b3370081eaf2">3.4 - Java 抛出UnsupportedEncodingException</h1>
    
	<hr>
<h2 id="tips">Tips</h2>
<p>这个异常表示当前系统不支持此编码。大部分系统是支持的，所以没必要抛出这个异常。</p>
<p>当我们调用 <code>String.getBytes()</code> 传入一个 <code>Charset</code> 参数时，就会调用其重载方法</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">byte</span><span style="color:#ce5c00;font-weight:bold">[]</span> <span style="color:#000">getBytes</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">Charset</span> <span style="color:#000">charset</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span></code></pre></div><p>这样就不会抛出异常了</p>
<h2 id="参考链接">参考链接</h2>
<ul>
<li><a href="https://skyao.github.io/2016/01/13/java-string-practice/">java中String和byte数组转换的小技巧</a></li>
</ul>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-9cd99af5426a65caba642cf46c4be99b">3.5 - Rabbitmq Tutorial 学习笔记</h1>
    
	<blockquote>
<ul>
<li><a href="https://www.rabbitmq.com/getstarted.html">RabbitMQ Tutorial</a> 学习笔记</li>
<li>本文相关代码放在 <a href="https://github.com/bwangelme/RabbitMQDemo">Github@bwangelme/RabbitMQDemo</a> 中</li>
</ul>
</blockquote>
<hr>
<h1 id="rabbitmq-基础概念介绍">RabbitMQ 基础概念介绍</h1>
<p><img src="https://passage-1253400711.cos-website.ap-beijing.myqcloud.com/2020-01-07-152647.jpg" alt=""></p>
<p>上图展示的 RabbitMQ 的一些基础概念和它们之间的关系。这里为了方便展示，只显示了一个生产者，且每个消费者只绑定了一个队列。</p>
<p>生产者(<code>Producer</code>)将消息发布(<code>Pubscribe</code>)到交换机(<code>Exchange</code>)上，交换机将消息转发给一个或多个（根据交换机的类型确定）队列(<code>Queue</code>)。队列将收到的消息发送给订阅(<code>Subscribe</code>)该队列的消费者(<code>Consumer</code>)。</p>
<h2 id="publish">Publish</h2>
<p>生产者将消息发送到交换机的过程称为<code>Publish</code>，下面是<code>Publish</code>的示例代码:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>    <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">ch</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Publish</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span>     <span style="color:#8f5902;font-style:italic">// exchange
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#4e9a06">&#34;abcd&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#8f5902;font-style:italic">// Route key
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span>  <span style="color:#8f5902;font-style:italic">// mandatory 强制的
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span>  <span style="color:#8f5902;font-style:italic">// immediate 即时的
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">amqp</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Publishing</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">DeliveryMode</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">amqp</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Persistent</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">ContentType</span><span style="color:#000;font-weight:bold">:</span>  <span style="color:#4e9a06">&#34;text/plain&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">Body</span><span style="color:#000;font-weight:bold">:</span>         <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87">byte</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">body</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p><code>Publish</code>的前两个参数分别是交换机名称和<code>Route Key</code>。</p>
<p>我们在这里将消息发送给了无名交换机（即交换机的名称为空字符串<code>&quot;&quot;</code>），这是 RabbitMQ 默认就会创建的交换机，它是<code>direct</code>类型(关于交换机的类型会在下文中讲述)。</p>
<h2 id="队列与-binding">队列与 Binding</h2>
<p>生产者直接将消息发送给交换机，但是消费者不能直接从交换机读取消息。</p>
<p>它需要创建一个队列，将队列和交换机绑定(<code>Bind</code>)起来，然后才能从队列中收到交换机转发过来的消息。</p>
<p>消费者从队列读取消息的过程称为<code>Consume</code>，队列和交换机的绑定关系叫做<code>Binding</code>。</p>
<h3 id="创建临时队列">创建临时队列</h3>
<p>当我们需要创建一个只用一次的队列时，可以通过指定<code>exclusive=true</code>参数来实现:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">q</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">ch</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">QueueDeclare</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span>    <span style="color:#8f5902;font-style:italic">// name
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#8f5902;font-style:italic">// durable
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#8f5902;font-style:italic">// delete when unused
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span>  <span style="color:#8f5902;font-style:italic">// exclusive
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#8f5902;font-style:italic">// no-wait
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span>   <span style="color:#8f5902;font-style:italic">// arguments
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>上述代码创建了一个临时队列，在 <code>Channel</code>（客户端和 RabbitMQ 交互的中介）关闭之后，该队列就会被自动删除，注意指定了三个参数，<code>name=&quot;&quot;</code>, <code>durable=false</code>(不进行持久化存储), <code>exclusive=true</code>(只使用一次)。</p>
<p>上述代码会返回一个临时队列，队列的名字类似于这样: <code>amq.gen-JzTY20BRgKO-HjmUJj0wLg</code>。想要了解 Exclusive 队列的更多信息，请参考文档 <a href="https://www.rabbitmq.com/queues.html">Guide on Queues</a></p>
<p>通过<code>rabbitmqctl list_queues</code> 可以查看我们创建的所有队列。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>ø&gt; rabbitmqctl list_queues
</span></span><span style="display:flex;"><span>Timeout: 60.0 seconds ...
</span></span><span style="display:flex;"><span>Listing queues <span style="color:#204a87;font-weight:bold">for</span> vhost / ...
</span></span><span style="display:flex;"><span>name    messages
</span></span><span style="display:flex;"><span>hipri   <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>task_queue      <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>second  <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>celery  <span style="color:#0000cf;font-weight:bold">0</span>
</span></span></code></pre></div><h3 id="创建和查看-binding">创建和查看 Binding</h3>
<p>将队列绑定到交换机的代码如下，前三个参数分别是<code>队列名称</code>，<code>Bind Key</code>，和<code>交换机名称</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">ch</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">QueueBind</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">q</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#8f5902;font-style:italic">// queue name
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span>     <span style="color:#8f5902;font-style:italic">// bind key
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#4e9a06">&#34;logs&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#8f5902;font-style:italic">// exchange name
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>通过 <code>rabbitmqctl list_bindgs</code> 命令我们可以查看 RabbitMQ 中所有的 Binding。</p>
<h2 id="consume">Consume</h2>
<p>消费者从队列中读取消息的过程称为<code>Consume</code></p>
<p>下面是<code>Consume</code>的示例代码，返回值<code>msgs</code>是Go语言中的 channel 类型，消费者可以从中读取队列返回的的消息。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">msgs</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">ch</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Consume</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">q</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#8f5902;font-style:italic">// name
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span>     <span style="color:#8f5902;font-style:italic">// consumer
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span>   <span style="color:#8f5902;font-style:italic">// auto ack
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span>  <span style="color:#8f5902;font-style:italic">// exclusive
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span>  <span style="color:#8f5902;font-style:italic">// no-local
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span>  <span style="color:#8f5902;font-style:italic">// no-wait
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span>    <span style="color:#8f5902;font-style:italic">// args
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h1 id="交换机的类型与特性">交换机的类型与特性</h1>
<p>交换机一端接收消息，另外一端发送消息到队列中。</p>
<p>交换机处理消息的方式是由它的类型决定的，交换机共有这么几种类型: <code>direct</code>, <code>topic</code>, <code>headers</code>, <code>fanout</code>。</p>
<h2 id="查看交换机">查看交换机</h2>
<p>通过命令 <code>rabbitmqctl list_exchanges</code> 就可以列出所有的交换机:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>&gt;&gt;&gt; rabbitmqctl list_exchanges
</span></span><span style="display:flex;"><span>Listing exchanges <span style="color:#204a87;font-weight:bold">for</span> vhost / ...
</span></span><span style="display:flex;"><span>name    <span style="color:#204a87">type</span>
</span></span><span style="display:flex;"><span>amq.fanout      fanout
</span></span><span style="display:flex;"><span>amq.headers     headers
</span></span><span style="display:flex;"><span>amq.match       headers
</span></span><span style="display:flex;"><span>amq.direct      direct
</span></span><span style="display:flex;"><span>amq.topic       topic
</span></span><span style="display:flex;"><span>        direct
</span></span><span style="display:flex;"><span>amq.rabbitmq.log        topic
</span></span><span style="display:flex;"><span>amq.rabbitmq.trace      topic
</span></span></code></pre></div><p>我们可以看到 RabbitMQ 中已经预置了 <code>amq.*</code> 交换机和一个无名交换机(<code>&quot;&quot;</code>)。无名交换机是默认交换机，所有未指定交换机名称的消息都会发到这里来。</p>
<h2 id="direct-交换机">Direct 交换机</h2>
<p>我们将<code>Publish</code>时指定的<code>key</code>称为<code>Route Key</code>, 将消费者 Bind 到交换机时指定的<code>key</code>成为 <code>Bind key</code>。</p>
<p>Direct 交换机的转发逻辑很简单，就是寻找声明的 <code>Bind key</code> == <code>Route key</code> 队列，然后将消息转发到该队列上。</p>
<p>它支持一个队列使用多个<code>Bind Key</code>，也支持多个队列使用同一个 <code>Bind key</code>。</p>
<h2 id="direct-交换机示例">Direct 交换机示例</h2>
<p>下图是一个 Direct 交换机的完整例子，我们使用日志等级名称作为<code>Route Key</code>。</p>
<p>2号消费者绑定了<code>debug</code> key，3号消费者绑定了<code>info</code> key。可以看到，1号生成者分别发送了两条消息，这些消息根据<code>Route Key</code>的不同，发送到了不同的消费者上。</p>
<p><img src="https://passage-1253400711.cos-website.ap-beijing.myqcloud.com/2020-01-11-084105.png" alt=""></p>
<p><strong>该示例的代码详见 <a href="https://github.com/bwangelme/RabbitMQDemo/tree/3593d57">Github@3593d57</a> 。</strong></p>
<h2 id="fanout-交换机">Fanout 交换机</h2>
<p>Fanout 类型交换机的转发策略非常简单，它就是将收到的消息发送给所有绑定的队列，这点从它的名字（<code>Fanout</code> 扇出）就可以看出。</p>
<h2 id="fanout-交换机示例">Fanout 交换机示例</h2>
<p>下图是 Fanout 交换机的例子，2号消费者和3号消费者将不同的队列绑定到了同一个 Fanout 交换机上，然后1号生产者发出了两条消息，这两个消费者都收到了。</p>
<p><img src="https://passage-1253400711.cos-website.ap-beijing.myqcloud.com/2020-01-11-084917.png" alt=""></p>
<p><strong>该示例的代码详见 <a href="https://github.com/bwangelme/RabbitMQDemo/tree/cf8f902">Github@cf8f902</a></strong></p>
<h2 id="topic-交换机">Topic 交换机</h2>
<p>Topic 交换机 也是按照<code>Bind Key</code>对<code>Route Key</code>进行匹配，不过它可以指定<code>Bind Key</code>的模式，匹配一批<code>Route Key</code>。</p>
<ul>
<li><code>Route Key</code>按照<code>.</code>分割，<code>.</code>之间的内容称为一个单词。</li>
<li><code>Bind Key</code>支持两个通配符<code>#</code>和<code>*</code>，<code>#</code>代表一个或多个单词，<code>*</code>代表一个单词。</li>
</ul>
<p>例如<code>Route Key</code> <code>a.#</code> 会匹配 <code>a.b.c.d</code>, <code>a.b.c</code> 等，<code>a.*</code>只会匹配<code>a.b</code>, <code>a.c</code>，不会匹配<code>a.b.c</code></p>
<p>如果<code>Bind Key</code>中没有<code>#</code>和<code>*</code>通配符，那么这个 Topic 交换机其实就是一个 Direct 类型的交换机，
同理，如果<code>Bind Key</code>是<code>#</code>，那么这个 Topic 交换机就是一个 Fanout 类型的交换机。</p>
<h2 id="topic-交换机示例">Topic 交换机示例</h2>
<p>下图是一个 Topic 交换机的例子，我们做了一个收集日志的简易客户端，<code>Route Key</code>遵循<code>模块.级别</code>的模式。生产者可以订阅不同模式的日志，然后将日志写到不同的文件中。
其中2号消费者订阅的是所有模块<code>info</code>级别和所有<code>net</code>模块的日志，3号消费者订阅的是<code>kernel</code>模块<code>debug</code>级别的日志。</p>
<p><img src="https://passage-1253400711.cos-website.ap-beijing.myqcloud.com/2019-12-18-142810.png" alt=""></p>
<p><strong>该示例的代码详见 <a href="https://github.com/bwangelme/RabbitMQDemo/tree/b56c3b1">Github@b56c3b1</a></strong></p>
<p>注意红框内的消息，1号生产者发送了<code>Route Key = net.info</code>的一条消息，
但由于2号消费者中__只有一个队列__绑定了<code>*.info</code>和<code>net.*</code>这两个模式，所以2号消费者只收到了一条消息。</p>
<h1 id="消息的分发与确认">消息的分发与确认</h1>
<h2 id="轮询分发">轮询分发</h2>
<p>在 RabbitMQ 中，消息默认是通过<code>轮询分发</code>的方式进行发送的。具体来说，就是顺序地给绑定同一个队列的每个消费者发送消息，平均下来，每个消费者获得的消息数量是相同的。</p>
<p>可以参考下面这个例子:
<img src="https://passage-1253400711.cos-website.ap-beijing.myqcloud.com/2020-01-08-144228.png" alt="round-robin Example"></p>
<p><strong>该示例的代码详见 <a href="https://github.com/bwangelme/RabbitMQDemo/tree/41c82064edbde8c3bf74c1474420da821f7ac6dc">Github@41c82064</a> 。</strong></p>
<p>1号窗口是生产者，2，3，4，5号窗口都是消费者。</p>
<p>生产者一共发送了10条消息，他们被顺序地发送给四个消费者。</p>
<h2 id="公平分发">公平分发</h2>
<p>轮询分发的策略有时候并不适合实际的业务，可能会导致某些消费者特别忙，但是另一些消费者很闲的情况。</p>
<p>例如下面的这个例子，消息中<code>.</code>的数量表示<code>Sleep</code>的秒数，<code>.</code>越多，表示工作越繁重。</p>
<p>1号生产者发送的奇数消息都很繁重，偶数消息都很轻松，导致2号消费者很忙，3号消费者很轻松（）。</p>
<p><img src="https://passage-1253400711.cos-website.ap-beijing.myqcloud.com/2020-01-08-145032.png" alt=""></p>
<p><strong>该示例的代码详见 <a href="https://github.com/bwangelme/RabbitMQDemo/tree/14a0414">Github@14a0414</a></strong></p>
<p>为了避免这种极端情况的发生，我们可以设置预取值(<code>prefetch count</code>)为1。这样的话，相当于告诉 RabbitMQ，在 Worker 消费完一个消息之前，不要再给他分发新的消息了，这样的话随后的消息就会被分发给其他的空闲的 Worker 了。</p>
<p>在具体代码如下:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 在 Worker 的代码中设置
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">ch</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Qos</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span>     <span style="color:#8f5902;font-style:italic">// prefetch count
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span>     <span style="color:#8f5902;font-style:italic">// prefetch size
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#8f5902;font-style:italic">// global
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>运行效果如下:</p>
<p><img src="https://passage-1253400711.cos-website.ap-beijing.myqcloud.com/2020-01-08-150016.png" alt=""></p>
<p><strong>该示例的代码详见<a href="https://github.com/bwangelme/RabbitMQDemo/tree/ad5507e">Github@ad5507e</a></strong></p>
<p>可以看到2号窗口和3号窗口中的消费者都分配到了耗时较长的任务。</p>
<p><strong>注意:</strong> 这样操作容易让 RabbitMQ 的队列被塞满，需要有合适的监控机制来监控消息的数量。</p>
<h2 id="消息确认">消息确认</h2>
<p>当消费者收到消息后，可能会遇到某种异常崩溃了，此时这条消息就会丢失了。</p>
<p>为了避免这种情况，我们可以使用 RabbitMQ 提供的消息确认机制。</p>
<p>消费者在消费完消息后，再向 RabbitMQ 发送 ack。收到 ack 之后，RabbitMQ 才会把这条消息标记为可删除的，并择机删除。
如果 RabbitMQ 没有收到 ack，消费者就死掉了（channel 关闭，连接关闭，或者 TCP 连接关闭）。
那么 RabbitMQ 就会认为这条消息没有被消费完，它就会重新入队，然后被快速发送给其他消费者。</p>
<p>使用了消息确认机制后，我们就可以确保即使存在消费者偶尔崩溃的情况，我们的消息也不会丢失。</p>
<p>在消息确认机制中，没有任何的超时限制，所以即使客户端花费很长的时间去处理消息，也不用担心消息会被误重发。</p>
<p>具体代码如下，我们在消费者订阅的时候将<code>auto_ack</code>选项关掉，然后再在消费完消息后手动发送 Ack</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// 消费者从队列订阅消息
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">msgs</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">ch</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Consume</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">q</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#8f5902;font-style:italic">// name
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span>     <span style="color:#8f5902;font-style:italic">// consumer
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span>   <span style="color:#8f5902;font-style:italic">// 关闭掉 autoack
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span>  <span style="color:#8f5902;font-style:italic">// exclusive
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span>  <span style="color:#8f5902;font-style:italic">// no-local
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span>  <span style="color:#8f5902;font-style:italic">// no-wait
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span>    <span style="color:#8f5902;font-style:italic">// args
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">go</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">d</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">msgs</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Received a message: %s&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">d</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Body</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">dot_count</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">bytes</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Count</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Body</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87">byte</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;.&#34;</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">t</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Duration</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dot_count</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sleep</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Second</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Done&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">d</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Ack</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic">// 手动发送 ack
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}()</span>
</span></span></code></pre></div><p>示例如下，3号消费者在 <code>23:08:54</code> 收到消息后，还没有确认(确认后会打印 Done )，就被我们 kill 掉了。2号消费者在<code>23:08:55</code>重新收到了这条消息。</p>
<p><img src="https://passage-1253400711.cos-website.ap-beijing.myqcloud.com/2020-01-08-151127.png" alt=""></p>
<p><strong>该示例代码详见<a href="https://github.com/bwangelme/RabbitMQDemo/tree/9cd87dd">Github@9cd87dd</a></strong></p>
<h1 id="持久化">持久化</h1>
<p>通过消息确认，我们可以在消费者崩溃的情况下，让我们的消息不丢失。但如果 RabbitMQ 崩溃，或者 RabbitMQ 所在的节点宕机的话，消息仍然可能会丢失。</p>
<p>在这种情况下，我们可以使用消息和队列持久化，这样的话即使 RabbitMQ 退出，消息和队列也回被持久化到磁盘中，不会丢失。</p>
<h2 id="声明队列持久化">声明队列持久化</h2>
<p>声明队列持久化的代码如下:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>    <span style="color:#000">q</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">ch</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">QueueDeclare</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;task_queue&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#8f5902;font-style:italic">// Queue name
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span>   <span style="color:#8f5902;font-style:italic">// durable  持久性
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span>   <span style="color:#8f5902;font-style:italic">// delete when unused
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span>   <span style="color:#8f5902;font-style:italic">// exclusive 独占
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span>   <span style="color:#8f5902;font-style:italic">// no-wait
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span>     <span style="color:#8f5902;font-style:italic">// arguments
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p><strong>注意:</strong> 在声明队列时，如果我们声明一个已经存在的队列，但是初始化参数不同的时候，<code>QueueDeclare</code>会失败并返回一个 err。</p>
<h2 id="声明消息持久化">声明消息持久化</h2>
<p>在发送消息的时候，我们可以设置一个 <code>amqp.Persistent</code> 选项，来表明这个消息应该被持久化。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>    <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">ch</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Publish</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">,</span>     <span style="color:#8f5902;font-style:italic">//exchange
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">q</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#8f5902;font-style:italic">// route key
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span>  <span style="color:#8f5902;font-style:italic">// mandatory 强制的
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span>  <span style="color:#8f5902;font-style:italic">// immediate 即时的
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">amqp</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Publishing</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">DeliveryMode</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">amqp</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Persistent</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#8f5902;font-style:italic">// 声明消息持久化
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>            <span style="color:#000">ContentType</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;text/plain&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">Body</span><span style="color:#000;font-weight:bold">:</span>        <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87">byte</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">body</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h2 id="关于消息持久化注意事项">关于消息持久化注意事项</h2>
<p>上述声明消息持久化的代码，并不能100%保证消息不会丢失，有以下两方面的原因:</p>
<ol>
<li>在 RabbitMQ 收到消息和 RabbitMQ 将消息写入磁盘这两个事件中仍然有一个短暂的时间窗口。如果在这个时间窗口内发生宕机的话，消息仍然会丢失。</li>
<li>RabbitMQ 并不会每次收到消息后，都调用 <code>fsync(2)</code>，消息可能被存储在缓存中，过一段时间后才被写入到磁盘中。</li>
</ol>
<p>因此，这个持久化策略并不是强健的，如果你想使用更强健的持久化策略，可以考虑 <a href="https://www.rabbitmq.com/confirms.html">Publisher Confirms</a>。</p>
</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-52710525e0e85b3607a18dda64e4a590">4 - TCP/IP</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-b18443c3dbf086414f4fb6e642eda08e">4.1 - 混杂模式</h1>
    
	<hr>
<h2 id="定义">定义</h2>
<p>混杂模式是指一个网卡会把它接收的所有网络流量都交给 CPU，而不是只把它想转交的部分交给 CPU。</p>
<p>在 IEEE 802 定的网络规范中，每个网络帧都有一个目的 MAC 地址。在非混杂模式下，网卡只会接收目的地址是它自己的单播帧，以及多播及广播帧；在混杂模式下，网卡会接收经过它的所有帧。</p>
<h2 id="查看">查看</h2>
<p>使用 <code>netstat -i</code> 和 <code>ifconfig</code> 可以查看网卡的状态</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>ø&gt; sudo netstat -i
</span></span><span style="display:flex;"><span>Kernel Interface table
</span></span><span style="display:flex;"><span>Iface      MTU    RX-OK RX-ERR RX-DRP RX-OVR    TX-OK TX-ERR TX-DRP TX-OVR Flg
</span></span><span style="display:flex;"><span>br-7fd48  <span style="color:#0000cf;font-weight:bold">1500</span>        <span style="color:#0000cf;font-weight:bold">0</span>      <span style="color:#0000cf;font-weight:bold">0</span>      <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#0000cf;font-weight:bold">0</span>             <span style="color:#0000cf;font-weight:bold">0</span>      <span style="color:#0000cf;font-weight:bold">0</span>      <span style="color:#0000cf;font-weight:bold">0</span>      <span style="color:#0000cf;font-weight:bold">0</span> BMU
</span></span><span style="display:flex;"><span>br-bade7  <span style="color:#0000cf;font-weight:bold">1500</span>        <span style="color:#0000cf;font-weight:bold">0</span>      <span style="color:#0000cf;font-weight:bold">0</span>      <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#0000cf;font-weight:bold">0</span>             <span style="color:#0000cf;font-weight:bold">0</span>      <span style="color:#0000cf;font-weight:bold">0</span>      <span style="color:#0000cf;font-weight:bold">0</span>      <span style="color:#0000cf;font-weight:bold">0</span> BMU
</span></span><span style="display:flex;"><span>docker0   <span style="color:#0000cf;font-weight:bold">1500</span>        <span style="color:#0000cf;font-weight:bold">0</span>      <span style="color:#0000cf;font-weight:bold">0</span>      <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#0000cf;font-weight:bold">0</span>             <span style="color:#0000cf;font-weight:bold">0</span>      <span style="color:#0000cf;font-weight:bold">0</span>      <span style="color:#0000cf;font-weight:bold">0</span>      <span style="color:#0000cf;font-weight:bold">0</span> BMU
</span></span><span style="display:flex;"><span>enp0s3    <span style="color:#0000cf;font-weight:bold">1500</span>      <span style="color:#0000cf;font-weight:bold">999</span>      <span style="color:#0000cf;font-weight:bold">0</span>      <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#0000cf;font-weight:bold">0</span>           <span style="color:#0000cf;font-weight:bold">692</span>      <span style="color:#0000cf;font-weight:bold">0</span>      <span style="color:#0000cf;font-weight:bold">0</span>      <span style="color:#0000cf;font-weight:bold">0</span> BMRU
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># P 表示网卡 enp0s8 开启了混杂模式 promisc</span>
</span></span><span style="display:flex;"><span>enp0s8    <span style="color:#0000cf;font-weight:bold">1500</span>        <span style="color:#0000cf;font-weight:bold">1</span>      <span style="color:#0000cf;font-weight:bold">0</span>      <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#0000cf;font-weight:bold">0</span>            <span style="color:#0000cf;font-weight:bold">17</span>      <span style="color:#0000cf;font-weight:bold">0</span>      <span style="color:#0000cf;font-weight:bold">0</span>      <span style="color:#0000cf;font-weight:bold">0</span> BMPRU
</span></span><span style="display:flex;"><span>lo       <span style="color:#0000cf;font-weight:bold">65536</span>        <span style="color:#0000cf;font-weight:bold">8</span>      <span style="color:#0000cf;font-weight:bold">0</span>      <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#0000cf;font-weight:bold">0</span>             <span style="color:#0000cf;font-weight:bold">8</span>      <span style="color:#0000cf;font-weight:bold">0</span>      <span style="color:#0000cf;font-weight:bold">0</span>      <span style="color:#0000cf;font-weight:bold">0</span> LRU
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ø&gt; ifconfig enp0s8
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># PROMISC 表示 enp0s8 开启了混杂模式</span>
</span></span><span style="display:flex;"><span>enp0s8: <span style="color:#000">flags</span><span style="color:#ce5c00;font-weight:bold">=</span>4419&lt;UP,BROADCAST,RUNNING,PROMISC,MULTICAST&gt;  mtu <span style="color:#0000cf;font-weight:bold">1500</span>
</span></span><span style="display:flex;"><span>        inet 192.168.56.23  netmask 255.255.255.0  broadcast 192.168.56.255
</span></span><span style="display:flex;"><span>        inet6 fe80::a00:27ff:fedd:4aec  prefixlen <span style="color:#0000cf;font-weight:bold">64</span>  scopeid 0x20&lt;link&gt;
</span></span><span style="display:flex;"><span>        ether 08:00:27:dd:4a:ec  txqueuelen <span style="color:#0000cf;font-weight:bold">1000</span>  <span style="color:#ce5c00;font-weight:bold">(</span>Ethernet<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        RX packets <span style="color:#0000cf;font-weight:bold">1</span>  bytes <span style="color:#0000cf;font-weight:bold">86</span> <span style="color:#ce5c00;font-weight:bold">(</span>86.0 B<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        RX errors <span style="color:#0000cf;font-weight:bold">0</span>  dropped <span style="color:#0000cf;font-weight:bold">0</span>  overruns <span style="color:#0000cf;font-weight:bold">0</span>  frame <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>        TX packets <span style="color:#0000cf;font-weight:bold">17</span>  bytes <span style="color:#0000cf;font-weight:bold">1326</span> <span style="color:#ce5c00;font-weight:bold">(</span>1.3 KB<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        TX errors <span style="color:#0000cf;font-weight:bold">0</span>  dropped <span style="color:#0000cf;font-weight:bold">0</span> overruns <span style="color:#0000cf;font-weight:bold">0</span>  carrier <span style="color:#0000cf;font-weight:bold">0</span>  collisions <span style="color:#0000cf;font-weight:bold">0</span>
</span></span></code></pre></div><h2 id="设置">设置</h2>
<ul>
<li>
<p><code>sudo ifconfig enp0s8 promisc</code> 可以让网卡进入混杂模式</p>
</li>
<li>
<p><code>sudo ifconfig enp0s8 -promisc</code> 可以让网卡退出混杂模式</p>
</li>
<li>
<p>veth 设备加入 Linux Bridge 后，会自动进入混杂模式，且无法退出。</p>
</li>
<li>
<p>网络设备离开 Linux Bridge 后，会自动退出混杂模式。</p>
</li>
</ul>
<h2 id="参考链接">参考链接</h2>
<ul>
<li><a href="https://book.douban.com/subject/34855927/">《Kubernetes 网络权威指南》</a></li>
</ul>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-2576cf70f23247048e4395173fc49a55">4.2 - TCP Naggle 算法</h1>
    
	<hr>
<h2 id="tips">Tips</h2>
<pre tabindex="0"><code>if 有数据要发送 {
    if 可用窗口大小 &gt;= MSS and 可发送的数据 &gt;= MSS {
        立刻发送MSS大小的数据
    } else {
        if 有未确认的数据 {
            将数据放入缓存等待接收ACK
        } else {
            立刻发送数据
        }
    }
}
</code></pre><h2 id="参考链接">参考链接</h2>
<ul>
<li><a href="https://cloud.tencent.com/developer/article/1784570">深入浅出TCPIP之Nagle算法</a></li>
</ul>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-989dfb3901123545c6efaa0747a57500">4.3 - TCP/IP 读书笔记</h1>
    
	<p>本文是本人在阅读《TCP/IP 详解：卷一》时所做的一些笔记，记录一些我认为比较重要的知识点或者句子，较为凌乱，仅为本人参考使用，并非是分享知识的博客文章。</p>
<h2 id="第19章-tcp-的交互数据流">第19章 TCP 的交互数据流</h2>
<h3 id="经受时延">经受时延</h3>
<ul>
<li>通常 TCP 在收到数据后并不立即进行确认，而是推迟发送 ACK 确认，以便与同一方向上的数据一起发送。有时也称这种现象为数据捎带 ACK。</li>
<li>绝大多数实现采用的时延为200ms，即操作系统每200毫秒滴答一次，在滴答的时候 TCP 检测是否有 ACK 需要发送，如果有则发送。</li>
<li>当一个数据包到达并被处理后，系统产生经受时延标记，ACK 暂不发送。当经受时延计时器超时后，ACK 被发送，并且系统的经受时延标记被清除。</li>
</ul>
<h3 id="nagle-算法">Nagle 算法</h3>
<ul>
<li>在一个 TCP 连接上只能有一个未被确认的未完成的小分组，在该分组的确认到达之前不能发送任何小分组。</li>
<li>TCP 连接将会收集这些小分组，在确认到达时以一个分组发送出去。</li>
<li>TCP 接口可以通过<code>TCP_NODELAY</code>选项关闭 Nagle 算法。</li>
</ul>
<h3 id="其他">其他</h3>
<ul>
<li>每当 TCP 接收到一个超出期望序号的失序数据时，它总是发送一个确认序号为其期望序号的确认。</li>
<li>TCP 可以在应用读取并处理所有数据前，发送所接收数据的确认。</li>
</ul>
<h2 id="第20章-tcp的成块数据流">第20章 TCP的成块数据流</h2>
<h3 id="滑动窗口">滑动窗口</h3>
<ol>
<li>发送方滑动窗口的大小随着接收方接收缓冲区的大小变化而变化。</li>
<li>FIN 的 ACK 可以携带数据，FIN 也可以携带数据。</li>
<li>不确定数据，仅更新窗口右边缘的 ACK 称为窗口更新。</li>
</ol>
<h3 id="窗口大小">窗口大小</h3>
<ul>
<li>PUSH 标记
<ul>
<li>发送方通知接收方的 TCP 立即将接收到的数据发送给应用程序，这些数据包括 PSH 标记携带的数据和所有 TCP 为这个应用程序接收的数据。</li>
</ul>
</li>
<li>许多 TCP 实现在窗口大小增加了两个最大报文段长度，或者窗口大小增加到最大可能窗口的50%后，会向对端发送窗口更新报文。</li>
</ul>
<h3 id="慢启动">慢启动</h3>
<p>发送方设置一个拥塞窗口(Congestion Window)cwnd。</p>
<ol>
<li>连接建立后 cwnd = 1， 表明可以传发送方网络链路一个 MSS 大小的数据。</li>
<li>每收到一个 ACK，cwnd++</li>
<li>每经过一个 RTT，cwnd = cwnd * 2</li>
<li>当<code>cwnd &gt;= ssthresh(slow start threshold)</code>时，就会进入拥塞避免算法</li>
</ol>
<p>Linux 3.0以后根据 Google 一篇论文<a href="http://static.googleusercontent.com/media/research.google.com/zh-CN//pubs/archive/36640.pdf">《An Argument for Increasing TCP’s Initial CongestionWindow》</a>的建议，将 cwnd 初始化为10个 MSS。在 Linux 3.0之前，比如2.6，Linux 则采用了 <a href="http://www.rfc-editor.org/rfc/rfc3390.txt">RFC3390</a>，cwnd 是根据 MSS 的值变化的，变化方式如下所示：</p>
<pre tabindex="0"><code>if MSS &lt; 1095 {
  cwnd = 4
} else if MSS &gt; 2190 {
  cwnd = 2
} else {
  cwnd = 3
}
</code></pre><h2 id="参考文章">参考文章</h2>
<ol>
<li><a href="https://coolshell.cn/articles/11609.html">TCP 的那些事（下）</a></li>
</ol>
</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-98618c5bda197ea7e031816d02c90466">5 - MySQL</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-1d0f5b011af811d1926541ceaa916c7b">5.1 - MySQL 修改 root 密码</h1>
    
	<hr>
<h2 id="旧版本修改-root-密码">旧版本修改 root 密码</h2>
<ul>
<li>MySQL 5.7.6 and newer as well as MariaDB 10.1.20 and newer</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">ALTER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">USER</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;root&#39;</span><span style="color:#ce5c00;font-weight:bold">@</span><span style="color:#4e9a06">&#39;localhost&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">IDENTIFIED</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">BY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;new_password&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">FLUSH</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">PRIVILEGES</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><ul>
<li>MySQL 5.7.5 and older as well as MariaDB 10.1.20 and older</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">SET</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">PASSWORD</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FOR</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;root&#39;</span><span style="color:#ce5c00;font-weight:bold">@</span><span style="color:#4e9a06">&#39;localhost&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">PASSWORD</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;new_password&#39;</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">FLUSH</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">PRIVILEGES</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="ubuntu-下-mysql-80-以上版本修改-root-密码">Ubuntu 下 MySQL 8.0 以上版本修改 root 密码</h2>
<ul>
<li>MySQL 8 默认不开启 root 用户，默认用户是 <code>debian-sys-maint</code>，其默认密码存储在 <code>/etc/mysql/debian.conf</code> 中</li>
<li>MySQL 8 已经抛弃了 <code>PASSWORD()</code> 函数。</li>
<li>MySQL 8 的 user 表已经没有 password 字段了，使用 <code>authentication_string</code> 存储密码 hash</li>
</ul>
<p>在 <code>/etc/mysql/debian.conf</code> 中查看 MySQL <code>debian-sys-maint</code> 用户的密码，登录上之后，修改 root 的密码</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">alter</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">user</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;root&#39;</span><span style="color:#ce5c00;font-weight:bold">@</span><span style="color:#4e9a06">&#39;localhost&#39;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">identified</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">with</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">mysql_native_password</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">by</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;passwd&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">flush</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">privileges</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>然后就可以用 root 用户登录了。</p>
<h2 id="参考链接">参考链接</h2>
<ul>
<li><a href="https://www.digitalocean.com/community/tutorials/how-to-reset-your-mysql-or-mariadb-root-password">https://www.digitalocean.com/community/tutorials/how-to-reset-your-mysql-or-mariadb-root-password</a></li>
<li><a href="https://blog.csdn.net/qq285744011/article/details/120743369">https://blog.csdn.net/qq285744011/article/details/120743369</a></li>
</ul>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-af7bff7ec8885337795256bace71794f">5.2 - InnoDB 锁机制</h1>
    
	<p>本文试图讲清楚 InnoDB 中存在的各种锁，以及它们锁定的区别。</p>
<h2 id="前言">前言</h2>
<p>　锁是数据库系统区别于文件系统的一个关键特性，锁机制用于管理对共享资源的并发访问。不同数据库和不同搜索引擎都可能有不同的锁机制，MyISAM 引擎的锁是表锁设计，并发读没有问题，但是并发写入可能就存在一定的问题。</p>
<p>　Microsoft SQL Server 在2005版本之前是页锁设计，相对于 MyISAM 并发性能有所提高，但是对于热点数据页的并发问题仍然无能为力。在2005版本中，SQL Server 开始支持乐观并发和悲观并发，在乐观并发下开始支持行级锁。但其实现方式与 InnoDB 完全不同，在 SQL Server 中锁是一种稀缺资源，锁越多开销越大，当锁过多的时候会出现锁升级，从行锁升级到表锁。</p>
<p>　InnoDB 存储引擎锁的实现和 Oracle 数据库非常类似，提供一致性的非锁定读和行级锁支持。行级锁没有相关额外的开销，可以同时得到并发性和一致性。</p>
<h2 id="lock-与-latch-的区别">lock 与 latch 的区别</h2>
<p>　在 MySQL 中 lock 与 latch 都可以被称为&quot;锁&quot;，但是它们是不同的东西。</p>
<ul>
<li>latch 一般称为闩(shuan, 读一声)锁(轻量级的锁)，它可以分为 mutex(互斥量) 和 rwlock(读写锁) ，它锁定的对象是内存中的共享资源，主要用来保证并发线程操作临界资源的正确性。</li>
<li>lock 就是锁，它可以分为排他锁，共享锁，意向锁等，它锁定的对象是事务，主要用来锁定数据库中的对象，包括表，页，行等。</li>
</ul>
<p>它们具体的区别可以用下表表示:</p>
<table>
<thead>
<tr>
<th>比较内容</th>
<th>lock</th>
<th>latch</th>
</tr>
</thead>
<tbody>
<tr>
<td>锁定对象</td>
<td>事务</td>
<td>线程</td>
</tr>
<tr>
<td>保护内容</td>
<td>数据库内存</td>
<td>内存数据结构</td>
</tr>
<tr>
<td>持续时间</td>
<td>整个事务过程</td>
<td>临界资源</td>
</tr>
<tr>
<td>模式</td>
<td>行锁，表锁，意向锁等</td>
<td>读写锁，互斥量</td>
</tr>
<tr>
<td>死锁检测</td>
<td>通过 waits-for graph, time out等机制检测与处理</td>
<td>无死锁检测机制。仅通过应用程序加锁的顺序保证无死锁的情况发生</td>
</tr>
<tr>
<td>存在于</td>
<td>Lock Manager的哈希表中</td>
<td>每个数据结构对象中</td>
</tr>
</tbody>
</table>
<h2 id="锁的类型">锁的类型</h2>
<h3 id="行级锁">行级锁</h3>
<p>InnoDB 存储引擎支持如下两种类型的行级锁:</p>
<ul>
<li>共享锁(S Lock) 允许事务读取一行数据</li>
<li>排他锁(X Lock) 允许事务删除或者更新一行数据</li>
</ul>
<p>如果一个事务T1已经获得了记录r上的共享锁，另一个事务T2也可以获得记录r上的共享锁，这种情况称为锁兼容。但如果T1获取的是记录r上的排他锁，则T2获取不了记录r上的共享锁，这种情况称为锁不兼容。
共享锁和排他锁的兼容情况如下所示:</p>
<table>
<thead>
<tr>
<th>共享锁</th>
<th>排他锁</th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>共享锁</td>
<td>兼容</td>
<td>不兼容</td>
</tr>
<tr>
<td>排他锁</td>
<td>不兼容</td>
<td>不兼容</td>
</tr>
</tbody>
</table>
<p><strong>注意</strong>: 共享锁和排他锁都是行锁，兼容指的是同一记录上的锁的兼容情况。</p>
<h3 id="意向锁">意向锁</h3>
<p>InnoDB 存储引擎支持多粒度(multiple granularity locking)锁定，它允许表锁和行锁共存。为了支持在不同粒度上加锁，InnoDB 额外支持了一种表级锁类型，意向锁(Intention Locks)。</p>
<p>意向锁可以分为意向共享锁(Intention Shared Lock, IS)和意向排他锁(Intention eXclusive Lock, IX)。但它的锁定方式和共享锁和排他锁并不相同，意向锁上锁只是表示一种“意向”,并不会真的将对象锁住，让其他事物无法修改或访问。例如事物T1想要修改表<code>test</code>中的行<code>r1</code>，它会上两个锁:</p>
<ol>
<li>在表<code>test</code>上意向排他锁</li>
<li>在行<code>r1</code>上排他锁</li>
</ol>
<p>事物T1在<code>test</code>表上上了意向排他锁，并不代表其他事物无法访问<code>test</code>了，它上的锁只是表明一种意向，它将会在<code>db</code>中的<code>test</code>表中的某几行记录上上一个排他锁。</p>
<p>但是意向锁并不是完全和任何锁都兼容，在表级别上的意向锁也会和表级别的读锁(共享锁)和写锁(排他锁)冲突。比如下面的例子:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">-- 事务A用读锁的方式锁定了表 table_lock
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">mysql</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">root</span><span style="color:#ce5c00;font-weight:bold">@</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">none</span><span style="color:#000;font-weight:bold">):</span><span style="color:#000">hp</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">start</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">transaction</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">Query</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">OK</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">affected</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">Time</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">000</span><span style="color:#000">s</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">mysql</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">root</span><span style="color:#ce5c00;font-weight:bold">@</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">none</span><span style="color:#000;font-weight:bold">):</span><span style="color:#000">hp</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">lock</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">table_lock</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">read</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">Query</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">OK</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">affected</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">Time</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">013</span><span style="color:#000">s</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- 事务B尝试向表 table_lock 中写入数据，它会在插入数据的语句中阻塞住
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">mysql</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">root</span><span style="color:#ce5c00;font-weight:bold">@</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">none</span><span style="color:#000;font-weight:bold">):(</span><span style="color:#204a87;font-weight:bold">none</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">start</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">transaction</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">Query</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">OK</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">affected</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">Time</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">001</span><span style="color:#000">s</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">mysql</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">root</span><span style="color:#ce5c00;font-weight:bold">@</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">none</span><span style="color:#000;font-weight:bold">):</span><span style="color:#000">hp</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">insert</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">table_lock</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- 此时我们查询 informaction_schema 数据中的 INNODB_TRX 表，会发现存在如下两个事务
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">-- 第一行代表了事务B，可以看到它锁定的表 trx_tables_locked 的数量为0
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">-- 第二行代表了事务A，可以看到它锁定的表 trx_tables_locked 的数量为1
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">mysql</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">root</span><span style="color:#ce5c00;font-weight:bold">@</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">none</span><span style="color:#000;font-weight:bold">):</span><span style="color:#000">information_schema</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#000">INNODB_TRX</span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#a40000">\</span><span style="color:#204a87;font-weight:bold">G</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#ce5c00;font-weight:bold">***************************</span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">row</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">***************************</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">trx_id</span><span style="color:#f8f8f8;text-decoration:underline">                     </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">421391658438288</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">trx_state</span><span style="color:#f8f8f8;text-decoration:underline">                  </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">RUNNING</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">trx_started</span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2018</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">03</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">08</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">19</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">57</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">28</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">trx_requested_lock_id</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">null</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">trx_wait_started</span><span style="color:#f8f8f8;text-decoration:underline">           </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">null</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">trx_weight</span><span style="color:#f8f8f8;text-decoration:underline">                 </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">trx_mysql_thread_id</span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">15</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">trx_query</span><span style="color:#f8f8f8;text-decoration:underline">                  </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">insert</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">into</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">table_lock</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">trx_operation_state</span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">null</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">trx_tables_in_use</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">trx_tables_locked</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">trx_lock_structs</span><span style="color:#f8f8f8;text-decoration:underline">           </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">trx_lock_memory_bytes</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1136</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">trx_rows_locked</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">trx_rows_modified</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">trx_concurrency_tickets</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">trx_isolation_level</span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">REPEATABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">READ</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">trx_unique_checks</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">trx_foreign_key_checks</span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">trx_last_foreign_key_error</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">null</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">trx_adaptive_hash_latched</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">trx_adaptive_hash_timeout</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">trx_is_read_only</span><span style="color:#f8f8f8;text-decoration:underline">           </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">trx_autocommit_non_locking</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#ce5c00;font-weight:bold">***************************</span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">row</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">***************************</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">trx_id</span><span style="color:#f8f8f8;text-decoration:underline">                     </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">421391658436448</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">trx_state</span><span style="color:#f8f8f8;text-decoration:underline">                  </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">RUNNING</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">trx_started</span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2018</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">03</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">08</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">19</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">57</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">18</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">trx_requested_lock_id</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">null</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">trx_wait_started</span><span style="color:#f8f8f8;text-decoration:underline">           </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">null</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">trx_weight</span><span style="color:#f8f8f8;text-decoration:underline">                 </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">trx_mysql_thread_id</span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">6</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">trx_query</span><span style="color:#f8f8f8;text-decoration:underline">                  </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">null</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">trx_operation_state</span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">null</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">trx_tables_in_use</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">trx_tables_locked</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">trx_lock_structs</span><span style="color:#f8f8f8;text-decoration:underline">           </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">trx_lock_memory_bytes</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1136</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">trx_rows_locked</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">trx_rows_modified</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">trx_concurrency_tickets</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">trx_isolation_level</span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">REPEATABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">READ</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">trx_unique_checks</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">trx_foreign_key_checks</span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">trx_last_foreign_key_error</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">null</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">trx_adaptive_hash_latched</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">trx_adaptive_hash_timeout</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">trx_is_read_only</span><span style="color:#f8f8f8;text-decoration:underline">           </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">trx_autocommit_non_locking</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">in</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">set</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">Time</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">006</span><span style="color:#000">s</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- 接着我们在事务A中执行解锁语句，并提交事务A
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">mysql</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">root</span><span style="color:#ce5c00;font-weight:bold">@</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">none</span><span style="color:#000;font-weight:bold">):</span><span style="color:#000">hp</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">unlock</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tables</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">Query</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">OK</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">affected</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">Time</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">011</span><span style="color:#000">s</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">mysql</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">root</span><span style="color:#ce5c00;font-weight:bold">@</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">none</span><span style="color:#000;font-weight:bold">):</span><span style="color:#000">hp</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">commit</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">Query</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">OK</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">affected</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">Time</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">000</span><span style="color:#000">s</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- 事务A在解锁了表后，事务B的插入语句立刻就完成了，此时我们再来看 INNODB_TRX 表，发现事务只有一个了:
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">-- 第一行代表了事务B，可以看到此时它锁定的表的数量(trx_tables_locked)变成了1
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">mysql</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">root</span><span style="color:#ce5c00;font-weight:bold">@</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">none</span><span style="color:#000;font-weight:bold">):</span><span style="color:#000">information_schema</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#000">INNODB_TRX</span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#a40000">\</span><span style="color:#204a87;font-weight:bold">G</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#ce5c00;font-weight:bold">***************************</span><span style="color:#000;font-weight:bold">[</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">row</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">***************************</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">trx_id</span><span style="color:#f8f8f8;text-decoration:underline">                     </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">30221</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">trx_state</span><span style="color:#f8f8f8;text-decoration:underline">                  </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">RUNNING</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">trx_started</span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2018</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">03</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">08</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">19</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">57</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">28</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">trx_requested_lock_id</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">null</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">trx_wait_started</span><span style="color:#f8f8f8;text-decoration:underline">           </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">null</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">trx_weight</span><span style="color:#f8f8f8;text-decoration:underline">                 </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">trx_mysql_thread_id</span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">15</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">trx_query</span><span style="color:#f8f8f8;text-decoration:underline">                  </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">null</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">trx_operation_state</span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">null</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">trx_tables_in_use</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">trx_tables_locked</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">trx_lock_structs</span><span style="color:#f8f8f8;text-decoration:underline">           </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">trx_lock_memory_bytes</span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1136</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">trx_rows_locked</span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">trx_rows_modified</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">trx_concurrency_tickets</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">trx_isolation_level</span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">REPEATABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">READ</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">trx_unique_checks</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">trx_foreign_key_checks</span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">trx_last_foreign_key_error</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">null</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">trx_adaptive_hash_latched</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">trx_adaptive_hash_timeout</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">trx_is_read_only</span><span style="color:#f8f8f8;text-decoration:underline">           </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">trx_autocommit_non_locking</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">row</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">in</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">set</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">Time</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">007</span><span style="color:#000">s</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>所有表级别的锁的兼容性如下所示(其中S和X代表表级别的读锁和写锁):</p>
<table>
<thead>
<tr>
<th>X</th>
<th>IX</th>
<th>S</th>
<th>IS</th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>X</td>
<td>Conflict</td>
<td>Conflict</td>
<td>Conflict</td>
<td>Conflict</td>
</tr>
<tr>
<td>IX</td>
<td>Conflict</td>
<td>Compatible</td>
<td>Conflict</td>
<td>Compatible</td>
</tr>
<tr>
<td>S</td>
<td>Conflict</td>
<td>Conflict</td>
<td>Compatible</td>
<td>Compatible</td>
</tr>
<tr>
<td>IS</td>
<td>Conflict</td>
<td>Compatible</td>
<td>Compatible</td>
<td>Compatible</td>
</tr>
</tbody>
</table>
<h2 id="一致性非锁定读">一致性非锁定读</h2>
<p>一致性非锁定读是指 InnoDB 存储引擎通过行多版本控制(multi version)的方式来读取当前执行时间数据库中行的数据。具体来说就是如果一个事务读取的行正在被锁定，那么它就会去读取这行数据之前的快照数据，而不会等待这行数据上的锁释放。这个读取流程如图1所示:</p>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2018-03-06-052802.png" alt="图1"></p>
<p>行的快照数据是通过undo段来实现的，而undo段用来回滚事务，所以快照数据本身没有额外的开销。此外，读取快照数据时不需要上锁的，因为没有事务会对快照数据进行更改。</p>
<p>MySQL 中并不是每种隔离级别都采用非一致性非锁定读的读取模式，而且就算是采用了一致性非锁定读，不同隔离级别的表现也不相同。在 READ COMMITTED 和 REPEATABLE READ 这两种隔离级别下，InnoDB存储引擎都使用一致性非锁定读。但是对于快照数据，READ COMMITTED 隔离模式中的事务读取的是当前行最新的快照数据，而 REPEATABLE READ 隔离模式中的事务读取的是事务开始时的行数据版本。</p>
<p>接下来我们通过一个例子来进行分析:</p>
<p>我们首先创建一个表<code>lock_test</code>，并向其中插入一条测试记录，如下所示:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#000">lock_test</span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#000">id</span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">int</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">unsigned</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NOT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NULL</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">PRIMARY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">KEY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#000">id</span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ENGINE</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">InnoDB</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DEFAULT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">CHARSET</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">utf8mb4</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">insert</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">into</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">lock_test</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>接着我们开启一个事务A，事务A更新表中的记录:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">begin</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">update</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">lock_test</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">set</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">where</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>在事务A还未提交的时候，我们再来开启一个事务B，从<code>lock_test</code>表中查询这条记录:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">begin</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">lock_test</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">where</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#8f5902;font-style:italic">------+
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#8f5902;font-style:italic">------|
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#8f5902;font-style:italic">------+
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">row</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">in</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">set</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">Time</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">006</span><span style="color:#000">s</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>此时无论是在<code>READ COMMITTED</code>隔离级别下，还是在<code>READ REPEATABLE</code>隔离级别下，<code>lock_test</code>表中id为1的记录都能查找到，这是因为数据库事务的隔离性，未提交事务的更改不会影响到其他的事务。</p>
<p>然后我们把事务A提交，再在事务B中进行查找。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">mysql</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">root</span><span style="color:#ce5c00;font-weight:bold">@</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">none</span><span style="color:#000;font-weight:bold">):</span><span style="color:#000">hp</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">@@</span><span style="color:#000">tx_isolation</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#8f5902;font-style:italic">------------------+
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">@@</span><span style="color:#000">tx_isolation</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#8f5902;font-style:italic">------------------|
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">REPEATABLE</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#204a87;font-weight:bold">READ</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#8f5902;font-style:italic">------------------+
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">row</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">in</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">set</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">Time</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">006</span><span style="color:#000">s</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">mysql</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">root</span><span style="color:#ce5c00;font-weight:bold">@</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">none</span><span style="color:#000;font-weight:bold">):</span><span style="color:#000">hp</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">lock_test</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">where</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#8f5902;font-style:italic">------+
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#8f5902;font-style:italic">------|
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#8f5902;font-style:italic">------+
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">row</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">in</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">set</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">Time</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">006</span><span style="color:#000">s</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">--------------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">mysql</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">root</span><span style="color:#ce5c00;font-weight:bold">@</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">none</span><span style="color:#000;font-weight:bold">):</span><span style="color:#000">hp</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">@@</span><span style="color:#000">tx_isolation</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#8f5902;font-style:italic">------------------+
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">@@</span><span style="color:#000">tx_isolation</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#8f5902;font-style:italic">------------------|
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">READ</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#204a87;font-weight:bold">COMMITTED</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#8f5902;font-style:italic">------------------+
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">row</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">in</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">set</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">Time</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">006</span><span style="color:#000">s</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">mysql</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">root</span><span style="color:#ce5c00;font-weight:bold">@</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">none</span><span style="color:#000;font-weight:bold">):</span><span style="color:#000">hp</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">lock_test</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">where</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#8f5902;font-style:italic">------+
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#8f5902;font-style:italic">------|
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#8f5902;font-style:italic">------+
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">in</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">set</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">Time</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">006</span><span style="color:#000">s</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>此时我们可以看到，事务B在<code>READ COMMITTED</code>和<code>READ REPEATABLE</code>这两种不同的隔离级别下查找的结果不同。这个原因我们在上文中已经提过了，在<code>READ COMMITTED</code>隔离级别下读取的是行记录的最新快照版本，而在<code>READ REPEATABLE</code>隔离级别下读取的是事务开始时行数据版本。</p>
<p>其实，从数据库理论的角度来看，<code>READ COMMITTED</code>的隔离级别违反了事务的ACID特性中的隔离性。</p>
<h2 id="一致性锁定读">一致性锁定读</h2>
<p>在 InnoDB 存储引擎中，<code>select</code>语句默认采取的是一致性非锁定读的情况，但是有时候我们也有需求需要对某一行记录进行锁定再来读取，这就是一致性锁定读。</p>
<p>InnoDB 对于<code>select</code>语句支持以下两种锁定读:</p>
<ul>
<li><code>select ... for update</code></li>
<li><code>select ... lock in share mode</code></li>
</ul>
<p><code>select ... for update</code>会对读取的记录加一个X锁，其他事务不能够再来为这些记录加锁。<code>select ... lock in share mode</code>会对读取的记录加一个S锁，其它事务能够再为这些记录加一个S锁，但不能加X锁。</p>
<p>对于一致性非锁定读，即使行记录上加了X锁，它也是能够读取的，因为它读取的是行记录的快照数据，并没有读取行记录本身。</p>
<p><code>select ... for update</code>和<code>select ... lock in share mode</code>这两个语句必须在一个事务中，当事务提交了，锁也就释放了。因此在使用这两条语句之前必须先执行<code>begin</code>, <code>start transaction</code>，或者执行<code>set autocommit = 0</code>。</p>
<h3 id="锁的阻塞分析">锁的阻塞分析</h3>
<h4 id="infomation-schema-中关于事务和锁的表">Infomation Schema 中关于事务和锁的表</h4>
<p>从 InnoDB 1.0 开始，在 <code>INFORMATION_SCHEMA</code> 数据库下添加了表 <code>INNODB_TRX</code>，<code>INNODB_LOCKS</code> 和 <code>INNODB_WAITS</code>。通过这三张表，用户可以更简单地监控当前事务并分析可能存在的锁问题。</p>
<p>INNODB_TRX 的表结构如下:</p>
<table>
<thead>
<tr>
<th>字段名</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>trx_id</code></td>
<td>InnoDB 存储引擎内部唯一的事务ID</td>
</tr>
<tr>
<td><code>trx_state</code></td>
<td>当前事务的状态</td>
</tr>
<tr>
<td><code>trx_started</code></td>
<td>事务的开始时间</td>
</tr>
<tr>
<td><code>trx_requested_lock_id</code></td>
<td>等待事务的锁ID。如果 trx_state 为 LOCK WAIT，那么该值代表当前事务等待之前事务占用的锁资源ID，否则这个字段为NULL。</td>
</tr>
<tr>
<td><code>trx_wait_started</code></td>
<td>事务等待开始的时间</td>
</tr>
<tr>
<td><code>trx_weight</code></td>
<td>事务的权重，代表事务修改和锁住的行数。当死锁发生时，InnoDB 会选择权重值最小的事务进行回滚。</td>
</tr>
<tr>
<td><code>trx_mysql_thread_id</code></td>
<td>MySQL 中的线程ID，SHOW PROCESSLIST 显示的结果</td>
</tr>
<tr>
<td><code>trx_query</code></td>
<td>事务运行的 SQL 语句</td>
</tr>
</tbody>
</table>
<p><code>INNODB_LOCK_WAITS</code> 表结构说明</p>
<table>
<thead>
<tr>
<th>字段名</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>request_trx_id</code></td>
<td>当前正在被阻塞的事务ID</td>
</tr>
<tr>
<td><code>request_lock_id</code></td>
<td>当前正在被阻塞的锁ID</td>
</tr>
<tr>
<td><code>blocking_trx_id</code></td>
<td>当前正在执行的事务ID</td>
</tr>
<tr>
<td><code>blocking_lock_id</code></td>
<td>当前正在阻塞的锁ID</td>
</tr>
</tbody>
</table>
<h4 id="查询当前阻塞的事务">查询当前阻塞的事务</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">trx_id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">waiting_trx_id</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">trx_mysql_thread_id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">waiting_thread_thread</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">trx_query</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">waiting_query</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">b</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">trx_id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">blocking_trx_id</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">b</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">trx_mysql_thread_id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">blocking_thread_thread</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#000">b</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">trx_query</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">blocking_query</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#000">INNODB_LOCK_WAITS</span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">w</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">inner</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">join</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#000">INNODB_TRX</span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">b</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">on</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">b</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">trx_id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">w</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">blocking_trx_id</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">inner</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">join</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#000">INNODB_TRX</span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">r</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">on</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">trx_id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">w</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">requesting_trx_id</span><span style="color:#a40000">\</span><span style="color:#204a87;font-weight:bold">G</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>上述SQL语句会查找当前正在被阻塞的和阻塞的事务，并将其事务ID，MySQL执行线程ID，正在执行的查询都打印出来。</p>
<h2 id="自增长与锁">自增长与锁</h2>
<h3 id="mysql-插入分类">MySQL 插入分类</h3>
<table>
<thead>
<tr>
<th>插入类型</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>insert-like</td>
<td>insert-like 指所有的插入语句，如 insert，replace，insert &hellip; select, replace &hellip; select, load data等</td>
</tr>
<tr>
<td>simple inserts</td>
<td>simple inserts 指在插入前就能确定行数的语句，包括 insert, replace等。但是其不包括 insert &hellip; on duplicate key update 这类 SQL 语句</td>
</tr>
<tr>
<td>bulk inserts</td>
<td>bulk inserts 指插入前不能确定行数的 SQL 语句，例如 insert &hellip; select, replace &hellip; select, load data 等。</td>
</tr>
<tr>
<td>mixed-mode inserts</td>
<td>mixed-mode inserts 语句指插入的数据中有一部分是自增长的，也有一部分的主键是已经确定的，例如：insert into t(c1, c2) values (1, &lsquo;a&rsquo;), (NULL, &lsquo;b&rsquo;), (4, &lsquo;c&rsquo;)。注意: insert &hellip; on duplicate key update 这类语句也属于 mixed-mode inserts。</td>
</tr>
</tbody>
</table>
<h3 id="innodb-锁类型">InnoDB 锁类型</h3>
<h4 id="auto-inc-locking">AUTO-INC Locking</h4>
<p>在 InnoDB 存储引擎的内存结构中，每个含有自增长主键的表都有一个自增长计数器。当对含有自增长计数器的表进行插入时，这个计数器会被初始化，并通过以下语句来获得计数器的值：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">max</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">auto_inc_col</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">t</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">for</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">update</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>自增长计数器是一种特殊的表锁设计，因为在自增长计数器上的锁不会等到事务结束时才释放，而是在执行完插入语句后就被释放了。这种锁设计称为 <strong>AUTO-INC Locking</strong>。</p>
<h4 id="轻量级互斥量锁">轻量级互斥量锁</h4>
<p>尽管 <strong>AUTO-INC Locking</strong> 在一定程度上提高了并发的插入效率，但还是存在一些性能上的问题，从 MySQL 5.1.22 版本开始，InnoDB 提供了一种轻量级互斥量的自增长实现方式，这种方式大大提高了自增长值插入的性能。并且从该版本开始，InnoDB 提供了一个<code>innodb_autoinc_lock_mode</code>的参数来确定自增长锁的锁模式。</p>
<h3 id="innodb-自增长锁模式">InnoDB 自增长锁模式</h3>
<p><code>innodb_autoinc_lock_mode</code>共有三个值可以设置，即0，1，2。这三个值的具体功能如下：</p>
<table>
<thead>
<tr>
<th>innodb_autoinc_lock_mode</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>这是在 MySQL 5.1.22 之前使用<code>AUTO-INC Locking</code>的方式来实现主键的自增长</td>
</tr>
<tr>
<td>1</td>
<td>这是该参数的默认值。对于<code>simple inserts</code>，该值会使用互斥量(mutex)去对内存中的计数器进行累加的操作。对于<code>bulk inserts</code>还是会使用传统表锁的<code>AUTO-INC Locking</code>的方式。在这种配置下，如果不考虑回滚操作，对于自增长列的键值还是连续的。这种方式下，statement-based 的 replication 还是能很好地工作的。</td>
</tr>
<tr>
<td>2</td>
<td>这种模式下，对于所有&quot;INSERT-LIKE&quot;自增长值的产生都是通过互斥量，而不是&quot;AUTO-INC Locking&quot;的方式。显然，这是性能最高的方式。但是这种模式在并发插入时，产生的自增长的值可能不是连续的。此外，在这种模式下，statement-based 的 replication 会出现问题。因此使用这种模式时需要使用 row-based 的 replication。</td>
</tr>
</tbody>
</table>
<p>此外，MyISAM 和 InnoDB 不同，它是表锁设计，所以自增长不需要考虑并发插入的问题。</p>
<p>此外，在 InnoDB 存储引擎中，自增长的列必须是索引，而且必须是索引的第一个列，如果不是第一个列，MySQL 数据库会抛出异常。如下所示:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">mysql</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">root</span><span style="color:#ce5c00;font-weight:bold">@</span><span style="color:#000">localhost</span><span style="color:#000;font-weight:bold">:</span><span style="color:#000">hp</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">create</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">primary_table</span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                      </span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">a</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">int</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">auto_increment</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                      </span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">b</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">int</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                      </span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">key</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">b</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">                      </span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1075</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;Incorrect table definition; there can be only one auto column and it must be defined as a key&#39;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="外键与锁">外键与锁</h2>
<p>在InnoDB中，当我们在子表上添加记录时，会在相应的父表上添加一个共享锁。</p>
<p>例如存在一个父表<code>parent</code>和子表<code>child</code>，它们的结构如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">mysql</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">root</span><span style="color:#ce5c00;font-weight:bold">@</span><span style="color:#000">localhost</span><span style="color:#000;font-weight:bold">:</span><span style="color:#000">hp</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">show</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">create</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">child</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#8f5902;font-style:italic">---------+-------------------------------------------------------------------------------+
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">Table</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">Create</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">Table</span><span style="color:#f8f8f8;text-decoration:underline">                                                                  </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#8f5902;font-style:italic">---------+-------------------------------------------------------------------------------|
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">child</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#000">child</span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline">                                                        </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#000">id</span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">int</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">11</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NOT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NULL</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">                                                      </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#000">parent_id</span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">int</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">11</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NOT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NULL</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">                                               </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#204a87;font-weight:bold">PRIMARY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">KEY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#000">id</span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#000;font-weight:bold">),</span><span style="color:#f8f8f8;text-decoration:underline">                                                         </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#204a87;font-weight:bold">KEY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#000">FK_PARENT</span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#000">parent_id</span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#000;font-weight:bold">),</span><span style="color:#f8f8f8;text-decoration:underline">                                              </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#204a87;font-weight:bold">CONSTRAINT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#000">FK_PARENT</span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">FOREIGN</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">KEY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#000">parent_id</span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">REFERENCES</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#000">parent</span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#000">id</span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ENGINE</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">InnoDB</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DEFAULT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">CHARSET</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">utf8mb4</span><span style="color:#f8f8f8;text-decoration:underline">                                       </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#8f5902;font-style:italic">---------+-------------------------------------------------------------------------------+
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">mysql</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">root</span><span style="color:#ce5c00;font-weight:bold">@</span><span style="color:#000">localhost</span><span style="color:#000;font-weight:bold">:</span><span style="color:#000">hp</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">show</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">create</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">parent</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#8f5902;font-style:italic">---------+-----------------------------------------+
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">Table</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">Create</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">Table</span><span style="color:#f8f8f8;text-decoration:underline">                            </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#8f5902;font-style:italic">---------+-----------------------------------------|
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">parent</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#000">parent</span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline">                 </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#000">id</span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">int</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">11</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NOT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NULL</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">                </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">   </span><span style="color:#204a87;font-weight:bold">PRIMARY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">KEY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#000">id</span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">                    </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">         </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ENGINE</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">InnoDB</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DEFAULT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">CHARSET</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">utf8mb4</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#8f5902;font-style:italic">---------+-----------------------------------------+
</span></span></span></code></pre></div><p>我们先向父表中插入一条记录: <code>insert into parent select 3</code>。</p>
<p>接着，我们新开一个事务，称为事务A，在其中执行删除父表中id=3的记录，如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">-- 事务A
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">mysql</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">root</span><span style="color:#ce5c00;font-weight:bold">@</span><span style="color:#000">localhost</span><span style="color:#000;font-weight:bold">:</span><span style="color:#000">hp</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">begin</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">Query</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">OK</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">affected</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">Time</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">006</span><span style="color:#000">s</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">mysql</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">root</span><span style="color:#ce5c00;font-weight:bold">@</span><span style="color:#000">localhost</span><span style="color:#000;font-weight:bold">:</span><span style="color:#000">hp</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">delete</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">parent</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">where</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">id</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">Query</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">OK</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">row</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">affected</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">Time</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">002</span><span style="color:#000">s</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>然后，我们再开一个事务B，在其中执行，向子表中插入(2, 3)的记录:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">-- 事务B
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">mysql</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">root</span><span style="color:#ce5c00;font-weight:bold">@</span><span style="color:#000">localhost</span><span style="color:#000;font-weight:bold">:</span><span style="color:#000">hp</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">begin</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">Query</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">OK</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">rows</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">affected</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">Time</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">006</span><span style="color:#000">s</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">mysql</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">root</span><span style="color:#ce5c00;font-weight:bold">@</span><span style="color:#000">localhost</span><span style="color:#000;font-weight:bold">:</span><span style="color:#000">hp</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">insert</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">into</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">child</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>此时事务B就会阻塞，因为在事务A已经在父表上添加了一个排他行锁。而事务B插入时需要在父表上id=3的行上添加一个共享锁，此时就会阻塞。</p>
<p>最后，我们把事务A提交，事务B立刻就会报错，提示相关的外键不存在:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">-- 事务B
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">mysql</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">root</span><span style="color:#ce5c00;font-weight:bold">@</span><span style="color:#000">localhost</span><span style="color:#000;font-weight:bold">:</span><span style="color:#000">hp</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">insert</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">into</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">child</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1452</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#39;Cannot add or update a child row: a foreign key constraint fails (`hp`.`child`, CONSTRAINT `FK_PARENT` FOREIGN KEY (`parent_id`) REFERENCES `parent` (`id`))&#39;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="行锁">行锁</h2>
<h3 id="行锁的三种算法">行锁的三种算法</h3>
<p>InnoDB 存储引擎有三种行锁的算法，其分别是：</p>
<ul>
<li>Record Lock: 单个行记录上的锁</li>
<li>Gap Lock: 间隙锁，锁定一个范围，但不包含记录本身</li>
<li>Next-Key 锁: Gap Lock + Record Lock，锁定一个范围，并且会锁定记录本身</li>
</ul>
<p>Record Lock 总是会去锁住索引记录，如果 InnoDB 表在创建的时候没有设置任何主键索引，那么 Record Lock 会锁住隐式的主键。</p>
<h3 id="加锁场景分析">加锁场景分析</h3>
<ul>
<li>主键索引</li>
</ul>
<p>如果我们加锁的行上存在主键索引，那么就会在这个主键索引上添加一个 Record Lock。</p>
<ul>
<li>辅助索引</li>
</ul>
<p>如果我们加锁的行上存在辅助索引，那么我们就会在这行的辅助索引上添加 Next-Key Lock，并在这行之后的辅助索引上添加一个 Gap Lock</p>
<p>辅助索引上的 Next-Key Lock 和 Gap Lock 都是针对 Repeatable Read 隔离模式存在的，这两种锁都是为了防止幻读现象的发生。</p>
<ul>
<li>唯一的辅助索引</li>
</ul>
<p>这里有一个特殊情况，如果辅助索引是唯一索引的话，MySQL 会将 Next-Key Lock 降级为 Record Lock，只会锁定当前记录的辅助索引。</p>
<p>如果唯一索引由多个列组成的，而我们只锁定其中一个列的话，那么此时并不会进行锁降级，还会添加 Next-Key Lock 和 Gap Lock。</p>
<ul>
<li>Insert 语句</li>
</ul>
<p>在 InnoDB 存储引擎中，对于 Insert 的操作，其会检查插入记录的下一条记录是否被锁定，若已经被锁定，则不允许查询。</p>
<p>介绍了上面三种锁的加锁场景后，我们接着来看一个例子，存在一个表<code>z</code>，</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">-- 注意a列上有主键索引，b列上有辅助索引
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">Create</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">Table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">CREATE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">TABLE</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#000">z</span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#000">a</span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">int</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">11</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NOT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NULL</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#000">b</span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">int</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">11</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DEFAULT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">NULL</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">PRIMARY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">KEY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#000">a</span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#000;font-weight:bold">),</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">KEY</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#000">b</span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#000">b</span><span style="color:#ce5c00;font-weight:bold">`</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ENGINE</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">InnoDB</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">DEFAULT</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">CHARSET</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">utf8mb4</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>表<code>z</code>中的数据如下所示:</p>
<pre tabindex="0"><code>+-----+-----+
| a   | b   |
|-----+-----|
| 1   | 1   |
| 3   | 1   |
| 5   | 3   |
| 7   | 6   |
| 10  | 8   |
+-----+-----+
</code></pre><p>通过上面表<code>z</code>中的数据，我们可以分析得出 Next-Key Lock 加锁的区间为:</p>
<pre tabindex="0"><code>(负无穷, 1]
(1, 3]
(3, 6]
(6, 8]
(8, 正无穷)
</code></pre><p>接着我们开启两个事务A和B，在事务A中执行如下的锁定语句:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">-- 在事务A中执行
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">z</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">where</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">b</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">for</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">update</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>在执行完上述语句后，我们会在表z中添加上三个锁:</p>
<ol>
<li>在主键列a的索引上添加一个 Record Lock，锁定住 a=5 的索引</li>
<li>在列b的辅助索引上添加一个 Next Key Lock，锁定住区间(1, 3]</li>
<li>在列b的辅助索引上添加一个 Gap Lock，锁定住区间(3, 6)</li>
</ol>
<p>这里大家可能会疑惑，为什么在辅助索引上会加两个锁，这主要是为了防止事务A出现幻读，即事务A再次执行<code>select * from z where b = 3</code>时出现了多条语句。</p>
<p>因为列b并不是唯一的，所以其他事务也有可能插入<code>b=3</code>的记录到表z中。根据B+树索引的有序性，其他事务如果插入<code>b=3</code>的记录，那么就会在辅助索引上原有的<code>b=3</code>索引的前后区间中添加记录，如果我们把原有的<code>b=3</code>索引的前后区间锁住，那么其他事务就无法添加<code>b=3</code>的记录了，从而防止了幻读现象的出现。</p>
<p>分析完上面的锁情况之后，我们在事务B中执行插入语句，验证我们的想法：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">-- 下面的语句会阻塞，因为和主键索引中的 Record Lock 锁冲突
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">mysql</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">root</span><span style="color:#ce5c00;font-weight:bold">@</span><span style="color:#000">localhost</span><span style="color:#000;font-weight:bold">:</span><span style="color:#000">hp</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">z</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">where</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">a</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">lock</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">in</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">share</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">mode</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#ce5c00;font-weight:bold">^</span><span style="color:#000">Ccancelled</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">query</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- 下面的语句会阻塞，因为和辅助索引上的 (1, 3] Next-Lock 锁冲突
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">mysql</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">root</span><span style="color:#ce5c00;font-weight:bold">@</span><span style="color:#000">localhost</span><span style="color:#000;font-weight:bold">:</span><span style="color:#000">hp</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">insert</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">into</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">z</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#ce5c00;font-weight:bold">^</span><span style="color:#000">Ccancelled</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">query</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- 下面的语句会阻塞，因为和辅助索引上的 (3, 6) Gap Lock 锁冲突
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">mysql</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">root</span><span style="color:#ce5c00;font-weight:bold">@</span><span style="color:#000">localhost</span><span style="color:#000;font-weight:bold">:</span><span style="color:#000">hp</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">insert</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">into</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">z</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">6</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#ce5c00;font-weight:bold">^</span><span style="color:#000">Ccancelled</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">query</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic">-- 以下的三条语句都不会阻塞
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">mysql</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">root</span><span style="color:#ce5c00;font-weight:bold">@</span><span style="color:#000">localhost</span><span style="color:#000;font-weight:bold">:</span><span style="color:#000">hp</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">insert</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">into</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">z</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">6</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">Query</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">OK</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">row</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">affected</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">Time</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">008</span><span style="color:#000">s</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">mysql</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">root</span><span style="color:#ce5c00;font-weight:bold">@</span><span style="color:#000">localhost</span><span style="color:#000;font-weight:bold">:</span><span style="color:#000">hp</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">insert</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">into</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">z</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">Query</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">OK</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">row</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">affected</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">Time</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">007</span><span style="color:#000">s</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">mysql</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">root</span><span style="color:#ce5c00;font-weight:bold">@</span><span style="color:#000">localhost</span><span style="color:#000;font-weight:bold">:</span><span style="color:#000">hp</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">insert</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">into</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">z</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">6</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">7</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">Query</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">OK</span><span style="color:#000;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">row</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">affected</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">Time</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">.</span><span style="color:#0000cf;font-weight:bold">007</span><span style="color:#000">s</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="死锁">死锁</h2>
<p>死锁是指两个或两个以上的事务在执行过程中，因争夺锁资源而造成的一种相互等待的现象。若无外力作用，事务都将无法推进下去。</p>
<p>在InnoDB存储引擎中，可以通过超时机制来解决死锁问题，但超时机制是按照FIFO的顺序来进行回滚的，有可能我们回滚的事务做的更新比较多，对其回滚所用时间比回滚另一个事务要多的多，此时超时机制就不太合适了。</p>
<p>因此除了超时机制，还会采用<code>wait-for graph</code>的方式来进行死锁检测，这是一种更主动的死锁检测方式。</p>
<h2 id="参考资料">参考资料</h2>
<ol>
<li><a href="https://dev.mysql.com/doc/refman/5.7/en/innodb-locking.html#innodb-intention-locks">https://dev.mysql.com/doc/refman/5.7/en/innodb-locking.html#innodb-intention-locks</a></li>
<li><a href="https://dev.mysql.com/doc/refman/5.7/en/lock-tables.html">https://dev.mysql.com/doc/refman/5.7/en/lock-tables.html</a></li>
<li><a href="https://www.percona.com/blog/2012/07/31/innodb-table-locks/">https://www.percona.com/blog/2012/07/31/innodb-table-locks/</a></li>
<li><a href="http://hedengcheng.com/?p=771#_Toc374698309">http://hedengcheng.com/?p=771#_Toc374698309</a></li>
<li>《MySQL 技术内幕 &ndash; InnoDB 存储引擎》 第二版，第六章</li>
</ol>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-abde27c2366084c3ca6935b6bb833a9e">5.3 - InnoDB 行记录格式</h1>
    
	<p><strong>简介</strong>: 本文主要讲述了 InnoDB 的行如何在数据文件中进行存储的，同时简单分析了 InnoDB 的逻辑存储结构</p>
<h2 id="前言">前言</h2>
<p>InnoDB 是 MySQL 的一种面向行(row-oriented)存储引擎，即在其中数据是按照行的形式存储的，那么行又是如何组织的呢？在了解 InnoDB 的行格式之前，我们先简单了解一下 InnoDB 的逻辑存储结构。</p>
<h2 id="innodb-逻辑存储结构">InnoDB 逻辑存储结构</h2>
<p>从 InnoDB 的逻辑存储结构上看，所有的数据都被存储在一个空间中，这个空间就叫做表空间，表空间又是由段(segment)，区(extent)和页(Page)组成的，页在某些文档中也被称为块(block)。它们之间的关系可以用下图表示:</p>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2018-01-11-InnoDB%20%E9%80%BB%E8%BE%91%E5%AD%98%E5%82%A8%E7%BB%93%E6%9E%84.png" alt=""></p>
<h3 id="表空间">表空间</h3>
<p>表空间是 InnoDB 逻辑存储的最高层，所有的数据都放在表空间中。当我们创建一个数据库的时候，它会产生后缀为<code>idb</code>和<code>frm</code>的文件，其中<code>frm</code>文件是MySQL的表和视图结构定义文件，<code>idb</code>文件是MySQL表的数据文件，我们说的表空间就存储在<code>idb</code>文件中。</p>
<p>当我们开启了<code>innodb_file_per_table</code>配置项后，InnoDB 会为每个表分配一个__独立表空间文件__，但是这个文件只存储该表的数据，索引，插入缓存BITMAP等信息，其余信息还存放在__共享表空间文件__中。</p>
<p>关于<code>idb</code>和<code>frm</code>文件之间的关系可以用下图来表示:</p>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2018-01-03-122727.jpg" alt=""></p>
<h3 id="段">段</h3>
<p>InnoDB 的表空间是由各种段组成的，包括数据段，索引段和回滚段等。因为 InnoDB 存储引擎表是索引组织(index organized)的，因此数据段即为B+树的叶子节点，索引段即为B+树的非叶子节点。</p>
<h3 id="区">区</h3>
<p>区的大小为1M</p>
<p>MySQL创建表空间的时候，不先申请一整个区，而是先申请一些碎片页(33个)。如果表的空间持续增加，用完所有碎片页以后，才会去申请区，此时表空间文件(tablename.idb)的大小就会1M，1M地增加。</p>
<p>如果通过区申请空间，那么就会有很多空闲页(<code>&lt;Freshly Allocated Page&gt;</code>)。</p>
<h3 id="页">页</h3>
<p>InnoDB 的区是由页组成的，页主要有以下几种类型:</p>
<table>
<thead>
<tr>
<th>InnoDB存储引擎中页的类型</th>
<th>十六进制</th>
<th>解释</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>FIL_PAGE_INDEX</code></td>
<td>0x45BF</td>
<td>B+树叶节点</td>
</tr>
<tr>
<td><code>FIL_PAGE_UNDO_LOG</code></td>
<td>0x0002</td>
<td>Undo Log 页</td>
</tr>
<tr>
<td><code>FIL_PAGE_INODE</code></td>
<td>0x0003</td>
<td>索引节点</td>
</tr>
<tr>
<td><code>FIL_PAGE_IBUF_FREE_LIST</code></td>
<td>0x0004</td>
<td>Insert Buffer 空闲列表</td>
</tr>
<tr>
<td><code>FIL_PAGE_TYPE_ALLOCATED</code></td>
<td>0x0000</td>
<td>该页为最新分配</td>
</tr>
<tr>
<td><code>FIL_PAGE_IBUF_BITMAP</code></td>
<td>0x0005</td>
<td>Insert Buffer 位图</td>
</tr>
<tr>
<td><code>FIL_PAGE_TYPE_SYS</code></td>
<td>0x0006</td>
<td>系统页</td>
</tr>
<tr>
<td><code>FIL_PAGE_TYPE_TRX_SYS</code></td>
<td>0x0007</td>
<td>事务系统数据</td>
</tr>
<tr>
<td><code>FIL_PAGE_TYPE_FSP_HDR</code></td>
<td>0x0008</td>
<td>File Space Header</td>
</tr>
<tr>
<td><code>FIL_PAGE_TYPE_XDES</code></td>
<td>0x0009</td>
<td>扩展描述页</td>
</tr>
<tr>
<td><code>FIL_PAGE_TYPE_BLOB</code></td>
<td>0x000A</td>
<td>BLOB页</td>
</tr>
</tbody>
</table>
<h2 id="innodb-行">InnoDB 行</h2>
<h3 id="char-的行存储结构">Char 的行存储结构</h3>
<p>从 MySQL 4.1版本开始，<code>char(N)</code>类型中的<code>N</code>表示的就是字符的长度，而不是字符串的长度。</p>
<p>举个例子，我们创建如下的表:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#000">mysql</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">create</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">table</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">test_char</span><span style="color:#000;font-weight:bold">(</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">c1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87">char</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">charset</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;gbk&#39;</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>然后向其中插入数据，并查看其中的数据:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">insert</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">into</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">test_char</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">values</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;我们&#39;</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">insert</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">into</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">test_char</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">values</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;abc&#39;</span><span style="color:#000;font-weight:bold">);</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">mysql</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">select</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">length</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c1</span><span style="color:#000;font-weight:bold">),</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">character_length</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c1</span><span style="color:#000;font-weight:bold">),</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">c1</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">from</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">test_char</span><span style="color:#000;font-weight:bold">;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#8f5902;font-style:italic">------------+----------------------+--------+
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">length</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c1</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">character_length</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c1</span><span style="color:#000;font-weight:bold">)</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">c1</span><span style="color:#f8f8f8;text-decoration:underline">     </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#8f5902;font-style:italic">------------+----------------------+--------+
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">                    </span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">abc</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#0000cf;font-weight:bold">6</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">                    </span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#a40000">我们</span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#8f5902;font-style:italic">------------+----------------------+--------+
</span></span></span></code></pre></div><p>我们可以看到，<code>我们</code>和<code>abc</code>的字符长度都是3，但是它们的字节长度是不同的。这也就意味着，在数据文件中存储的时候，<code>char</code>类型的字段也是被当做变长字段来存储的。</p>
<p>我们可以通过<code>hexdump</code>命令来查看<code>test_char</code>表对应的数据文件，具体命令如下:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>hexdump -C -v /usr/local/var/mysql/hp/test_char.ibd <span style="color:#000;font-weight:bold">|</span>less
</span></span></code></pre></div><p><strong>注意</strong>: 我的 MySQL 开启了<code>innodb_file_per_table</code>选项，所以每个表都会有自己单独的数据文件。上述命令中的<code>/usr/local/var/mysql/hp/test_char.ibd</code>文件是<code>hp</code>数据库中的<code>test_char</code>表的数据文件。</p>
<pre tabindex="0"><code>0000c090  01 10 61 62 20 20 06 00  00 00 18 00 20 00 00 00  |..ab  ...... ...|
0000c0a0  00 06 08 00 00 00 1f 43  fb ba 00 00 01 2f 01 10  |.......C...../..|
0000c0b0  e6 88 91 e4 bb ac 04 00  00 00 20 ff b3 00 00 00  |.......... .....|
0000c0c0  00 06 09 00 00 00 1f 44  00 bd 00 00 01 35 01 10  |.......D.....5..|
0000c0d0  61 62 63 20 00 00 00 00  00 00 00 00 00 00 00 00  |abc ............|
</code></pre><p>在上面的二进制数据中，<code>c096 - c0b5</code>代表的是<code>c1=我们</code>这一行的数据，它的具体内容如下:</p>
<ul>
<li><code>c1=我们</code>行数据</li>
</ul>
<table>
<thead>
<tr>
<th>二进制内容</th>
<th>具体含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>06</td>
<td>变长字段c1的长度</td>
</tr>
<tr>
<td>00</td>
<td>NULL标志位</td>
</tr>
<tr>
<td>00 00 18 00 20</td>
<td>Record Header</td>
</tr>
<tr>
<td>00 00 00 00 06 08</td>
<td>隐式创建的行 ID</td>
</tr>
<tr>
<td>00 00 00 1f 43 fb</td>
<td>事务ID</td>
</tr>
<tr>
<td>ba 00 00 01 2f 01 10</td>
<td>回滚指针</td>
</tr>
<tr>
<td>e6 88 91 e4 BB AC</td>
<td>列数据字符串&rsquo;我们'</td>
</tr>
</tbody>
</table>
<ul>
<li><code>c1=abc</code>行数据</li>
</ul>
<table>
<thead>
<tr>
<th>二进制内容</th>
<th>具体含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>04</td>
<td>变长字段c1的长度</td>
</tr>
<tr>
<td>00</td>
<td>NULL标志位</td>
</tr>
<tr>
<td>00 00 20 ff b3</td>
<td>Record Header</td>
</tr>
<tr>
<td>00 00 00 00 06 09</td>
<td>隐式创建的行ID</td>
</tr>
<tr>
<td>00 00 00 1f 44 00</td>
<td>事务ID</td>
</tr>
<tr>
<td>bd 00 00 01 35 01 10</td>
<td>回滚指针</td>
</tr>
<tr>
<td>61 62 63 20</td>
<td>列数据字符串&rsquo;abc&rsquo;，另外加上补全4字符的空格</td>
</tr>
</tbody>
</table>
<p><strong>疑惑</strong>: 这里<code>CHAR</code>类型补全空格的规则是什么（例如中文什么时候会补全？），我还不太了解，如有了解的同学，希望可以指出</p>
<p>从上面的例子分析中，我们可以看到。MySQL 4.1 之后，<code>CHAR(N)</code>类型中的长度N表示的就是字符的长度，所以底层存储的字符数据实际上是变长的，MySQL也是将它按照变长数据的类型来处理的。</p>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-aff300e3b1167d3a0f03f0927405f9a0">5.4 - MySQL Character Set support</h1>
    
	<p><strong>摘要</strong>:</p>
<blockquote>
<ol>
<li>本文是对MySQL文档 <a href="https://dev.mysql.com/doc/refman/5.7/en/charset.html">Character Set Support</a> 的翻译</li>
</ol>
</blockquote>
<!-- more -->
<h2 id="字符集character-set和排序规则collation概要">字符集(character set)和排序规则(collation)概要</h2>
<p>一个字符集是一组符号和编码的集合。一个排序规则是一组字符集中用来比较字符的规则的集合。让我们使用一个假想的字符集的例子来分别区分它们。</p>
<p>假设我们有四个字母：A, B, a, b。我们给每个字母赋值一个数字，A = 0, B = 1, a = 2, b = 3。字母 <strong>A</strong> 是一个符号，数字0是字母 <strong>A</strong> 的编码，四个字母和它们编码的集合叫做 <strong>字符集</strong> (character set)。</p>
<p>假设我们想要比较两个字符串值，A 和 B。做这个最简单的方式就是去查看它们的编码，A 是0，B 是1。因为0比1小，所以我们说 A 比 B 小。刚刚我们所做的事情是将一个排序规则(collation)应用到我们的字符集上。排序规则(collation)是一组规则(比较编码)的集合(在这个例子中仅有一个规则)。我们称这个所有可能的排序规则中最简单的排序规则为二进制排序规则(binary collation)。</p>
<p>但是如果我们想说大写字母和小写字母是等价的，那该怎么排序呢？那么我们将会有至少两个规则：</p>
<ol>
<li>将小写字母 a 和 b 等价成大写字母 A 和 B。</li>
<li>然后比较它们的编码。</li>
</ol>
<p>我们称这个为不区分大小写的排序规则。它比起二进制排序规则来要复杂一些。</p>
<p>在现实生活中，大多数的字符集都有许多字符；并不仅仅是 A 和 B 而是包括所有的字母，有时还会包括多字母和东方书写系统中成千上万个字符和许多相关的特殊字符和标点符号。同样在现实生活中，大多数的排序规则都有许多条规则，并不仅仅是区分大小写对于多字符映射(比如德语排序规则中的两个规则之一就是Ö = OE)也会区分口音(口音是和字符相关的一个标记例如德语中的Ö)。</p>
<p>MySQL 能为你做这些事情：</p>
<ul>
<li>使用各种各样的字符集来存储字符串。</li>
<li>使用各种各样的排序规则来比较字符串。</li>
<li>在同一台服务器上，在同一个的数据库，甚至是在同一个表中，混合使用不同字符集不同排序规则的字符串。</li>
<li>在任何等级上开启特殊的字符集和排序规则。</li>
</ul>
<p>为了能够有效地使用这些特性，你必须要知道哪些字符集和排序规则是可用的，如何改变默认的排序规则，以及它们是如何影响到字符串操作符和相关函数的行为的。</p>
<h2 id="mysql中的字符集和排序规则">MySQL中的字符集和排序规则</h2>
<p>MySQL 服务器支持多种字符集。使用__INFORMATION_SCHEMA.CHARACTER_SETS__表或者__SHOW CHARACTER_SET__语句能够列出所有的可用字符集。下面的例子列出了一部分字符集，如果想要查看完整的信息，请参看<a href="https://dev.mysql.com/doc/refman/5.7/en/charset-charsets.html"> Section 11.1.14, “Character Sets and Collations Supported by MySQL” </a>。</p>
<pre><code>mysql&gt; SHOW CHARACTER SET;
+----------+---------------------------------+---------------------+--------+
| Charset  | Description                     | Default collation   | Maxlen |
+----------+---------------------------------+---------------------+--------+
| big5     | Big5 Traditional Chinese        | big5_chinese_ci     |      2 |
...
| latin1   | cp1252 West European            | latin1_swedish_ci   |      1 |
| latin2   | ISO 8859-2 Central European     | latin2_general_ci   |      1 |
...
| utf8     | UTF-8 Unicode                   | utf8_general_ci     |      3 |
| ucs2     | UCS-2 Unicode                   | ucs2_general_ci     |      2 |
...
| utf8mb4  | UTF-8 Unicode                   | utf8mb4_general_ci  |      4 |
...
</code></pre>
<p>一个给定的字符集至少有一个排序规则，而大多数的字符集都有多个。通过__INFORMATION_SCHEMA.COLLATIONS__表或者__SHOW COLLATION__语句可以列出一个字符集所有可用的排序规则。例如，使用下面的语句可以列出 <em>latin1</em> 字符集(cp1252 西欧)所有的排序规则。</p>
<pre><code>mysql&gt; SHOW COLLATION WHERE Charset = 'latin1';
+-------------------+---------+----+---------+----------+---------+
| Collation         | Charset | Id | Default | Compiled | Sortlen |
+-------------------+---------+----+---------+----------+---------+
| latin1_german1_ci | latin1  |  5 |         | Yes      |       1 |
| latin1_swedish_ci | latin1  |  8 | Yes     | Yes      |       1 |
| latin1_danish_ci  | latin1  | 15 |         | Yes      |       1 |
| latin1_german2_ci | latin1  | 31 |         | Yes      |       2 |
| latin1_bin        | latin1  | 47 |         | Yes      |       1 |
| latin1_general_ci | latin1  | 48 |         | Yes      |       1 |
| latin1_general_cs | latin1  | 49 |         | Yes      |       1 |
| latin1_spanish_ci | latin1  | 94 |         | Yes      |       1 |
+-------------------+---------+----+---------+----------+---------+
</code></pre>
<p><em>latin1</em> 的排序规则有如下含义。</p>
<table>
<thead>
<tr>
<th>Collation</th>
<th>Meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td>latin1_bin</td>
<td>根据 latin1 的编码进行二进制排序</td>
</tr>
<tr>
<td>latin_danish_ci</td>
<td>丹麦/挪威</td>
</tr>
<tr>
<td>latin1_general_ci</td>
<td>多语言(西欧)</td>
</tr>
<tr>
<td>latin1_general_cs</td>
<td>多语言(ISO 西欧)，区分大小写</td>
</tr>
<tr>
<td>latin1_german1_ci</td>
<td>德语 DIN-1 (字典顺序)</td>
</tr>
<tr>
<td>latin1_german2_ci</td>
<td>德语 DIN-2 (电话簿顺序)</td>
</tr>
<tr>
<td>latin1_spanish_ci</td>
<td>现代西班牙语</td>
</tr>
<tr>
<td>latin1_swedish_ci</td>
<td>瑞典/芬兰</td>
</tr>
</tbody>
</table>
<p>排序规则有如下的特点：</p>
<ul>
<li>两个不同字符集不能有同样的排序规则</li>
<li>每个字符集有一个排序规则称为默认排序规则(<em>default collation</em>)。例如，<strong>latin1</strong> 和 <strong>utf8</strong> 的默认排序规则分别是 <strong>latin1_swedish_ci</strong> 和 <strong>utf8_general_ci</strong> 。<strong>INFORMATION_SHCEMA.CHARACTER_SETS</strong> 表和 <strong>SHOW CHARACTER_SET</strong> 语句表明了每个字符集的默认排序规则。 <strong>INFORMATION_SHCEMA.COLLATIONS</strong> 表和 <strong>SHOW COLLATION</strong> 语句有一列表明每个排序规则是不是它所属字符集的默认排序规则。(是的话值为<em>YES</em>，否则值为空)。</li>
<li>排序规则的名字是以它们相关联的字符集的名字作为起始值，后面跟着一个或多个的后缀来表明其他的排序规则特性。如果想要了解更多的排序规则命名规范，请参考<a href="https://dev.mysql.com/doc/refman/5.7/en/charset-collation-names.html"> Section 11.1.3, “Collation Naming Conventions” </a>。</li>
</ul>
<p>当一个字符集有多个排序规则的时候，对于一个给定的应用程序来说哪个排序规则是最适合的可能并不清晰。为了避免选择一个不合适的排序规则，请使用一些代表数据值来执行一些比较，来确认给定的排序规则将值排序的方式是否符合你的期望。</p>
<p><a href="http://www.collation-charts.org/">Collation-Charts.Org</a>是一个很有用的网站，用来展示一个排序规则和另外一个排序规则的比较信息。</p>
<h2 id="排序规则命名规范">排序规则命名规范</h2>
<p>MySQL 排序规则的命名遵循如下的规范：</p>
<ul>
<li>一个排序规则的名字使用和它相关联的那个字符集的名字作为开始，后面跟着一个或者多个后缀表示排序规则的其他特性。例如，<em>utf8_general_ci</em> 和 <em>latin1_swedish_ci</em> 分别是 <em>utf8</em> 和 <em>latin1</em> 字符集的排序规则。</li>
<li>某个语言特定的排序规则包括了语言名。例如，<em>utf8_turkish_ci</em> 和 <em>utf8_hungarian_ci</em> 分别使用土耳其和匈牙利的的规则来为 <em>utf8</em> 字符集排序字符。</li>
<li>一个排序规则可能是区分大小写或者不区分大小写的，也有可能是二进制排序的。对于二进制排序的排序规则，字符比较基于字符的二进制编码值。下面的表格表示了这些排序特性使用的后缀。</li>
</ul>
<blockquote>
<p><strong>表格 11.1 排序规则大小写区分的后缀</strong></p>
</blockquote>
<blockquote>
<table>
<thead>
<tr>
<th>Suffix</th>
<th>Meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td>_ai</td>
<td>不区分口音</td>
</tr>
<tr>
<td>_as</td>
<td>区分口音</td>
</tr>
<tr>
<td>_ci</td>
<td>不区分大小写</td>
</tr>
<tr>
<td>_cs</td>
<td>区分大小写</td>
</tr>
<tr>
<td>_bin</td>
<td>二进制排序</td>
</tr>
</tbody>
</table>
</blockquote>
<blockquote>
<p>对于没有指定口音的非二进制排序规则，它是由区分大小写来决定的。那就意味着，如果一个排序规则名字中没有包含 <em>_ai</em> 或者 <em>_as</em> ，名字中的 <em>_ci</em> 就暗示着 <em>_ai</em>，而 <em>_cs</em> 就暗示着 <em>_as</em>。</p>
</blockquote>
<blockquote>
<p>例如，<em>latin1_general_ci</em> 是不区分大小写的(同时也暗示着不区分口音)。<em>latin1_general_cs</em> 是区分大小写的(同时也暗示着区分口音), <em>latin1_bin</em> 使用二进制编码的值。</p>
</blockquote>
<ul>
<li>对于 Unicode 字符集，排序规则名字中可能包含着一个版本号，用来表示这个排序规则基于的 UCA(Unicode Collation Algorithm) 的版本。基于 UCA 的排序规则的名字中没有版本号的话，意味着使用了 UCA 加权键 4.0.0 版本。例如：
<ul>
<li><em>utf8_unicode_520_ci</em> 是基于 <a href="http://www.unicode.org/Public/UCA/5.2.0/allkeys.txt">UCA 5.2.0 加权键</a>。</li>
<li><em>utf8_unicode_ci</em> (名字中不含版本号) 是基于 <a href="http://www.unicode.org/Public/UCA/4.0.0/allkeys-4.0.0.txt">UCA 4.0.0 加权键</a>。</li>
</ul>
</li>
<li>对于 Unicode 字符集来说，<em>xxx_general_mysql500_ci</em> 排序规则保留了5.1.24之前的的原始排序规则 <em>xxx_general_ci</em> ，同时也允许 MySQL 5.1.24 之前创建的表进行升级。想要了解更多信息，请参考 <a href="http://dev.mysql.com/doc/refman/5.7/en/checking-table-incompatibilities.html"> Section 2.11.3, “Checking Whether Tables or Indexes Must Be Rebuilt” </a> 和 <a href="http://dev.mysql.com/doc/refman/5.7/en/rebuilding-tables.html"> Section 2.11.4, “Rebuilding or Repairing Tables or Indexes” </a></li>
</ul>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-3961477342dbdf6a1d2dee22c35df128">6 - Ubuntu</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-401b386da8551144a94cd399b33e853e">6.1 - Ubuntu 下 alacritty 终端中安装 nvim-tree 插件</h1>
    
	<hr>
<h2 id="tips">Tips</h2>
<p>使用 packer 安装 nvim-tree 的步骤比较简单，这里不再赘述。</p>
<ul>
<li>从 <a href="https://www.nerdfonts.com/font-downloads">nerdfonts</a> 选择一个你喜欢的字体并下载下来，我下载的是 DejaVuSansMono.zip</li>
<li>安装 nerd 字体</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>unzip -d ~/.fonts/DejaVuSansMono DejaVuSansMono.zip
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 刷新字体缓存</span>
</span></span><span style="display:flex;"><span>fc-cache -fv
</span></span></code></pre></div><ul>
<li>获取字体名称，打开终端，在 <strong>配置文件首选项</strong> 中查看字体名称</li>
</ul>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2022-10-21-155055.png" alt=""></p>
<p>可以看到字体名称是: <strong>DejaVuSansMono Nerd Font Mono</strong></p>
<ul>
<li>修改 <code>~/.alacritty.yml</code> 文件，将 <code>font -&gt; normal -&gt; family</code> 改成对应的字体名称</li>
<li>最终，我们就能够在终端里看到，图标被正确显示了</li>
</ul>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2022-10-21-155427.png" alt=""></p>
<h2 id="参考链接">参考链接</h2>
<ul>
<li><a href="https://www.nerdfonts.com/font-downloads">www.nerdfonts.com</a></li>
</ul>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-3e581989bbccdb5fda275519f67ba847">6.2 - Ubuntu 初始化</h1>
    
	<h2 id="安装软件">安装软件</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>sed -i <span style="color:#4e9a06">&#39;s/http:\/\/cn.archive.ubuntu.com/https:\/\/mirrors.ustc.edu.cn/g&#39;</span> /etc/apt/sources.list
</span></span><span style="display:flex;"><span>sudo apt update
</span></span><span style="display:flex;"><span>sudo apt install zsh git ripgrep vim curl build-essential
</span></span></code></pre></div><ul>
<li><a href="https://github.com/cli/cli/blob/trunk/docs/install_linux.md">github cli</a></li>
<li><a href="https://www.vagrantup.com/downloads">vagrant</a></li>
<li><a href="https://www.google.com/chrome/">google chrome</a></li>
<li><a href="https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb">chrome download</a></li>
</ul>
<h2 id="ubuntu-将-capslock-映射成-esc">Ubuntu 将 capslock 映射成 esc</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>sudo apt-get install dconf-tools
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 使 caps 成为 esc 按键</span>
</span></span><span style="display:flex;"><span>dconf write /org/gnome/desktop/input-sources/xkb-options <span style="color:#4e9a06">&#34;[&#39;caps:escape&#39;]&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 交换 caps 和 esc 按键</span>
</span></span><span style="display:flex;"><span>dconf write <span style="color:#4e9a06">&#34;/org/gnome/desktop/input-sources/xkb-options&#34;</span> <span style="color:#4e9a06">&#34;[&#39;caps:swapescape&#39;]&#34;</span>
</span></span></code></pre></div><ul>
<li>caps 配置的说明</li>
</ul>
<pre tabindex="0"><code>Caps Lock behavior

┌────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│Option                         Description                                                                          │
├────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│caps:internal                  Caps Lock uses internal capitalization; Shift &#34;pauses&#34; Caps Lock                     │
│caps:internal_nocancel         Caps Lock uses internal capitalization; Shift does not affect Caps Lock              │
│caps:shift                     Caps Lock acts as Shift with locking; Shift &#34;pauses&#34; Caps Lock                       │
│caps:shift_nocancel            Caps Lock acts as Shift with locking; Shift does not affect Caps Lock                │
│caps:capslock                  Caps Lock toggles normal capitalization of alphabetic characters                     │
│caps:shiftlock                 Caps Lock toggles Shift Lock (affects all keys)                                      │
│caps:swapescape                Swap Esc and Caps Lock                                                               │
│caps:escape                    Make Caps Lock an additional Esc                                                     │
│caps:escape_shifted_capslock   Make Caps Lock an additional Esc, but Shift + Caps Lock is the regular Caps Lock     │
│caps:backspace                 Make Caps Lock an additional Backspace                                               │
│caps:super                     Make Caps Lock an additional Super                                                   │
│caps:hyper                     Make Caps Lock an additional Hyper                                                   │
│caps:menu                      Make Caps Lock an additional Menu key                                                │
│caps:numlock                   Make Caps Lock an additional Num Lock                                                │
│caps:ctrl_modifier             Make Caps Lock an additional Ctrl                                                    │
│caps:none                      Caps Lock is disabled                                                                │
│                                                                                                                    │
└────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
</code></pre><h3 id="参考链接">参考链接</h3>
<ul>
<li><a href="https://askubuntu.com/a/365701/581894">How to permanently switch Caps Lock and Esc</a></li>
<li><a href="https://askubuntu.com/a/1415659/581894">jammy 22.04: how to map Capslock to ctrl and esc</a></li>
<li>man 7 xkeyboard-config</li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-85ccc389ff28c3fde48540584c68912e">6.3 - Ubuntu 使用默认的 DNS Server 配置</h1>
    
	<hr>
<h2 id="tips">Tips</h2>
<p>Ubuntu 使用 <code>/etc/resolv.conf</code> 中设置的地址为 DNS Server 地址</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 关闭 systemd-resolved 服务</span>
</span></span><span style="display:flex;"><span>sudo systemctl disable systemd-resolved
</span></span><span style="display:flex;"><span>sudo systemctl stop systemd-resolved
</span></span></code></pre></div><p>在 <code>/etc/NetworkManager/NetworkManager.conf</code> 文件的 <code>[main]</code> 部分添加配置</p>
<pre tabindex="0"><code>dns=default
</code></pre><p>删除原来的软链接文件</p>
<pre tabindex="0"><code>sudo unlink /etc/resolv.conf
</code></pre><p>重启 NetworkManager</p>
<pre tabindex="0"><code>sudo systemctl restart NetworkManager
</code></pre><h2 id="参考链接">参考链接</h2>
<ul>
<li><a href="https://askubuntu.com/a/907249/581894">https://askubuntu.com/a/907249/581894</a></li>
<li><a href="https://www.gabriel.urdhr.fr/2020/03/17/systemd-revolved-dns-configuration-for-vpn/">https://www.gabriel.urdhr.fr/2020/03/17/systemd-revolved-dns-configuration-for-vpn/</a></li>
</ul>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-07ba0697e72dd0ea984005d61f4f73f8">6.4 - 修复 Ubuntu 中 chrome vimium-c 插件失效的问题</h1>
    
	<blockquote>
<p>记录一次折腾 Ubuntu 的经历</p>
</blockquote>
<hr>
<p>下午升级了 Ubuntu 的一些软件之后，发现 Chrome 中的 vimium-c 插件失效了，按 k 不会向上滑动，而是像按下 tab 按键一样，选中 url 链接。weasd 等字符也是一样，同时飞书中输入不了 wkeasd 等字符。</p>
<h2 id="排查-vimium-c">排查 vimium-c</h2>
<p>最开始以为是 vimium-c 软件的 bug，于是去 github 中提 Issue。<a href="https://github.com/gdh1995/vimium-c/issues/558">#558</a></p>
<p>和作者排查了半天，使用作者提供了 <a href="https://gdh1995.cn/vimium-c/keyboard-test.html">keyboard-test</a> 工具检查按键能否正常工作，最后得出的结论是，</p>
<ol>
<li>使用 firefox, chromium 等浏览器依然会遇到这个问题</li>
<li>换一个用户后，这个问题就解决了。</li>
</ol>
<p>由此我认定一定是我的系统配置有问题，和浏览器无关。于是开始排查系统配置</p>
<h2 id="排查按键映射">排查按键映射</h2>
<p>一开始以为是 <code>xmodmap</code> 设置的问题，因为我用 <code>xmodmap</code> 改过键，将 caps-lock 改成了 Esc。</p>
<p>但是查了半天，发现我原来是用 <code>dconf</code> 改的，并不是用 <code>xmodmap</code>，我把 <code>dconf</code> 中的改键配置删除后，vimium-c 仍然不工作。</p>
<p>此时我就很无力了，用 <code>ls -al ~/</code> 和 <code>ls -al ~/.config</code> 反复看 HOME 目录下的配置文件，反复想可能是哪个配置文件导致的问题。</p>
<h2 id="最终定位问题">最终定位问题</h2>
<p>后来一想，既然这个问题能够复现，燕过留痕，肯定有个进程拦截了这些按键的事件，导致 chrome 出错了。排查进程比排查配置文件范围小了很多，就开始排查进程。</p>
<p>于是用 <code>ps aufx</code> 查看所有进程，一个一个地排查所有的进程。</p>
<p>最后发现罪魁祸首是 <code>orca</code>(Ubuntu 下屏幕阅读功能的进程) 进程，关掉 Ubuntu 阅读屏幕的辅助功能后，chrome 中就能够正常捕获这些按键的事件了。</p>
<h2 id="参考链接">参考链接</h2>
<ul>
<li><a href="https://github.com/gdh1995/vimium-c/issues/558">https://github.com/gdh1995/vimium-c/issues/558</a></li>
<li><a href="https://manpages.ubuntu.com/manpages/bionic/man1/orca.1.html">https://manpages.ubuntu.com/manpages/bionic/man1/orca.1.html</a></li>
</ul>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-828346b319a10bfadd19751af2752ecb">6.5 - Ubuntu缩小磁盘分区大小</h1>
    
	<p><strong>摘要</strong>:</p>
<blockquote>
<ol>
<li>通过resize2fs调整文件系统大小</li>
<li>通过parted调整磁盘分区大小</li>
</ol>
</blockquote>
<p>我在刚开始装系统的时候，没有考虑到以后的扩展，直接把所有的空间都给使用了，后来发现需要新的分区的时候，已经没有可用的空间了，这时候就需要将一个分区的空间给缩小，后来折腾了半天，终于成功了！下面我以虚拟机中装的Ubuntu 16.04为例子，和大家分享一下。</p>
<p>首先查看一下目前的磁盘分区</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>michale@vv2x:~$ lsblk
</span></span><span style="display:flex;"><span>NAME   MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT
</span></span><span style="display:flex;"><span>sda      8:0    <span style="color:#0000cf;font-weight:bold">0</span>   32G  <span style="color:#0000cf;font-weight:bold">0</span> disk
</span></span><span style="display:flex;"><span>├─sda1   8:1    <span style="color:#0000cf;font-weight:bold">0</span>  190M  <span style="color:#0000cf;font-weight:bold">0</span> part /boot
</span></span><span style="display:flex;"><span>├─sda2   8:2    <span style="color:#0000cf;font-weight:bold">0</span>    1K  <span style="color:#0000cf;font-weight:bold">0</span> part
</span></span><span style="display:flex;"><span>├─sda5   8:5    <span style="color:#0000cf;font-weight:bold">0</span>  7.6G  <span style="color:#0000cf;font-weight:bold">0</span> part /home
</span></span><span style="display:flex;"><span>├─sda6   8:6    <span style="color:#0000cf;font-weight:bold">0</span>  487M  <span style="color:#0000cf;font-weight:bold">0</span> part <span style="color:#ce5c00;font-weight:bold">[</span>SWAP<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>└─sda7   8:7    <span style="color:#0000cf;font-weight:bold">0</span> 23.7G  <span style="color:#0000cf;font-weight:bold">0</span> part /
</span></span><span style="display:flex;"><span>sr0     11:0    <span style="color:#0000cf;font-weight:bold">1</span> 1024M  <span style="color:#0000cf;font-weight:bold">0</span> rom
</span></span></code></pre></div><p>这个虚拟机上只有一块硬盘sda，sda分成了5个分区，其中sda2是扩展分区，现在，我想将/home分区的大小缩小为4G，这样可以多出一部分空间来新建一个分区，那该如何做呢，且听我慢慢道来。</p>
<h2 id="卸载home分区">卸载/home分区</h2>
<p>首先，我们需要以root登陆进去，用<code>umount /home</code>命令卸载/home分区。注意，此时其他用户必须已经退出了，否则就会显示/home分区是busy的，无法卸载。如果卸载时发现/home分区busy无法卸载，可以通过<code>lsof +d /home</code>命令来查看哪些进程在使用/home分区。</p>
<h2 id="缩小home分区的文件系统大小">缩小/home分区的文件系统大小</h2>
<p>第二步，通过<code>resize2fs</code>命令来缩小/home分区的__文件系统大小__。（注意：文件系统大小和磁盘分区大小是两个不同的概念。我的理解是，文件系统大小表示的是文件系统实际可用的大小，而磁盘分区大小则是文件系统所安装的磁盘分区的真实大小。通过<code>df -h</code>命令我们可以查看文件系统大小，通过<code>lsblk</code>或者<code>fdisk</code>命令可以查看磁盘分区大小。）</p>
<p>在这里，我将我的/home分区大小变成了4G，结果如下所示（需要注意的是，在缩小之前，首先要对文件系统进行检查）：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>root@vv2x:~# e2fsck -f /dev/sda5
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 上面这条命令强制对/dev/sda5的文件系统进行了检查</span>
</span></span><span style="display:flex;"><span>e2fsck 1.42.13 <span style="color:#ce5c00;font-weight:bold">(</span>17-May-2015<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>Pass 1: Checking inodes, blocks, and sizes
</span></span><span style="display:flex;"><span>Pass 2: Checking directory structure
</span></span><span style="display:flex;"><span>Pass 3: Checking directory connectivity
</span></span><span style="display:flex;"><span>Pass 4: Checking reference counts
</span></span><span style="display:flex;"><span>Pass 5: Checking group summary information
</span></span><span style="display:flex;"><span>/dev/sda5: 220/499968 files <span style="color:#ce5c00;font-weight:bold">(</span>3.6% non-contiguous<span style="color:#ce5c00;font-weight:bold">)</span>, 69132/1999872 blocks
</span></span><span style="display:flex;"><span>root@vv2x:~# resize2fs /dev/sda5 4G
</span></span><span style="display:flex;"><span>resize2fs 1.42.13 <span style="color:#ce5c00;font-weight:bold">(</span>17-May-2015<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>Resizing the filesystem on /dev/sda5 to <span style="color:#0000cf;font-weight:bold">1048576</span> <span style="color:#ce5c00;font-weight:bold">(</span>4k<span style="color:#ce5c00;font-weight:bold">)</span> blocks.
</span></span><span style="display:flex;"><span>The filesystem on /dev/sda5 is now <span style="color:#0000cf;font-weight:bold">1048576</span> <span style="color:#ce5c00;font-weight:bold">(</span>4k<span style="color:#ce5c00;font-weight:bold">)</span> blocks long.
</span></span></code></pre></div><h2 id="缩小home分区的磁盘分区大小">缩小/home分区的磁盘分区大小</h2>
<p>调整好文件系统大小以后，我们就需要来调整磁盘分区大小了，这里我们通过<code>parted</code>命令中的<code>resizepart</code>命令来调整分区大小。用法如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span>parted<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#204a87">help</span> resizepart
</span></span><span style="display:flex;"><span>  resizepart NUMBER END                    resize partition NUMBER
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NUMBER is the partition number used by Linux.  On MS-DOS disk labels, the primary
</span></span><span style="display:flex;"><span>partitions number from <span style="color:#0000cf;font-weight:bold">1</span> to 4, logical partitions from <span style="color:#0000cf;font-weight:bold">5</span> onwards.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>END is disk location, such as 4GB or 10%.  Negative value counts from the end of the
</span></span><span style="display:flex;"><span>disk.  For example, -1s specifies exactly the last sector.
</span></span></code></pre></div><p>其中NUMBER代表的是分区号，这里我们的/home分区为5，END代表的是结束的位置，我们可以用4GB来表示。（注意：<strong>parted的分区大小计算方式和lsblk不同</strong>，所以我们多留一些空间，防止数据丢失）</p>
<p>运行结果如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>root@vv2x:~# parted /dev/sda
</span></span><span style="display:flex;"><span>GNU Parted 3.2
</span></span><span style="display:flex;"><span>Using /dev/sda
</span></span><span style="display:flex;"><span>Welcome to GNU Parted! Type <span style="color:#4e9a06">&#39;help&#39;</span> to view a list of commands.
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span>parted<span style="color:#ce5c00;font-weight:bold">)</span> resizepart <span style="color:#0000cf;font-weight:bold">5</span> 5G
</span></span><span style="display:flex;"><span>Warning: Shrinking a partition can cause data loss, are you sure you want to <span style="color:#204a87;font-weight:bold">continue</span>?
</span></span><span style="display:flex;"><span>Yes/No? Yes
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span>parted<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>Information: You may need to update /etc/fstab.
</span></span></code></pre></div><h2 id="调整home分区的文件系统大小并重新挂载">调整/home分区的文件系统大小并重新挂载</h2>
<p>在第三步中，为了防止数据丢失，我们多留出了一些空间。在这里我们需要相应地调整文件系统大小，让其和磁盘空间大小匹配，这里我们通过<code>resize2fs</code>命令来完成这一步。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>root@vv2x:~# resize2fs /dev/sda7
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># resize2fs如果没有指定大小，那么/dev/sda7的文件系统大小默认和磁盘分区大小相同</span>
</span></span><span style="display:flex;"><span>resize2fs 1.42.13 <span style="color:#ce5c00;font-weight:bold">(</span>17-May-2015<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>Resizing the filesystem on /dev/sda7 to <span style="color:#0000cf;font-weight:bold">1171295</span> <span style="color:#ce5c00;font-weight:bold">(</span>4k<span style="color:#ce5c00;font-weight:bold">)</span> blocks.
</span></span><span style="display:flex;"><span>The filesystem on /dev/sda7 is now <span style="color:#0000cf;font-weight:bold">1171295</span> <span style="color:#ce5c00;font-weight:bold">(</span>4k<span style="color:#ce5c00;font-weight:bold">)</span> blocks long.
</span></span></code></pre></div><p>最后我们重新把/home分区挂载上就可以了。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>root@vv2x:~# mount -a
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 这条命令默认挂载/etc/fstab文件中所有指定的分区</span>
</span></span><span style="display:flex;"><span>root@vv2x:~# lsblk
</span></span><span style="display:flex;"><span>NAME   MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT
</span></span><span style="display:flex;"><span>sda      8:0    <span style="color:#0000cf;font-weight:bold">0</span>   32G  <span style="color:#0000cf;font-weight:bold">0</span> disk
</span></span><span style="display:flex;"><span>├─sda1   8:1    <span style="color:#0000cf;font-weight:bold">0</span>  190M  <span style="color:#0000cf;font-weight:bold">0</span> part /boot
</span></span><span style="display:flex;"><span>├─sda5   8:5    <span style="color:#0000cf;font-weight:bold">0</span>  487M  <span style="color:#0000cf;font-weight:bold">0</span> part <span style="color:#ce5c00;font-weight:bold">[</span>SWAP<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>├─sda6   8:6    <span style="color:#0000cf;font-weight:bold">0</span> 23.7G  <span style="color:#0000cf;font-weight:bold">0</span> part /
</span></span><span style="display:flex;"><span>└─sda7   8:7    <span style="color:#0000cf;font-weight:bold">0</span>  4.5G  <span style="color:#0000cf;font-weight:bold">0</span> part /home
</span></span><span style="display:flex;"><span>sr0     11:0    <span style="color:#0000cf;font-weight:bold">1</span> 1024M  <span style="color:#0000cf;font-weight:bold">0</span> rom
</span></span></code></pre></div><h2 id="注意">注意</h2>
<p>最后需要注意的是调整磁盘分区大小以后，磁盘分区的UUID可能会改变，<code>mount -a</code>命令可能会失败，此时我们需要通过<code>blkid</code>命令来查看/home分区的大小，并相应地更改<code>/etc/fstab</code>配置文件中指定的/home分区的UUID。</p>
</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-871466015f6090c36613870230e285c6">7 - 算法</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-9f5dcf38e17fcfeddce9852e9fd7027b">7.1 - 二分查找</h1>
    
	<h2 id="二分查找的注意点">二分查找的注意点</h2>
<ol>
<li>循环的条件: <code>left &lt;= right</code></li>
<li>mid 计算方法:</li>
</ol>
<pre tabindex="0"><code># 用移位预算速度更快
mid = left + ((right-left) &gt;&gt; 2))
</code></pre><ol start="3">
<li>left 和 right 的更新方法</li>
</ol>
<pre tabindex="0"><code>left = mid + 1
right = mid - 1
</code></pre>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-21f47c88e34eb924495192f8639a2df6">7.2 - LeetCode</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-5c761828d342b91f1c7dda6244083aee">7.2.1 - Leetcode 142: 环形链表 II</h1>
    
	<hr>
<h2 id="题目">题目</h2>
<p>给定一个链表的头节点  head ，返回链表开始入环的第一个节点。 如果链表无环，则返回 null。</p>
<p>链表节点的定义如下</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">ListNode</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Val</span>  <span style="color:#204a87;font-weight:bold">int</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Next</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ListNode</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="解题思路">解题思路</h2>
<h3 id="判断链表是否有环">判断链表是否有环</h3>
<p>判断链表是否有环就使用简单的双指针法。</p>
<p>定义两个指针，slow, fast, 它们一起从 head 开始往前移动，slow 每次移动一步，fast 每次移动两步。</p>
<p>因为每次移动后 fast 比 slow 多一步，如果链表有环的话，它们一定会相遇。代码如下</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 判断链表中是否有环，并返回 slow 指针
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">getCycleSlow</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">head</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ListNode</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ListNode</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">head</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fast</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">head</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">slow</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">head</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 注意这里的判断条件，先判断 fast 再判断 fast.Next
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">fast</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">fast</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Next</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">slow</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fast</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">fast</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Next</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Next</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">slow</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">slow</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Next</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">fast</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">slow</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#8f5902;font-style:italic">// 快慢指针重合
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#8f5902;font-style:italic">// s = nb
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#8f5902;font-style:italic">// f = 2nb
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">slow</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 链表中没有环，此时 slow == nil
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>我们假设链表中存在环，环的长度是 <code>b</code>。那么当 <code>getCycleSlow</code> 结束时，我们可以得到以下结论</p>
<ul>
<li>fast 移动的步数是 slow 的两倍</li>
</ul>

<div class="math">$$fast = 2 * slow$$</div><ul>
<li>fast 比 slow 多走了 n 次环的长度</li>
</ul>

<div class="math">$$fast = slow + n * b$$</div><p>将上述两式相减，可以得到</p>

<div class="math">$$slow = n * b$$</div>
<div class="math">$$fast = 2 * n * b$$</div><h3 id="寻找环的入口">寻找环的入口</h3>
<p>我们令 <code>a</code> 为从起点 head 到 环入口的距离，任意一个节点，从起点 head 走到环入口的距离为 k 步，可得:</p>

<div class="math">$$k = a + n * b$$</div><p>\(b\) 表示环的长度，任意一个节点从 head 开始，走 \(a\) 步后可以到达环入口，在环中再走 \(n\) 圈后，又到达了环入口。</p>
<p>此时我们继续用双指针法，</p>
<ol>
<li>定义一个追赶者 <code>pursuer</code>，让它从 head 开始往前走 \(a\) 步。</li>
<li>同时让 \(slow\) 开始往前走 \(a\) 步。</li>
</ol>
<p>因为 \(slow\) 已经走了 \(n * b\) 步了，所以当 \(slow\) 走了 \(a + n * b\) 步后，<code>pursuer</code> 走了 \(a\) 步之后，\(slow\) 和 <code>pursuer</code> 就会在环的入口相遇。</p>
<p>代码如下</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">detectCycle</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">head</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ListNode</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ListNode</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">pursuer</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">head</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 判断有环的同时，返回 slow 的位置
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">slow</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">getCycleSlow</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">head</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">slow</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 因为链表中有环，slow 和 pursuer 一定能够相遇
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// 需要先判断 pursuer == slow，因为 slow 可能正好停在环入口
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">pursuer</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">slow</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">pursuer</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">pursuer</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">pursuer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Next</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">slow</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">slow</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Next</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="参考链接">参考链接</h2>
<ul>
<li><a href="https://leetcode.cn/problems/linked-list-cycle-ii/solution/linked-list-cycle-ii-kuai-man-zhi-zhen-shuang-zhi-/">环形链表 II（双指针法，清晰图解）</a></li>
</ul>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-301653e9504d9bc0694f178fe07fe36e">7.2.2 - Leetcode 第343题</h1>
    
	<blockquote>
<ul>
<li><a href="https://leetcode.com/problems/integer-break/">LeetCode 343题</a></li>
</ul>
</blockquote>
<hr>
<h2 id="题目描述">题目描述</h2>
<p><a href="https://leetcode.com/problems/integer-break/">https://leetcode.com/problems/integer-break/</a></p>
<p><strong>注意:</strong></p>
<ol>
<li>给定的整数和被分解的整数都是正数，整数应该被分解成__至少__两个整数。</li>
<li>输入的 n 应该不小于 2，不大于 58</li>
</ol>
<p><strong>相关主题:</strong></p>
<ul>
<li>动态规划</li>
</ul>
<h2 id="解题思路">解题思路</h2>
<p>令求分解整数最大积的函数为 P，初始情况 <code>P(2) = 1</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#000">P</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">N</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">max</span><span style="color:#000;font-weight:bold">([</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># 注意，因为 P 函数将整数至少分解成了两个整数， P(N-1) 的 max 比较整数集中，不包括 N - 1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">P</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">N</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">N</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0000cf;font-weight:bold">2</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">P</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">N</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#0000cf;font-weight:bold">2</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">N</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0000cf;font-weight:bold">3</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">P</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">N</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#0000cf;font-weight:bold">3</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">N</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># 注意 P(1) 是不存在的，为了方便运算，我们将其设置为 1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">(</span><span style="color:#000">N</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">P</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">N</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">])</span>
</span></span></code></pre></div><p>从上面的公式可以看出，求出 <code>P(1) ~ P(N-1)</code> 后，才能求 <code>P(N)</code></p>
<p>这是<code>P(N)</code>的递归公式，如果用递归实现的话，会存在大量的重复计算，所以我们使用动态规划的方式来解这个题目。</p>
<p>令记录中间结果的表格为<code>dp</code>，<code>dp[n] = P(N)</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 初始化 dp, 设置dp中的每一个值都是 0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">dp</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span><span style="color:#000">dp</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 对于任意一个正整数i, P(i)的计算函数为</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">&gt;=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">-=</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">dp</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">max</span><span style="color:#000;font-weight:bold">([</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">dp</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">j</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic"># dp[i] 表示上一次(j+1)求出的最大值</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">dp</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">])</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>整个程序的思路就是，对于输入的正整数N，求出 <code>dp[3] ~ dp[N]</code> 的所有值，然后返回 <code>dp[N]</code> 即可</p>
<h2 id="代码">代码</h2>
<p><a href="https://github.com/bwangelme/LeetCode-Go/tree/master/l343">https://github.com/bwangelme/LeetCode-Go/tree/master/l343</a></p>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-2a81c7b01891dea88626767b1b355c10">7.2.3 - Leetcode 第342题</h1>
    
	<blockquote>
<ul>
<li><a href="https://leetcode.com/problems/power-of-four/">LeetCode 342题</a></li>
</ul>
</blockquote>
<hr>
<h2 id="题目描述">题目描述</h2>
<p><a href="https://leetcode.com/problems/power-of-four/">https://leetcode.com/problems/power-of-four/</a></p>
<p><strong>注意:</strong></p>
<ol>
<li>给定的整数参数是 <code>signed 32 bits</code>，即它有可能是负数</li>
<li>Follow up: Could you solve it without loops/recursion? 我们要给出一个不用循环或递归的解法</li>
</ol>
<h2 id="解题思路">解题思路</h2>
<p>这道题的 Related Topic 中给出的主题是 Bit Manipulation，我们要从4的二进制形式去考虑</p>
<p>4的N次方幂可以写成 $4^N$ ，可以进一步写成 $2^{2N}$ 。从这里我们就可以看出其二进制形式的规律</p>
<ol>
<li>只有1位是1，其余都是0</li>
<li>为1的位其位置是个偶数</li>
</ol>
<p>例如: 4 -&gt; 1000, 0 -&gt; 0001, 16 -&gt; 0001 0000</p>
<p>找到了这个规律后，我们的解决方案就是逐个判断给定的数字是否满足上面的条件</p>
<ol>
<li>num 必须是正数(隐含条件)</li>
<li><code>num &amp; (num-1) == 0</code>，此整数只有一位是1</li>
<li><code>num &amp; 0x55555555 == 0</code>，此整数为1的位，它的位置索引是个偶数</li>
</ol>
<h2 id="复杂度分析">复杂度分析</h2>
<ul>
<li>时间复杂度: O(1)</li>
<li>空间复杂度: O(1)</li>
</ul>
<h2 id="代码">代码</h2>
<p><a href="https://github.com/bwangelme/LeetCode-Go/tree/master/l342/">https://github.com/bwangelme/LeetCode-Go/tree/master/l342/</a></p>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-1aeb2a9eda376ee95c011157b6dd23c3">7.2.4 - Leetcode 第65题</h1>
    
	<blockquote>
<ul>
<li><a href="https://leetcode.com/problems/valid-number/">LeetCode 65题</a></li>
</ul>
</blockquote>
<hr>
<h2 id="题目描述">题目描述</h2>
<p>Validate if a given string can be interpreted as a decimal number.</p>
<p>Some examples:</p>
<pre tabindex="0"><code>&#34;0&#34; =&gt; true
&#34; 0.1 &#34; =&gt; true
&#34;abc&#34; =&gt; false
&#34;1 a&#34; =&gt; false
&#34;2e10&#34; =&gt; true
&#34; -90e3   &#34; =&gt; true
&#34; 1e&#34; =&gt; false
&#34;e3&#34; =&gt; false
&#34; 6e-1&#34; =&gt; true
&#34; 99e2.5 &#34; =&gt; false
&#34;53.5e93&#34; =&gt; true
&#34; --6 &#34; =&gt; false
&#34;-+3&#34; =&gt; false
&#34;95a54e53&#34; =&gt; false
</code></pre><p>Note: It is intended for the problem statement to be ambiguous. You should gather all requirements up front before implementing one. However, here is a list of characters that can be in a valid decimal number:</p>
<ul>
<li>Numbers 0-9</li>
<li>Exponent - <strong>&ldquo;e&rdquo;</strong> (注意只支持小写e，不支持大写E)</li>
<li>Positive/negative sign - &ldquo;+&rdquo;/&quot;-&quot;</li>
<li>Decimal point - &ldquo;.&rdquo;</li>
</ul>
<p>Of course, the context of these characters also matters in the input.</p>
<p>Update (2015-02-10):
The signature of the C++ function had been updated. If you still see your function signature accepts a const char * argument, please click the reload button to reset your code definition.</p>
<h2 id="解题思路">解题思路</h2>
<p><strong>一定要写单元测试，一定要写单元测试，一定要写单元测试</strong></p>
<p>这个题你可能本地测得十分正确，但一提交，发现 LeetCode 准备了各种稀奇古怪的输入，结果是提交失败，代码又得改，所以一定要写单元测试，这样能够节省大量的时间。</p>
<p>接下来我们开始分析这道题，就像题目中描述的那样，这道题非常具有迷惑性。一开始以为就是判断个数字，用正则就可以了，后来发现各种复杂的情况太多了，用正则处理不了，得上<a href="https://zh.wikipedia.org/wiki/%E6%9C%89%E9%99%90%E7%8A%B6%E6%80%81%E6%9C%BA">状态机</a>。</p>
<p>状态机的设计思路就是画个表格，输入的字符作为列(即状态机中的 Action)，在本题中共有四种情况，<code>数字</code>, <code>指数符号</code>, <code>正负符号</code>, <code>小数点</code>。行的话就是状态机的<code>状态</code>，首先加上起始状态，然后根据输入的情况，酌情添加。表格能够正确处理所有的有效输入后，再去除重复的行(状态)。</p>
<p>最终我设计出来的状态机表格是这样的</p>
<p><img src="https://passage-1253400711.cos-website.ap-beijing.myqcloud.com/2020-04-03-041334.png" alt=""></p>
<p>使用 Graphivz 画出来的效果图是这样的</p>
<ul>
<li>S0 为起始状态，绿色的状态表示输入为有效数字，其他的状态表示解析失败</li>
</ul>
<p><img src="https://passage-1253400711.cos-website.ap-beijing.myqcloud.com/2020-04-03-163625.jpg" alt=""></p>
<h2 id="代码">代码</h2>
<p>代码及测试在 <a href="https://github.com/bwangelme/LeetCode-Go/tree/master/l65">Github@LeetCode</a> 上</p>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-c8534acc911cdb888d719d03fe686713">7.2.5 - Leetcode 第2题</h1>
    
	<blockquote>
<ul>
<li><a href="https://leetcode.com/problems/add-two-numbers/">LeetCode 2题</a></li>
</ul>
</blockquote>
<hr>
<h2 id="题目描述">题目描述</h2>
<p>You are given two non-empty linked lists representing two non-negative integers. The digits are stored in reverse order and each of their nodes contain a single digit. Add the two numbers and return it as a linked list.</p>
<p>You may assume the two numbers do not contain any leading zero, except the number 0 itself.</p>
<p>Example:</p>
<pre><code>Input: (2 -&gt; 4 -&gt; 3) + (5 -&gt; 6 -&gt; 4)
Output: 7 -&gt; 0 -&gt; 8
Explanation: 342 + 465 = 807.
</code></pre>
<h2 id="解题思路">解题思路</h2>
<p>这个题目是对两个按位存储在链表中的非负整数进行求和。
一开始我的思路是将链表中的数转换成整数，求和之后，再将结果存储到一个列表中。</p>
<p>但是代码提交以后，发现还有<code>10000000000000000000000000000001</code>这样的输入值，这个明显溢出了，使用 uint64 也无法存储。</p>
<p>于是干脆转换思路，不进行转换，直接在列表的基础上执行求和操作。由于数在列表上是逆序存储的，即<code>31415</code>会存储成<code>51413</code>。
所以这就方便了我们执行求和的操作，直接从列表头开始执行+操作，如果某一位的和超过了10，则记录进位。</p>
<p>核心代码逻辑的如下所示:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// carry 表示进位
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// 需要注意，求和结束需要满足三个条件，两个加数链表已经遍历完，且 **进位为0**
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">l1</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">l2</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">carry</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">break</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">num</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">l1</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">num</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#000">l1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Val</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">l1</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">l1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Next</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">l2</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">num</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#000">l2</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Val</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">l2</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">l2</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Next</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">num</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#000">carry</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">carry</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">num</span> <span style="color:#ce5c00;font-weight:bold">&gt;=</span> <span style="color:#0000cf;font-weight:bold">10</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">num</span> <span style="color:#ce5c00;font-weight:bold">-=</span> <span style="color:#0000cf;font-weight:bold">10</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">carry</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// newListNode 是自定义函数，会创建一个新的链表节点
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">node</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">newListNode</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">num</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">head</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">head</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">node</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">prevNode</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">prevNode</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Next</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">node</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">prevNode</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">node</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="代码">代码</h2>
<p>解题代码和相关测试我已经放在 GitHub 上了，大家可以自行下载运行:</p>
<ul>
<li><a href="https://github.com/bwangelme/LeetCode-Go/tree/master/l2">bwangelme/LeetCode-Go/l2</a></li>
</ul>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-17e3d91069e260357770bce2053503eb">7.2.6 - Leetcode 第3题</h1>
    
	<blockquote>
<ul>
<li><a href="https://leetcode.com/problems/longest-substring-without-repeating-characters/">LeetCode 3题</a></li>
</ul>
</blockquote>
<hr>
<h2 id="题目描述">题目描述</h2>
<p><a href="https://leetcode.com/problems/longest-substring-without-repeating-characters/">https://leetcode.com/problems/longest-substring-without-repeating-characters/</a></p>
<h2 id="解题思路">解题思路</h2>
<p>这个题可以用动态规划的思路来解。</p>
<ul>
<li>字符串的长度为N,</li>
<li>字符串用<code>S(N)</code>表示</li>
<li><code>S(N)</code>中__不含重复字符的最长子串__用<code>NoRepeatSub(N)</code>表示</li>
<li><code>NoRepeatSub(N)</code>的长度用<code>L(N)</code>表示</li>
</ul>
<p>令 <code>S(N) = S(N-1) + char</code></p>
<ul>
<li><code>char</code>不在<code>S(N-1)</code>中，<code>L(N) = L(N-1) + 1</code></li>
<li><code>char</code>在<code>S(N-1)</code>中:
<ul>
<li><code>char</code>在<code>NoRepeatSub(N)</code>中, <code>L(N) = L()</code></li>
</ul>
</li>
</ul>
<h2 id="代码">代码</h2>
<p><a href="https://github.com/bwangelme/LeetCode-Go/tree/master/l3">https://github.com/bwangelme/LeetCode-Go/tree/master/l3</a></p>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-fa655b923d49cb69e575a767af9184d1">7.2.7 - Leetcode 第29题</h1>
    
	<blockquote>
<ul>
<li><a href="https://leetcode.com/problemset/all/">LeetCode 29题</a></li>
</ul>
</blockquote>
<hr>
<h2 id="题目描述">题目描述</h2>
<p>Given two integers dividend and divisor, divide two integers without using multiplication, division and mod operator.</p>
<p>Return the quotient after dividing dividend by divisor.</p>
<p>The integer division should truncate toward zero.</p>
<p>Example 1:</p>
<pre tabindex="0"><code>Input: dividend = 10, divisor = 3
Output: 3
</code></pre><p>Example 2:</p>
<pre tabindex="0"><code>Input: dividend = 7, divisor = -3
Output: -2
</code></pre><p>Note:</p>
<p>Both dividend and divisor will be 32-bit signed integers.
The divisor will never be 0. Assume we are dealing with an environment which could only store integers within the 32-bit signed integer range: [<code>−2^31</code>,  <code>2^31 − 1</code>]. For the purpose of this problem, assume that your function returns <code>2^31 − 1</code> when the division result overflows.</p>
<h2 id="解题思路">解题思路</h2>
<h3 id="基本思路">基本思路</h3>
<p>这道题是要求在不使用<code>*</code>, <code>/</code> 和取余的情况下做除法，那能用的方法就是做减法了。最简单的做法就是让被除数一直减除数，直到被除数为0为止，减法执行的次数就是商。</p>
<p>在这个基础上，我们可以执行一定的优化，例如 <code>divide(10, 2)</code> 执行的是以下的操作:</p>
<pre tabindex="0"><code>10 - 2 - 2 - 2 - 2 - 2

# 共执行了5次减法，所以商是5
</code></pre><p>我们可以将除数不断乘二（<code>&lt;&lt;1</code>），同时也将商不断乘二，直到除数为小于被除数的最大数，然后再执行被除数减去除数的操作。</p>
<p>在最好的情况下，上述优化可以将 $\frac{被除数}{除数}$ 次减法合并成 $log_2{\frac{被除数}{除数}}$ 次位运算。</p>
<h3 id="处理符号">处理符号</h3>
<p>题目中的输入值为32位有符号数，所以需要处理为负数的情况。这里比较简单，就是判断被除数和除数的符号是否相同就可以了。</p>
<p>在 C 语言中布尔值即是整数值，可以执行异或运算</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">sign</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#a40000">被除数</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">^</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#a40000">除数</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">?</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><p>在 Go 语言中，布尔值执行异或运算，只需要判断两个布尔值是否相同即可以了</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">sign</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#a40000">除数</span> <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#a40000">被除数</span> <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">sign</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="溢出情况">溢出情况</h3>
<p>题目中还提示到，当溢出发生时，返回$2^{31} - 1$。由于输入的数值是32位整数，执行的又是除法，所以溢出只可能是一种情况，就是</p>
<p>$$
\frac{-2^{31}}{-1}
$$</p>
<p>所以我们只需要处理这一种溢出情况即可。</p>
<h2 id="代码">代码</h2>
<ul>
<li><code>solution.go</code></li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">l29</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">MaxInt</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span><span style="color:#0000cf;font-weight:bold">31</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">MinInt</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#0000cf;font-weight:bold">31</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">IntAbs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">num</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">num</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">num</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">num</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">divide</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dividend</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">divisor</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">divisor</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87">panic</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;divided by zero&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 由于 dividend 和 divisor 都是 32 位有符号整数，所以溢出的情况只会是下面这一种情况。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">dividend</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">MinInt</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">divisor</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">MaxInt</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">dvd</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">IntAbs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dividend</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">dvs</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">IntAbs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">divisor</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">sign</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">dividend</span> <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">divisor</span> <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">sign</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">answer</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">dvd</span> <span style="color:#ce5c00;font-weight:bold">&gt;=</span> <span style="color:#000">dvs</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">tmp</span>   <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">dvs</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">count</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">n</span>		<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">tmp</span><span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span><span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">&lt;=</span> <span style="color:#000">dvd</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">tmp</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;=</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">count</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;=</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">dvd</span> <span style="color:#ce5c00;font-weight:bold">-=</span> <span style="color:#000">tmp</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">answer</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#000">count</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">answer</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">sign</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><ul>
<li><code>solution_test.go</code></li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">l29</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;github.com/stretchr/testify/assert&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;testing&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">TestDivide</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">testing</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">T</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">assert</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Equal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">divide</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">9</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">assert</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Equal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">divide</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">assert</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Equal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">divide</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">7</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">assert</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Equal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">divide</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">2147483648</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#0000cf;font-weight:bold">2147483647</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-dd111fb175ed5ffbd5348eb2329617bd">7.2.8 - Leetcode 第191题</h1>
    
	<blockquote>
<ul>
<li><a href="https://leetcode.com/problems/number-of-1-bits/">LeetCode 191题</a></li>
</ul>
</blockquote>
<hr>
<h2 id="题目描述">题目描述</h2>
<p>Write a function that takes an unsigned integer and return the number of &lsquo;1&rsquo; bits it has (also known as the Hamming weight).</p>
<h3 id="example-1">Example 1:</h3>
<pre tabindex="0"><code>Input: 00000000000000000000000000001011
Output: 3
Explanation: The input binary string 00000000000000000000000000001011 has a total of three &#39;1&#39; bits.
</code></pre><h3 id="example-2">Example 2:</h3>
<pre tabindex="0"><code>Input: 00000000000000000000000010000000
Output: 1
Explanation: The input binary string 00000000000000000000000010000000 has a total of one &#39;1&#39; bit.
</code></pre><h3 id="example-3">Example 3:</h3>
<pre tabindex="0"><code>Input: 11111111111111111111111111111101
Output: 31
Explanation: The input binary string 11111111111111111111111111111101 has a total of thirty one &#39;1&#39; bits.
</code></pre><p>Note:</p>
<p>Note that in some languages such as Java, there is no unsigned integer type. In this case, the input will be given as signed integer type and should not affect your implementation, as the internal binary representation of the integer is the same whether it is signed or unsigned.</p>
<p>In Java, the compiler represents the signed integers using 2&rsquo;s complement notation. Therefore, in Example 3 above the input represents the signed integer -3.</p>
<h2 id="解题思路">解题思路</h2>
<h3 id="n--n---1">n &amp; n - 1</h3>
<h4 id="二的正指数幂">二的正指数幂</h4>
<p>如果一个正整数是2的幂，那么这个正整数的二进制表示中只有一个1，且<code>n &amp; (n-1) == 0</code>。因为从<code>n</code>的二进制表示中的1开始向右数，<code>n</code>和<code>n-1</code>的二进制表示正好是相反的。</p>
<p>例如<code>bin(8) = 0b1000</code>，<code>bin(7) = 0b0111</code>，<code>8 &amp; 7 == 0b1000 &amp; 0b0111 == 0</code>。</p>
<h4 id="普通正整数">普通正整数</h4>
<p>任何一个正整数<code>N</code>都可以分解成若干个2的正指数幂的和：</p>
<p>$$
N = 2^n*tn + 2^{n-1}<em>t{n-1} + &hellip; + 2^0</em>t0
$$</p>
<p>那么对于任意一个正整数N来说，<code>N = N &amp; (N-1)</code>就是让<code>N</code>减去其中最小的2的幂。例如：</p>
<p>$$
10 = 2^3 * 1 + 2^2 * 0 + 2^1 * 1 + 2^0 * 0
$$</p>
<p>$$
9 = 2^3 * 1 + 2^2 * 0 + 2^1 * 0 + 2^0 * 1
$$</p>
<p><code>10 &amp; 9</code>就是将10减去其中的最小的2的幂<code>2</code>，得到的结果为<code>8</code>。</p>
<p>将以上结果代入到正整数二进制表示中考虑，可得:</p>
<blockquote>
<p><code>N = N &amp; (N-1)</code>会将N的二进制表示中最右边的1变成0。</p>
</blockquote>
<h2 id="答案">答案</h2>
<p>了解了<code>N = N &amp; (N-1)</code>的含义之后，整个题目的解题思路也就出来了，</p>
<p>每次执行<code>N = N &amp; (N-1)</code>都会将<code>N</code>最右边的1变成0，我们就可以执行循环<code>N = N &amp; (N-1)</code>，
直到<code>N == 0</code>，循环的执行次数就是<code>N</code>中1的个数。</p>
<p>由于题目中给出的<code>N</code>是非负整数，所以我们还需要额外处理一下<code>N == 0</code>的情况。</p>
<h2 id="代码">代码</h2>
<p>题目的答案及测试代码如下:</p>
<ul>
<li>solution.go</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">l166</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;strconv&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">hammingWeight</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">num</span> <span style="color:#204a87;font-weight:bold">uint32</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">num</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">count</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">num</span> <span style="color:#ce5c00;font-weight:bold">&amp;=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">num</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">num</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">break</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">count</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">count</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">binStrToUint32</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">binary</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">uint32</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">num</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">strconv</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ParseUint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">binary</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">32</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatalln</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87">uint32</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">num</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><ul>
<li>solution_test.go</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">l166</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;testing&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;github.com/stretchr/testify/assert&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">TestHammingWeight</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">testing</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">T</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">assert</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Equal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">hammingWeight</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">binStrToUint32</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;00000000000000000000000000001011&#34;</span><span style="color:#000;font-weight:bold">)),</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">assert</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Equal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">hammingWeight</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">binStrToUint32</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;11111111111111111111111111111101&#34;</span><span style="color:#000;font-weight:bold">)),</span> <span style="color:#0000cf;font-weight:bold">31</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">assert</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Equal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">hammingWeight</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">binStrToUint32</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;00000000000000000000000010000000&#34;</span><span style="color:#000;font-weight:bold">)),</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">assert</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Equal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">hammingWeight</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">binStrToUint32</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;00000000000000000000000000000000&#34;</span><span style="color:#000;font-weight:bold">)),</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="参考资料">参考资料</h2>
<ul>
<li><a href="https://book.douban.com/subject/3004255/">《编程之美》</a></li>
</ul>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-99b32d044faa3fce9f3f75a3429e0a8a">7.2.9 - Leetcode 第338题</h1>
    
	<blockquote>
<ul>
<li><a href="https://leetcode.com/problems/reverse-words-in-a-string/">LeetCode 338题</a></li>
</ul>
</blockquote>
<h2 id="题目描述">题目描述</h2>
<p>Given a non negative integer number num. For every numbers i in the range 0 ≤ i ≤ num calculate the number of 1&rsquo;s in their binary representation and return them as an array.</p>
<p>Example 1:</p>
<pre tabindex="0"><code>Input: 2
Output: [0,1,1]
</code></pre><p>Example 2:</p>
<pre tabindex="0"><code>Input: 5
Output: [0,1,1,2,1,2]
</code></pre><p>Follow up:</p>
<p>It is very easy to come up with a solution with run time O(n*sizeof(integer)). But can you do it in linear time O(n) /possibly in a single pass?
Space complexity should be O(n).
Can you do it like a boss? Do it without using any builtin function like <strong>builtin</strong> popcount in c++ or in any other language.</p>
<h2 id="解题思路">解题思路</h2>
<p>求一个非负整数的二进制表示中有多少个1, 这个问题可以用分治法来解决。</p>
<p>令非负整数 N 中的1有 f(N) 个，N的个位数为 S(N)</p>
<p>$$
f(N) = f(N/2) + (S(N) == 1)
$$
$$
&hellip;
$$
$$
f(0) = 0
$$</p>
<p>根据上述的思路，我们可以写出如下的伪代码:</p>
<pre tabindex="0"><code>def count_bit(N):
  if N == 0:
    return 0

  if N &amp; 1 == 1:
    return count_bit(N/2) + 1
  else:
    return count_bit(N/2)
</code></pre><p>这个题需要求<code>1..N</code>每个数的二进制表示中1的个数，所以我们可以将中间结果存储起来，没必要每个数都从0开始运算一遍。</p>
<h2 id="代码">代码</h2>
<ul>
<li>solution.go</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">l338</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">CountBits</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">num</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">result</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">int</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">bitCount</span> <span style="color:#204a87;font-weight:bold">int</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">result</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">result</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;=</span> <span style="color:#000">num</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">bitCount</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">result</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">bitCount</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">result</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">result</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">result</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">bitCount</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">result</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><ul>
<li>solution_test.go</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">l338</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;testing&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;github.com/stretchr/testify/assert&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">TestCountBits</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">testing</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">T</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">assert</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Equal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">{</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">},</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">{</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">assert</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Equal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">CountBits</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">{</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">assert</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Equal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">CountBits</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">{</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-080b2406352b570ddfdaa5988aac5880">7.2.10 - Leetcode 第151题</h1>
    
	<blockquote>
<ul>
<li><a href="https://leetcode.com/problems/reverse-words-in-a-string/">LeetCode 151题</a></li>
</ul>
</blockquote>
<h2 id="题目描述">题目描述</h2>
<p>Given an input string, reverse the string word by word.</p>
<ul>
<li>Example 1:</li>
</ul>
<pre tabindex="0"><code>Input: &#34;the sky is blue&#34;
Output: &#34;blue is sky the&#34;
</code></pre><ul>
<li>Example 2:</li>
</ul>
<pre tabindex="0"><code>Input: &#34;  hello world!  &#34;
Output: &#34;world! hello&#34;
Explanation: Your reversed string should not contain leading or trailing spaces.
</code></pre><ul>
<li>Example 3:</li>
</ul>
<pre tabindex="0"><code>Input: &#34;a good   example&#34;
Output: &#34;example good a&#34;
Explanation: You need to reduce multiple spaces between two words to a single space in the reversed string.
</code></pre><ul>
<li>Note:</li>
</ul>
<p>A word is defined as a sequence of non-space characters.
Input string may contain leading or trailing spaces. However, your reversed string should not contain leading or trailing spaces.
You need to reduce multiple spaces between two words to a single space in the reversed string.</p>
<ul>
<li>Follow up:</li>
</ul>
<p>For C programmers, try to solve it in-place in O(1) extra space.</p>
<h2 id="解题思路">解题思路</h2>
<ul>
<li>将整个字符串从后向前遍历，将遍历到的__非空格__内容输出到一个临时变量中<code>word</code>。</li>
<li>如果遍历到空格，将<code>word</code>中的内容加上空格后一起输出，同时将<code>word</code>清空。</li>
<li>遍历完整个字符串后，所有的单词也就被输出了。</li>
</ul>
<p><strong>注意:</strong></p>
<ul>
<li>最后要将结果结尾多余的空格切掉</li>
<li>需要手动处理<code>&quot;&quot;</code>的输入</li>
</ul>
<h2 id="代码">代码</h2>
<ul>
<li>solution.go</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">l151</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">reverseWord</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">word</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">runeString</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87">rune</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">word</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">reverseString</span> <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">runeString</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&gt;=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">--</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">reverseString</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#204a87">string</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">runeString</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">])</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">reverseString</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">reverseWords</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">result</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#4e9a06">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">word</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#4e9a06">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">length</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">s</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#34;&#34;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">length</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&gt;=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">--</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#39; &#39;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">word</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">result</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#000">reverseWord</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">word</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#4e9a06">&#34; &#34;</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">word</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">word</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#204a87">string</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">])</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">word</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">result</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#000">reverseWord</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">word</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#4e9a06">&#34; &#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">result</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">result</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">result</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#39; &#39;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">result</span><span style="color:#000;font-weight:bold">[:</span><span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">result</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">result</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><ul>
<li>solution_test.go</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">l151</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;testing&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;github.com/stretchr/testify/assert&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">TestReverseWords</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">testing</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">T</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">assert</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Equal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">reverseWords</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;a good   example&#34;</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#4e9a06">&#34;example good a&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">assert</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Equal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">reverseWords</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">assert</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Equal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">reverseWords</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34; &#34;</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#4e9a06">&#34;&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">assert</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Equal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">reverseWords</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;the sky is blue&#34;</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#4e9a06">&#34;blue is sky the&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">assert</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Equal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">reverseWords</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;  hello world!  &#34;</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#4e9a06">&#34;world! hello&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-84ffa092ec053720f155e2f5a14b7b11">7.2.11 - Leetcode[258]. Add Digits</h1>
    
	<blockquote>
<ul>
<li><a href="https://leetcode.com/problems/add-digits/">LeetCode 258题</a></li>
</ul>
</blockquote>
<hr>
<h2 id="题目描述">题目描述</h2>
<p>Given a non-negative integer num, repeatedly add all its digits until the result has only one digit.</p>
<p>Example:</p>
<p>Input: 38</p>
<p>Output: 2</p>
<p>Explanation: The process is like: 3 + 8 = 11, 1 + 1 = 2.
Since 2 has only one digit, return it.</p>
<p>Follow up:
Could you do it without any loop/recursion in O(1) runtime?</p>
<h2 id="解题思路">解题思路</h2>
<h3 id="数根的定义">数根的定义</h3>
<p>这个题目其实是让求一个非负整数的数根，关于数根的定义如下:</p>
<blockquote>
<p>在数学中，数根（又称位数根或数字根 Digital root）是自然数的一种性质，</p>
</blockquote>
<blockquote>
<p>数根是将一正整数的各个位数相加（即横向相加），若加完后的值大于10的话，则继续将各位数进行横向相加直到其值小于10为止。</p>
</blockquote>
<blockquote>
<p>或是，将一数字重复做数字和，直到其值小于10为止，则所得的值为该数的数根。</p>
</blockquote>
<p>例如54817的数根为7，因为5+4+8+1+7=25，25大于10则再加一次，2+5=7，7小于十，则7为54817的数根。</p>
<h3 id="自然数和它的数根模9同余">自然数和它的数根模9同余</h3>
<p>要求一个数的数根，我们需要了解数根的一个重要性质:</p>
<blockquote>
<p>自然数<code>N</code>和它的数根<code>X</code>，对9取余，他们的余数相同</p>
</blockquote>
<p>接下来我们证明一下这个性质，</p>
<p>假设有一个<code>n</code>位的10进制自然数<code>N</code>，我们可以写成 $ N = \sum_{i=0}^{n} a_i * 10^i $</p>
<p>因为</p>
<ul>
<li>$ 10^n \equiv 1^n \equiv 1 \pmod 9 $，即 $10^n$ ， $1^n$ 和 1 模9，得到的余数都是1。</li>
<li>模运算的乘法运算规则 $ (a * b) % p \equiv (a % p * b % p) % p $</li>
</ul>
<p>所以 $ N \equiv \sum_{i=0}^{n} a_i \pmod 9 $，</p>
<p>$ \sum_{i=0}^{n} a_i $ 即是自然数<code>N</code>的各个位数相加，我们将自然数<code>N</code>的各个位数相加的操作称为<code>f</code>，其相加结果为<code>f(N)</code></p>
<p>可得 $ N \equiv f(N) \pmod 9$</p>
<p>进一步可得 $ N \equiv f(N) \equiv f(f(N)) \equiv f(f(f(N))) \pmod 9 &hellip; $</p>
<p><code>N</code>的数根是重复各个位数相加的过程得来的，所以可得 $ N \equiv N的数根 \pmod 9 $</p>
<h2 id="代码">代码</h2>
<p>根据<code>自然数和它的数根模9同余</code>的性质，我们可以推断出，一个数的数根是它模9的余数，或者是9（模9等于0）。</p>
<p>最终代码如下:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">l258</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// addDigits 计算 __数根__ 的程序
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">addDigits</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">num</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">num</span> <span style="color:#ce5c00;font-weight:bold">&lt;=</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// 非自然数及0的情况
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">res</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">num</span> <span style="color:#ce5c00;font-weight:bold">%</span> <span style="color:#0000cf;font-weight:bold">9</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">res</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#8f5902;font-style:italic">// 模9等于0时，其数根为9
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">9</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#8f5902;font-style:italic">// 自然数的数根为其模9的余数
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">res</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><ul>
<li>测试代码</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">l258</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;testing&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;github.com/stretchr/testify/assert&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">TestAddDigits</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">testing</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">T</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">assert</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Equal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">addDigits</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">38</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">assert</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Equal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">addDigits</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">assert</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Equal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">9</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">addDigits</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">9</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">assert</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Equal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">9</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">addDigits</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">18</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="参考链接">参考链接</h2>
<ul>
<li><a href="https://zh.wikipedia.org/wiki/%E6%95%B8%E6%A0%B9">维基百科 - 数根</a></li>
<li><a href="https://www.zhihu.com/question/30972581/answer/50203344">如何证明一个数的数根(digital root)就是它对9的余数？ - 知乎用户的回答 - 知乎</a></li>
<li><a href="https://baike.baidu.com/item/%E5%8F%96%E6%A8%A1%E8%BF%90%E7%AE%97/10739384?fr=aladdin">百度百科 - 取模运算</a></li>
</ul>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-34baac9a2ee283b8630219993a8f5dfd">7.2.12 - Leetcode 第8题</h1>
    
	<blockquote>
<p><a href="https://leetcode.com/problems/string-to-integer-atoi/submissions/">https://leetcode.com/problems/string-to-integer-atoi/submissions/</a></p>
</blockquote>
<h2 id="题目描述">题目描述</h2>
<p>实现一个将字符串转换成整数的<code>atoi</code>。</p>
<p>这个函数首先会丢弃掉前面不必要的空白字符。然后从第一个非空白字符开始，输入一个可选的<code>+</code>或者<code>-</code>符号，符号后面跟着不限数量的数字符号，然后将这个字符串解释成一个数字。</p>
<p>在这个字符串的有效数字后面后面可以跟着附加的非数字字符，这些字符将会被忽略，不会影响到函数的功能。</p>
<p>如果字符串中第一个非空白字符不是一个有效的数字，或者在字符串中 不存在这样有效的数字序列，不需要进行转换。如果没有有效的数字字符串进行转换，返回0即可。</p>
<p>注意:</p>
<ul>
<li>仅有空格字符<code> </code>被认为是空白字符。</li>
<li>假设我们处于一个仅仅能够存储32位带符号整数<code>range = [-2^31, 2^31-1]</code>的环境中，如果解析出来的数字超出了可以表示的范围。<code>INT_MAX(2^31 - 1)</code>或者<code>INT_MIN(-2^31)</code>将会被返回。</li>
</ul>
<h2 id="答案示例">答案示例</h2>
<h3 id="example-1">Example 1</h3>
<pre tabindex="0"><code>Input: &#34;42&#34;
Output: 42
</code></pre><h3 id="example-2">Example 2</h3>
<pre tabindex="0"><code>Input: &#34;   -42&#34;
Output: -42
</code></pre><ul>
<li>解释: 第一个非空白符号是<code>-</code>号，加上后面跟着的数字，可以解析出 42 来</li>
</ul>
<h3 id="example-3">Example 3</h3>
<pre tabindex="0"><code>Input: &#34;4193 with words&#34;
Output: 4193
</code></pre><ul>
<li>解释: 转换在遇到3之后就停止了，因为下一个字符不是数字</li>
</ul>
<h3 id="example-4">Example 4</h3>
<pre tabindex="0"><code>Input: &#34;words and 987&#34;
Output: 0
</code></pre><ul>
<li>解释: 第一个非空白字符是 w，因为既不是有效的数字也不是<code>+</code>或者<code>-</code>符号，所以转换没有发生</li>
</ul>
<h3 id="example-5">Example 5:</h3>
<pre tabindex="0"><code>Input: &#34;-91283472332&#34;
Output: -2147483648
</code></pre><ul>
<li>解释: 数字<code>-91283472332</code>超出了32位数所能表示的范围，所以返回了<code>INT_MIN(-2^31)</code></li>
</ul>
<h2 id="解题思路">解题思路</h2>
<p>看到这个题，一下子就想起了<a href="https://leetcode.com/problems/valid-number/">LeetCode 第65题</a>, 可以通过状态机来解决，而且这个题目中由于忽略浮点数和科学计数法表示的数字，所以这个状态机的设计还简单一些。</p>
<p>首先定义输入的 token，一开始我将 Token 分成了四组，</p>
<table>
<thead>
<tr>
<th>Token</th>
<th>Char</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>space</td>
</tr>
<tr>
<td>1</td>
<td>+/-</td>
</tr>
<tr>
<td>3</td>
<td>0-9</td>
</tr>
<tr>
<td>4</td>
<td>INVALID CHAR</td>
</tr>
</tbody>
</table>
<p>后来发现这种设计，对于<code>+000023</code>这种情况处理起来不太友好，就将<code>0</code>单独设计为一种 Token。最终设计的 Token 和 <strong>状态转换表格</strong> 如下所示：</p>
<table>
<thead>
<tr>
<th>Token</th>
<th>Char</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>space</td>
</tr>
<tr>
<td>1</td>
<td>+/-</td>
</tr>
<tr>
<td>2</td>
<td>0</td>
</tr>
<tr>
<td>3</td>
<td>1-9</td>
</tr>
<tr>
<td>4</td>
<td>INVALID CHAR</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>State</th>
<th>T0</th>
<th>T1</th>
<th>T2</th>
<th>T3</th>
<th>T4</th>
</tr>
</thead>
<tbody>
<tr>
<td>S0</td>
<td>S0</td>
<td>S1</td>
<td>S4</td>
<td>S2</td>
<td>S3</td>
</tr>
<tr>
<td>S1</td>
<td>S3</td>
<td>S3</td>
<td>S1</td>
<td>S2</td>
<td>S3</td>
</tr>
<tr>
<td>S2</td>
<td>S3</td>
<td>S3</td>
<td>S2</td>
<td>S2</td>
<td>S3</td>
</tr>
<tr>
<td>S3</td>
<td>S3</td>
<td>S3</td>
<td>S3</td>
<td>S3</td>
<td>S3</td>
</tr>
<tr>
<td>S4</td>
<td>S3</td>
<td>S3</td>
<td>S4</td>
<td>S2</td>
<td>S3</td>
</tr>
</tbody>
</table>
<ul>
<li>S3 是终止状态</li>
<li>S1 状态可以用来确定整个数字的符号是正数还是负数</li>
<li>S2 状态获得的数字都是有效的数字，需要存储起来</li>
</ul>
<h2 id="答案">答案</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;strconv&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">myAtoi</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">str</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">intMax</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">int</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span><span style="color:#0000cf;font-weight:bold">31</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">intMin</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">int</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span><span style="color:#0000cf;font-weight:bold">31</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">stateMap</span> <span style="color:#000;font-weight:bold">[][]</span><span style="color:#204a87;font-weight:bold">int</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">stateMap</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stateMap</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">{</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">stateMap</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stateMap</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">{</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">stateMap</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stateMap</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">{</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">stateMap</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stateMap</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">{</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">stateMap</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">stateMap</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">{</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">strNumber</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#4e9a06">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">path</span>  <span style="color:#000;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">4</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">state</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">sign</span>  <span style="color:#000;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">char</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">str</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">switch</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">char</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#39; &#39;</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">path</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">char</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#39;+&#39;</span> <span style="color:#ce5c00;font-weight:bold">||</span> <span style="color:#000">char</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#39;-&#39;</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">path</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">char</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#39;0&#39;</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">path</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#4e9a06">&#39;0&#39;</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#000">char</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">char</span> <span style="color:#ce5c00;font-weight:bold">&lt;=</span> <span style="color:#4e9a06">&#39;9&#39;</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">path</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">3</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">default</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">path</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">4</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">state</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">stateMap</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">state</span><span style="color:#000;font-weight:bold">][</span><span style="color:#000">path</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">state</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">3</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">break</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">state</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">char</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#4e9a06">&#39;0&#39;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">char</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#39;+&#39;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">sign</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">sign</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">state</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">2</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">strNumber</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#204a87">string</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">char</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">strNumber</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">strNumber</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#0000cf;font-weight:bold">10</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">sign</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">intMin</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">intMax</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">number</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">strconv</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Atoi</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">strNumber</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">number</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">number</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">sign</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 如果数字的大小超过了32位数表示的范围，则返回 INT_MAX 或者 INT_MIN
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">number</span> <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#000">intMax</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">intMax</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">number</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#000">intMin</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">intMin</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">number</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-e8f4ac0e603f47c82bb66534cf70181c">7.2.13 - Leetcode 661题</h1>
    
	<blockquote>
<ul>
<li>LeetCode 661题</li>
<li><a href="https://leetcode.com/problems/non-decreasing-array/">https://leetcode.com/problems/non-decreasing-array/</a></li>
</ul>
</blockquote>
<h2 id="题目">题目</h2>
<p>给定一个数组有N个元素(<code>1 &lt;= N &lt;= 10000</code>)，你的任务是__最多__修改其中的一个元素，将这个数组变成非递减数组。如果可以完成这个任务，函数返回 True，否则返回 False</p>
<p>非递减数组定义：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">is_nonDecrease_arr</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">arr</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">idx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">_</span> <span style="color:#204a87;font-weight:bold">in</span> <span style="color:#204a87">enumerate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">arr</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">arr</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">idx</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">arr</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">idx</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]:</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">False</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">True</span>
</span></span></code></pre></div><ul>
<li>输入例子1
<ul>
<li>Input: [4,2,3]</li>
<li>Output: True</li>
<li>Explanation: 修改4可以让数组变成非递减数组</li>
</ul>
</li>
<li>输入例子2
<ul>
<li>Input: [4,2,1]</li>
<li>Output: False</li>
<li>Explanation: 无法实现修改某个元素让数组变成非递减数组</li>
</ul>
</li>
</ul>
<h2 id="解题思路">解题思路</h2>
<ul>
<li>遍历整个数组，寻找递减的双数元组</li>
<li>如果递减双数元组找到了2个及以上，函数返回 False。</li>
<li>如果递减双数元组找到了0个，返回 True</li>
<li>如果递减双数元组找到了1个
<ul>
<li>如果这个元组位于数组的首部或尾部，直接修改其中一个数就可以，返回 True</li>
<li>如果这个元素位于数组的中间，尝试修改这个元组中的两个数，看能否把这个元组 + 它们前后两个数变成非递减数列</li>
</ul>
</li>
</ul>
<h2 id="答案">答案</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">checkPossibility</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nums</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">bool</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">k</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nums</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">nums</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#000">nums</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#8f5902;font-style:italic">// 如果 k != -1，说明之前已经找到过一次了
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">k</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">k</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">i</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 没有找到递减的双数元组
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">k</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 递减双数元组位于数组首部或者尾部
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">k</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#ce5c00;font-weight:bold">||</span> <span style="color:#000">k</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">nums</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">2</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 修改 nums[k] 可以让数组变成非递减数组
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">nums</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">k</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">&lt;=</span> <span style="color:#000">nums</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">k</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 修改 nums[k+1] 可以让数组变成非递减数组
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">nums</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">k</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">&lt;=</span> <span style="color:#000">nums</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">k</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div>
</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-1e58c13d4d6af0d346b296fbce0d0972">7.3 - 哈希表学习笔记</h1>
    
	<h2 id="解决冲突的两种方法">解决冲突的两种方法</h2>
<h3 id="分离连接法">分离连接法</h3>
<p>散列表的装填因子（load factor）为散列表中元素的个数与散列表大小的比值。表的大小并不重要，装填因子才是最重要的。
分离连接散列的一般法则是使得表的大小尽量与预料的元素个数差不多（换句话说，装填因子 ≈ 1）</p>
<h3 id="开放定址法">开放定址法</h3>
<p>在开放定址散列算法系统中，如果有冲突发生，那么就要尝试选择另外的单元。<code>h0(x)</code>, <code>h1(x)</code>, &hellip; 逐个尝试</p>
<p>其中 <code>hi(x) = (hash(x) + F(i)) mod tableSize</code>，其中F(i)是解决冲突的方法。一般来说，开放定址法的散列算法其装填因子 lambda &lt;= 0.5</p>
<h2 id="定理证明">定理证明</h2>
<h3 id="将乘法运算转换成位运算">将乘法运算转换成位运算</h3>
<p>令 $F(0) = 0$ 且 $F(i) = F(i - 1) + 2 \cdot i - 1$，则 $F(i) = i ^ 2$。</p>
<p>证明过程:</p>
<p>$$
F(0) = 0
$$
$$
F(1) = F(0) + (2 \cdot 1) - 1
$$
$$
F(0) + F(1) + F(2) + &hellip; + F(i) = 0 + F(0) + (2 \cdot 1) - 1 + (2 \cdot 2) - 1 + &hellip; + F(i-1) + (2 \cdot i) - 1
$$
$$
F(i) = (2 \cdot 1) - 1 + (2 \cdot 2) - 1 + &hellip; + (2 \cdot i) - 1
$$
$$
F(i) = 1 + 3 + 5 + &hellip; + 2 \cdot i - 1
$$
$$
F(i) = \frac{1+2 \cdot i-1}{2} = i^2
$$</p>
<p>这样就将一个乘法运算转换成了一个位移运算，提高了效率。</p>
<h3 id="平方探测法总可向空间大于12的哈希表中插入元素">平方探测法总可向空间大于1/2的哈希表中插入元素</h3>
<h4 id="相关定理">相关定理：</h4>
<ul>
<li>$(a+b) \mod n = (a \mod n + b \mod n) \mod n$</li>
<li>$(a \mod n) \mod n = a \mod n$</li>
</ul>
<h4 id="定理说明">定理说明</h4>
<p>如果使用平方探测，且表的大小是素数，那么当表至少有一半为空的时候，总能够插入一个新的元素</p>
<h4 id="证明">证明</h4>
<ul>
<li>前提说明</li>
</ul>
<p>哈希表大小为<code>ts</code>，我们向其中插入了两个冲突的元素x和y。这两个元素冲突重试的次数分别是<code>i</code>和<code>j</code>。其中：</p>
<p>$$
0 &lt; i, j &lt; \frac{ts}{2}  (小于 \frac{ts}{2} 意味着表中还有多余一半的空间可以使用)
$$
$$
P_x = (Hash(x) + i^2) \mod ts (x位置)
$$
$$
P_y = (Hash(y) + j^2) \mod ts (y位置)
$$
$$
Hash(x) \mod {ts} = Hash(y) \mod {ts} =&gt; (Hash(x) - Hash(y)) \mod ts = 0
$$
$$
ts 是素数
$$</p>
<p>试证明，如果$i \neq j$，那么$P_x \neq P_y$</p>
<ul>
<li>证明过程</li>
</ul>
<p>假设上述定理是不成立的，则$i \neq j$时，$P_x = P_y$</p>
<p>$$
P_x = P_y
$$
$$
(Hash(x) + i^2) \mod ts = (Hash(y) + j^2) \mod ts
$$
$$
(Hash(x) + i^2) \mod ts - (Hash(y) + j^2) \mod ts = 0 \mod ts
$$
$$
(Hash(x) + i^2 - Hash(y) - j^2) \mod ts = 0
$$
$$
[(Hash(x) - Hash(y)) \mod ts + (i^2 - j^2) \mod ts] \mod ts = 0
$$
$$
(i^2 - j^2) \mod ts = 0
$$</p>
<ul>
<li>
<p>因为$i, j &lt; \frac{ts}{2}$，所以$(i^2 - j^2) &lt;= \frac{(ts-1)^2}{4} - \frac{(ts-2)^2}{4} &lt;= \frac{ts}{2} - \frac{3}{4} &lt; ts$</p>
</li>
<li>
<p>因为<code>ts是素数</code>，所以$(i^2 - j^2) = 0$，可得$i=\pm j$</p>
</li>
<li>
<p>因为$0 &lt; i, j$，所以$i = j$</p>
</li>
</ul>
<p>与已知矛盾，故可得当$i \neq j$时，$P_x \neq P_y$。</p>
<p>可证明 <strong>如果使用平方探测，且表的大小是素数，那么当表至少有一半为空的时候，总能够插入一个新的元素</strong></p>
<ul>
<li>额外说明</li>
</ul>
<p>根据 $K^2 \cdot [(ts - 1)^2 - (ts - 2)^2] &lt; ts$可得$ K &lt; \frac{\sqrt{3} \cdot ts}{3}$，<code>i, j</code>更精确的范围是$0 &lt; i, j &lt; \frac{\sqrt{3} \cdot ts}{3}$。</p>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-bdaba29e3bfa272d95d4990643411484">7.4 - 变态跳台阶问题的解题思路</h1>
    
	<p>简介：本文主要记录了 变态跳台阶问题 的推导过程</p>
<h2 id="题目描述">题目描述</h2>
<blockquote>
<p>一只青蛙一次可以跳上1级台阶，也可以跳上2级……它也可以跳上n级。求该青蛙跳上一个n级的台阶总共有多少种跳法。</p>
</blockquote>
<h2 id="解题思路">解题思路</h2>
<h3 id="问题转换">问题转换</h3>
<p>这个问题我们可以转换思路，将其转换成求树的节点0的个数的题目。</p>
<p>假设存在一棵树，它的根节点是N，它的子节点从左往右依次为 n-1, n-2, &hellip; 直到0。</p>
<p>同理，根节点子节点的子节点也遵循这样的规律，0节点没有子节点。请问在这棵树中，0节点一共有多少个？</p>
<p>根节点为3的树如下图所示:</p>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2018-04-08-100136.png" alt=""></p>
<p><strong>从 0 到 3 的路径可以认为是青蛙跳到三阶台阶上的路径，0 的个数就是跳法的个数</strong></p>
<h3 id="答案推导">答案推导</h3>
<p>如上所示，我们已经将问题转换成了求树中0节点的个数，根据树的递归定义，我们可以得到如下的定义:</p>
<ul>
<li>\(f(1) = 1\)</li>
<li>\(f(n) = f(n-1) + f(n-2) + &hellip; + f(1) + 1\)</li>
<li>\(f(n-1) = \space \space \space \space \space \space \space \space \space \space \space \space f(n-2) + &hellip; + f(1) + 1\)</li>
</ul>
<p>令\(f(n) - f(n-1)\)，可得：\(f(n) = 2 * f(n-1)\)。</p>
<p>根据\(f(1) = 1\)和\(f(n) = 2 * f(n-1)\)，我们最终可以得到，\(f(n) = 2^{n-1}\)。</p>
<h3 id="最终答案">最终答案</h3>
<p>有了上面的推导过程，最终的编程实现很简单，我们只需要返回\(2^{n-1}\)即可，答案如下:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#include</span> <span style="color:#8f5902;font-style:italic">&lt;cmath&gt;</span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">Solution</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">public</span><span style="color:#ce5c00;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">jumpFloorII</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">number</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">pow</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">number</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">};</span>
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-a0f39954774aeefe139f67aba0845930">7.5 - Go与数据结构之二叉搜索树</h1>
    
	<p><strong>简介</strong>: 利用Go语言实现二叉搜索树并为其编写单元测试</p>
<h2 id="说明">说明</h2>
<p>本文是我读了<a href="https://book.douban.com/subject/1139426/">《数据结构与算法分析 - C语言描述》</a>后总结的二叉搜索树的实现，在本文中涉及到的代码都可以在我的Github仓库 <a href="https://github.com/bwangel23/LeetCode/tree/daic/4chapter/searchtree">bwangel23/LeetCode</a> 中找到。</p>
<h2 id="描述">描述</h2>
<p>对于二叉树中的任意节点X，它的左子树中所有关键字的值小于X的关键字值，而它的右子树中所有关键字值大于X的关键字值，那么这棵树就是一颗二叉搜索树。这也意味着二叉搜索树中的所有节点都可以按照某种方式来排序。</p>
<p>二叉查找树树的平均深度是$O(log N)$</p>
<h2 id="定义">定义</h2>
<p>通过上面的描述，我们了解了二叉搜索树的概念，接下来我们使用 Go 语言来定义二叉搜索树及其上的操作。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">TreeNode</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">elem</span>  <span style="color:#204a87;font-weight:bold">int</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">left</span>  <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">TreeNode</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">right</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">TreeNode</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">MakeEmpty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">tree</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">TreeNode</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">TreeNode</span> <span style="color:#8f5902;font-style:italic">// 清空一棵树或者创造一棵空树
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">FindMin</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">tree</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">TreeNode</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">TreeNode</span>   <span style="color:#8f5902;font-style:italic">// 查找树中最小的节点
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">FindMax</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">tree</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">TreeNode</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">TreeNode</span>   <span style="color:#8f5902;font-style:italic">// 查找树中最大的节点
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">Find</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">elem</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tree</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">TreeNode</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">TreeNode</span>  <span style="color:#8f5902;font-style:italic">// 查找树中某个特定的节点
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">Insert</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">elem</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tree</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">TreeNode</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">TreeNode</span>  <span style="color:#8f5902;font-style:italic">// 向树中插入节点
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">Delete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">elem</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tree</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">TreeNode</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">TreeNode</span>  <span style="color:#8f5902;font-style:italic">// 从树中删除节点
</span></span></span></code></pre></div><p>从上面的定义中我们可以看到，二叉搜索树中的节点是通过<code>TreeNode</code>结构体来定义的，其中<code>elem</code>表示存储在这个树节点中的关键字值，<code>left</code>和<code>right</code>分别代表左右子树。</p>
<h2 id="实现">实现</h2>
<p>在二叉搜索树上我们一共定义了六个操作，接下来我们分别讨论它们的实现</p>
<h3 id="makeempty">MakeEmpty</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 创造一棵空树，或者将一棵搜索树清空
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">MakeEmpty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">tree</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">TreeNode</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">TreeNode</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">tree</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">MakeEmpty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">tree</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">left</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">tree</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">left</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">MakeEmpty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">tree</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">right</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">tree</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">right</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>MakeEmpty</code>的功能说明:</p>
<ul>
<li>
<p>创建一棵空树: 不像其他一些数据结构中通过一个结构体来定义一棵空树，我们直接通过空指针来定义一棵空树，所以在<code>MakeEmpty</code>尾部我们直接返回了空指针来代表一棵空树。</p>
</li>
<li>
<p>清空一棵树: <code>MakeEmpty</code>函数还可以清空一棵树，由于Go语言中并不需要我们手动管理内存空间，所以删除树节点并不需要释放空间，只需要将指向树节点的指针置为<code>nil</code>即可。</p>
</li>
</ul>
<h3 id="findmin">FindMin</h3>
<p>二叉搜索树的<code>FindMin</code>操作的实现如下所示：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">FindMin</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">tree</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">TreeNode</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">TreeNode</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">tree</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">tree</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">left</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">tree</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">tree</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">left</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">tree</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>这部分功能我们是通过迭代来实现的，由于二叉搜索树中某个树节点的左子树的关键字始终小于这个树节点的关键字值，所以我们只需要一直遍历，找到__最左__的那个树节点，它就是整个树中最小的节点。</p>
<h3 id="findmax">FindMax</h3>
<p>二叉搜索树的<code>FindMax</code>操作的实现如下:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">FindMax</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">tree</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">TreeNode</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">TreeNode</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">tree</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">tree</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">right</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">tree</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">FindMax</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">tree</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">right</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>FindMax</code>的功能我们是通过递归来实现的，从二叉搜索树的特性可知，树节点的右子树中的值始终要比当前节点的值大。所以我们判断只要当前节点有右子树，就去寻找它右子树中的最大值，这样就可以找到二叉搜索树中的最大节点了。</p>
<h3 id="find">Find</h3>
<p>二叉搜索树的<code>Find</code>操作的实现如下:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">Find</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">elem</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tree</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">TreeNode</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">TreeNode</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">tree</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">tree</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">elem</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">elem</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">tree</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">elem</span> <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#000">tree</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">elem</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">Find</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">elem</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tree</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">right</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// 查找节点比当前树节点要小
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">Find</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">elem</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tree</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">left</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>Find</code>操作的功能是通过递归来实现的。判断当前树节点是否是要查找的节点，如果是则返回当前节点。否则，根据目标关键字的值的是否小于当前节点的关键字值分别去当前节点的左子树或右子树中去查找目标节点。</p>
<h3 id="insert">Insert</h3>
<p>二叉搜索树的<code>Insert</code>操作的实现如下:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">Insert</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">elem</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tree</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">TreeNode</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">TreeNode</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">tree</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">tree</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">TreeNode</span><span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">tree</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">left</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">tree</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">right</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">tree</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">elem</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">elem</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">elem</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#000">tree</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">elem</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">tree</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">left</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">Insert</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">elem</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tree</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">left</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">elem</span> <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#000">tree</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">elem</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">tree</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">right</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">Insert</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">elem</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tree</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">right</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// 该节点已经在这颗树中了，我们什么也不做
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">tree</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>从树的根节点开始，判断要插入的值是否比当前节点的要大，如果是的话，插入到当前节点的右子树，否则插入到当前节点的左子树。如果当前节点是一棵空树的话，我们就把目标值插入到当前节点上。</p>
<p><strong>注意</strong>，如果要插入的值已经在树中存在的话，我们什么也不做，我们不会在树中保存两个相同的值。</p>
<h3 id="insert-测试">Insert 测试</h3>
<p>为了验证我们的<code>Insert</code>操作的实现是否正确，我们可以利用 Go 的单元测试来为<code>Insert</code>操作编写测试代码，如下所示:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">TestInsert</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">testing</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">T</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">tree</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">TreeNode</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">tree</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">Insert</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tree</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">tree</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">Insert</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tree</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">tree</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">Insert</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tree</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">tree</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">Insert</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tree</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 构造出来的树
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//    3
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//   / \
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//   1  4
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//    \
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//     2
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">assert</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Equal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">FindMax</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">tree</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">elem</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">assert</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Equal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">FindMin</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">tree</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">elem</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">assert</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Nil</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Find</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tree</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">left</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">assert</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Nil</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Find</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tree</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">right</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>我们按顺序向树中插入<code>3, 4, 2, 1</code>四个节点，最终构造出来的树如下图所示:</p>
<p><strong>树1</strong> <img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2018-03-01-searchtree.png" alt="树1"></p>
<p>为了验证我们构造出来的树是否正确，我们使用<code>FindMax</code>和<code>FindMin</code>方法检验树中的最大值和最小值是否是4和1。
同时，我们也判断了树节点4的左右子树是否都为空。</p>
<h3 id="delete">Delete</h3>
<p>二叉搜索树的删除操作比较复杂，我们需要分情况来讨论:</p>
<ul>
<li>
<p>如果被删除的节点有0个子节点，那我们直接将它删除就好了</p>
</li>
<li>
<p>如果被删除的节点有1个子树，那么我们需要将它的子树移动到当前节点，再将当前节点删除</p>
</li>
</ul>
<p>例如有这样的一棵树2，我们要删除其中的节点3，那么我们需要将其存在的右子树移动到3节点所在的位置，再删除3节点。</p>
<p><strong>树2</strong> <img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2018-03-01-152637.png" alt="树2"></p>
<p>删除3节点后的树如树3所示</p>
<p><strong>树3</strong> <img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2018-03-01-153332.png" alt="树3"></p>
<ul>
<li>如果被删除的节点有两个子树，我们首先要将其右子树中的最小的节点移动到当前节点，然后再删除当前节点。</li>
</ul>
<p>例如上面提到的树2，如果我们要删除2节点，我们首先需要找出其右子树中最小的节点3，将节点3放到节点2所在的位置，如树4所示：</p>
<p><strong>树4</strong> <img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2018-03-01-153658.png" alt="树4"></p>
<p>然后再将原来节点2的右子树中的节点3删除，节点3的删除规则依然准遵循这里讨论的删除规则。由于这里节点3只有一个子树，所以只需要将其右子树移动到节点3所在的位置即可，如树5所示:</p>
<p><strong>树5</strong> <img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2018-03-01-153916.png" alt="树5"></p>
<p>至此，我们就从树2中成功删除了节点2。</p>
<p><code>Delete</code>操作的实现如下所示:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">Delete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">elem</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tree</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">TreeNode</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">TreeNode</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">tree</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatalf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Cannot find element %v in tree %v\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">elem</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tree</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">elem</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#000">tree</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">elem</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">tree</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">left</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">Delete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">elem</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tree</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">left</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">elem</span> <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#000">tree</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">elem</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">tree</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">right</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">Delete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">elem</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tree</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">right</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// 被删除的就是当前节点
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">tree</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">left</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">tree</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">right</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#8f5902;font-style:italic">// 被删除的节点有两个子节点
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#000">tmpNode</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">FindMin</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">tree</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">right</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">tree</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">elem</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">tmpNode</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">elem</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">tree</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">right</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">Delete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">tmpNode</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">elem</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tree</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">right</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#8f5902;font-style:italic">// 被删除的节点有0个或者1个子节点
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">tree</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">left</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">tree</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">tree</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">right</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">tree</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">right</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">tree</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">tree</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">left</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">tree</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">tree</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="delete-测试">Delete 测试</h3>
<p>我为<code>Delete</code>操作编写了两个单元测试，分别测试删除只有有右子树的节点，和删除有两个子树的节点，测试代码如下:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">TestDeleteRight</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">testing</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">T</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">tree</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">TreeNode</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 构造出来的树
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//     6
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//    / \
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//   2  8
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//  /\
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// 1 4
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//   \
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//    5
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">tree</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">Insert</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">6</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tree</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">tree</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">Insert</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tree</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">tree</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">Insert</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tree</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">tree</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">Insert</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tree</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">tree</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">Insert</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tree</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">tree</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">Insert</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tree</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 删除了节点4之后的树
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//     6
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//    / \
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//   2  8
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//  /\
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// 1 5
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">tree</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">Delete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tree</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">assert</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Equal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Find</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tree</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">right</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">elem</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">TestDeleteTwoChild</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">testing</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">T</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">tree</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">TreeNode</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 删除之前的树
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//     6
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//    / \
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//   2  8
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//  /\
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// 1 5
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//  /
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// 3
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// \
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//  4
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">tree</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">Insert</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">6</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tree</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">tree</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">Insert</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tree</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">tree</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">Insert</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tree</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">tree</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">Insert</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tree</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">tree</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">Insert</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tree</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">tree</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">Insert</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tree</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">tree</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">Insert</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tree</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 删除节点2之后的树
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//     6
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//    / \
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//   3  8
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//  /\
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// 1 5
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//  /
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// 4
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">tree</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">Delete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tree</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">node</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">Find</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tree</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">assert</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Equal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">node</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">left</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">elem</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">assert</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Equal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">node</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">right</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">elem</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-9be646f123e40dbca79fc8fe0683405b">7.6 - 算法复杂度小记</h1>
    
	<p>本文主要书写了本人对于算法复杂度的一些理解，并辅以一些例子进行说明</p>
<h2 id="算法复杂度的概念">算法复杂度的概念</h2>
<h3 id="从一个简单的例子入手">从一个简单的例子入手</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">cal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">n</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">sum</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;=</span><span style="color:#000">n</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">sum</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">sum</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">i</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">sum</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>cal</code> 是一个简单的求和函数, 我们将它的执行时间定义为 \( T(n) \) 。从 CPU 的角度来看，每一行代码都执行着类似的操作 <strong>读数据 - 运算 - 写数据</strong> 。</p>
<p>尽管每行代码编译出来的汇编代码都是不同的(汇编指令的个数也不同)，执行时间也都不一样。但我们这里只是粗略估计，为了简单起见，我们将每一行的代码的执行时间都定义为 <code>unit_time</code>。</p>
<p>第 2, 3 行只执行需要一个 <code>unit_time</code>， 第4, 5行需要执行 N 个 <code>unit_time</code>, 可以得到</p>
<p>$$ T(n) = unit\_time * (1 + 1 + n + n) = unit\_time * (2n + 2) $$</p>
<p><strong>上述分析中，我们忽略了调用函数时入参和返回参数所需的时间</strong></p>
<p>定义 \( f(n) = 2n+2 \)，由于 <code>unit_time</code> 始终都是一个正数，<strong>我们可以得出 <code>cal</code> 函数的执行时间 \( T(n) \) 和每行代码的执行次数 \( f(n) \) 成正比</strong></p>
<p>以上关系我们可以用 字母 <code>O</code> 来表示:</p>
<ul>
<li>\( T(n) = O(f(n)) ，即代码的执行时间 T(n) 和 某个函数 f(n) 成正比。\)</li>
</ul>
<p>但是准确计算某个函数共有多少行代码需要执行，这也是一个困难的工作，我们可以将 <code>O</code> 的定义进一步精确。</p>
<ul>
<li>\( T(n) = O(f(n)) \)，代码的执行时间随着数据规模(<code>n</code>)增长的 <strong>增长趋势</strong>。所以，<code>O</code> 也叫做渐进时间复杂度( asymptotic time complexity)，简称时间复杂度。</li>
</ul>
<h3 id="复杂度的计算理念">复杂度的计算理念</h3>
<ul>
<li>我们不对某个算法进行精确的分析，只需要初略地知道它的 <strong>增长趋势</strong> 就可以了。</li>
<li>平常我们分析算法复杂度的时候，通常有分析最坏情况和平均情况两种选项，由于最坏情况易于分析，所以我们一般分析算法复杂度的最坏情况。</li>
</ul>
<h3 id="复杂度的渐进表示法">复杂度的渐进表示法</h3>
<ul>
<li>上界</li>
</ul>
<p>$$ T(n) = O(f(n)) $$</p>
<p>上述式子表示当N足够大的时候，<code>f(n)</code>函数是<code>T(n)</code>的上界。</p>
<ul>
<li>下界</li>
</ul>
<p>$$ T(n) = \Omega(h(n)) $$</p>
<p>上述式子表示当N足够大的时候，<code>h(n)</code>函数是<code>T(n)</code>的下界。</p>
<ul>
<li>上界和下界同时成立</li>
</ul>
<p>$$ T(n) = \Theta(g(n)) $$</p>
<p>上述式子表示当N足够大的时候，<code>g(n)</code>函数同时是<code>T(n)</code>的上界和下界。</p>
<ul>
<li>在上面三个式子中，<code>T(n)</code>表示的都是某个算法的时间复杂度，它们也可以应用在算法的空间复杂度<code>S(n)</code>上。</li>
<li>一个算法的上界和下界函数可能有无穷多个，为了和现实的情况更贴合，我们在使用上述式子表示算法的复杂度的时候，通常使用 <strong>最小的上界</strong> 和 <strong>最大的下界</strong> 。</li>
</ul>
<h3 id="复杂度的增长趋势比较">复杂度的增长趋势比较</h3>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2022-08-28-073000.png" alt=""></p>
<p>$$ O(1) &lt;  O(\log n) &lt; O(n) &lt; O(n \log n) &lt; O(n^2) &lt; O(n^3) &lt; O(2^n) &lt; O(n!) $$</p>
<p>上面的复杂度量级，我们可以粗略地分成两类， 多项式量级和非多项式量级。其中，非多项式量级只有两个：指数阶 \( O(2^n) \) 和 阶乘阶 \( O(n!) \)</p>
<p>我们把时间复杂度为非多项式量级的算法问题叫做 NP (Non-Deterministic Polynomial，非确定多项式) 问题。</p>
<h2 id="算法复杂度的分析规则">算法复杂度的分析规则</h2>
<h3 id="加法法则">加法法则</h3>
<p><strong>多个复杂度相加，取量级最大的时间复杂度</strong>，这个规则用公式表示为:</p>
<p>$$ T_1(n) = O(f_1(n)), T_2(n) = O(f_2(n)) $$</p>
<p>$$ T_1(n) + T_2(n) = max(O(f_1(n)), O(f_2(n))) $$</p>
<p>由于我们分析算法复杂度的时候主要是分析它的 <strong>增长趋势</strong> ，所以我们只需要分析算法复杂度的 <strong>某个主要趋势</strong> 即可。</p>
<p>有时间复杂度计算公式，</p>
<p>$$ T(n) = O(C_1 * n^2 + C_2 * n) $$</p>
<p>\( 在N进行增长的时候，n^2 对于 T(n) 增长的影响是远远大于 n 的，所以我们就可以忽略掉 n ，认为 T(n) = O(C_1 * n^2) \)，
常数项量级也可以忽略掉，最终为</p>
<p>$$ T(n) = O(n^2) $$</p>
<ul>
<li>即当 <code>n</code> 很大的时候，\( n^2 为 T(n) 的上界函数。\)</li>
<li>即随着 <code>n</code> 的增长，某个算法所用的时间 \( T(n) \) 的 <strong>增长趋势</strong> 是 \( n^2 \)</li>
</ul>
<p>\( 总结可得，当 T(n) 是关于n的k阶多项式的时候， T(n) = O(n^k) \)</p>
<p>分析代码时，可以得出:</p>
<pre tabindex="0"><code>一个if-else的复杂度 = max(条件判断式的复杂度，if分支的复杂度，else分支的复杂度)
</code></pre><h3 id="忽略常数项">忽略常数项</h3>
<p>当我们谈论时间复杂度 \( \log N \) 的时候，我们并没有说明 \( \log N \) 是以2，以10还是以<code>e</code>为底的。</p>
<p>这是因为当N很大的时候，\( \log_{2} N  和  \log_{10} N \) 它们之间相差了常数倍。</p>
<p>$$ log_2N = log_{10}N * log_2 10 $$</p>
<p>其中 \( \log_2 10 \) 是一个常数</p>
<p>\( \log N \)的增长趋势是大于常数的增长趋势的，所以我们可以忽略掉底数的差异，直接以\( \log N \) 代指一种增长趋势。</p>
<h3 id="乘法法则">乘法法则</h3>
<p><strong>嵌套代码的复杂度等一嵌套内外代码复杂度的乘积</strong>，这个规则用公式表示为</p>
<p>$$ T_1(n) = O(f_1(n)), T_2(n) = O(f_2(n)) $$</p>
<p>$$ T_1(n) * T_2(n) = O(f_1(n) * f_2(n)) $$</p>
<p>我们先看一段代码:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">cal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">n</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>   <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">ret</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">n</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>     <span style="color:#000">ret</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ret</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">f</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>   <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span> <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">f</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">n</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">sum</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">n</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">sum</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">sum</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">i</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">sum</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span> <span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>cal</code> 函数除了5行，其他地方的时间复杂度是 \( O(n) \), <code>f</code> 函数的时间复杂度是 \( O(n) \)
整个 <code>cal</code> 函数的时间复杂度就是</p>

<div class="math">$$T(n) = T1(n) * T2(n) = O(n*n) = O(n^2)$$</div><p>分析代码时，可得:</p>
<pre tabindex="0"><code>一个for循环的复杂度 = 循环体的复杂度 * 循环次数
</code></pre><h2 id="空间复杂度">空间复杂度</h2>
<p>上文说到, 时间复杂度的全称是 <strong>渐进时间复杂度，表示算法的执行时间与数据规模之间的增长关系</strong>。</p>
<p>类比一下，空间复杂度的全称就是 <strong>渐进空间复杂度 (asymptotic space complexity)，表示算法的存储空间和数据规模之间的增长关系。</strong></p>
<p>先看一段简单的代码</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">n</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">[]</span> <span style="color:#000">a</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">new</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">n</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">a</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">i</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">n</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&gt;=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#ce5c00;font-weight:bold">--</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">print</span> <span style="color:#000">out</span> <span style="color:#000">a</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>上述代码中，第二行申请了一个固定大小的内存空间，第三行申请了一个大小为 n 的 int 类型的数组，其他行都没有申请内存空间，我们可以忽略。</p>
<p>所以整段代码的空间复杂度就是 \( O(n) \)</p>
<p><strong>我们常见的空间复杂度就是 \( O(1), O(n), O(n^2) \)，像 \( O(logn), O(nlogn) \) 这样的对数阶复杂度平时都用不到</strong>。</p>
<h2 id="参考资料">参考资料</h2>
<ul>
<li>极客时间 《数据结构与算法之美》</li>
<li><a href="https://www.icourse163.org/course/ZJU-93001">浙江大学《数据结构》公开课</a></li>
</ul>
</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-b5fadaa3f5f96e8c51757851d7668a4e">8 - Redis</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-452fe98fe10bf583ed0509083a6fa631">8.1 - Redis 备份恢复的正确步骤</h1>
    
	<hr>
<h2 id="tips">Tips</h2>
<ol start="0">
<li>清空数据目录下的 dump.rdb 和 appendonly.aof 文件</li>
<li>将备份的 rdb 文件拷贝到 redis 的数据目录下 (<code>dir</code>选项配置了数据目录)</li>
<li>修改配置文件，设置 <code>appendonly no</code></li>
<li>启动 redis-server</li>
<li>通过 redis-cli 开启 appendonly 备份: <code>CONFIG SET appendonly yes</code></li>
<li>同时修改配置文件，开启 aof 备份</li>
</ol>
<h2 id="注意">注意</h2>
<p>必须要关闭 appendonly 后，rdb 备份才能正确回复，否则恢复出来的数据是空的</p>
<h2 id="原因">原因</h2>
<p>redis server 启动后会生成 appendonly.aof 文件，在 dump.rdb 和 appendonly.aof 文件同时存在的时候，会优先恢复 appendonly.aof 文件，由于 appendonly.aof 是空的，redis server 中的数据也会变成空的。</p>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-9f184c796063902888d119a9e9dbf239">8.2 - Redis 主从同步细节</h1>
    
	<blockquote>
<p>介绍了 Redis 的主从同步流程及一些配置选项</p>
</blockquote>
<hr>
<h2 id="完整的复制流程">完整的复制流程</h2>
<ol>
<li>slave 启动，获取 master 节点的信息，包括 (master run_id)</li>
<li>如果 slave 中可以找到此 master 的数据，发送 <code>PSYNC {master run id} {slave offset}</code> 指令给 master，请求开始部分复制。</li>
<li>如果 slave 找不到 master 的数据，发送 <code>PSYNC ? -1</code> 指令给 master，请求全量复制。</li>
<li>口令认证，如果 master 设置了 <code>requirepass</code>，slave 节点必须发送 <code>masterauth</code> 设置的口令去认证</li>
<li>master node 执行一次全量复制/部分复制，将数据同步到 slave 上。</li>
<li>master node 后续持续将写命令，异步地发送给 slave，同时会将命令写入到先进先出的队列 backlog 中</li>
</ol>
<p>主从复制的流程图如下</p>
<p><img src="https://passage-1253400711.cos-website.ap-beijing.myqcloud.com/2021-10-22-143417.png" alt=""></p>
<h2 id="复制过程中的参数说明">复制过程中的参数说明</h2>
<ul>
<li>offset (复制偏移量)</li>
</ul>
<p>master 和  slave 都会维护一个累加的 offset，master 还会维护每个 slave 的offset，用于沟通数据的差异。</p>
<p><code>role</code>命令可以查看复制偏移量</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># master role</span>
</span></span><span style="display:flex;"><span>127.0.0.1:6379&gt; role
</span></span><span style="display:flex;"><span>1<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;master&#34;</span>  <span style="color:#8f5902;font-style:italic"># 服务器的角色</span>
</span></span><span style="display:flex;"><span>2<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">(</span>integer<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#0000cf;font-weight:bold">98</span>  <span style="color:#8f5902;font-style:italic"># master 的复制偏移量</span>
</span></span><span style="display:flex;"><span>3<span style="color:#ce5c00;font-weight:bold">)</span> 1<span style="color:#ce5c00;font-weight:bold">)</span> 1<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;127.0.0.1&#34;</span>  <span style="color:#8f5902;font-style:italic"># slave host</span>
</span></span><span style="display:flex;"><span>      2<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;6380&#34;</span>   <span style="color:#8f5902;font-style:italic"># slave port</span>
</span></span><span style="display:flex;"><span>      3<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;98&#34;</span>     <span style="color:#8f5902;font-style:italic"># slave 的复制偏移量</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># slave role</span>
</span></span><span style="display:flex;"><span>127.0.0.1:6380&gt; role
</span></span><span style="display:flex;"><span>1<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;slave&#34;</span>  <span style="color:#8f5902;font-style:italic"># 服务器的角色</span>
</span></span><span style="display:flex;"><span>2<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;localhost&#34;</span>  <span style="color:#8f5902;font-style:italic"># master host</span>
</span></span><span style="display:flex;"><span>3<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">(</span>integer<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#0000cf;font-weight:bold">6379</span>  <span style="color:#8f5902;font-style:italic"># master port</span>
</span></span><span style="display:flex;"><span>4<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;connected&#34;</span>  <span style="color:#8f5902;font-style:italic"># 和 master 的连接状态</span>
</span></span><span style="display:flex;"><span>5<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">(</span>integer<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#0000cf;font-weight:bold">112</span>  <span style="color:#8f5902;font-style:italic"># slave 的复制偏移量</span>
</span></span></code></pre></div><p>连接状态有以下几种值:</p>
<table>
<thead>
<tr>
<th>状态</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>&ldquo;none&rdquo;</td>
<td>主从服务器尚未建立连接</td>
</tr>
<tr>
<td>&ldquo;connect&rdquo;</td>
<td>主从服务器正在握手。</td>
</tr>
<tr>
<td>&ldquo;connecting&rdquo;</td>
<td>主从服务器成功建立了连接。</td>
</tr>
<tr>
<td>&ldquo;sync&rdquo;</td>
<td>主从服务器正在进行数据同步。</td>
</tr>
<tr>
<td>&ldquo;connected&rdquo;</td>
<td>主从服务器已经进入在线更新状态。</td>
</tr>
<tr>
<td>&ldquo;unknown&rdquo;</td>
<td>主从服务器连接状态未知。</td>
</tr>
</tbody>
</table>
<ul>
<li>run id</li>
</ul>
<p>master run id 发生变化时， slave 会重新做全量复制</p>
<p>使用 <code>info server</code> 可以查看当前 Redis Server 的 run id</p>
<h3 id="full-resynchronization-全量复制">Full Resynchronization (全量复制)</h3>
<ol>
<li>master 执行 bgsave，用子进程生成 rdb 快照文件</li>
<li>master 生成快照文件的同时会将随后的操作指令写在内存缓存中</li>
<li>master 将 rdb 文件发送给 slave node，如果发送时间超过 <code>repl-timeout</code> （默认是 60s），那么 slave node 就会认为复制失败，可以适当调大这个参数.</li>
<li><code>client-output-buffer-limit slave 256M 64M 60</code>，如果在复制过程中，内存缓存区持续消耗超过 64M，或一次性超过 256M，那么停止复制，复制失败。</li>
<li>slave 将 rdb 文件落盘</li>
<li>slave 从 rdb 文件恢复数据，恢复的同时基于旧数据 serve</li>
<li>如果 slave 开启了 aof 备份，那么恢复成功后会立即执行 BGREWRITEAOF，重写 AOF</li>
<li>master 在 slave 恢复成功后将内存缓存的操作指令发送给 slave</li>
</ol>
<blockquote>
<p><strong>在数据同步时复用 rdb 文件</strong></p>
<ol>
<li>如果 master 在收到 replicaof 指令之前已经执行过一次 bgsave 命令，且数据库在执行 bgsave 之后没有任何变化，那么 master 将会直接向 slave 发送已经生成的 rdb 文件</li>
<li>如果 master 在生成 rdb 文件期间，又有多个 slave 请求同步数据，那么 master 会把请求同步的 slave 全部放到队列中，等 rdb 文件生成后，一起发送给队列中的所有 slave</li>
</ol>
</blockquote>
<h2 id="在线更新">在线更新</h2>
<p>master 和 slave 执行完全量复制后，</p>
<ol>
<li>master 会将收到的写指令发送给 slave 执行，让两边数据同步</li>
<li>master 对每个 slave 都会维护一个先进先出的队列，存储 slave 收到的写指令。可以通过 <code>repl-backlog-size</code> 设置这个队列的大小</li>
</ol>
<h2 id="部分复制-partial-resynchronization">部分复制 (partial resynchronization)</h2>
<ol start="0">
<li>在 redis 2.8 之前，如果 slave 断开连接后又重新建立连接，slave 会请求重新执行一次全量同步，这样非常浪费资源</li>
<li>redis 2.8 之后，添加了部分复制的功能</li>
<li>第一次全量复制完成后，master 每次向 slave 发送的指令都会存储到 backlog 中</li>
<li>如果 slave 因为网络原因短暂地断开了连接， slave 重新连接后会发送 replica offset 到 master 中</li>
<li>master 如果在 backlog 中找到了 replica offset，master 会将 backlog 中存储的剩余数据发送过来。</li>
<li>如果找不到，master 会开始进行全量复制</li>
</ol>
<blockquote>
<p>backlog 的容量越大，master 所能容忍的 slave 断线时间也就越长，可以通过 <code>repl-backlog-size</code> 选项更改 backlog 的大小。</p>
</blockquote>
<h2 id="无盘化复制">无盘化复制</h2>
<p>两个相关选项:</p>
<ul>
<li>repl-diskless-sync</li>
</ul>
<p>开启此选项后，rdb 文件在 master 上不会落盘，会直接发送给 slave，slave 上还是会进行落盘，redis 目前无法做到完全不依靠硬盘实现主从复制。</p>
<ul>
<li>repl-diskless-sync-delay</li>
</ul>
<p>开启无盘化复制后，新的 Slave 无法复用之前已经开始的复制任务，只能等待新的复制任务。<code>repl-diskless-sync-delay</code> 设置复制任务在收到 Slave 的请求多久后开始，以等待更多的 Slave 连接，一起发送 rdb 数据。</p>
<h2 id="降低数据不一致出现的概率">降低数据不一致出现的概率</h2>
<h3 id="因-master-挂掉出现数据不一致">因 master 挂掉出现数据不一致</h3>
<ol>
<li>master 将数据同步到 slave 是异步进行的，如果 master 还有部分数据未同步，就挂掉了。哨兵发现 master 不正常，及时切换了 master，但旧 master 中未同步的数据就会丢失掉了。</li>
<li>设置 <code>min-slaves-max-lag 10</code> 选项，表示如果超过10秒 slave 没有和 master 通信过，master 就认为 slave 和自己的数据差别太大，不再接收写操作。这样 master 挂掉后可以少丢失一些数据。</li>
</ol>
<h3 id="因集群脑裂出现数据不一致">因集群脑裂出现数据不一致</h3>
<ol>
<li>因为网络原因，集群短暂地分裂成两个，两个 master 都接收数据。网络恢复后，节点少的 master 会重新变成 slave，此时这个 master 上写的数据就会丢失。</li>
<li>设置 <code>min-slaves-to-write 3</code> 选项，表示如果 slave 个数小于3，master 就不再接收写操作，小集群的 master 不写数据，集群恢复后，也不会造成数据丢失。</li>
</ol>
<h2 id="过期-key-处理">过期 key 处理</h2>
<p>如果设置了 <code>slave-read-only=yes</code>， Slave 不会主动过期 key，master 在将 key 过期后，会发送 DEL 指令给 Slave</p>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-f69785f60caf73840045abeb86206c30">8.3 - Redis 备份机制</h1>
    
	<hr>
<h2 id="redis-的-aof-和-rdb-备份机制">Redis 的 AOF 和 RDB 备份机制</h2>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com//2021-02-19-224253.png" alt="RDB 和 AOF 介绍"></p>
<p>RDB 比 AOF 恢复要快</p>
<ul>
<li>AOF 存储的是写入指令，它恢复是重放写入指令。</li>
<li>RDB 恢复时是将文件直接写入内存，恢复速度更快。</li>
</ul>
<p>RDB 是定时备份，AOF 的每条操作都会写入磁盘(中间有 linux 系统缓存, fsync 会同步系统缓存到磁盘中)，故 RDB 的写入速度要比 AOF 要高。</p>
<p>如果 AOF 和 RDB 备份都存在，那么 redis 优先会从 AOF 恢复数据文件。</p>
<h3 id="rdb-备份">RDB 备份</h3>
<p>配置文件中设置:</p>
<p>每条 save 是一个检查点，每隔 <code>&lt;seconds&gt;</code> 秒，检查是否有至少 <code>&lt;changes&gt;</code> 个key 发生了变化，如果有的话就执行一次备份。</p>
<pre tabindex="0"><code># save &lt;seconds&gt; &lt;changes&gt;
save 900 1
save 300 10
save 60 10000
</code></pre><p>RDB 持久化的工作流程:</p>
<ol>
<li>redis 根据配置的检查点，尝试去生成 rdb 快照文件</li>
<li>redis fork 一个子进程出来</li>
<li>子进程尝试将数据 dump 到 rdb 快照文件中</li>
<li>完成 rdb 文件的 dump 后，就用新文件替换掉之前的旧文件</li>
</ol>
<p>如果是通过 <code>redis-cli shutdown</code> 的方式来关闭 redis server 的话，redis server 会在关闭之前会同步一次 rdb 文件。</p>
<h3 id="aof-备份">AOF 备份</h3>
<p>配置:</p>
<p><code>appendfsync</code> 表示多长时间执行一次 <code>fsync</code> 系统调用，将 os cache 数据写入到磁盘中，默认是 everysec，每秒写一次。</p>
<p>AOF ReWrite 过程:</p>
<ol>
<li>redis fork 一个子进程</li>
<li>子进程基于当前内存中的数据，构建日志，开始往一个新的临时的 aof 文件中写入日志</li>
<li>redis 主进程，接收到 client 端的写操作之后，
<ol>
<li>往旧的 aof 文件中写日志</li>
<li>开辟一个新的内存区域，在其中写入日志</li>
</ol>
</li>
<li>子进程写完新的日志文件之后，redis 主进程会将内存区域中的新日志再次追加到新的 aof 文件之中</li>
<li>用新的日志文件，替换掉旧的日志文件</li>
</ol>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-0bff432c35e390c24fb8a4000eb1827a">8.4 - Redis 集群简介</h1>
    
	<hr>
<h2 id="为什么要有-redis-集群">为什么要有 Redis 集群</h2>
<p>redis 单机最多只能支持 1万 到 几万不等的 QPS (根据操作的不同 serve 能力也不同)。如果我们想要支撑更高的 QPS，就需要配置 Redis 集群。</p>
<h2 id="redis-集群是为了解决什么问题">Redis 集群是为了解决什么问题</h2>
<p>Redis 集群可以通过读写分离的设置，支持大规模读多写少的操作场景( QPS 达到百万级)。写多的操作场景单纯配置 Redis 集群是无法支持的，我们还需要更改客户端实现，像 kafka 客户端一样通过队列合并写入操作。</p>
<h2 id="redis-replication-是如何工作的">Redis Replication 是如何工作的</h2>
<p><img src="https://tva1.sinaimg.cn/large/008i3skNly1gvnd81kfq3j60er0dhjs002.jpg" alt=""></p>
<p>Redis 集群的架构图如上所示。</p>
<ul>
<li>Client 将数据写入到 Master 节点后就立刻返回了，Slave 节点从 Master 同步数据过来，Client 不会确认数据是否同步到了 Slave 节点中。</li>
<li>2.8 以后， Slave 会周期性地确认自己复制的数据量</li>
<li>Slave 节点也可以连接其他 Slave 节点</li>
<li>Slave 节点做复制的时候，不会阻塞 Master 节点，也不会阻塞自己，它会用旧的数据集 Serve，当复制完成时，会删除旧的数据集，加载新的数据集，此时会短暂地停止对外服务。(时间在毫秒到秒之间)</li>
<li>Slave 节点主要应用在读多写少场景下的读写分离操作上，扩容 Slave，可以提高集群的 <strong>读</strong> 吞吐量。</li>
</ul>
<h2 id="redis-集群数据备份的配置">Redis 集群数据备份的配置</h2>
<p>Redis 集群做持久化的时候，需要配置 Master 节点的持久化。因为以下原因：</p>
<p>假设我们配置了 Slave 节点的持久化，而没有配置 Master 节点。当 Master 节点宕机重启后，它会直接认为自己的数据是空的，同时将这个状态同步到 Slave，从而导致集群的数据消失。</p>
<p>尽管 Master 挂掉以后，Sentinel 会切换 Master，但这有时间成本，如果在 Sentinel 发现之前 Master 就重启了，一样会造成数据丢失。</p>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-5e80ba3bff85aef5c731bcf3ecb0922c">8.5 - Redis 源码阅读之 dict </h1>
    
	<p>本文主要介绍了 Redis 的基础数据结构 dict 的实现，并描述了其渐进式 rehash 的操作</p>
<p><strong>注意</strong>: 本文基于 Redis 3.0.0 的代码进行分析的</p>
<h2 id="dict-介绍">dict 介绍</h2>
<p>dict 又称符号表(symbol table)，关联数组(associative array)或映射(map)，是一种用于保存键值对的抽象数据结构。</p>
<p>Redis 实现使用的C语言并没有内置 dict 这种数据类型，所以 Redis 实现了自己的 dict。dict 在 Redis 中有广泛的应用，Redis 数据库的底层就是使用字典来实现的，也就是说对数据库的增，删，改，查都是建立在字典之上的。同时，字典也是<code>hash</code>和<code>sorted set</code>等数据结构的底层实现之一。</p>
<h2 id="dict-的实现">dict 的实现</h2>
<p>在 Redis 中，dict 的代码存放在<code>src/dict.c</code>和<code>src/dict.h</code>两个文件中。在<code>src/dict.h</code>中定义了 dict 所用到的结构体，一共有四个:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 哈希表项
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">typedef</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">dictEntry</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">union</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">val</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">uint64_t</span> <span style="color:#000">u64</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">int64_t</span> <span style="color:#000">s64</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">double</span> <span style="color:#000">d</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">v</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">dictEntry</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">next</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// 哈希表中是通过单链表解决键索引冲突的，next用来指向同一个键索引下的下一个元素
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">dictEntry</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 这里的思想类似于Go，使用函数来定义字典类型(接口)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">typedef</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">dictType</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">hashFunction</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">keyDup</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">privdata</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">valDup</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">privdata</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">obj</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">keyCompare</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">privdata</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">key1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">key2</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">keyDestructor</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">privdata</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">valDestructor</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">privdata</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">obj</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">dictType</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">/* 哈希表结构体，每个字典都有两个哈希表，其中多的一个用来做渐进式 rehash */</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">typedef</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">dictht</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">dictEntry</span> <span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#000">table</span><span style="color:#000;font-weight:bold">;</span>       <span style="color:#8f5902;font-style:italic">// 哈希表项组成的数组
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">size</span><span style="color:#000;font-weight:bold">;</span>      <span style="color:#8f5902;font-style:italic">// 当前哈希表的大小
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">sizemask</span><span style="color:#000;font-weight:bold">;</span>  <span style="color:#8f5902;font-style:italic">// 哈希表大小的掩码，总是等于size - 1
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">used</span><span style="color:#000;font-weight:bold">;</span>      <span style="color:#8f5902;font-style:italic">// 哈希表中哈希表项的数目
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">dictht</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">/* 字典的定义 */</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">typedef</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">dict</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">dictType</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">type</span><span style="color:#000;font-weight:bold">;</span>  <span style="color:#8f5902;font-style:italic">// 字典的类型
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">privdata</span><span style="color:#000;font-weight:bold">;</span>  <span style="color:#8f5902;font-style:italic">// 字典私有数据
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">dictht</span> <span style="color:#000">ht</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">];</span>    <span style="color:#8f5902;font-style:italic">// 字典中的哈希表
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">rehashidx</span><span style="color:#000;font-weight:bold">;</span>  <span style="color:#8f5902;font-style:italic">// rehashidx == -1 表示当前字典没有做 rehash，否则表示当前字典正在进行 rehash 操作
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">iterators</span><span style="color:#000;font-weight:bold">;</span>   <span style="color:#8f5902;font-style:italic">// 安全迭代器的数量
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">dict</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">/*
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 字典迭代器用来获取字典中所有的项，其中迭代器可以分为安全迭代器和非安全迭代器两种
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 安全迭代器表示在迭代过程中可以调用字典的 dictAdd(), dictFind() 等接口
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 非安全迭代器在迭代过程中只能调用 dictNext() 接口
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * */</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">typedef</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">dictIterator</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">dict</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">;</span>             <span style="color:#8f5902;font-style:italic">// 迭代器所关联的字典
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">index</span><span style="color:#000;font-weight:bold">;</span>          <span style="color:#8f5902;font-style:italic">// 当前迭代器在字典中迭代的索引
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">table</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">safe</span><span style="color:#000;font-weight:bold">;</span>     <span style="color:#8f5902;font-style:italic">// 哈希表的索引，当前迭代器是否是安全迭代器
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">dictEntry</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">entry</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">nextEntry</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// 当前迭代器所指向的哈希表项和下一个哈希表项
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">/* unsafe iterator fingerprint for misuse detection. */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">fingerprint</span><span style="color:#000;font-weight:bold">;</span>  <span style="color:#8f5902;font-style:italic">// 字典的指纹，非安全迭代器中用于鉴别字典是否被修改过
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">dictIterator</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><p>他们之间的关系如图1所示:</p>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2018-03-10-054715.png" alt="图1"></p>
<p><strong>图1</strong></p>
<p>当我们向字典中存储键值对(k, v)时，字典通过一定的算法计算出k的索引值，它的计算方法如下:</p>
<pre tabindex="0"><code># 先根据哈希算法计算出键k的哈希值，哈希值为unsigned int 类型
hash = d-&gt;type-&gt;hashFunction(k)
# 然后再将哈希值和哈希表的sizemask按位与，获得键k在哈希表中的索引
idx = hash &amp; d-&gt;ht[table].sizemask
</code></pre><p>最后按照计算出来的索引值将键值对存储到字典中的哈希表中。</p>
<h2 id="dict-的哈希算法">dict 的哈希算法</h2>
<p>dict 按照使用方式的不同，所采取的哈希算法也不同。Redis目前共使用两种不同的哈希算法：</p>
<ol>
<li>MurmurHash2 32 bit 算法：这种算法的分布率和速度都非常好， 具体信息请参考 MurmurHash 的主页： <a href="http://code.google.com/p/smhasher/">http://code.google.com/p/smhasher/</a> 。</li>
<li>基于 djb 算法实现的一个大小写无关散列算法：具体信息请参考 <a href="http://www.cse.yorku.ca/~oz/hash.html">http://www.cse.yorku.ca/~oz/hash.html</a> 。</li>
</ol>
<ul>
<li>dict 在命令表以及 Lua 脚本缓存中时，使用了算法2</li>
<li>dict 在数据库，集群，哈希键和阻塞操作等功能中都使用到了算法1</li>
</ul>
<h2 id="dict-解决键冲突的方案">dict 解决键冲突的方案</h2>
<p>根据前面的内容所知，向dict中添加键值对时，dict根据键计算出来的索引值将键值对存储到哈希表中。由于哈希表的大小是有限的，所以可能会出现两个键的索引值相同的情况，这种情况也称作键冲突。</p>
<p>当出现键冲突的时候，dict会将两个键值对存放在同一个哈希表的同一个索引下，它们通过单链表的形式组合起来，如图2所示：</p>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2018-03-13-155621.jpg" alt="图2"></p>
<p><strong>图2</strong></p>
<p>其中k1和k2计算出来的索引值是相同的，他们被存放到哈希表的同一个索引下，然后通过单链表的形式组合起来。</p>
<p>在 <code>src/dict.c</code>的<code>dictEntry *dictAddRaw(dict *d, void *key)</code>函数中，我们可以看到向单链表中添加元素的过程</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">/* 哈希表通过单链表来解决键冲突，下面的代码向单链表中添加了哈希表节点 */</span>
</span></span><span style="display:flex;"><span><span style="color:#000">entry</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">zmalloc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">entry</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span><span style="color:#000">entry</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">next</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ht</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">table</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">index</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span><span style="color:#000">ht</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">table</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">index</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">entry</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">ht</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">used</span><span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><p>申请一个哈希表项之后，将它的地址存放在哈希表中，同时也使哈希表中原来存在的节点变成它的next节点，即新增元素在单链表的头部。</p>
<h2 id="渐进式-rehash">渐进式 rehash</h2>
<p>每个dict都有一个负载因子，计算方式如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000">load_factor</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ht</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">used</span> <span style="color:#ce5c00;font-weight:bold">/</span> <span style="color:#000">ht</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">size</span>
</span></span></code></pre></div><p>当 dict 的负载因子过大或过小的时候，Redis 需要为这个 dict 扩展或者收缩哈希表的大小，这个过程叫做 rehash。上文中我们提到每个 dict 都有两个哈希表, <code>ht0</code>和<code>ht1</code>，在这里它们就发挥作用了。rehash 的具体操作如下:</p>
<ol>
<li>
<p>设置<code>ht1</code>的size，扩展过程中size为大于<code>ht0.size</code>的最小2次幂，收缩过程中size为大于<code>ht0.used</code>的最小2次幂</p>
</li>
<li>
<p>将 dict.rehashidx 设置为0</p>
</li>
<li>
<p>在增删改查的过程中，检查 dict.rehashidx 是否不等于 -1，如果是，那么就执行<code>_dictRehashStep</code>操作，<code>_dictRehashStep</code>的操作如下:</p>
<ul>
<li>如果当前字典上的没有安全迭代器，执行<code>dictRehash</code>操作</li>
<li><code>dictRehash</code>操作就是从<code>ht0</code>中取出值，重新计算哈希值，然后放到<code>ht1</code>中，并将<code>ht0.used</code>减少。将<code>dict.rehashidx</code>的索引加1。由于在这个过程中重新计算了 key 的哈希值，所以这个过程称为 <strong>rehash</strong></li>
<li>如果<code>ht0</code>中的所有元素都复制到了<code>ht1</code>中后，Redis 会交换<code>ht1</code>和<code>ht0</code>的地址，然后将<code>ht1</code>置为空表(即存在dictht这个结构体变量，但是里面的dictEntry指针为空，没有任何哈希表项)，同时将<code>dict.rehashidx</code>置为 -1。</li>
<li>同时<code>dictRehash</code>还有一个限制，每次 rehash 的时候存在一个 <code>empty_visits</code> 限制(empty_visits = 10 * n，n是本次<code>dictRehash</code>操作要 rehash 哈希表项的数量)。如果访问到的空的哈希表项的次数超过了<code>empty_visits</code>，本次 rehash 操作就结束了。</li>
</ul>
</li>
</ol>
<ul>
<li>
<p>由于 rehash 操作不是一次性做完的，而是在字典的操作中一点一点做的，所以这个过程称作__渐进式rehash__</p>
</li>
<li>
<p>因为在字典的增删改查操作中执行了 rehash 操作，所以这些操作的行为也会受到影响</p>
<ul>
<li>在<code>dictAdd</code>操作中，如果当前字典正在进行 rehash，那么新加的值都会加入到<code>ht1</code>中，这样保证<code>ht0</code>只会减少，不会增加，最终<code>ht0</code>会变成空表</li>
<li>在<code>dictFind</code>操作中，会在<code>ht0</code>和<code>ht1</code>两个哈希表中查询对应的键</li>
<li>在<code>dictDelete</code>操作中也回在<code>ht0</code>和<code>ht1</code>中查找对应的键</li>
<li><code>dictReplace</code>操作调用的是<code>dictFind</code>方法查找对应的键</li>
</ul>
</li>
<li>
<p>在执行 BGSAVE 和 BGREWRITEAOF 命令时，Redis 会提高字典的负载因子。因为在调用这两个命令时，Redis 会为当前进程产生子进程，而很多操作系统采用了写时复制的策略，如果不执行 rehash 操作，会避免不必要的内存写入操作，从而节省一些内存。</p>
</li>
</ul>
<h2 id="字典迭代器和-rehash-的关系">字典迭代器和 rehash 的关系</h2>
<p>在渐进式 rehash 一小节中我们提到，当字典的安全迭代器的数量为0的时候，才会执行 rehash 操作，这是为什么呢？</p>
<p>首先我们可以分析一下字典迭代器的迭代操作，它可以用如下的伪代码来表示:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">iter_dict</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">dict</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># 迭代0号哈希表</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">iter_table</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ht</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">table</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># 如果正在进行 rehash 的话，也迭代1号哈希表</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">dict</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">is_rehashing</span><span style="color:#000;font-weight:bold">():</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">iter_table</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ht</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">table</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">iter_table</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">table</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">index</span> <span style="color:#204a87;font-weight:bold">in</span> <span style="color:#000">table</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic"># 跳过空的哈希表项</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">table</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">index</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">empty</span><span style="color:#000;font-weight:bold">():</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic"># 处理当前哈希表项的单链表上所有的节点</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">node</span> <span style="color:#204a87;font-weight:bold">in</span> <span style="color:#000">table</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">node</span><span style="color:#000;font-weight:bold">]:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">do_some_thing_with</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">node</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>假设我们在一个正在进行 rehash 操作的字典上创立了一个安全迭代器，首先执行了<code>dictNext()</code>，获取了<code>ht0</code>中的一个哈希表项<code>he1</code>。接着执行<code>dictAdd()</code>，添加了一个哈希表项。如果<code>dictAdd()</code>函数能够执行 rehash 的话，<code>he1</code>哈希表项可能被从<code>ht0</code>复制到了<code>ht1</code>，从而导致安全迭代器获取了哈希表项<code>he1</code>两次</p>
<p>所以当字典中存在安全迭代器的时候，是不能进行 rehash 操作的。</p>
<p>而对于非安全迭代器，Redis 规定在非安全迭代器的生命周期内只能执行<code>dictNext()</code>操作，不能执行其他操作，从而避免了 rehash 操作。</p>
<p>同时 Redis 在创建非安全迭代器的时候会获取 dict 的指纹，在释放非安全迭代器的时候重新获取指纹，检查两次指纹是否相同。如果不同，证明 dict 被修改过，Redis 就会抛出异常。</p>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-24908c465f52816f8bd5bc366e5a5645">8.6 - Redis Sort 命令简介</h1>
    
	<blockquote>
<p><code>sort</code>命令是Redis中最强大的命令之一，本文试图通过一些例子来总结Redis Sort的常用方法。</p>
</blockquote>
<h2 id="对列表排序的简单例子">对列表排序的简单例子</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>127.0.0.1:6379&gt; RPUSH users <span style="color:#0000cf;font-weight:bold">3</span> <span style="color:#0000cf;font-weight:bold">4</span> <span style="color:#0000cf;font-weight:bold">5</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#0000cf;font-weight:bold">33</span> <span style="color:#0000cf;font-weight:bold">8</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span>integer<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#0000cf;font-weight:bold">6</span>
</span></span><span style="display:flex;"><span>127.0.0.1:6379&gt; SORT users
</span></span><span style="display:flex;"><span>1<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;1&#34;</span>
</span></span><span style="display:flex;"><span>2<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;3&#34;</span>
</span></span><span style="display:flex;"><span>3<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;4&#34;</span>
</span></span><span style="display:flex;"><span>4<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;5&#34;</span>
</span></span><span style="display:flex;"><span>5<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;8&#34;</span>
</span></span><span style="display:flex;"><span>6<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;33&#34;</span>
</span></span></code></pre></div><p>在上面的例子中，我们对一系列的数字进行了排序，得到了排序后的结果。</p>
<h2 id="列表排序的更高级的例子">列表排序的更高级的例子</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>127.0.0.1:6379&gt; RPUSH users <span style="color:#0000cf;font-weight:bold">3</span> <span style="color:#0000cf;font-weight:bold">4</span> <span style="color:#0000cf;font-weight:bold">5</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#0000cf;font-weight:bold">33</span> <span style="color:#0000cf;font-weight:bold">8</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span>integer<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#0000cf;font-weight:bold">6</span>
</span></span><span style="display:flex;"><span>127.0.0.1:6379&gt; SORT users limit <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#0000cf;font-weight:bold">4</span> asc alpha
</span></span><span style="display:flex;"><span>1<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;3&#34;</span>
</span></span><span style="display:flex;"><span>2<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;33&#34;</span>
</span></span><span style="display:flex;"><span>3<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;4&#34;</span>
</span></span><span style="display:flex;"><span>4<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;5&#34;</span>
</span></span></code></pre></div><p>在上面的例子中，我们使用了三个参数，<code>limit</code>, <code>asc</code>和<code>alpha</code>。
<code>limit</code>表示对结果进行分页，其中<code>1</code>表示页数，<code>4</code>表示一页中元素的个数。
<code>asc</code>表示对结果进行正序排序。
<code>alpha</code>表示对结果使用字母序排序，而不是数字序。</p>
<h2 id="基于引用对象进行排序">基于引用对象进行排序</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 首先添加一组用户ID</span>
</span></span><span style="display:flex;"><span>127.0.0.1:6379&gt; RPUSH users <span style="color:#0000cf;font-weight:bold">13</span> <span style="color:#0000cf;font-weight:bold">84</span> <span style="color:#0000cf;font-weight:bold">23</span> <span style="color:#0000cf;font-weight:bold">454</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span>integer<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#0000cf;font-weight:bold">4</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 然后添加一些user_age:id key用来表示用户的年龄</span>
</span></span><span style="display:flex;"><span>127.0.0.1:6379&gt; <span style="color:#204a87">set</span> user_age:13 <span style="color:#0000cf;font-weight:bold">20</span>
</span></span><span style="display:flex;"><span>OK
</span></span><span style="display:flex;"><span>127.0.0.1:6379&gt; <span style="color:#204a87">set</span> user_age:84 <span style="color:#0000cf;font-weight:bold">23</span>
</span></span><span style="display:flex;"><span>OK
</span></span><span style="display:flex;"><span>127.0.0.1:6379&gt; <span style="color:#204a87">set</span> user_age:23 <span style="color:#0000cf;font-weight:bold">34</span>
</span></span><span style="display:flex;"><span>OK
</span></span><span style="display:flex;"><span>127.0.0.1:6379&gt; <span style="color:#204a87">set</span> user_age:454 <span style="color:#0000cf;font-weight:bold">11</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 使用sort命令基于用户年龄对用户进行排序</span>
</span></span><span style="display:flex;"><span>127.0.0.1:6379&gt; sort users by user_age:* desc
</span></span><span style="display:flex;"><span>1<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;23&#34;</span>
</span></span><span style="display:flex;"><span>2<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;84&#34;</span>
</span></span><span style="display:flex;"><span>3<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;13&#34;</span>
</span></span><span style="display:flex;"><span>4<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;454&#34;</span>
</span></span></code></pre></div><p>在上面的例子中，我们使用一些值<code>user_age:*</code>，来对列表进行排序。
我们通过<code>sort</code>命令强大的<code>by</code>参数来设置排序的规则。<code>by</code>参数除了可以指定基于键值对数据进行排序外，也可以基于哈希对象进行排序，请看下面这个例子:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 添加一组用户ID</span>
</span></span><span style="display:flex;"><span>127.0.0.1:6379&gt; RPUSH users <span style="color:#0000cf;font-weight:bold">13</span> <span style="color:#0000cf;font-weight:bold">84</span> <span style="color:#0000cf;font-weight:bold">23</span> <span style="color:#0000cf;font-weight:bold">454</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span>integer<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#0000cf;font-weight:bold">4</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 添加了一组哈希对象来表示用户</span>
</span></span><span style="display:flex;"><span>127.0.0.1:6379&gt; hmset user:13 age <span style="color:#0000cf;font-weight:bold">20</span> name user_13
</span></span><span style="display:flex;"><span>OK
</span></span><span style="display:flex;"><span>127.0.0.1:6379&gt; hmset user:84 age <span style="color:#0000cf;font-weight:bold">23</span> name user_84
</span></span><span style="display:flex;"><span>OK
</span></span><span style="display:flex;"><span>127.0.0.1:6379&gt; hmset user:23 age <span style="color:#0000cf;font-weight:bold">34</span> name user_23
</span></span><span style="display:flex;"><span>OK
</span></span><span style="display:flex;"><span>127.0.0.1:6379&gt; hmset user:454 age <span style="color:#0000cf;font-weight:bold">11</span> name user_454
</span></span><span style="display:flex;"><span>OK
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 基于哈希对象的来对上面的例子进行排序</span>
</span></span><span style="display:flex;"><span>127.0.0.1:6379&gt; sort users by user:*-&gt;age
</span></span><span style="display:flex;"><span>1<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;454&#34;</span>
</span></span><span style="display:flex;"><span>2<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;13&#34;</span>
</span></span><span style="display:flex;"><span>3<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;84&#34;</span>
</span></span><span style="display:flex;"><span>4<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;23&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 基于哈希对象的来对上面的例子进行排序，并获取用户名称</span>
</span></span><span style="display:flex;"><span>127.0.0.1:6379&gt; sort users by user:*-&gt;age get user:*-&gt;name
</span></span><span style="display:flex;"><span>1<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;user_454&#34;</span>
</span></span><span style="display:flex;"><span>2<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;user_13&#34;</span>
</span></span><span style="display:flex;"><span>3<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;user_84&#34;</span>
</span></span><span style="display:flex;"><span>4<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;user_23&#34;</span>
</span></span></code></pre></div><p>在这个例子中，<code>users</code>是一个列表用来表示用户ID，<code>user:*</code>为哈希对象用来表示用户。
在第一个<code>sort</code>命令中，我们基于用户哈希对象的<code>age</code>字段来进行排序，得到的结果为排序过后的用户ID列表。
如果想要取的返回值不是用户ID的话，也可以通过<code>get</code>参数来指定获取的字段。
在第二个<code>sort</code>命令中，我们还是通过用户哈希对象的<code>age</code>字段来排序，获取的结果为用户哈希对象的<code>name</code>字段组成的数组。</p>
<h2 id="存储查询结果">存储查询结果</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 添加一组用户ID</span>
</span></span><span style="display:flex;"><span>127.0.0.1:6379&gt; RPUSH users <span style="color:#0000cf;font-weight:bold">13</span> <span style="color:#0000cf;font-weight:bold">84</span> <span style="color:#0000cf;font-weight:bold">23</span> <span style="color:#0000cf;font-weight:bold">454</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 添加一组key用来表示用户年龄</span>
</span></span><span style="display:flex;"><span>127.0.0.1:6379&gt; <span style="color:#204a87">set</span> user_age:13 <span style="color:#0000cf;font-weight:bold">20</span>
</span></span><span style="display:flex;"><span>OK
</span></span><span style="display:flex;"><span>127.0.0.1:6379&gt; <span style="color:#204a87">set</span> user_age:84 <span style="color:#0000cf;font-weight:bold">23</span>
</span></span><span style="display:flex;"><span>OK
</span></span><span style="display:flex;"><span>127.0.0.1:6379&gt; <span style="color:#204a87">set</span> user_age:23 <span style="color:#0000cf;font-weight:bold">34</span>
</span></span><span style="display:flex;"><span>OK
</span></span><span style="display:flex;"><span>127.0.0.1:6379&gt; <span style="color:#204a87">set</span> user_age:454 <span style="color:#0000cf;font-weight:bold">11</span>
</span></span><span style="display:flex;"><span>OK
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 根据用户年龄对用户ID进行排序，并将排序结果存储在users_sort_result所代表的列表中</span>
</span></span><span style="display:flex;"><span>127.0.0.1:6379&gt; SORT users by user_age:* desc store users_sort_result
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span>integer<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#0000cf;font-weight:bold">4</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 为排序结果设置过期时间</span>
</span></span><span style="display:flex;"><span>127.0.0.1:6379&gt; expire users_sort_result <span style="color:#0000cf;font-weight:bold">30</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span>integer<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span></code></pre></div><p>在上面的例子中，我们根据用户年龄对用户ID进行了排序，同时为排序结果设置了一个过期时间，这样我们就可以将排序结果缓存起来了。
然后每回获取排序结果的时候，我们可以先查缓存，如果缓存不存在的话，则进行排序。
需要注意的是，为了避免多个客户端同时操作排序结果，我们需要使用<code>SETNX</code>命令来为缓存结果设置一个锁，详见<a href="https://redis.io/commands/setnx">SETNX key value</a></p>
</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-af68ff2ed3e54c426ada6b1cb8e61eaa">9 - Kafka</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-c7b3f27b65643bf045308409a82ca6b8">9.1 - Consumer</h1>
    
	<h2 id="commit">Commit</h2>
<ul>
<li>
<p>当 Consumer 将 <code>enable.auto.commit</code> 设置为 true 的时候，kafka consumer 会自动提交 offset。
它在 <code>auto.commit.interval.ms</code> 选项的控制下，间隔N秒后，自动将当前 consumer 拉取到的消息 offset 提交到 kafka 中。</p>
</li>
<li>
<p>当 <code>enable.auto.commit=false</code> 时，kafka 客户端不会自动提交 offset，需要开发者通过 <code>consumer.commitSync</code> 或 <code>consumer.commitAsync</code> 提交 offset。</p>
</li>
<li>
<p>不建议每收到一条消息就提交一次 offset，<code>consumer.commitSync</code> 是有性能损耗的，如果 <code>consumer.commitSync</code> 调用的频率非常高，consumer 消费消息的速度将会变得很慢。</p>
</li>
<li>
<p><code>consumer.commitAsync</code> 是异步提交的，它相对 <code>consumer.commitSync</code> 会有一定的性能提升。<code>consumer.commitAsync</code> 还有一个回调函数参数，让开发者设定在提交失败时做什么。</p>
<ul>
<li>一般在 broker 正常时，提交失败的情况很少发生。开发者不需要做提交失败后重试的逻辑。</li>
</ul>
</li>
</ul>
<h3 id="参考链接">参考链接</h3>
<ul>
<li><a href="https://github.com/edenhill/librdkafka/blob/4992b3db321befa04ece3027f3c79f3557684db9/CONFIGURATION.md">https://github.com/edenhill/librdkafka/blob/4992b3db321befa04ece3027f3c79f3557684db9/CONFIGURATION.md</a></li>
<li><a href="https://docs.confluent.io/platform/current/clients/consumer.html#id1">https://docs.confluent.io/platform/current/clients/consumer.html#id1</a></li>
</ul>
<h2 id="offset">offset</h2>
<p>kafka 的消息以 group 为单位给 Consumer 发送。Consumer Group 在 topic 中的 offset 存储在 broker 的 <code>__consumer_offsets</code> topic 中。</p>
<p>新加入的 consumer group 默认从最新位置读取 message。可以通过修改 Consumer 的<code>auto.offset.reset=smallest</code> 选项，让 consumer 从头开始读取 message.</p>
<p>当 broker 获取 consumer group 的 offset 出错时(offset 不存在或者 offset 超出已有的 message 的范围)，也会根据 <code>auto.offset.reset</code> 的配置来决定从什么位置开始读取 message。</p>
<ul>
<li>auto.offset.reset 说明
<ul>
<li><code>smallest</code>, <code>earliest</code> 自动将 offset 设置成最小的 offset</li>
<li><code>largest</code>, <code>latest</code> 自动将 offset 设置成最大的 offset</li>
<li><code>error</code> 抛出一个错误 (ERR__AUTO_OFFSET_RESET) consumer 可以通过 <code>message-&gt;err</code> 获取到该错误</li>
</ul>
</li>
</ul>
<h3 id="参考链接-1">参考链接</h3>
<ul>
<li><a href="https://github.com/edenhill/librdkafka/blob/master/CONFIGURATION.md">https://github.com/edenhill/librdkafka/blob/master/CONFIGURATION.md</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-b0db364c520cdda052412caee9f7bb79">9.2 - Broker</h1>
    
	<h2 id="优雅地关闭-kafka-broker">优雅地关闭 Kafka Broker</h2>
<p>向进程发送 <code>TERM</code> 信号就可以优雅地关闭 Kafka Broker</p>
<p>这是 <code>bin/kafka-server-stop.sh</code> 的内容，他的思路就是通过 ps 查找 cmd 中包括 <code>kafka.Kafka</code> 的进程，来寻找进程 ID</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#000">SIGNAL</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">${</span><span style="color:#000">SIGNAL</span><span style="color:#204a87;font-weight:bold">:-</span><span style="color:#000">TERM</span><span style="color:#4e9a06">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">OSNAME</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">$(</span>uname -s<span style="color:#204a87;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#ce5c00;font-weight:bold">[[</span> <span style="color:#4e9a06">&#34;</span><span style="color:#000">$OSNAME</span><span style="color:#4e9a06">&#34;</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#34;OS/390&#34;</span> <span style="color:#ce5c00;font-weight:bold">]]</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#204a87;font-weight:bold">then</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#ce5c00;font-weight:bold">[</span> -z <span style="color:#000">$JOBNAME</span> <span style="color:#ce5c00;font-weight:bold">]</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#204a87;font-weight:bold">then</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">JOBNAME</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;KAFKSTRT&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">fi</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">PIDS</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">$(</span>ps -A -o pid,jobname,comm <span style="color:#000;font-weight:bold">|</span> grep -i <span style="color:#000">$JOBNAME</span> <span style="color:#000;font-weight:bold">|</span> grep java <span style="color:#000;font-weight:bold">|</span> grep -v grep <span style="color:#000;font-weight:bold">|</span> awk <span style="color:#4e9a06">&#39;{print $1}&#39;</span><span style="color:#204a87;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">elif</span> <span style="color:#ce5c00;font-weight:bold">[[</span> <span style="color:#4e9a06">&#34;</span><span style="color:#000">$OSNAME</span><span style="color:#4e9a06">&#34;</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#34;OS400&#34;</span> <span style="color:#ce5c00;font-weight:bold">]]</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#204a87;font-weight:bold">then</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">PIDS</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">$(</span>ps -Af <span style="color:#000;font-weight:bold">|</span> grep -i <span style="color:#4e9a06">&#39;kafka\.Kafka&#39;</span> <span style="color:#000;font-weight:bold">|</span> grep java <span style="color:#000;font-weight:bold">|</span> grep -v grep <span style="color:#000;font-weight:bold">|</span> awk <span style="color:#4e9a06">&#39;{print $2}&#39;</span><span style="color:#204a87;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">else</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">PIDS</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">$(</span>ps ax <span style="color:#000;font-weight:bold">|</span> grep <span style="color:#4e9a06">&#39; kafka\.Kafka &#39;</span> <span style="color:#000;font-weight:bold">|</span> grep java <span style="color:#000;font-weight:bold">|</span> grep -v grep <span style="color:#000;font-weight:bold">|</span> awk <span style="color:#4e9a06">&#39;{print $1}&#39;</span><span style="color:#204a87;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">fi</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#ce5c00;font-weight:bold">[</span> -z <span style="color:#4e9a06">&#34;</span><span style="color:#000">$PIDS</span><span style="color:#4e9a06">&#34;</span> <span style="color:#ce5c00;font-weight:bold">]</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#204a87;font-weight:bold">then</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87">echo</span> <span style="color:#4e9a06">&#34;No kafka server to stop&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87">exit</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">else</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87">kill</span> -s <span style="color:#000">$SIGNAL</span> <span style="color:#000">$PIDS</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">fi</span>
</span></span></code></pre></div><p>但是 Linux 内核有限制，ps 输出的一行内容不能超过页大小 <code>PAGE_SIZE</code> (4096)，所以如果 kafka 进程的 cmd 过长，可能会导致 ps + grep 失败。</p>
<p>此时就需要我们手动来找对应的进程，可以通过 <code>ps ax | grep 'kafka'</code> 来寻找对应的进程。</p>
<h2 id="存储">存储</h2>
<ul>
<li>
<p>顺序写盘的速度不仅比随机写盘的速度快，而且也比随机写内存的速度快。kafka 在设计时采用了文件追加的方式来写入消息，即只能在日志文件的尾部追加新的消息，并且也不允许修改已经写入的消息，这种方式属于典型的顺序写盘的操作。</p>
</li>
<li>
<p>kafka 大量地使用了页缓存来提高读写文件的效率，而并没有怎么使用进程内的缓存。Java 对象的内存开销非常大，是真实数据的几倍，Java 的 GC 会随着堆内数据的增多而变得越来越慢。基于以上考虑，kafka 使用 Linux 为文件 I/O 提供的页缓存，而不是使用 Java 进程内的缓存。</p>
</li>
<li>
<p>Linux 系统提供了 swap 分区的功能，将非活跃的进程调入 swap 分区，以此把内存空出来让给活跃的进程。对于大量使用系统页缓存的 kafka 而言，应避免这种内存的交换，否则会对它各方面的性能产生较大的影响。<code>vm.swappiness</code> 参数控制 swap 分区的使用率，数值在 0 - 100，数值越大使用的越多，建议设置成1，不设置成 0 防止系统在内存耗尽时 kill 进程。</p>
</li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-2fabee976deeadba60c4cdb9b8ab43f2">9.3 - 从源码安装 confluent-kafka-python</h1>
    
	<hr>
<h2 id="从源码安装-librdkafka">从源码安装 librdkafka</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 安装 vcpkg</span>
</span></span><span style="display:flex;"><span>&gt; git clone https://github.com/microsoft/vcpkg ~/.local/vcpkg
</span></span><span style="display:flex;"><span>&gt; ~/.local/vcpkg/bootstrap-vcpkg.sh
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 安装 librdkafka</span>
</span></span><span style="display:flex;"><span>&gt; ~/.local/vcpkg/vcpkg install librdkafka
</span></span></code></pre></div><ul>
<li>设置 include path 和 link path</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#204a87">export</span> <span style="color:#000">CPATH</span><span style="color:#ce5c00;font-weight:bold">=</span>~/.local/vcpkg/packages/librdkafka_x64-linux/include
</span></span><span style="display:flex;"><span><span style="color:#204a87">export</span> <span style="color:#000">LIBRARY_PATH</span><span style="color:#ce5c00;font-weight:bold">=</span>~/.local/vcpkg/packages/librdkafka_x64-linux/lib
</span></span></code></pre></div><blockquote>
<p>GCC uses the following environment variables:</p>
<ul>
<li>PATH: For searching the executables and run-time shared libraries (.dll, .so).</li>
<li>CPATH: For searching the include-paths for headers. It is searched after paths specified in <code>-I&lt;dir&gt;</code> options. <code>C_INCLUDE_PATH</code> and <code>CPLUS_INCLUDE_PATH</code> can be used to specify C and C++ headers if the particular language was indicated in pre-processing.</li>
<li>LIBRARY_PATH: For searching library-paths for link libraries. It is searched after paths specified in <code>-L&lt;dir&gt;</code> options. 程序编译期查找动态链接库的路径。</li>
<li>LD_LIBRARY_PATH: 程序运行期间查找动态链接库的路径。</li>
</ul>
</blockquote>
<ul>
<li>安装 librdkafka</li>
</ul>
<pre tabindex="0"><code>pip install -e ~/work/Douban/code/confluent-kafka-python/
</code></pre><h2 id="参考链接">参考链接</h2>
<ul>
<li><a href="https://www3.ntu.edu.sg/home/ehchua/programming/cpp/gcc_make.html#zz-1.9">https://www3.ntu.edu.sg/home/ehchua/programming/cpp/gcc_make.html#zz-1.9</a></li>
<li><a href="https://github.com/microsoft/vcpkg">https://github.com/microsoft/vcpkg</a></li>
</ul>
</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-7eb9a6396b5cbd586e9b014377b38023">10 - K8S</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-bd84dd312bc1d349bf04a6cec2f524ce">10.1 - K8S In Actions</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-83a38df0e29a6bce99f61db69b4f4565">10.1.1 - 11-architecture</h1>
    
	<hr>
<h2 id="了解-k8s-架构">了解 K8S 架构</h2>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com//2022-01-27-000255.png" alt="K8S 架构图"></p>
<p>K8S 系统组件之间只能通过 API Server 通信，它们之间不会直接通信。API Server 是和 etcd 通信的唯一组件。</p>
<p>检查控制平面组件的状态</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>ø&gt; k get componentstatuses
</span></span><span style="display:flex;"><span>Warning: v1 ComponentStatus is deprecated in v1.19+
</span></span><span style="display:flex;"><span>NAME                 STATUS      MESSAGE                                                                                       ERROR
</span></span><span style="display:flex;"><span>scheduler            Unhealthy   Get <span style="color:#4e9a06">&#34;http://127.0.0.1:10251/healthz&#34;</span>: dial tcp 127.0.0.1:10251: connect: connection refused
</span></span><span style="display:flex;"><span>controller-manager   Healthy     ok
</span></span><span style="display:flex;"><span>etcd-0               Healthy     <span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#4e9a06">&#34;health&#34;</span>:<span style="color:#4e9a06">&#34;true&#34;</span>,<span style="color:#4e9a06">&#34;reason&#34;</span>:<span style="color:#4e9a06">&#34;&#34;</span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><p><strong>乐观并发控制</strong></p>
<p>数据中包含一个版本，每次更新时版本会 +1。</p>
<p>写入时，检查数据库中的版本和被写入的版本之间的差是否等于1，如果不等于，则证明期间该数据被修改过，会拒绝写入。</p>
<h2 id="api-服务器做了什么">API 服务器做了什么</h2>
<ol>
<li>认证插件 <strong>Authentication Plugin</strong></li>
<li>授权插件 <strong>Authorization Plugin</strong></li>
<li>准入控制插件 <strong>Admission Control Plugin</strong></li>
</ol>
<p>以上每种类型的插件都有多个，API Server 会按顺序执行</p>
<p>K8S 客户端发送的请求，通过以上三个插件的认证，并完成 <strong>资源认证</strong> 后。API Server 会将对象信息存储到 etcd 中。然后返回一个响应给客户端。</p>
<p>除此之外，API Server 没有做额外的工作。例如，当创建一个 ReplicaSet 资源的时候，它不会去创建 Pod，也不会去管理服务的节点，那是 Controller Manager (控制器管理器) 的工作。</p>
<h2 id="调度器">调度器</h2>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2022-01-26-234210.png" alt="调度器结构图"></p>
<p><strong>默认调度算法</strong></p>
<ol>
<li>过滤所有节点
<ol>
<li>调度器给节点下发一组配置好的预测函数，这些函数执行完以后。决定该 Pod 能否在当前节点上调度。</li>
</ol>
</li>
<li>选择完节点后，调度器再对节点进行排序，选择一个最合适的节点</li>
</ol>
<p><strong>选择调度器</strong></p>
<p>可以在集群内运行多个调度器</p>
<p>pod 通过 <code>schedulerName</code> 属性选择调度器。未设置该属性的 Pod 使用默认调度器进行调度。</p>
<h2 id="控制器管理器中运行的控制器">控制器管理器中运行的控制器</h2>
<p>控制器执行一个调和循环，将实际的状态调整为期望状态(在资源 spec 中定义)。然后将新的实际状态写入资源的 status 部分。</p>
<p>因为控制器订阅 API Server 的事件，这不能保证它不会再某些时间漏掉。控制器需要定期执行重新列举操作，确保不会丢掉什么。</p>
<blockquote>
<p>如何阅读控制器的源码</p>
<p>控制器的源码违约 pkg/controller 中</p>
<p>每个控制器通常有一个构造器，内部会创建一个 <code>Informer</code>。它是个监听器，每次 API 对象有更新就会被调用。</p>
<p>接着，可以看 worker 方法，每次控制器工作时会调用 worker，实际函数保存在 syncHandler 或类似的字段里，该字段也会在构造器里初始化。</p>
</blockquote>
<h2 id="控制器如何协作">控制器如何协作</h2>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2022-02-09-235435.png" alt=""></p>
<h2 id="了解运行中的-pod-是什么">了解运行中的 Pod 是什么</h2>
<p>Pod 是多个容器的集合，它们共享相同的命名空间。</p>
<p>K8S 创建 Pod 时会创建基础容器 Pause，后续的用户自定义容器都会使用 Pause 容器提供的命名空间。</p>
<p>Pause 容器的生命周期和 Pod 绑定，从 Pod 被调度直到被删除的期间， Pause 容器会一直运行。
如果 Pod 运行期间 Pause 容器被删除了，kubelet 会重建 Pod 中的所有容器。</p>
<h2 id="跨-pod-网络">跨 Pod 网络</h2>
<p>K8S 规定 Pod 必须通过非 NAT 网络进行连接，即 Server 看到的 Client IP 和 Client 看到的自身 IP 是相同的。</p>
<h2 id="问题">问题</h2>
<h3 id="scheduler-组件挂掉了">scheduler 组件挂掉了</h3>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-748bf9642d06918290f08675791b7fee">10.1.2 - 10-statefulset</h1>
    
	<hr>
<h2 id="杂记">杂记</h2>
<ul>
<li>
<p>StatefulSet 用于创建有状态的服务，StatefulSet 创建的每个 Pod 都有一个从0开始的顺序索引，这个会体现在 Pod 的名称，主机名和存储上。</p>
</li>
<li>
<p>Pod 挂掉后，这个 Pod 实例会在另一个节点上重建，且新的实例必须和被替换的示例有如下相同的标识:</p>
<ol>
<li>相同的名称</li>
<li>相同的网络标识(主机名/IP)</li>
<li>相同的状态</li>
</ol>
</li>
<li>
<p>StatefulSet 的每个 Pod 都会创建一个持久卷声明(Persistent Volume Claim)。</p>
<ul>
<li>对 StatefulSet 执行缩容后，Pod 会被删除，但是它对应的持久卷声明不会删除，卷也不会删。需要开发者手动删除 PVC 时卷才会被删除。
后续对 StatefulSet 执行扩容后，该索引的 Pod 又被创建了，则新 Pod 会使用之前遗留的卷。</li>
</ul>
</li>
<li>
<p>StatefulSet 保证 Pod 的 at-most-one 语义，即同一个索引的 Pod 最多只会创建一个。</p>
</li>
<li>
<p>删除 Pod 后，API Server 会将 Pod 标记为 Terminating 状态，使用 <code>k get pod</code> 依然能够查询到该 Pod。这是因为 API Server 必须等到 kubelet 报告该 Pod 处于删除状态后，API Server 才会真正删除 Pod 的信息。</p>
<ul>
<li>如果整个节点都挂了，确认该 Pod 已经无用了，可以使用 <code>k delete pod xx --force --grace-period 0</code> 删除该 Pod。这样 API Server 就不会等待 kubelet 的等待，直接删除 Pod 的信息</li>
</ul>
</li>
</ul>
<h2 id="利用-calico-和-kubeadm-搭建-k8s-集群">利用 calico 和 kubeadm 搭建 K8S 集群</h2>
<ul>
<li><a href="https://projectcalico.docs.tigera.io/getting-started/kubernetes/quickstart">https://projectcalico.docs.tigera.io/getting-started/kubernetes/quickstart</a></li>
<li><a href="https://kubernetes.io/zh/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/">https://kubernetes.io/zh/docs/setup/production-environment/tools/kubeadm/create-cluster-kubeadm/</a></li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>sudo kubeadm init --apiserver-advertise-address 192.168.57.101 --pod-network-cidr<span style="color:#ce5c00;font-weight:bold">=</span>10.1.0.0/16
</span></span><span style="display:flex;"><span>kubeadm join 192.168.57.101:6443 --token efw8cb.x7rt4piplnoehba4 <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>        --discovery-token-ca-cert-hash sha256:2939553704626b85761e11beb9230eb1194916d16ce174477591683b7c0b1df2
</span></span></code></pre></div><ul>
<li>安装 calico 插件</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 安装 calico operator</span>
</span></span><span style="display:flex;"><span>kubectl create -f conf/calico/tigera-operator.yaml
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 安装 自定义资源，注意，我修改了 ipPool.CIDR</span>
</span></span><span style="display:flex;"><span>kubectl create -f conf/calico/custom-resources.yaml
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 观察 calico 的相关pod，是否都处于 running 状态</span>
</span></span><span style="display:flex;"><span>kubectl get pods -n calico-system
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 去掉主节点的 taint，可以让 pod 调度上去</span>
</span></span><span style="display:flex;"><span>kubectl taint nodes --all node-role.kubernetes.io/master-
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 查看节点是否都处于 ready 状态</span>
</span></span><span style="display:flex;"><span>kubectl get nodes -o wide
</span></span></code></pre></div><h2 id="实验">实验</h2>
<h3 id="通过-service-访问-pod">通过 Service 访问 Pod</h3>
<ol>
<li>部署一个非 headless 的 Service (即 Service 有 IP)</li>
<li>通过 Service 的 IP 访问 Pod</li>
</ol>
<p>在 pod 内 ping svc 的 IP 超时，怀疑是网络部署的问题 (重新部署 calico 后解决)</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>root@dev-d68d66dff-lkfll:~# ping 10.98.169.254
</span></span><span style="display:flex;"><span>PING 10.98.169.254 <span style="color:#ce5c00;font-weight:bold">(</span>10.98.169.254<span style="color:#ce5c00;font-weight:bold">)</span> 56<span style="color:#ce5c00;font-weight:bold">(</span>84<span style="color:#ce5c00;font-weight:bold">)</span> bytes of data.
</span></span><span style="display:flex;"><span>^C
</span></span><span style="display:flex;"><span>--- 10.98.169.254 ping statistics ---
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">3</span> packets transmitted, <span style="color:#0000cf;font-weight:bold">0</span> received, 100% packet loss, <span style="color:#204a87">time</span> 2041ms
</span></span></code></pre></div><h3 id="通过-srv-dns-记录让-pod-彼此发现">通过 SRV DNS 记录让 pod 彼此发现</h3>
<p>statefulset 创建的时候，可以通过 <code>spec.serviceName</code> 字段制定 pod 绑定的 service 名字。</p>
<p>我们创建了一个名字叫 kubia 的 headless Service。在其他 pod 中，可以通过 SRV 记录查询到 statefulset pod 的 IP</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>root@dev-d68d66dff-j49lc:~# dig SRV kubia.default.svc.cluster.local
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;</span> &lt;&lt;&gt;&gt; DiG 9.11.3-1ubuntu1.16-Ubuntu &lt;&lt;&gt;&gt; SRV kubia.default.svc.cluster.local
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;;</span> global options: +cmd
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;;</span> Got answer:
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;;</span> WARNING: .local is reserved <span style="color:#204a87;font-weight:bold">for</span> Multicast DNS
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;;</span> You are currently testing what happens when an mDNS query is leaked to DNS
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;;</span> -&gt;&gt;HEADER<span style="color:#4e9a06">&lt;&lt;- opco</span>de: QUERY, status: NOERROR, id: <span style="color:#0000cf;font-weight:bold">3910</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;;</span> flags: qr aa rd<span style="color:#000;font-weight:bold">;</span> QUERY: 1, ANSWER: 2, AUTHORITY: 0, ADDITIONAL: <span style="color:#0000cf;font-weight:bold">3</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;;</span> WARNING: recursion requested but not available
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;;</span> OPT PSEUDOSECTION:
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;</span> EDNS: version: 0, flags:<span style="color:#000;font-weight:bold">;</span> udp: <span style="color:#0000cf;font-weight:bold">4096</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;</span> COOKIE: 2ff40eb09b50498b <span style="color:#ce5c00;font-weight:bold">(</span>echoed<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;;</span> QUESTION SECTION:
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;</span>kubia.default.svc.cluster.local. IN    SRV
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;;</span> ANSWER SECTION:
</span></span><span style="display:flex;"><span>kubia.default.svc.cluster.local. <span style="color:#0000cf;font-weight:bold">30</span> IN  SRV     <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#0000cf;font-weight:bold">50</span> <span style="color:#0000cf;font-weight:bold">80</span> kubia-0.kubia.default.svc.cluster.local.
</span></span><span style="display:flex;"><span>kubia.default.svc.cluster.local. <span style="color:#0000cf;font-weight:bold">30</span> IN  SRV     <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#0000cf;font-weight:bold">50</span> <span style="color:#0000cf;font-weight:bold">80</span> kubia-1.kubia.default.svc.cluster.local.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;;</span> ADDITIONAL SECTION:
</span></span><span style="display:flex;"><span>kubia-1.kubia.default.svc.cluster.local. <span style="color:#0000cf;font-weight:bold">30</span> IN A 10.1.169.130
</span></span><span style="display:flex;"><span>kubia-0.kubia.default.svc.cluster.local. <span style="color:#0000cf;font-weight:bold">30</span> IN A 10.1.107.193
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;;</span> Query time: <span style="color:#0000cf;font-weight:bold">0</span> msec
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;;</span> SERVER: 10.96.0.10#53<span style="color:#ce5c00;font-weight:bold">(</span>10.96.0.10<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;;</span> WHEN: Sat Jan <span style="color:#0000cf;font-weight:bold">22</span> 15:25:04 UTC <span style="color:#0000cf;font-weight:bold">2022</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;;</span> MSG SIZE  rcvd: <span style="color:#0000cf;font-weight:bold">362</span>
</span></span></code></pre></div><h3 id="pod-重用存储">Pod 重用存储</h3>
<ol start="0">
<li>创建一个 statefulset ，有两个 pod, pod-0 和 pod-1</li>
<li>在 pod-1 的 volume 中写入内容。</li>
<li>将 statefulset 的 pod 数改成 1, pod-1 被删除</li>
<li>将 statefulset 的 pod 数改成 1，新的 pod-1&rsquo; 被创建</li>
<li>访问 pod-1&rsquo;，它的内容和 pod-1 内容一样</li>
</ol>
<h3 id="通过-kubectl-proxy-访问-pod">通过 kubectl proxy 访问 pod</h3>
<ol>
<li>创建 pod 时要声明 <code>containers[*].ports</code></li>
<li>启动 kubectl proxy</li>
<li>在本地访问 pod 暴露的端口， <code>curl localhost:8001/api/v1/namespaces/default/pods/dev-6968fdb999-94ddx/proxy/ip</code>，如果pod 没有声明暴露的端口，默认会使用 80</li>
</ol>
<h2 id="问题">问题</h2>
<h3 id="安装-flannel-插件失败">安装 flannel 插件失败</h3>
<p>dev pod 在 k8s-node2 上，kubia-1 在 k8s-node2 上，kubia-2 在 k8s-node3 上。</p>
<p>dev pod 能够和 kubia-1 通信，无法和 kubia-2 通信。其他 pod 也是如此，跨节点的 pod 无法通信。</p>
<p>查看 <code>kube-flannel-ds</code> 的 pod 日志，发现了如下的报错:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>E0121 01:40:13.395131       <span style="color:#0000cf;font-weight:bold">1</span> reflector.go:127<span style="color:#ce5c00;font-weight:bold">]</span> github.com/flannel-io/flannel/subnet/kube/kube.go:379: Failed to watch *v1.Node: failed to list *v1.Node: Get <span style="color:#4e9a06">&#34;https://10.96.0.1:443/api/v1/nodes?resourceVersion=4657&#34;</span>: dial tcp 10.96.0.1:443: connect: network is unreachable
</span></span><span style="display:flex;"><span>E0121 01:40:56.634458       <span style="color:#0000cf;font-weight:bold">1</span> reflector.go:127<span style="color:#ce5c00;font-weight:bold">]</span> github.com/flannel-io/flannel/subnet/kube/kube.go:379: Failed to watch *v1.Node: failed to list *v1.Node: Get <span style="color:#4e9a06">&#34;https://10.96.0.1:443/api/v1/nodes?resourceVersion=4657&#34;</span>: dial tcp 10.96.0.1:443: connect: network is unreachable
</span></span></code></pre></div><p>搜索到了相关的 github issue，kubeadm 作者回复说建议换用其他的 CNI 插件 <a href="https://github.com/kubernetes/kubeadm/issues/1817#issuecomment-538311661">链接</a></p>
<p>参考阅读: <a href="https://www.91the.top/k8s/kubernetes-probelem.html">https://www.91the.top/k8s/kubernetes-probelem.html</a></p>
<p>TODO: 安装完网络插件后，一定要看 pod 日志中是否有报错，此次安装完 flannel 之后，pod 都显示是 Running 状态，但 pod 日志中有连接超时的错误</p>
<h3 id="k8s-拉取镜像失败">k8s 拉取镜像失败</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>  Type     Reason     Age               From               Message
</span></span><span style="display:flex;"><span>  ----     ------     ----              ----               -------
</span></span><span style="display:flex;"><span>  Normal   Scheduled  18s               default-scheduler  Successfully assigned default/dev-79d7bcddc6-q4rz7 to k8s-node2
</span></span><span style="display:flex;"><span>  Warning  Failed     13s               kubelet            Failed to pull image <span style="color:#4e9a06">&#34;bwangel/dev:0.1&#34;</span>: rpc error: <span style="color:#000">code</span> <span style="color:#ce5c00;font-weight:bold">=</span> Unknown <span style="color:#000">desc</span> <span style="color:#ce5c00;font-weight:bold">=</span> Error response from daemon: pull access denied <span style="color:#204a87;font-weight:bold">for</span> bwangel/dev, repository does not exist or may require <span style="color:#4e9a06">&#39;docker login&#39;</span>: denied: requested access to the resource is denied
</span></span><span style="display:flex;"><span>  Warning  Failed     13s               kubelet            Error: ErrImagePull
</span></span><span style="display:flex;"><span>  Normal   BackOff    13s               kubelet            Back-off pulling image <span style="color:#4e9a06">&#34;bwangel/dev:0.1&#34;</span>
</span></span><span style="display:flex;"><span>  Warning  Failed     13s               kubelet            Error: ImagePullBackOff
</span></span><span style="display:flex;"><span>  Normal   Pulling    1s <span style="color:#ce5c00;font-weight:bold">(</span>x2 over 18s<span style="color:#ce5c00;font-weight:bold">)</span>  kubelet            Pulling image <span style="color:#4e9a06">&#34;bwangel/dev:0.1&#34;</span>
</span></span></code></pre></div><h3 id="创建-statefulset-服务">创建 StatefulSet 服务</h3>
<p>创建服务时，启动 pod 出现了如下的错误:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>Events:
</span></span><span style="display:flex;"><span>  Type     Reason                  Age                   From               Message
</span></span><span style="display:flex;"><span>  ----     ------                  ----                  ----               -------
</span></span><span style="display:flex;"><span>  Warning  FailedScheduling        3m16s                 default-scheduler  0/3 nodes are available: <span style="color:#0000cf;font-weight:bold">3</span> pod has unbound immediate PersistentVolumeClaims.
</span></span><span style="display:flex;"><span>  Normal   Scheduled               3m15s                 default-scheduler  Successfully assigned default/kubia-0 to k8s-node3
</span></span><span style="display:flex;"><span>  Warning  FailedCreatePodSandBox  3m15s                 kubelet            Failed to create pod sandbox: rpc error: <span style="color:#000">code</span> <span style="color:#ce5c00;font-weight:bold">=</span> Unknown <span style="color:#000">desc</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">[</span>failed to <span style="color:#204a87">set</span> up sandbox container <span style="color:#4e9a06">&#34;96322b4278a93ee85612b031fdf02d00cee3cbfbb680aa7a62ac5e4a50a6966d&#34;</span> network <span style="color:#204a87;font-weight:bold">for</span> pod <span style="color:#4e9a06">&#34;kubia-0&#34;</span>: networkPlugin cni failed to <span style="color:#204a87">set</span> up pod <span style="color:#4e9a06">&#34;kubia-0_default&#34;</span> network: unable to allocate IP address: Post <span style="color:#4e9a06">&#34;http://127.0.0.1:6784/ip/96322b4278a93ee85612b031fdf02d00cee3cbfbb680aa7a62ac5e4a50a6966d&#34;</span>: dial tcp 127.0.0.1:6784: connect: connection refused, failed to clean up sandbox container <span style="color:#4e9a06">&#34;96322b4278a93ee85612b031fdf02d00cee3cbfbb680aa7a62ac5e4a50a6966d&#34;</span> network <span style="color:#204a87;font-weight:bold">for</span> pod <span style="color:#4e9a06">&#34;kubia-0&#34;</span>: networkPlugin cni failed to teardown pod <span style="color:#4e9a06">&#34;kubia-0_default&#34;</span> network: Delete <span style="color:#4e9a06">&#34;http://127.0.0.1:6784/ip/96322b4278a93ee85612b031fdf02d00cee3cbfbb680aa7a62ac5e4a50a6966d&#34;</span>: dial tcp 127.0.0.1:6784: connect: connection refused<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>  Normal   SandboxChanged          10s <span style="color:#ce5c00;font-weight:bold">(</span>x15 over 3m14s<span style="color:#ce5c00;font-weight:bold">)</span>  kubelet            Pod sandbox changed, it will be killed and re-created.
</span></span></code></pre></div><p>解决方案:</p>
<ol>
<li>删掉了 weave CNI 插件</li>
<li>重新安装 flannel 插件</li>
</ol>
<p>安装 flannel 的命令:</p>
<ol>
<li>启动 master 节点: <code>sudo kubeadm init --apiserver-advertise-address 192.168.57.101 --pod-network-cidr=10.244.0.0/16</code></li>
<li>安装 flannel: <code>k apply -f conf/kube-flannel.yml</code> <a href="https://github.com/bwangelme/k8s-in-vagrant/blob/08fe5f9679ad14b52163faff7d503ccfa1c1ca1b/conf/kube-flannel.yml">kube-flannel.yml 文件内容</a></li>
</ol>
<h3 id="k-proxy-访问-pod-失败">k proxy 访问 pod 失败</h3>
<p>使用 <code>k proxy</code> 启动代理服务后，使用 curl 访问 pod 超时</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>ø&gt; curl -m3 -v localhost:8001/api/v1/namespaces/default/pods/kubia-0/proxy/                                   23:02:30 <span style="color:#ce5c00;font-weight:bold">(</span>01-19<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>*   Trying 127.0.0.1...
</span></span><span style="display:flex;"><span>* TCP_NODELAY <span style="color:#204a87">set</span>
</span></span><span style="display:flex;"><span>* Connected to localhost <span style="color:#ce5c00;font-weight:bold">(</span>127.0.0.1<span style="color:#ce5c00;font-weight:bold">)</span> port <span style="color:#0000cf;font-weight:bold">8001</span> <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#8f5902;font-style:italic">#0)</span>
</span></span><span style="display:flex;"><span>&gt; GET /api/v1/namespaces/default/pods/kubia-0/proxy/ HTTP/1.1
</span></span><span style="display:flex;"><span>&gt; Host: localhost:8001
</span></span><span style="display:flex;"><span>&gt; User-Agent: curl/7.64.1
</span></span><span style="display:flex;"><span>&gt; Accept: */*
</span></span><span style="display:flex;"><span>&gt;
</span></span><span style="display:flex;"><span>* Operation timed out after <span style="color:#0000cf;font-weight:bold">3004</span> milliseconds with <span style="color:#0000cf;font-weight:bold">0</span> bytes received
</span></span><span style="display:flex;"><span>* Closing connection <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>curl: <span style="color:#ce5c00;font-weight:bold">(</span>28<span style="color:#ce5c00;font-weight:bold">)</span> Operation timed out after <span style="color:#0000cf;font-weight:bold">3004</span> milliseconds with <span style="color:#0000cf;font-weight:bold">0</span> bytes received
</span></span></code></pre></div><h3 id="跨节点-pod-无法互通">跨节点 Pod 无法互通</h3>
<p><strong>表现</strong></p>
<ol>
<li>搭建完 calico 网络，跨节点pod 能够互通的</li>
<li>过了一段时间后，网络不通。</li>
<li><code>tigera-operator</code> 中的 Pod <code>tigera-operator-c4b9549c7-scvn22</code> 挂掉了,</li>
</ol>
<p>设置了配置文件 <code>/etc/NetworkManager/conf.d/calico.conf</code>，并重启后恢复了，还不了解原因</p>
<p>查看信息</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>tigera-operator    tigera-operator-c4b9549c7-scvn2           0/1     CrashLoopBackOff   <span style="color:#0000cf;font-weight:bold">42</span> <span style="color:#ce5c00;font-weight:bold">(</span>3m6s ago<span style="color:#ce5c00;font-weight:bold">)</span>   11h   192.168.57.101   k8s-node1   &lt;none&gt;           &lt;none&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ø&gt; k -n tigera-operator logs tigera-operator-c4b9549c7-scvn2                                                  10:25:35 <span style="color:#ce5c00;font-weight:bold">(</span>01-23<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>2022/01/23 02:22:01 <span style="color:#ce5c00;font-weight:bold">[</span>INFO<span style="color:#ce5c00;font-weight:bold">]</span> Version: v1.23.5
</span></span><span style="display:flex;"><span>2022/01/23 02:22:01 <span style="color:#ce5c00;font-weight:bold">[</span>INFO<span style="color:#ce5c00;font-weight:bold">]</span> Go Version: go1.16.7b7
</span></span><span style="display:flex;"><span>2022/01/23 02:22:01 <span style="color:#ce5c00;font-weight:bold">[</span>INFO<span style="color:#ce5c00;font-weight:bold">]</span> Go OS/Arch: linux/amd64
</span></span><span style="display:flex;"><span>2022/01/23 02:22:01 <span style="color:#ce5c00;font-weight:bold">[</span>ERROR<span style="color:#ce5c00;font-weight:bold">]</span> Get <span style="color:#4e9a06">&#34;https://10.96.0.1:443/api?timeout=32s&#34;</span>: dial tcp 10.96.0.1:443: connect: network is unreachable
</span></span></code></pre></div><ol start="4">
<li>dev pod 和 kubia-1 属于不通节点，dev ping kubia-1 超时。dev ping 同节点上的 kubia-0 可以成功</li>
</ol>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-e4213589dd7386ddf7fc692619b58395">10.1.3 - 7-configmap-secert</h1>
    
	<blockquote>
<p>ConfigMap 和 Secret 配置应用程序</p>
</blockquote>
<hr>
<h2 id="配置容器化应用程序">配置容器化应用程序</h2>
<p>配置应用程序的方法:</p>
<ol>
<li>向容器传递命令行参数</li>
<li>为每个容器设置自定义的环境变量</li>
<li>通过特殊类型的卷将配置文件挂载到容器中</li>
</ol>
<h2 id="向容器传递命令行参数">向容器传递命令行参数</h2>
<ul>
<li>ENTRYPOINT 定义容器启动时被调用的可执行程序</li>
<li>CMD 指定传递给 ENTRYPOINT 的参数</li>
</ul>
<p>shell 形式与 exec 形式的主要区别是命令是否在 shell 中调用。</p>
<ul>
<li>shell 形式: <code>ENTRYPOINT node app.js</code></li>
<li>exec 形式: <code>ENTRYPOINT [&quot;node&quot;, &quot;app.js&quot;]</code></li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 使用默认的命令行参数</span>
</span></span><span style="display:flex;"><span>ø&gt; docker run -it bwangel/fortune:args
</span></span><span style="display:flex;"><span>Configured to generate new fortune every <span style="color:#0000cf;font-weight:bold">10</span> seconds
</span></span><span style="display:flex;"><span>Sat Feb <span style="color:#0000cf;font-weight:bold">13</span> 01:54:01 UTC <span style="color:#0000cf;font-weight:bold">2021</span> Writing fortune to /var/htdocs/index.html
</span></span><span style="display:flex;"><span>Sat Feb <span style="color:#0000cf;font-weight:bold">13</span> 01:54:11 UTC <span style="color:#0000cf;font-weight:bold">2021</span> Writing fortune to /var/htdocs/index.html
</span></span><span style="display:flex;"><span>^C
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 传递命令行参数给容器，覆盖默认的值</span>
</span></span><span style="display:flex;"><span>ø&gt; docker run -it bwangel/fortune:args <span style="color:#0000cf;font-weight:bold">5</span>
</span></span><span style="display:flex;"><span>Configured to generate new fortune every <span style="color:#0000cf;font-weight:bold">5</span> seconds
</span></span><span style="display:flex;"><span>Sat Feb <span style="color:#0000cf;font-weight:bold">13</span> 01:54:23 UTC <span style="color:#0000cf;font-weight:bold">2021</span> Writing fortune to /var/htdocs/index.html
</span></span><span style="display:flex;"><span>Sat Feb <span style="color:#0000cf;font-weight:bold">13</span> 01:54:28 UTC <span style="color:#0000cf;font-weight:bold">2021</span> Writing fortune to /var/htdocs/index.html
</span></span><span style="display:flex;"><span>Sat Feb <span style="color:#0000cf;font-weight:bold">13</span> 01:54:33 UTC <span style="color:#0000cf;font-weight:bold">2021</span> Writing fortune to /var/htdocs/index.html
</span></span><span style="display:flex;"><span>Sat Feb <span style="color:#0000cf;font-weight:bold">13</span> 01:54:38 UTC <span style="color:#0000cf;font-weight:bold">2021</span> Writing fortune to /var/htdocs/index.html
</span></span><span style="display:flex;"><span>^C
</span></span></code></pre></div><p>k8s 配置中的 <code>cmd</code> 和 <code>args</code> 选项可以覆盖镜像的 <code>entrypoint</code> 和 <code>cmd</code> 设置。</p>
<p>注意: 字符串值无需使用引号包裹，数值需要。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">args</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#000">foo</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#000">bar</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#4e9a06">&#34;15&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h2 id="为容器设置环境变量">为容器设置环境变量</h2>
<p>环境变量被设置在 pod 的容器定义中，并非是 pod 级别。k8s 在 pod 中会自动暴露相同命名空间下 Service 的环境变量。所以环境变量可以被看作是注入的配置。</p>
<p>环境变量的定义中可以使用 <code>$(SOME_ENV)</code> 的形式引用其他环境变量，同样，cmd 和 args 的配置也可以引用其他环境变量。</p>
<h2 id="利用-configmap-解偶配置">利用 ConfigMap 解偶配置</h2>
<p>configmap 是一个键值对的表，不同的命名空间下可以有同名的 configmap，通过这种方式将配置和 pod 定义分离开来。</p>
<p>创建 configmap 的多种来源以及最终存储的值:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>k create configmap my-config --from-file<span style="color:#ce5c00;font-weight:bold">=</span>foo.json --from-file<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">bar</span><span style="color:#ce5c00;font-weight:bold">=</span>foobar.conf --from-file<span style="color:#ce5c00;font-weight:bold">=</span>config-opts/ --from-literal<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">some</span><span style="color:#ce5c00;font-weight:bold">=</span>thing
</span></span></code></pre></div><p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com//2021-02-13-112953.png" alt=""></p>
<p>如果创建的 Pod 中引用的 configMap 不存在，那么引用 configmap 的容器会启动失败，其他容器能够正常启动。
如果被引用的 configmap 后续又被正常创建了，那么失败的容器后面又可以重新成功运行。</p>
<p><strong>注意:</strong></p>
<p><code>envFrom</code> 可以将 configmap 中的配置项设置为环境变量，如果配置项的名称不是一个合法的环境变量名(数字字母+下划线)，那么这个环境变量在创建时就会被自动忽略，且不会发出任何事件通知。</p>
<ul>
<li>从本地文件创建 configmap</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># configmap-files 是本地的一个文件夹</span>
</span></span><span style="display:flex;"><span>ø&gt; k create configmap fortune-config --from-file<span style="color:#ce5c00;font-weight:bold">=</span>configmap-files
</span></span><span style="display:flex;"><span>configmap/fortune-config created
</span></span></code></pre></div><ul>
<li>检查创建的 configmap 的配置项</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>ø&gt; k get configmap fortune-config -o<span style="color:#ce5c00;font-weight:bold">=</span>yaml
</span></span><span style="display:flex;"><span>apiVersion: v1
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 注意，配置项中的管道符号`|`表示配置项的值是一个多行字面量</span>
</span></span><span style="display:flex;"><span>data:
</span></span><span style="display:flex;"><span>  my-nginx-config.conf: <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span>    server <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        listen 80<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        server_name kubia.example.com<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        gzip on<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        gzip_types text/plain application/xml<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        location / <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            root /usr/share/nginx/html<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>            index index.html index.htm<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  sleep-interval: <span style="color:#000;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span>    <span style="color:#0000cf;font-weight:bold">25</span>
</span></span><span style="display:flex;"><span>kind: ConfigMap
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  creationTimestamp: <span style="color:#4e9a06">&#34;2021-02-14T07:09:19Z&#34;</span>
</span></span><span style="display:flex;"><span>  name: fortune-config
</span></span><span style="display:flex;"><span>  namespace: default
</span></span><span style="display:flex;"><span>  resourceVersion: <span style="color:#4e9a06">&#34;15400246&#34;</span>
</span></span><span style="display:flex;"><span>  selfLink: /api/v1/namespaces/default/configmaps/fortune-config
</span></span><span style="display:flex;"><span>  uid: a0925cca-bf39-4e67-9cd9-c5a6ea1eae83
</span></span></code></pre></div><ul>
<li>配置卷是通过挂载的方式加入到容器上的，挂载某一文件夹会隐藏该文件夹中已存在的文件。</li>
</ul>
<p>mountPath 和 subPath 选项可以指定只挂载文件，而不挂载整个文件夹，这样容器的文件夹就不会覆盖了。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">containers</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">image</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">some/image</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">volumeMounts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">myvolume</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#8f5902;font-style:italic"># 只挂载某个文件，而不是挂载一个文件夹</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">mountPath</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/etc/someconfig.conf</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">subPath</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">myconfig.conf</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><ul>
<li>更新配置且不重启容器</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># edit 命令可以修改 configmap 中的配置文件</span>
</span></span><span style="display:flex;"><span>ø&gt; k edit configmap fortune-config
</span></span><span style="display:flex;"><span>configmap/fortune-config edited
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 修改完配置后，再通知 nginx 重启应用</span>
</span></span><span style="display:flex;"><span>ø&gt; k <span style="color:#204a87">exec</span> -it -c web-server fortune-configmap-volume -- nginx -s reload
</span></span><span style="display:flex;"><span>2021/02/16 03:39:49 <span style="color:#ce5c00;font-weight:bold">[</span>notice<span style="color:#ce5c00;font-weight:bold">]</span> 43#43: signal process started
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 这样我们就达到了不重启容器更新配置的目的</span>
</span></span></code></pre></div><p><strong>注意</strong>: configmap 更新时，不同的容器同步配置文件的时间是不同的，因此有可能出现容器间配置文件不一致的情况。</p>
<p>我们可以看到，被挂载的文件链接到了 <code>..data</code> 文件夹中，而 <code>..data</code> 文件夹又是一个软连接。</p>
<p>k8s 在更新文件的时候，会先创建好新的文件，再修改 <code>..data</code> 的链接，这样就达到了一次性更新所有文件的目的。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>ø&gt; k <span style="color:#204a87">exec</span> -it -c web-server fortune-configmap-volume -- ls -lA /etc/nginx/conf.d/               11:42:58 <span style="color:#ce5c00;font-weight:bold">(</span>02-16<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>total <span style="color:#0000cf;font-weight:bold">4</span>
</span></span><span style="display:flex;"><span>drwxr-xr-x    <span style="color:#0000cf;font-weight:bold">2</span> root     root          <span style="color:#0000cf;font-weight:bold">4096</span> Feb <span style="color:#0000cf;font-weight:bold">16</span> 03:39 ..2021_02_16_03_39_25.637552423
</span></span><span style="display:flex;"><span>lrwxrwxrwx    <span style="color:#0000cf;font-weight:bold">1</span> root     root            <span style="color:#0000cf;font-weight:bold">31</span> Feb <span style="color:#0000cf;font-weight:bold">16</span> 03:39 ..data -&gt; ..2021_02_16_03_39_25.637552423
</span></span><span style="display:flex;"><span>lrwxrwxrwx    <span style="color:#0000cf;font-weight:bold">1</span> root     root            <span style="color:#0000cf;font-weight:bold">16</span> Feb <span style="color:#0000cf;font-weight:bold">16</span> 03:30 gzip.conf -&gt; ..data/gzip.conf
</span></span></code></pre></div><h2 id="使用-secret-给容器传递敏感数据">使用 Secret 给容器传递敏感数据</h2>
<p>Secret 是一种类似与 Configmap 的资源，它存储的也是键值对的映射，它支持:</p>
<ol>
<li>将 Secret 条目作为环境变量传递给容器</li>
<li>将 Secret 条目暴露为卷中的文件</li>
</ol>
<p>同时，为了保证 Secret 的安全性，k8s 仅仅将 Secret 分发到需要访问 Secret 的 pod 的所在节点上，同时，Secert 只会写到节点的内存上，不会写到物理存储上。</p>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-b6b4be05877fe20db89592154fb3a5a3">10.1.4 - 6-volume</h1>
    
	<blockquote>
<p>卷: 将磁盘挂载到容器</p>
</blockquote>
<hr>
<h2 id="介绍卷">介绍卷</h2>
<ul>
<li>
<p>卷被定义为 Pod 的一部分，且和 Pod 拥有相同的生命周期。在重启容器之后，新容器可以识别前一个容器写入卷的所有文件。
另外，如果一个 Pod 包含有多个容器，那么这个卷可以同时被 Pod 内的所有容器使用。</p>
</li>
<li>
<p>填充或装入卷的过程是在 Pod 内的容器启动之前执行的。</p>
</li>
<li>
<p>卷被绑定到 Pod 的生命周期中，只有在 Pod 存在时才会存在，但是取决于卷的类型，某些类型下，即使在 Pod 和 卷消失之后，卷的文件也可能保持和原样，并可以挂载到新的卷中。</p>
</li>
</ul>
<h2 id="通过卷在容器之间共享数据">通过卷在容器之间共享数据</h2>
<h3 id="使用-emptydir-卷">使用 emptyDir 卷</h3>
<p><code>emptyDir</code>卷提供一个空目录，供 pod 内的应用程序写入。<code>emptyDir</code> 卷的生命周期和 Pod 的生命周期相关联，所以当删除 Pod 时，卷的内容就会丢失。</p>
<ul>
<li>构建 fortune 镜像</li>
</ul>
<p><a href="https://github.com/bwangelme/k8s-in-actions/tree/master/fortune">Dockerfile 及容器入口文件</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>docker build -t bwangel/fortune .
</span></span><span style="display:flex;"><span>docker push bwangel/fortune
</span></span></code></pre></div><p>emptyDir 卷是在承载 Pod 的工作节点的实际磁盘上创建的，因此其性能取决与节点磁盘的类型，我们也可以通知 k8s 在 tmfs 文件系统(存在内存而非磁盘)上创建 emptyDir。只需要修改卷的 <code>medium</code> 设置即可:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">volumes</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">html</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">emptyDir</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">medium</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Memory</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h3 id="通过端口转发访问-pod">通过端口转发访问 Pod</h3>
<ul>
<li>fortune-pod.yaml</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Pod</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">fortune</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">containers</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">image</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">bwangel/fortune</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">html-generator</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">volumeMounts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">html</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">mountPath</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/var/htdocs</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">image</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nginx:alpine</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">web-server</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">volumeMounts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">html</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">mountPath</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/usr/share/nginx/html</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">readOnly</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">volumes</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">html</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">emptyDir</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>下面的命令创建了一个 fortune 的 Pod，并设置了本地端口8080 转发到 fortune Pod 的 80 端口</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ k create -f fortune-pod.yaml
</span></span><span style="display:flex;"><span>$ k port-forward fortune 8080:8080
</span></span><span style="display:flex;"><span>$ http localhost:8080
</span></span><span style="display:flex;"><span>HTTP/1.1 <span style="color:#0000cf;font-weight:bold">200</span> OK
</span></span><span style="display:flex;"><span>Accept-Ranges: bytes
</span></span><span style="display:flex;"><span>Connection: keep-alive
</span></span><span style="display:flex;"><span>Content-Length: <span style="color:#0000cf;font-weight:bold">24</span>
</span></span><span style="display:flex;"><span>Content-Type: text/html
</span></span><span style="display:flex;"><span>Date: Tue, <span style="color:#0000cf;font-weight:bold">05</span> Jan <span style="color:#0000cf;font-weight:bold">2021</span> 00:38:47 GMT
</span></span><span style="display:flex;"><span>ETag: <span style="color:#4e9a06">&#34;5ff3b512-18&#34;</span>
</span></span><span style="display:flex;"><span>Last-Modified: Tue, <span style="color:#0000cf;font-weight:bold">05</span> Jan <span style="color:#0000cf;font-weight:bold">2021</span> 00:38:42 GMT
</span></span><span style="display:flex;"><span>Server: nginx/1.19.6
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>You now have Asian Flu.
</span></span></code></pre></div><h3 id="通过-loadbalancer-服务来访问-pod">通过 LoadBalancer 服务来访问 Pod</h3>
<ul>
<li>webview-svc.yaml</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ReplicationController</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">webview</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">replicas</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">template</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">webview-v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">labels</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">app</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">webview</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">containers</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:bold">image</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">bwangel/fortune</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">html-generator</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">volumeMounts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">html</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">mountPath</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/var/htdocs</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:bold">image</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">nginx:alpine</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">web-server</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">volumeMounts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">html</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">mountPath</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/usr/share/nginx/html</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">readOnly</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">volumes</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">html</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">emptyDir</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span>{}<span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#000">---</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Service</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">webview</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">LoadBalancer</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">selector</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">app</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">webview</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">ports</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:bold">port</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">80</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">targetPort</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">80</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>下面的命令创建了一个名为 webview 的 Loadbalancer 服务和一个名为 webview 的 RC，我们可以通过 LoadBalancer 的外部IP 访问到 Pod。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>ø&gt; k create -f 6chapter/webview-svc.yaml
</span></span><span style="display:flex;"><span>ø&gt; k get svc webview
</span></span><span style="display:flex;"><span>NAME      TYPE           CLUSTER-IP    EXTERNAL-IP    PORT<span style="color:#ce5c00;font-weight:bold">(</span>S<span style="color:#ce5c00;font-weight:bold">)</span>        AGE
</span></span><span style="display:flex;"><span>webview   LoadBalancer   10.3.242.84   34.84.233.43   80:31870/TCP   9m21s
</span></span><span style="display:flex;"><span>ø&gt; http 34.84.233.43
</span></span><span style="display:flex;"><span>HTTP/1.1 <span style="color:#0000cf;font-weight:bold">200</span> OK
</span></span><span style="display:flex;"><span>Accept-Ranges: bytes
</span></span><span style="display:flex;"><span>Connection: keep-alive
</span></span><span style="display:flex;"><span>Content-Length: <span style="color:#0000cf;font-weight:bold">51</span>
</span></span><span style="display:flex;"><span>Content-Type: text/html
</span></span><span style="display:flex;"><span>Date: Tue, <span style="color:#0000cf;font-weight:bold">05</span> Jan <span style="color:#0000cf;font-weight:bold">2021</span> 00:43:12 GMT
</span></span><span style="display:flex;"><span>ETag: <span style="color:#4e9a06">&#34;5ff3b61c-33&#34;</span>
</span></span><span style="display:flex;"><span>Last-Modified: Tue, <span style="color:#0000cf;font-weight:bold">05</span> Jan <span style="color:#0000cf;font-weight:bold">2021</span> 00:43:08 GMT
</span></span><span style="display:flex;"><span>Server: nginx/1.19.6
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>You<span style="color:#4e9a06">&#39;ll feel much better once you&#39;</span>ve given up hope.
</span></span></code></pre></div><h2 id="访问工作节点文件系统上的文件">访问工作节点文件系统上的文件</h2>
<p>hostPath 卷可以让 Pod 读取/写入 工作节点的文件系统。</p>
<p>从下面的例子中可以看到，系统的 fluentd-gke-jvbcc Pod 使用 hostPath 卷来读取工作节点上的 <code>/var/log</code> 和 <code>/var/lib/docker/containers</code> 等目录。</p>
<pre tabindex="0"><code>ø&gt; kubectl describe pod fluentd-gke-jvbcc --namespace kube-system
Name:                 fluentd-gke-jvbcc
...
Volumes:
  varrun:
    Type:          HostPath (bare host directory volume)
    Path:          /var/run/google-fluentd
    HostPathType:
  varlog:
    Type:          HostPath (bare host directory volume)
    Path:          /var/log
    HostPathType:
  varlibdockercontainers:
    Type:          HostPath (bare host directory volume)
    Path:          /var/lib/docker/containers
    HostPathType:
  input-config-volume:
    Type:      ConfigMap (a volume populated by a ConfigMap)
    Name:      fluentd-gke-input-config-v1.2.9
    Optional:  false
  config-volume:
    Type:      ConfigMap (a volume populated by a ConfigMap)
    Name:      fluentd-gke-config-v1.2.9
    Optional:  false
  fluentd-gke-token-299pv:
    Type:        Secret (a volume populated by a Secret)
    SecretName:  fluentd-gke-token-299pv
    Optional:    false
...
</code></pre><h2 id="使用持久化存储">使用持久化存储</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 创建 GCE 持久磁盘存储</span>
</span></span><span style="display:flex;"><span>gcloud compute disks create --size<span style="color:#ce5c00;font-weight:bold">=</span>10Gib --zone<span style="color:#ce5c00;font-weight:bold">=</span>asia-northeast1-a mongodb
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 下面的命令可以查看 Pod 被调度到了哪一个节点上</span>
</span></span><span style="display:flex;"><span>ø&gt; k get pod -o wide gitrepo-volume-pod
</span></span><span style="display:flex;"><span>NAME                 READY   STATUS    RESTARTS   AGE   IP         NODE                                   NOMINATED NODE   READINESS GATES
</span></span><span style="display:flex;"><span>gitrepo-volume-pod   1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          31h   10.0.0.7   gke-kubia-default-pool-83589229-zfw4   &lt;none&gt;           &lt;none&gt;
</span></span></code></pre></div><ul>
<li>mongodb-pod-gcepd.yaml</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Pod</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">mongodb</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">volumes</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">mongodb-data</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># 声明卷的类型和它使用的文件系统</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">gcePersistentDisk</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">pdName</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">mongodb</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">fsType</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ext4</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">containers</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">image</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">mongo</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">mongodb</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># 根据卷的名字将卷挂载到容器上</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">volumeMounts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">mongodb-data</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">mountPath</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/data/db</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">ports</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:bold">containerPort</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">27017</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">protocol</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">TCP</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><ul>
<li>操作实录</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 创建 mongodb Pod</span>
</span></span><span style="display:flex;"><span>ø&gt; k create -f 6chapter/mongodb-pod-gcepd.yaml
</span></span><span style="display:flex;"><span>pod/mongodb created
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 查看 Pod 状态，已经成功运行了</span>
</span></span><span style="display:flex;"><span>ø&gt; k get pods mongodb
</span></span><span style="display:flex;"><span>NAME                 READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>mongodb              1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          60s
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 登录 Mongodb 数据库</span>
</span></span><span style="display:flex;"><span>ø&gt; k <span style="color:#204a87">exec</span> -it mongodb -- mongo
</span></span><span style="display:flex;"><span>&gt; use mystore
</span></span><span style="display:flex;"><span>switched to db mystore
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 向数据库中写入数据</span>
</span></span><span style="display:flex;"><span>&gt; db.foo.insert<span style="color:#ce5c00;font-weight:bold">({</span><span style="color:#4e9a06">&#39;name&#39;</span>: <span style="color:#4e9a06">&#39;foo&#39;</span><span style="color:#ce5c00;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>WriteResult<span style="color:#ce5c00;font-weight:bold">({</span> <span style="color:#4e9a06">&#34;nInserted&#34;</span> : <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>&gt; db.foo.find<span style="color:#ce5c00;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">{</span> <span style="color:#4e9a06">&#34;_id&#34;</span> : ObjectId<span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;5ff64ad47af44ac9535a9abe&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>, <span style="color:#4e9a06">&#34;name&#34;</span> : <span style="color:#4e9a06">&#34;foo&#34;</span> <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>&gt;
</span></span><span style="display:flex;"><span>bye
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 删除 Pod 并重建</span>
</span></span><span style="display:flex;"><span>ø&gt; k delete pod mongodb
</span></span><span style="display:flex;"><span>pod <span style="color:#4e9a06">&#34;mongodb&#34;</span> deleted
</span></span><span style="display:flex;"><span>ø&gt; k create -f 6chapter/mongodb-pod-gcepd.yaml
</span></span><span style="display:flex;"><span>pod/mongodb created
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 重新登录 MongoDB 进行查找，发现之前创建的记录还在</span>
</span></span><span style="display:flex;"><span>ø&gt; k <span style="color:#204a87">exec</span> -it mongodb -- mongo
</span></span><span style="display:flex;"><span>&gt; use mystore
</span></span><span style="display:flex;"><span>switched to db mystore
</span></span><span style="display:flex;"><span>&gt; db.foo.find<span style="color:#ce5c00;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">{</span> <span style="color:#4e9a06">&#34;_id&#34;</span> : ObjectId<span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;5ff64ad47af44ac9535a9abe&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>, <span style="color:#4e9a06">&#34;name&#34;</span> : <span style="color:#4e9a06">&#34;foo&#34;</span> <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>&gt;
</span></span><span style="display:flex;"><span>bye
</span></span></code></pre></div><h2 id="从底层技术解耦-pod">从底层技术解耦 Pod</h2>
<h3 id="持久卷和持久卷声明的工作模式">持久卷和持久卷声明的工作模式</h3>
<p>Persistent Volume(PV)，持久卷，管理员声明的一种和存储系统绑定的资源。</p>
<p>持久卷不属于任何命名空间，它和节点一样，是集群层面的资源。</p>
<p>Persitent Volume Claim(PVC)，持久卷声明，开发人员声明的一种持久卷资源请求，K8S 将会根据 PVC 中的声明，分配合适的持久卷资源和 PVC 绑定起来。</p>
<p>PVC 状态说明:</p>
<ul>
<li>RWO &ndash; ReadWriteOnce  仅允许单个节点的挂载读写</li>
<li>ROX &ndash; ReadOnlyMany  允许多个节点的挂载只读</li>
<li>RWX &ndash; ReadWriteMany 允许多个节点挂载读写这个卷</li>
</ul>
<p><strong>注意:</strong> RWO, ROX, RWX 涉及可以同时使用卷的 <strong>工作节点</strong> 的数量而非 Pod 的数量。</p>
<p>PVC 只能在特定命名空间中创建，且只能被这个命名空间的 Pod 使用。</p>
<p>它们的工作模式:</p>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com//2021-01-07-091724.png" alt=""></p>
<h3 id="创建持久卷">创建持久卷</h3>
<ul>
<li>mongodb-pv-gcepd.yaml</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">PersistentVolume</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">mongodb-pv</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">capacity</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">storage</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">10Gi</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># 声明持久卷的访问模式，单节点读写和多节点只读</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">accessModes</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">ReadWriteOnce</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">ReadOnlyMany</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># pvc 删除后，保留 pv</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">persistentVolumeReclaimPolicy</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Retain</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">gcePersistentDisk</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">pdName</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">mongodb</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">fsType</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ext4</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>ø&gt; k create -f 6chapter/mongodb-pv-gcepd.yaml
</span></span><span style="display:flex;"><span>persistentvolume/mongodb-pv created
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 查看持久卷，可以看到持久卷的状态是 Available</span>
</span></span><span style="display:flex;"><span>ø&gt; k get pv
</span></span><span style="display:flex;"><span>NAME         CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM   STORAGECLASS   REASON   AGE
</span></span><span style="display:flex;"><span>mongodb-pv   10Gi       RWO,ROX        Retain           Available                                   3s
</span></span></code></pre></div><h3 id="创建持久卷声明">创建持久卷声明</h3>
<ul>
<li>mongodb-pvc.yaml</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">PersistentVolumeClaim</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">mongodb-pvc</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># 声明需要的 pv 的特征，存储是1Gi，访问模式是单节点读写</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">resources</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">requests</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">storage</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">1Gi</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">accessModes</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#000">ReadWriteOnce</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">storageClassName</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 创建 pvc</span>
</span></span><span style="display:flex;"><span>ø&gt; k create -f 6chapter/mongodb-pvc.yaml
</span></span><span style="display:flex;"><span>persistentvolumeclaim/mongodb-pvc created
</span></span><span style="display:flex;"><span>ø&gt; k get pvc
</span></span><span style="display:flex;"><span>NAME          STATUS   VOLUME       CAPACITY   ACCESS MODES   STORAGECLASS   AGE
</span></span><span style="display:flex;"><span>mongodb-pvc   Bound    mongodb-pv   10Gi       RWO,ROX                       3s
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 查看pv，可以看到它的状态已经变成了 Bound，且被绑定到了 default/mongodb-pvc 上</span>
</span></span><span style="display:flex;"><span>ø&gt; k get pv
</span></span><span style="display:flex;"><span>NAME         CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                 STORAGECLASS   REASON   AGE
</span></span><span style="display:flex;"><span>mongodb-pv   10Gi       RWO,ROX        Retain           Bound    default/mongodb-pvc                           3m51s
</span></span></code></pre></div><h3 id="在-pod-中使用-持久卷声明">在 Pod 中使用 持久卷声明</h3>
<ul>
<li>mongodb-pod-pvc.yaml</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Pod</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">mongodb</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">containers</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">image</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">mongo</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">mongodb</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">volumeMounts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">mongodb-data</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">mountPath</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/data/db</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">ports</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:bold">containerPort</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">27017</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">protocol</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">TCP</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># 将刚刚创建的 PVC 声明为一种卷</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">volumes</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">mongodb-data</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">persistentVolumeClaim</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">claimName</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">mongodb-pvc</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 创建 Pod</span>
</span></span><span style="display:flex;"><span>ø&gt; k create -f 6chapter/mongodb-pod-pvc.yaml
</span></span><span style="display:flex;"><span>pod/mongodb created
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 登录 mongodb，查询我们之前创建的数据</span>
</span></span><span style="display:flex;"><span>ø&gt; k <span style="color:#204a87">exec</span> -it mongodb -- mongo
</span></span><span style="display:flex;"><span>&gt; use mystore
</span></span><span style="display:flex;"><span>switched to db mystore
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 可以看到之前创建的数据仍然存在</span>
</span></span><span style="display:flex;"><span>&gt; db.foo.find<span style="color:#ce5c00;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">{</span> <span style="color:#4e9a06">&#34;_id&#34;</span> : ObjectId<span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;5ff64ad47af44ac9535a9abe&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>, <span style="color:#4e9a06">&#34;name&#34;</span> : <span style="color:#4e9a06">&#34;foo&#34;</span> <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>&gt;
</span></span><span style="display:flex;"><span>bye
</span></span></code></pre></div><h3 id="删除持久卷声明">删除持久卷声明</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>ø&gt; k delete pod mongodb
</span></span><span style="display:flex;"><span>pod <span style="color:#4e9a06">&#34;mongodb&#34;</span> deleted
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">2598</span> <span style="color:#ce5c00;font-weight:bold">(</span>lazyubuntu<span style="color:#ce5c00;font-weight:bold">)</span> ~/Github/k8s-in-actions <span style="color:#ce5c00;font-weight:bold">(</span>master<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>ø&gt; k delete pvc mongodb-pvc
</span></span><span style="display:flex;"><span>persistentvolumeclaim <span style="color:#4e9a06">&#34;mongodb-pvc&#34;</span> deleted
</span></span><span style="display:flex;"><span>ø&gt; k get pv
</span></span><span style="display:flex;"><span>NAME         CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS     CLAIM                 STORAGECLASS   REASON   AGE
</span></span><span style="display:flex;"><span>mongodb-pv   10Gi       RWO,ROX        Retain           Released   default/mongodb-pvc                           12m
</span></span></code></pre></div><p>当我们删除 PVC 之后，可以看到 PV 没有变成可用的状态，而是变成了 <code>Released</code> 状态。这是因为我们在创建 PV 时声明它的 <code>RECLAIM POLICY</code> 是 <code>Retain</code> 。此时需要系统管理员来确定 PV 中的数据是否还可用，手动回收卷并更改其状态，然后这个PV才能够被重新使用。</p>
<h2 id="持久卷的动态配置">持久卷的动态配置</h2>
<p>StorageClass 是一种集群资源，它绑定了一个 <strong>制备程序</strong> ，可以根据 PVC 的申请，来动态地创建 PV 并绑定到实际的存储上。</p>
<ul>
<li>持久卷动态配置的完整图示</li>
</ul>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com//2021-01-08-073419.png" alt=""></p>
<ul>
<li>k8s 中有个默认的存储类 (StorageClass) <code>standard</code>，如果 PVC 声明中没有指定存储类，那就使用这个默认的存储类来创建 PV 。</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>ø&gt; k get sc standard -o yaml
</span></span><span style="display:flex;"><span>allowVolumeExpansion: <span style="color:#204a87">true</span>
</span></span><span style="display:flex;"><span>apiVersion: storage.k8s.io/v1
</span></span><span style="display:flex;"><span>kind: StorageClass
</span></span><span style="display:flex;"><span>metadata:
</span></span><span style="display:flex;"><span>  annotations:
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># 这个注解声明它是默认的存储类</span>
</span></span><span style="display:flex;"><span>    storageclass.kubernetes.io/is-default-class: <span style="color:#4e9a06">&#34;true&#34;</span>
</span></span><span style="display:flex;"><span>  creationTimestamp: <span style="color:#4e9a06">&#34;2021-01-03T16:26:12Z&#34;</span>
</span></span><span style="display:flex;"><span>  labels:
</span></span><span style="display:flex;"><span>    addonmanager.kubernetes.io/mode: EnsureExists
</span></span><span style="display:flex;"><span>  name: standard
</span></span><span style="display:flex;"><span>  resourceVersion: <span style="color:#4e9a06">&#34;263&#34;</span>
</span></span><span style="display:flex;"><span>  selfLink: /apis/storage.k8s.io/v1/storageclasses/standard
</span></span><span style="display:flex;"><span>  uid: 278b918a-466e-454b-bab4-f25833314feb
</span></span><span style="display:flex;"><span>parameters:
</span></span><span style="display:flex;"><span>  type: pd-standard
</span></span><span style="display:flex;"><span>provisioner: kubernetes.io/gce-pd  <span style="color:#8f5902;font-style:italic"># 这是它所配置的制备程序</span>
</span></span><span style="display:flex;"><span>reclaimPolicy: Delete  <span style="color:#8f5902;font-style:italic"># 声明创建的 PV 的使用策略</span>
</span></span><span style="display:flex;"><span>volumeBindingMode: Immediate
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-aaeea77df4520e5dfdc2d4246e2cdb1a">10.1.5 - 5-service</h1>
    
	<blockquote>
<p>服务：让客户端发现 Pod 并与之通信</p>
</blockquote>
<hr>
<h2 id="介绍服务">介绍服务</h2>
<p>K8S 服务是一种 <strong>为一组功能相同的 Pod 提供单一不变的接入点</strong> 的资源。</p>
<ul>
<li>kubia-svc.yaml</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Service</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kubia</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># 会话亲和性，即相同的客户端IP访问同一个 Pod</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">sessionAffinity</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ClientIP</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># 指定服务转发的端口</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">ports</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:bold">port</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">80</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">http-default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">targetPort</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">http-default</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:bold">port</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">90</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">http-mux1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">targetPort</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">http-mux1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># 查找 Pod 的标签，注意 svc 不会自动创建 Pod，需要先通过 ReplicaSet 创建好 Pod</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">selector</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">app</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kubia</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 创建服务</span>
</span></span><span style="display:flex;"><span>ø&gt; kubectl create -f kubia-svc.yaml
</span></span><span style="display:flex;"><span>service/kuia created
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 查看我们刚刚创建的服务</span>
</span></span><span style="display:flex;"><span>ø&gt; kubectl get svc
</span></span><span style="display:flex;"><span>NAME         TYPE        CLUSTER-IP     EXTERNAL-IP   PORT<span style="color:#ce5c00;font-weight:bold">(</span>S<span style="color:#ce5c00;font-weight:bold">)</span>         AGE
</span></span><span style="display:flex;"><span>kubia        ClusterIP   10.66.13.240   &lt;none&gt;        80/TCP,90/TCP   8m48s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 到某个 Pod 上执行 curl 命令，访问服务的集群内部端口</span>
</span></span><span style="display:flex;"><span>ø&gt; kubectl <span style="color:#204a87">exec</span> kubia-zhg6k -- curl -s 10.66.13.240:80
</span></span><span style="display:flex;"><span>You<span style="color:#4e9a06">\&#39;</span>ve hit kubia-4bv25 on default mux
</span></span><span style="display:flex;"><span>ø&gt; kubectl <span style="color:#204a87">exec</span> kubia-zhg6k -- curl -s 10.66.13.240:90
</span></span><span style="display:flex;"><span>You<span style="color:#4e9a06">\&#39;</span>ve hit kubia-7sd67 on mux1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 注意，服务的IP是虚拟IP，是 ping 不通的</span>
</span></span><span style="display:flex;"><span>ø&gt; kubectl <span style="color:#204a87">exec</span> -it kubia-zhg6k bash
</span></span><span style="display:flex;"><span>root@kubia-zhg6k:/app# ping 10.66.13.240
</span></span><span style="display:flex;"><span>PING 10.66.13.240 <span style="color:#ce5c00;font-weight:bold">(</span>10.66.13.240<span style="color:#ce5c00;font-weight:bold">)</span> 56<span style="color:#ce5c00;font-weight:bold">(</span>84<span style="color:#ce5c00;font-weight:bold">)</span> bytes of data.
</span></span><span style="display:flex;"><span>^C
</span></span><span style="display:flex;"><span>--- 10.66.13.240 ping statistics ---
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">8</span> packets transmitted, <span style="color:#0000cf;font-weight:bold">0</span> received, 100% packet loss, <span style="color:#204a87">time</span> 205ms
</span></span></code></pre></div><h3 id="通过环境变量发现服务">通过环境变量发现服务</h3>
<p>在 Pod 开始运行的时候，K8S 会初始化一系列的环境变指向现在存在的服务。(故 Pod 要在服务之后创建才能够看到这些环境变量)</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 当前集群中存在着两个服务</span>
</span></span><span style="display:flex;"><span>ø&gt; kubectl get svc
</span></span><span style="display:flex;"><span>NAME         TYPE        CLUSTER-IP     EXTERNAL-IP   PORT<span style="color:#ce5c00;font-weight:bold">(</span>S<span style="color:#ce5c00;font-weight:bold">)</span>         AGE
</span></span><span style="display:flex;"><span>kubernetes   ClusterIP   10.66.0.1      &lt;none&gt;        443/TCP         31d
</span></span><span style="display:flex;"><span>kubia        ClusterIP   10.66.13.240   &lt;none&gt;        80/TCP,90/TCP   9h
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ø&gt; kubectl <span style="color:#204a87">exec</span> kubia-zhg6k -- env
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># KUBIA 服务的环境变量</span>
</span></span><span style="display:flex;"><span><span style="color:#000">KUBIA_SERVICE_HOST</span><span style="color:#ce5c00;font-weight:bold">=</span>10.66.13.240
</span></span><span style="display:flex;"><span><span style="color:#000">KUBIA_SERVICE_PORT</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">80</span>
</span></span><span style="display:flex;"><span><span style="color:#000">KUBIA_PORT_80_TCP_PROTO</span><span style="color:#ce5c00;font-weight:bold">=</span>tcp
</span></span><span style="display:flex;"><span><span style="color:#000">KUBIA_PORT_80_TCP_ADDR</span><span style="color:#ce5c00;font-weight:bold">=</span>10.66.13.240
</span></span><span style="display:flex;"><span><span style="color:#000">KUBIA_SERVICE_PORT_HTTP_DEFAULT</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">80</span>
</span></span><span style="display:flex;"><span><span style="color:#000">KUBIA_PORT</span><span style="color:#ce5c00;font-weight:bold">=</span>tcp://10.66.13.240:80
</span></span><span style="display:flex;"><span><span style="color:#000">KUBIA_PORT_90_TCP</span><span style="color:#ce5c00;font-weight:bold">=</span>tcp://10.66.13.240:90
</span></span><span style="display:flex;"><span><span style="color:#000">KUBIA_PORT_90_TCP_PORT</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">90</span>
</span></span><span style="display:flex;"><span><span style="color:#000">KUBIA_SERVICE_PORT_HTTP_MUX1</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">90</span>
</span></span><span style="display:flex;"><span><span style="color:#000">KUBIA_PORT_80_TCP</span><span style="color:#ce5c00;font-weight:bold">=</span>tcp://10.66.13.240:80
</span></span><span style="display:flex;"><span><span style="color:#000">KUBIA_PORT_80_TCP_PORT</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">80</span>
</span></span><span style="display:flex;"><span><span style="color:#000">KUBIA_PORT_90_TCP_PROTO</span><span style="color:#ce5c00;font-weight:bold">=</span>tcp
</span></span><span style="display:flex;"><span><span style="color:#000">KUBIA_PORT_90_TCP_ADDR</span><span style="color:#ce5c00;font-weight:bold">=</span>10.66.13.240
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Kubernetes 服务的环境变量</span>
</span></span><span style="display:flex;"><span><span style="color:#000">KUBERNETES_SERVICE_PORT_HTTPS</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">443</span>
</span></span><span style="display:flex;"><span><span style="color:#000">KUBERNETES_SERVICE_HOST</span><span style="color:#ce5c00;font-weight:bold">=</span>10.66.0.1
</span></span><span style="display:flex;"><span><span style="color:#000">KUBERNETES_PORT_443_TCP</span><span style="color:#ce5c00;font-weight:bold">=</span>tcp://10.66.0.1:443
</span></span><span style="display:flex;"><span><span style="color:#000">KUBERNETES_PORT_443_TCP_ADDR</span><span style="color:#ce5c00;font-weight:bold">=</span>10.66.0.1
</span></span><span style="display:flex;"><span><span style="color:#000">KUBERNETES_SERVICE_PORT</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">443</span>
</span></span><span style="display:flex;"><span><span style="color:#000">KUBERNETES_PORT</span><span style="color:#ce5c00;font-weight:bold">=</span>tcp://10.66.0.1:443
</span></span><span style="display:flex;"><span><span style="color:#000">KUBERNETES_PORT_443_TCP_PROTO</span><span style="color:#ce5c00;font-weight:bold">=</span>tcp
</span></span><span style="display:flex;"><span><span style="color:#000">KUBERNETES_PORT_443_TCP_PORT</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">443</span>
</span></span></code></pre></div><h3 id="通过-dns-发现服务">通过 DNS 发现服务</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 在 kube-system 命名空间中存在着提供 DNS 服务的 Pod</span>
</span></span><span style="display:flex;"><span>ø&gt; kcd kube-system
</span></span><span style="display:flex;"><span>Context <span style="color:#4e9a06">&#34;gke_braided-turbine-271114_asia-east1-c_demo&#34;</span> modified.
</span></span><span style="display:flex;"><span>ø&gt; kubectl get pod
</span></span><span style="display:flex;"><span>NAME                                             READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>kube-dns-5f886bf8d8-ddzjb                        4/4     Running   <span style="color:#0000cf;font-weight:bold">0</span>          24d
</span></span><span style="display:flex;"><span>kube-dns-5f886bf8d8-pnrts                        4/4     Running   <span style="color:#0000cf;font-weight:bold">0</span>          26d
</span></span><span style="display:flex;"><span>kube-dns-autoscaler-8687c64fc-qknwj              1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          24d
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 所有 Pod 都默认使用了集群中的 DNS 服务器</span>
</span></span><span style="display:flex;"><span>ø&gt; kubectl <span style="color:#204a87">exec</span> -it kubia-zhg6k bash
</span></span><span style="display:flex;"><span>root@kubia-zhg6k:/app# cat /etc/resolv.conf
</span></span><span style="display:flex;"><span>nameserver 10.66.0.10
</span></span><span style="display:flex;"><span>search default.svc.cluster.local svc.cluster.local cluster.local asia-east1-c.c.braided-turbine-271114.internal c.braided-turbine-271114.internal google.internal
</span></span><span style="display:flex;"><span>options ndots:5
</span></span></code></pre></div><p>集群中的任何一个节点可以通过 全限定域名(FQDN) 来访问服务，它的格式如下:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>kubia.default.svc.cluster.local
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">{</span>服务名称<span style="color:#ce5c00;font-weight:bold">}</span>.<span style="color:#ce5c00;font-weight:bold">{</span>命名空间<span style="color:#ce5c00;font-weight:bold">}</span>.<span style="color:#ce5c00;font-weight:bold">{</span>集群域后缀<span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 集群域后缀可以省略，命名空间是默认的话也可以省略</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 在任意一个节点上通过 FQDN 访问服务</span>
</span></span><span style="display:flex;"><span>root@kubia-zhg6k:/app# curl kubia.default.svc.cluster.local:<span style="color:#000">$KUBIA_SERVICE_PORT_HTTP_MUX1</span>
</span></span><span style="display:flex;"><span>You<span style="color:#a40000">&#39;</span>ve hit kubia-4bv25 on mux1
</span></span><span style="display:flex;"><span>root@kubia-zhg6k:/app# curl kubia.default:<span style="color:#000">$KUBIA_SERVICE_PORT_HTTP_MUX1</span>
</span></span><span style="display:flex;"><span>You got it on mux1, 5.
</span></span><span style="display:flex;"><span>root@kubia-zhg6k:/app# curl kubia:<span style="color:#000">$KUBIA_SERVICE_PORT_HTTP_MUX1</span>
</span></span><span style="display:flex;"><span>You got it on mux1, 6.
</span></span></code></pre></div><h2 id="连接集群外部的服务">连接集群外部的服务</h2>
<p>Endpoints 是一种介于服务和 Pod 之间的资源，它是一个存储服务的转发 IP 及端口的列表。它和对应的服务同名。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 查看某个服务的 Endpoints 资源</span>
</span></span><span style="display:flex;"><span>ø&gt; kubectl describe svc kubia
</span></span><span style="display:flex;"><span>Name:              kubia
</span></span><span style="display:flex;"><span>Namespace:         default
</span></span><span style="display:flex;"><span>Labels:            &lt;none&gt;
</span></span><span style="display:flex;"><span>Annotations:       &lt;none&gt;
</span></span><span style="display:flex;"><span>Selector:          <span style="color:#000">app</span><span style="color:#ce5c00;font-weight:bold">=</span>kubia
</span></span><span style="display:flex;"><span>Type:              ClusterIP
</span></span><span style="display:flex;"><span>IP:                10.66.13.240
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Port:              http-default  80/TCP
</span></span><span style="display:flex;"><span>TargetPort:        http-default/TCP
</span></span><span style="display:flex;"><span>Endpoints:         10.0.1.23:8080,10.0.2.13:8080,10.0.2.14:8080
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Port:              http-mux1  90/TCP
</span></span><span style="display:flex;"><span>TargetPort:        http-mux1/TCP
</span></span><span style="display:flex;"><span>Endpoints:         10.0.1.23:8090,10.0.2.13:8090,10.0.2.14:8090
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Session Affinity:  ClientIP
</span></span><span style="display:flex;"><span>Events:            &lt;none&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 查看 endpoints 的具体信息</span>
</span></span><span style="display:flex;"><span>ø&gt; kubectl get endpoints kubia
</span></span><span style="display:flex;"><span>NAME    ENDPOINTS                                                  AGE
</span></span><span style="display:flex;"><span>kubia   10.0.1.23:8080,10.0.2.13:8080,10.0.2.14:8080 + <span style="color:#0000cf;font-weight:bold">3</span> more...   2d
</span></span><span style="display:flex;"><span>ø&gt; kubectl describe endpoints kubia
</span></span><span style="display:flex;"><span>Name:         kubia
</span></span><span style="display:flex;"><span>Namespace:    default
</span></span><span style="display:flex;"><span>Labels:       &lt;none&gt;
</span></span><span style="display:flex;"><span>Annotations:  &lt;none&gt;
</span></span><span style="display:flex;"><span>Subsets:
</span></span><span style="display:flex;"><span>  Addresses:          10.0.1.23,10.0.2.13,10.0.2.14
</span></span><span style="display:flex;"><span>  NotReadyAddresses:  &lt;none&gt;
</span></span><span style="display:flex;"><span>  Ports:
</span></span><span style="display:flex;"><span>    Name          Port  Protocol
</span></span><span style="display:flex;"><span>    ----          ----  --------
</span></span><span style="display:flex;"><span>    http-default  <span style="color:#0000cf;font-weight:bold">8080</span>  TCP
</span></span><span style="display:flex;"><span>    http-mux1     <span style="color:#0000cf;font-weight:bold">8090</span>  TCP
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Events:  &lt;none&gt;
</span></span></code></pre></div><h3 id="创建一个重定向到外部地址的服务">创建一个重定向到外部地址的服务</h3>
<ul>
<li>external-service.yaml</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 这个文件只创建了一个服务，但是没有定义选择器，也就没有创建对应的 Endpoint 资源</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Service</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">external-service</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">ports</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:bold">port</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">80</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>创建 external-service 的 Endpoints 资源，它指向了两个外部的 IP 地址</p>
<ul>
<li>external-service-endpoints.yaml</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Endpoints</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># 注意要和绑定的目标服务的名称相同</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">external-service</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">subsets</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">addresses</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:bold">ip</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">13.250.94.254</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:bold">ip</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">13.229.188.59</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">ports</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:bold">port</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">80</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>测试:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 客户端访问 external-service 服务会重定向到外部服务上</span>
</span></span><span style="display:flex;"><span>ø&gt; kubectl <span style="color:#204a87">exec</span> -it kubia-zhg6k bash
</span></span><span style="display:flex;"><span>root@kubia-zhg6k:/app# curl -v 10.66.10.171
</span></span><span style="display:flex;"><span>* Expire in <span style="color:#0000cf;font-weight:bold">0</span> ms <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#0000cf;font-weight:bold">6</span> <span style="color:#ce5c00;font-weight:bold">(</span>transfer 0x55b86f259f50<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>*   Trying 10.66.10.171...
</span></span><span style="display:flex;"><span>* TCP_NODELAY <span style="color:#204a87">set</span>
</span></span><span style="display:flex;"><span>* Expire in <span style="color:#0000cf;font-weight:bold">200</span> ms <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#0000cf;font-weight:bold">4</span> <span style="color:#ce5c00;font-weight:bold">(</span>transfer 0x55b86f259f50<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>* Connected to 10.66.10.171 <span style="color:#ce5c00;font-weight:bold">(</span>10.66.10.171<span style="color:#ce5c00;font-weight:bold">)</span> port <span style="color:#0000cf;font-weight:bold">80</span> <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#8f5902;font-style:italic">#0)</span>
</span></span><span style="display:flex;"><span>&gt; GET / HTTP/1.1
</span></span><span style="display:flex;"><span>&gt; Host: 10.66.10.171
</span></span><span style="display:flex;"><span>&gt; User-Agent: curl/7.64.0
</span></span><span style="display:flex;"><span>&gt; Accept: */*
</span></span><span style="display:flex;"><span>&gt;
</span></span><span style="display:flex;"><span>&lt; HTTP/1.1 <span style="color:#0000cf;font-weight:bold">301</span> Moved Permanently
</span></span><span style="display:flex;"><span>&lt; Content-length: <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>&lt; Location: https://10.66.10.171/
</span></span><span style="display:flex;"><span>&lt;
</span></span><span style="display:flex;"><span>* Connection <span style="color:#8f5902;font-style:italic">#0 to host 10.66.10.171 left intact</span>
</span></span></code></pre></div><h3 id="为外部服务创建别名">为外部服务创建别名</h3>
<ul>
<li>external-service-externalname.yaml</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Service</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">external-service-externalname</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ExternalName </span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 外部服务的别名服务需要制定类型为 ExternalName</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">externalName</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">httpbin.org</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">ports</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:bold">port</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">80</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>测试:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 在集群内部可以通过 FQDN 来访问该服务</span>
</span></span><span style="display:flex;"><span>ø&gt; kubectl <span style="color:#204a87">exec</span> -it kubia-zhg6k bash
</span></span><span style="display:flex;"><span>root@kubia-zhg6k:/app# curl external-service-externalname/get
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;args&#34;</span>: <span style="color:#ce5c00;font-weight:bold">{}</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;headers&#34;</span>: <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;Accept&#34;</span>: <span style="color:#4e9a06">&#34;*/*&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;Host&#34;</span>: <span style="color:#4e9a06">&#34;external-service-externalname&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;User-Agent&#34;</span>: <span style="color:#4e9a06">&#34;curl/7.64.0&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;X-Amzn-Trace-Id&#34;</span>: <span style="color:#4e9a06">&#34;Root=1-5ea85513-abbb4098869550459c9a0934&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ce5c00;font-weight:bold">}</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;origin&#34;</span>: <span style="color:#4e9a06">&#34;35.229.134.91&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;url&#34;</span>: <span style="color:#4e9a06">&#34;http://external-service-externalname/get&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>root@kubia-zhg6k:/app# curl external-service-externalname.default.svc.cluster.local/get
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;args&#34;</span>: <span style="color:#ce5c00;font-weight:bold">{}</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;headers&#34;</span>: <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;Accept&#34;</span>: <span style="color:#4e9a06">&#34;*/*&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;Host&#34;</span>: <span style="color:#4e9a06">&#34;external-service-externalname.default.svc.cluster.local&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;User-Agent&#34;</span>: <span style="color:#4e9a06">&#34;curl/7.64.0&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;X-Amzn-Trace-Id&#34;</span>: <span style="color:#4e9a06">&#34;Root=1-5ea8551c-a7ebbeae3b50c9b6c66240c9&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ce5c00;font-weight:bold">}</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;origin&#34;</span>: <span style="color:#4e9a06">&#34;35.229.134.91&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;url&#34;</span>: <span style="color:#4e9a06">&#34;http://external-service-externalname.default.svc.cluster.local/get&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>ExternalName</code> 服务仅在 DNS 级别实施，它仅为服务创建了简单的 CNAME DNS 记录。因此链接到该服务的客户端将直接连接到外部服务，完全绕过服务代理。出于这个原因，<code>ExternalName</code> 类型的服务甚至不会获得集群 IP。</p>
<h2 id="将服务暴露给外部客户端">将服务暴露给外部客户端</h2>
<h3 id="通过-nodeport-类型的服务向外暴露">通过 NodePort 类型的服务向外暴露</h3>
<p>通过创建 NodePort 服务，可以让 Kubernetes 在其所有 <strong>节点</strong> 上保留一个端口(所有节点都使用相同的端口号)，将传入的连接转发给作为服务部分的 Pod。</p>
<h3 id="创建--使用-nodeport-类型的服务">创建 &amp; 使用 NodePort 类型的服务</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 配置 GCK 的防火墙规则，允许外部网络访问 30123 端口</span>
</span></span><span style="display:flex;"><span>ø&gt; gcloud compute firewall-rules create kubia-svc-rule --allow<span style="color:#ce5c00;font-weight:bold">=</span>tcp:30123
</span></span><span style="display:flex;"><span>Creating firewall...⠧Created <span style="color:#ce5c00;font-weight:bold">[</span>https://www.googleapis.com/compute/v1/projects/braided-turbine-271114/global/firewalls/kubia-svc-rule<span style="color:#ce5c00;font-weight:bold">]</span>.
</span></span><span style="display:flex;"><span>Creating firewall...done.
</span></span><span style="display:flex;"><span>NAME            NETWORK  DIRECTION  PRIORITY  ALLOW      DENY  DISABLED
</span></span><span style="display:flex;"><span>kubia-svc-rule  default  INGRESS    <span style="color:#0000cf;font-weight:bold">1000</span>      tcp:30123        False
</span></span></code></pre></div><ul>
<li>kubia-svc-nodeport.yaml</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Service</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kubia-nodeport</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">NodePort</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">ports</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:bold">port</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">80</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 通过集群内部IP访问的端口</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">targetPort</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">8080</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># 转发的背后 Pod 服务的端口</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">nodePort</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">30123</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic"># 集群节点可访问的端口</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">selector</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">app</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kubia</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 创建 NodePort 服务</span>
</span></span><span style="display:flex;"><span>ø&gt; kubectl create -f kubia-svc-nodeport.yaml
</span></span><span style="display:flex;"><span>service/kubia-nodeport created
</span></span><span style="display:flex;"><span>ø&gt; kubectl get svc kubia-nodeport
</span></span><span style="display:flex;"><span>NAME             TYPE       CLUSTER-IP   EXTERNAL-IP   PORT<span style="color:#ce5c00;font-weight:bold">(</span>S<span style="color:#ce5c00;font-weight:bold">)</span>        AGE
</span></span><span style="display:flex;"><span>kubia-nodeport   NodePort   10.66.5.6    &lt;none&gt;        80:30123/TCP   9m39s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 获得所有节点的 IP 地址</span>
</span></span><span style="display:flex;"><span>ø&gt; kubectl get nodes -o <span style="color:#000">jsonpath</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;{.items[*].status.addresses[?(@.type==&#34;ExternalIP&#34;)].address}&#39;</span> <span style="color:#000;font-weight:bold">|</span> tr <span style="color:#4e9a06">&#39; &#39;</span> <span style="color:#4e9a06">&#39;\n&#39;</span>
</span></span><span style="display:flex;"><span>35.234.11.33
</span></span><span style="display:flex;"><span>35.234.27.130
</span></span><span style="display:flex;"><span>35.229.134.91
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 通过节点访问 NodePort 服务</span>
</span></span><span style="display:flex;"><span>ø&gt; curl 35.229.134.91:30123
</span></span><span style="display:flex;"><span>You got it on default mux, 9.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 通过集群内部IP访问 NodePort 服务</span>
</span></span><span style="display:flex;"><span>ø&gt; kubectl <span style="color:#204a87">exec</span> -it kubia-zhg6k bash
</span></span><span style="display:flex;"><span>root@kubia-zhg6k:/app# curl 10.66.5.6:80
</span></span><span style="display:flex;"><span>You got it on default mux, 10.
</span></span></code></pre></div><ul>
<li><a href="https://kubernetes.io/zh/docs/reference/kubectl/jsonpath/">JSON Path 的文档</a></li>
</ul>
<h3 id="通过负载均衡器将服务暴露出来">通过负载均衡器将服务暴露出来</h3>
<p>在云提供商上运行的 Kubernetes 集群通常支持从云基础架构自动提供负载均衡器。通过指定类型为 <code>LoadBalancer</code>，就可以创建一个负载均衡器。
它通常拥有自己独一无二的可公开访问的IP地址，并将所有的连接重定向到服务，可以通过负载均衡器的公开IP地址访问服务。</p>
<p>LoadBalancer 类型的服务是一个具有额外的基础设施提供的负载均衡器 NodePort 服务。使用 <code>kubectl explain</code> 可以看到该服务选择的 <code>NodePort</code> 端口。</p>
<ul>
<li>kubia-svc-loadbalancer.yaml</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Service</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kubia-loadbalancer</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">LoadBalancer</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">ports</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:bold">port</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">80</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">targetPort</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">8080</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">selector</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">app</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kubia</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 创建 loadbalancer 服务</span>
</span></span><span style="display:flex;"><span>ø&gt; kubectl create -f kubia-svc-loadbalancer.yaml
</span></span><span style="display:flex;"><span>service/kubia-loadbalancer created
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 查看创建的 lb 服务，External-IP 要等一会才会出现</span>
</span></span><span style="display:flex;"><span>ø&gt; kubectl get svc kubia-loadbalancer
</span></span><span style="display:flex;"><span>NAME                 TYPE           CLUSTER-IP    EXTERNAL-IP     PORT<span style="color:#ce5c00;font-weight:bold">(</span>S<span style="color:#ce5c00;font-weight:bold">)</span>        AGE
</span></span><span style="display:flex;"><span>kubia-loadbalancer   LoadBalancer   10.66.4.173   35.221.253.22   80:32179/TCP   47s
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># External-IP 可以访问</span>
</span></span><span style="display:flex;"><span>ø&gt; ping 35.221.253.22
</span></span><span style="display:flex;"><span>PING 35.221.253.22 <span style="color:#ce5c00;font-weight:bold">(</span>35.221.253.22<span style="color:#ce5c00;font-weight:bold">)</span>: <span style="color:#0000cf;font-weight:bold">56</span> data bytes
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">64</span> bytes from 35.221.253.22: <span style="color:#000">icmp_seq</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000">ttl</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">102</span> <span style="color:#000">time</span><span style="color:#ce5c00;font-weight:bold">=</span>166.876 ms
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">64</span> bytes from 35.221.253.22: <span style="color:#000">icmp_seq</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#000">ttl</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">102</span> <span style="color:#000">time</span><span style="color:#ce5c00;font-weight:bold">=</span>173.021 ms
</span></span><span style="display:flex;"><span>^C
</span></span><span style="display:flex;"><span>--- 35.221.253.22 ping statistics ---
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">2</span> packets transmitted, <span style="color:#0000cf;font-weight:bold">2</span> packets received, 0.0% packet loss
</span></span><span style="display:flex;"><span>round-trip min/avg/max/stddev <span style="color:#ce5c00;font-weight:bold">=</span> 166.876/169.948/173.021/3.072 ms
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 访问 External-IP 的 80 端口</span>
</span></span><span style="display:flex;"><span>ø&gt; http 35.221.253.22
</span></span><span style="display:flex;"><span>HTTP/1.1 <span style="color:#0000cf;font-weight:bold">200</span> OK
</span></span><span style="display:flex;"><span>Content-Length: <span style="color:#0000cf;font-weight:bold">38</span>
</span></span><span style="display:flex;"><span>Content-Type: text/plain<span style="color:#000;font-weight:bold">;</span> <span style="color:#000">charset</span><span style="color:#ce5c00;font-weight:bold">=</span>utf-8
</span></span><span style="display:flex;"><span>Date: Mon, <span style="color:#0000cf;font-weight:bold">20</span> Jul <span style="color:#0000cf;font-weight:bold">2020</span> 23:30:33 GMT
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>You<span style="color:#4e9a06">\&#39;</span>ve hit kubia-6wjvz on default mux
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 查看负载均衡器的信息</span>
</span></span><span style="display:flex;"><span>ø&gt; kubectl describe svc kubia-loadbalancer
</span></span><span style="display:flex;"><span>Name:                     kubia-loadbalancer
</span></span><span style="display:flex;"><span>Namespace:                default
</span></span><span style="display:flex;"><span>Labels:                   &lt;none&gt;
</span></span><span style="display:flex;"><span>Annotations:              &lt;none&gt;
</span></span><span style="display:flex;"><span>Selector:                 <span style="color:#000">app</span><span style="color:#ce5c00;font-weight:bold">=</span>kubia
</span></span><span style="display:flex;"><span>Type:                     LoadBalancer
</span></span><span style="display:flex;"><span>IP:                       10.66.4.173
</span></span><span style="display:flex;"><span>LoadBalancer Ingress:     35.221.253.22
</span></span><span style="display:flex;"><span>Port:                     &lt;unset&gt;  80/TCP
</span></span><span style="display:flex;"><span>TargetPort:               8080/TCP
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 选择了 32179 作为节点端口</span>
</span></span><span style="display:flex;"><span>NodePort:                 &lt;unset&gt;  32179/TCP
</span></span><span style="display:flex;"><span>Endpoints:                10.0.0.2:8080,10.0.0.3:8080,10.0.0.6:8080
</span></span><span style="display:flex;"><span>Session Affinity:         None
</span></span><span style="display:flex;"><span>External Traffic Policy:  Cluster
</span></span><span style="display:flex;"><span>Events:
</span></span><span style="display:flex;"><span>  Type    Reason                Age   From                Message
</span></span><span style="display:flex;"><span>  ----    ------                ----  ----                -------
</span></span><span style="display:flex;"><span>  Normal  EnsuringLoadBalancer  15m   service-controller  Ensuring load balancer
</span></span><span style="display:flex;"><span>  Normal  EnsuredLoadBalancer   15m   service-controller  Ensured load balancer
</span></span></code></pre></div><h2 id="通过-ingress-暴露服务">通过 Ingress 暴露服务</h2>
<p>每个 LoadBalancer 服务都需要自己的负载均衡器，以及独有的公有 IP 地址，而 Ingress 只需要一个公网 IP 就能为许多服务提供访问。</p>
<p>Ingress 控制器不会将请求转发给 Endpoint 服务器，只是通过 EndPoints 服务来选择一个 Pod 的IP，并且将请求转发给 Pod。</p>
<h3 id="创建-ingress-服务">创建 Ingress 服务</h3>
<ul>
<li>kubia-ingress.yaml</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">extensions/v1beta1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Ingress</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kubia</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">rules</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:bold">host</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kubia.example.com</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">http</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">paths</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span>- <span style="color:#204a87;font-weight:bold">path</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:bold">backend</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#204a87;font-weight:bold">serviceName</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kubia-nodeport</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#204a87;font-weight:bold">servicePort</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">80</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>ø&gt; kubectl create -f kubia-ingress.yaml
</span></span><span style="display:flex;"><span>ingress.extensions/kubia created
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 查看 Ingress 对外暴露的 IP 地址</span>
</span></span><span style="display:flex;"><span>ø&gt; kubectl get ingress
</span></span><span style="display:flex;"><span>NAME    HOSTS               ADDRESS        PORTS   AGE
</span></span><span style="display:flex;"><span>kubia   kubia.example.com   35.227.198.7   <span style="color:#0000cf;font-weight:bold">80</span>      74s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 在本地设置好 hosts 后，通过域名访问服务</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">echo</span> <span style="color:#4e9a06">&#39;35.227.198.7 kubia.example.com&#39;</span> &gt;&gt; /etc/hosts
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ø&gt; http kubia.example.com
</span></span><span style="display:flex;"><span>HTTP/1.1 <span style="color:#0000cf;font-weight:bold">200</span> OK
</span></span><span style="display:flex;"><span>Content-Length: <span style="color:#0000cf;font-weight:bold">44</span>
</span></span><span style="display:flex;"><span>Content-Type: text/plain<span style="color:#000;font-weight:bold">;</span> <span style="color:#000">charset</span><span style="color:#ce5c00;font-weight:bold">=</span>utf-8
</span></span><span style="display:flex;"><span>Date: Wed, <span style="color:#0000cf;font-weight:bold">29</span> Jul <span style="color:#0000cf;font-weight:bold">2020</span> 01:25:25 GMT
</span></span><span style="display:flex;"><span>Via: 1.1 google
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>You<span style="color:#a40000">&#39;</span>ve hit kubia-zssz2 on default mux by <span style="color:#0000cf;font-weight:bold">15</span>
</span></span></code></pre></div><p>注意，通过域名访问的时候，服务如果返回500的话，会使用 Ingress 自定义的错误页面，无法看到服务返回的 500 页面。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 服务返回500的情况</span>
</span></span><span style="display:flex;"><span>ø&gt; http kubia.example.com
</span></span><span style="display:flex;"><span>HTTP/1.1 <span style="color:#0000cf;font-weight:bold">502</span> Bad Gateway
</span></span><span style="display:flex;"><span>Content-Length: <span style="color:#0000cf;font-weight:bold">332</span>
</span></span><span style="display:flex;"><span>Content-Type: text/html<span style="color:#000;font-weight:bold">;</span> <span style="color:#000">charset</span><span style="color:#ce5c00;font-weight:bold">=</span>UTF-8
</span></span><span style="display:flex;"><span>Date: Tue, <span style="color:#0000cf;font-weight:bold">28</span> Jul <span style="color:#0000cf;font-weight:bold">2020</span> 15:10:53 GMT
</span></span><span style="display:flex;"><span>Referrer-Policy: no-referrer
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>&lt;html&gt;&lt;head&gt;
</span></span><span style="display:flex;"><span>&lt;meta http-equiv<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;content-type&#34;</span> <span style="color:#000">content</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;text/html;charset=utf-8&#34;</span>&gt;
</span></span><span style="display:flex;"><span>&lt;title&gt;502 Server Error&lt;/title&gt;
</span></span><span style="display:flex;"><span>&lt;/head&gt;
</span></span><span style="display:flex;"><span>&lt;body <span style="color:#000">text</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#8f5902;font-style:italic">#000000 bgcolor=#ffffff&gt;</span>
</span></span><span style="display:flex;"><span>&lt;h1&gt;Error: Server Error&lt;/h1&gt;
</span></span><span style="display:flex;"><span>&lt;h2&gt;The server encountered a temporary error and could not <span style="color:#204a87">complete</span> your request.&lt;p&gt;Please try again in <span style="color:#0000cf;font-weight:bold">30</span> seconds.&lt;/h2&gt;
</span></span><span style="display:flex;"><span>&lt;h2&gt;&lt;/h2&gt;
</span></span><span style="display:flex;"><span>&lt;/body&gt;&lt;/html&gt;
</span></span></code></pre></div><h3 id="配置-ingress-处理-tls-传输">配置 Ingress 处理 TLS 传输</h3>
<p>创建好证书和秘钥后，存储到 Secert 资源中</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 创建 RSA 秘钥</span>
</span></span><span style="display:flex;"><span>ø&gt; openssl genrsa -out tls.key <span style="color:#0000cf;font-weight:bold">2048</span>
</span></span><span style="display:flex;"><span>Generating RSA private key, <span style="color:#0000cf;font-weight:bold">2048</span> bit long modulus
</span></span><span style="display:flex;"><span>...............................................................+++
</span></span><span style="display:flex;"><span>....+++
</span></span><span style="display:flex;"><span>e is <span style="color:#0000cf;font-weight:bold">65537</span> <span style="color:#ce5c00;font-weight:bold">(</span>0x10001<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 创建证书</span>
</span></span><span style="display:flex;"><span>ø&gt; openssl req -new -x509 -sha256 -key tls.key  -out tls.cert -days <span style="color:#0000cf;font-weight:bold">3650</span> -subj /CN<span style="color:#ce5c00;font-weight:bold">=</span>kubia.example.com
</span></span><span style="display:flex;"><span>ø&gt; ls
</span></span><span style="display:flex;"><span>tls.cert tls.key
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 创建 Secret 资源</span>
</span></span><span style="display:flex;"><span>ø&gt; k create secret tls tls-secret --cert<span style="color:#ce5c00;font-weight:bold">=</span>tls.cert --key<span style="color:#ce5c00;font-weight:bold">=</span>tls.key
</span></span><span style="display:flex;"><span>secret/tls-secret created
</span></span></code></pre></div><p>更新 Ingress 的配置，使用 Secret 配置 HTTPS</p>
<ul>
<li>kubia-ingress-tls.yaml</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">extensions/v1beta1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Ingress</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kubia</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">tls</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:bold">hosts</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#000">kubia.example.com</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">secretName</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">tls-secret</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">rules</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:bold">host</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kubia.example.com</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">http</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">paths</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span>- <span style="color:#204a87;font-weight:bold">path</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:bold">backend</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#204a87;font-weight:bold">serviceName</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kubia-nodeport</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#204a87;font-weight:bold">servicePort</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">80</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 更新 ingress 配置</span>
</span></span><span style="display:flex;"><span>ø&gt; kubectl apply -f kubia-ingress-tls.yaml
</span></span><span style="display:flex;"><span>Warning: kubectl apply should be used on resource created by either kubectl create --save-config or kubectl apply
</span></span><span style="display:flex;"><span>ingress.extensions/kubia configured
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 访问我们配置的域名，查看其证书</span>
</span></span><span style="display:flex;"><span>ø&gt; curl -k -v https://kubia.example.com/
</span></span><span style="display:flex;"><span>*   Trying 35.227.198.7...
</span></span><span style="display:flex;"><span>* TCP_NODELAY <span style="color:#204a87">set</span>
</span></span><span style="display:flex;"><span>* Connected to kubia.example.com <span style="color:#ce5c00;font-weight:bold">(</span>35.227.198.7<span style="color:#ce5c00;font-weight:bold">)</span> port <span style="color:#0000cf;font-weight:bold">443</span> <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#8f5902;font-style:italic">#0)</span>
</span></span><span style="display:flex;"><span>* ALPN, offering h2
</span></span><span style="display:flex;"><span>* ALPN, offering http/1.1
</span></span><span style="display:flex;"><span>* successfully <span style="color:#204a87">set</span> certificate verify locations:
</span></span><span style="display:flex;"><span>*   CAfile: /etc/ssl/cert.pem
</span></span><span style="display:flex;"><span>  CApath: none
</span></span><span style="display:flex;"><span>* TLSv1.2 <span style="color:#ce5c00;font-weight:bold">(</span>OUT<span style="color:#ce5c00;font-weight:bold">)</span>, TLS handshake, Client hello <span style="color:#ce5c00;font-weight:bold">(</span>1<span style="color:#ce5c00;font-weight:bold">)</span>:
</span></span><span style="display:flex;"><span>* TLSv1.2 <span style="color:#ce5c00;font-weight:bold">(</span>IN<span style="color:#ce5c00;font-weight:bold">)</span>, TLS handshake, Server hello <span style="color:#ce5c00;font-weight:bold">(</span>2<span style="color:#ce5c00;font-weight:bold">)</span>:
</span></span><span style="display:flex;"><span>* TLSv1.2 <span style="color:#ce5c00;font-weight:bold">(</span>IN<span style="color:#ce5c00;font-weight:bold">)</span>, TLS handshake, Certificate <span style="color:#ce5c00;font-weight:bold">(</span>11<span style="color:#ce5c00;font-weight:bold">)</span>:
</span></span><span style="display:flex;"><span>* TLSv1.2 <span style="color:#ce5c00;font-weight:bold">(</span>IN<span style="color:#ce5c00;font-weight:bold">)</span>, TLS handshake, Server key exchange <span style="color:#ce5c00;font-weight:bold">(</span>12<span style="color:#ce5c00;font-weight:bold">)</span>:
</span></span><span style="display:flex;"><span>* TLSv1.2 <span style="color:#ce5c00;font-weight:bold">(</span>IN<span style="color:#ce5c00;font-weight:bold">)</span>, TLS handshake, Server finished <span style="color:#ce5c00;font-weight:bold">(</span>14<span style="color:#ce5c00;font-weight:bold">)</span>:
</span></span><span style="display:flex;"><span>* TLSv1.2 <span style="color:#ce5c00;font-weight:bold">(</span>OUT<span style="color:#ce5c00;font-weight:bold">)</span>, TLS handshake, Client key exchange <span style="color:#ce5c00;font-weight:bold">(</span>16<span style="color:#ce5c00;font-weight:bold">)</span>:
</span></span><span style="display:flex;"><span>* TLSv1.2 <span style="color:#ce5c00;font-weight:bold">(</span>OUT<span style="color:#ce5c00;font-weight:bold">)</span>, TLS change cipher, Change cipher spec <span style="color:#ce5c00;font-weight:bold">(</span>1<span style="color:#ce5c00;font-weight:bold">)</span>:
</span></span><span style="display:flex;"><span>* TLSv1.2 <span style="color:#ce5c00;font-weight:bold">(</span>OUT<span style="color:#ce5c00;font-weight:bold">)</span>, TLS handshake, Finished <span style="color:#ce5c00;font-weight:bold">(</span>20<span style="color:#ce5c00;font-weight:bold">)</span>:
</span></span><span style="display:flex;"><span>* TLSv1.2 <span style="color:#ce5c00;font-weight:bold">(</span>IN<span style="color:#ce5c00;font-weight:bold">)</span>, TLS change cipher, Change cipher spec <span style="color:#ce5c00;font-weight:bold">(</span>1<span style="color:#ce5c00;font-weight:bold">)</span>:
</span></span><span style="display:flex;"><span>* TLSv1.2 <span style="color:#ce5c00;font-weight:bold">(</span>IN<span style="color:#ce5c00;font-weight:bold">)</span>, TLS handshake, Finished <span style="color:#ce5c00;font-weight:bold">(</span>20<span style="color:#ce5c00;font-weight:bold">)</span>:
</span></span><span style="display:flex;"><span>* SSL connection using TLSv1.2 / ECDHE-RSA-CHACHA20-POLY1305
</span></span><span style="display:flex;"><span>* ALPN, server accepted to use h2
</span></span><span style="display:flex;"><span>* Server certificate:
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 可以看到 CN 正是我们在创建时声明的CN配置</span>
</span></span><span style="display:flex;"><span>*  subject: <span style="color:#000">CN</span><span style="color:#ce5c00;font-weight:bold">=</span>kubia.example.com
</span></span><span style="display:flex;"><span>*  start date: Jul <span style="color:#0000cf;font-weight:bold">30</span> 15:08:40 <span style="color:#0000cf;font-weight:bold">2020</span> GMT
</span></span><span style="display:flex;"><span>*  expire date: Jul <span style="color:#0000cf;font-weight:bold">28</span> 15:08:40 <span style="color:#0000cf;font-weight:bold">2030</span> GMT
</span></span><span style="display:flex;"><span>*  issuer: <span style="color:#000">CN</span><span style="color:#ce5c00;font-weight:bold">=</span>kubia.example.com
</span></span><span style="display:flex;"><span>*  SSL certificate verify result: self signed certificate <span style="color:#ce5c00;font-weight:bold">(</span>18<span style="color:#ce5c00;font-weight:bold">)</span>, continuing anyway.
</span></span><span style="display:flex;"><span>* Using HTTP2, server supports multi-use
</span></span><span style="display:flex;"><span>* Connection state changed <span style="color:#ce5c00;font-weight:bold">(</span>HTTP/2 confirmed<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>* Copying HTTP/2 data in stream buffer to connection buffer after upgrade: <span style="color:#000">len</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>* Using Stream ID: <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">(</span>easy handle 0x7f869c80fc00<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>&gt; GET / HTTP/2
</span></span><span style="display:flex;"><span>&gt; Host: kubia.example.com
</span></span><span style="display:flex;"><span>&gt; User-Agent: curl/7.64.1
</span></span><span style="display:flex;"><span>&gt; Accept: */*
</span></span><span style="display:flex;"><span>&gt;
</span></span><span style="display:flex;"><span>* Connection state changed <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">MAX_CONCURRENT_STREAMS</span> <span style="color:#ce5c00;font-weight:bold">==</span> 100<span style="color:#ce5c00;font-weight:bold">)</span>!
</span></span><span style="display:flex;"><span>&lt; HTTP/2 <span style="color:#0000cf;font-weight:bold">200</span>
</span></span><span style="display:flex;"><span>&lt; date: Thu, <span style="color:#0000cf;font-weight:bold">30</span> Jul <span style="color:#0000cf;font-weight:bold">2020</span> 15:17:17 GMT
</span></span><span style="display:flex;"><span>&lt; content-length: <span style="color:#0000cf;font-weight:bold">46</span>
</span></span><span style="display:flex;"><span>&lt; content-type: text/plain<span style="color:#000;font-weight:bold">;</span> <span style="color:#000">charset</span><span style="color:#ce5c00;font-weight:bold">=</span>utf-8
</span></span><span style="display:flex;"><span>&lt; via: 1.1 google
</span></span><span style="display:flex;"><span>&lt; alt-svc: clear
</span></span><span style="display:flex;"><span>&lt;
</span></span><span style="display:flex;"><span>You<span style="color:#4e9a06">\&#39;</span>ve hit kubia-zssz2 on default mux by <span style="color:#0000cf;font-weight:bold">8026</span>
</span></span><span style="display:flex;"><span>* Connection <span style="color:#8f5902;font-style:italic">#0 to host kubia.example.com left intact</span>
</span></span><span style="display:flex;"><span>* Closing connection <span style="color:#0000cf;font-weight:bold">0</span>
</span></span></code></pre></div><h2 id="pod-就绪后发出信号">Pod 就绪后发出信号</h2>
<p>就绪探测器会定期调用，并确定特定的 pod 是否接收客户端请求。当容器的准备就绪探测返回成功时，表示容器已经准备好接收请求。如果容器报告它未准备就绪，则会从该服务中删除该 Pod。如果 Pod 再次准备就绪，则重新添加 Pod。</p>
<p>像存活探针一样，就绪探针有三种类型:</p>
<ol>
<li>Exec 探针，执行一个进程，容器的状态由命令的退出状态码确定</li>
<li>HTTP GET 探针，向容器发送 HTTP GET 请求，通过响应的 HTTP 状态代码判断容器是否准备好。</li>
<li>TCP socket 探针，它打开一个 TCP 连接到容器的指定端口。如果连接已经建立，则认为容器已经准备就绪。</li>
</ol>
<p>与存活探针不同，如果容器未通过准备检查，则不会被终止或重新启动。这是存活探针与就绪探针之间的重要区别。</p>
<ul>
<li>实验:</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 编辑 rs 的配置文件中 pod 模板的部分，加入就绪探针</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 这个就绪探针是一个 exec 类型，检测某个文件是否存在</span>
</span></span><span style="display:flex;"><span>TODO
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 删除已有的 Pod</span>
</span></span><span style="display:flex;"><span>ø&gt; kubectl delete pod kubia-bp5xc
</span></span><span style="display:flex;"><span>pod <span style="color:#4e9a06">&#34;kubia-bp5xc&#34;</span> deleted
</span></span><span style="display:flex;"><span>ø&gt; kubectl delete pod kubia-tt8rl
</span></span><span style="display:flex;"><span>pod <span style="color:#4e9a06">&#34;kubia-tt8rl&#34;</span> deleted
</span></span><span style="display:flex;"><span>ø&gt; kubectl delete pod kubia-zssz2
</span></span><span style="display:flex;"><span>pod <span style="color:#4e9a06">&#34;kubia-zssz2&#34;</span> deleted
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 查看现在的 Pod，发现都没有处于就绪状态</span>
</span></span><span style="display:flex;"><span>ø&gt; kubectl get pods --show-labels
</span></span><span style="display:flex;"><span>NAME          READY   STATUS    RESTARTS   AGE   LABELS
</span></span><span style="display:flex;"><span>kubia-m7xnj   0/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          80s   <span style="color:#000">app</span><span style="color:#ce5c00;font-weight:bold">=</span>kubia
</span></span><span style="display:flex;"><span>kubia-qsrhr   0/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          41s   <span style="color:#000">app</span><span style="color:#ce5c00;font-weight:bold">=</span>kubia
</span></span><span style="display:flex;"><span>kubia-wpk4k   0/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          46s   <span style="color:#000">app</span><span style="color:#ce5c00;font-weight:bold">=</span>kubia
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 令一个 Pod 处于就绪状态</span>
</span></span><span style="display:flex;"><span>ø&gt; kubectl <span style="color:#204a87">exec</span> kubia-wpk4k -- touch /var/ready
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 通过 nodeport 暴露的端口访问，发现所有的流量都走到了 kubia-wpk4k 这个 Pod 上</span>
</span></span><span style="display:flex;"><span>ø&gt; curl 34.80.233.40:30123
</span></span><span style="display:flex;"><span>You ve hit kubia-wpk4k on default mux by <span style="color:#0000cf;font-weight:bold">65</span>
</span></span><span style="display:flex;"><span>ø&gt; curl 34.80.233.40:30123
</span></span><span style="display:flex;"><span>You ve hit kubia-wpk4k on default mux by <span style="color:#0000cf;font-weight:bold">66</span>
</span></span><span style="display:flex;"><span>ø&gt; curl 34.80.233.40:30123
</span></span><span style="display:flex;"><span>You ve hit kubia-wpk4k on default mux by <span style="color:#0000cf;font-weight:bold">67</span>
</span></span><span style="display:flex;"><span>ø&gt; curl 34.80.233.40:30123
</span></span><span style="display:flex;"><span>You ve hit kubia-wpk4k on default mux by <span style="color:#0000cf;font-weight:bold">77</span>
</span></span><span style="display:flex;"><span>ø&gt; curl 34.80.233.40:30123
</span></span><span style="display:flex;"><span>You ve hit kubia-wpk4k on default mux by <span style="color:#0000cf;font-weight:bold">78</span>
</span></span><span style="display:flex;"><span>ø&gt; curl 34.80.233.40:30123
</span></span><span style="display:flex;"><span>You ve hit kubia-wpk4k on default mux by <span style="color:#0000cf;font-weight:bold">79</span>
</span></span><span style="display:flex;"><span>ø&gt; curl 34.80.233.40:30123
</span></span><span style="display:flex;"><span>You ve hit kubia-wpk4k on default mux by <span style="color:#0000cf;font-weight:bold">80</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 通过 describe 查看日志，可以看到就绪指针的相关日志</span>
</span></span><span style="display:flex;"><span>ø&gt; kubectl describe pod kubia-m7xnj
</span></span><span style="display:flex;"><span>Name:           kubia-m7xnj
</span></span><span style="display:flex;"><span>Namespace:      default
</span></span><span style="display:flex;"><span>Priority:       <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>Events:
</span></span><span style="display:flex;"><span>  Type     Reason     Age                 From                                          Message
</span></span><span style="display:flex;"><span>  ----     ------     ----                ----                                          -------
</span></span><span style="display:flex;"><span>  Normal   Scheduled  11m                 default-scheduler                             Successfully assigned default/kubia-m7xnj to gke-demo-default-pool-ade08258-zjhd
</span></span><span style="display:flex;"><span>  Normal   Pulled     11m                 kubelet, gke-demo-default-pool-ade08258-zjhd  Container image <span style="color:#4e9a06">&#34;bwangel/kubia:v0.4&#34;</span> already present on machine
</span></span><span style="display:flex;"><span>  Normal   Created    11m                 kubelet, gke-demo-default-pool-ade08258-zjhd  Created container kubia
</span></span><span style="display:flex;"><span>  Normal   Started    11m                 kubelet, gke-demo-default-pool-ade08258-zjhd  Started container kubia
</span></span><span style="display:flex;"><span>  Warning  Unhealthy  98s <span style="color:#ce5c00;font-weight:bold">(</span>x61 over 11m<span style="color:#ce5c00;font-weight:bold">)</span>  kubelet, gke-demo-default-pool-ade08258-zjhd  Readiness probe failed: ls: cannot access <span style="color:#4e9a06">&#39;/var/ready&#39;</span>: No such file or directory
</span></span></code></pre></div><ul>
<li>注意事项:</li>
</ul>
<ol>
<li>应该始终定义就绪指针，针对一些启动时间长的应用，如果没有就绪指针，会让客户端请求到达时报错。</li>
<li>就绪指针不需要关注删除容器的情况，如果删除了 Pod，K8S 会自动将其从服务中移除，不需要通过就绪指针来标记移除。</li>
</ol>
<h2 id="使用-headless-服务来发现独立的-pod">使用 headless 服务来发现独立的 Pod</h2>
<p>在创建服务时，声明 <code>spec.ClusterInfo: None</code> 就可以设置一个服务为 headless 服务。</p>
<p>当通过 DNS 查询 FQDN 时，常规服务返回的是服务的集群IP，headless 服务返回的是 Pod IP。</p>
<p>headless 也会提供跨 Pod 的负载均衡，但是是通过 DNS 的轮询机制实现的，而不是像常规服务那样通过服务代理实现的。</p>
<ul>
<li>kubia.svc-headless.yaml</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Service</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kubia-headless</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">clusterIP</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">None</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">ports</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:bold">port</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">80</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">targetPort</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">8080</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">selector</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">app</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kubia</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 创建 headless 服务</span>
</span></span><span style="display:flex;"><span>ø&gt; kubectl create -f kubia-svc-headless.yaml
</span></span><span style="display:flex;"><span>service/kubia-headless created
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 查看 headless 服务的信息，发现没有 ClusterIP</span>
</span></span><span style="display:flex;"><span>ø&gt; kubectl get service
</span></span><span style="display:flex;"><span>NAME                            TYPE           CLUSTER-IP     EXTERNAL-IP     PORT<span style="color:#ce5c00;font-weight:bold">(</span>S<span style="color:#ce5c00;font-weight:bold">)</span>         AGE
</span></span><span style="display:flex;"><span>external-service                ClusterIP      10.66.10.171   &lt;none&gt;          80/TCP          95d
</span></span><span style="display:flex;"><span>external-service-externalname   ExternalName   &lt;none&gt;         httpbin.org     80/TCP          95d
</span></span><span style="display:flex;"><span>kubernetes                      ClusterIP      10.66.0.1      &lt;none&gt;          443/TCP         128d
</span></span><span style="display:flex;"><span>kubia                           ClusterIP      10.66.13.240   &lt;none&gt;          80/TCP,90/TCP   97d
</span></span><span style="display:flex;"><span>kubia-headless                  ClusterIP      None           &lt;none&gt;          80/TCP          11s
</span></span><span style="display:flex;"><span>kubia-loadbalancer              LoadBalancer   10.66.4.173    35.221.253.22   80:32179/TCP    12d
</span></span><span style="display:flex;"><span>kubia-nodeport                  NodePort       10.66.5.6      &lt;none&gt;          80:30123/TCP    94d
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ø&gt; kubectl describe service kubia-headless
</span></span><span style="display:flex;"><span>Name:              kubia-headless
</span></span><span style="display:flex;"><span>Namespace:         default
</span></span><span style="display:flex;"><span>Labels:            &lt;none&gt;
</span></span><span style="display:flex;"><span>Annotations:       &lt;none&gt;
</span></span><span style="display:flex;"><span>Selector:          <span style="color:#000">app</span><span style="color:#ce5c00;font-weight:bold">=</span>kubia
</span></span><span style="display:flex;"><span>Type:              ClusterIP
</span></span><span style="display:flex;"><span>IP:                None
</span></span><span style="display:flex;"><span>Port:              &lt;unset&gt;  80/TCP
</span></span><span style="display:flex;"><span>TargetPort:        8080/TCP
</span></span><span style="display:flex;"><span>Endpoints:         10.0.0.8:8080
</span></span><span style="display:flex;"><span>Session Affinity:  None
</span></span><span style="display:flex;"><span>Events:            &lt;none&gt;
</span></span></code></pre></div><h3 id="通过-dns-查找-pod-的-ip">通过 DNS 查找 Pod 的 IP</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 创建一个可以执行 DNS 查找命令的临时 Pod</span>
</span></span><span style="display:flex;"><span>ø&gt; kubectl run dnsutils --image<span style="color:#ce5c00;font-weight:bold">=</span>tutum/dnsutils --generator<span style="color:#ce5c00;font-weight:bold">=</span>run-pod/v1 --command -- sleep infinity
</span></span><span style="display:flex;"><span>pod/dnsutils created
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 查看 kubia ReplicaSet，可以看到只有两个 Pod 就绪</span>
</span></span><span style="display:flex;"><span>ø&gt; kubectl get rs
</span></span><span style="display:flex;"><span>NAME    DESIRED   CURRENT   READY   AGE
</span></span><span style="display:flex;"><span>kubia   <span style="color:#0000cf;font-weight:bold">3</span>         <span style="color:#0000cf;font-weight:bold">3</span>         <span style="color:#0000cf;font-weight:bold">2</span>       97d
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 执行 DNS 查找</span>
</span></span><span style="display:flex;"><span>ø&gt; kubectl <span style="color:#204a87">exec</span> dnsutils nslookup kubia-headless
</span></span><span style="display:flex;"><span>Server:         10.66.0.10
</span></span><span style="display:flex;"><span>Address:        10.66.0.10#53
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 这里只返回了两个 Pod IP，因为 selector=&#34;app=kubia&#34; 的 Pod 只有两个就绪了。</span>
</span></span><span style="display:flex;"><span>Name:   kubia-headless.default.svc.cluster.local
</span></span><span style="display:flex;"><span>Address: 10.0.0.8
</span></span><span style="display:flex;"><span>Name:   kubia-headless.default.svc.cluster.local
</span></span><span style="display:flex;"><span>Address: 10.0.2.5
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 查找常规服务的 DNS，可以看到返回的是服务的集群IP</span>
</span></span><span style="display:flex;"><span>ø&gt; kubectl <span style="color:#204a87">exec</span> dnsutils nslookup kubia
</span></span><span style="display:flex;"><span>Server:         10.66.0.10
</span></span><span style="display:flex;"><span>Address:        10.66.0.10#53
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Name:   kubia.default.svc.cluster.local
</span></span><span style="display:flex;"><span>Address: 10.66.13.240
</span></span></code></pre></div><h3 id="发现所有-pod包括未就绪-pod">发现所有 Pod，包括未就绪 Pod</h3>
<p>在 K8S 1.17 版本中，在创建 headless 服务中添加<code>publishNotReadyAddresses</code>配置，就可以让 DNS 服务器查找到对应 headless 服务的未就绪 Pod。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Service</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kubia-headless</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">...</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">publishNotReadyAddresses</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#000">...</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># app=kubia 中就绪的 Pod 还是只有两个</span>
</span></span><span style="display:flex;"><span>ø&gt; kubectl get rs
</span></span><span style="display:flex;"><span>NAME    DESIRED   CURRENT   READY   AGE
</span></span><span style="display:flex;"><span>kubia   <span style="color:#0000cf;font-weight:bold">3</span>         <span style="color:#0000cf;font-weight:bold">3</span>         <span style="color:#0000cf;font-weight:bold">2</span>       97d
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ø&gt; kubectl <span style="color:#204a87">exec</span> dnsutils nslookup kubia-headless
</span></span><span style="display:flex;"><span>Server:         10.66.0.10
</span></span><span style="display:flex;"><span>Address:        10.66.0.10#53
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 可以看到此时所有 Pod 的 IP 全部返回了</span>
</span></span><span style="display:flex;"><span>Name:   kubia-headless.default.svc.cluster.local
</span></span><span style="display:flex;"><span>Address: 10.0.0.8
</span></span><span style="display:flex;"><span>Name:   kubia-headless.default.svc.cluster.local
</span></span><span style="display:flex;"><span>Address: 10.0.2.4
</span></span><span style="display:flex;"><span>Name:   kubia-headless.default.svc.cluster.local
</span></span><span style="display:flex;"><span>Address: 10.0.2.5
</span></span></code></pre></div><p><a href="https://v1-17.docs.kubernetes.io/docs/reference/generated/kubernetes-api/v1.17/">publishNotReadyAddresses 的参考文档</a></p>
<h2 id="排除服务故障">排除服务故障</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 查看 pod 的 IP</span>
</span></span><span style="display:flex;"><span>ø&gt; kubectl get pods -o <span style="color:#000">jsonpath</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;{range .items[*]}{.metadata.name}--{.status.podIP} {end}&#34;</span> <span style="color:#000;font-weight:bold">|</span> tr <span style="color:#4e9a06">&#39; &#39;</span> <span style="color:#4e9a06">&#39;\n&#39;</span>
</span></span><span style="display:flex;"><span>dnsutils--10.0.0.9
</span></span><span style="display:flex;"><span>kubia-m7xnj--10.0.2.4
</span></span><span style="display:flex;"><span>kubia-qsrhr--10.0.2.5
</span></span><span style="display:flex;"><span>kubia-wpk4k--10.0.0.8
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 查看所有服务的集群IP</span>
</span></span><span style="display:flex;"><span>ø&gt; kubectl get svc
</span></span><span style="display:flex;"><span>NAME                            TYPE           CLUSTER-IP     EXTERNAL-IP     PORT<span style="color:#ce5c00;font-weight:bold">(</span>S<span style="color:#ce5c00;font-weight:bold">)</span>         AGE
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>kubia                           ClusterIP      10.66.13.240   &lt;none&gt;          80/TCP,90/TCP   97d
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># headless 服务是没有集群IP的</span>
</span></span><span style="display:flex;"><span>kubia-headless                  ClusterIP      None           &lt;none&gt;          80/TCP          44m
</span></span><span style="display:flex;"><span>kubia-loadbalancer              LoadBalancer   10.66.4.173    35.221.253.22   80:32179/TCP    12d
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 在集群内 ping 服务的集群IP，发现是 ping 不通的</span>
</span></span><span style="display:flex;"><span>ø&gt; kubectl <span style="color:#204a87">exec</span> -it kubia-wpk4k bash                                                                       11:17:47 <span style="color:#ce5c00;font-weight:bold">(</span>08-02<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>root@kubia-wpk4k:/app# ping 10.66.13.240
</span></span><span style="display:flex;"><span>PING 10.66.13.240 <span style="color:#ce5c00;font-weight:bold">(</span>10.66.13.240<span style="color:#ce5c00;font-weight:bold">)</span> 56<span style="color:#ce5c00;font-weight:bold">(</span>84<span style="color:#ce5c00;font-weight:bold">)</span> bytes of data.
</span></span><span style="display:flex;"><span>^C
</span></span><span style="display:flex;"><span>--- 10.66.13.240 ping statistics ---
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">6</span> packets transmitted, <span style="color:#0000cf;font-weight:bold">0</span> received, 100% packet loss, <span style="color:#204a87">time</span> 116ms
</span></span></code></pre></div><p>如何排除服务故障:</p>
<ol>
<li>确保从集群内连接到服务的集群IP，而不是从外部 (k get svc 可以获得服务的集群IP)</li>
<li>不要通过 ping 服务 IP 来判断服务是否可以访问( <strong>请记住，服务的集群IP是虚拟IP，是无法 ping 通的</strong> )</li>
<li>如果已经定义了就绪探针，请确保它返回成功；否则该 Pod 不会成为服务的一部分</li>
<li>要确认某个容器是服务的一部分，请使用 <code>k get endpoints</code> 来检查服务对应的 endpoints 中存储有该 Pod 的IP及端口。</li>
<li>如果尝试通过 FQDN 或其中一部分来访问服务（例如，<code>myservice.mynamespace.svc.cluster.local</code> 或 <code>myservice.mynamespace</code>），但并不起作用，请查看是否可以通过其集群IP而不是 FQDN 来访问服务。</li>
<li>检查是否连接到服务公开的端口，而不是目标端口。</li>
<li>尝试直接连接到 Pod IP 以确认 pod 正在接收正确端口上的连接。</li>
<li>如果甚至无法通过 pod 的 IP 访问应用，请确保应用不是仅绑定到 localhost。</li>
</ol>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-c9372cbe944c20fd9d588bcf483caeef">10.1.6 - 4-pod-replicaset</h1>
    
	<p>副本机制和其他控制器 &ndash; 部署托管的 Pod</p>
<hr>
<h2 id="保持-pod-健康">保持 Pod 健康</h2>
<p>如果容器的主进程崩溃或存活探针检查失败，K8S 会自动重启容器，通过这种方式来让容器获得了自我修复的能力。</p>
<p>这个操作是由节点上的 kubelet 执行的，在主服务器上运行的 K8S Control Plane 组件不会参与此过程。</p>
<h3 id="存活探针">存活探针</h3>
<p>存活探针 (<code>liveness probe</code>) 可以用来定期检查容器是否还在正常运行，从而决定是否重启容器。</p>
<p>存活探针有三种:</p>
<ol>
<li><code>HTTP GET 探针</code>:
GET 容器的 HTTP 地址，检查响应码是否是 2xx 或 3xx</li>
<li><code>TCP 探针</code>:
测试能否与容器的指定端口建立 TCP 连接</li>
<li><code>Exec 指针</code>:
在容器内执行某个命令，检查命令的返回码是否是0</li>
</ol>
<h3 id="创建一个-http-get-探针">创建一个 HTTP GET 探针</h3>
<h4 id="准备工作">准备工作</h4>
<ol>
<li>修改 kubia 程序，设置请求5次<code>/</code>接口后，程序就会返回 500，kubia 程序的代码在 <a href="https://github.com/bwangelme/kubia/tree/v0.2">bwangelme/kubia@v0.2</a>。</li>
<li>根据上述代码，重新创建一个镜像，<a href="https://hub.docker.com/r/bwangel/kubia/tags">bwangel/kubia:v0.2</a></li>
</ol>
<h4 id="创建-pod--查看探针">创建 Pod &amp; 查看探针</h4>
<ul>
<li>kubia-liveness.yaml</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Pod</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kubia-unhealthy</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">containers</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:bold">image</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">bwangel/kubia:v0.2</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kubiame</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">livenessProbe</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">httpGet</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">path</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">port</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">8080</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>通过 <code>spec.containers.image.livenessProbe</code> 我们创建了一个 HTTP GET 存活探针。</p>
<ul>
<li>创建 &amp; 查看 Pod</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>ø&gt; kubectl create -f kubia-liveness.yaml
</span></span><span style="display:flex;"><span>pod/kubia-unhealthy created
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ø&gt; kubectl get pod
</span></span><span style="display:flex;"><span>NAME              READY   STATUS             RESTARTS   AGE
</span></span><span style="display:flex;"><span>kubia-unhealthy   0/1     CrashLoopBackOff   <span style="color:#0000cf;font-weight:bold">11</span>         30m
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># RESTARTS 表示 Pod 已经重启了11次，目前 Pod 正处于 CrashLoopBackOff 状态</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>ø&gt; kubectl describe pod kubia-unhealthy
</span></span><span style="display:flex;"><span>Name:         kubia-unhealthy
</span></span><span style="display:flex;"><span>Namespace:    default
</span></span><span style="display:flex;"><span>Priority:     <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>Node:         gke-demo-default-pool-ade08258-zjhd/10.140.0.10
</span></span><span style="display:flex;"><span>Start Time:   Wed, <span style="color:#0000cf;font-weight:bold">01</span> Apr <span style="color:#0000cf;font-weight:bold">2020</span> 22:07:04 +0800
</span></span><span style="display:flex;"><span>Labels:       &lt;none&gt;
</span></span><span style="display:flex;"><span>Annotations:  kubernetes.io/limit-ranger: LimitRanger plugin set: cpu request <span style="color:#204a87;font-weight:bold">for</span> container kubiame
</span></span><span style="display:flex;"><span>Status:       Running
</span></span><span style="display:flex;"><span>IP:           10.0.2.2
</span></span><span style="display:flex;"><span>IPs:          &lt;none&gt;
</span></span><span style="display:flex;"><span>Containers:
</span></span><span style="display:flex;"><span>  kubiame:
</span></span><span style="display:flex;"><span>    Container ID:   docker://6eb920af09115cb21564045fbc8ced0251e3aaecd5e7482142ecbf8ace3439e5
</span></span><span style="display:flex;"><span>    Image:          bwangel/kubia:v0.2
</span></span><span style="display:flex;"><span>    Image ID:       docker-pullable://bwangel/kubia@sha256:a89eaf3503fc72dc1e8c702142faefa6aeb59860c9472c1ee3e7e8154771be43
</span></span><span style="display:flex;"><span>    Port:           &lt;none&gt;
</span></span><span style="display:flex;"><span>    Host Port:      &lt;none&gt;
</span></span><span style="display:flex;"><span>    State:          Waiting
</span></span><span style="display:flex;"><span>      Reason:       CrashLoopBackOff
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># 先前的容器被 Signal INT(2) 终止了</span>
</span></span><span style="display:flex;"><span>    Last State:     Terminated
</span></span><span style="display:flex;"><span>      Reason:       Error
</span></span><span style="display:flex;"><span>      Exit Code:    <span style="color:#0000cf;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span>      Started:      Wed, <span style="color:#0000cf;font-weight:bold">01</span> Apr <span style="color:#0000cf;font-weight:bold">2020</span> 22:34:48 +0800
</span></span><span style="display:flex;"><span>      Finished:     Wed, <span style="color:#0000cf;font-weight:bold">01</span> Apr <span style="color:#0000cf;font-weight:bold">2020</span> 22:35:57 +0800
</span></span><span style="display:flex;"><span>    Ready:          False
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># 容器已经重启了11次了</span>
</span></span><span style="display:flex;"><span>    Restart Count:  <span style="color:#0000cf;font-weight:bold">11</span>
</span></span><span style="display:flex;"><span>    Requests:
</span></span><span style="display:flex;"><span>      cpu:        100m
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># 这里介绍了存活探针的属性</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># 探针将会在应用启动后延迟0秒开始检查，探针检查的超时时间为1秒，检查间隔为10秒，检查失败3次后重启应用</span>
</span></span><span style="display:flex;"><span>    Liveness:     http-get http://:8080/ <span style="color:#000">delay</span><span style="color:#ce5c00;font-weight:bold">=</span>0s <span style="color:#000">timeout</span><span style="color:#ce5c00;font-weight:bold">=</span>1s <span style="color:#000">period</span><span style="color:#ce5c00;font-weight:bold">=</span>10s <span style="color:#8f5902;font-style:italic">#success=1 #failure=3</span>
</span></span><span style="display:flex;"><span>    Environment:  &lt;none&gt;
</span></span><span style="display:flex;"><span>    Mounts:
</span></span><span style="display:flex;"><span>      /var/run/secrets/kubernetes.io/serviceaccount from default-token-hbl2l <span style="color:#ce5c00;font-weight:bold">(</span>ro<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>Conditions:
</span></span><span style="display:flex;"><span>  Type              Status
</span></span><span style="display:flex;"><span>  Initialized       True
</span></span><span style="display:flex;"><span>  Ready             False
</span></span><span style="display:flex;"><span>  ContainersReady   False
</span></span><span style="display:flex;"><span>  PodScheduled      True
</span></span><span style="display:flex;"><span>Volumes:
</span></span><span style="display:flex;"><span>  default-token-hbl2l:
</span></span><span style="display:flex;"><span>    Type:        Secret <span style="color:#ce5c00;font-weight:bold">(</span>a volume populated by a Secret<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    SecretName:  default-token-hbl2l
</span></span><span style="display:flex;"><span>    Optional:    <span style="color:#204a87">false</span>
</span></span><span style="display:flex;"><span>QoS Class:       Burstable
</span></span><span style="display:flex;"><span>Node-Selectors:  &lt;none&gt;
</span></span><span style="display:flex;"><span>Tolerations:     node.kubernetes.io/not-ready:NoExecute <span style="color:#204a87;font-weight:bold">for</span> 300s
</span></span><span style="display:flex;"><span>                 node.kubernetes.io/unreachable:NoExecute <span style="color:#204a87;font-weight:bold">for</span> 300s
</span></span><span style="display:flex;"><span>Events:
</span></span><span style="display:flex;"><span>  Type     Reason     Age                   From                                          Message
</span></span><span style="display:flex;"><span>  ----     ------     ----                  ----                                          -------
</span></span><span style="display:flex;"><span>  Normal   Scheduled  33m                   default-scheduler                             Successfully assigned default/kubia-unhealthy to gke-demo-default-pool-ade08258-zjhd
</span></span><span style="display:flex;"><span>  Normal   Pulling    33m                   kubelet, gke-demo-default-pool-ade08258-zjhd  Pulling image <span style="color:#4e9a06">&#34;bwangel/kubia:v0.2&#34;</span>
</span></span><span style="display:flex;"><span>  Normal   Pulled     33m                   kubelet, gke-demo-default-pool-ade08258-zjhd  Successfully pulled image <span style="color:#4e9a06">&#34;bwangel/kubia:v0.2&#34;</span>
</span></span><span style="display:flex;"><span>  Normal   Killing    29m <span style="color:#ce5c00;font-weight:bold">(</span>x3 over 32m<span style="color:#ce5c00;font-weight:bold">)</span>     kubelet, gke-demo-default-pool-ade08258-zjhd  Container kubiame failed liveness probe, will be restarted
</span></span><span style="display:flex;"><span>  Normal   Created    29m <span style="color:#ce5c00;font-weight:bold">(</span>x4 over 33m<span style="color:#ce5c00;font-weight:bold">)</span>     kubelet, gke-demo-default-pool-ade08258-zjhd  Created container kubiame
</span></span><span style="display:flex;"><span>  Normal   Started    29m <span style="color:#ce5c00;font-weight:bold">(</span>x4 over 33m<span style="color:#ce5c00;font-weight:bold">)</span>     kubelet, gke-demo-default-pool-ade08258-zjhd  Started container kubiame
</span></span><span style="display:flex;"><span>  Normal   Pulled     29m <span style="color:#ce5c00;font-weight:bold">(</span>x3 over 32m<span style="color:#ce5c00;font-weight:bold">)</span>     kubelet, gke-demo-default-pool-ade08258-zjhd  Container image <span style="color:#4e9a06">&#34;bwangel/kubia:v0.2&#34;</span> already present on machine
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic"># HTTP GET 存活探针检查失败，Pod 重启</span>
</span></span><span style="display:flex;"><span>  Warning  Unhealthy  13m <span style="color:#ce5c00;font-weight:bold">(</span>x25 over 32m<span style="color:#ce5c00;font-weight:bold">)</span>    kubelet, gke-demo-default-pool-ade08258-zjhd  Liveness probe failed: HTTP probe failed with statuscode: <span style="color:#0000cf;font-weight:bold">500</span>
</span></span><span style="display:flex;"><span>  Warning  BackOff    3m49s <span style="color:#ce5c00;font-weight:bold">(</span>x78 over 26m<span style="color:#ce5c00;font-weight:bold">)</span>  kubelet, gke-demo-default-pool-ade08258-zjhd  Back-off restarting failed container
</span></span></code></pre></div><ul>
<li><strong>注意:</strong> 当容器被强行终止时，会创建一个全新的容器，而不是重启原来的容器。</li>
</ul>
<p>所以如果想要看容器的失败日志，要通过<code>kubectl logs -f kubia-unhealthy --previous</code>命令，查看上一个容器的日志。</p>
<h4 id="修改存活探针的选项">修改存活探针的选项</h4>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">containers</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">livenessProbe</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">httpGet</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">path</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">/</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">port</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">8080</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">initialDelaySeconds</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">15</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># 设置应用启动15秒后，才开始探针检查</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>如果探针检测的延时很短，可能导致应用还没有完全启动就开始检测，但检测的结果始终是失败的，这样应用会被无限重启。</p>
<h3 id="创建存活探针的注意事项">创建存活探针的注意事项</h3>
<h4 id="1-探针应该只检查应用内部的状态">1. 探针应该只检查应用内部的状态</h4>
<p>例如 web 程序依赖的数据库崩溃了，web 程序的存活探针不应该返回失败，否则就会导致应用程序被无限重启，但这样并不能恢复数据库。</p>
<h4 id="2-探针应该是轻量的">2. 探针应该是轻量的</h4>
<p>探针的CPU执行时间会占用 Pod 的执行时间，重量的探针会让 Pod 的 CPU 执行时间变短。</p>
<p>Java 和 Python 应用，启动时解释器会执行一些初始化操作，耗费大量的时间。应该使用 HTTP GET 探针，而不应该使用 Exec 探针。</p>
<h4 id="3-探针中的操作无需重试">3. 探针中的操作无需重试</h4>
<p>K8S 在检查应用的探针时就会自动重试，故探针内部只用做一次检查就好，无需重试。</p>
<h2 id="了解-replicationcontroller">了解 ReplicationController</h2>
<h3 id="介绍">介绍</h3>
<p>ReplicationController 旨在创建和管理一个 Pod 的多个副本(replicas)，这就是它名字的由来，ReplicationController 是通过标签来查看和管理容器。</p>
<p>ReplicationController 由三部分组成:</p>
<ol>
<li>Label Selector(标签选择器)，用于确定 ReplicationController 的作用域中有哪些 Pod</li>
<li>Replica Count(副本个数)，指定应该运行的 Pod 数量。</li>
<li>Pod template(Pod 模板)，用于创建新的 Pod 副本</li>
</ol>
<p><strong>注意:</strong> ReplicationController 管理的 Pod 不会从一个节点迁移到另一个节点上，它只会在另一个节点上新建一个 Pod，或者删除当前节点上的 Pod。</p>
<h3 id="创建-replicationcontroller">创建 ReplicationController</h3>
<p>以下是创建一个 ReplicationController 的示例文件</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ReplicationController</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kubia</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># 定义了 RC 的副本个数和标签选择器属性</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">replicas</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">selector</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">app</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kubia</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># template 定义了 Pod 模板</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">template</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#8f5902;font-style:italic"># 注意这里定义的标签要和 spec.selector 中定义的标签一致，否则 RC 就会不停地创建 Pod</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">labels</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">app</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kubia</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">containers</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kubia</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">image</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">bwangel/kubia:v0.1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">ports</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span>- <span style="color:#204a87;font-weight:bold">containerPort</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">8080</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p><strong>注意:</strong> 模板文件可以不指定选择器(spec.selector)，让 K8S 自动从 Pod 模板中提取标签配置</p>
<ul>
<li>创建好 RC 后，我们可以查看 集群中的 Pod，可以看到已经有对应标签的 Pod 被创建了</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>ø&gt; kubectl get pod --show-labels
</span></span><span style="display:flex;"><span>NAME          READY   STATUS              RESTARTS   AGE   LABELS
</span></span><span style="display:flex;"><span>kubia-8fnnc   1/1     Running             <span style="color:#0000cf;font-weight:bold">0</span>          36s   <span style="color:#000">app</span><span style="color:#ce5c00;font-weight:bold">=</span>kubia
</span></span><span style="display:flex;"><span>kubia-gswk6   0/1     ContainerCreating   <span style="color:#0000cf;font-weight:bold">0</span>          36s   <span style="color:#000">app</span><span style="color:#ce5c00;font-weight:bold">=</span>kubia
</span></span><span style="display:flex;"><span>kubia-q865j   1/1     Running             <span style="color:#0000cf;font-weight:bold">0</span>          36s   <span style="color:#000">app</span><span style="color:#ce5c00;font-weight:bold">=</span>kubia
</span></span></code></pre></div><ul>
<li>查看 RC 的详细信息</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>ø&gt; kubectl describe rc kubia
</span></span><span style="display:flex;"><span>Name:         kubia
</span></span><span style="display:flex;"><span>Namespace:    default
</span></span><span style="display:flex;"><span>Selector:     <span style="color:#000">app</span><span style="color:#ce5c00;font-weight:bold">=</span>kubia
</span></span><span style="display:flex;"><span>Labels:       <span style="color:#000">app</span><span style="color:#ce5c00;font-weight:bold">=</span>kubia
</span></span><span style="display:flex;"><span>Annotations:  &lt;none&gt;
</span></span><span style="display:flex;"><span>Replicas:     <span style="color:#0000cf;font-weight:bold">3</span> current / <span style="color:#0000cf;font-weight:bold">3</span> desired  <span style="color:#8f5902;font-style:italic"># 副本的实际数量和期望数量</span>
</span></span><span style="display:flex;"><span>Pods Status:  <span style="color:#0000cf;font-weight:bold">3</span> Running / <span style="color:#0000cf;font-weight:bold">0</span> Waiting / <span style="color:#0000cf;font-weight:bold">0</span> Succeeded / <span style="color:#0000cf;font-weight:bold">0</span> Failed  <span style="color:#8f5902;font-style:italic"># 当前各个状态的 Pod 数量</span>
</span></span><span style="display:flex;"><span>Pod Template:
</span></span><span style="display:flex;"><span>  Labels:  <span style="color:#000">app</span><span style="color:#ce5c00;font-weight:bold">=</span>kubia
</span></span><span style="display:flex;"><span>  Containers:
</span></span><span style="display:flex;"><span>   kubia:
</span></span><span style="display:flex;"><span>    Image:        bwangel/kubia:v0.1
</span></span><span style="display:flex;"><span>    Port:         8080/TCP
</span></span><span style="display:flex;"><span>    Host Port:    0/TCP
</span></span><span style="display:flex;"><span>    Environment:  &lt;none&gt;
</span></span><span style="display:flex;"><span>    Mounts:       &lt;none&gt;
</span></span><span style="display:flex;"><span>  Volumes:        &lt;none&gt;
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 这里列出了 RC 的事件</span>
</span></span><span style="display:flex;"><span>Events:
</span></span><span style="display:flex;"><span>  Type    Reason            Age   From                    Message
</span></span><span style="display:flex;"><span>  ----    ------            ----  ----                    -------
</span></span><span style="display:flex;"><span>  Normal  SuccessfulCreate  6m7s  replication-controller  Created pod: kubia-8fnnc
</span></span><span style="display:flex;"><span>  Normal  SuccessfulCreate  6m7s  replication-controller  Created pod: kubia-gswk6
</span></span><span style="display:flex;"><span>  Normal  SuccessfulCreate  6m7s  replication-controller  Created pod: kubia-q865j
</span></span></code></pre></div><h3 id="通过删除-pod-来看-rc-的自动恢复能力">通过删除 Pod 来看 RC 的自动恢复能力</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 查看当前所有的 Pod</span>
</span></span><span style="display:flex;"><span>ø&gt; kubectl get pod --show-labels
</span></span><span style="display:flex;"><span>NAME          READY   STATUS    RESTARTS   AGE     LABELS
</span></span><span style="display:flex;"><span>kubia-8fnnc   1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          9m36s   <span style="color:#000">app</span><span style="color:#ce5c00;font-weight:bold">=</span>kubia
</span></span><span style="display:flex;"><span>kubia-gswk6   1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          9m36s   <span style="color:#000">app</span><span style="color:#ce5c00;font-weight:bold">=</span>kubia
</span></span><span style="display:flex;"><span>kubia-q865j   1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          9m36s   <span style="color:#000">app</span><span style="color:#ce5c00;font-weight:bold">=</span>kubia
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 删除某个特定的 Pod</span>
</span></span><span style="display:flex;"><span>ø&gt; kubectl delete pod kubia-q865j
</span></span><span style="display:flex;"><span>pod <span style="color:#4e9a06">&#34;kubia-q865j&#34;</span> deleted
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 可以看到 RC 又重建了一个 Pod</span>
</span></span><span style="display:flex;"><span>ø&gt; kubectl get pod --show-labels
</span></span><span style="display:flex;"><span>NAME          READY   STATUS    RESTARTS   AGE   LABELS
</span></span><span style="display:flex;"><span>kubia-2c592   1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          14s   <span style="color:#000">app</span><span style="color:#ce5c00;font-weight:bold">=</span>kubia
</span></span><span style="display:flex;"><span>kubia-8fnnc   1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          10m   <span style="color:#000">app</span><span style="color:#ce5c00;font-weight:bold">=</span>kubia
</span></span><span style="display:flex;"><span>kubia-gswk6   1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          10m   <span style="color:#000">app</span><span style="color:#ce5c00;font-weight:bold">=</span>kubia
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 查看 RC 的详细信息</span>
</span></span><span style="display:flex;"><span>ø&gt; kubectl describe rc kubia
</span></span><span style="display:flex;"><span>Name:         kubia
</span></span><span style="display:flex;"><span>Selector:     <span style="color:#000">app</span><span style="color:#ce5c00;font-weight:bold">=</span>kubia
</span></span><span style="display:flex;"><span>Labels:       <span style="color:#000">app</span><span style="color:#ce5c00;font-weight:bold">=</span>kubia
</span></span><span style="display:flex;"><span>Replicas:     <span style="color:#0000cf;font-weight:bold">3</span> current / <span style="color:#0000cf;font-weight:bold">3</span> desired
</span></span><span style="display:flex;"><span>Pods Status:  <span style="color:#0000cf;font-weight:bold">3</span> Running / <span style="color:#0000cf;font-weight:bold">0</span> Waiting / <span style="color:#0000cf;font-weight:bold">0</span> Succeeded / <span style="color:#0000cf;font-weight:bold">0</span> Failed
</span></span><span style="display:flex;"><span>Pod Template:
</span></span><span style="display:flex;"><span>  Labels:  <span style="color:#000">app</span><span style="color:#ce5c00;font-weight:bold">=</span>kubia
</span></span><span style="display:flex;"><span>Events:
</span></span><span style="display:flex;"><span>  Type    Reason            Age   From                    Message
</span></span><span style="display:flex;"><span>  ----    ------            ----  ----                    -------
</span></span><span style="display:flex;"><span>  Normal  SuccessfulCreate  11m   replication-controller  Created pod: kubia-8fnnc
</span></span><span style="display:flex;"><span>  Normal  SuccessfulCreate  11m   replication-controller  Created pod: kubia-gswk6
</span></span><span style="display:flex;"><span>  Normal  SuccessfulCreate  11m   replication-controller  Created pod: kubia-q865j
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic"># 可以看到新增了一个新建 Pod 的事件</span>
</span></span><span style="display:flex;"><span>  Normal  SuccessfulCreate  85s   replication-controller  Created pod: kubia-2c592
</span></span></code></pre></div><p>当 K8S 的 API 服务器收到删除某个 Pod 的请求后，会将该事件通知相关的 RC。RC 收到事件通知后会去检查实际的 Pod 数量并采取适当的措施。</p>
<p>RC 不会对删除 Pod 操作本身做出反应，而是对删除 Pod 操作导致的状态 <code>Pod 数量不足</code> 做出了反应。</p>
<h3 id="通过停止节点来查看-rc-的自动恢复能力">通过停止节点来查看 RC 的自动恢复能力</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 查看当前 Pod 的状态</span>
</span></span><span style="display:flex;"><span>ø&gt; kubectl get pod --show-labels -o<span style="color:#ce5c00;font-weight:bold">=</span>wide
</span></span><span style="display:flex;"><span>NAME          READY   STATUS    RESTARTS   AGE     IP         NODE                                  NOMINATED NODE   READINESS GATES   LABELS
</span></span><span style="display:flex;"><span>kubia-2c592   1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          3m24s   10.0.2.5   gke-demo-default-pool-ade08258-zjhd   &lt;none&gt;           &lt;none&gt;            <span style="color:#000">app</span><span style="color:#ce5c00;font-weight:bold">=</span>kubia
</span></span><span style="display:flex;"><span>kubia-8fnnc   1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          13m     10.0.2.4   gke-demo-default-pool-ade08258-zjhd   &lt;none&gt;           &lt;none&gt;            <span style="color:#000">app</span><span style="color:#ce5c00;font-weight:bold">=</span>kubia
</span></span><span style="display:flex;"><span>kubia-gswk6   1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          13m     10.0.1.5   gke-demo-default-pool-ade08258-g3rl   &lt;none&gt;           &lt;none&gt;            <span style="color:#000">app</span><span style="color:#ce5c00;font-weight:bold">=</span>kubia
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 停掉 gke-demo-default-pool-ade08258-g3rl 节点</span>
</span></span><span style="display:flex;"><span>ø&gt; gcloud compute ssh gke-demo-default-pool-ade08258-g3rl
</span></span><span style="display:flex;"><span>Welcome to Kubernetes v1.14.10-gke.27!
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>You can find documentation <span style="color:#204a87;font-weight:bold">for</span> Kubernetes at:
</span></span><span style="display:flex;"><span>  http://docs.kubernetes.io/
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>The <span style="color:#204a87">source</span> <span style="color:#204a87;font-weight:bold">for</span> this release can be found at:
</span></span><span style="display:flex;"><span>  /home/kubernetes/kubernetes-src.tar.gz
</span></span><span style="display:flex;"><span>Or you can download it at:
</span></span><span style="display:flex;"><span>  https://storage.googleapis.com/kubernetes-release-gke/release/v1.14.10-gke.27/kubernetes-src.tar.gz
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>It is based on the Kubernetes <span style="color:#204a87">source</span> at:
</span></span><span style="display:flex;"><span>  https://github.com/kubernetes/kubernetes/tree/v1.14.10-gke.27
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>For Kubernetes copyright and licensing information, see:
</span></span><span style="display:flex;"><span>  /home/kubernetes/LICENSES
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 通过关闭网卡来停掉这个节点</span>
</span></span><span style="display:flex;"><span>michaeltsui@gke-demo-default-pool-ade08258-g3rl ~ $ sudo ifconfig eth0 down
</span></span><span style="display:flex;"><span>packet_write_wait: Connection to 35.234.11.33 port 22: Broken pipe
</span></span><span style="display:flex;"><span>ERROR: <span style="color:#ce5c00;font-weight:bold">(</span>gcloud.compute.ssh<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">[</span>/usr/bin/ssh<span style="color:#ce5c00;font-weight:bold">]</span> exited with <span style="color:#204a87;font-weight:bold">return</span> code <span style="color:#ce5c00;font-weight:bold">[</span>255<span style="color:#ce5c00;font-weight:bold">]</span>.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 查看所有节点的状态，发现被停掉节点的状态变成了 NotReady</span>
</span></span><span style="display:flex;"><span>ø&gt; kubectl get node --show-labels
</span></span><span style="display:flex;"><span>NAME                                  STATUS     ROLES    AGE   VERSION
</span></span><span style="display:flex;"><span>gke-demo-default-pool-ade08258-g3rl   NotReady   &lt;none&gt;   47h   v1.14.10-gke.27
</span></span><span style="display:flex;"><span>gke-demo-default-pool-ade08258-vqx4   Ready      &lt;none&gt;   19d   v1.14.10-gke.27
</span></span><span style="display:flex;"><span>gke-demo-default-pool-ade08258-zjhd   Ready      &lt;none&gt;   19d   v1.14.10-gke.27
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 查看 Pod 的状态，发现新建了一个 Pod kubia-fxkbc</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 被停掉节点上的 Pod kubia-gswk6 的状态变成了 Unknown</span>
</span></span><span style="display:flex;"><span>ø&gt; kubectl get pods --show-labels -o<span style="color:#ce5c00;font-weight:bold">=</span>wide
</span></span><span style="display:flex;"><span>NAME          READY   STATUS    RESTARTS   AGE    IP         NODE                                  NOMINATED NODE   READINESS GATES   LABELS
</span></span><span style="display:flex;"><span>kubia-2c592   1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          16m    10.0.2.5   gke-demo-default-pool-ade08258-zjhd   &lt;none&gt;           &lt;none&gt;            <span style="color:#000">app</span><span style="color:#ce5c00;font-weight:bold">=</span>kubia
</span></span><span style="display:flex;"><span>kubia-8fnnc   1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          26m    10.0.2.4   gke-demo-default-pool-ade08258-zjhd   &lt;none&gt;           &lt;none&gt;            <span style="color:#000">app</span><span style="color:#ce5c00;font-weight:bold">=</span>kubia
</span></span><span style="display:flex;"><span>kubia-fxkbc   1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          112s   10.0.2.6   gke-demo-default-pool-ade08258-zjhd   &lt;none&gt;           &lt;none&gt;            <span style="color:#000">app</span><span style="color:#ce5c00;font-weight:bold">=</span>kubia
</span></span><span style="display:flex;"><span>kubia-gswk6   1/1     Unknown   <span style="color:#0000cf;font-weight:bold">0</span>          26m    10.0.1.5   gke-demo-default-pool-ade08258-g3rl   &lt;none&gt;           &lt;none&gt;            <span style="color:#000">app</span><span style="color:#ce5c00;font-weight:bold">=</span>kubia
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 恢复被停掉的节点</span>
</span></span><span style="display:flex;"><span>ø&gt; gcloud compute instances reset gke-demo-default-pool-ade08258-g3rl
</span></span><span style="display:flex;"><span>Updated <span style="color:#ce5c00;font-weight:bold">[</span>https://www.googleapis.com/compute/v1/projects/braided-turbine-271114/zones/asia-east1-c/instances/gke-demo-default-pool-ade08258-g3rl<span style="color:#ce5c00;font-weight:bold">]</span>.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Updates are available <span style="color:#204a87;font-weight:bold">for</span> some Cloud SDK components.  To install them,
</span></span><span style="display:flex;"><span>please run:
</span></span><span style="display:flex;"><span>  $ gcloud components update
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>To take a quick anonymous survey, run:
</span></span><span style="display:flex;"><span>  $ gcloud survey
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 查看 K8S 集群中的节点也恢复了</span>
</span></span><span style="display:flex;"><span>ø&gt; kubectl get node
</span></span><span style="display:flex;"><span>NAME                                  STATUS   ROLES    AGE   VERSION
</span></span><span style="display:flex;"><span>gke-demo-default-pool-ade08258-g3rl   Ready    &lt;none&gt;   47h   v1.14.10-gke.27
</span></span><span style="display:flex;"><span>gke-demo-default-pool-ade08258-vqx4   Ready    &lt;none&gt;   19d   v1.14.10-gke.27
</span></span><span style="display:flex;"><span>gke-demo-default-pool-ade08258-zjhd   Ready    &lt;none&gt;   19d   v1.14.10-gke.27
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 节点恢复后，查看 Pod 会发现刚刚状态为 Unknown 的 Pod 被删除了。</span>
</span></span><span style="display:flex;"><span>ø&gt; kubectl get pods --show-labels -o<span style="color:#ce5c00;font-weight:bold">=</span>wide
</span></span><span style="display:flex;"><span>NAME          READY   STATUS    RESTARTS   AGE     IP         NODE                                  NOMINATED NODE   READINESS GATES   LABELS
</span></span><span style="display:flex;"><span>kubia-2c592   1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          19m     10.0.2.5   gke-demo-default-pool-ade08258-zjhd   &lt;none&gt;           &lt;none&gt;            <span style="color:#000">app</span><span style="color:#ce5c00;font-weight:bold">=</span>kubia
</span></span><span style="display:flex;"><span>kubia-8fnnc   1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          29m     10.0.2.4   gke-demo-default-pool-ade08258-zjhd   &lt;none&gt;           &lt;none&gt;            <span style="color:#000">app</span><span style="color:#ce5c00;font-weight:bold">=</span>kubia
</span></span><span style="display:flex;"><span>kubia-fxkbc   1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          5m35s   10.0.2.6   gke-demo-default-pool-ade08258-zjhd   &lt;none&gt;           &lt;none&gt;            <span style="color:#000">app</span><span style="color:#ce5c00;font-weight:bold">=</span>kubia
</span></span></code></pre></div><h3 id="将-pod-移入或移出-rc-的作用域">将 Pod 移入或移出 RC 的作用域</h3>
<p>ReplicationController 的工作方式:</p>
<blockquote>
<p>通过标签选择器来查看 Pod，如果与预期的数量不符，则新建 Pod 或删除 Pod，直到达到预期(<code>desired</code>)的数量。</p>
</blockquote>
<p>所以通过更改 Pod 的标签，可以将 Pod 从 RC 中移除。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 为 Pod 新增一个无关标签，并不影响RC</span>
</span></span><span style="display:flex;"><span>ø&gt; kubectl label pod kubia-2c592 <span style="color:#000">foo</span><span style="color:#ce5c00;font-weight:bold">=</span>bar
</span></span><span style="display:flex;"><span>pod/kubia-2c592 labeled
</span></span><span style="display:flex;"><span>ø&gt; kubectl get pods --show-labels
</span></span><span style="display:flex;"><span>NAME          READY   STATUS    RESTARTS   AGE     LABELS
</span></span><span style="display:flex;"><span>kubia-2c592   1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          6d23h   <span style="color:#000">app</span><span style="color:#ce5c00;font-weight:bold">=</span>kubia,foo<span style="color:#ce5c00;font-weight:bold">=</span>bar
</span></span><span style="display:flex;"><span>kubia-8fnnc   1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          6d23h   <span style="color:#000">app</span><span style="color:#ce5c00;font-weight:bold">=</span>kubia
</span></span><span style="display:flex;"><span>kubia-fxkbc   1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          6d23h   <span style="color:#000">app</span><span style="color:#ce5c00;font-weight:bold">=</span>kubia
</span></span><span style="display:flex;"><span>ø&gt; kubectl describe rc kubia
</span></span><span style="display:flex;"><span>Name:         kubia
</span></span><span style="display:flex;"><span>Namespace:    default
</span></span><span style="display:flex;"><span>Selector:     <span style="color:#000">app</span><span style="color:#ce5c00;font-weight:bold">=</span>kubia
</span></span><span style="display:flex;"><span>Labels:       <span style="color:#000">app</span><span style="color:#ce5c00;font-weight:bold">=</span>kubia
</span></span><span style="display:flex;"><span>Annotations:  &lt;none&gt;
</span></span><span style="display:flex;"><span>Replicas:     <span style="color:#0000cf;font-weight:bold">3</span> current / <span style="color:#0000cf;font-weight:bold">3</span> desired
</span></span><span style="display:flex;"><span>Pods Status:  <span style="color:#0000cf;font-weight:bold">3</span> Running / <span style="color:#0000cf;font-weight:bold">0</span> Waiting / <span style="color:#0000cf;font-weight:bold">0</span> Succeeded / <span style="color:#0000cf;font-weight:bold">0</span> Failed
</span></span><span style="display:flex;"><span>Pod Template:
</span></span><span style="display:flex;"><span>  Labels:  <span style="color:#000">app</span><span style="color:#ce5c00;font-weight:bold">=</span>kubia
</span></span><span style="display:flex;"><span>  Containers:
</span></span><span style="display:flex;"><span>   kubia:
</span></span><span style="display:flex;"><span>    Image:        bwangel/kubia:v0.1
</span></span><span style="display:flex;"><span>    Port:         8080/TCP
</span></span><span style="display:flex;"><span>    Host Port:    0/TCP
</span></span><span style="display:flex;"><span>    Environment:  &lt;none&gt;
</span></span><span style="display:flex;"><span>    Mounts:       &lt;none&gt;
</span></span><span style="display:flex;"><span>  Volumes:        &lt;none&gt;
</span></span><span style="display:flex;"><span>Events:           &lt;none&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 为 Pod 删除 app=kubia 标签，将 kubia-2c592 从 RC 中移除，</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 可以看到 RC 会自动创建一个 Pod，来达到预期的数量</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 注意必须指定 --overwrite 选项，否则 k8s 不会覆盖已有的标签 (一个防止误操作的保护措施)</span>
</span></span><span style="display:flex;"><span>ø&gt; kubectl label pod kubia-2c592 <span style="color:#000">app</span><span style="color:#ce5c00;font-weight:bold">=</span>bar --overwrite
</span></span><span style="display:flex;"><span>pod/kubia-2c592 labeled
</span></span><span style="display:flex;"><span>ø&gt; kubectl get pods --show-labels
</span></span><span style="display:flex;"><span>NAME          READY   STATUS    RESTARTS   AGE     LABELS
</span></span><span style="display:flex;"><span>kubia-2c592   1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          6d23h   <span style="color:#000">app</span><span style="color:#ce5c00;font-weight:bold">=</span>bar,foo<span style="color:#ce5c00;font-weight:bold">=</span>bar
</span></span><span style="display:flex;"><span>kubia-8fnnc   1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          6d23h   <span style="color:#000">app</span><span style="color:#ce5c00;font-weight:bold">=</span>kubia
</span></span><span style="display:flex;"><span>kubia-fxkbc   1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          6d23h   <span style="color:#000">app</span><span style="color:#ce5c00;font-weight:bold">=</span>kubia
</span></span><span style="display:flex;"><span>kubia-l8hs9   1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          6s      <span style="color:#000">app</span><span style="color:#ce5c00;font-weight:bold">=</span>kubia
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">5496</span> <span style="color:#ce5c00;font-weight:bold">(</span>lazywork<span style="color:#ce5c00;font-weight:bold">)</span> ~/k8s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 为 Pod 新增标签 app=kubia，让 Pod kubia-2c592 重新回到 RC 的管理中</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 可以看到 RC 会自动删除刚刚新建的 Pod，保持 Pod 数量达到预期</span>
</span></span><span style="display:flex;"><span>ø&gt; kubectl label pod kubia-2c592 <span style="color:#000">app</span><span style="color:#ce5c00;font-weight:bold">=</span>kubia --overwrite
</span></span><span style="display:flex;"><span>pod/kubia-2c592 labeled
</span></span><span style="display:flex;"><span>ø&gt; kubectl get pods --show-labels
</span></span><span style="display:flex;"><span>NAME          READY   STATUS        RESTARTS   AGE     LABELS
</span></span><span style="display:flex;"><span>kubia-2c592   1/1     Running       <span style="color:#0000cf;font-weight:bold">0</span>          6d23h   <span style="color:#000">app</span><span style="color:#ce5c00;font-weight:bold">=</span>kubia,foo<span style="color:#ce5c00;font-weight:bold">=</span>bar
</span></span><span style="display:flex;"><span>kubia-8fnnc   1/1     Running       <span style="color:#0000cf;font-weight:bold">0</span>          6d23h   <span style="color:#000">app</span><span style="color:#ce5c00;font-weight:bold">=</span>kubia
</span></span><span style="display:flex;"><span>kubia-fxkbc   1/1     Running       <span style="color:#0000cf;font-weight:bold">0</span>          6d23h   <span style="color:#000">app</span><span style="color:#ce5c00;font-weight:bold">=</span>kubia
</span></span><span style="display:flex;"><span>kubia-l8hs9   0/1     Terminating   <span style="color:#0000cf;font-weight:bold">0</span>          48s     <span style="color:#000">app</span><span style="color:#ce5c00;font-weight:bold">=</span>kubia
</span></span><span style="display:flex;"><span>ø&gt; kubectl get pods --show-labels
</span></span><span style="display:flex;"><span>NAME          READY   STATUS    RESTARTS   AGE     LABELS
</span></span><span style="display:flex;"><span>kubia-2c592   1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          6d23h   <span style="color:#000">app</span><span style="color:#ce5c00;font-weight:bold">=</span>kubia,foo<span style="color:#ce5c00;font-weight:bold">=</span>bar
</span></span><span style="display:flex;"><span>kubia-8fnnc   1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          6d23h   <span style="color:#000">app</span><span style="color:#ce5c00;font-weight:bold">=</span>kubia
</span></span><span style="display:flex;"><span>kubia-fxkbc   1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          6d23h   <span style="color:#000">app</span><span style="color:#ce5c00;font-weight:bold">=</span>kubia
</span></span></code></pre></div><h3 id="编辑-replicationcontroller">编辑 ReplicationController</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 编辑 RC，在 spec.template.metadata.labels 中新增标签 dae: k8s</span>
</span></span><span style="display:flex;"><span>ø&gt; kubectl edit rc kubia
</span></span><span style="display:flex;"><span>replicationcontroller/kubia edited
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 原有的 Pod 并不会发生改变</span>
</span></span><span style="display:flex;"><span>ø&gt; kubectl get pods --show-labels
</span></span><span style="display:flex;"><span>NAME          READY   STATUS    RESTARTS   AGE     LABELS
</span></span><span style="display:flex;"><span>kubia-2c592   1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          7d      <span style="color:#000">app</span><span style="color:#ce5c00;font-weight:bold">=</span>kubia,foo<span style="color:#ce5c00;font-weight:bold">=</span>bar
</span></span><span style="display:flex;"><span>kubia-8fnnc   1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          7d      <span style="color:#000">app</span><span style="color:#ce5c00;font-weight:bold">=</span>kubia
</span></span><span style="display:flex;"><span>kubia-fxkbc   1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          6d23h   <span style="color:#000">app</span><span style="color:#ce5c00;font-weight:bold">=</span>kubia
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 删除一个 Pod 后，发现新建的 Pod 会有 dae=k8s 的标签</span>
</span></span><span style="display:flex;"><span>ø&gt; kubectl delete pod kubia-2c592
</span></span><span style="display:flex;"><span>pod <span style="color:#4e9a06">&#34;kubia-2c592&#34;</span> deleted
</span></span><span style="display:flex;"><span>ø&gt; kubectl get pods --show-labels
</span></span><span style="display:flex;"><span>NAME          READY   STATUS    RESTARTS   AGE     LABELS
</span></span><span style="display:flex;"><span>kubia-47kt7   1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          9s      <span style="color:#000">app</span><span style="color:#ce5c00;font-weight:bold">=</span>kubia,dae<span style="color:#ce5c00;font-weight:bold">=</span>k8s
</span></span><span style="display:flex;"><span>kubia-8fnnc   1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          7d      <span style="color:#000">app</span><span style="color:#ce5c00;font-weight:bold">=</span>kubia
</span></span><span style="display:flex;"><span>kubia-fxkbc   1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          6d23h   <span style="color:#000">app</span><span style="color:#ce5c00;font-weight:bold">=</span>kubia
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 编辑 RC，修改 spec.relicas = 10，可以看到 RC 新建了 Pod，让 Pod 总数达到了10个</span>
</span></span><span style="display:flex;"><span>ø&gt; kubectl edit rc kubia
</span></span><span style="display:flex;"><span>replicationcontroller/kubia edited
</span></span><span style="display:flex;"><span>ø&gt; kubectl get pods --show-labels
</span></span><span style="display:flex;"><span>NAME          READY   STATUS    RESTARTS   AGE     LABELS
</span></span><span style="display:flex;"><span>kubia-2sgqm   1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          7s      <span style="color:#000">app</span><span style="color:#ce5c00;font-weight:bold">=</span>kubia,dae<span style="color:#ce5c00;font-weight:bold">=</span>k8s
</span></span><span style="display:flex;"><span>kubia-47kt7   1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          2m53s   <span style="color:#000">app</span><span style="color:#ce5c00;font-weight:bold">=</span>kubia,dae<span style="color:#ce5c00;font-weight:bold">=</span>k8s
</span></span><span style="display:flex;"><span>kubia-8fnnc   1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          7d      <span style="color:#000">app</span><span style="color:#ce5c00;font-weight:bold">=</span>kubia
</span></span><span style="display:flex;"><span>kubia-fxkbc   1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          6d23h   <span style="color:#000">app</span><span style="color:#ce5c00;font-weight:bold">=</span>kubia
</span></span><span style="display:flex;"><span>kubia-h2klc   1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          7s      <span style="color:#000">app</span><span style="color:#ce5c00;font-weight:bold">=</span>kubia,dae<span style="color:#ce5c00;font-weight:bold">=</span>k8s
</span></span><span style="display:flex;"><span>kubia-lx9k2   1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          7s      <span style="color:#000">app</span><span style="color:#ce5c00;font-weight:bold">=</span>kubia,dae<span style="color:#ce5c00;font-weight:bold">=</span>k8s
</span></span><span style="display:flex;"><span>kubia-mvvk8   1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          7s      <span style="color:#000">app</span><span style="color:#ce5c00;font-weight:bold">=</span>kubia,dae<span style="color:#ce5c00;font-weight:bold">=</span>k8s
</span></span><span style="display:flex;"><span>kubia-rxlpv   1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          7s      <span style="color:#000">app</span><span style="color:#ce5c00;font-weight:bold">=</span>kubia,dae<span style="color:#ce5c00;font-weight:bold">=</span>k8s
</span></span><span style="display:flex;"><span>kubia-tlnn9   1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          7s      <span style="color:#000">app</span><span style="color:#ce5c00;font-weight:bold">=</span>kubia,dae<span style="color:#ce5c00;font-weight:bold">=</span>k8s
</span></span><span style="display:flex;"><span>kubia-vx4kf   1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          7s      <span style="color:#000">app</span><span style="color:#ce5c00;font-weight:bold">=</span>kubia,dae<span style="color:#ce5c00;font-weight:bold">=</span>k8s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 通过 scale 命令，将 RC 期望的 Pod 降到了3</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 此时 RC 的描述文件也相应地发生了变化</span>
</span></span><span style="display:flex;"><span>ø&gt; kubectl scale replicationcontroller kubia --replicas<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">3</span>
</span></span><span style="display:flex;"><span>replicationcontroller/kubia scaled
</span></span><span style="display:flex;"><span>ø&gt; kubectl get pods --show-labels
</span></span><span style="display:flex;"><span>NAME          READY   STATUS        RESTARTS   AGE     LABELS
</span></span><span style="display:flex;"><span>kubia-2sgqm   0/1     Terminating   <span style="color:#0000cf;font-weight:bold">0</span>          2m19s   <span style="color:#000">app</span><span style="color:#ce5c00;font-weight:bold">=</span>kubia,dae<span style="color:#ce5c00;font-weight:bold">=</span>k8s
</span></span><span style="display:flex;"><span>kubia-47kt7   1/1     Running       <span style="color:#0000cf;font-weight:bold">0</span>          5m5s    <span style="color:#000">app</span><span style="color:#ce5c00;font-weight:bold">=</span>kubia,dae<span style="color:#ce5c00;font-weight:bold">=</span>k8s
</span></span><span style="display:flex;"><span>kubia-8fnnc   1/1     Running       <span style="color:#0000cf;font-weight:bold">0</span>          7d      <span style="color:#000">app</span><span style="color:#ce5c00;font-weight:bold">=</span>kubia
</span></span><span style="display:flex;"><span>kubia-fxkbc   1/1     Running       <span style="color:#0000cf;font-weight:bold">0</span>          6d23h   <span style="color:#000">app</span><span style="color:#ce5c00;font-weight:bold">=</span>kubia
</span></span><span style="display:flex;"><span>kubia-h2klc   0/1     Terminating   <span style="color:#0000cf;font-weight:bold">0</span>          2m19s   <span style="color:#000">app</span><span style="color:#ce5c00;font-weight:bold">=</span>kubia,dae<span style="color:#ce5c00;font-weight:bold">=</span>k8s
</span></span><span style="display:flex;"><span>kubia-lx9k2   0/1     Terminating   <span style="color:#0000cf;font-weight:bold">0</span>          2m19s   <span style="color:#000">app</span><span style="color:#ce5c00;font-weight:bold">=</span>kubia,dae<span style="color:#ce5c00;font-weight:bold">=</span>k8s
</span></span><span style="display:flex;"><span>kubia-mvvk8   0/1     Terminating   <span style="color:#0000cf;font-weight:bold">0</span>          2m19s   <span style="color:#000">app</span><span style="color:#ce5c00;font-weight:bold">=</span>kubia,dae<span style="color:#ce5c00;font-weight:bold">=</span>k8s
</span></span><span style="display:flex;"><span>kubia-rxlpv   0/1     Terminating   <span style="color:#0000cf;font-weight:bold">0</span>          2m19s   <span style="color:#000">app</span><span style="color:#ce5c00;font-weight:bold">=</span>kubia,dae<span style="color:#ce5c00;font-weight:bold">=</span>k8s
</span></span><span style="display:flex;"><span>kubia-tlnn9   0/1     Terminating   <span style="color:#0000cf;font-weight:bold">0</span>          2m19s   <span style="color:#000">app</span><span style="color:#ce5c00;font-weight:bold">=</span>kubia,dae<span style="color:#ce5c00;font-weight:bold">=</span>k8s
</span></span><span style="display:flex;"><span>kubia-vx4kf   0/1     Terminating   <span style="color:#0000cf;font-weight:bold">0</span>          2m19s   <span style="color:#000">app</span><span style="color:#ce5c00;font-weight:bold">=</span>kubia,dae<span style="color:#ce5c00;font-weight:bold">=</span>k8s
</span></span><span style="display:flex;"><span>ø&gt; kubectl get pods --show-labels
</span></span><span style="display:flex;"><span>NAME          READY   STATUS    RESTARTS   AGE     LABELS
</span></span><span style="display:flex;"><span>kubia-47kt7   1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          5m14s   <span style="color:#000">app</span><span style="color:#ce5c00;font-weight:bold">=</span>kubia,dae<span style="color:#ce5c00;font-weight:bold">=</span>k8s
</span></span><span style="display:flex;"><span>kubia-8fnnc   1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          7d      <span style="color:#000">app</span><span style="color:#ce5c00;font-weight:bold">=</span>kubia
</span></span><span style="display:flex;"><span>kubia-fxkbc   1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          6d23h   <span style="color:#000">app</span><span style="color:#ce5c00;font-weight:bold">=</span>kubia
</span></span></code></pre></div><h3 id="删除-replicationcontroller">删除 ReplicationController</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># --cascade=true: If true, cascade the deletion of the resources managed by this resource </span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># (e.g. Pods created by a ReplicationController).  Default true.</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 通过 --cascade=false 选项，在删除 RC 的时候不删除它管理的 Pod</span>
</span></span><span style="display:flex;"><span>ø&gt; kubectl delete rc kubia --cascade<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">false</span>
</span></span><span style="display:flex;"><span>replicationcontroller <span style="color:#4e9a06">&#34;kubia&#34;</span> deleted
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 发现 RC 已经被删除了</span>
</span></span><span style="display:flex;"><span>ø&gt; kubectl get rc
</span></span><span style="display:flex;"><span>No resources found in default namespace.
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 我们之前通过 RC 创建的 Pod 仍然存在</span>
</span></span><span style="display:flex;"><span>ø&gt; kubectl get pods --show-labels
</span></span><span style="display:flex;"><span>NAME          READY   STATUS    RESTARTS   AGE    LABELS
</span></span><span style="display:flex;"><span>kubia-47kt7   1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          8m8s   <span style="color:#000">app</span><span style="color:#ce5c00;font-weight:bold">=</span>kubia,dae<span style="color:#ce5c00;font-weight:bold">=</span>k8s
</span></span><span style="display:flex;"><span>kubia-8fnnc   1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          7d     <span style="color:#000">app</span><span style="color:#ce5c00;font-weight:bold">=</span>kubia
</span></span><span style="display:flex;"><span>kubia-fxkbc   1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          7d     <span style="color:#000">app</span><span style="color:#ce5c00;font-weight:bold">=</span>kubia
</span></span></code></pre></div><h2 id="使用-replicaset-而不是-replicationcontroller">使用 ReplicaSet 而不是 ReplicationController</h2>
<p>ReplicaSet 的标签选择器要比 ReplicationController 的更强大，以后都应该使用 ReplicaSet 而不是 ReplicationController。</p>
<h3 id="使用-replicaset">使用 ReplicaSet</h3>
<ul>
<li>kubia-replicaset.yaml</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># replicaset 资源属于 apps API 组的 v1beta2 版本</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">apps/v1beta2</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ReplicaSet</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kubia</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">replicas</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># 这里我们使用了简单的 matchLabels，它和 RC 中的直接指定标签的效果是一样的</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">selector</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">matchLabels</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">app</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kubia</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">template</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">labels</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">app</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kubia</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">containers</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kubia</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">image</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">bwangel/kubia:v0.1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><blockquote>
<p>apiVersion 的格式为 <code>API 组/API 版本</code>，如果没有指定 API 组，则表明此资源属于<code>核心 API 组</code>。</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 创建 ReplicaSet 资源</span>
</span></span><span style="display:flex;"><span>ø&gt; kubectl create -f kubia-replicaset.yaml
</span></span><span style="display:flex;"><span>replicaset.apps/kubia created
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 查看已经创建好的 ReplicaSet 资源</span>
</span></span><span style="display:flex;"><span>ø&gt; kubectl get rs
</span></span><span style="display:flex;"><span>NAME    DESIRED   CURRENT   READY   AGE
</span></span><span style="display:flex;"><span>kubia   <span style="color:#0000cf;font-weight:bold">3</span>         <span style="color:#0000cf;font-weight:bold">3</span>         <span style="color:#0000cf;font-weight:bold">3</span>       7s
</span></span><span style="display:flex;"><span>ø&gt; kubectl describe rs kubia
</span></span><span style="display:flex;"><span>Name:         kubia
</span></span><span style="display:flex;"><span>Namespace:    default
</span></span><span style="display:flex;"><span>Selector:     <span style="color:#000">app</span><span style="color:#ce5c00;font-weight:bold">=</span>kubia
</span></span><span style="display:flex;"><span>Labels:       &lt;none&gt;
</span></span><span style="display:flex;"><span>Annotations:  &lt;none&gt;
</span></span><span style="display:flex;"><span>Replicas:     <span style="color:#0000cf;font-weight:bold">3</span> current / <span style="color:#0000cf;font-weight:bold">3</span> desired
</span></span><span style="display:flex;"><span>Pods Status:  <span style="color:#0000cf;font-weight:bold">3</span> Running / <span style="color:#0000cf;font-weight:bold">0</span> Waiting / <span style="color:#0000cf;font-weight:bold">0</span> Succeeded / <span style="color:#0000cf;font-weight:bold">0</span> Failed
</span></span><span style="display:flex;"><span>Pod Template:
</span></span><span style="display:flex;"><span>  Labels:  <span style="color:#000">app</span><span style="color:#ce5c00;font-weight:bold">=</span>kubia
</span></span><span style="display:flex;"><span>  Containers:
</span></span><span style="display:flex;"><span>   kubia:
</span></span><span style="display:flex;"><span>    Image:        bwangel/kubia:v0.1
</span></span><span style="display:flex;"><span>    Port:         &lt;none&gt;
</span></span><span style="display:flex;"><span>    Host Port:    &lt;none&gt;
</span></span><span style="display:flex;"><span>    Environment:  &lt;none&gt;
</span></span><span style="display:flex;"><span>    Mounts:       &lt;none&gt;
</span></span><span style="display:flex;"><span>  Volumes:        &lt;none&gt;
</span></span><span style="display:flex;"><span>Events:           &lt;none&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 查看命名空间中的所有 Pod，可以看到 RS 没有创建新的 Pod，而是使用之前遗留的 Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 故我们指定的新 Pod 模板没有生效，如果需要让 Pod 使用新的模板创建，需要把这些遗留的 Pod 删掉，让 RS 再创建新的 Pod</span>
</span></span><span style="display:flex;"><span>ø&gt; kubectl get pods --show-labels
</span></span><span style="display:flex;"><span>NAME          READY   STATUS    RESTARTS   AGE    LABELS
</span></span><span style="display:flex;"><span>kubia-47kt7   1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          7h9m   <span style="color:#000">app</span><span style="color:#ce5c00;font-weight:bold">=</span>kubia,dae<span style="color:#ce5c00;font-weight:bold">=</span>k8s
</span></span><span style="display:flex;"><span>kubia-8fnnc   1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          7d7h   <span style="color:#000">app</span><span style="color:#ce5c00;font-weight:bold">=</span>kubia
</span></span><span style="display:flex;"><span>kubia-fxkbc   1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          7d7h   <span style="color:#000">app</span><span style="color:#ce5c00;font-weight:bold">=</span>kubia
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 删除我们刚刚创建的 RS</span>
</span></span><span style="display:flex;"><span>ø&gt; kubectl delete rs kubia
</span></span><span style="display:flex;"><span>replicaset.extensions <span style="color:#4e9a06">&#34;kubia&#34;</span> deleted
</span></span><span style="display:flex;"><span>ø&gt; kubectl get pods --show-labels
</span></span><span style="display:flex;"><span>No resources found in default namespace.
</span></span><span style="display:flex;"><span>ø&gt; kubectl get rs
</span></span><span style="display:flex;"><span>No resources found in default namespace.
</span></span></code></pre></div><h3 id="使用-replicaset-更富表达力的标签选择器">使用 ReplicaSet 更富表达力的标签选择器</h3>
<p>RS 标签选择器的配置文件格式:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">selector</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">matchExpressions</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:bold">key</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">app</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">operator</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">In</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">values</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#000">kubia</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>一个 matchExpressions 可以有多个表达式，这些表达式之间是<code>与</code>的关系。</p>
<p>一个表达式由三部分构成: <code>key</code>, <code>operator</code>, <code>values</code>(可选)</p>
<p><code>operator</code> 有以下四种情况:</p>
<ol>
<li><code>In</code>: Label 的值必须与其中一个指定的 values 匹配</li>
<li><code>NotIn</code>: Label 的值与任何指定的 values 不匹配</li>
<li><code>Exists</code>: pod 必须包含一个指定名称的标签(值不重要)。使用此运算符时，values 属性不得指定</li>
<li><code>DoesNotExist</code>: pod 不得包含一个指定名称的标签。values 属性不得指定</li>
</ol>
<p>如果同时指定了 <code>matchExpressions</code> 和 <code>matchLabels</code>，则 Pod 必须同时满足两者的条件，它才会被选中。</p>
<h2 id="使用-daemonset">使用 DaemonSet</h2>
<p>DaemonSet 的 Pod 实例可以在每个节点上运行，且每个节点都只运行一个 Pod 实例。在不可调度的节点上，DaemonSet 也会运行 Pod，DaemonSet 部署 Pod 会完全绕过调度器。</p>
<h3 id="创建并使用-daemonset">创建并使用 DaemonSet</h3>
<ul>
<li>ssd-monitor-daemonset.yaml</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">apps/v1beta2</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">DaemonSet</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ssd-monitor</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">selector</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#8f5902;font-style:italic"># matchLabels 指定 DaemonSet 选择 pod 时使用的标签</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">matchLabels</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">app</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ssd-monitor</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">template</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">labels</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">app</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ssd-monitor</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#8f5902;font-style:italic"># nodeSelector 指定 DaemonSet 选择节点时使用的标签</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">nodeSelector</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">disk</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">ssd</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">containers</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">main</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">image</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">luksa/ssd-monitor</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 创建 DaemonSet</span>
</span></span><span style="display:flex;"><span>ø&gt; kubectl create -f ssd-monitor-daemonset.yaml
</span></span><span style="display:flex;"><span>daemonset.apps/ssd-monitor created
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 由于集群中没有符合条件的节点(存在标签 disk=ssd)，所以 DaemonSet 没有创建任何 Pod 实例</span>
</span></span><span style="display:flex;"><span>ø&gt; kubectl get pods --show-labels
</span></span><span style="display:flex;"><span>No resources found in default namespace.
</span></span><span style="display:flex;"><span>ø&gt; kubectl get ds --show-labels
</span></span><span style="display:flex;"><span>NAME          DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR   AGE   LABELS
</span></span><span style="display:flex;"><span>ssd-monitor   <span style="color:#0000cf;font-weight:bold">0</span>         <span style="color:#0000cf;font-weight:bold">0</span>         <span style="color:#0000cf;font-weight:bold">0</span>       <span style="color:#0000cf;font-weight:bold">0</span>            <span style="color:#0000cf;font-weight:bold">0</span>           <span style="color:#000">disk</span><span style="color:#ce5c00;font-weight:bold">=</span>ssd        11s   &lt;none&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 为节点 gke-demo-default-pool-ade08258-zjhd 加上标签</span>
</span></span><span style="display:flex;"><span>ø&gt; kubectl label node gke-demo-default-pool-ade08258-zjhd <span style="color:#000">disk</span><span style="color:#ce5c00;font-weight:bold">=</span>ssd
</span></span><span style="display:flex;"><span>node/gke-demo-default-pool-ade08258-zjhd labeled
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 可以看到 Pod 实例被创建了</span>
</span></span><span style="display:flex;"><span>ø&gt; kubectl get pods --show-labels
</span></span><span style="display:flex;"><span>NAME                READY   STATUS              RESTARTS   AGE   LABELS
</span></span><span style="display:flex;"><span>ssd-monitor-rfzg7   0/1     ContainerCreating   <span style="color:#0000cf;font-weight:bold">0</span>          6s    <span style="color:#000">app</span><span style="color:#ce5c00;font-weight:bold">=</span>ssd-monitor,controller-revision-hash<span style="color:#ce5c00;font-weight:bold">=</span>645b8b64c4,pod-template-generation<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>ø&gt; kubectl get pods --show-labels
</span></span><span style="display:flex;"><span>NAME                READY   STATUS    RESTARTS   AGE   LABELS
</span></span><span style="display:flex;"><span>ssd-monitor-rfzg7   1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          19s   <span style="color:#000">app</span><span style="color:#ce5c00;font-weight:bold">=</span>ssd-monitor,controller-revision-hash<span style="color:#ce5c00;font-weight:bold">=</span>645b8b64c4,pod-template-generation<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 删除掉节点的 disk=ssd 标签</span>
</span></span><span style="display:flex;"><span>ø&gt; kubectl label node gke-demo-default-pool-ade08258-zjhd <span style="color:#000">disk</span><span style="color:#ce5c00;font-weight:bold">=</span>hhd --overwrite
</span></span><span style="display:flex;"><span>node/gke-demo-default-pool-ade08258-zjhd labeled
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># DaemonSet 对应的 Pod 实例也开始删除</span>
</span></span><span style="display:flex;"><span>ø&gt; kubectl get pods --show-labels
</span></span><span style="display:flex;"><span>NAME                READY   STATUS        RESTARTS   AGE   LABELS
</span></span><span style="display:flex;"><span>ssd-monitor-rfzg7   1/1     Terminating   <span style="color:#0000cf;font-weight:bold">0</span>          48s   <span style="color:#000">app</span><span style="color:#ce5c00;font-weight:bold">=</span>ssd-monitor,controller-revision-hash<span style="color:#ce5c00;font-weight:bold">=</span>645b8b64c4,pod-template-generation<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>ø&gt; kubectl get pods --show-labels
</span></span><span style="display:flex;"><span>No resources found in default namespace.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 删除 DaemonSet</span>
</span></span><span style="display:flex;"><span>ø&gt; kubectl delete ds ssd-monitor
</span></span><span style="display:flex;"><span>daemonset.extensions <span style="color:#4e9a06">&#34;ssd-monitor&#34;</span> deleted
</span></span></code></pre></div><h2 id="运行单个任务的-pod----job">运行单个任务的 Pod &ndash; Job</h2>
<p>Job 是 K8S 上的一种资源，它会运行一个或多个 Pod，它在 Pod 内的进程成功结束时，不重启容器，一旦任务完成， Pod 就被认为处于完成状态。</p>
<p>在发生节点故障时，该节点上由 Job 管理的 Pod 将按照 ReplicationController 的方式，将 Pod 重新安排到其他节点。如果进程本身异常退出(进程返回错误退出代码)，可以将 Job 配置为重新启动 Pod。</p>
<h3 id="定义--查看-job-资源">定义 &amp; 查看 Job 资源</h3>
<ul>
<li>exporter.yaml</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">batch/v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Job</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">batch-job</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># 注意，我们没有显示地为 Job 指定 Selector 来让其选择 Pod</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># Job 将会自动根据 Pod 创建时使用的标签来创建 Selector</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">template</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">labels</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">app</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">batch-job</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">restartPolicy</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">OnFailure</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">containers</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">main</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">image</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">luksa/batch-job</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>在 Pod 的定义中，我们可以指定在容器中运行的进程结束时，K8S 会做什么，这是通过<code>restartPolicy</code>选项指定的，默认是 <code>Always</code>。</p>
<p>但 Job Pod 不能使用默认策略，需要明确地将重启策略设置为 <code>OnFailure</code> 或 <code>Never</code>。此设置防止容器在完成任务后重新启动。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 创建 Job</span>
</span></span><span style="display:flex;"><span>ø&gt; kubectl create -f exporter.yaml
</span></span><span style="display:flex;"><span>job.batch/batch-job created
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 查看所有 Job</span>
</span></span><span style="display:flex;"><span>ø&gt; kubectl get job
</span></span><span style="display:flex;"><span>NAME        COMPLETIONS   DURATION   AGE
</span></span><span style="display:flex;"><span>batch-job   0/1           6s         6s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 查看 Job 创建的 Pod</span>
</span></span><span style="display:flex;"><span>ø&gt; kubectl get pod
</span></span><span style="display:flex;"><span>NAME              READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>batch-job-b24d2   1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          9s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Job 运行完成后状态会变成 Complated</span>
</span></span><span style="display:flex;"><span>ø&gt; kubectl get pod --show-all
</span></span><span style="display:flex;"><span>NAME              READY   STATUS      RESTARTS   AGE     LABELS
</span></span><span style="display:flex;"><span>batch-job-b24d2   0/1     Completed   <span style="color:#0000cf;font-weight:bold">0</span>          3m37s   <span style="color:#000">app</span><span style="color:#ce5c00;font-weight:bold">=</span>batch-job,controller-uid<span style="color:#ce5c00;font-weight:bold">=</span>1b33484a-7f20-11ea-87c1-42010a8c00bc,job-name<span style="color:#ce5c00;font-weight:bold">=</span>batch-job
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 可以查看到这个 Pod 运行时输出的日志</span>
</span></span><span style="display:flex;"><span>ø&gt; kubectl logs batch-job-b24d2
</span></span><span style="display:flex;"><span>Wed Apr <span style="color:#0000cf;font-weight:bold">15</span> 13:50:51 UTC <span style="color:#0000cf;font-weight:bold">2020</span> Batch job starting
</span></span><span style="display:flex;"><span>Wed Apr <span style="color:#0000cf;font-weight:bold">15</span> 13:52:51 UTC <span style="color:#0000cf;font-weight:bold">2020</span> Finished succesfully
</span></span></code></pre></div><h3 id="在-job-中运行多个-pod-实例">在 Job 中运行多个 Pod 实例</h3>
<ul>
<li>exporter-parallel.yaml</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">batch/v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Job</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">batch-job-parallel</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">completions</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># Pod 运行的总次数</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">parallelism</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># 可以同时运行的 Pod 的数量</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">template</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">labels</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">app</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">batch-job-parallel</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">restartPolicy</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">OnFailure</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">containers</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">main</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">image</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">luksa/batch-job</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 可以看到 COMPLETIONS 列是 0/5</span>
</span></span><span style="display:flex;"><span>ø&gt; kubectl get job
</span></span><span style="display:flex;"><span>NAME                 COMPLETIONS   DURATION   AGE
</span></span><span style="display:flex;"><span>batch-job-parallel   0/5           6s         6s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 同时有两个 Pod 在运行</span>
</span></span><span style="display:flex;"><span>ø&gt; kubectl get pod
</span></span><span style="display:flex;"><span>NAME                       READY   STATUS      RESTARTS   AGE
</span></span><span style="display:flex;"><span>batch-job-parallel-kf2px   1/1     Running     <span style="color:#0000cf;font-weight:bold">0</span>          16s
</span></span><span style="display:flex;"><span>batch-job-parallel-qjkkc   1/1     Running     <span style="color:#0000cf;font-weight:bold">0</span>          16s
</span></span></code></pre></div><h3 id="job-的限制">Job 的限制</h3>
<ul>
<li><code>spec.activeDeadlineSeconds</code> 设置 Job 的超时时间</li>
<li><code>spec.backoffLimit</code> 设置 Job 被标记为失败之前重试的次数</li>
</ul>
<p><code>spec.activeDeadlineSeconds</code> 的优先级高于 <code>spec.backoffLimit</code>，即一旦到达限制的时间，即使重试次数小于<code>spec.backoffLimit</code>， Job 也会终止。</p>
<h2 id="安排-job-定期运行或在将来运行一次----cronjob">安排 Job 定期运行或在将来运行一次 &ndash; CronJob</h2>
<ul>
<li>cronjob.yaml</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">batch/v1beta1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">CronJob</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">batch-job-every-five-minutes</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># Job 必须在15秒内开始运行，如果15秒内未开始运行，Job 将不会运行，并且将状态设置为 Failed</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">startingDeadlineSeconds</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">15</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">schedule</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;*/5 * * * *&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">jobTemplate</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">template</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">labels</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span><span style="color:#204a87;font-weight:bold">app</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">periodic-batch-job</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">restartPolicy</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">OnFailure</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">          </span><span style="color:#204a87;font-weight:bold">containers</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">            </span>- <span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">main</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">              </span><span style="color:#204a87;font-weight:bold">image</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">luksa/batch-job</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 创建 CronJob</span>
</span></span><span style="display:flex;"><span>ø&gt; kubectl create -f cronjob.yaml
</span></span><span style="display:flex;"><span>cronjob.batch/batch-job-every-five-minutes created
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 查看 CronJob</span>
</span></span><span style="display:flex;"><span>ø&gt; kubectl get cronjob
</span></span><span style="display:flex;"><span>NAME                              SCHEDULE      SUSPEND   ACTIVE   LAST SCHEDULE   AGE
</span></span><span style="display:flex;"><span>batch-job-every-fifteen-minutes   */5 * * * *   False     <span style="color:#0000cf;font-weight:bold">1</span>        14s             6m40s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 查看 Job，由于未到设置的时间，我们没有发现运行的 CronJob</span>
</span></span><span style="display:flex;"><span>ø&gt; kubectl get job
</span></span><span style="display:flex;"><span>NAME                 COMPLETIONS   DURATION   AGE
</span></span><span style="display:flex;"><span>batch-job            1/1           2m5s       98m
</span></span><span style="display:flex;"><span>batch-job-parallel   5/5           6m13s      74m
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 到了指定的时间后，我们可以看到 K8S 创建了对应的 Job</span>
</span></span><span style="display:flex;"><span>ø&gt; kubectl get job
</span></span><span style="display:flex;"><span>NAME                                         COMPLETIONS   DURATION   AGE
</span></span><span style="display:flex;"><span>batch-job                                    1/1           2m5s       99m
</span></span><span style="display:flex;"><span>batch-job-every-five-minutes-1586964600      0/1           3s         3s
</span></span><span style="display:flex;"><span>batch-job-parallel                           5/5           6m13s      75m
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 同时也可以看到正在执行具体程序的 Pod</span>
</span></span><span style="display:flex;"><span>ø&gt; kubectl get pod
</span></span><span style="display:flex;"><span>NAME                                               READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>batch-job-every-fifve-minutes-1586964600-k8j2f     1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          44s
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 在运行的同时也可以查看当前 Job 的 Pod 的日志</span>
</span></span><span style="display:flex;"><span>ø&gt; kubectl logs batch-job-every-five-minutes-1586964600-k8j2f
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 注意程序的开始时间，延迟了11秒</span>
</span></span><span style="display:flex;"><span>Wed Apr <span style="color:#0000cf;font-weight:bold">15</span> 15:30:11 UTC <span style="color:#0000cf;font-weight:bold">2020</span> Batch job starting
</span></span></code></pre></div><p>Cronjob 并不是精确运行的，可能会同时运行两个 Job，或者一个 Job 也不运行。因此开发者需要确保定时运行的 Job 是幂等的，多次运行也不会报错。</p>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-f304a0762141011be226e59429050213">10.1.7 - 3-Pod</h1>
    
	<blockquote>
<p>Pod - 运行于 Kubernetes 中的容器</p>
</blockquote>
<hr>
<h2 id="介绍-pod">介绍 pod</h2>
<ul>
<li>pod 内可以运行一个或多个容器，一个 pod 绝不会跨越多个工作节点。</li>
<li>pod 内的容器可以分为主容器和 sidecar 容器。(支持容器)</li>
</ul>
<hr>
<ul>
<li>Question: 为什么每个容器内只运行一个进程?</li>
<li>Answer: 如果我们在容器内运行多个进程，那么管理这些进程的启动，停止，重启就会变得复杂。同时，由于进程们的输出都写到了 Docker 的输出中，分别管理它们的日志也不容易，未能充分利用 Docker 的特性。</li>
</ul>
<h3 id="pod-内容器的共享与隔离">Pod 内容器的共享与隔离</h3>
<p>Kubernetes 通过配置 Docker 来让一个 pod 内的所有容器共享 Linux 命名空间。</p>
<p>具体来说:</p>
<ul>
<li>pod 内的所有容器共享 Network, UTS，IPC 命名空间，这样 pod 内的所有容器具有相同的网络环境和主机名，他们之间可以相互进行 IPC 通信。(配置端口时要注意不让他们的端口发生冲突，同时他们可以通过 localhost 地址进行通信。)</li>
<li>PID 命名空间默认是不共享的，可以通过配置开启。</li>
<li>Mount 命名空间是不共享的，pod 内的容器相互是独立的根目录。如果容器之间想要共享文件的话，可以配置 k8s Volume 资源共享文件目录</li>
</ul>
<h3 id="pod-的网络">Pod 的网络</h3>
<p>k8s 集群中所有的 pod 都在同一个网络地址空间中，他们之间没有 NAT 网关。</p>
<h2 id="通过-manifest-创建-pod">通过 Manifest 创建 Pod</h2>
<h3 id="常用命令">常用命令</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 输出一个 Pod 的 yaml 配置</span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">`</span>kubectl get pod podName -o<span style="color:#ce5c00;font-weight:bold">=</span>yaml<span style="color:#4e9a06">`</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 获取配置的文档</span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">`</span>kubectl explain pod<span style="color:#4e9a06">`</span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">`</span>kubectl explain pod.spec.containers<span style="color:#4e9a06">`</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 通过 manifest 创建一个 Pod</span>
</span></span><span style="display:flex;"><span><span style="color:#4e9a06">`</span>kubectl create -f somefile.yaml<span style="color:#4e9a06">`</span>
</span></span></code></pre></div><h3 id="manifest-说明">Manifest 说明</h3>
<pre tabindex="0"><code>apiVersion: v1
kind: Pod
metadata:
  annotations:
    kubernetes.io/limit-ranger: &#39;LimitRanger plugin set: cpu request for container
      kubiame&#39;
  creationTimestamp: &#34;2020-03-16T13:35:38Z&#34;
  generateName: kubiame-
  labels:
    run: kubiame
  name: kubiame-8wt8x
  namespace: default
  ownerReferences:
  - apiVersion: v1
    blockOwnerDeletion: true
    controller: true
    kind: ReplicationController
    name: kubiame
    uid: bd10842d-6602-11ea-93a6-42010a8c003a
  resourceVersion: &#34;591803&#34;
  selfLink: /api/v1/namespaces/default/pods/kubiame-8wt8x
  uid: 05e120ae-678b-11ea-baaa-42010a8c0091
spec:
  containers:
  - image: bwangel/kubia:v0.1
    imagePullPolicy: IfNotPresent
    name: kubiame
    ports:
    - containerPort: 8080
      protocol: TCP
    resources:
      requests:
        cpu: 100m
    terminationMessagePath: /dev/termination-log
    terminationMessagePolicy: File
    volumeMounts:
    - mountPath: /var/run/secrets/kubernetes.io/serviceaccount
      name: default-token-hbl2l
      readOnly: true
  dnsPolicy: ClusterFirst
  enableServiceLinks: true
  nodeName: gke-demo-default-pool-ade08258-vqx4
  priority: 0
  restartPolicy: Always
  schedulerName: default-scheduler
  securityContext: {}
  serviceAccount: default
  serviceAccountName: default
  terminationGracePeriodSeconds: 30
  tolerations:
  - effect: NoExecute
    key: node.kubernetes.io/not-ready
    operator: Exists
    tolerationSeconds: 300
  - effect: NoExecute
    key: node.kubernetes.io/unreachable
    operator: Exists
    tolerationSeconds: 300
  volumes:
  - name: default-token-hbl2l
    secret:
      defaultMode: 420
      secretName: default-token-hbl2l
status:
  conditions:
  - lastProbeTime: null
    lastTransitionTime: &#34;2020-03-16T13:35:38Z&#34;
    status: &#34;True&#34;
    type: Initialized
  - lastProbeTime: null
    lastTransitionTime: &#34;2020-03-16T13:36:18Z&#34;
    status: &#34;True&#34;
    type: Ready
  - lastProbeTime: null
    lastTransitionTime: &#34;2020-03-16T13:36:18Z&#34;
    status: &#34;True&#34;
    type: ContainersReady
  - lastProbeTime: null
    lastTransitionTime: &#34;2020-03-16T13:35:38Z&#34;
    status: &#34;True&#34;
    type: PodScheduled
  containerStatuses:
  - containerID: docker://59a3d4a8f8778b7fa6424f91246180a82435cda5867915008250004b2171562a
    image: bwangel/kubia:v0.1
    imageID: docker-pullable://bwangel/kubia@sha256:16a200e2b44a2e9b28fe9c40338d3766f376130f806e263193dba02fb6d40c7c
    lastState: {}
    name: kubiame
    ready: true
    restartCount: 0
    state:
      running:
        startedAt: &#34;2020-03-16T13:36:17Z&#34;
  hostIP: 10.140.0.2
  phase: Running
  podIP: 10.0.0.6
  qosClass: Burstable
  startTime: &#34;2020-03-16T13:35:38Z&#34;
</code></pre><p>上面是通过 <code>kubectl get pod -o=yaml</code> 获取的完整的配置文件，一个 Pod 的YAML配置文件主要包括这么几部分:</p>
<table>
<thead>
<tr>
<th>名称</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>apiVersion</code></td>
<td>k8s API 的版本</td>
</tr>
<tr>
<td><code>kind</code></td>
<td>定义的资源的类型</td>
</tr>
<tr>
<td><code>metadata</code>部分</td>
<td>Pod 的名称，命名空间，标签以及其他信息</td>
</tr>
<tr>
<td><code>spec</code>部分</td>
<td>Pod 内容的实际说明，例如 Pod 的容器，卷等</td>
</tr>
<tr>
<td><code>status</code>部分</td>
<td>Pod 的状态信息 (创建 Pod 时，无需指定 status 部分)</td>
</tr>
</tbody>
</table>
<h2 id="创建一个-pod">创建一个 Pod</h2>
<p>下面是创建 Pod 所需的 Manifest 文件, <code>kubia-manual.yaml</code>，使用命令 <code>kubectl create -f kubia-manual.yaml</code> 就可以创建一个 Pod 了。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Pod</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kubia-manual</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">containers</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:bold">image</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">bwangel/kubia:v0.1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kubiame</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">ports</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:bold">containerPort</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">8080</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">protocol</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">TCP</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>需要注意的是, <code>ports</code> 部分是信息式的，即使 Manifest 中未声明 <code>ports</code>，只要应用监听了<code>0.0.0.0:8080</code>，其他 Pod 仍然能够访问这个 Pod 的 8080 端口。采用这样的声明可以让其他用户方便地了解到这个 Pod 暴露了哪些端口。</p>
<h2 id="端口转发--查看日志">端口转发 &amp; 查看日志</h2>
<p>可以通过<code>端口转发</code>来访问 pod</p>
<pre tabindex="0"><code>kubectl port-forward kubia-manual &lt;本地端口&gt;:&lt;Pod 暴露的端口&gt;
</code></pre><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 查看日志</span>
</span></span><span style="display:flex;"><span>kubectl logs -f &lt;Pod 名称&gt; -c &lt;容器的名称&gt;
</span></span></code></pre></div><h2 id="使用标签组织-pod">使用标签组织 Pod</h2>
<p>标签是可以附加到资源的任意键值对，用以选择具有该确切标签的资源(这是通过标签选择器完成的)。</p>
<h3 id="查看-pod-的标签">查看 Pod 的标签</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 查看所有标签</span>
</span></span><span style="display:flex;"><span>ø&gt; kubectl get pod --show-labels
</span></span><span style="display:flex;"><span>NAME              READY   STATUS    RESTARTS   AGE     LABELS
</span></span><span style="display:flex;"><span>kubia-manual      1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          6d      &lt;none&gt;
</span></span><span style="display:flex;"><span>kubia-manual-v2   1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          59s     <span style="color:#000">creation_method</span><span style="color:#ce5c00;font-weight:bold">=</span>manual,env<span style="color:#ce5c00;font-weight:bold">=</span>prod
</span></span><span style="display:flex;"><span>kubiame-fvh8x     1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          5d22h   <span style="color:#000">run</span><span style="color:#ce5c00;font-weight:bold">=</span>kubiame
</span></span><span style="display:flex;"><span>kubiame-hcjkf     1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          5d22h   <span style="color:#000">run</span><span style="color:#ce5c00;font-weight:bold">=</span>kubiame
</span></span><span style="display:flex;"><span>kubiame-qvw7w     1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          5d22h   <span style="color:#000">run</span><span style="color:#ce5c00;font-weight:bold">=</span>kubiame
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 查看指定标签</span>
</span></span><span style="display:flex;"><span>ø&gt; kubectl get pod -L creation_method,env
</span></span><span style="display:flex;"><span>NAME              READY   STATUS    RESTARTS   AGE     CREATION_METHOD   ENV
</span></span><span style="display:flex;"><span>kubia-manual      1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          6d
</span></span><span style="display:flex;"><span>kubia-manual-v2   1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          63s     manual            prod
</span></span><span style="display:flex;"><span>kubiame-fvh8x     1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          5d22h
</span></span><span style="display:flex;"><span>kubiame-hcjkf     1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          5d22h
</span></span><span style="display:flex;"><span>kubiame-qvw7w     1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          5d22h
</span></span></code></pre></div><h3 id="修改-pod-的标签">修改 Pod 的标签</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 为 Pod 新增标签</span>
</span></span><span style="display:flex;"><span>ø&gt; kubectl label pod kubia-manual <span style="color:#000">creation_method</span><span style="color:#ce5c00;font-weight:bold">=</span>manual
</span></span><span style="display:flex;"><span>pod/kubia-manual labeled
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 修改 Pod 的已有标签</span>
</span></span><span style="display:flex;"><span>ø&gt; kubectl label pod kubia-manual-v2 <span style="color:#000">env</span><span style="color:#ce5c00;font-weight:bold">=</span>debug --overwrite
</span></span><span style="display:flex;"><span>pod/kubia-manual-v2 labeled
</span></span><span style="display:flex;"><span>ø&gt; kubectl get pod -L creation_method,env
</span></span><span style="display:flex;"><span>NAME              READY   STATUS    RESTARTS   AGE     CREATION_METHOD   ENV
</span></span><span style="display:flex;"><span>kubia-manual      1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          6d      manual
</span></span><span style="display:flex;"><span>kubia-manual-v2   1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          2m52s   manual            debug
</span></span></code></pre></div><h2 id="通过标签选择器列出-pod-子集">通过标签选择器列出 Pod 子集</h2>
<p>标签选择器可以根据资源的以下条件来选择资源:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 包含(或者不包含)使用特定建的标签</span>
</span></span><span style="display:flex;"><span>ø&gt; kubectl get pod -l creation_method
</span></span><span style="display:flex;"><span>NAME              READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>kubia-manual      1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          6d
</span></span><span style="display:flex;"><span>kubia-manual-v2   1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          17m
</span></span><span style="display:flex;"><span>ø&gt; kubectl get pod -l <span style="color:#4e9a06">&#39;!creation_method&#39;</span>
</span></span><span style="display:flex;"><span>NAME            READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>kubiame-fvh8x   1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          5d22h
</span></span><span style="display:flex;"><span>kubiame-hcjkf   1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          5d22h
</span></span><span style="display:flex;"><span>kubiame-qvw7w   1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          5d22h
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 包含具有特定建和值的标签</span>
</span></span><span style="display:flex;"><span>ø&gt; kubectl get pod -l <span style="color:#000">creation_method</span><span style="color:#ce5c00;font-weight:bold">=</span>manual
</span></span><span style="display:flex;"><span>NAME              READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>kubia-manual      1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          6d
</span></span><span style="display:flex;"><span>kubia-manual-v2   1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          18m
</span></span><span style="display:flex;"><span>ø&gt; kubectl get pod -l <span style="color:#4e9a06">&#39;env in (debug,prod)&#39;</span>
</span></span><span style="display:flex;"><span>NAME              READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>kubia-manual-v2   1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          20m
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 键的值值不是我们指定的值</span>
</span></span><span style="display:flex;"><span>ø&gt; kubectl get pod -l <span style="color:#4e9a06">&#39;creation_method!=manual&#39;</span>
</span></span><span style="display:flex;"><span>NAME            READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>kubiame-fvh8x   1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          5d22h
</span></span><span style="display:flex;"><span>kubiame-hcjkf   1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          5d22h
</span></span><span style="display:flex;"><span>kubiame-qvw7w   1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          5d22h
</span></span><span style="display:flex;"><span>ø&gt; kubectl get pod -l <span style="color:#4e9a06">&#39;env notin (debug,prod)&#39;</span> --show-labels
</span></span><span style="display:flex;"><span>NAME            READY   STATUS    RESTARTS   AGE     LABELS
</span></span><span style="display:flex;"><span>kubia-manual    1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          6d1h    <span style="color:#000">creation_method</span><span style="color:#ce5c00;font-weight:bold">=</span>manual
</span></span><span style="display:flex;"><span>kubiame-fvh8x   1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          5d22h   <span style="color:#000">run</span><span style="color:#ce5c00;font-weight:bold">=</span>kubiame
</span></span><span style="display:flex;"><span>kubiame-hcjkf   1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          5d22h   <span style="color:#000">run</span><span style="color:#ce5c00;font-weight:bold">=</span>kubiame
</span></span><span style="display:flex;"><span>kubiame-qvw7w   1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          5d22h   <span style="color:#000">run</span><span style="color:#ce5c00;font-weight:bold">=</span>kubiame
</span></span></code></pre></div><ul>
<li>当条件有多个时，他们是<code>and</code>的关系</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>ø&gt; kubectl get pod -l <span style="color:#4e9a06">&#39;creation_method=manual,env=debug&#39;</span> --show-labels
</span></span><span style="display:flex;"><span>NAME              READY   STATUS    RESTARTS   AGE   LABELS
</span></span><span style="display:flex;"><span>kubia-manual-v2   1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          25m   <span style="color:#000">creation_method</span><span style="color:#ce5c00;font-weight:bold">=</span>manual,env<span style="color:#ce5c00;font-weight:bold">=</span>debug
</span></span></code></pre></div><h2 id="使用标签和选择器来约束-pod-调度">使用标签和选择器来约束 Pod 调度</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 为节点添加标签</span>
</span></span><span style="display:flex;"><span>ø&gt; kubectl label node gke-demo-default-pool-ade08258-g3rl <span style="color:#000">gpu</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">true</span>
</span></span><span style="display:flex;"><span>node/gke-demo-default-pool-ade08258-g3rl labeled
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Pod</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kubia-gpu</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">spec</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">nodeSelector</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">gpu</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;true&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">containers</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span>- <span style="color:#204a87;font-weight:bold">image</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">bwangel/kubia:v0.1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kubiame</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">ports</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span>- <span style="color:#204a87;font-weight:bold">containerPort</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#0000cf;font-weight:bold">8080</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">        </span><span style="color:#204a87;font-weight:bold">protocol</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">TCP</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><p>通过 <code>spec.NodeSelector</code> 可以约束这个 Pod 只在 <code>gpu=true</code> 的节点上调度。</p>
<p>每个节点都有一个默认标签: <code>kubernetes.io/hostname={节点的主机名}</code>，可以通过这个标签来让某个 Pod 只在一个节点上调度。</p>
<p>但是如果这个节点挂了的话，这个 Pod 则不会调度。</p>
<h2 id="注解-pod">注解 Pod</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 添加注解</span>
</span></span><span style="display:flex;"><span>ø&gt; kubectl annotate pod kubia-gpu bwangel.me/someannotation<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;foo bar&#34;</span>
</span></span><span style="display:flex;"><span>pod/kubia-gpu annotated
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 查看注解</span>
</span></span><span style="display:flex;"><span>ø&gt; kubectl describe pod kubia-gpu
</span></span><span style="display:flex;"><span>Name:         kubia-gpu
</span></span><span style="display:flex;"><span>Annotations:  bwangel.me/someannotation: foo bar
</span></span><span style="display:flex;"><span>              kubernetes.io/limit-ranger: LimitRanger plugin set: cpu request <span style="color:#204a87;font-weight:bold">for</span> container kubiame
</span></span></code></pre></div><h2 id="使用命名空间对资源进行分组">使用命名空间对资源进行分组</h2>
<h3 id="命名空间介绍">命名空间介绍</h3>
<p>k8s 命名空间和 Linux 的命名空间不同，它只是简单地为对象名称提供了一个作用域，可以让我们在不同的命名空间中使用相同的名称，k8s 命名空间并不会隔离网络。</p>
<p>节点资源是全局的且未被约束于单一命名空间的资源，其他的大多数资源都和命名空间有关。</p>
<p>k8s 中所有的内容都是一个 API 对象，都可以通过向 K8S API 服务器提供 YAML manifest，来实现创建，读取，更新和删除操作。</p>
<h3 id="查看命名空间及资源">查看命名空间及资源</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 获取所有命名空间</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ø&gt; kubectl get ns
</span></span><span style="display:flex;"><span>NAME                   STATUS   AGE
</span></span><span style="display:flex;"><span>default                Active   11d
</span></span><span style="display:flex;"><span>kube-node-lease        Active   11d
</span></span><span style="display:flex;"><span>kube-public            Active   11d
</span></span><span style="display:flex;"><span>kube-system            Active   11d
</span></span><span style="display:flex;"><span>kubernetes-dashboard   Active   9d
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 列出只属于某个 NS 的 Pod</span>
</span></span><span style="display:flex;"><span>ø&gt; kubectl get pod -n kubernetes-dashboard
</span></span><span style="display:flex;"><span>NAME                                          READY   STATUS    RESTARTS   AGE
</span></span><span style="display:flex;"><span>kubernetes-dashboard-6f89577b77-fhbfb         1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          6d8h
</span></span><span style="display:flex;"><span>kubernetes-metrics-scraper-79c9985bc6-bx59z   1/1     Running   <span style="color:#0000cf;font-weight:bold">0</span>          6d8h
</span></span></code></pre></div><h3 id="创建命名空间">创建命名空间</h3>
<p>可以通过以下 yaml 文件创建命名空间，也可以通过 <code>k create namespace {namespace}</code> 命令来创建命名空间。</p>
<p>命名空间的名字可以包括 字母，数字，横杠(<code>-</code>)，但是不能包括点(<code>.</code>)。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">apiVersion</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">v1</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">kind</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">Namespace</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">bwangel</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h3 id="为资源指定命名空间">为资源指定命名空间</h3>
<p>可以在 Pod 的创建文件中设置 <code>metadata.namespace</code> 字段，为资源指定命名空间，也可以通过 <code>k create -f pod.yaml -n {namespace}</code> 命令指定资源的命名空间。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">metadata</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">kubia-manual</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">namespace</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">bwangel</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h3 id="切换命名空间">切换命名空间</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 切换当前 kubectl 的默认命名空间到 bwangel</span>
</span></span><span style="display:flex;"><span>kubectl config set-context <span style="color:#204a87;font-weight:bold">$(</span>kubectl config current-context<span style="color:#204a87;font-weight:bold">)</span> --namespace bwangel
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 创建 kcd 命名，快速地切换命名空间</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">((</span> $+commands<span style="color:#ce5c00;font-weight:bold">[</span>kubectl<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">))</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#204a87">alias</span> <span style="color:#000">kcd</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#39;kubectl config set-context $(kubectl config current-context) --namespace&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 查看当前命名空间</span>
</span></span><span style="display:flex;"><span>ø&gt; kubectl config view<span style="color:#000;font-weight:bold">|</span> grep namespace:
</span></span><span style="display:flex;"><span>    namespace: default
</span></span></code></pre></div><h2 id="停止和移除-pod">停止和移除 Pod</h2>
<p>k8s 在终止容器时，首先会向进程发送 <code>SIGTERM</code> 信号，并等待30秒。如果没有关闭的话，则继续发送 <code>SIGKILL</code> 信号。</p>
<p>如果应用程序想要正常结束的话，需要处理 <code>SIGTERM</code> 信号。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 通过标签删除容器</span>
</span></span><span style="display:flex;"><span>ø&gt; kubectl delete pod -l <span style="color:#000">creation_method</span><span style="color:#ce5c00;font-weight:bold">=</span>manual
</span></span><span style="display:flex;"><span>pod <span style="color:#4e9a06">&#34;kubia-manual&#34;</span> deleted
</span></span><span style="display:flex;"><span>pod <span style="color:#4e9a06">&#34;kubia-manual-v2&#34;</span> deleted
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 删除所有资源(注：删除的是当前命名空间下的)</span>
</span></span><span style="display:flex;"><span>ø&gt; kubectl delete all --all
</span></span><span style="display:flex;"><span>pod <span style="color:#4e9a06">&#34;kubia-gpu&#34;</span> deleted
</span></span><span style="display:flex;"><span>pod <span style="color:#4e9a06">&#34;kubiame-fvh8x&#34;</span> deleted
</span></span><span style="display:flex;"><span>pod <span style="color:#4e9a06">&#34;kubiame-hcjkf&#34;</span> deleted
</span></span><span style="display:flex;"><span>pod <span style="color:#4e9a06">&#34;kubiame-qvw7w&#34;</span> deleted
</span></span><span style="display:flex;"><span>replicationcontroller <span style="color:#4e9a06">&#34;kubiame&#34;</span> deleted
</span></span><span style="display:flex;"><span>service <span style="color:#4e9a06">&#34;kubernetes&#34;</span> deleted
</span></span><span style="display:flex;"><span>service <span style="color:#4e9a06">&#34;kubia-http&#34;</span> deleted
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 删除命名空间</span>
</span></span><span style="display:flex;"><span>ø&gt; kubectl delete ns bwangel
</span></span><span style="display:flex;"><span>namespace <span style="color:#4e9a06">&#34;bwangel&#34;</span> deleted
</span></span></code></pre></div>
</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-78e83ea0e9527f0679f830292a8e4bc6">10.2 - Pod Tips</h1>
    
	<hr>
<h2 id="pod-状态计算细节">Pod 状态计算细节</h2>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2023-03-02-093104.png" alt=""></p>
<h2 id="pod-的-qos-分类">Pod 的 QoS 分类</h2>
<blockquote>
<p>request 是最低资源需求，limit 是最高资源需求</p>
</blockquote>
<table>
<thead>
<tr>
<th>QoS 类别</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>Guaranteed(确保)</td>
<td>Pod 的资源 request 和 limit 相同</td>
</tr>
<tr>
<td>Burstable(可破裂)</td>
<td>Pod 的资源 request 小于 limit</td>
</tr>
<tr>
<td>BestEffort(尽力而为)</td>
<td>Pod 的资源没有设置任何 request 和 limit</td>
</tr>
</tbody>
</table>
<p>当计算节点上存在内存/磁盘压力时，k8s 会按照 <code>BestEffort -&gt; Burstable -&gt; Guaranteed</code> 的顺序一次驱逐 pod.</p>
<p>CPU 是可以压缩的资源，当 CPU 存在压力时，k8s 不会驱逐 pod.</p>
<p>通常情况下，Burstable 是最好的 QoS 策略，对于一些重要的核心 pod，可以设置为 Guaranteed, 确保它最后被驱逐。</p>
<h2 id="统计集群中运行-pod-的数量">统计集群中运行 pod 的数量</h2>
<pre tabindex="0"><code>sum(kube_pod_status_phase{phase=&#34;Running&#34;})
</code></pre><p><code>kube_pod_container_status_ready</code> 指标有 <code>namespace</code>, <code>cluster</code>, <code>phase</code> Label 可以对指标进行筛选，其他的看起来都是 prom 相关的</p>
<p>phase 有五种: Pending|Running|Succeeded|Failed|Unknown</p>
<ul>
<li>统计处于 Running 和 Succeeded 状态的 Pod，某些 Job 执行成功后是 Succeed 状态</li>
</ul>
<pre tabindex="0"><code>sum(kube_pod_status_phase{phase=~&#34;Running|Succeeded&#34;})
</code></pre><ul>
<li>按 namespace 统计集群中运行 pod 的数量，并按逆序排序</li>
</ul>
<pre tabindex="0"><code>sort_desc(sum(kube_pod_status_phase{phase=&#34;Running&#34;}) by (namespace))
</code></pre><h3 id="参考链接">参考链接</h3>
<ul>
<li><a href="https://github.com/kubernetes/kube-state-metrics/blob/master/docs/pod-metrics.md">Pod Metrics</a></li>
</ul>
<h2 id="k8s-停止-pod-的过程">k8s 停止 Pod 的过程</h2>
<ol>
<li>将 Pod 的状态设置为 <code>Terminating</code>，将 Pod 从 service 的 endpoints 列表中移除。</li>
<li>执行 <a href="https://kubernetes.io/docs/concepts/containers/container-lifecycle-hooks/#hook-details">preStopHook</a></li>
<li>发送 SIGTERM 信号给进程。
<ul>
<li><strong>注意:</strong> k8s 不会等待 preStopHook 结束后再发送信号，发送 SIGTERM 和 执行 preStopHook 是同时进行的</li>
</ul>
</li>
<li>等待 Pod 正常退出，等待的时间由 <code>terminationGracePeriod</code> 设置</li>
<li>如果等待超时，会发送 SIGKILL 信号给进程。</li>
<li>清理 k8s 中存储的 Pod 信息。</li>
</ol>
<h3 id="参考链接-1">参考链接</h3>
<ul>
<li><a href="https://cloud.google.com/blog/products/containers-kubernetes/kubernetes-best-practices-terminating-with-grace">Kubernetes best practices: terminating with grace</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-7fcccd7bd8aad5aa05b1de7e02521efc">10.3 - Deployment Tips</h1>
    
	<hr>
<h2 id="k8s-查询-deployment-的错误">K8s 查询 Deployment 的错误</h2>
<p>有时 Deployment 部署失败，我们通过 <code>k descript deploy xxx</code> 只能看到一个错误信息</p>
<pre tabindex="0"><code>Conditions:
  Type             Status  Reason
  ----             ------  ------
  ReplicaFailure   True    FailedCreate
Events:            &lt;none&gt;
</code></pre><p>此时我们需要找到 deploy 对应的 replicaset, describe replicaset 就能够看到对应的错误了</p>
<pre tabindex="0"><code>$ k describe replicaset &lt;replica-set-name&gt;

Type     Reason            Age                From                   Message
  ----     ------            ----               ----                   -------
  Normal   SuccessfulCreate  13m                replicaset-controller  Created pod: pod
  Warning  FailedCreate      13m                replicaset-controller  Error creating: pods &#34;pod&#34; is forbidden: exceeded quota: custom-resource-quota, requested: cpu=510m, used: cpu=1630m, limited: cpu=2
</code></pre><h3 id="参考链接">参考链接</h3>
<ul>
<li><a href="https://stackoverflow.com/a/64016529/5161084">kubernetes-replicafailure-failedcreate-but-no-events</a></li>
</ul>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-aaf94f93d4f526a149b5434d89980c98">10.4 - K8S 中观察 CPU Throttling 情况的指标</h1>
    
	<blockquote>
<p>解释了一下观察 CPU Throttling 情况的指标</p>
</blockquote>
<hr>
<h2 id="观察容器-cpu-throttling-的指标">观察容器 CPU Throttling 的指标</h2>
<p>k8s 中为每个 Pod 提供了限制 CPU 资源的选项，当 Pod 使用的 CPU 资源超出设置的 limit 时，会发生 Throttling 的情况，即进程被分配的 CPU 时间片被夺走了。</p>
<p>cAdvisor 提供了三个关于 CPU 运行时间的指标</p>
<table>
<thead>
<tr>
<th>name</th>
<th>desc</th>
<th>解释</th>
</tr>
</thead>
<tbody>
<tr>
<td>container_cpu_cfs_throttled_periods_total</td>
<td>Number of throttled period intervals</td>
<td>容器被 Throttled 的 CPU 时间片数</td>
</tr>
<tr>
<td>container_cpu_cfs_throttled_seconds_total</td>
<td>Total time duration the container has been throttled</td>
<td>容器被 Throttled 的 CPU 时间(单位是秒)</td>
</tr>
<tr>
<td>container_cpu_cfs_periods_total</td>
<td>Number of elapsed enforcement period intervals</td>
<td>容器被分配的，应该执行的 CPU 时间片书</td>
</tr>
</tbody>
</table>
<p>以上三个指标都是 prometheus 中的 counter 类型，即只会增加的绝对值，它们的数值对于维护者的观察意义也不大。</p>
<p>我们常用的指标是</p>

<div class="math">$$\frac{rate(container-cpu-cfs-throttled-periods-total[5m])}{rate(container-cpu-cfs-periods-total[5m])}$$</div><p>它表示 CPU 被 Throttling 的时间片占总分配的时间片的比重。我们以此来判断某个容器的 CPU 资源是否不足。</p>
<h2 id="指标的去重">指标的去重</h2>
<p>以上三个指标针对每个 Pod 都有 N+1 个，</p>
<ol>
<li>pod 的总指标</li>
<li>pod 中每个容器的指标</li>
</ol>
<p>所以计算时，我们需要设置 <code>{container=&quot;&quot;}</code> 或 <code>{image=&quot;&quot;}</code> 来只保留 pod 的指标</p>
<h2 id="指标加上-pod-label">指标加上 Pod label</h2>
<p>以上的三个指标，他们中的 label 都是和容器相关的(<code>pod</code>, <code>container</code>, <code>image</code>)，我们需要根据 pod 的 label 来对指标进行聚合，观察某个 deployment 或某个 k8s job 的 CPU Throttling 情况，此时，我们就需要用到 <code>kube_pod_label</code> 指标，来和上述指标进行相乘。</p>
<p><code>kube_pod_label</code> 是 <a href="https://github.com/kubernetes/kube-state-metrics">kube-state-metrics</a> 提供的指标，它将 k8s label 转换成 prometheus 指标，每个 pod 上的 k8s label 都在 prom 指标中变成 <code>label_xx</code> 的形式。例如我们假设某个 pod 有 app 和 owner 两个 k8s label，那么它的 prom 指标如下</p>
<pre tabindex="0"><code>kube_pod_labels{
    cluster=&#34;local&#34;, container=&#34;kube-state-metrics&#34;, endpoint=&#34;http&#34;,
    instance=&#34;172.19.2.101:8080&#34;, job=&#34;kube-state-metrics&#34;, label_app=&#34;http-bin&#34;,
    label_owner=&#34;xyd&#34;, namespace=&#34;default&#34;,
    pod=&#34;http-bin-867bc77ld45d&#34;, prometheus=&#34;monitoring/kube-prom-kube-prometheus-prometheus&#34;,
    uid=&#34;7b9c5473-1455-454d-b5a3-69f08dc99bb1&#34;
}
</code></pre><p><code>instance</code> label 表示 kube-state-metrics 的 IP 地址。</p>
<pre tabindex="0"><code>rate(
    container_cpu_cfs_throttled_periods_total{pod=&#34;http-bin-867bc77ld45d&#34;, image=&#34;&#34;}[5m]
) * on(pod) group_left(label_app, label_owner) 
    kube_pod_labels{namespace=&#34;default&#34;, pod=&#34;http-bin-867bc77ld45d&#34;}
</code></pre><p>上面的计算公式中，</p>
<ul>
<li><code>* on(pod)</code> 表示左边的指标 <code>container_cpu_cfs_throttled_periods_total</code> 和右边的指标 <code>kube_pod_labels</code> 根据相同的 <code>pod</code> label，对 value 进行相乘。</li>
<li><code>group_left(label_app, label_owner)</code> 表示将右边指标的 <code>label_app</code>, <code>label_owner</code> 添加到左边指标中，生成一个新指标</li>
<li>如果写成 <code>group_right(label_app, label_owner)</code>，表示以右边的指标为基准，将 <code>label_app</code>, <code>label_owner</code> 添加上，生成一个新指标</li>
<li>注意新指标的值是左右两个指标相乘，<code>kube_pod_labels</code> 的 value 始终是1, 所以新指标的值和 <code>container_cpu_cfs_throttled_periods_total</code> 相同</li>
<li>如果针对同一个 pod label, <code>container_cpu_cfs_throttled_periods_total</code> 有多个，那么就只能写 <code>group_left(label_app, label_owner)</code>
<ul>
<li>如果写 <code>group_right(label_app, label_owner)</code>，prom 不知道如何将多个 <code>container_cpu_cfs_throttled_periods_total</code> 聚合起来，就会报错</li>
</ul>
<pre tabindex="0"><code>Error executing query: found duplicate series for the match group {pod=&#34;http-bin-867bc77ld45d&#34;} on the left hand-side of the operation: [{...}, {...}];many-to-many matching not allowed: matching labels must be unique on one side
</code></pre></li>
<li>正常情况下，<code>kube_pod_label</code> 针对同一个 pod 只有一个，但是当 kube-state-metrics 重启的时候，由于 kube-state-metrics 的 IP 地址变了，<code>kube_pod_label</code> 就会出现 pod 相同，但是 <code>instance</code> 不同的指标。所以，最好还是要保证和 <code>kube_pod_labels</code> 相乘的指标针对同一个 pod 只有一个，否则当 kube-state-metrics 重启时，相乘的计算公式就会出现以下两种错误。
<ul>
<li>many * many 的错误</li>
<li>one * group_left() many 的错误</li>
</ul>
</li>
</ul>
<p>为 cpu throttled 指标加上 pod label 后，我们再根据 k8s app sum 一下，就得到我们最终想要的结果了</p>
<pre tabindex="0"><code>sum(
    rate(container_cpu_cfs_throttled_periods_total{namespace=&#34;default&#34;, image=&#34;&#34;}[5m])
        * on(pod) group_left(label_app, label_owner)
    kube_pod_labels{namespace=&#34;default&#34;}
) by (label_app, label_owner)
  /
sum(
    rate(container_cpu_cfs_periods_total{namespace=&#34;default&#34;, image=&#34;&#34;}[5m])
        * on(pod) group_left(label_app, label_owner)
    kube_pod_labels{namespace=&#34;default&#34;}
) by (label_app, label_owner)
</code></pre><p>上述指标按 <code>label_app</code> 和 <code>label_owner</code> 这两个维度，求和了一下符合筛选标签的所有 pod 的 CPU Throttling 时间片的百分比。</p>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-52f25b57aa970b9c8ef121fcdbb83976">10.5 - 进程卡住如何 debug</h1>
    
	<hr>
<h2 id="进程卡住如何-debug">进程卡住如何 Debug</h2>
<h3 id="查看-cpu">查看 CPU</h3>
<p>利用 prom 指标查看 CPU 使用率，如果从某个时间点后就降低了，说明是阻塞在 IO 上了。</p>
<h3 id="查看-io">查看 IO</h3>
<ul>
<li>查看进程当前建立的网络连接 (进入容器内执行)</li>
</ul>
<pre tabindex="0"><code>lsof -i -a -p 1 | grep ESTABLISHED
</code></pre><h3 id="利用-strace">利用 strace</h3>
<ul>
<li>查看所有的 open, read 系统调用</li>
</ul>
<pre tabindex="0"><code>sudo strace -e trace=open,read -p {pid}
</code></pre>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-bb3ef80f413d06f056f401de51d6c418">10.6 - Review 《How eBPF will solve Service Mesh - Goodbye Sidecars》</h1>
    
	<blockquote>
<ul>
<li>原文地址: <a href="https://isovalent.com/blog/post/2021-12-08-ebpf-servicemesh">https://isovalent.com/blog/post/2021-12-08-ebpf-servicemesh</a></li>
</ul>
</blockquote>
<hr>
<p>Service Mesh (服务网格) 是一个概念，描述了现代云原生应用在通信、可见性和安全性方面的要求。目前这个概念的实现涉及到在每个workload 或 pod 中运行 sidecar 代理。这是一种相当低效的方式。在这篇文章中，我们将探讨一个替代 sidecar 模型的方法，在eBPF的帮助下，提供一个透明的 Service Mesh，在低复杂度下具有很高的效率。</p>
<h2 id="what-is-service-mesh">What is Service Mesh?</h2>
<p>随着分布式应用的引入，额外的可见性、连接性和安全性要求也浮现出来(have surfaced)。应用程序组件在跨越云和城市边界的不受信任的网络中通信，负载均衡需要理解应用协议，弹性(resiliency)变得至关重要(crucial)，安全性必须发展(evolve)到发送者和接收者可以验证彼此身份的模式。在分布式应用的早期，这些要求是通过直接将所需的逻辑嵌入到应用中来解决的。Service Mesh 将这些功能从应用程序中提取出来，作为基础设施的一部分提供给所有应用程序使用，因此不再需要修改每个应用程序。</p>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com//2021-12-20-200012.png" alt=""></p>
<p>纵观 Service Mesh 今天的特点，可以总结为以下几点:</p>
<ul>
<li>弹性链接: 服务与服务之间的通信必须能够跨越边界，例如云服务，集群和城市。通信必须是弹性且可容错的。</li>
<li>L7 流量管理: 负载均衡，频率限制器，弹性都必须在 L7 层(能够理解 HTTP, REST, gRPC, WebSocket 等协议)</li>
<li>基于身份的安全: 基于网络标识符来实现安全已经不够了，发送和接收服务必须能够基于身份标识认证对方，而不是通过网络标识认证。</li>
<li>可观察性和可追踪性: 追踪和指标形式的观察，对于理解，监控，调试应用程序的稳定性，性能和可用性至关重要。</li>
<li>透明性：该功能必须以透明的形式提供给应用程序，即不需要改变应用程序的代码。</li>
</ul>
<p>在早期，Service Mesh 功能通常以库的形式实现，需要网格中的每个应用程序链接到以对应语言编写的库中。同样的事情也在互联网早期发生过，在那些日子里，应用程序需要维护自己的 TCP/IP 栈。就像我们在这篇文章里讨论的一样，Service Mesh 正在发展成为一种内核职责，就像 TCP/IP 网络栈一样。</p>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com//2021-12-20-201812.png" alt=""></p>
<p>在今天，Service Mesh 通常是用一种称为 sidecar 模型的架构实现的。这种架构将实现了上述功能的代码封装到4层代理中，然后将应用接收和发送的流量重定向到被称为 sidecar 的代理中。它之所以被成为 Sidecar，是因为每个应用程序都有一个代理，就像摩托车上的挎斗一样。</p>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com//2021-12-20-202330.png" alt=""></p>
<p>这种架构的优点是应用服务自身不再需要实现 Service Mesh 中的功能。如果许多应用服务使用不同语言编写，或者你运行的服务是一个不可变的第三方应用程序，这种架构就很方便。</p>
<p>这种模型的缺点是有大量的代理，许多额外的网络连接和复杂的重定向逻辑将应用的网络流量送入到代理中。除此之外，四层代理能够传输的网络流量的类型也有限制(四层代理无法理解 HTTP/Thrift 等七层协议)。代理在其能够支持的网络协议上是被限制的。</p>
<h2 id="a-history-of-connectivity-moving-into-the-kernel">A history of connectivity moving into the Kernel</h2>
<p>几十年来，在应用程序之间提供安全可靠的连接一直是操作系统的责任。你们中的一些人可能还记得早期 Unix 和 Linux 时代的 <a href="https://en.wikipedia.org/wiki/TCP_Wrappers">TCP Wrapper</a> 和 tcpd。它可以被认为是原始的 sidecar ，tcpd 允许用户透明地添加日志，访问控制，主机名验证，欺骗保护功能到应用程序中，而不需要修改应用程序。
它使用了 libwrap 库，而且，在一个有趣的平行与服务网格历史的故事中，这个库也是以前的应用程序提供这些功能的链接对象。tcpd 带来的是能够在不修改现有应用程序的情况下将这些功能透明地添加到现有应用程序中。最终，所有这些功能都进入了 Linux 本身，并以一种更有效，更强大的方式提供给应用程序。今天，这已经演变成了我们熟知的 iptables。</p>
<p>然而，iptables 显然不适合解决现代网络的连接性，安全性和可观察性要求，因为它在网络层面上运行，缺少对应用协议层的任何理解。自然，阻力最小的路径是回到库模型，然后是 sidecar 模式。现在，我们正处于这样一个阶段：为了最佳的透明度、效率性和安全性，在操作系统中原生地支持这种模式是有意义的。</p>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2022-01-29-111200.png" alt=""></p>
<p>在曾经的 TCPD 时代使用的 <code>连接记录 (connection logging back)</code>，现在变成了<code>追踪 (tracing)</code>。在 IP 层的访问控制已经进化成了在应用层的授权(例如使用 JWT 进行授权)。主机名验证已经被更强大的认证所取代，例如双端 TLS 认证。网络负载均衡已经扩展到 L7 层的流量管理功能。HTTP 重试是新的 TCP 重传。过去使用黑洞路由解决的问题今天被称为 熔断(circuit breaking)。这些都不是根本性的新问题，但所需的环境和控制都已经发生了变化。</p>
<h2 id="extending-the-kernel-namespace-concept">Extending the Kernel Namespace Concept</h2>
<p>Linux 内核已经有一个概念，可以共享相同的功能，并使其对系统上运行的许多应用程序可用。这个概念被称为命名空间，它构成了我们今天所熟知的容器技术的基础。命名空间(内核的概念)存在于各种抽象中，包括文件系统、用户管理，挂载设备，进程，网络等。这就是允许独立的容器用 不同的文件系统视图、不同的用户集存在，以及允许多个容器绑定到同一台主机上的同一个端口。在 cgroups 的帮助下，这个概念得到了扩展，可以对 CPU、内存和网络等资源进行资源管理和有限排序。从云原生应用开发者的角度来看，cgroups 和 资源被紧密地整合到了我们熟知的 “容器” 概念中。</p>
<p>符合逻辑的是，如果我们认为服务网格是操作系统的责任，那么它必须遵循并集成命名空间和 cgroups 的概念。这看起来是这样的:</p>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2022-01-29-113330.png" alt=""></p>
<p>不出所料，这看起来非常自然，而且可能是大多数用户从简单的角度所期望的。应用程序保持不变，它们就像以前一样继续使用网络套接字进行通信。理想的服务网络功能是作为 Linux 的一部分透明地提供的。它就在那里，就像今天的 TCP 一样。</p>
<h2 id="the-cost-of-sidecar-injection">The Cost of Sidecar Injection</h2>
<p>如果我们仔细研究一下 sidecar 模型，我们会发现它实际上是在试图模仿这种模型。应用程序继续使用套接字，一切都被塞进 Linux 内核的网络命名空间。然而，这让它比看起来要复杂许多，需要许多额外的步骤来透明地注入 sidecar 代理:</p>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2022-01-29-114543.png" alt=""></p>
<p>这种额外的复杂性在延迟和额外资源消耗方面付出了巨大的代价。早期的基准测试表明，这让延迟增加了3到4倍，而且所有的代理都需要大量的额外内存。在本文的后面，我们将研究这两点，因为我们将要将它和 eBPF 模型比较。</p>
<h2 id="unlocking-the-kernel-service-mesh-with-ebpf">Unlocking the Kernel Service Mesh with eBPF</h2>
<p>为什么我们以前在内核中没有创建一个服务网格？有些人半开玩笑地说，kube-proxy 是最初的服务网格(See <a href="https://www.youtube.com/watch?v=lUF88T16YqY&amp;ab_channel=CloudNativeRejekts">We&rsquo;ve Made Quite A Mesh  - Tim Hockin, Google</a>)。这句话是有一定道理的。kube-proxy 是一个很好的例子，说明了 Linux 内核在依靠传统的基于网络的 iptables 功能实现服务网格时，可以达到多么接近。然而，这还不够，L7 的上下文是缺失的。kube-proxy 完全在数据包层面操作，现代应用程序需要 L7 层的流量管理，追踪，认证和额外的可靠性保证。kube-proxy 不能在网络层面上提供这些。</p>
<p>eBPF 改变了这个等式( equation )，它允许动态地扩展 Linux 内核的功能。我们已经使用 eBPF 为 Cilium 构建了一个高效的网络，安全和可观察的数据通路。并将其直接嵌入到 Linux 内核。应用这个相同的概念，我们也可以在内核层面上解决服务网格的需求。事实上，Cilium 已经实现了各种所需的概念，例如基于身份的安全，L3-L7可观察性和授权，加密，负载均衡。缺少的部分 Cilium 正在添加中。在本文的莫问，你会发现如何加入有 Cilium 社区推动的 Cilium 服务网格 beta 项目的细节。</p>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2022-01-29-141203.png" alt=""></p>
<p>你们中的一些人可能想知道为什么Linux内核社区没有直接解决这些需求。eBPF有一个巨大的优势，eBPF代码可以在运行时插入到现有的Linux内核中，类似于Linux内核模块，但与内核模块不同，它可以以安全和可移植的方式进行。这使得eBPF的实现能够随着服务网状结构社区的发展而继续发展。新的内核版本需要几年时间才能进入用户手中。eBPF是一项关键技术，它使Linux内核能够跟上快速发展的云原生技术栈。</p>
<h2 id="ebpf-based-l7-tracing--metrics-without-sidecars">eBPF-based L7 Tracing &amp; Metrics without Sidecars</h2>
<p>让我们以 L7 层的追踪和指标可观察性作为一个具体的例子，来说明基于 eBPF 的服务网格在保持低延迟和保持低可观察成本上有巨大的作用。应用程序团队依靠应用程序的可见性和可监控作为基本要求，这包括了请求跟踪，HTTP 响应率，服务延迟信息等。然而，这些观察不应该有明显的成本(延迟，复杂性，资源等成本)。</p>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2022-01-29-142614.png" alt=""></p>
<p>在下面的基准测试中，我们可以看到早期的测量结果，即通过eBPF或sidecar方法实现HTTP可见性对延迟的影响。
该测试是在两个不同节点上运行的两个pod之间，通过固定数量的连接每秒稳定地执行 10K 个HTTP请求，并测量请求的平均延迟。</p>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2022-01-29-143216.png" alt=""></p>
<p>我们故意不提这些测量中使用的具体代理，因为它并不重要。对于我们测试过的所有代理，结果几乎都是一样的。要明确的是，这不是关于Envoy、Linkerd、Nginx或其他代理是否更快的实验。所提到的代理有差异，但与首先注入代理的成本相比，它们是微不足道的。几乎没有开销是来自代理本身的逻辑。开销是通过注入代理、将网络流量重定向到它、终止连接和启动新连接而增加的。</p>
<p>这些早期的测量结果表明，基于 eBPF 的内核方法是非常有前途的，可以实现完全透明的服务网状结构的愿望，而且没有明显的开销。</p>
<h2 id="ebpf-accelerated-per-node-proxy">eBPF Accelerated Per-Node Proxy</h2>
<p>越来越多的用例可以用这种仅有eBPF的方法来覆盖，从而完全取消L4代理。对于一些用例，仍然需要一个代理。例如，当连接需要拼接时，当TLS终止被执行时，或对于某些形式的HTTP授权。</p>
<p>我们的eBPF服务网格工作将继续关注那些从性能角度可以获得最大收益的领域。如果你必须执行TLS终止，你可能不介意在流量流入集群时终止一次与代理的连接。然而，你会更关心在每个连接的路径中注入两个代理的影响，只是为了提取HTTP指标和跟踪数据。</p>
<p>当一个用例不能用纯eBPF的方法来实现时，服务网格可以 fallback 到 per-node 的代理模型，直接将代理与内核的套接字层结合起来。</p>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2022-01-29-144528.png" alt=""></p>
<p>eBPF不依赖网络层的重定向，而是直接在套接字级别注入代理，保持短路径。在 Cilium 的案例中，正在使用 Envoy，尽管从架构的角度来看，任何代理都可以被整合到这个模型。从概念上讲，这允许将Linux内核网络命名空间的概念直接扩展到Envoy监听器配置的概念，并将Envoy变成一个多用户代理。</p>
<h2 id="sidecar-vs-per-node-proxy">Sidecar vs per-Node Proxy</h2>
<p>即使需要代理，代理的成本也会根据部署的架构而有所不同。让我们来看看 per-node 的代理模式与 sidecar 模式的比较，看看它们是如何比较的。</p>
<h3 id="proxies-per-connection">Proxies per Connection</h3>
<p>所需的网络连接数将会根据图片上的代理模式发生变化。最简单的场景是 sidecar-free 模型，这意味着网络连接的数量没有变化。一个连接就能够 serve 请求，eBPF 将会在已有的连接上提供追踪，负载均衡等服务网格的能力。</p>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2022-01-29-150117.png" alt=""></p>
<p>用 sidecar 模型实现同样的功能，需要在连接中注入两次代理，这就导致了需要维护三个连接。进一步导致开销的增加和套接字缓冲区所需的内存倍增，表现为更高的服务到服务的延迟。这就是我们之前在无 sidecar L7 可见性部分看到的 sidecar 开销。</p>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2022-01-29-150455.png" alt=""></p>
<p>切换到 per-node 的代理模式使我们能够摆脱其中一个代理，因为我们不再依赖在每个工作负载中运行一个sidecar。比起不需要额外的连接，这还是不够理想，但比起总是需要两个额外的连接要好。</p>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2022-01-29-150625.png" alt=""></p>
<h3 id="total-number-of-proxies-required">Total number of proxies required</h3>
<p>在每个工作负载中运行一个 sidecar 会导致大量的代理。即使每个单独的代理实例在其内存占用方面是相当优化的，但实例的数量之多将导致总的影响很大。此外，每个代理维护的数据结构，如路由和端点表，随着集群的增长而增长，所以集群越大，每个代理的内存消耗就越高。今天，一些服务网格试图通过将部分路由表推送给单个代理来解决这个问题，限制他们可以路由到哪里。</p>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2022-01-29-151028.png" alt=""></p>
<p>让我们假设在一个500个节点的集群中，每一个节点有30个pod，一个基于sidecar的架构将需要运行15K个proxy。在每个代理消耗70MB内存的情况下（已经假设了严重优化的路由表），这仍然导致集群中所有sidecar消耗1TB内存。在 per-node 模型中，假设每个代理的内存足迹相同，500个代理将消耗不超过34GB的内存。</p>
<h3 id="multi-tenancy">Multi-Tenancy</h3>
<p>当我们从 sidecar 模型转向 per-node 模型时，代理将为多个应用程序提供连接。代理必须有多租户意识。这与我们从使用单个虚拟机转向使用容器时发生的过渡完全相同。由于我们不再使用在每个虚拟机中运行的完全独立的操作系统副本，而开始与多个应用程序共享操作系统，Linux 必须有多租户意识。这就是命名空间和 cgroup 存在的原因。如果没有它们，一个容器可能会消耗一个系统的所有资源，容器可能会以不受控制的方式访问对方的文件系统。</p>
<p>如果在服务网格级别的网络资源上表现得完全一样，那不是很好吗？Envoy已经有了命名空间的初步概念，它们被称为监听器。监听器可以携带单独的配置并独立运行。这将开启全新的可能性：突然间，我们可以很容易地控制资源消耗，建立公平的排队规则，并将可用的资源平等地分配给所有的应用程序，或者按照指定的规则分配。这可以而且应该与我们今天在 Kubernetes 中定义应用程序的CPU和内存约束的方式完全一样。如果你想了解这个话题，我曾在EnvoyCon上讲过这个问题（<a href="https://www.youtube.com/watch?v=08opgZkdYIw">Envoy Namespaces - Operating an Envoy-based Service Mesh at a Fraction of the Cost, Thomas Graf, EnvoyCon 2019</a>）。</p>
<h2 id="want-to-get-involved---join-the-cilium-service-mesh-beta">Want to get Involved? - Join the Cilium Service Mesh Beta</h2>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2022-01-29-151704.png" alt=""></p>
<p>伴随着即将发布的Cilium 1.11，Cilium社区正在举办一个新的Cilium Service Mesh测试项目。它的特点是，新的构建将使以下功能可用。</p>
<ul>
<li>L7流量管理和负载平衡（HTTP、gRPC&hellip;)</li>
<li>跨集群、云和场所的拓扑感知路由</li>
<li>TLS终结</li>
<li>通过Envoy配置的金丝雀展开、重试、速率限制、断路等。</li>
<li>通过OpenTelemetry和Jaeger集成进行追踪</li>
<li>内置Kubernetes入口支持</li>
</ul>
<p>上述所有功能都可在 <a href="https://github.com/cilium/cilium">github.com/cilium/cilium</a> 上的功能分支中找到。测试计划允许 Cilium 维护者直接与用户接触，了解他们的需求。要注册，你可以直接填写这个<a href="https://forms.gle/j9fwhAC6HnHRJQKeA">表格</a>，或者你可以在 Cilium 社区的<a href="https://cilium.io/blog/2021/12/01/cilium-service-mesh-beta/">公告</a>中阅读更多关于该计划的信息。</p>
<h2 id="结论">结论</h2>
<p>eBPF是提供本地和高效的服务网格实现的答案。它将把我们从 sidecar 模型中解放出来，并允许将现有的代理技术整合到现有的内核命名概念中，使它们成为我们每天都在使用的美丽容器抽象的一部分。除此之外，eBPF将能够卸载越来越多的目前由代理执行的功能，以进一步减少开销和复杂性。通过能够整合几乎任何现有的代理，该架构也允许与大多数现有的服务服务网格（Istio、SMI、Linkerd&hellip;）整合。这将使eBPF的好处提供给广大的终端用户，同时将数据通路的效率和开销讨论与控制平面方面的问题相分离。</p>
<p>如果你对探索这一领域感兴趣，我们很愿意听到你的意见。请随时通过 Twitter 或eBPF &amp; Cilium Slack联系我们。</p>
<h2 id="further-reading">Further Reading</h2>
<ul>
<li><a href="https://thenewstack.io/how-ebpf-streamlines-the-service-mesh/">How eBPF Streamlines the Service Mesh</a>, Liz Rice, The New Stack</li>
<li><a href="https://cilium.io/blog/2021/12/01/cilium-service-mesh-beta/">Cilium Service Mesh Beta Program</a>, Cilium Community</li>
<li><a href="https://cilium.io/learn/">Learn more about Cilium</a></li>
</ul>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-ad08524b2d9bf44799deda2288946354">10.7 - 使用 Buildkit 和 Containerd 构建运行容器</h1>
    
	<hr>
<h2 id="tips">Tips</h2>
<h3 id="安装--运行-containerd">安装 &amp; 运行 Containerd</h3>
<p>我的电脑是 Ubuntu 20.04 ，直接通过 deb 包安装的:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 安装 containerd</span>
</span></span><span style="display:flex;"><span>sudo apt install containerd
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 将 containerd 设置为开机自动启动</span>
</span></span><span style="display:flex;"><span>sudo systemctl <span style="color:#204a87">enable</span> containerd.service
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 启动  containerd</span>
</span></span><span style="display:flex;"><span>sudo systemctl start containerd.service
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 查看 containerd 的版本</span>
</span></span><span style="display:flex;"><span>ø&gt; sudo ctr version
</span></span><span style="display:flex;"><span>Client:
</span></span><span style="display:flex;"><span>  Version:  1.5.2-0ubuntu1~20.04.3
</span></span><span style="display:flex;"><span>  Revision:
</span></span><span style="display:flex;"><span>  Go version: go1.13.8
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Server:
</span></span><span style="display:flex;"><span>  Version:  1.5.2-0ubuntu1~20.04.3
</span></span><span style="display:flex;"><span>  Revision:
</span></span><span style="display:flex;"><span>  UUID: 2e890619-f1a0-4b0f-8c4f-3363136c0c38
</span></span></code></pre></div><p>containerd 的配置文件在 <code>/etc/containerd/config.toml</code></p>
<h3 id="安装--运行-buildkitd">安装 &amp; 运行 buildkitd</h3>
<ol>
<li>下载 buildkit</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#204a87">cd</span> ~/.local/
</span></span><span style="display:flex;"><span>wget https://github.com/moby/buildkit/releases/download/v0.9.2/buildkit-v0.9.2.linux-amd64.tar.gz
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 解压 buildkit 的相关二进制文件到 ~/.local/bin 目录中</span>
</span></span><span style="display:flex;"><span>tar -xvf buildkit-v0.9.2.linux-amd64.tar.gz
</span></span></code></pre></div><ol start="2">
<li>为 buildkit 创建 systemd service</li>
</ol>
<p>向 <code>/etc/systemd/system/buildkit.service</code> 中写入</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>Unit<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#000">Description</span><span style="color:#ce5c00;font-weight:bold">=</span>BuildKit
</span></span><span style="display:flex;"><span><span style="color:#000">Requires</span><span style="color:#ce5c00;font-weight:bold">=</span>buildkit.socket
</span></span><span style="display:flex;"><span><span style="color:#000">After</span><span style="color:#ce5c00;font-weight:bold">=</span>buildkit.socketDocumentation<span style="color:#ce5c00;font-weight:bold">=</span>https://github.com/moby/buildkit
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>Service<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#000">ExecStart</span><span style="color:#ce5c00;font-weight:bold">=</span>/home/xuyundong/.local/bin/buildkitd --oci-worker<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">false</span> --containerd-worker<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">true</span> --addr tcp://localhost:1234
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>Install<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#000">WantedBy</span><span style="color:#ce5c00;font-weight:bold">=</span>multi-user.target
</span></span></code></pre></div><ul>
<li><code>--oci-worker=false</code> 和 <code>--containerd-worker=true</code> 表示使用 containerd 作为 buildkit 的后端 worker</li>
<li><code>--addr tcp://localhost:1234</code> 表示监听 <code>localhost:1234</code> 端口和客户端通信</li>
</ul>
<p>向 <code>/etc/systemd/system/buildkit.socket</code> 中写入</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>Unit<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#000">Description</span><span style="color:#ce5c00;font-weight:bold">=</span>BuildKit
</span></span><span style="display:flex;"><span><span style="color:#000">Documentation</span><span style="color:#ce5c00;font-weight:bold">=</span>https://github.com/moby/buildkit
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>Socket<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#000">ListenStream</span><span style="color:#ce5c00;font-weight:bold">=</span>%t/buildkit/buildkitd.sock
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>Install<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#000">WantedBy</span><span style="color:#ce5c00;font-weight:bold">=</span>sockets.target
</span></span></code></pre></div><ol start="3">
<li>启动 buildkit daemon</li>
</ol>
<pre tabindex="0"><code>sudo systemctl start buildkit.service
</code></pre><h3 id="使用-buildkit-构建镜像">使用 buildkit 构建镜像</h3>
<ol>
<li>创建 hello.go 文件，写一个简单的 web server</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;net/http&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HandleFunc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">writer</span> <span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ResponseWriter</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">request</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Request</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">writer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;hello, containerd&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Listen on %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;:8080&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatalln</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListenAndServe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;:8080&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><ol start="2">
<li>编写 Dockerfile</li>
</ol>
<pre tabindex="0"><code>FROM golang:1.16

COPY hello.go /src/hello.go
RUN go build -o /src/hello /src/hello.go
ENTRYPOINT [&#34;/src/hello&#34;]%
</code></pre><ol start="3">
<li>构建镜像</li>
</ol>
<pre tabindex="0"><code>sudo ~/.local/bin/buildctl --addr tcp://localhost:1234 build --frontend=dockerfile.v0 --local context=. --local dockerfile=. --output type=image,name=hel:latest
</code></pre><p><code>--output</code> 指定输出镜像的名字和类型</p>
<p>构建好的镜像会放到 containerd 的 buildkit namespace 下</p>
<pre tabindex="0"><code>ø&gt; sudo ctr -n buildkit i ls
REF          TYPE                                                 DIGEST                                                                  SIZE      PLATFORMS   LABELS
hel:latest   application/vnd.docker.distribution.manifest.v2+json sha256:00fdb709c6f938df80d96a2c7e0677351f1f82a4c6cd54f618c0f96d4006705c 314.5 MiB linux/amd64 -
</code></pre><h3 id="使用-containerd-运行镜像">使用 containerd 运行镜像</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 创建 container</span>
</span></span><span style="display:flex;"><span>sudo ctr -n buildkit c create hel:latest hel
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 启动 task</span>
</span></span><span style="display:flex;"><span>sudo ctr -n buildkit t start -d hel
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># exec 进入到 task 中</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># --exec-id 参数可以随便写，只要唯一就行</span>
</span></span><span style="display:flex;"><span>sudo ctr -n buildkit t <span style="color:#204a87">exec</span> --exec-id <span style="color:#0000cf;font-weight:bold">0</span> -t hel bash
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 在 容器内使用 curl 访问 web server</span>
</span></span><span style="display:flex;"><span>root@lazyubuntu:/go# curl 127.0.0.1:8080
</span></span><span style="display:flex;"><span>hello, containerdroot@lazyubuntu:/go#
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 停掉 task</span>
</span></span><span style="display:flex;"><span>ø&gt; sudo ctr -n buildkit t <span style="color:#204a87">kill</span> hel
</span></span><span style="display:flex;"><span>ø&gt; sudo ctr -n buildkit t ls
</span></span><span style="display:flex;"><span>TASK    PID      STATUS
</span></span><span style="display:flex;"><span>hel     <span style="color:#0000cf;font-weight:bold">47605</span>    STOPPED
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 删除 task</span>
</span></span><span style="display:flex;"><span>ø&gt; sudo ctr -n buildkit t rm hel
</span></span><span style="display:flex;"><span>WARN<span style="color:#ce5c00;font-weight:bold">[</span>0000<span style="color:#ce5c00;font-weight:bold">]</span> task hel <span style="color:#204a87">exit</span> with non-zero <span style="color:#204a87">exit</span> code <span style="color:#0000cf;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span>ø&gt; sudo ctr -n buildkit t ls
</span></span><span style="display:flex;"><span>TASK    PID    STATUS
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 删除容器</span>
</span></span><span style="display:flex;"><span>ø&gt; sudo ctr -n buildkit c ls
</span></span><span style="display:flex;"><span>CONTAINER    IMAGE         RUNTIME
</span></span><span style="display:flex;"><span>hel          hel:latest    io.containerd.runc.v2
</span></span><span style="display:flex;"><span>ø&gt; sudo ctr -n buildkit c rm hel
</span></span></code></pre></div><h2 id="参考链接">参考链接</h2>
<ul>
<li><a href="https://www.qikqiak.com/post/containerd-usage/">一文搞懂容器运行时 Containerd</a></li>
<li><a href="https://www.duyidong.com/2019/05/19/build-image-in-container-via-buildkit/">下一代镜像构建工具 Buildkit</a></li>
<li><a href="https://zhuanlan.zhihu.com/p/366671300">用buildkit和containerd构建镜像</a></li>
<li><a href="https://blog.frognew.com/2021/05/relearning-container-05.html">重学容器05: 使用nerdctl + buildkitd构建容器镜像</a></li>
<li><a href="https://blog.mobyproject.org/introducing-buildkit-17e056cc5317">Introducing BuildKit</a></li>
</ul>
</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-4aaad1b9f7ee3c127b91ab5b259ce456">11 - Container</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-5dd2bc857390538c171fb56a14e4efb8">11.1 - Ubuntu 中 Docker 设置容器中 DNS 服务器的地址</h1>
    
	<hr>
<h2 id="tips">Tips</h2>
<p>修改 <code>/etc/docker/daemon.json</code> 文件，写入以下配置:</p>
<pre tabindex="0"><code>{
  &#34;dns&#34;: [
    &#34;10.8.0.1&#34;,
    &#34;192.168.45.155&#34;,
  ]
  &#34;dns-opts&#34;: [ &#34;ndots:1&#34; ]
}
</code></pre><p>这样相当于在 <code>/etc/resolv.conf</code> 设置了</p>
<pre tabindex="0"><code>nameserver 10.8.0.1
nameserver 192.168.45.155
options ndots:15
</code></pre><p>修改完成后重启 docker daemon 生效</p>
<h2 id="参考链接">参考链接</h2>
<ul>
<li><a href="https://github.com/moby/moby/issues/32093">ndots:0 #32093</a></li>
</ul>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-ebcaa5066994bddfb13c8bffcd9addae">11.2 - 从 none 开始，用网桥模式启动容器的网络</h1>
    
	<p>用 none 网络模式启动的容器，创建一个可以对外通信的网络</p>
<hr>
<h2 id="目的">目的</h2>
<p>本篇文章中，我们首先使用 none 网络模式启动一个容器，然后一步步给它配置好网络，让这个容器能够正常进行网络通信。</p>
<p>最终容器的网络架构图如下图所示:</p>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2023-01-20-103416.png" alt=""></p>
<ul>
<li>enp4s0 是宿主机的网络设备</li>
<li>eth0 是 nginx 容器的网络设备, eth0 和 A 是一对 veth 设备</li>
<li>docker0 是 docker 安装时自动创建的网桥设备</li>
</ul>
<h2 id="veth-是什么">veth 是什么</h2>
<p>veth 全称是 virtual ethernet devices, 虚拟以太网设备。
它们可以作为网络 namespace 之间通信的通道，在另一个网络 namespace 创建和网络物理设备通信的桥梁。
也可以作为内部网络设备。</p>
<p>veth 设备总是成对出现，一对 veth 设备可以用如下的命令创建:</p>
<pre tabindex="0"><code>ip link add &lt;p1-name&gt; type veth peer name &lt;p2-name&gt;
</code></pre><p>在上面的代码中，p1-name 和 p2-name 是分配给两个连接的端点的名称。</p>
<p>对一个设备上传输的数据包会立即在另一个设备上接收。当任何一个设备关闭时，veth 对的链路状态就会关闭。</p>
<p>Veth 设备对用于以有趣的方式将内核的网络设施组合在一起。</p>
<p>一个特别有趣的用例是将 veth 对的一端放在一个网络 namespace 中，
另一端放在另一个网络 namepsace 中，从而允许网络 namespace 之间进行通信。</p>
<p>为此，可以在创建接口时提供 netns 参数:</p>
<pre tabindex="0"><code>ip link add &lt;p1-name&gt; netns &lt;p1-ns&gt; type veth peer &lt;p2-name&gt; netns &lt;p2-ns&gt;
</code></pre><p>或者，对于现有的 veth 对，可以将一端移动到另一个名称空间:</p>
<pre tabindex="0"><code>ip link set &lt;p2-name&gt; netns &lt;p2-ns&gt;
</code></pre><p><a href="https://man7.org/linux/man-pages/man8/ethtool.8.html">ethtool(8)</a> 可用于查找 veth 网络接口的对等点，使用类似下面这样的命令:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ ip link add ve_A <span style="color:#204a87">type</span> veth peer name ve_B   <span style="color:#8f5902;font-style:italic"># 创建一对 veth 设备</span>
</span></span><span style="display:flex;"><span>$ ethtool -S ve_A         <span style="color:#8f5902;font-style:italic"># 查找 ve_A 接口对端接口的索引</span>
</span></span><span style="display:flex;"><span>NIC statistics:
</span></span><span style="display:flex;"><span>    peer_ifindex: <span style="color:#0000cf;font-weight:bold">16</span>
</span></span><span style="display:flex;"><span>$ ip link <span style="color:#000;font-weight:bold">|</span> grep <span style="color:#4e9a06">&#39;^16:&#39;</span>   <span style="color:#8f5902;font-style:italic"># 查找索引是 16 的设备</span>
</span></span><span style="display:flex;"><span>16: ve_B@ve_A: &lt;BROADCAST,MULTICAST,M-DOWN&gt; mtu <span style="color:#0000cf;font-weight:bold">1500</span> qdisc ...
</span></span></code></pre></div><ul>
<li><strong>注意</strong>：如果 veth 的设备名太长，ethtool 会出错</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>root@Macmini:~# ethtool -S veth550bfa1@if25
</span></span><span style="display:flex;"><span>ioctl-only request, device name longer than <span style="color:#0000cf;font-weight:bold">15</span> not supported
</span></span></code></pre></div><h2 id="准备工作">准备工作</h2>
<ul>
<li>查看当前主机上的网桥设备，默认有一个 docker0</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>root@dockervbox:~# brctl show
</span></span><span style="display:flex;"><span>bridge name     bridge id               STP enabled     interfaces
</span></span><span style="display:flex;"><span>docker0         8000.02421f335f1f       no
</span></span></code></pre></div><ul>
<li>创建 /var/run/netns 目录，ip netns 操作的就是此目录中的网络 namespace</li>
<li>删除 /var/run/netns 中的所有目录</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>root@dockervbox:~# mkdir -p /var/run/netns
</span></span><span style="display:flex;"><span>root@dockervbox:~# find -L /var/run/netns -type l -delete
</span></span></code></pre></div><h2 id="启动容器">启动容器</h2>
<ul>
<li>使用 none 网络模式启动一个 nginx 容器</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>ø&gt; docker run --rm -it --network<span style="color:#ce5c00;font-weight:bold">=</span>none -d nginx
</span></span><span style="display:flex;"><span>ebcf462cbb463d41dd677a501aee5a629f587141c27632d4954017784877b7c0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ø&gt; docker ps
</span></span><span style="display:flex;"><span>CONTAINER ID   IMAGE     COMMAND                  CREATED         STATUS         PORTS     NAMES
</span></span><span style="display:flex;"><span>ebcf462cbb46   nginx     <span style="color:#4e9a06">&#34;/docker-entrypoint.…&#34;</span>   <span style="color:#0000cf;font-weight:bold">6</span> minutes ago   Up <span style="color:#0000cf;font-weight:bold">6</span> minutes             exciting_torvalds
</span></span></code></pre></div><ul>
<li>启动成功后，记录此容器的 pid 到 $pid 环境变量</li>
</ul>
<pre tabindex="0"><code>ø&gt; docker inspect ebcf462cbb463d41dd677a501aee5a629f587141c27632d4954017784877b7c0 | grep -i pid
            &#34;Pid&#34;: 119320,
            &#34;PidMode&#34;: &#34;&#34;,
            &#34;PidsLimit&#34;: null,
ø&gt; export pid=119320
ø&gt; echo $pid
119320
</code></pre><ul>
<li>进入 $pid 进程所在的网络 ns, 查看所有的网络设备，可以看到只有一个 lo 设备，没有其他的网络设备</li>
</ul>
<pre tabindex="0"><code>root@Macmini:~# nsenter -t $pid -n ip a
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
inet 127.0.0.1/8 scope host lo
valid_lft forever preferred_lft forever
</code></pre><ul>
<li>软链接 $pid 的网络 ns 到 /var/run/netns/ 中, 使 ip netns 可以操作它</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>root@Macmini:~# ln -s <span style="color:#4e9a06">&#34;/proc/</span><span style="color:#000">$pid</span><span style="color:#4e9a06">/ns/net&#34;</span> /var/run/netns/<span style="color:#000">$pid</span>
</span></span><span style="display:flex;"><span>root@Macmini:~# ls /var/run/netns/119320
</span></span><span style="display:flex;"><span>/var/run/netns/119320
</span></span><span style="display:flex;"><span>root@Macmini:~# ip netns list
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">119320</span>
</span></span></code></pre></div><ul>
<li>使用 <code>lsns -t net</code> 查看当前系统的 network namespace, 可以看到已经有 nginx 容器的 network namespace 了</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>root@Macmini:~# lsns -t net <span style="color:#000;font-weight:bold">|</span> head -n <span style="color:#0000cf;font-weight:bold">3</span>
</span></span><span style="display:flex;"><span>        NS TYPE NPROCS    PID USER         NETNSID NSFS                           COMMAND
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">4026531840</span> net     <span style="color:#0000cf;font-weight:bold">345</span>      <span style="color:#0000cf;font-weight:bold">1</span> root      unassigned                                /sbin/init
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">4026532348</span> net      <span style="color:#0000cf;font-weight:bold">13</span> <span style="color:#0000cf;font-weight:bold">119320</span> root      unassigned /run/docker/netns/2bdfbe67a978 nginx: master process nginx -g daemon off<span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><ul>
<li>查看 <code>/proc/$pid/ns</code> 目录中的 namespace id, 能够看到 net namespace id 和 lsns 列出的 id 相同</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>root@Macmini:~# ls -l /proc/<span style="color:#000">$pid</span>/ns
</span></span><span style="display:flex;"><span>总用量 <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>lrwxrwxrwx <span style="color:#0000cf;font-weight:bold">1</span> root root <span style="color:#0000cf;font-weight:bold">0</span>  1月 <span style="color:#0000cf;font-weight:bold">20</span> 11:01 cgroup -&gt; <span style="color:#4e9a06">&#39;cgroup:[4026532904]&#39;</span>
</span></span><span style="display:flex;"><span>lrwxrwxrwx <span style="color:#0000cf;font-weight:bold">1</span> root root <span style="color:#0000cf;font-weight:bold">0</span>  1月 <span style="color:#0000cf;font-weight:bold">20</span> 11:01 ipc -&gt; <span style="color:#4e9a06">&#39;ipc:[4026532307]&#39;</span>
</span></span><span style="display:flex;"><span>lrwxrwxrwx <span style="color:#0000cf;font-weight:bold">1</span> root root <span style="color:#0000cf;font-weight:bold">0</span>  1月 <span style="color:#0000cf;font-weight:bold">20</span> 11:01 mnt -&gt; <span style="color:#4e9a06">&#39;mnt:[4026532278]&#39;</span>
</span></span><span style="display:flex;"><span>lrwxrwxrwx <span style="color:#0000cf;font-weight:bold">1</span> root root <span style="color:#0000cf;font-weight:bold">0</span>  1月 <span style="color:#0000cf;font-weight:bold">20</span> 10:50 net -&gt; <span style="color:#4e9a06">&#39;net:[4026532348]&#39;</span>
</span></span><span style="display:flex;"><span>lrwxrwxrwx <span style="color:#0000cf;font-weight:bold">1</span> root root <span style="color:#0000cf;font-weight:bold">0</span>  1月 <span style="color:#0000cf;font-weight:bold">20</span> 11:01 pid -&gt; <span style="color:#4e9a06">&#39;pid:[4026532312]&#39;</span>
</span></span><span style="display:flex;"><span>lrwxrwxrwx <span style="color:#0000cf;font-weight:bold">1</span> root root <span style="color:#0000cf;font-weight:bold">0</span>  1月 <span style="color:#0000cf;font-weight:bold">20</span> 11:01 pid_for_children -&gt; <span style="color:#4e9a06">&#39;pid:[4026532312]&#39;</span>
</span></span><span style="display:flex;"><span>lrwxrwxrwx <span style="color:#0000cf;font-weight:bold">1</span> root root <span style="color:#0000cf;font-weight:bold">0</span>  1月 <span style="color:#0000cf;font-weight:bold">20</span> 11:01 <span style="color:#204a87">time</span> -&gt; <span style="color:#4e9a06">&#39;time:[4026531834]&#39;</span>
</span></span><span style="display:flex;"><span>lrwxrwxrwx <span style="color:#0000cf;font-weight:bold">1</span> root root <span style="color:#0000cf;font-weight:bold">0</span>  1月 <span style="color:#0000cf;font-weight:bold">20</span> 11:01 time_for_children -&gt; <span style="color:#4e9a06">&#39;time:[4026531834]&#39;</span>
</span></span><span style="display:flex;"><span>lrwxrwxrwx <span style="color:#0000cf;font-weight:bold">1</span> root root <span style="color:#0000cf;font-weight:bold">0</span>  1月 <span style="color:#0000cf;font-weight:bold">20</span> 11:01 user -&gt; <span style="color:#4e9a06">&#39;user:[4026531837]&#39;</span>
</span></span><span style="display:flex;"><span>lrwxrwxrwx <span style="color:#0000cf;font-weight:bold">1</span> root root <span style="color:#0000cf;font-weight:bold">0</span>  1月 <span style="color:#0000cf;font-weight:bold">20</span> 11:01 uts -&gt; <span style="color:#4e9a06">&#39;uts:[4026532280]&#39;</span>
</span></span></code></pre></div><h2 id="创建-veth-设备">创建 veth 设备</h2>
<ul>
<li>创建一对 veth 设备，叫做 A 和 B</li>
<li>将 A 连接到 docker0 网桥上</li>
<li>启动 A</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>root@Macmini:~# ip link add A <span style="color:#204a87">type</span> veth peer name B
</span></span><span style="display:flex;"><span>root@Macmini:~# brctl addif docker0 A
</span></span><span style="display:flex;"><span>root@Macmini:~# ip link <span style="color:#204a87">set</span> A up
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># A 处于 UP 状态，但因为 A 没有完全连通，所以还是有 M-DOWN 的状态</span>
</span></span><span style="display:flex;"><span>root@Macmini:~# ip a
</span></span><span style="display:flex;"><span>23: B@A: &lt;BROADCAST,MULTICAST&gt; mtu <span style="color:#0000cf;font-weight:bold">1500</span> qdisc noop state DOWN group default qlen <span style="color:#0000cf;font-weight:bold">1000</span>
</span></span><span style="display:flex;"><span>    link/ether 16:81:96:a3:bf:27 brd ff:ff:ff:ff:ff:ff
</span></span><span style="display:flex;"><span>24: A@B: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP,M-DOWN&gt; mtu <span style="color:#0000cf;font-weight:bold">1500</span> qdisc noqueue master docker0 state LOWERLAYERDOWN group default qlen <span style="color:#0000cf;font-weight:bold">1000</span>
</span></span><span style="display:flex;"><span>    link/ether 76:8b:1a:65:f5:57 brd ff:ff:ff:ff:ff:ff
</span></span></code></pre></div><h2 id="设置-veth-设备">设置 veth 设备</h2>
<ul>
<li>将 ip, 掩码， 网关保存成环境变量</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>root@Macmini:~# <span style="color:#000">SETIP</span><span style="color:#ce5c00;font-weight:bold">=</span>172.17.0.10
</span></span><span style="display:flex;"><span>root@Macmini:~# <span style="color:#000">SETMASK</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">16</span>
</span></span><span style="display:flex;"><span>root@Macmini:~# <span style="color:#000">GATEWAY</span><span style="color:#ce5c00;font-weight:bold">=</span>172.17.0.1
</span></span></code></pre></div><ul>
<li>将 veth 设备 B 加入到 $pid 所在的 network namespace 中</li>
<li>并将 设备 B 的名字改成 eth0</li>
</ul>
<pre tabindex="0"><code>root@Macmini:~# ip link set B netns $pid
root@Macmini:~# ip netns exec $pid ip link set dev B name eth0
</code></pre><ul>
<li>此时查看 $pid network namespace 中的网络设备，可以看到 eth0 已经存在了</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>root@Macmini:~# ip netns <span style="color:#204a87">exec</span> <span style="color:#000">$pid</span> ip a
</span></span><span style="display:flex;"><span>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu <span style="color:#0000cf;font-weight:bold">65536</span> qdisc noqueue state UNKNOWN group default qlen <span style="color:#0000cf;font-weight:bold">1000</span>
</span></span><span style="display:flex;"><span>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
</span></span><span style="display:flex;"><span>    inet 127.0.0.1/8 scope host lo
</span></span><span style="display:flex;"><span>       valid_lft forever preferred_lft forever
</span></span><span style="display:flex;"><span>23: eth0@if24: &lt;BROADCAST,MULTICAST&gt; mtu <span style="color:#0000cf;font-weight:bold">1500</span> qdisc noop state DOWN group default qlen <span style="color:#0000cf;font-weight:bold">1000</span>
</span></span><span style="display:flex;"><span>    link/ether 16:81:96:a3:bf:27 brd ff:ff:ff:ff:ff:ff link-netnsid <span style="color:#0000cf;font-weight:bold">0</span>
</span></span></code></pre></div><ul>
<li>启动 eth0</li>
<li>因为 A 已经连接到了网桥上，所以直接启动成功，出现了 <code>LOWER_UP</code> 的状态</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>root@Macmini:~# ip netns <span style="color:#204a87">exec</span> <span style="color:#000">$pid</span> ip link <span style="color:#204a87">set</span> eth0 up
</span></span><span style="display:flex;"><span>root@Macmini:~# ip netns <span style="color:#204a87">exec</span> <span style="color:#000">$pid</span> ip a
</span></span><span style="display:flex;"><span>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu <span style="color:#0000cf;font-weight:bold">65536</span> qdisc noqueue state UNKNOWN group default qlen <span style="color:#0000cf;font-weight:bold">1000</span>
</span></span><span style="display:flex;"><span>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
</span></span><span style="display:flex;"><span>    inet 127.0.0.1/8 scope host lo
</span></span><span style="display:flex;"><span>       valid_lft forever preferred_lft forever
</span></span><span style="display:flex;"><span>23: eth0@if24: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span style="color:#0000cf;font-weight:bold">1500</span> qdisc noqueue state UP group default qlen <span style="color:#0000cf;font-weight:bold">1000</span>
</span></span><span style="display:flex;"><span>    link/ether 16:81:96:a3:bf:27 brd ff:ff:ff:ff:ff:ff link-netnsid <span style="color:#0000cf;font-weight:bold">0</span>
</span></span></code></pre></div><ul>
<li>设置 IP 和路由</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 设置 $pid ns 中的 eth0 设备的 ip 和 掩码</span>
</span></span><span style="display:flex;"><span>root@dockervbox:~# ip netns <span style="color:#204a87">exec</span> <span style="color:#000">$pid</span> ip addr add <span style="color:#000">$SETIP</span>/<span style="color:#000">$SETMASK</span> dev eth0
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 设置 $pid ns 中的 eth0 设备的默认路由网关</span>
</span></span><span style="display:flex;"><span>root@dockervbox:~# ip netns <span style="color:#204a87">exec</span> <span style="color:#000">$pid</span> ip route add default via <span style="color:#000">$GATEWAY</span>
</span></span></code></pre></div><ul>
<li>查看 IP 和路由</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 查看 $pid ns 中的所有设备，可以看到 eth0 已经启动成功，并且有了 ip 和子网掩码</span>
</span></span><span style="display:flex;"><span>root@Macmini:~# nsenter -t <span style="color:#000">$pid</span> -n ip a
</span></span><span style="display:flex;"><span>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu <span style="color:#0000cf;font-weight:bold">65536</span> qdisc noqueue state UNKNOWN group default qlen <span style="color:#0000cf;font-weight:bold">1000</span>
</span></span><span style="display:flex;"><span>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
</span></span><span style="display:flex;"><span>    inet 127.0.0.1/8 scope host lo
</span></span><span style="display:flex;"><span>       valid_lft forever preferred_lft forever
</span></span><span style="display:flex;"><span>23: eth0@if24: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span style="color:#0000cf;font-weight:bold">1500</span> qdisc noqueue state UP group default qlen <span style="color:#0000cf;font-weight:bold">1000</span>
</span></span><span style="display:flex;"><span>    link/ether 16:81:96:a3:bf:27 brd ff:ff:ff:ff:ff:ff link-netnsid <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>    inet 172.17.0.10/16 scope global eth0
</span></span><span style="display:flex;"><span>       valid_lft forever preferred_lft forever
</span></span></code></pre></div><ul>
<li>查看 $pid ns 中的路由表，可以看到 eth0 默认的路由地址是 172.17.0.1</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>root@Macmini:~# nsenter -t <span style="color:#000">$pid</span> -n ip route
</span></span><span style="display:flex;"><span>default via 172.17.0.1 dev eth0
</span></span><span style="display:flex;"><span>172.17.0.0/16 dev eth0 proto kernel scope link src 172.17.0.10
</span></span></code></pre></div><ul>
<li>查看宿主机上的网络设备，可以看到 veth A 的名字变成了 A@if23, 并且状态已经由 <code>M-DOWN</code> 变成了 <code>LOWER_UP</code></li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>root@Macmini:~# ip a
</span></span><span style="display:flex;"><span>24: A@if23: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span style="color:#0000cf;font-weight:bold">1500</span> qdisc noqueue master docker0 state UP group default qlen <span style="color:#0000cf;font-weight:bold">1000</span>
</span></span><span style="display:flex;"><span>    link/ether 76:8b:1a:65:f5:57 brd ff:ff:ff:ff:ff:ff link-netns <span style="color:#0000cf;font-weight:bold">119320</span>
</span></span><span style="display:flex;"><span>    inet6 fe80::748b:1aff:fe65:f557/64 scope link
</span></span><span style="display:flex;"><span>       valid_lft forever preferred_lft forever
</span></span></code></pre></div><h2 id="容器网络启动成功">容器网络启动成功</h2>
<ul>
<li>最后，我们在容器中访问互联网，能够成功访问</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>root@Macmini:~# docker <span style="color:#204a87">exec</span> ebcf462cbb46 curl -I www.baidu.com
</span></span><span style="display:flex;"><span>  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
</span></span><span style="display:flex;"><span>                                 Dload  Upload   Total   Spent    Left  Speed
</span></span><span style="display:flex;"><span>  <span style="color:#0000cf;font-weight:bold">0</span>   <span style="color:#0000cf;font-weight:bold">277</span>    <span style="color:#0000cf;font-weight:bold">0</span>     <span style="color:#0000cf;font-weight:bold">0</span>    <span style="color:#0000cf;font-weight:bold">0</span>     <span style="color:#0000cf;font-weight:bold">0</span>      <span style="color:#0000cf;font-weight:bold">0</span>      <span style="color:#0000cf;font-weight:bold">0</span> --:--:-- --:--:-- --:--:--     <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>HTTP/1.1 <span style="color:#0000cf;font-weight:bold">200</span> OK
</span></span><span style="display:flex;"><span>Accept-Ranges: bytes
</span></span><span style="display:flex;"><span>Cache-Control: private, no-cache, no-store, proxy-revalidate, no-transform
</span></span><span style="display:flex;"><span>Connection: keep-alive
</span></span><span style="display:flex;"><span>Content-Length: <span style="color:#0000cf;font-weight:bold">277</span>
</span></span><span style="display:flex;"><span>Content-Type: text/html
</span></span><span style="display:flex;"><span>Date: Fri, <span style="color:#0000cf;font-weight:bold">20</span> Jan <span style="color:#0000cf;font-weight:bold">2023</span> 03:33:01 GMT
</span></span><span style="display:flex;"><span>Etag: <span style="color:#4e9a06">&#34;575e1f60-115&#34;</span>
</span></span><span style="display:flex;"><span>Last-Modified: Mon, <span style="color:#0000cf;font-weight:bold">13</span> Jun <span style="color:#0000cf;font-weight:bold">2016</span> 02:50:08 GMT
</span></span><span style="display:flex;"><span>Pragma: no-cache
</span></span><span style="display:flex;"><span>Server: bfe/1.0.8.18
</span></span></code></pre></div><ul>
<li>在宿主机上访问 nginx 容器的 ip, 也能够正常访问</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>root@Macmini:~# curl -I <span style="color:#000">$SETIP</span>
</span></span><span style="display:flex;"><span>HTTP/1.1 <span style="color:#0000cf;font-weight:bold">200</span> OK
</span></span><span style="display:flex;"><span>Server: nginx/1.23.3
</span></span><span style="display:flex;"><span>Date: Fri, <span style="color:#0000cf;font-weight:bold">20</span> Jan <span style="color:#0000cf;font-weight:bold">2023</span> 03:28:12 GMT
</span></span><span style="display:flex;"><span>Content-Type: text/html
</span></span><span style="display:flex;"><span>Content-Length: <span style="color:#0000cf;font-weight:bold">615</span>
</span></span><span style="display:flex;"><span>Last-Modified: Tue, <span style="color:#0000cf;font-weight:bold">13</span> Dec <span style="color:#0000cf;font-weight:bold">2022</span> 15:53:53 GMT
</span></span><span style="display:flex;"><span>Connection: keep-alive
</span></span><span style="display:flex;"><span>ETag: <span style="color:#4e9a06">&#34;6398a011-267&#34;</span>
</span></span><span style="display:flex;"><span>Accept-Ranges: bytes
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-b711168a3d768a0c419283a9a611a17f">11.3 - Ubuntu 下安装 Containerd 及配置代理</h1>
    
	<blockquote>
<p>介绍了安装 containerd 的方法</p>
</blockquote>
<hr>
<h2 id="安装-containerd">安装 containerd</h2>
<ul>
<li>卸载从 apt 源安装的 containerd</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>apt-get remove -y containerd docker.io
</span></span><span style="display:flex;"><span>rm -vf /etc/systemd/system/containerd.service
</span></span><span style="display:flex;"><span>rm -rvf /etc/systemd/system/containerd.service.d
</span></span></code></pre></div><ul>
<li>安装 containerd 二进制文件</li>
</ul>
<ol>
<li>从 <a href="https://github.com/containerd/containerd/releases">containerd release 页面</a> 下载 <code>containerd-{version}-linux-amd64.tar.gz</code></li>
<li>将 containerd 的二进制文件解压到 /usr/local/bin 中</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 我下载的是 1.6.8 版本</span>
</span></span><span style="display:flex;"><span>tar Cxzvf /usr/local containerd-1.6.8-linux-amd64.tar.gz
</span></span></code></pre></div><ol start="3">
<li>从 <a href="https://github.com/containerd/containerd/blob/main/containerd.service">containerd 仓库</a> 中下载 systemd 配置文件, 并将其复制到 <code>/usr/local/lib/systemd/system/containerd.service</code> 中</li>
<li>重启令 systemd 配置文件生效</li>
</ol>
<pre tabindex="0"><code>systemctl daemon-reload
systemctl enable --now containerd
</code></pre><ul>
<li>安装 runc</li>
</ul>
<ol>
<li>从 <a href="https://github.com/opencontainers/runc/releases">runc release 页面</a> 下载 <code>runc.amd64</code></li>
<li>安装 runc,</li>
</ol>
<pre tabindex="0"><code>install -m 755 runc.amd64 /usr/local/sbin/runc
</code></pre><ul>
<li>安装 CNI 插件</li>
</ul>
<ol>
<li>从 <a href="https://github.com/containernetworking/plugins/releases">containernetworking release 页面</a> 下载 <code>cni-plugins-linux-amd64-v{vesion}.tgz</code></li>
<li>将其解压到 <code>/opt/cni/bin</code> 中</li>
</ol>
<pre tabindex="0"><code>mkdir -p /opt/cni/bin
tar Cxzvf /opt/cni/bin cni-plugins-linux-amd64-v1.1.1.tgz
</code></pre><h2 id="containerd-客户端的说明">containerd 客户端的说明</h2>
<table>
<thead>
<tr>
<th>Name</th>
<th>Community</th>
<th>API</th>
<th>Target</th>
<th>Web site</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ctr</code></td>
<td>containerd</td>
<td>Native</td>
<td>For debugging only</td>
<td>(None, see <code>ctr --help</code> to learn the usage)</td>
</tr>
<tr>
<td><code>nerdctl</code></td>
<td>containerd (non-core)</td>
<td>Native</td>
<td>General-purpose</td>
<td><a href="https://github.com/containerd/nerdctl">https://github.com/containerd/nerdctl</a></td>
</tr>
<tr>
<td><code>crictl</code></td>
<td>Kubernetes SIG-node</td>
<td>CRI</td>
<td>For debugging only</td>
<td><a href="https://github.com/kubernetes-sigs/cri-tools/blob/master/docs/crictl.md">https://github.com/kubernetes-sigs/cri-tools/blob/master/docs/crictl.md</a></td>
</tr>
</tbody>
</table>
<p>一共有三种命令行工具可以和 containerd 交互:</p>
<ul>
<li><code>ctr</code> 和 <code>nerdctl</code> 都是 containerd 社区提供的工具, <code>ctr</code> 是和 <code>containerd</code> 一起安装的.</li>
<li><code>crictl</code> 是 k8s 社区提供的符合 CRI 接口的交互工具. 在 Ubuntu 下,可以通过 <code>sudo apt get install cri-tools</code> 安装 <code>crictl</code></li>
</ul>
<h2 id="生成-containerd-配置文件">生成 containerd 配置文件</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>containerd config default <span style="color:#000;font-weight:bold">|</span> sudo tee /etc/containerd/config.toml
</span></span></code></pre></div><p>执行以上命令可以生成 containerd 的默认配置文件, 我们可以做一些自定义的修改, 例如修改 <code>[plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.runtimes.runc.options]</code>, 令 <code>SystemdCgroup = true</code>, 让 containerd 和 systemd 使用同一个 cgroups 控制器</p>
<p>crictl 默认连接的 service socket是 <code>unix:///var/run/dockershim.sock</code>, 我们可以在 <code>/etc/crictl.yaml</code> 中写入以下配置</p>
<pre tabindex="0"><code>runtime-endpoint: unix:///run/containerd/containerd.sock
</code></pre><p>让它默认连接 containerd 的 socket 接口</p>
<h2 id="设置拉取镜像的-http-代理">设置拉取镜像的 http 代理</h2>
<p>通过设置 <code>HTTP_PROXY</code>, <code>HTTPS_PROXY</code> 环境变量, 可以设置 http 代理.</p>
<blockquote>
<p><strong>注意</strong></p>
<ul>
<li><code>ctr pull ...</code> 是在客户端进程中拉取镜像的, 环境变量需要设置到客户端中</li>
<li><code>crictl pull ...</code> 是在 cri 插件中拉取镜像的, 它被集成到了 containerd 中, 所以需要在 server 端设置环境变量</li>
</ul>
</blockquote>
<h3 id="设置-server-端的环境变量">设置 server 端的环境变量</h3>
<p>修改 <code>/usr/local/lib/systemd/system/containerd.service</code> 文件, 在 <code>[Service]</code> 段加入以下内容</p>
<pre tabindex="0"><code># 设置拉取镜像的代理
Environment=HTTP_PROXY=127.0.0.1:8118
Environment=HTTPS_PROXY=127.0.0.1:8118
Environment=NO_PROXY=localhost,127.0.0.1,172.17.0.0/16,192.168.56.0/24,10.96.0.0/16
</code></pre><p>修改完以上配置后, 重启 containerd , 环境变量就生效了</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>systemctl daemon-reload
</span></span><span style="display:flex;"><span>systemctl restart containerd
</span></span></code></pre></div><p>此时再执行 <code>sudo crictl pull k8s.gcr.io/kube-controller-manager:v1.24.4</code> 就可以成功拉取到 k8s 相关的镜像了, 也能够正常地和 <code>kubeadm</code> 交互了</p>
<h3 id="设置-client-侧的环境变量">设置 client 侧的环境变量</h3>
<p>如果想通过 <code>ctr</code> 拉取镜像, 需要在 client 侧设置环境变量</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>sudo <span style="color:#000">HTTP_PROXY</span><span style="color:#ce5c00;font-weight:bold">=</span>127.0.0.1:8118 <span style="color:#000">HTTPS_PROXY</span><span style="color:#ce5c00;font-weight:bold">=</span>127.0.0.1:8118 ctr i pull k8s.gcr.io/kube-apiserver:v1.24.4
</span></span></code></pre></div><p>这样也能正常拉取镜像</p>
<h2 id="参考链接">参考链接</h2>
<ul>
<li><a href="https://github.com/containerd/containerd/blob/main/docs/getting-started.md">https://github.com/containerd/containerd/blob/main/docs/getting-started.md</a></li>
<li><a href="https://github.com/containerd/cri/issues/1169#issuecomment-501376676">https://github.com/containerd/cri/issues/1169#issuecomment-501376676</a></li>
</ul>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-00dc390d2f975a93f93712be0cac7f2e">11.4 - Ubuntu 下 Docker 设置 Registry</h1>
    
	<blockquote>
<ul>
<li>docker 拉取镜像怎么办?
<ul>
<li>
<ol>
<li>设置 registry-mirror</li>
</ol>
</li>
<li>
<ol start="2">
<li>为 dockerd 设置 http 代理</li>
</ol>
</li>
</ul>
</li>
<li>鉴于很多厂商不再提供公共的 docker registry，提供服务的也都对下载速度进行了限制，建议使用第二种解决方案</li>
</ul>
</blockquote>
<hr>
<h2 id="docker-配置-registry-mirror">docker 配置 registry-mirror</h2>
<ul>
<li>执行 <code>systemctl cat docker | grep Exec</code> 查看 dockerd 的启动命令，确认启动时没有指定 <code>registry-mirror</code> 选项</li>
</ul>
<pre tabindex="0"><code>ø&gt; systemctl cat docker | grep Exec
ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock
ExecReload=/bin/kill -s HUP $MAINPID
</code></pre><ul>
<li>向 <code>/etc/docker/daemon.json</code> 写入以下内容</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>sudo mkdir -p /etc/docker
</span></span><span style="display:flex;"><span>sudo tee /etc/docker/daemon.json <span style="color:#4e9a06">&lt;&lt;-&#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">{
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  &#34;registry-mirrors&#34;: [
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    &#34;https://hub-mirror.c.163.com&#34;,
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    &#34;https://mirror.baidubce.com&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">  ]
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">}
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">EOF</span>
</span></span></code></pre></div><ul>
<li>重新启动服务</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>sudo systemctl daemon-reload
</span></span><span style="display:flex;"><span>sudo systemctl restart docker
</span></span></code></pre></div><ul>
<li>检查配置是否成功</li>
</ul>
<pre tabindex="0"><code>docker info | grep -A 3 &#39;Registry Mirrors:&#39;
</code></pre><ul>
<li>速度限制</li>
</ul>
<p>目前找到的可用的公共 registry-mirror 一共有三个</p>
<ul>
<li><code>https://hub-mirror.c.163.com</code></li>
<li><code>https://mirror.baidubce.com</code></li>
<li><code>https://xxx.mirror.aliyuncs.com</code> (需要登录阿里云后获取)</li>
</ul>
<p>他们都存在限速，最高下载速度是每秒 500k 左右。</p>
<ul>
<li>镜像更新不及时</li>
</ul>
<p>有些较新的镜像，例如 <code>golang:1.19</code>， registry mirror 中并没有，最终还是会从 <code>registry-1.docker.io</code> 去拉取镜像</p>
<h2 id="dockerd-使用-http-代理">dockerd 使用 http 代理</h2>
<ul>
<li>在执行 <code>docker pull</code> 的时候，拉取镜像的过程实际是由 dockerd 执行，因此，想要在访问 <code>docker.io</code> 时加上代理，就需要通过 <code>http_proxy</code> 环境变量为 dockerd 配置代理</li>
<li>修改 systemd 配置，并写入代理配置</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>sudo mkdir -p /etc/systemd/system/docker.service.d
</span></span><span style="display:flex;"><span>sudo touch /etc/systemd/system/docker.service.d/proxy.conf
</span></span><span style="display:flex;"><span>sudo tee /etc/systemd/system/docker.service.d/proxy.conf <span style="color:#4e9a06">&lt;&lt;-&#39;EOF&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">Environment=&#34;HTTP_PROXY=http://proxy.example.com:8080/&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">Environment=&#34;HTTPS_PROXY=http://proxy.example.com:8080/&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">Environment=&#34;NO_PROXY=localhost,127.0.0.1,.example.com&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">EOF</span>
</span></span></code></pre></div><ul>
<li>重新启动服务</li>
</ul>
<pre tabindex="0"><code>sudo systemctl daemon-reload
sudo systemctl restart docker
</code></pre><ul>
<li>检查配置是否成功</li>
</ul>
<pre tabindex="0"><code>docker info | grep -A 3 &#39;Proxy&#39;
</code></pre><h2 id="参考链接">参考链接</h2>
<ul>
<li><a href="https://yeasy.gitbook.io/docker_practice/install/mirror">镜像加速器</a></li>
<li><a href="https://note.qidong.name/2020/05/docker-proxy/">Docker的三种网络代理配置</a></li>
</ul>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-72ba781c964286a98ded46d175dfee82">11.5 - Docker 客户端连接远程 Docker Daemon</h1>
    
	<blockquote>
<ul>
<li>Docker 客户端连接远程 Docker Daemon</li>
<li><a href="https://dockerlabs.collabnix.com/beginners/components/daemon/access-daemon-externally.html">参考链接 How to Connect to a Remote Docker Daemon</a></li>
</ul>
</blockquote>
<hr>
<h2 id="环境准备">环境准备</h2>
<ul>
<li>Ubuntu 18.04 运行着 Docker Daemon 19.03.6</li>
<li>MacOS 系统运行着 Docker Client 20.10.2 版本</li>
</ul>
<h2 id="设置-ubuntu-中的-docker-daemon">设置 Ubuntu 中的 Docker Daemon</h2>
<p><strong>注:</strong> 这一小节的命令都在 Ubuntu 中执行</p>
<ul>
<li>配置 Docker Daemon</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 创建 docker service 的配置文件目录</span>
</span></span><span style="display:flex;"><span>sudo mkdir -p /etc/systemd/system/docker.service.d
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 修改 docker service 的启动命令，令其监听本地套接字文件和 2375 端口</span>
</span></span><span style="display:flex;"><span>sudo cat &gt; /etc/systemd/system/docker.service.d/options.conf <span style="color:#4e9a06">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">ExecStart=
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock -H tcp://0.0.0.0:2375
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">EOF</span>
</span></span></code></pre></div><ul>
<li>
<p>TODO: 配置防火墙 (由于我的 Ubuntu 是台虚拟机，我直接将防火墙关闭了)</p>
</li>
<li>
<p>重启 docker service，令配置生效</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>sudo systemctl daemon-reload <span style="color:#8f5902;font-style:italic"># 重新载入 systemd 关于 docker service 的配置</span>
</span></span><span style="display:flex;"><span>sudo systemctl restart docker.service <span style="color:#8f5902;font-style:italic"># 重启 docker service</span>
</span></span></code></pre></div><ul>
<li>执行 <code>docker version -f '{{.Server.APIVersion}}'</code>，查看 Docker API 版本，我的版本是 <code>1.40</code></li>
</ul>
<h2 id="客户端测试连接">客户端测试连接</h2>
<p><strong>注:</strong> 这一小节的命令都在 MacOS 中执行</p>
<ul>
<li>执行 <code>curl 192.168.56.23:2375/v1.40/images/json</code>，会列出所有已经下载的镜像，若返回值正确，表示 Docker Daemon 已经配置好了</li>
<li>使用 docker client 连接 Ubuntu 中的 Docker Daemon</li>
</ul>
<pre tabindex="0"><code>ø&gt; DOCKER_HOST=tcp://192.168.56.23:2375 docker images                                                                                                                                                                                                                                                     11:55:17 (05-22)
REPOSITORY                        TAG       IMAGE ID       CREATED         SIZE
ubuntu                            20.04     8e428cff54c8   8 weeks ago     72.9MB
ubuntu                            latest    8e428cff54c8   8 weeks ago     72.9MB
elasticsearch                     7.5.1     2bd69c322e98   17 months ago   779MB
docker.elastic.co/kibana/kibana   7.1.0     714b175e84e8   2 years ago     745MB
</code></pre><p>最后，我在 zshrc 中添加了一条 alias:</p>
<pre tabindex="0"><code>(( $+commands[docker] )) &amp;&amp; alias docker=&#34;DOCKER_HOST=tcp://192.168.56.23:2375 docker&#34;
</code></pre><p>这样在 MacOS 中执行 docker 命令访问的就是 Ubuntu 虚拟机中的 Docker Daemon 了。</p>
</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-5b8be070e024dee1528ca4106a3ef913">12 - HTTP</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-674980be1abe17a6cece69ef854e0dca">12.1 - HTTP 协议中带下划线的 header 说明</h1>
    
	<hr>
<h2 id="http-header-名字的规范">HTTP Header 名字的规范</h2>
<p><a href="https://www.rfc-editor.org/rfc/rfc9110.html#fields.registry">RFC9110</a> 中说，Field Name <strong>应该</strong> 仅包含字母数字，连字符(<code>-</code>), 第一个字符是字母，不区分大小写。</p>
<blockquote>
<p>The requested field name. It MUST conform to the field-name syntax defined in Section 5.1, and it SHOULD be restricted to just letters, digits, and hyphen (&rsquo;-&rsquo;) characters, with the first character being a letter.</p>
</blockquote>
<p>自定义专用的标头之前可以与 <code>X-</code> 前缀一起使用，但是这种用法被 IETF 在 2012 年 6 月发布的 <a href="https://datatracker.ietf.org/doc/html/rfc6648">RFC 6648</a> 明确弃用，原因是其会在非标准字段成为标准时造成不便；</p>
<p>一个标准的 HTTP Header 诞生要经历漫长的过程，而且我们的 Header 中如果有业务前缀的话，基本不会和标准 HTTP Header 冲突，所以很多文章说使用 <code>X-</code> 前缀也没有什么问题。</p>
<p>Nginx 的 <a href="http://nginx.org/en/docs/http/ngx_http_core_module.html#ignore_invalid_headers">ignore_invalid_headers</a> 配置文档中说，Http Header 名称由字母数字，连字符组成，<code>underscores_in_headers</code> 开启时可以包含下划线。</p>
<p>当在 Nginx 中设置了 <code>ignore_invalid_headers on;</code> 时， Nginx 会自动丢弃名称无效的 Header 。</p>
<h2 id="如何让-nginx-允许-header-名中带下划线">如何让 Nginx 允许 Header 名中带下划线</h2>
<p>Nginx 的选项 <a href="http://nginx.org/en/docs/http/ngx_http_core_module.html#underscores_in_headers">underscores_in_headers</a> 可以允许我们在 HTTP Header 的名字中带上下划线。</p>
<blockquote>
<p>Enables or disables the use of underscores in client request header fields. When the use of underscores is disabled, request header fields whose names contain underscores are marked as invalid and become subject to the ignore_invalid_headers directive.</p>
</blockquote>
<h2 id="实验">实验</h2>
<h3 id="使用-nc-启动一个-http-server">使用 nc 启动一个 http server</h3>
<ul>
<li>/tmp/index.http</li>
</ul>
<pre tabindex="0"><code>HTTP/1.1 200 OK
Content-Type: text/html; charset=UTF-8
Content-Length: 77
Server: netcat!

&lt;!doctype html&gt;
&lt;html&gt;&lt;body&gt;&lt;h1&gt;A webpage served by netcat&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;
</code></pre><ul>
<li>使用 nc 启动 web server</li>
</ul>
<pre tabindex="0"><code>while true;do cat /tmp/index.http| nc -l -p 8090 ;done
</code></pre><blockquote>
<p><strong>注意</strong>: 不能使用 flask 作为后端</p>
<p>Python 的 wsgi 解析器或 Flask 中会自动丢掉名字中带下划线的 header, 使用 flask 作为后端，就算 Nginx 传了下划线 Header 我们也看不到。</p>
<p>使用 nc 作为后端 Web Server, 它会原样输出 nginx 传输给它的内容。</p>
</blockquote>
<p>我们使用 curl 命令给 Nginx Server 发送带下划线的 Header</p>
<pre tabindex="0"><code>curl -H &#39;Some_Header: V1&#39; -s flask.bwangel.me
</code></pre><h3 id="默认不会传输带下划线的-header">默认不会传输带下划线的 Header</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">server</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">listen</span> <span style="color:#0000cf;font-weight:bold">80</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">server_name</span> <span style="color:#4e9a06">flask.bwangel.me</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">location</span> <span style="color:#4e9a06">/</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">proxy_set_header</span> <span style="color:#4e9a06">Nginx-Host</span> <span style="color:#4e9a06">&#34;flask&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">proxy_pass</span> <span style="color:#4e9a06">http://127.0.0.1:8090</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><img src="https://github.com/bwangelme/bwangelme.github.io/assets/11701497/419ee40b-ffc6-4c69-9955-4358d6e8ac36" alt="image"></p>
<p>图中上半部分是 nc web server 输出的内容，可以看到 <code>Some_Header</code> 没有被 Nginx 传输给后端.</p>
<h3 id="关闭-ignore_invalid_headers">关闭 ignore_invalid_headers</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">server</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">listen</span> <span style="color:#0000cf;font-weight:bold">80</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">server_name</span> <span style="color:#4e9a06">flask.bwangel.me</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">ignore_invalid_headers</span> <span style="color:#000">off</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">location</span> <span style="color:#4e9a06">/</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">proxy_set_header</span> <span style="color:#4e9a06">Nginx-Host</span> <span style="color:#4e9a06">&#34;flask&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">proxy_pass</span> <span style="color:#4e9a06">http://127.0.0.1:8090</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>关闭了 <code>ignore_invalid_headers</code> 之后，无效的 header 也会被 Nginx 传输给后端了</p>
<p><img src="https://github.com/bwangelme/bwangelme.github.io/assets/11701497/95b9f397-c1d7-4782-afd2-9971b45fa402" alt="image"></p>
<p>上图中，可以看到 <code>Some_Header</code> 被 Nginx 传输给了后端</p>
<h3 id="开启-underscores_in_headers">开启 underscores_in_headers</h3>
<pre tabindex="0"><code>server {
    listen 80;

    server_name flask.bwangel.me;
    underscores_in_headers on;
    ignore_invalid_headers on;

    location / {
        proxy_set_header Nginx-Host &#34;flask&#34;;
        proxy_pass http://127.0.0.1:8090;
    }
}
</code></pre><p><img src="https://github.com/bwangelme/bwangelme.github.io/assets/11701497/2bfeda6c-0c4e-4bc9-a1d7-9eb00a15fa3c" alt="image"></p>
<p>可以看到，开启了 <code>underscores_in_headers</code> 之后，带下划线的 header 就是有效的 header 了，就算开着 <code>ignore_invalid_headers</code>, nginx 也会将 <code>Some_Header</code> 传输给后端。</p>
<h2 id="参考链接">参考链接</h2>
<ul>
<li><a href="https://www.nginx.com/resources/wiki/start/topics/tutorials/config_pitfalls/?highlight=underscores#missing-disappearing-http-headers">Missing (disappearing) HTTP Headers</a></li>
<li><a href="http://nginx.org/en/docs/http/ngx_http_core_module.html#ignore_invalid_headers">ignore_invalid_headers</a></li>
<li><a href="http://nginx.org/en/docs/http/ngx_http_core_module.html#underscores_in_headers">underscores_in_headers</a></li>
<li><a href="https://trac.nginx.org/nginx/ticket/2251">#2251 closed defect (worksforme) &ldquo;underscores_in_headers on&rdquo; didn&rsquo;t work</a></li>
<li><a href="https://www.rfc-editor.org/rfc/rfc9110.html#fields.registry">rfc9110.html</a></li>
<li><a href="https://datatracker.ietf.org/doc/html/rfc6648">RFC 6648</a></li>
<li><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers">MDN HTTP 标头（header）</a></li>
</ul>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-aed2ff328139f1dc7b767eb1eb9e5077">12.2 - Nginx proxy_set_header 默认会覆盖上一层的设置</h1>
    
	<hr>
<h2 id="配置代码">配置代码</h2>
<ul>
<li><code>app.py</code></li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#!/usr/bin/env python</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">json</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">from</span> <span style="color:#000">flask</span> <span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">Flask</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">request</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">app</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Flask</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">__name__</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#5c35cc;font-weight:bold">@app.route</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;/&#39;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">index</span><span style="color:#000;font-weight:bold">():</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">json</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">dumps</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">dict</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">request</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">headers</span><span style="color:#000;font-weight:bold">))</span>
</span></span></code></pre></div><p>Start the flask server:</p>
<pre tabindex="0"><code>FLASK_RUN_PORT=&#34;8060&#34; ~/.pyenv/versions/3.11.1/bin/flask run
</code></pre><ul>
<li><code>/etc/nginx/conf.d/flask.conf</code></li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">upstream</span> <span style="color:#4e9a06">flask</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">server</span> <span style="color:#000">localhost</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">8060</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">server</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">listen</span> <span style="color:#0000cf;font-weight:bold">80</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">server_name</span> <span style="color:#4e9a06">&#34;www.qae.com&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># 使用 curl 请求后端，后端能收到的 &#34;HH2&#34; &#34;HH3&#34;, 无法收到 HH0, HH1 header
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">proxy_set_header</span> <span style="color:#4e9a06">HH0</span> <span style="color:#4e9a06">&#34;value&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">proxy_set_header</span> <span style="color:#4e9a06">HH1</span> <span style="color:#4e9a06">&#34;value&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">location</span> <span style="color:#4e9a06">/</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic"># 当子块中有 proxy_set_header 指令时，父块中所有的 proxy_set_header 的值都会被丢弃
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#8f5902;font-style:italic"># include 不会创建新的块，所以 include 的配置文件中的 proxy_set_header 还能会正常使用的
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">proxy_set_header</span> <span style="color:#4e9a06">HH2</span> <span style="color:#4e9a06">&#34;value&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">proxy_set_header</span> <span style="color:#4e9a06">HHCOMMON</span> <span style="color:#4e9a06">&#34;value2&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">include</span> <span style="color:#4e9a06">conf.d/flask-component.conf</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">proxy_pass</span> <span style="color:#4e9a06">http://flask</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><ul>
<li><code>/etc/nginx/conf.d/flask-component.conf</code></li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">proxy_set_header</span> <span style="color:#4e9a06">HH3</span> <span style="color:#4e9a06">&#34;value&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 同一个块中多次使用 proxy_set_header 定义 HHCOMMON, 他们的值会用 `,` join 到一起
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">proxy_set_header</span> <span style="color:#4e9a06">HHCOMMON</span> <span style="color:#4e9a06">&#34;value3&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><h2 id="问题说明">问题说明</h2>
<p>以上是一个 nginx + flask 后端的配置，<code>proxy_set_header</code> 用来向后端传递 header ，我们使用 curl 来请求后端</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>ø&gt; curl -s www.qae.com <span style="color:#000;font-weight:bold">|</span> jq
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;Hh3&#34;</span>: <span style="color:#4e9a06">&#34;value&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;Hhcommon&#34;</span>: <span style="color:#4e9a06">&#34;value3,value2&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;Hh2&#34;</span>: <span style="color:#4e9a06">&#34;value&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;Host&#34;</span>: <span style="color:#4e9a06">&#34;flask&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;Connection&#34;</span>: <span style="color:#4e9a06">&#34;close&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;User-Agent&#34;</span>: <span style="color:#4e9a06">&#34;curl/7.81.0&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;Accept&#34;</span>: <span style="color:#4e9a06">&#34;*/*&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><p>可以看到后端仅收到 HH2 和 HH3, 但是 HH0 和 HH1 却消失了。这是为什么呢？</p>
<p>我翻了翻 nginx 的文档，里面这样写到</p>
<blockquote>
<p>Allows redefining or appending fields to the request header passed to the proxied server.</p>
</blockquote>
<blockquote>
<p>These directives are inherited from the previous configuration level if and <strong>only if there are no</strong> proxy_set_header directives defined on the current level.</p>
</blockquote>
<ul>
<li>如果当前配置块有 <code>proxy_set_header</code> 指令的话，就不会再继承父配置块中的 <code>proxy_set_header</code> 指令了
<ul>
<li><code>HH0</code>, <code>HH1</code> 消失, <code>HH2</code>能看到的原因</li>
</ul>
</li>
<li>include 指令不会创建新的配置块，所以 include 的文件中写的 <code>proxy_set_header</code> 会继续生效
<ul>
<li><code>HH3</code> 能正常看到</li>
</ul>
</li>
<li>如果一个块中用 <code>proxy_set_header</code> 多次设置了同一个 header, 那他们的值会放到一起
<ul>
<li><code>HHCOMMON</code> 的值是 <code>&quot;value3,value2&quot;</code></li>
</ul>
</li>
</ul>
<h2 id="参考链接">参考链接</h2>
<ul>
<li><a href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_set_header">nginx doc</a></li>
</ul>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-394cadd4f30bcd3b6e1d18482f78d518">12.3 - 如何生成自签名 HTTPS 证书</h1>
    
	<hr>
<h2 id="ca-机构是什么">CA 机构是什么</h2>
<p>Certificate Authority，是一个公司或者组织，用于为实体(网站，Email 地址，公司或个人等)提供证书。通过证书认证这些实体。</p>
<p>数字证书提供三方面的验证:</p>
<ol>
<li>身份验证(Authentication): 通过提供认证服务，来验证他颁发证书的实体。</li>
<li>加密(Encryption): 提供加密方式，让通信双方在不可信的信道上通信。</li>
<li>完整性验证(Integrity): 可以对文档进行签名，这样可以确保传输过程中文档不会被修改。</li>
</ol>
<h3 id="ca-机构的证书分类">CA 机构的证书分类</h3>
<table>
<thead>
<tr>
<th>证书类型</th>
<th>单域名</th>
<th>多域名</th>
<th>泛域名</th>
<th>多泛域名</th>
</tr>
</thead>
<tbody>
<tr>
<td>DV</td>
<td>支持</td>
<td>支持</td>
<td>不支持</td>
<td>不支持</td>
</tr>
<tr>
<td>OV</td>
<td>支持</td>
<td>支持</td>
<td>支持</td>
<td>支持</td>
</tr>
<tr>
<td>EV</td>
<td>支持</td>
<td>支持</td>
<td>不支持</td>
<td>不支持</td>
</tr>
<tr>
<td>举例</td>
<td><a href="https://www.bwangel.me">www.bwangel.me</a></td>
<td><code>www.bwangel.me</code>, <code>www.wbangel1.me</code>, <code>www.langel.me</code></td>
<td>*.bwangel.me</td>
<td>*.bwangel.me, *.fbangel2.me, *.wbngel.me</td>
</tr>
</tbody>
</table>
<p>不论是 DV，OV，还是EV证书，他们的加密效果都是一样的，其区别在于实体认证方式:</p>
<ol>
<li>DV(Domain Validation)，面向个体用户，认证方式为向 whois 信息中的邮箱发送邮件进行验证。</li>
<li>OV(Origanization Validation)，面向企业用户，证书在 DV 证书验证的基础上，还需要公司授权，CA 通过拨打信息库中的公司电话来确认</li>
<li>EV(Extended Validation)，这类证书除了上述两个确认外，还需要公司提供的金融机构的开户许可证，要求十分严格。</li>
</ol>
<p>OV 和 EV 证书相当昂贵，使用方可以为这些颁发出来的证书买保险，一旦 CA 提供的证书出现问题，一张证书的赔偿金可以达到 100w 刀以上。</p>
<h2 id="什么是证书申请文件csr">什么是证书申请文件(CSR)</h2>
<p>证书申请文件(Certificate Signing Request)，简写为 CSR。</p>
<p>数字证书的核心，其实就是非对称加密，这需要开发者自己保护好私钥的安全。</p>
<p>因此开发者在向 CA 申请证书的时候，开发者首先需要生成一个密钥对。开发者自己保管好私钥，然后将公钥和个人信息发送给 CA 机构，CA 机构通过公钥和你的个人信息最终签发数字证书。</p>
<p>而 CSR 文件其实就是一个包含了用户公钥和个人信息的一个数据文件。用户产生出这个 CSR 文件，再把这个 CSR 文件发送给 CA 机构，CA 机构通过 CSR 中的内容来签发出数字证书。</p>
<h2 id="san-是什么">SAN 是什么</h2>
<p>证书中字段的说明，除了这些通用字段外，证书中还可以附加字段。SAN 就是附加的字段。</p>
<table>
<thead>
<tr>
<th>Field</th>
<th>Meaning</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr>
<td>/C=</td>
<td>Country</td>
<td>GB</td>
</tr>
<tr>
<td>/ST=</td>
<td>State</td>
<td>London</td>
</tr>
<tr>
<td>/L=</td>
<td>Location</td>
<td>London</td>
</tr>
<tr>
<td>/O=</td>
<td>Organization</td>
<td>Global Security</td>
</tr>
<tr>
<td>/OU=</td>
<td>Organizational Unit</td>
<td>IT Department</td>
</tr>
<tr>
<td>/CN=</td>
<td>Common Name</td>
<td>example.com</td>
</tr>
</tbody>
</table>
<p>Subject Alternative Name ，多域名证书，令一个证书可以保护多个域名。</p>
<p>Chrome 从58开始 只会检查证书的 SAN 字段，不再检查 Common Name 字段的域名，如果没有设置 SAN 字段，Chrome 连接时会报错 <code>net:ERR_CERT_COMMON_NAME_INVALID</code></p>
<h2 id="chrome-连接-https-网站的常见错误">Chrome 连接 HTTPS 网站的常见错误</h2>
<ol>
<li><code>net:ERR_CERT_AUTHORITY_INVALID</code>: 浏览器不认服务器的证书，一般是因为给服务器签发证书的 CA 机构不在浏览器的信任列表中。</li>
<li><code>net:ERR_CERT_COMMON_NAME_INVALID</code>: Common Name 不匹配，即访问的域名和证书中的域名不匹配</li>
</ol>
<h2 id="如何生成一张证书">如何生成一张证书</h2>
<p>大致流程是:</p>
<ol>
<li>自定义配置文件，生成 CA 机构的证书</li>
<li>生成申请证书的 CSR 文件和私钥文件*pem (注意，一定要在配置文件中指定 SAN，否则 chrome 不认这个证书)</li>
<li>利用CA证书对 CSR 文件进行签名，生成证书文件。</li>
</ol>
<p>具体步骤见: <a href="https://github.com/bwangelme/Certs">https://github.com/bwangelme/Certs</a></p>
<h2 id="如何设置浏览器信任-ca-机构">如何设置浏览器信任 CA 机构</h2>
<ul>
<li>基于Chrome 86.0.4240.198</li>
</ul>
<p>Settings -&gt; Privacy and security -&gt; Security -&gt; Manage certificates -&gt; Authorities -&gt; Import 导入 CA 机构的 pem 文件</p>
<ul>
<li>基于 Firefox 83.0</li>
</ul>
<p>Preferences -&gt; Privacy &amp; Security -&gt; Certificates -&gt; View Certificates -&gt; Authorities -&gt; Import</p>
<h2 id="参考链接">参考链接</h2>
<ol>
<li><a href="https://www.barretlee.com/blog/2016/04/24/detail-about-ca-and-certs/">细说 CA 和证书</a></li>
<li><a href="https://www.jianshu.com/p/66d84ca65f41">什么是CSR文件</a></li>
<li><a href="https://www.shellhacks.com/create-csr-openssl-without-prompt-non-interactive/">HowTo: Create CSR using OpenSSL Without Prompt</a></li>
<li><a href="https://ningyu1.github.io/site/post/51-ssl-cert/">Openssl生成自签名证书，简单步骤</a></li>
<li><a href="http://blog.ideawand.com/2017/11/22/build-certificate-that-support-Subject-Alternative-Name-SAN/">使用OpenSSL生成含有Subject Alternative Name(SAN)的证书</a></li>
</ol>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-e441447b9eeecda48a04f52b3f5591d1">12.4 - HTTP 协议中的分块传输编码</h1>
    
	<p>说明了 HTTP 分块传输编码方式</p>
<h2 id="http的持久连接和短连接">HTTP的持久连接和短连接</h2>
<h3 id="基本概念">基本概念</h3>
<p>在聊 HTTP 协议的分块传输编码之前，我们先来聊一下HTTP的连接方式。</p>
<p>HTTP协议是应用层协议，它是建立在TCP协议之上的。TCP协议在传输数据之前，需要先通过三次握手建立连接，同时由于慢启动的特性，TCP协议的报文不会在一开始就满负荷传输。如果一个HTTP事务能够复用之前的TCP连接的话，将会节约很多的请求时间。</p>
<p>但是在最开始的<code>HTTP/1.0</code>中是不支持复用TCP连接的，即一个HTTP事务结束后，底层的TCP连接也立刻关闭掉，这就是短连接。在<code>HTTP1/1.1</code>中，新加了<code>Connection</code>请求头用来定义TCP连接的使用方式。<code>Connection</code>请求头的值有两种</p>
<ul>
<li><code>close</code></li>
</ul>
<p>表示服务端或服务器在HTTP事务结束后将会关闭相应的TCP连接，即使使用短连接的方式</p>
<ul>
<li>任何<code>,</code>分离的HTTP请求头列表(通常是<code>keep-alive</code>)</li>
</ul>
<p>表示客户端在HTTP事务结束后将会继续保持这个TCP连接，即持久连接。在<code>HTTP/1.1</code>中，默认使用的就是这种持久连接的方式。<code>Connection</code>请求头的值可以是使用<code>,</code>分隔的请求头列表，这些请求头表示将会被第一个非传输性的代理或者缓存服务器给删除掉。这些请求头的定义应用在请求的发送方和第一个实体之间，而不会应用在请求发送方和目标服务器之间。</p>
<h3 id="短连接例子">短连接例子</h3>
<p>下面是使用短连接处理HTTP请求的例子，我们写完响应行后立刻将TCP连接关闭了，此时浏览器是能够正确处理这种请求的。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">handleClosedHttpReq</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">conn</span> <span style="color:#000">net</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Conn</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">buffer</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">([]</span><span style="color:#204a87;font-weight:bold">byte</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1024</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">n</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">conn</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Read</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">buffer</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatalln</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">n</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">string</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">buffer</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">data</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87">byte</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;hello, world!&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">conn</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Write</span><span style="color:#000;font-weight:bold">([]</span><span style="color:#204a87">byte</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;HTTP/1.1 200 OK\r\n&#34;</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">conn</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Write</span><span style="color:#000;font-weight:bold">([]</span><span style="color:#204a87">byte</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;\r\n&#34;</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">conn</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Write</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">conn</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Close</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">ln</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">net</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Listen</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;tcp&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;:8080&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatalln</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">conn</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">ln</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Accept</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">handleClosedHttpReq</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">conn</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><img src="https://passage-1253400711.cos-website.ap-beijing.myqcloud.com/2018-11-01-233404.png" alt="HTTP短连接"></p>
<h3 id="持久连接例子">持久连接例子</h3>
<p>在持久连接模式中，由于服务器不会立刻关闭TCP连接，所以需要在响应中加上一个<code>Content-Length</code>的响应头来表示响应体的长度，让浏览器判断HTTP响应是否结束。如果没有这个响应头的话，浏览器会处于<code>pending</code>的状态。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 没有添加 Content-Length 的响应，浏览器会处于 pending 的状态
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">handleKeepAliveHttpReq</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">conn</span> <span style="color:#000">net</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Conn</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">buffer</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">([]</span><span style="color:#204a87;font-weight:bold">byte</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1024</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">n</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">conn</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Read</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">buffer</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatalln</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">n</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">string</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">buffer</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">data</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87">byte</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;hello, keel-alive!&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">conn</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Write</span><span style="color:#000;font-weight:bold">([]</span><span style="color:#204a87">byte</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;HTTP/1.1 200 OK\r\n&#34;</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">conn</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Write</span><span style="color:#000;font-weight:bold">([]</span><span style="color:#204a87">byte</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;\r\n&#34;</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">conn</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Write</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><img src="https://passage-1253400711.cos-website.ap-beijing.myqcloud.com/2018-11-01-234251.png" alt="持久连接浏览器pending"></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 添加了 Content-Length，浏览器就可以正常处理响应了
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">handleKeepAliveHttpReq</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">conn</span> <span style="color:#000">net</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Conn</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">buffer</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">([]</span><span style="color:#204a87;font-weight:bold">byte</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1024</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">n</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">conn</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Read</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">buffer</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatalln</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">n</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">string</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">buffer</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">data</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87">byte</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;hello, keel-alive!&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">conn</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Write</span><span style="color:#000;font-weight:bold">([]</span><span style="color:#204a87">byte</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;HTTP/1.1 200 OK\r\n&#34;</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">conn</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Write</span><span style="color:#000;font-weight:bold">([]</span><span style="color:#204a87">byte</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Content-Length: %d\r\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">))))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">conn</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Write</span><span style="color:#000;font-weight:bold">([]</span><span style="color:#204a87">byte</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;\r\n&#34;</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">conn</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Write</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><img src="https://passage-1253400711.cos-website.ap-beijing.myqcloud.com/2018-11-01-234547.png" alt="持久连接"></p>
<h2 id="分块传输编码">分块传输编码</h2>
<h3 id="相关概念">相关概念</h3>
<p>在长连接模式中，除了通过<code>Content-Length</code>指定响应体的长度外，还有另外一种传输方式。它就是本文的主角，分块传输编码。</p>
<blockquote>
<p>分块传输编码（Chunked transfer encoding）是超文本传输协议（HTTP）中的一种数据传输机制，允许HTTP由网页服务器发送给客户端应用（ 通常是网页浏览器）的数据可以分成多个部分。分块传输编码只在HTTP协议1.1版本（HTTP/1.1）中提供。</p>
</blockquote>
<p>如果需要使用分块传输编码的响应格式，我们需要在HTTP响应中设置响应头<code>Transfer-Encoding: chunked</code>。它的具体传输格式是这样的(注意HTTP响应中换行符是<code>\r\n</code>):</p>
<pre tabindex="0"><code>HTTP/1.1 200 OK\r\n
\r\n
Transfer-Encoding: chunked\r\n
...\r\n
\r\n
&lt;chunked 1 length&gt;\r\n
&lt;chunked 1 content&gt;\r\n
&lt;chunked 2 length&gt;\r\n
&lt;chunked 2 content&gt;\r\n
...\r\n
0\r\n
\r\n
\r\n
</code></pre><h3 id="分块传输编码例子">分块传输编码例子</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">handleChunkedHttpResp</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">conn</span> <span style="color:#000">net</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Conn</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">buffer</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">([]</span><span style="color:#204a87;font-weight:bold">byte</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1024</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">n</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">conn</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Read</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">buffer</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatalln</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">n</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">string</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">buffer</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">conn</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Write</span><span style="color:#000;font-weight:bold">([]</span><span style="color:#204a87">byte</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;HTTP/1.1 200 OK\r\n&#34;</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">conn</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Write</span><span style="color:#000;font-weight:bold">([]</span><span style="color:#204a87">byte</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Transfer-Encoding: chunked\r\n&#34;</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">conn</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Write</span><span style="color:#000;font-weight:bold">([]</span><span style="color:#204a87">byte</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;\r\n&#34;</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">conn</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Write</span><span style="color:#000;font-weight:bold">([]</span><span style="color:#204a87">byte</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;6\r\n&#34;</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">conn</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Write</span><span style="color:#000;font-weight:bold">([]</span><span style="color:#204a87">byte</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;hello,\r\n&#34;</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">conn</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Write</span><span style="color:#000;font-weight:bold">([]</span><span style="color:#204a87">byte</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;8\r\n&#34;</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">conn</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Write</span><span style="color:#000;font-weight:bold">([]</span><span style="color:#204a87">byte</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;chunked!\r\n&#34;</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">conn</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Write</span><span style="color:#000;font-weight:bold">([]</span><span style="color:#204a87">byte</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;0\r\n&#34;</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">conn</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Write</span><span style="color:#000;font-weight:bold">([]</span><span style="color:#204a87">byte</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;\r\n&#34;</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><img src="https://passage-1253400711.cos-website.ap-beijing.myqcloud.com/2018-11-02-000422.png" alt="HTTP chunked传输"></p>
<p>通过 WireShark 抓包我们可以更清晰地看到响应中有两个 chunked。但由于这两个chunked的内容很少，TCP传输的时候将它们合并了。</p>
<p><img src="https://passage-1253400711.cos-website.ap-beijing.myqcloud.com/2018-11-02-001330.png" alt="HTTP chunked wireshark抓包"></p>
<h2 id="参考链接">参考链接</h2>
<ul>
<li>[https://imququ.com/post/transfer-encoding-header-in-http.html](HTTP 协议中的 Transfer-Encoding)</li>
<li><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Connection">MDN Connection</a></li>
<li><a href="https://zh.wikipedia.org/wiki/%E5%88%86%E5%9D%97%E4%BC%A0%E8%BE%93%E7%BC%96%E7%A0%81">维基百科 - 分块传输编码</a></li>
</ul>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-a84e3fde2477368f92e0571415ecdb25">12.5 - Letsencrypt通过DNS TXT记录来验证域名有效性</h1>
    
	<blockquote>
<p><strong>摘要</strong>:</p>
<ol>
<li>Letsencrypt 通过dns记录来验证域名</li>
</ol>
</blockquote>
<h2 id="前言">前言</h2>
<p>我们在使用<code>letsencrypt</code>获取免费的HTTPS证书的时候，<code>letsencrypt</code>需要对域名进行验证。默认情况下它的验证方式是这样的：</p>
<ol>
<li><code>certbot</code>程序在web目录的根目录下放置一个文件。</li>
<li><code>letsencrypt</code>的服务器通过域名来访问这个文件，来验证你申请的域名是属于你的</li>
</ol>
<p>但有时候我们想为内网的某台主机设置HTTPS，因为内网的主机无法被<code>letsencrypt</code>的服务器访问到，<code>certbot --nginx certonly</code>就会出现<code>Connection refused</code>的错误。</p>
<p>为了解决上述问题，我们可以更改验证方式，使用DNS记录来验证域名。</p>
<h2 id="利用certbot获取证书">利用certbot获取证书</h2>
<p>运行<code>sudo certbot --manual --preferred-challenges dns certonly</code>命令，输入域名并同意记录本机IP后开始获取证书，接着<code>certbot</code>就会弹出如下的提示：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>-------------------------------------------------------------------------------
</span></span><span style="display:flex;"><span>Please deploy a DNS TXT record under the name
</span></span><span style="display:flex;"><span>_acme-challenge.example.com with the following value:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>IMdfdsfsJDqBRyRaaEgPPQlEuvtxJQAgWZTIVbLuzDi8U
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Once this is deployed,
</span></span><span style="display:flex;"><span>-------------------------------------------------------------------------------
</span></span><span style="display:flex;"><span>Press Enter to Continue
</span></span></code></pre></div><p>此时<code>certbot</code>程序就会暂停，等待我们去添加DNS记录。</p>
<h2 id="添加dns的txt记录">添加DNS的TXT记录</h2>
<p>看到上述的提示后，修改域名的DNS记录，添加一条<code>TXT</code>记录，主机名为<code>_acme-challenge</code>，而其中的内容就是<code>letsencrypt</code>生成的随机字符串<code>IMdfdsfsJDqBRyRaaEgPPQlEuvtxJQAgWZTIVbLuzDi8U</code>。</p>
<h2 id="验证成功">验证成功</h2>
<p>添加好DNS记录后，我们可以通过<code>dig -t txt _acme-challenge.example.com</code>来查看域名的内容，域名生效以后，在<code>certbot</code>程序中下按下回车键，程序继续运行。<code>letsencrypt</code>对DNS记录验证成功，证书就申请成功了。</p>
<h2 id="参考文献">参考文献</h2>
<ol>
<li><a href="https://certbot.eff.org/docs/using.html#manual">Certbot User Guide</a></li>
<li><code>certbot -h certonly</code></li>
</ol>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-b21d7a632564e90b6152ef79c335936f">12.6 - CentOS 下编译安装 Nginx</h1>
    
	<p><strong>摘要</strong>:</p>
<blockquote>
<p>主要讲述了编译安装 Nginx</p>
</blockquote>
<h2 id="安装-pcre">安装 pcre</h2>
<p>pcre: 支持正则表达式，地址重写rewrite</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>tar -xvf tar_ball/pcre-8.38.tar.gz
</span></span><span style="display:flex;"><span><span style="color:#204a87">cd</span> pcre-8.38/
</span></span><span style="display:flex;"><span>./configure --prefix<span style="color:#ce5c00;font-weight:bold">=</span>/usr/local/pcre-8.38
</span></span><span style="display:flex;"><span>make <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> make install
</span></span></code></pre></div><h2 id="编译安装-nginx">编译安装 Nginx</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>yum install openssl openssl-devel
</span></span><span style="display:flex;"><span>groupadd www
</span></span><span style="display:flex;"><span>useradd -g www www -s /sbin/nologin
</span></span><span style="display:flex;"><span>tar -xvf tar_ball/nginx-1.9.12.tar.gz
</span></span><span style="display:flex;"><span><span style="color:#204a87">cd</span> nginx-1.9.12/
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 注意转义符号后面不要跟空格</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>root@localhost nginx-1.9.12<span style="color:#ce5c00;font-weight:bold">]</span><span style="color:#8f5902;font-style:italic"># ./configure \</span>
</span></span><span style="display:flex;"><span>&gt; --prefix<span style="color:#ce5c00;font-weight:bold">=</span>/usr/local/nginx-1.9.12 <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>&gt; --user<span style="color:#ce5c00;font-weight:bold">=</span>www <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>&gt; --group<span style="color:#ce5c00;font-weight:bold">=</span>www <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>&gt; --with-http_ssl_module <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>&gt; --with-http_flv_module <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>&gt; --with-http_stub_status_module <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>&gt; --with-http_gzip_static_module <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>&gt; --with-pcre<span style="color:#ce5c00;font-weight:bold">=</span>/root/source/pcre-8.38/  <span style="color:#8f5902;font-style:italic"># 注意要指定pcre源码包位置</span>
</span></span><span style="display:flex;"><span>   
</span></span><span style="display:flex;"><span>make
</span></span><span style="display:flex;"><span>make install
</span></span><span style="display:flex;"><span>   
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 启动并测试</span>
</span></span><span style="display:flex;"><span>/usr/local/nginx-1.9.12/sbin/nginx -t  <span style="color:#8f5902;font-style:italic"># 测试配置文件</span>
</span></span><span style="display:flex;"><span>/usr/local/nginx-1.9.12/sbin/nginx  <span style="color:#8f5902;font-style:italic"># 启动Nginx</span>
</span></span><span style="display:flex;"><span>lsof -i:80  <span style="color:#8f5902;font-style:italic"># 查看80端口占用情况</span>
</span></span><span style="display:flex;"><span>elinks -dump http://localhost  <span style="color:#8f5902;font-style:italic"># 用elinks测试本机</span>
</span></span><span style="display:flex;"><span>   
</span></span><span style="display:flex;"><span>vim /etc/profile
</span></span><span style="display:flex;"><span>  pathmunge /usr/local/nginx-1.9.12/sbin/ after  <span style="color:#8f5902;font-style:italic"># 添加Nginx可执行文件的PATH</span>
</span></span></code></pre></div>
</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-61067b04bc7fd549be32943b40ec4eac">13 - Prometheus</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-22b5afb7c5e4cb0f2b2c329578af5ecd">13.1 - Statsd Exporter 如何跳过 prom 的指标检查</h1>
    
	<hr>
<h2 id="statsd-exporter-中构造一些特殊的指标">statsd exporter 中构造一些特殊的指标</h2>
<p>statsd exporter 是 prometheus 官方提供的，将 statsd 指标转换成 prom 指标的 exporter。</p>
<p>statsd exporter 中，可以创建名字相同但 label 不同的同名指标。例如下面的这种序列，</p>
<pre tabindex="0"><code>qae_app_request_latencies_count{app=&#34;mrpink&#34;,role=&#34;web&#34;,task=&#34;default&#34;} 1
qae_app_request_latencies_count{app=&#34;mrpink&#34;,itf=&#34;count_by_item&#34;,role=&#34;service&#34;,service_type=&#34;thrift&#34;,task=&#34;ThriftSvcInstance&#34;} 1
</code></pre><p>我们用个简单例子来说明一下:</p>
<h3 id="准备-statsd-exporter-的配置文件">准备 statsd exporter 的配置文件</h3>
<ul>
<li>exporter_config.yaml</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">defaults</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># 所有指标使用 glob 匹配的模式</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">match_type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">glob</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">glob_disable_ordering</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">ttl</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">5m</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">#</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">mappings</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">match</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;qae.*.web.*.req_time&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;qae_app_request_latencies&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">match_metric_type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">timer</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">timer_type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">histogram</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">labels</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">app</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;$1&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;web&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">task</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;$2&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># labels 中的 $1, $2 等是从 match 中捕获的匹配组</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">match</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;qae.*.service.*.*.*.req_time&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;qae_app_request_latencies&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">match_metric_type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">timer</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">timer_type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">histogram</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">labels</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">app</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;$1&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;service&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">task</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;$2&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">itf</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;$4&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">service_type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;thrift&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># 其他不符合规范的指标都会被丢弃掉</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">match</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;.&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">match_type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">regex</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">action</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">drop</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;dropped&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h3 id="启动-statsd-exporter">启动 statsd exporter</h3>
<p>在 statsd_exporter 的代码目录下执行 go build 命令，并启动它:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ go build -o /tmp/exporter . <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> /tmp/exporter --statsd.mapping-config<span style="color:#ce5c00;font-weight:bold">=</span>exporter_config.yaml --log.level<span style="color:#ce5c00;font-weight:bold">=</span>debug
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">ts</span><span style="color:#ce5c00;font-weight:bold">=</span>2023-05-31T23:42:11.802Z <span style="color:#000">caller</span><span style="color:#ce5c00;font-weight:bold">=</span>main.go:292 <span style="color:#000">level</span><span style="color:#ce5c00;font-weight:bold">=</span>info <span style="color:#000">msg</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;Starting StatsD -&gt; Prometheus Exporter&#34;</span> <span style="color:#000">version</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;(version=, branch=, revision=f40cab3899c8effd25a5daee6f69e30eea796a96-modified)&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">ts</span><span style="color:#ce5c00;font-weight:bold">=</span>2023-05-31T23:42:11.802Z <span style="color:#000">caller</span><span style="color:#ce5c00;font-weight:bold">=</span>main.go:293 <span style="color:#000">level</span><span style="color:#ce5c00;font-weight:bold">=</span>info <span style="color:#000">msg</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;Build context&#34;</span> <span style="color:#000">context</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;(go=go1.18.8, platform=linux/amd64, user=, date=, tags=unknown)&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">ts</span><span style="color:#ce5c00;font-weight:bold">=</span>2023-05-31T23:42:11.803Z <span style="color:#000">caller</span><span style="color:#ce5c00;font-weight:bold">=</span>main.go:342 <span style="color:#000">level</span><span style="color:#ce5c00;font-weight:bold">=</span>info <span style="color:#000">msg</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;Accepting StatsD Traffic&#34;</span> <span style="color:#000">udp</span><span style="color:#ce5c00;font-weight:bold">=</span>:9125 <span style="color:#000">tcp</span><span style="color:#ce5c00;font-weight:bold">=</span>:9125 <span style="color:#000">unixgram</span><span style="color:#ce5c00;font-weight:bold">=</span>
</span></span><span style="display:flex;"><span><span style="color:#000">ts</span><span style="color:#ce5c00;font-weight:bold">=</span>2023-05-31T23:42:11.803Z <span style="color:#000">caller</span><span style="color:#ce5c00;font-weight:bold">=</span>main.go:343 <span style="color:#000">level</span><span style="color:#ce5c00;font-weight:bold">=</span>info <span style="color:#000">msg</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;Accepting Prometheus Requests&#34;</span> <span style="color:#000">addr</span><span style="color:#ce5c00;font-weight:bold">=</span>:9102
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 可以看到，statsd server 运行在 9125 端口，prom server 运行在 9102 端口</span>
</span></span></code></pre></div><h3 id="使用-statsd-client-向-statsd-exporter-发送指标">使用 statsd client 向 statsd exporter 发送指标</h3>
<ul>
<li>发送指标的代码</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;github.com/cactus/go-statsd-client/v5/statsd&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">sendMetrics</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">client</span> <span style="color:#000">statsd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Statter</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">client</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">TimingDuration</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;web.default.req_time&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Millisecond</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#0000cf;font-weight:bold">500</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatalln</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">client</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">TimingDuration</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;service.ThriftSvcInstance.ThriftSvcInstance.count_by_item.req_time&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Millisecond</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#0000cf;font-weight:bold">300</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatalln</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">config</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">statsd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ClientConfig</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Address</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;127.0.0.1:9125&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Prefix</span><span style="color:#000;font-weight:bold">:</span>  <span style="color:#4e9a06">&#34;qae.mrpink&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">client</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">statsd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewClientWithConfig</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">client</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Close</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">sendMetrics</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">client</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>执行上述代码，就会向 statsd exporter 发送两个 timer 指标</p>
<pre tabindex="0"><code>qae.mrpink.web.default.req_time:500|ms
qae.mrpink.service.ThriftSvcInstance.ThriftSvcInstance.count_by_item.req_time:300|ms
</code></pre><h3 id="检查-statsd-exporter-的-prom-指标">检查 statsd exporter 的 prom 指标</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ curl -s localhost:9102/metrics <span style="color:#000;font-weight:bold">|</span> rg qae_app_request_latencies_count
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>qae_app_request_latencies_count<span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#000">app</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;mrpink&#34;</span>,role<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;web&#34;</span>,task<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;default&#34;</span><span style="color:#ce5c00;font-weight:bold">}</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>qae_app_request_latencies_count<span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#000">app</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;mrpink&#34;</span>,itf<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;count_by_item&#34;</span>,role<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;service&#34;</span>,service_type<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;thrift&#34;</span>,task<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;ThriftSvcInstance&#34;</span><span style="color:#ce5c00;font-weight:bold">}</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span></code></pre></div><p>可以看到，statsd exporter 中存储了两个同名的指标序列 <code>qae_app_request_latencies_count</code>, 但是他们的 label 却不同。</p>
<h2 id="使用-prometheus-client_golang-构造同样的指标就会报错">使用 prometheus client_golang 构造同样的指标就会报错</h2>
<p>如果我们想要使用 prometheus 提供的的官方客户端 <a href="https://github.com/prometheus/client_golang/">client_golang</a>, 发送同样的指标，就会遇到错误</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;github.com/prometheus/client_golang/prometheus&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;github.com/prometheus/client_golang/prometheus/promauto&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;github.com/prometheus/client_golang/prometheus/promhttp&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;net/http&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">AppRequestLatencies</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">promauto</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewHistogramVec</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">prometheus</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HistogramOpts</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Name</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;qae_app_request_latencies&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Help</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;web request count and req time latency&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">},</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">{</span><span style="color:#4e9a06">&#34;app&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;role&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;task&#34;</span><span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ThriftAppRequestLatencies</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">promauto</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewHistogramVec</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">prometheus</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HistogramOpts</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Name</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;qae_app_request_latencies&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Help</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;service request count and req time latency&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">},</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">{</span><span style="color:#4e9a06">&#34;app&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;role&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;task&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;itf&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;service_type&#34;</span><span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">SendMetrics</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">dur1</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Duration</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">300</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Millisecond</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">AppRequestLatencies</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">With</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#4e9a06">&#34;app&#34;</span><span style="color:#000;font-weight:bold">:</span>  <span style="color:#4e9a06">&#34;mrpink&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#4e9a06">&#34;role&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;web&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#4e9a06">&#34;task&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;default&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}).</span><span style="color:#000">Observe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dur1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Seconds</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">dur2</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Duration</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">500</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Millisecond</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ThriftAppRequestLatencies</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">With</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#4e9a06">&#34;app&#34;</span><span style="color:#000;font-weight:bold">:</span>          <span style="color:#4e9a06">&#34;mrpink&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#4e9a06">&#34;role&#34;</span><span style="color:#000;font-weight:bold">:</span>         <span style="color:#4e9a06">&#34;service&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#4e9a06">&#34;task&#34;</span><span style="color:#000;font-weight:bold">:</span>         <span style="color:#4e9a06">&#34;ThriftSvcInstance&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#4e9a06">&#34;service_type&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;thrift&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#4e9a06">&#34;itf&#34;</span><span style="color:#000;font-weight:bold">:</span>          <span style="color:#4e9a06">&#34;count_by_item&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}).</span><span style="color:#000">Observe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dur2</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Seconds</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Send metrics done&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">addr</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#4e9a06">&#34;0.0.0.0:8090&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">promMux</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewServeMux</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">promMux</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Handle</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/metrics&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">promhttp</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Handler</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sleep</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Second</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">SendMetrics</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListenAndServe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">addr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">promMux</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Start prom server on %v\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">addr</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatalf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Starting the http server %v failed: %v\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">addr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>执行以上代码，会抛出 panic 异常</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ go run prom_client/main.go
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>panic: a previously registered descriptor with the same fully-qualified name as Desc<span style="color:#ce5c00;font-weight:bold">{</span>fqName: <span style="color:#4e9a06">&#34;qae_app_request_latencies&#34;</span>, help: <span style="color:#4e9a06">&#34;service request count and req time latency&#34;</span>, constLabels: <span style="color:#ce5c00;font-weight:bold">{}</span>, variableLabels: <span style="color:#ce5c00;font-weight:bold">[{</span>app &lt;nil&gt;<span style="color:#ce5c00;font-weight:bold">}</span> <span style="color:#ce5c00;font-weight:bold">{</span>role &lt;nil&gt;<span style="color:#ce5c00;font-weight:bold">}</span> <span style="color:#ce5c00;font-weight:bold">{</span>task &lt;nil&gt;<span style="color:#ce5c00;font-weight:bold">}</span> <span style="color:#ce5c00;font-weight:bold">{</span>itf &lt;nil&gt;<span style="color:#ce5c00;font-weight:bold">}</span> <span style="color:#ce5c00;font-weight:bold">{</span>service_type &lt;nil&gt;<span style="color:#ce5c00;font-weight:bold">}]}</span> has different label names or a different <span style="color:#204a87">help</span> string
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>goroutine <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">[</span>running<span style="color:#ce5c00;font-weight:bold">]</span>:
</span></span><span style="display:flex;"><span>github.com/prometheus/client_golang/prometheus.<span style="color:#ce5c00;font-weight:bold">(</span>*Registry<span style="color:#ce5c00;font-weight:bold">)</span>.MustRegister<span style="color:#ce5c00;font-weight:bold">(</span>0x0?, <span style="color:#ce5c00;font-weight:bold">{</span>0xc000118010?, 0x1, 0x0?<span style="color:#ce5c00;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>        /home/xuyundong/.gvm/pkgsets/go1.18.8/global/pkg/mod/github.com/prometheus/client_golang@v1.15.1/prometheus/registry.go:405 +0x7f
</span></span><span style="display:flex;"><span>github.com/prometheus/client_golang/prometheus/promauto.Factory.NewHistogramVec<span style="color:#ce5c00;font-weight:bold">({{</span>0x922410?, 0xc0000a2960?<span style="color:#ce5c00;font-weight:bold">}}</span>, <span style="color:#ce5c00;font-weight:bold">{{</span>0x0, 0x0<span style="color:#ce5c00;font-weight:bold">}</span>, <span style="color:#ce5c00;font-weight:bold">{</span>0x0, 0x0<span style="color:#ce5c00;font-weight:bold">}</span>, <span style="color:#ce5c00;font-weight:bold">{</span>0x87e012, 0x19<span style="color:#ce5c00;font-weight:bold">}</span>, <span style="color:#ce5c00;font-weight:bold">{</span>0x88794e, 0x2a<span style="color:#ce5c00;font-weight:bold">}</span>, ...<span style="color:#ce5c00;font-weight:bold">}</span>, ...<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        /home/xuyundong/.gvm/pkgsets/go1.18.8/global/pkg/mod/github.com/prometheus/client_golang@v1.15.1/prometheus/promauto/auto.go:362 +0x1cc
</span></span><span style="display:flex;"><span>github.com/prometheus/client_golang/prometheus/promauto.NewHistogramVec<span style="color:#ce5c00;font-weight:bold">(</span>...<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        /home/xuyundong/.gvm/pkgsets/go1.18.8/global/pkg/mod/github.com/prometheus/client_golang@v1.15.1/prometheus/promauto/auto.go:235
</span></span><span style="display:flex;"><span>main.init<span style="color:#ce5c00;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>        /home/xuyundong/Github/Golang/statsd_client/prom_client/main.go:17 +0x269
</span></span><span style="display:flex;"><span><span style="color:#204a87">exit</span> status <span style="color:#0000cf;font-weight:bold">2</span>
</span></span></code></pre></div><h2 id="prometheus-client_golang-的检查逻辑">Prometheus client_golang 的检查逻辑</h2>
<p>于是我有些好奇，statsd exporter 是如何做到，可以发送同名不同 label 的指标的。
简单的阅读了 client_golang 和 statsd_exporter 的指标之后，我找到了答案。</p>
<p>我阅读的代码的版本是</p>
<ul>
<li><a href="https://github.com/prometheus/client_golang/tree/release-1.15">client_golang - release-1.15</a></li>
<li><a href="https://github.com/prometheus/statsd_exporter/tree/v0.23.1">statsd_exporter - 0.23.1</a></li>
</ul>
<p>client_golang 中定义了两个接口</p>
<ul>
<li><a href="https://github.com/prometheus/client_golang/blob/release-1.15/prometheus/collector.go#L27">prometheus.Collector</a></li>
<li><a href="https://github.com/prometheus/client_golang/blob/release-1.15/prometheus/registry.go#L96">prometheus.Registerer</a></li>
</ul>
<p>client_golang 中每种指标都实现了 <code>prometheus.Collector</code>, 所有的指标会注册到一个实现了 <code>prometheus.Registerer</code> 接口的实例中，再由此实例收集并输出指标。</p>
<p>我们在代码中定义指标的代码是:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">opts</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">prometheus</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HistogramOpts</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">Name</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;qae_app_request_latencies&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">Help</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;web request count and req time latency&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000">labels</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">{</span><span style="color:#4e9a06">&#34;app&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;role&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;task&#34;</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000">AppRequestLatencies</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">promauto</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewHistogramVec</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">opts</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">labels</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>client_golang 实际执行的代码如下, 它会注册一个 Histogram 指标，并将其注册到 <code>DefaultRegisterer</code> 中。<code>DefaultRegisterer</code> 就是一个实现了 <code>prometheus.Registerer</code> 接口的实例。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">h</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">prometheus</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewHistogramVec</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">opts</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">labelNames</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">prometheus</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DefaultRegisterer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MustRegister</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">h</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// MustRegister 底层调用了 Register 方法，在 Register 返回 err 时会 panic
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// prometheus.DefaultRegisterer.Register(h)
</span></span></span></code></pre></div><p><code>prometheus.Collector</code> 接口有一个 <code>Describe</code> 方法，它用于获取指标的信息。具体做法是传入一个 channel 参数，指标将 Desc 信息写入到 channel 中。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Collector</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a40000">#</span> <span style="color:#000">Desc</span> <span style="color:#a40000">包含指标名</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">label</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">help</span> <span style="color:#a40000">等信息</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">Describe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">chan</span><span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Desc</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">...</span><span style="color:#000;font-weight:bold">.</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>接着我们来看一下 <code>DefaultRegisterer</code> 的 <a href="https://github.com/prometheus/client_golang/blob/release-1.15/prometheus/registry.go#L270">Register</a> 函数的实现，</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 以下代码中我省略了一些无关的内容
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">r</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Registry</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Register</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#000">Collector</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// c 是 Collector 对象
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">descChan</span>           <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Desc</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">capDescChan</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Describe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">descChan</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">descChan</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">mtx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Lock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// 为了防止 goroutine 泄漏，descChan 必须被消费完
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">descChan</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">mtx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Unlock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">...</span><span style="color:#000;font-weight:bold">.</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">desc</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">descChan</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// desc.id 是根据指标名和固定 label 名算出来的 hash,
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// 如果注册的两个指标 name 和固定 label 名完全相同，则返回错误 duplicateDescErr
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">exists</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">descIDs</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">desc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">];</span> <span style="color:#000">exists</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">duplicateDescErr</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;descriptor %s already exists with the same fully-qualified name and const label values&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">desc</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// fqName 是指标名
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// dimHash 是 根据指标 label 名 + help 算出来的 hash
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// 如果注册了两个同名的指标，但是它们的 label 或者 help 信息不同的话，则会返回错误
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">dimHash</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">exists</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">dimHashesByName</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">desc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">fqName</span><span style="color:#000;font-weight:bold">];</span> <span style="color:#000">exists</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">dimHash</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">desc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">dimHash</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;a previously registered descriptor with the same fully-qualified name as %s has different label names or a different help string&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">desc</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>从以上代码可以看出，<code>Register</code> 中会通过 <code>Describe</code> 方法拿到指标的信息，并进行若干检查。如果两个同名指标的 label 名不同，则会返回错误 <code>a previously registered descriptor with the same fully-qualified name as Desc... has different label names or a different help string</code>。</p>
<h2 id="statsd-exporter-中跳过检查的方法">statsd exporter 中跳过检查的方法</h2>
<p>那么 statsd exporter 是如何跳过上述检查的呢，很简单，让 <code>Describe</code> 返回空就好。statsd exporter 中的每个指标都用 <a href="https://github.com/prometheus/statsd_exporter/blob/v0.23.1/pkg/registry/registry.go#L33-L42">uncheckedCollector</a> 包裹了一下。</p>
<p><code>uncheckedCollector</code> 的定义如下</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">uncheckedCollector</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">c</span> <span style="color:#000">prometheus</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Collector</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">u</span> <span style="color:#000">uncheckedCollector</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Describe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">_</span> <span style="color:#204a87;font-weight:bold">chan</span><span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">prometheus</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Desc</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">u</span> <span style="color:#000">uncheckedCollector</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Collect</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#204a87;font-weight:bold">chan</span><span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">prometheus</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Metric</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">u</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Collect</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>它的 <code>Describe</code> 方法什么也不返回，那么 <code>Register</code> 中的检查也会被跳过了。</p>
<p>这样最终实现了注册同名不同 label 指标的目的。</p>
</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-e5a0a7efb242ec26125e2066bad47362">14 - 编码</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-573e3337b8ecb996b3dee636fc080527">14.1 - ZigZag 变长整数编码</h1>
    
	<blockquote>
<p>变长整数编码的实现</p>
</blockquote>
<hr>
<h2 id="介绍">介绍</h2>
<p>Variants + Zigzag 是在 protobuf, thrift, kafka 中使用的一种数字编码方式，它将整数序列化成字节，整数的绝对值越小，其占用的字节数越少。</p>
<h2 id="variants-变长整数编码">Variants 变长整数编码</h2>
<p>Variants 是使用一个或多个字节来序列化整数的一种方法，数值对应的无符号数越小，其占用的字节数越少。</p>
<p>在 Variants 编码中，</p>
<ol>
<li>每个字节的最高位保留，成为 msb 位(most significant bit)，它用于表示其后的字节是否和当前字节一起来表示一个整数。</li>
<li>Variants 使用小端字节序的布局方式，整数的低位放在字节流的高位。</li>
</ol>
<p>例如整数 300，它的二进制形式是</p>
<pre tabindex="0"><code>[0000 0001] [0010 1100]
</code></pre><p>其中有效的数据只有前 9 位，即</p>
<pre tabindex="0"><code>[1] [0010 1100]
</code></pre><p>加上 msb 位，因为字节序后续还需要反转字节流，我们将 msb 位先记成 X</p>
<ul>
<li><strong>注意:</strong> 第一个字节只有前两位有效的，其他数据位我们都补0</li>
</ul>
<pre tabindex="0"><code>[X000 0010] [X010 1100]
</code></pre><p>将其按照小端字节序排列，得到</p>
<pre tabindex="0"><code>[X010 1100] [X000 0010]
</code></pre><p>再根据当前字节是否是最后一个，填充上 msb 位，得到 300 的 Variants 编码是</p>
<pre tabindex="0"><code>[1010 1100] [0000 0010]
</code></pre><h2 id="variants-编码负数遇到的问题">Variants 编码负数遇到的问题</h2>
<p>使用 Variants 对负数进行编码的时候，由于负数使用补码进行编码，越小的负数其对应的无符号数越大，Variants 编码后的字节数越多。</p>
<p>例如对于一个 64 位整数，-1 的补码用八个字节表示 <code>[1111 1111] [1111 1111] [1111 1111] [1111 1111] [1111 1111] [1111 1111] [1111 1111] [1111 1111]</code>，它经过 Variants 编码后的长度是10个字节。</p>
<p>由于小负数是很常见的数字，这样就容易造成浪费。</p>
<p>为了让编码更加高效，Variants 引入了 ZigZag 的编码方式。</p>
<h2 id="zigzag-编码">ZigZag 编码</h2>
<p>ZigZag 编码以一种锯齿形(zig-zags，或者也可以叫之字型)的方式来回穿梭正负整数，将带符号的整数映射为无符号证书，这样可以使绝对值较小的负数仍然享有较小的 Variants 编码值。</p>
<p>下表是部分数字的 ZigZag 编码结果，看了这个表格后，你应该明白它的名字为什么要叫 ZigZag 了吧 :)</p>
<table>
<thead>
<tr>
<th>原值</th>
<th>编码后的值</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>0</td>
</tr>
<tr>
<td>-1</td>
<td>1</td>
</tr>
<tr>
<td>1</td>
<td>2</td>
</tr>
<tr>
<td>-2</td>
<td>3</td>
</tr>
<tr>
<td>2</td>
<td>4</td>
</tr>
<tr>
<td>-3</td>
<td>5</td>
</tr>
<tr>
<td>3</td>
<td>6</td>
</tr>
<tr>
<td>-4</td>
<td>7</td>
</tr>
<tr>
<td>4</td>
<td>8</td>
</tr>
<tr>
<td>-5</td>
<td>9</td>
</tr>
<tr>
<td>5</td>
<td>10</td>
</tr>
<tr>
<td>-6</td>
<td>11</td>
</tr>
<tr>
<td>6</td>
<td>12</td>
</tr>
<tr>
<td>-7</td>
<td>13</td>
</tr>
<tr>
<td>7</td>
<td>14</td>
</tr>
<tr>
<td>-8</td>
<td>15</td>
</tr>
<tr>
<td>8</td>
<td>16</td>
</tr>
<tr>
<td>-9</td>
<td>17</td>
</tr>
<tr>
<td>9</td>
<td>18</td>
</tr>
<tr>
<td>-10</td>
<td>19</td>
</tr>
<tr>
<td>10</td>
<td>20</td>
</tr>
<tr>
<td>2147483647</td>
<td>4294967294</td>
</tr>
<tr>
<td>-2147483648</td>
<td>4294967295</td>
</tr>
</tbody>
</table>
<h2 id="zigzag-的实现方式">ZigZag 的实现方式</h2>
<p>编码方式: <code>(n &lt;&lt; 1) ^ (n &gt;&gt; (size(n) - 1))</code></p>
<p>解码方式: <code>(value &gt;&gt;&gt; 1) ^ -(value &amp; 1)</code></p>
<ul>
<li><code>size(n)</code> 表示的是整数 n 的位数</li>
<li><code>value &gt;&gt;&gt; 1</code> 表示将数字 value 无符号右移一位，最高位补0</li>
</ul>
<h2 id="实现代码">实现代码</h2>
<p>下面是对 32 位整数进行编码的代码</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">org.example.zigzag</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">java.nio.ByteBuffer</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">java.nio.charset.StandardCharsets</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">App</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">final</span> <span style="color:#204a87;font-weight:bold">byte</span><span style="color:#ce5c00;font-weight:bold">[]</span> <span style="color:#000">HEX_ARRAY</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;0123456789ABCDEF&#34;</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">getBytes</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">StandardCharsets</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">UTF_8</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">main</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">String</span><span style="color:#ce5c00;font-weight:bold">[]</span> <span style="color:#000">args</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">ByteBuffer</span> <span style="color:#000">buffer</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ByteBuffer</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">allocate</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">App</span> <span style="color:#000">a</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">App</span><span style="color:#ce5c00;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">a</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">writeVariant</span><span style="color:#ce5c00;font-weight:bold">(-</span><span style="color:#0000cf;font-weight:bold">23</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">buffer</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">System</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">out</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">println</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;variant bytes is `&#34;</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">bytesToHex</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">buffer</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">array</span><span style="color:#ce5c00;font-weight:bold">())</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#4e9a06">&#34;`&#34;</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">b</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">a</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">readVariant</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">buffer</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">System</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">out</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">println</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;decode value is &#34;</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">b</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">readVariant</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">ByteBuffer</span> <span style="color:#000">buffer</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">throws</span> <span style="color:#000">RuntimeException</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">b</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// 此处重置 bytebuffer 的 pos，否则不会从第0个开始读起
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">buffer</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">rewind</span><span style="color:#ce5c00;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// 从字节流中取出一个字节，如果第8位是0的话，表示读取整数结束
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">while</span> <span style="color:#ce5c00;font-weight:bold">(((</span><span style="color:#000">b</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">buffer</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">get</span><span style="color:#ce5c00;font-weight:bold">())</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#0000cf;font-weight:bold">0x80</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#8f5902;font-style:italic">// 取出低7位，并左移 7 位放到 value 中
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>            <span style="color:#000">b</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">b</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#0000cf;font-weight:bold">0x7f</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">System</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">out</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">println</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">b</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">|=</span> <span style="color:#000">b</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#0000cf;font-weight:bold">7</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#8f5902;font-style:italic">// 32 位整数最大编码结果是5个字节，在循环中最多只能读4次
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>            <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#0000cf;font-weight:bold">28</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">RuntimeException</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;illegal bytes&#34;</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// 最后一次在循环外读取，且由于最后一位最高位是0,也不需要进行去除最高位的操作
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">|=</span> <span style="color:#000">b</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;&gt;</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">^</span> <span style="color:#ce5c00;font-weight:bold">-(</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">writeVariant</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">value</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">ByteBuffer</span> <span style="color:#000">buffer</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// 将整数 value 进行 zigzag 编码, int 是 32 位，所以这里直接写死了 31
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">v</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">^</span> <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#0000cf;font-weight:bold">31</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// 判断 v 的低7位是否是0
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">while</span> <span style="color:#ce5c00;font-weight:bold">((</span><span style="color:#000">v</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#0000cf;font-weight:bold">0xffffff80</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000">L</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#8f5902;font-style:italic">// 取出 v 的低7位，并在最高位上加上1
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>            <span style="color:#204a87;font-weight:bold">byte</span> <span style="color:#000">b</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">byte</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">((</span><span style="color:#000">v</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#0000cf;font-weight:bold">0x7f</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#0000cf;font-weight:bold">0x80</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#8f5902;font-style:italic">// 放到 buffer 中
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>            <span style="color:#8f5902;font-style:italic">// 因为是先放整数的低字节位，所以这里实现了小端字节序
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>            <span style="color:#000">buffer</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">put</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">b</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#8f5902;font-style:italic">// 将 v 无符号右移 7 位，最高位补 0
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>            <span style="color:#000">v</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;&gt;=</span> <span style="color:#0000cf;font-weight:bold">7</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// 最后取出的 7 位最高位一定是0,且它位于 variant 编码的最后一个字节，需要设置成0
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">buffer</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">put</span><span style="color:#ce5c00;font-weight:bold">((</span><span style="color:#204a87;font-weight:bold">byte</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#000">v</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">static</span> <span style="color:#000">String</span> <span style="color:#000">bytesToHex</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">byte</span><span style="color:#ce5c00;font-weight:bold">[]</span> <span style="color:#000">bytes</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">byte</span><span style="color:#ce5c00;font-weight:bold">[]</span> <span style="color:#000">hexChars</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#204a87;font-weight:bold">byte</span><span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#000">bytes</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">length</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#ce5c00;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#ce5c00;font-weight:bold">;</span> <span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">bytes</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">length</span><span style="color:#ce5c00;font-weight:bold">;</span> <span style="color:#000">j</span><span style="color:#ce5c00;font-weight:bold">++)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">v</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bytes</span><span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#000">j</span><span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#0000cf;font-weight:bold">0xFF</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">hexChars</span><span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">HEX_ARRAY</span><span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#000">v</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;&gt;</span> <span style="color:#0000cf;font-weight:bold">4</span><span style="color:#ce5c00;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">hexChars</span><span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">3</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">HEX_ARRAY</span><span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#000">v</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#0000cf;font-weight:bold">0x0F</span><span style="color:#ce5c00;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">hexChars</span><span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">3</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#39; &#39;</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">String</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">hexChars</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">StandardCharsets</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">UTF_8</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><ul>
<li>Output</li>
</ul>
<pre tabindex="0"><code>variant bytes is `2D 00 00 00 00 00 00 00 00 00 `
decode value is -23
</code></pre>
</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-0d3382c151725c975fa7e12e83c234f9">15 - WireShark</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-228f2acd9c0ff088f1229559fcdd6503">15.1 - 利用 VirtualBox 和 Ubuntu 22 重现抓包实验</h1>
    
	<h2 id="实验介绍">实验介绍</h2>
<p>在 <a href="https://book.douban.com/subject/26268767/">《Wireshark网络分析就这么简单》</a> 第一章，讲述了一道面试题。</p>
<p>HostA 和 HostB 在同一个局域网中，它们的 IP 配置如下，请问这两台机器能否 ping 通?</p>
<pre tabindex="0"><code>HostA: 
    IP: 192.168.26.129/24
    Gateway: 192.168.26.2
HostB: 
    IP: 192.168.26.3/27
    Gateway: 192.168.26.2
</code></pre><p>答案是能够 ping 通，HostA 和 HostB 连同网关最终会形成一个奇怪的网络</p>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2023-08-23-103426.png" alt=""></p>
<p>具体通信过程如下:</p>
<ul>
<li>HostA(<code>192.168.26.129</code>) 发送 ping 请求给 HostB(<code>192.168.26.3</code>)
<ul>
<li>HostA 将 HostB 的 IP 和自己的掩码计算，发现 <code>192.168.26.3</code> 和自己是处于同一子网</li>
<li>HostA 通过 ARP 协议广播寻找 <code>192.168.26.3</code> 的 MAC 地址，由于 <code>192.168.26.3</code> 和它在同一局域网中，<code>192.168.26.3</code> 会应答自己的 MAC 地址</li>
<li>HostA 将 ping 请求直接发送给 <code>192.168.26.3</code>, 目的 MAC 地址使用的就是 <code>192.168.26.3</code> 的地址</li>
</ul>
</li>
<li>HostB(<code>192.168.26.3</code>) 收到 ping 请求，给 HostA 发送 ping 响应
<ul>
<li>HostB 将 HostA 的 IP 和自己的掩码计算，发现 <code>192.168.26.129</code> 和自己不是同一子网
<ul>
<li>192.168.26.3 &amp; 255.255.255.224 == 192.168.26.0</li>
<li>192.168.26.129 &amp; 255.255.255.224 == 192.168.26.128</li>
</ul>
</li>
<li>HostB 将 ping 响应发送给网关，由网关进行路由发送
<ul>
<li>HostB 通过 APR 协议广播寻找网关 <code>192.168.26.2</code> 的 MAC 地址，网关 <code>192.168.26.2</code> 告诉 HostB 自己的 MAC</li>
<li>HostB 发送 ping 响应包，目的 IP 是 <code>192.168.26.129</code>, 目的 MAC 是网关的 MAC 地址</li>
</ul>
</li>
<li>网关将 ping 响应发送给了 HostA</li>
</ul>
</li>
</ul>
<h2 id="开始实验">开始实验</h2>
<p>读完以后，感觉这个测试挺好玩，就尝试在本地复现了一下。</p>
<p>我的环境如下，3台安装了 Ubuntu 22.04 Vitualbox 虚拟机, 它们分别充当 HostA, HostB 和 网关</p>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2023-08-23-224057.png" alt=""></p>
<h3 id="配置-vagrant">配置 Vagrant</h3>
<p>我的 VirtualBox 是通过 Vagrant 启动的</p>
<ul>
<li>首先我们需要在 Vagrant 官网上下载 Ubuntu 22.04 的 Box</li>
</ul>
<p><a href="https://app.vagrantup.com/ubuntu/boxes/jammy64">ubuntu/jammy64 Vagrant box 下载地址</a></p>
<p>下载完成之后通过如下命令添加 Vagrant Box</p>
<pre tabindex="0"><code>vagrant box add ~/Downloads/jammy-server-cloudimg-amd64-vagrant.box --name ubuntu/jammy
</code></pre><p>添加完成后使用 <code>vagrant box list</code> 可以看到我们添加的 box 名字了</p>
<ul>
<li>接着我们再来安装 <code>vagrant-disksize</code> 插件</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 建议在执行命令前挂上 http 代理</span>
</span></span><span style="display:flex;"><span>vagrant plugin install vagrant-disksize
</span></span></code></pre></div><h3 id="启动并配置-vbox">启动并配置 VBox</h3>
<p>这是我的 Vagrantfile, 它启动了三个 virtualbox 虚拟机，分别命名为 vbox1, vbox2, vbox3。完整代码见 <a href="https://github.com/bwangelme/DockerVbox.git">github/bwangelme/DockerVbox.git</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># -*- mode: ruby -*-</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># vi: set ft=ruby :</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Verify whether required plugins are installed.</span>
</span></span><span style="display:flex;"><span><span style="color:#000">required_plugins</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">[</span> <span style="color:#4e9a06">&#34;vagrant-disksize&#34;</span> <span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#000">required_plugins</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">each</span> <span style="color:#204a87;font-weight:bold">do</span> <span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#000">plugin</span><span style="color:#ce5c00;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87;font-weight:bold">not</span> <span style="color:#000">Vagrant</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">has_plugin?</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">plugin</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">raise</span> <span style="color:#4e9a06">&#34;The vagrant plugin </span><span style="color:#4e9a06">#{</span><span style="color:#000">plugin</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06"> is required. Please run `vagrant plugin install </span><span style="color:#4e9a06">#{</span><span style="color:#000">plugin</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">`&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">end</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">Vagrant</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">configure</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;2&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">do</span> <span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#000">config</span><span style="color:#ce5c00;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">config</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">vm</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">box_check_update</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">$num_instances</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">3</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">..</span><span style="color:#000">$num_instances</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">each</span> <span style="color:#204a87;font-weight:bold">do</span> <span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">config</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">vm</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">define</span> <span style="color:#4e9a06">&#34;vbox</span><span style="color:#4e9a06">#{</span><span style="color:#000">i</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">&#34;</span> <span style="color:#204a87;font-weight:bold">do</span> <span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#000">node</span><span style="color:#ce5c00;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">node</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">vm</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">box</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;ubuntu/jammy&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">node</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">vm</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">hostname</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;vbox</span><span style="color:#4e9a06">#{</span><span style="color:#000">i</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">node</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">vm</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">provider</span> <span style="color:#4e9a06">&#34;virtualbox&#34;</span> <span style="color:#204a87;font-weight:bold">do</span> <span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#000">vb</span><span style="color:#ce5c00;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">vb</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">memory</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;1024&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">vb</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">cpus</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">vb</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">name</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;vbox</span><span style="color:#4e9a06">#{</span><span style="color:#000">i</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">end</span>
</span></span><span style="display:flex;"><span>      <span style="color:#8f5902;font-style:italic"># 单独执行 vagrant provision 也会执行一遍 install.sh 脚本</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">node</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">vm</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">provision</span> <span style="color:#4e9a06">&#34;shell&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">path</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;install.sh&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">end</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">end</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">end</span>
</span></span></code></pre></div><p>将 <a href="https://github.com/bwangelme/DockerVbox.git">github/bwangelme/DockerVbox.git</a> 克隆到本地，进入目录中执行</p>
<pre tabindex="0"><code>vagrant up
</code></pre><p>就可以创建并启动三个 Ubuntu 22.04 的 VirtualBox 虚机了</p>
<p>启动完成后，我们执行</p>
<pre tabindex="0"><code>vagrant halt
</code></pre><p>将虚拟机先停止，接着我们来手动设置网络。</p>
<h3 id="设置-vbox-网络">设置 VBox 网络</h3>
<ul>
<li>第一步，打开 VirtualBox 的 <strong>管理 -&gt; 全局设定</strong> ，打开网络 Tab, 添加一个 Nat 网络，设置名字为 <code>NatNetwork</code>，设置网段为 <code>192.168.26.0/24</code></li>
</ul>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2023-08-23-225440.png" alt=""></p>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2023-08-23-225556.png" alt=""></p>
<ul>
<li>第二步，分别在每个虚拟机上执行，在 <strong>虚拟机设置 -&gt; 网络</strong> 中添加网卡，<strong>连接方式</strong> 选 <code>Nat网络</code>, <strong>界面名称</strong> 选择我们刚刚创建的 <code>NatNetwork</code></li>
</ul>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2023-08-23-225755.png" alt=""></p>
<ul>
<li>第三步，手动启动三个虚拟机。</li>
</ul>
<p><strong>注意:</strong> 不能使用 <code>vagrant up</code> 启动, 否则我们创建的网卡就被关闭了</p>
<h3 id="手动设置机器的-ip">手动设置机器的 IP</h3>
<p>虚拟机启动后，使用如下命令可以登陆到对应的虚机上</p>
<pre tabindex="0"><code>vagrant ssh vbox1
</code></pre><p>接着我们修改 <code>/etc/netplan/50-cloud-init.yaml</code> 文件，加入我们 Nat 网卡 <code>enp0s8</code> 的配置</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-diff" data-lang="diff"><span style="display:flex;"><span> vagrant@vbox1:~$ cat /etc/netplan/50-cloud-init.yaml
</span></span><span style="display:flex;"><span> # This file is generated from information provided by the datasource.  Changes
</span></span><span style="display:flex;"><span> # to it will not persist across an instance reboot.  To disable cloud-init&#39;s
</span></span><span style="display:flex;"><span> # network configuration capabilities, write a file
</span></span><span style="display:flex;"><span> # /etc/cloud/cloud.cfg.d/99-disable-network-config.cfg with the following:
</span></span><span style="display:flex;"><span> # network: {config: disabled}
</span></span><span style="display:flex;"><span> network:
</span></span><span style="display:flex;"><span>     ethernets:
</span></span><span style="display:flex;"><span>         enp0s3:
</span></span><span style="display:flex;"><span>             dhcp4: true
</span></span><span style="display:flex;"><span>             match:
</span></span><span style="display:flex;"><span>                 macaddress: 02:20:c0:fe:1f:a9
</span></span><span style="display:flex;"><span>             set-name: enp0s3
</span></span><span style="display:flex;"><span><span style="color:#00a000">+        enp0s8:
</span></span></span><span style="display:flex;"><span><span style="color:#00a000">+            dhcp4: no
</span></span></span><span style="display:flex;"><span><span style="color:#00a000">+            addresses:
</span></span></span><span style="display:flex;"><span><span style="color:#00a000">+                - 192.168.26.129/24
</span></span></span><span style="display:flex;"><span><span style="color:#00a000">+            gateway4: 192.168.26.2
</span></span></span><span style="display:flex;"><span><span style="color:#00a000">+            nameservers:
</span></span></span><span style="display:flex;"><span><span style="color:#00a000">+                addresses: [223.5.5.5]
</span></span></span><span style="display:flex;"><span><span style="color:#00a000"></span>     version: 2
</span></span></code></pre></div><p>三台主机的配置如下</p>
<table>
<thead>
<tr>
<th>Hostname</th>
<th>网卡名称</th>
<th>IP/掩码</th>
<th>MAC 地址</th>
<th>网关</th>
</tr>
</thead>
<tbody>
<tr>
<td>vbox1</td>
<td>enp0s8</td>
<td>192.168.26.129/24</td>
<td>08:00:27:4c:f0:52</td>
<td>192.168.26.2</td>
</tr>
<tr>
<td>vbox2</td>
<td>enp0s8</td>
<td>192.168.26.3/27</td>
<td>08:00:27:69:22:ae</td>
<td>192.168.26.2</td>
</tr>
<tr>
<td>vbox3</td>
<td>enp0s8</td>
<td>192.168.26.2/24</td>
<td>08:00:27:d5:b5:13</td>
<td>192.168.26.1</td>
</tr>
</tbody>
</table>
<p>修改完配置文件后，使用以下命令将配置生效</p>
<pre tabindex="0"><code>sudo netplan apply
</code></pre><p>至此，所有的网络环境都配置成功了，我们可以开始抓包了。</p>
<h2 id="问题1-192168263-地址存在两个">问题1: 192.168.26.3 地址存在两个</h2>
<p>我在 vbox1 上执行以下抓包命令</p>
<pre tabindex="0"><code>sudo tcpdump -i enp0s8 --print -en -w vbox1_ping src host 192.168.26.3 or dst host 192.168.26.3
</code></pre><p>在另一个终端中执行 ping 发送 ICMP 包</p>
<pre tabindex="0"><code>ping -c 3 192.168.26.3
</code></pre><p>此时，很奇怪的问题出现了</p>
<p><code>192.168.26.3</code> 能够 ping 通，但请求不是从 vbox2 发回来的，而是从一个 MAC 地址为 <code>08:00:27:ae:84:b6</code> 的网卡发回来的。</p>
<pre tabindex="0"><code>01:26:47.254731 08:00:27:4c:f0:52 &gt; 08:00:27:ae:84:b6, ethertype IPv4 (0x0800), length 98: 192.168.26.129 &gt; 192.168.26.3: ICMP echo request, id 9, seq 1, length 64
01:26:47.254885 08:00:27:ae:84:b6 &gt; 08:00:27:4c:f0:52, ethertype IPv4 (0x0800), length 98: 192.168.26.3 &gt; 192.168.26.129: ICMP echo reply, id 9, seq 1, length 64
01:26:48.275239 08:00:27:4c:f0:52 &gt; 08:00:27:ae:84:b6, ethertype IPv4 (0x0800), length 98: 192.168.26.129 &gt; 192.168.26.3: ICMP echo request, id 9, seq 2, length 64
01:26:48.275415 08:00:27:ae:84:b6 &gt; 08:00:27:4c:f0:52, ethertype IPv4 (0x0800), length 98: 192.168.26.3 &gt; 192.168.26.129: ICMP echo reply, id 9, seq 2, length 64
01:26:49.298910 08:00:27:4c:f0:52 &gt; 08:00:27:ae:84:b6, ethertype IPv4 (0x0800), length 98: 192.168.26.129 &gt; 192.168.26.3: ICMP echo request, id 9, seq 3, length 64
01:26:49.299089 08:00:27:ae:84:b6 &gt; 08:00:27:4c:f0:52, ethertype IPv4 (0x0800), length 98: 192.168.26.3 &gt; 192.168.26.129: ICMP echo reply, id 9, seq 3, length 64
01:26:52.370038 08:00:27:4c:f0:52 &gt; 08:00:27:ae:84:b6, ethertype ARP (0x0806), length 42: Request who-has 192.168.26.3 tell 192.168.26.129, length 28
01:26:52.370156 08:00:27:ae:84:b6 &gt; 08:00:27:4c:f0:52, ethertype ARP (0x0806), length 60: Reply 192.168.26.3 is-at 08:00:27:ae:84:b6, length 46

# 这个抓包更奇怪，vbox1 询问 192.168.26.3 的 MAC 地址，有两个地址发来了响应
vagrant@vbox1:~$ sudo tcpdump -i enp0s8 --print src host 192.168.26.3 or dst host 192.168.26.3 -w vbox1_ping
tcpdump: listening on enp0s8, link-type EN10MB (Ethernet), snapshot length 262144 bytes
16:50:54.672007 ARP, Request who-has 192.168.26.3 tell vbox1, length 28
16:50:54.672243 ARP, Reply 192.168.26.3 is-at 08:00:27:ae:84:b6 (oui Unknown), length 46
16:50:54.672243 ARP, Reply 192.168.26.3 is-at 08:00:27:69:22:ae (oui Unknown), length 46
</code></pre><p>这个困扰了我好久，我反复检查三台 vbox 的所有网卡和我宿主机所有网卡的 MAC 地址，没有一个是符合 <code>08:00:27:ae:84:b6</code> 的。</p>
<p>后来我突发奇想，这是不是 virtualbox Nat Network 默认创建的地址，于是我将 vbox2 和 vbox3 的地址全部换掉，发现</p>
<ul>
<li>192.168.26.1</li>
<li>192.168.26.2</li>
<li>192.168.26.3</li>
</ul>
<p>这三个地址依然是能够 ping 通的。</p>
<p>我用关键字 <code>vbox nat network gateway</code> 在 Google 中搜索，找到了 vbox 的一篇文档: <a href="https://www.virtualbox.org/manual/ch06.html#network_nat_service">6.4. Network Address Translation Service</a></p>
<p>文档中创建了一个 <code>192.168.15.0/24</code> 的 Nat 网络， 并说静态设置的网关默认被赋予地址 <code>192.168.15.1</code></p>
<blockquote>
<p>Here, natnet1 is the name of the internal network to be used and 192.168.15.0/24 is the network address and mask of the NAT service interface. By default in this static configuration the gateway will be assigned the address 192.168.15.1, the address following the interface address, though this is subject to change. To attach a DHCP server to the internal network, modify the example command as follows:</p>
</blockquote>
<p>这下我就明白了，<code>192.168.26.1</code>, <code>192.168.26.2</code>, <code>192.168.26.3</code> 是 Vbox Nat 网络的保留地址，<code>192.168.26.1</code> 是默认网关，<code>192.168.26.3</code> 是 DNS Server 的地址(因为它的 53 端口能用 UDP 连上), <code>192.168.26.2</code> 是干嘛的还没搞明白</p>
<p>为了不冲突，我们改一下我们三台机器的地址，新地址如下</p>
<table>
<thead>
<tr>
<th>Hostname</th>
<th>网卡名称</th>
<th>IP/掩码</th>
<th>MAC 地址</th>
<th>网关</th>
</tr>
</thead>
<tbody>
<tr>
<td>vbox1</td>
<td>enp0s8</td>
<td>192.168.26.129/24</td>
<td>08:00:27:4c:f0:52</td>
<td>192.168.26.123</td>
</tr>
<tr>
<td>vbox2</td>
<td>enp0s8</td>
<td>192.168.26.122/27</td>
<td>08:00:27:69:22:ae</td>
<td>192.168.26.123</td>
</tr>
<tr>
<td>vbox3</td>
<td>enp0s8</td>
<td>192.168.26.123/24</td>
<td>08:00:27:d5:b5:13</td>
<td>192.168.26.1</td>
</tr>
</tbody>
</table>
<h2 id="问题2-网关没有转发">问题2: 网关没有转发</h2>
<p>更新了 IP 地址后，我们接着在 vbox1 上 ping <code>192.168.26.122</code>, 此时出现的问题是 ping 不通了，看起来上一个问题解决了，但是新的问题出现了。</p>
<p>我在 vbox2 上抓了一下包，看到了如下内容</p>
<pre tabindex="0"><code>vagrant@vbox2:~$ sudo tcpdump -i enp0s8 --print -en
17:17:56.850218 08:00:27:4c:f0:52 &gt; 08:00:27:69:22:ae, ethertype IPv4 (0x0800), length 98: 192.168.26.129 &gt; 192.168.26.122: ICMP echo request, id 25, seq 8, length 64
17:17:56.850246 08:00:27:69:22:ae &gt; 08:00:27:d5:b5:13, ethertype IPv4 (0x0800), length 98: 192.168.26.122 &gt; 192.168.26.129: ICMP echo reply, id 25, seq 8, length 64
17:17:57.868013 08:00:27:4c:f0:52 &gt; 08:00:27:69:22:ae, ethertype IPv4 (0x0800), length 98: 192.168.26.129 &gt; 192.168.26.122: ICMP echo request, id 25, seq 9, length 64
17:17:57.868046 08:00:27:69:22:ae &gt; 08:00:27:d5:b5:13, ethertype IPv4 (0x0800), length 98: 192.168.26.122 &gt; 192.168.26.129: ICMP echo reply, id 25, seq 9, length 64
17:17:58.883354 08:00:27:4c:f0:52 &gt; 08:00:27:69:22:ae, ethertype IPv4 (0x0800), length 98: 192.168.26.129 &gt; 192.168.26.122: ICMP echo request, id 25, seq 10, length 64
17:17:58.883387 08:00:27:69:22:ae &gt; 08:00:27:d5:b5:13, ethertype IPv4 (0x0800), length 98: 192.168.26.122 &gt; 192.168.26.129: ICMP echo reply, id 25, seq 10, length 64
</code></pre><p>vbox2 收到了来自 vbox1 的 ping request, 并发送 ping reply 给网关 vbox3, 这和我们预期的行为一致，说明 vbox2 没问题。</p>
<p>接着我又在 vbox3 上抓了一下包</p>
<pre tabindex="0"><code>root@vbox3:~# tcpdump -i enp0s8 --print -en
listening on enp0s8, link-type EN10MB (Ethernet), snapshot length 262144 bytes
01:49:50.730850 08:00:27:69:22:ae &gt; 08:00:27:d5:b5:13, ethertype IPv4 (0x0800), length 98: 192.168.26.122 &gt; 192.168.26.129: ICMP echo reply, id 26, seq 1, length 64
01:49:51.790335 08:00:27:69:22:ae &gt; 08:00:27:d5:b5:13, ethertype IPv4 (0x0800), length 98: 192.168.26.122 &gt; 192.168.26.129: ICMP echo reply, id 26, seq 2, length 64
01:49:53.203978 08:00:27:69:22:ae &gt; 08:00:27:d5:b5:13, ethertype IPv4 (0x0800), length 98: 192.168.26.122 &gt; 192.168.26.129: ICMP echo reply, id 26, seq 3, length 64
01:49:55.993736 08:00:27:69:22:ae &gt; 08:00:27:d5:b5:13, ethertype ARP (0x0806), length 60: Request who-has 192.168.26.123 tell 192.168.26.122, length 46
01:49:55.993751 08:00:27:d5:b5:13 &gt; 08:00:27:69:22:ae, ethertype ARP (0x0806), length 42: Reply 192.168.26.123 is-at 08:00:27:d5:b5:13, length 28
01:52:10.616571 08:00:27:69:22:ae &gt; 08:00:27:d5:b5:13, ethertype IPv4 (0x0800), length 98: 192.168.26.122 &gt; 192.168.26.129: ICMP echo reply, id 27, seq 1, length 64
01:52:11.965582 08:00:27:69:22:ae &gt; 08:00:27:d5:b5:13, ethertype IPv4 (0x0800), length 98: 192.168.26.122 &gt; 192.168.26.129: ICMP echo reply, id 27, seq 2, length 64
01:52:12.992503 08:00:27:69:22:ae &gt; 08:00:27:d5:b5:13, ethertype IPv4 (0x0800), length 98: 192.168.26.122 &gt; 192.168.26.129: ICMP echo reply, id 27, seq 3, length 64
</code></pre><p>vbox3 收到了 vbox2 转发来的包，但它没有进一步的发送动作，此时我拍脑袋一想，Linux 可能默认有限制，不转发包，于是我用 <strong>ubuntu 开启路由转发</strong> 作为关键字搜了一下，找到了配置项 <code>net.ipv4.ip_forward</code>, 我又用 <strong>ubuntu ipv4_forward</strong> 作为关键字搜索了一下，找到了 <a href="https://linuxconfig.org/how-to-turn-on-off-ip-forwarding-in-linux">ubuntu 开启 IP Forward 的文章</a>。</p>
<p>我执行以下命令，在 vbox3 上临时开启了 ip 转发的功能</p>
<pre tabindex="0"><code>sysctl -w net.ipv4.ip_forward=1
</code></pre><p>改完上述配置后，在 vbox1 上 ping <code>192.168.26.122</code> 就能 ping 通了。</p>
<p>在 vbox3 上抓包也能看到转发的 ICMP reply 包</p>
<pre tabindex="0"><code>01:58:54.790382 08:00:27:d5:b5:13 &gt; 08:00:27:4c:f0:52, ethertype IPv4 (0x0800), length 98: 192.168.26.122 &gt; 192.168.26.129: ICMP echo reply, id 28, seq 1, length 64
</code></pre><p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2023-08-23-234135.png" alt=""></p>
<h2 id="参考链接">参考链接</h2>
<ul>
<li><a href="https://linux-audit.com/how-to-clear-the-arp-cache-on-linux/">How to clear the ARP cache on Linux?</a></li>
<li><a href="https://www.virtualbox.org/manual/ch06.html#network_nat_service">6.4. Network Address Translation Service</a></li>
<li><a href="https://linuxconfig.org/how-to-turn-on-off-ip-forwarding-in-linux">Linux IP forwarding – How to Disable/Enable using net.ipv4.ip_forward</a></li>
<li>其他用到的命令</li>
</ul>
<pre tabindex="0"><code># 查看 arp 表
arp -n
# 清空 arp 表
sudo ip -s -s neigh flush all
# 查看路由信息
route -n
</code></pre>
</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-fb8915bbd249021082eebe2c7dfd52f0">16 - Golang</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-c374734838a7da2e3834d1091952177f">16.1 - 泛型</h1>
    
	<h2 id="利用泛型实现的语法糖">利用泛型实现的语法糖</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Cond
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 条件表达式的简单实现，支持任意类型
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">Cond</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">T</span> <span style="color:#000">any</span><span style="color:#000;font-weight:bold">](</span><span style="color:#000">val</span> <span style="color:#204a87;font-weight:bold">bool</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">a</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">b</span> <span style="color:#000">T</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">T</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">val</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">a</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">b</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Or
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 返回 vals 中第一个不是对应类型0值的参数，如果没有，则返回对应类型的0值
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">Or</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">T</span> <span style="color:#000">comparable</span><span style="color:#000;font-weight:bold">](</span><span style="color:#000">vals</span> <span style="color:#ce5c00;font-weight:bold">...</span><span style="color:#000">T</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">T</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">val</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">vals</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">val</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#204a87">new</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">T</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">val</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#204a87">new</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">T</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><ul>
<li>用法</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">TestCond</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">testing</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">T</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">assert</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Equal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Cond</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">assert</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Equal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Cond</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">req</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Request</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">assert</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Equal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MethodGet</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Cond</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">req</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MethodGet</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MethodPost</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">TestOr</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">testing</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">T</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 范型函数可以不传类型参数
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// 我在 1.18, 1.19, 1.20 上测试均可以工作
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">assert</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Equal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Or</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">]())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">assert</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Equal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Or</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">assert</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Equal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Or</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">assert</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Equal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Or</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">assert</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Equal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Or</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-8aa7d3f7c05390359a87acf37c95a33b">16.2 - YAML</h1>
    
	<h2 id="gopkginyamlv3-在-unmarshal-时设置默认值">gopkg.in/yaml.v3 在 Unmarshal 时设置默认值</h2>
<p>使用 <a href="https://github.com/go-yaml/yaml/tree/v3.0.1">gopkg.in/yaml.v3</a> 解析 yaml 文件时，我们可以实现结构体的 UnmarshalYAML 接口</p>
<p>在 <code>UnmarshalYAML</code> 方法中，既可以在结构体创建的时候指定默认值，也可以在结构体 Decode 完成之后，设置更复杂的默认值</p>
<ul>
<li>test.yaml</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">application</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">snowave</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">runtime</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">golang</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">services</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">linaewen.fdoulist</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">handler</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">services/api/thrift.go</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">thrift</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">use_services</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">app</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">fm</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">grpc</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">version</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">6b15b80</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">app</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">music</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">version</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">e89b497be9ef0fb932d5e543ed866f920780750f</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">app</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pony</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">version</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">c5b2e21</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><ul>
<li>main.go</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;github.com/pkg/errors&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;gopkg.in/yaml.v3&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;strings&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">UseService</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">App</span>     <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#4e9a06">`yaml:&#34;app,omitempty&#34;`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Type</span>    <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#4e9a06">`yaml:&#34;type,omitempty&#34;`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Version</span> <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#4e9a06">`yaml:&#34;version&#34;`</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// UnmarshalYAML
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//	此程序演示了，在 Decode 之前设置 Type 字段的默认值为 thrift
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">u</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">UseService</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">UnmarshalYAML</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">yaml</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Node</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">tmp</span> <span style="color:#000">UseService</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ru</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">tmp</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Type</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;thrift&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">value</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Decode</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">ru</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">errors</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Wrap</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;UseService: failed to unmarshal&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">u</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">UseService</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ru</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Service</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Name</span>      <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#4e9a06">`yaml:&#34;name&#34;`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Interface</span> <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#4e9a06">`yaml:&#34;interface&#34;`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Type</span>      <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#4e9a06">`yaml:&#34;type&#34;`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Handler</span>   <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#4e9a06">`yaml:&#34;handler&#34;`</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// UnmarshalYAML
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//	此函数演示了更复杂的情况, Name 字段的默认值是根据 Interface 的值来设置的
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Name 是 Interface 中 `.` 分割的最后一段
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 如果 Interface 中没有 `.` , 则 Name == Interface
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Service</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">UnmarshalYAML</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">yaml</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Node</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">tmp</span> <span style="color:#000">Service</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">rs</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">tmp</span><span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">value</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Decode</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">rs</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">errors</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Wrap</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Service: failed to unmarshal&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">rs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#34;&#34;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// 注意这里，无论 rs.Interface 的值是什么， tokens 的长度一定 &gt;= 1,
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// 所以 tokens[len(tokens)-1] 不会 Panic
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">tokens</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">strings</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Split</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Interface</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;.&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">rs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">tokens</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">tokens</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">s</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">Service</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rs</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">AppConfig</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Application</span> <span style="color:#204a87;font-weight:bold">string</span>        <span style="color:#4e9a06">`yaml:&#34;application&#34;`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Runtime</span>     <span style="color:#204a87;font-weight:bold">string</span>        <span style="color:#4e9a06">`yaml:&#34;runtime&#34;`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Services</span>    <span style="color:#000;font-weight:bold">[]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Service</span>    <span style="color:#4e9a06">`yaml:&#34;services&#34;`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">UseServices</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">UseService</span> <span style="color:#4e9a06">`yaml:&#34;use_services&#34;`</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">config</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">AppConfig</span><span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">content</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">_</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ReadFile</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;test.yaml&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">yaml</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Unmarshal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">content</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">config</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatalln</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 输出
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//fdoulist linaewen.fdoulist
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">svc</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Services</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">svc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">svc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Interface</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 输出
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//fm grpc
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//music thrift
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//pony thrift
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">svc</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UseServices</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">svc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">App</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">svc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Type</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="参考链接">参考链接</h3>
<ul>
<li><a href="https://github.com/go-yaml/yaml/issues/165#issuecomment-727092641">https://github.com/go-yaml/yaml/issues/165#issuecomment-727092641</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-52ff3e8194a92d6261809dbeed07036e">16.3 - Logrus 添加预设字段</h1>
    
	<hr>
<h2 id="tips">Tips</h2>
<ul>
<li>logrus 设置自定义 formatter, 添加预设字段</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#4e9a06">&#34;github.com/sirupsen/logrus&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">L</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">logrus</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Logger</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">customLogger</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">formatter</span> <span style="color:#000">logrus</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Formatter</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">domain</span>    <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">l</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">customLogger</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Format</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">entry</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">logrus</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Entry</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">([]</span><span style="color:#204a87;font-weight:bold">byte</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">entry</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Data</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;domain&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">l</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">domain</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">l</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">formatter</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Format</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">entry</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">L</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">logrus</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">New</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">L</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SetLevel</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">logrus</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">InfoLevel</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">L</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SetFormatter</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">customLogger</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">formatter</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">logrus</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">JSONFormatter</span><span style="color:#000;font-weight:bold">{},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">domain</span><span style="color:#000;font-weight:bold">:</span>    <span style="color:#4e9a06">&#34;custom domain&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">L</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Info</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;this msg&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//{&#34;domain&#34;:&#34;custom-domain&#34;,&#34;level&#34;:&#34;info&#34;,&#34;msg&#34;:&#34;this msg&#34;,&#34;time&#34;:&#34;2023-04-27T14:59:45+08:00&#34;}
</span></span></span></code></pre></div><h2 id="参考链接">参考链接</h2>
<ul>
<li><a href="https://github.com/sirupsen/logrus/issues/444#issuecomment-831093226">logrus#444</a></li>
</ul>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-16c718411b1484a4cad9a403ef36fc6a">16.4 - Golang Build 出错: error obtaining VCS status: exit status 128</h1>
    
	<hr>
<h2 id="go-build-时遇到了-error-obtaining-vcs-status-错误">Go build 时遇到了 error obtaining VCS status 错误</h2>
<p>我们的 Golang 项目都是在 docker 中 build 的，最近在 build 的时，遇到了以下的错误:</p>
<pre tabindex="0"><code>error obtaining VCS status: exit status 128
        Use -buildvcs=false to disable VCS stamping.
</code></pre><p>build golang 项目的 dockerfile 如下，我们会先把代码目录的所有者变成 bwangel, 再执行 go build:</p>
<pre tabindex="0"><code>FROM golang:1.18-buster

RUN sed -i &#39;s/deb.debian.org/mirrors.ustc.edu.cn/g&#39; /etc/apt/sources.list
RUN apt-get update &amp;&amp; apt-get -yq install sudo &amp;&amp; rm -rf /var/lib/apt/lists/*;

RUN git clone https://github.com/bwangelme/rdcdemo.git /go/src/
RUN /usr/sbin/useradd \
        --user-group \
        --create-home \
        --uid 1001 --shell &#39;/bin/bash&#39; \
        bwangel &amp;&amp; \
    chown bwangel:bwangel -R /go/src

WORKDIR /go/src/
RUN go build .
</code></pre><p>根据 buildvcs 这个关键字，我找到了 Go 1.18 的 <a href="https://tip.golang.org/doc/go1.18">release notes</a>，其中关于 buildvcs 的描述是这样的</p>
<blockquote>
<p>The go command now embeds version control information in binaries. It includes the currently checked-out revision, commit time, and a flag indicating whether edited or untracked files are present. Version control information is embedded if the go command is invoked in a directory within a Git, Mercurial, Fossil, or Bazaar repository, and the main package and its containing main module are in the same repository. This information may be omitted using the flag -buildvcs=false.</p>
</blockquote>
<blockquote>
<p>Additionally, the go command embeds information about the build, including build and tool tags (set with -tags), compiler, assembler, and linker flags (like -gcflags), whether cgo was enabled, and if it was, the values of the cgo environment variables (like CGO_CFLAGS). Both VCS and build information may be read together with module information using go version -m file or runtime/debug.ReadBuildInfo (for the currently running binary) or the new debug/buildinfo package.</p>
</blockquote>
<p>从 1.18 开始，Golang 在执行 build 时，会将 Git Commit Revision, Commit 时间，和是否有文件 Untracked 的标记写入到二进制中，使用 <code>go version -m &lt;file&gt;</code> 能够查看这些信息。</p>
<p>例如下面的代码中我们查看了 rdcdemo 文件的信息，可以看到执行 build 时 git commit revision 是 <code>8157a03bdfd846437cd0acdc1a7391ad9a13f6b3</code>, 这个 Commit 的创建时间是 <code>2021-09-26</code>, <code>vcs.modified=true</code> 表示有修改尚未提交到 git 中。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>ø&gt; go version -m rdcdemo
</span></span><span style="display:flex;"><span>rdcdemo: go1.18.9
</span></span><span style="display:flex;"><span>        path    rdcdemo
</span></span><span style="display:flex;"><span>        mod     rdcdemo <span style="color:#ce5c00;font-weight:bold">(</span>devel<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        dep     github.com/cespare/xxhash/v2    v2.1.1  h1:6MnRN8NT7+YBpUIWxHtefFZOKTAPgGjpQSxqLNn0+qY<span style="color:#ce5c00;font-weight:bold">=</span>
</span></span><span style="display:flex;"><span>        dep     github.com/dgryski/go-rendezvous        v0.0.0-20200823014737-9f7001d12a5f      h1:lO4WD4F/rVNCu3HqELle0jiPLLBs70cWOduZpkS1E78<span style="color:#ce5c00;font-weight:bold">=</span>
</span></span><span style="display:flex;"><span>        dep     github.com/go-redis/redis/v8    v8.11.3 h1:GCjoYp8c+yQTJfc0n69iwSiHjvuAdruxl7elnZCxgt8<span style="color:#ce5c00;font-weight:bold">=</span>
</span></span><span style="display:flex;"><span>        build   -compiler<span style="color:#ce5c00;font-weight:bold">=</span>gc
</span></span><span style="display:flex;"><span>        build   <span style="color:#000">CGO_ENABLED</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>        build   <span style="color:#000">CGO_CFLAGS</span><span style="color:#ce5c00;font-weight:bold">=</span>
</span></span><span style="display:flex;"><span>        build   <span style="color:#000">CGO_CPPFLAGS</span><span style="color:#ce5c00;font-weight:bold">=</span>
</span></span><span style="display:flex;"><span>        build   <span style="color:#000">CGO_CXXFLAGS</span><span style="color:#ce5c00;font-weight:bold">=</span>
</span></span><span style="display:flex;"><span>        build   <span style="color:#000">CGO_LDFLAGS</span><span style="color:#ce5c00;font-weight:bold">=</span>
</span></span><span style="display:flex;"><span>        build   <span style="color:#000">GOARCH</span><span style="color:#ce5c00;font-weight:bold">=</span>amd64
</span></span><span style="display:flex;"><span>        build   <span style="color:#000">GOOS</span><span style="color:#ce5c00;font-weight:bold">=</span>linux
</span></span><span style="display:flex;"><span>        build   <span style="color:#000">GOAMD64</span><span style="color:#ce5c00;font-weight:bold">=</span>v1
</span></span><span style="display:flex;"><span>        build   <span style="color:#000">vcs</span><span style="color:#ce5c00;font-weight:bold">=</span>git
</span></span><span style="display:flex;"><span>        build   vcs.revision<span style="color:#ce5c00;font-weight:bold">=</span>8157a03bdfd846437cd0acdc1a7391ad9a13f6b3
</span></span><span style="display:flex;"><span>        build   vcs.time<span style="color:#ce5c00;font-weight:bold">=</span>2021-09-26T11:45:50Z
</span></span><span style="display:flex;"><span>        build   vcs.modified<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">true</span>
</span></span></code></pre></div><p>在 build 时加上 <code>-buildvcs=false</code> 可以不添加这些信息。</p>
<h2 id="获取-vcs-信息的时候为什么会出错">获取 vcs 信息的时候为什么会出错</h2>
<p>报错 <code>error obtaining VCS status</code> 表示 Golang 获取 vcs 信息时出错了，但我还想往下深究一下，具体出了什么错误。此时就可以给 go build 加上 <code>-x -v</code> 选项，这样 go build 就会输出每一步执行的操作:</p>
<p>修改上述 dockerfile, 添加 build 选项 <code>-x -v</code></p>
<pre tabindex="0"><code>FROM golang:1.18-buster

RUN sed -i &#39;s/deb.debian.org/mirrors.ustc.edu.cn/g&#39; /etc/apt/sources.list
RUN apt-get update &amp;&amp; apt-get -yq install sudo &amp;&amp; rm -rf /var/lib/apt/lists/*;

RUN git clone https://github.com/bwangelme/rdcdemo.git /go/src/
RUN /usr/sbin/useradd \
        --user-group \
        --create-home \
        --uid 1001 --shell &#39;/bin/bash&#39; \
        bwangel &amp;&amp; \
    chown bwangel:bwangel -R /go/src

WORKDIR /go/src/
RUN go build -x -v .
</code></pre><p>此时出错信息变多了，可以看到，是 Go build 在执行 <code>git status --porcelain</code> 的时候出错了，错误信息是 <code>detected dubious ownership in repository</code></p>
<pre tabindex="0"><code>WORK=/tmp/go-build975996823
cd /go/src
git status --porcelain
# cd /go/src; git status --porcelain
fatal: detected dubious ownership in repository at &#39;/go/src&#39;
To add an exception for this directory, call:

        git config --global --add safe.directory /go/src
error obtaining VCS status: exit status 128
        Use -buildvcs=false to disable VCS stamping.
</code></pre><h2 id="git-为什么要检查-git-目录的-owner">Git 为什么要检查 .git 目录的 owner</h2>
<p>根据关键字 <code>detected dubious ownership in repository</code>, 我找到了一篇文章: <a href="https://medium.com/@thecodinganalyst/git-detect-dubious-ownership-in-repository-e7f33037a8f">Git detect dubious ownership in repository</a></p>
<p>这篇文章说，Git 命令在执行时，会执行 <code>.git/</code> 目录中的文件，如果 <code>.git/</code> 目录中的文件被恶意篡改了，那么就会造成安全漏洞。</p>
<p>例如 <code>/go/src</code> 这个目录是 bwangel 用户所有的，它修改了 <code>/go/src/.git/</code> 中的文件，添加了一个窃取信息的木马。root 用户在 <code>/go/src</code> 中执行 git status 时，就会以 root 用户执行这个木马，造成信息泄漏。</p>
<p>所以 Git 在 <a href="https://github.com/git/git/commit/8959555cee7ec045958f9b6dd62e541affb7e7d9">895955</a> 中添加了安全检查，确保执行 git 命令的用户和 <code>.git/</code> 目录的 owner 是同一个人。</p>
<p>如果用户信任某个目录，不想添加这种检查，可以修改配置 <code>safe.directory</code></p>
<pre tabindex="0"><code>git config --global --add safe.directory /some/repo
</code></pre><p>那么在 <code>/some/repo</code> 中执行 git 命令时，就不会检查文件 owner 了。</p>
<h2 id="解决-docker-build-失败的方案">解决 docker build 失败的方案</h2>
<h3 id="添加--buildvcsfalse-选项">添加 -buildvcs=false 选项</h3>
<p>修改 build 命令，加上 <code>-buildvcs=false</code> 选项，这样 go 不会收集 vcs 信息，也就不会遇到 git 的错误了</p>
<pre tabindex="0"><code>RUN go build -buildvcs=false .
</code></pre><h3 id="修改执行-go-build-的用户">修改执行 go build 的用户</h3>
<p>修改执行 build 命令的用户，这样也可以 build 成功</p>
<pre tabindex="0"><code>FROM golang:1.18-buster

RUN sed -i &#39;s/deb.debian.org/mirrors.ustc.edu.cn/g&#39; /etc/apt/sources.list
RUN apt-get update &amp;&amp; apt-get -yq install sudo &amp;&amp; rm -rf /var/lib/apt/lists/*;

RUN git clone https://github.com/bwangelme/rdcdemo.git /go/src/
RUN /usr/sbin/useradd \
        --user-group \
        --create-home \
        --uid 1001 --shell &#39;/bin/bash&#39; \
        bwangel &amp;&amp; \
    chown bwangel:bwangel -R /go/src

WORKDIR /go/src/
RUN su - bwangel bash -c &#34;cd /go/src; /usr/local/go/bin/go env; /usr/local/go/bin/go build -v .&#34;
</code></pre><h3 id="git-中添加-safe-directory-的配置">Git 中添加 safe directory 的配置</h3>
<p>将代码所在目录 <code>/go/src</code> 设置成 <code>safe.directory</code>, 这样 git 执行时就不会出错了，也可以 build 成功。</p>
<pre tabindex="0"><code>FROM golang:1.18-buster

RUN sed -i &#39;s/deb.debian.org/mirrors.ustc.edu.cn/g&#39; /etc/apt/sources.list
RUN apt-get update &amp;&amp; apt-get -yq install sudo &amp;&amp; rm -rf /var/lib/apt/lists/*;

RUN git clone https://github.com/bwangelme/rdcdemo.git /go/src/
RUN /usr/sbin/useradd \
        --user-group \
        --create-home \
        --uid 1001 --shell &#39;/bin/bash&#39; \
        bwangel &amp;&amp; \
    chown bwangel:bwangel -R /go/src

WORKDIR /go/src/
RUN git config --global --add safe.directory /go/src
RUN go build .
</code></pre><ul>
<li>safe.directory 只负责一个目录，不会关心子目录中的 git 仓库</li>
<li>使用 <code>*</code> 可以让所有仓库忽略 safe.directory 的检查</li>
</ul>
<pre tabindex="0"><code>git config --global --add safe.directory &#39;*&#39;
</code></pre><h2 id="go-install-时遇到的相似问题">go install 时遇到的相似问题</h2>
<p>当 GOPATH 目录的 owner 是 bwangel， 使用 root 用户运行 <code>go install</code> 安装私有仓库的命令时，也会遇到相同的问题。</p>
<p>比较有迷惑性的是，<code>go install</code>显示的错误是 <code>fatal: 'origin' does not appear to be a git repository</code></p>
<p>表面上看起来，这是下载的 git 仓库找不到 origin 这个 remote。但我们加上 <code>-x -v</code> 参数，输出一下详细的步骤，就能找到原因了。</p>
<pre tabindex="0"><code>root@551114e99eea:/go# go install -x -v github.private.repo/org/repo/cmd/dag@latest
# get https://github.private.repo/?go-get=1
# get https://github.private.repo/org?go-get=1
# get https://github.private.repo/org/repo/cmd?go-get=1
# get https://github.private.repo/org/repo/cmd/dag?go-get=1
# get https://github.private.repo/org/repo?go-get=1
# get https://github.private.repo/org/repo/cmd?go-get=1: 200 OK (0.103s)
# get https://github.private.repo/org/repo?go-get=1: 200 OK (0.103s)
# get https://github.private.repo/org/repo/cmd/dag?go-get=1: 200 OK (0.103s)
get &#34;github.private.repo/org/repo/cmd&#34;: found meta tag vcs.metaImport{Prefix:&#34;github.private.repo/org/repo&#34;, VCS:&#34;git&#34;, RepoRoot:&#34;https://github.private.repo/org/repo.git&#34;} at //github.private.repo/org/repo/cmd?go-get=1
get &#34;github.private.repo/org/repo/cmd&#34;: verifying non-authoritative meta tag
get &#34;github.private.repo/org/repo/cmd/dag&#34;: found meta tag vcs.metaImport{Prefix:&#34;github.private.repo/org/repo&#34;, VCS:&#34;git&#34;, RepoRoot:&#34;https://github.private.repo/org/repo.git&#34;} at //github.private.repo/org/repo/cmd/dag?go-get=1
get &#34;github.private.repo/org/repo/cmd/dag&#34;: verifying non-authoritative meta tag
# get https://github.private.repo/org/repo?go-get=1
get &#34;github.private.repo/org/repo&#34;: found meta tag vcs.metaImport{Prefix:&#34;github.private.repo/org/repo&#34;, VCS:&#34;git&#34;, RepoRoot:&#34;https://github.private.repo/org/repo.git&#34;} at //github.private.repo/org/repo?go-get=1
mkdir -p /go/pkg/mod/cache/vcs # git3 https://github.private.repo/org/repo.git
# lock /go/pkg/mod/cache/vcs/a1b9ef7e71cba11b98501177ca2d4f9fd012c258b967f915f68ee79a228ddf92.lock# /go/pkg/mod/cache/vcs/a1b9ef7e71cba11b98501177ca2d4f9fd012c258b967f915f68ee79a228ddf92 for git3 https://github.private.repo/org/repo.git
cd /go/pkg/mod/cache/vcs/a1b9ef7e71cba11b98501177ca2d4f9fd012c258b967f915f68ee79a228ddf92; git ls-remote -q origin
0.003s # cd /go/pkg/mod/cache/vcs/a1b9ef7e71cba11b98501177ca2d4f9fd012c258b967f915f68ee79a228ddf92; git ls-remote -q origin
# get https://github.private.repo/org/repo.git
# get https://github.private.repo/org/repo?go-get=1: 200 OK (0.040s)
# get https://github.private.repo/?go-get=1: 200 OK (0.154s)
# get https://github.private.repo/org?go-get=1: 200 OK (0.276s)
# get https://github.private.repo/org/repo.git: 200 OK (0.171s)
go: github.private.repo/org/repo/cmd/dag@latest: module github.private.repo/org/repo/cmd/dag: git ls-remote -q origin in /go/pkg/mod/cache/vcs/a1b9ef7e71cba11b98501177ca2d4f9fd012c258b967f915f68ee79a228ddf92: exit status 128:
        fatal: &#39;origin&#39; does not appear to be a git repository
        fatal: Could not read from remote repository.

        Please make sure you have the correct access rights
        and the repository exists.
</code></pre><p>在 go install 执行过程中，会首先下载仓库到 <code>/go/pkg/mod/cache/vcs/a1b9ef7e71cba11b98501177ca2d4f9fd012c258b967f915f68ee79a228ddf92</code> 目录中</p>
<p>然后在该目录执行 <code>git ls-remote -q origin</code> 获取 tag 列表，并得到最新的 repo tag.</p>
<p>因为 <code>safe.directory</code> 的检查，导致 <code>git ls-remote -q origin</code> 执行失败，git 认为 origin remote 不存在，才会显示异常 <code>fatal: 'origin' does not appear to be a git repository</code></p>
<p>go install 安装 github 上的仓库时，就不会遇到上述问题，因为安装 github 的仓库是从 GOPROXY 上获取的缓存文件，不需要经过 git 来查询 tag 了，不执行 git 命令，也就不会遇到上述问题了。</p>
<h2 id="参考链接">参考链接</h2>
<ul>
<li><a href="https://tip.golang.org/doc/go1.18">go 1.18 release note</a></li>
<li><a href="https://medium.com/@thecodinganalyst/git-detect-dubious-ownership-in-repository-e7f33037a8f">Git detect dubious ownership in repository</a></li>
<li><a href="https://idushu.com/%E8%A7%A3%E5%86%B3-golang-%E5%8D%87%E7%BA%A7%E5%88%B0-1-18-%E7%89%88%E6%9C%AC%E5%90%8E%E5%9C%A8%E5%AE%B9%E5%99%A8%E4%B8%AD%E6%9E%84%E5%BB%BA%E6%97%B6%E5%87%BA%E7%8E%B0-error-obtaining-vcs-status-exi/">解决 Golang 升级到 1.18+ 版本后在容器中构建时出现 error obtaining VCS status: exit status 128 的问题</a></li>
</ul>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-83df69ae1444d01a6f7c0a195b54857e">16.5 - pkg/errors 和 go1.13 中 errors 库发展历史</h1>
    
	<hr>
<ul>
<li>pkg/errors 的设计思路是，将 err 设计成一个链表，每次需要返回 error 的时候，调用 <code>errors.Wrap(err, &quot;message %v&quot;, value)</code>，生成一个新的 error，并将新 error 追加到链表尾部。这个 error 可以附加一些额外的信息和栈信息，</li>
<li>pkg/errors 提供了 <code>Cause</code> 接口和 <code>errors.Cause</code> 函数，<code>Cause</code> 接口返回 err 包裹的接口，<code>errors.Cause</code> 函数返回错误链表中链表头的错误</li>
<li>golang 1.13 中，将 pkg/errors 的设计思路纳入到了标准库中 <code>errors</code>
<ul>
<li>go 标准库采用了链表链接 error 的设计思路</li>
<li>go 标准库没有使用 pkg/errors 的 <code>Cause</code> 接口，而是使用了新接口 <code>Unwrap</code>，这样导致无法和旧的使用 <code>pkg/errors</code> 的代码兼容</li>
<li>go 标准库提供了处理错误的三个函数:
<ul>
<li><code>errors.Unwrap(err error) error</code> 返回 <code>err</code> 链表头的 error (即原始 error)</li>
<li><code>errors.Is(err error, target error) bool</code> 遍历 <code>err</code> 链表中的每一个错误和 <code>target</code> 进行比较, 判断 <code>err</code> 链表中是否存在和 <code>target</code> 相等的错误，如果有，返回 <code>true</code>，否则返回 <code>false</code></li>
<li><code>errors.As(err error, target interface{}) bool</code>，从 <code>err</code> 链表中找到第一个可以赋值给 <code>target</code> 的错误，并将其赋值给 <code>target</code>，如果赋值成功，返回 <code>true</code>，否则返回 <code>fasle</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="参考链接">参考链接</h2>
<ul>
<li><a href="https://dr-knz.net/cockroachdb-errors-std-api.html">The Go standard error APIs The CockroachDB errors library, part 1/</a></li>
<li><a href="https://github.com/golang/go/blob/dev.boringcrypto.go1.17/src/errors/wrap.go">go1.17 source code errors/wrap.go</a></li>
</ul>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-434a02cf1a3ee72f31be04b770f0fabb">16.6 - Golang 的版本发布计划</h1>
    
	<blockquote>
<p>Golang 的版本发布计划</p>
</blockquote>
<hr>
<h2 id="golang-的版本发布计划">Golang 的版本发布计划</h2>
<p>在 <a href="https://github.com/golang/go/wiki/Go-Release-Cycle">Go Release Cycle</a> 中写明了</p>
<p>每半年发布一个版本，每年的02月和08月发布一个 Major 版本。但是 Go 官方好像一直没有严格遵守过这个时间。</p>
<p>在 <a href="https://go.dev/doc/devel/release">Release History</a> 中可以看到最近的版本发布日期</p>
<table>
<thead>
<tr>
<th>版本</th>
<th>发布日期</th>
<th>是否还在维护</th>
</tr>
</thead>
<tbody>
<tr>
<td>go1.19</td>
<td><a href="https://groups.google.com/g/golang-dev/c/4xsD_D5oflI">2022-11-01?</a></td>
<td>开发中</td>
</tr>
<tr>
<td>go1.18</td>
<td>2022-03-15</td>
<td>是</td>
</tr>
<tr>
<td>go1.17</td>
<td>2021-08-16</td>
<td>是</td>
</tr>
<tr>
<td>go1.16</td>
<td>2021-02-16</td>
<td>否</td>
</tr>
<tr>
<td>go1.15</td>
<td>2020-08-11</td>
<td>否</td>
</tr>
<tr>
<td>go1.14</td>
<td>2020-02-25</td>
<td>否</td>
</tr>
<tr>
<td>go.1.13</td>
<td>2019-09-03</td>
<td>否</td>
</tr>
<tr>
<td>go1.12</td>
<td>2019-02-25</td>
<td>否</td>
</tr>
<tr>
<td>go1.11</td>
<td>2018-08-24</td>
<td>否</td>
</tr>
<tr>
<td>go1.10</td>
<td>2018-02-16</td>
<td>否</td>
</tr>
<tr>
<td>go1.9</td>
<td>2017-08-24</td>
<td>否</td>
</tr>
<tr>
<td>go1.8</td>
<td>2017-02-16</td>
<td>否</td>
</tr>
<tr>
<td>go1.7</td>
<td>2016-08-15</td>
<td>否</td>
</tr>
<tr>
<td>go1.6</td>
<td>2016-02-17</td>
<td>否</td>
</tr>
<tr>
<td>go1.5</td>
<td>2015-08-19</td>
<td>否</td>
</tr>
<tr>
<td>go1.4</td>
<td>2014-12-10</td>
<td>否</td>
</tr>
<tr>
<td>go1.3</td>
<td>2014-06-18</td>
<td>否</td>
</tr>
<tr>
<td>go1.2</td>
<td>2013-12-01</td>
<td>否</td>
</tr>
<tr>
<td>go1.1</td>
<td>2013-05-13</td>
<td>否</td>
</tr>
<tr>
<td>go1</td>
<td>2012-03-28</td>
<td>否</td>
</tr>
</tbody>
</table>
<h2 id="每个版本的维护计划">每个版本的维护计划</h2>
<blockquote>
<p>Each major Go release is supported until there are two newer major releases. For example, Go 1.5 was supported until the Go 1.7 release, and Go 1.6 was supported until the Go 1.8 release. We fix critical problems, including critical security problems, in supported releases as needed by issuing minor revisions (for example, Go 1.6.1, Go 1.6.2, and so on).</p>
</blockquote>
<p>每个 Major 版本会维护到下两个 Major 版本 release 的时候，例如 Go1.18 release 的，Go1.16 就放弃维护了。所以每个 Major 版本大致的支持时间是1年</p>
<h2 id="参考链接">参考链接</h2>
<ul>
<li><a href="https://dev.golang.org/release">Golang Release dashboard</a></li>
<li><a href="https://github.com/golang/go/wiki/Go-Release-Cycle">Go Release Cycle</a></li>
<li><a href="https://go.dev/doc/devel/release">Release History</a></li>
<li><a href="https://groups.google.com/g/golang-dev/c/4xsD_D5oflI">Go 1.19 release status</a></li>
</ul>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-3e6373393d3b5fc1fcfcf9263b1f83af">16.7 - Go gcflags/ldflags 的说明</h1>
    
	<blockquote>
<p>Go 链接选项和编译选项的说明</p>
</blockquote>
<hr>
<h2 id="编译选项">编译选项</h2>
<p>go build 时可以使用 <code>-gcflags</code> 指定编译选项，<code>-gcflags</code> 参数的格式是</p>
<pre tabindex="0"><code>-gcflags=&#34;pattern=arg list&#34;
</code></pre><h3 id="pattern">pattern</h3>
<p>pattern 是选择包的模式，它可以有以下几种定义:</p>
<ul>
<li><code>main</code>: 表示 main 函数所在的顶级包路径</li>
<li><code>all</code>: 表示 GOPATH 中的所有包。如果在 modules 模式下，则表示主模块和它所有的依赖，包括 test 文件的依赖</li>
<li><code>std</code>: 表示 Go 标准库中的所有包</li>
<li><code>...</code>: <code>...</code> 是一个通配符，可以匹配任意字符串(包括空字符串)。例如:
<ul>
<li>例如: <code>net/...</code> 表示 net 模块和它的所有子模块</li>
<li><code>./...</code> 表示当前主模块和所有子模块</li>
<li><strong>注意:</strong> 如果 pattern 中包含了 <code>/</code> 和 <code>...</code>，那么就不会匹配 <code>vendor</code> 目录
<ul>
<li>例如: <code>./...</code> 不会匹配 <code>./vendor</code> 目录。可以使用 <code>./vendor/...</code> 匹配 vendor 目录和它的子模块</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>更多的模式的说明请参考 <code>go help packages</code></p>
<h3 id="arg-list">arg list</h3>
<p>arg list 是空格分割的编译选项，如果编译选项中含有空格，可以使用引号包起来</p>
<p>下面介绍几种常用的编译选项:</p>
<ul>
<li><code>-N</code>: 禁止编译器优化</li>
<li><code>-l</code>: 关闭内联 (inline)</li>
<li><code>-c int</code>: 编译过程中的并发数，默认是1</li>
</ul>
<p>更多编译选项请参考 <code>go tool compile --help</code></p>
<h3 id="举例">举例</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 为当前模块下的所有包关闭编译优化和内联</span>
</span></span><span style="display:flex;"><span>go build -gcflags<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;all=-N -l&#34;</span> .
</span></span></code></pre></div><h2 id="链接选项">链接选项</h2>
<p><code>-ldflags</code> 可以设置链接选项</p>
<ul>
<li><code>-w</code> 不生成 DWARF 调试信息</li>
<li><code>-s</code> 关闭符号表</li>
</ul>
<p><code>-w</code> 和 <code>-s</code> 通常一起使用，用来减少可执行文件的体积。但删除了调试信息后，可执行文件将无法使用 gdb/dlv 调试</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>ø&gt; go build -ldflags<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;-w -s&#34;</span> ./abc.go
</span></span><span style="display:flex;"><span>ø&gt; dlv <span style="color:#204a87">exec</span> ./abc
</span></span><span style="display:flex;"><span>could not launch process: could not open debug info
</span></span></code></pre></div><p>注意： 使用 <code>go run main.go</code> 运行的进程，也无法用 <code>dlv attach ${pid}</code> 调试，因为找不到代码的符号信息。</p>
<h2 id="参考链接">参考链接</h2>
<ul>
<li><code>go help packages</code></li>
<li><code>go tool compile --help</code></li>
<li><code>go help build</code></li>
<li><a href="https://studygolang.com/articles/22803">https://studygolang.com/articles/22803</a></li>
<li><a href="https://javasgl.github.io/go-build-args/">https://javasgl.github.io/go-build-args/</a></li>
<li><a href="https://github.com/go-delve/delve/issues/1698">https://github.com/go-delve/delve/issues/1698</a></li>
</ul>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-7635b3151b5123edbeeed45e0cf3d239">16.8 - Review 《Don’t use Go’s default HTTP client (in production)》</h1>
    
	<blockquote>
<ul>
<li>原文地址: <a href="https://medium.com/@nate510/don-t-use-go-s-default-http-client-4804cb19f779">https://medium.com/@nate510/don-t-use-go-s-default-http-client-4804cb19f779</a></li>
</ul>
</blockquote>
<hr>
<p>编写通过 HTTP 与服务对话的 Go 程序很容易，也很有趣。
我已经写了无数的 API 客户端包，我发现这是一项令人愉快的任务。然而，我遇到了一个很容易落入的陷阱，它可以让你的程序很快崩溃：<strong>默认的HTTP客户端</strong>。</p>
<p>本文内容的一句话概括:</p>
<blockquote>
<p>Go 的 http 包默认没有指定请求超时，允许外部服务劫持你的 goroutine 。在连接外部服务时，一定要指定一个自定义的 http.Client 。</p>
</blockquote>
<h2 id="问题示例">问题示例</h2>
<p>假设你想通过漂亮的 JSON REST API与 <code>spacely-sprockets.com</code> 对话，并查看可用 <code>sprockets</code> 的列表。在 Go 语言中，你可以这样做:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 为了简洁省略了错误检查
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">sprockets</span> <span style="color:#000">SprocketsResponse</span>
</span></span><span style="display:flex;"><span><span style="color:#000">response</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">_</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;spacely-sprockets.com/api/sprockets&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">buf</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">_</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">ioutil</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ReadAll</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">response</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Body</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">json</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Unmarshal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">buf</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">sprockets</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>编写你的代码（请有适当的错误处理），编译，然后运行。
一切都很顺利。现在，你拿着你的API包，把它加入一个网络应用程序中。你的应用程序的一个页面通过调用 API 向用户显示 Spacely Sprockets 的库存列表。</p>
<p>一切都很顺利，直到有一天你的应用程序停止响应了。
你查看了日志，但没有任何迹象表明有问题。你检查了你的监控工具，但是 CPU、内存和 I/O 在故障发生前都看起来很正常。
你启动了一个沙盒，它似乎工作正常。怎么会这样呢？</p>
<p>沮丧之余，你查看了 Twitter，发现 Spacely Sprockets 开发团队发了一条推文，说他们经历了一次短暂的中断，但现在一切都恢复正常了。
你检查了他们的API状态页面，发现中断是在你之前几分钟开始的。
这似乎是一个不太可能的巧合，但你不能完全弄清楚这之间有什么关系，因为你的代码处理错误的方式很优雅。你仍然没有找到问题的答案。</p>
<h2 id="go-http-包">Go HTTP 包</h2>
<p>客户端是并发安全的对象，包含配置、管理 TCP 状态、处理 cookies 等。
当你使用 <code>http.Get(url)</code> 时，你正在使用 <code>http.DefaultClient</code> ，这是一个定义了客户端默认配置的包变量。它的声明是:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">DefaultClient</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">Client</span><span style="color:#000;font-weight:bold">{}</span>
</span></span></code></pre></div><p>除此之外，<code>http.Client</code> 配置了一个超时时间用来熔断长期运行的连接。这个值的默认值是0，它被解释为 &ldquo;没有超时&rdquo;。
这对软件包来说可能是一个合理的默认值，但它是一个讨厌的陷阱，也是我们的应用程序在上述例子中停止响应的原因。
事实证明，Spacely Sprockets 的 API 中断导致 <strong>连接尝试</strong> 阻塞住（这并不总是发生，但在我们的例子中确实如此）。只要故障的服务器不响应，它就会一直阻塞着。
因为正在进行 API 调用服务于用户请求，这导致服务于用户请求的 goroutines 也挂起。
一旦有足够多的用户点击此页面，应用程序就会停止响应，很可能是由于达到了资源限制。</p>
<p>这里有一个简单的代码演示了这个问题:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;net/http&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;net/http/httptest&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">svr</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">httptest</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewServer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HandlerFunc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">w</span> <span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ResponseWriter</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">r</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Request</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sleep</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Hour</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}))</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">svr</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Close</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;making request&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">svr</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">URL</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;finished request&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>启动之后，这个程序会请求一个 sleep 1小时的接口。随后，这个程序也会阻塞一个小时，然后退出。</p>
<h2 id="解决方案">解决方案</h2>
<p>解决这个问题的方法是你的场景中定义一个带有合理超时的 <code>http.Client</code> 。下面是一个例子。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">netClient</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Client</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">Timeout</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Second</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000">response</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">_</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">netClient</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">url</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>这为向 API 发出的请求设置了10秒的超时。如果服务器响应的时间超过了超时时间，Get()将返回错误。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">httpError</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">err</span><span style="color:#000;font-weight:bold">:</span>     <span style="color:#000">err</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Error</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#4e9a06">&#34; (Client.Timeout exceeded while awaiting headers)&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">timeout</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>如果你需要对请求生命周期进行更精细的控制，你可以另外指定一个自定义的 <code>net.Transport</code> 和 <code>net.Dialer</code>。
<code>Transport</code> 是一个客户端用来管理底层TCP连接的结构，它的 <code>Dialer</code> 是一个管理建立连接的结构。
Go 的 net 包也有一个默认的 Transport 和 Dialer 。下面是一个使用自定义结构的例子。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">netTransport</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Transport</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">Dial</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">net</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Dialer</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">Timeout</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">5</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Second</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}).</span><span style="color:#000">Dial</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">TLSHandshakeTimeout</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">5</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Second</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">netClient</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Client</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">Timeout</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Second</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">Transport</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">netTransport</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000">response</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">_</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">netClient</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">url</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>这段代码将为 TCP 连接和 TLS 握手设置超时上限，还设置了一个端到端的请求超时。如果需要的话，你还可以使用其他配置选项，如 <code>keep-alive</code> 超时。</p>
<h2 id="总结">总结</h2>
<p>Go 的 net 和 http 包是一个经过深思熟虑的、方便通过 HTTP(S) 进行通信的基础包。
然而，由于该包提供了 <code>http.Get(url)</code> 这样的方便方法，因此缺乏对请求的默认超时是一个容易陷入的陷阱。
有些语言（如Java）有同样的问题，其他语言（如Ruby有默认的60秒读取超时）则没有。
在联系远程服务时不设置请求超时，会使你的应用程序受到该服务的摆布。
一个故障的或恶意的服务可以永远阻塞你的连接，可能会使你的应用程序陷入内存不足的困境。</p>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-411c7d44b39c2c01f271102f90652135">16.9 - Go proxy 的说明</h1>
    
	<hr>
<h2 id="查看-go-proxy-中包的信息">查看 Go Proxy 中包的信息</h2>
<h3 id="查看包的版本列表">查看包的版本列表</h3>
<pre tabindex="0"><code>ø&gt; curl https://proxy.golang.org/go.etcd.io/etcd/client/v3/@v/list
v3.5.0-beta.4
v3.5.4
v3.5.2
v3.5.0-alpha.0
v3.5.0-rc.0
v3.5.3
v3.5.0
v3.5.1
v3.5.0-beta.2
v3.6.0-alpha.0
v3.5.0-rc.1
v3.5.0-beta.3
</code></pre><h3 id="查看包的版本信息">查看包的版本信息</h3>
<pre tabindex="0"><code>curl https://proxy.golang.org/go.etcd.io/etcd/client/v3/@v/v3.0.0-20201116001935-06e48f04865f.info
</code></pre><h3 id="查看包的依赖">查看包的依赖</h3>
<p>即获取 go.mod 文件</p>
<pre tabindex="0"><code>curl https://proxy.golang.org/go.etcd.io/etcd/client/v3/@v/v3.0.0-20201116001935-06e48f04865f.mod
</code></pre><pre tabindex="0"><code>module go.etcd.io/etcd/client/v3

go 1.15

require (
        github.com/dustin/go-humanize v1.0.0
        github.com/google/uuid v1.1.2
        github.com/grpc-ecosystem/go-grpc-prometheus v1.2.0
        github.com/prometheus/client_golang v1.5.1
        go.etcd.io/etcd/api/v3 v3.5.0-pre
        go.etcd.io/etcd/pkg/v3 v3.5.0-pre
        go.uber.org/zap v1.16.0
        google.golang.org/grpc v1.29.1
        sigs.k8s.io/yaml v1.2.0
)

replace (
        go.etcd.io/etcd/api/v3 =&gt; ../../api
        go.etcd.io/etcd/pkg/v3 =&gt; ../../pkg
)

// Bad imports are sometimes causing attempts to pull that code.
// This makes the error more explicit.
replace (
        go.etcd.io/etcd =&gt; ./FORBIDDEN_DEPENDENCY
        go.etcd.io/etcd/v3 =&gt; ./FORBIDDEN_DEPENDENCY
        go.etcd.io/tests/v3 =&gt; ./FORBIDDEN_DEPENDENCY
)
</code></pre><h3 id="下载包">下载包</h3>
<pre tabindex="0"><code>curl https://proxy.golang.org/go.etcd.io/etcd/client/v3/@v/v3.0.0-20201116001935-06e48f04865f.zip
</code></pre><h2 id="proxy-测速">Proxy 测速</h2>
<p>2021-12-13 日晚安装包 <code>go-git/go-git-fixtures</code> 的时候卡着不动，测了一下两个 proxy 的速度</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>ø&gt; curl https://goproxy.io/github.com/go-git/go-git-fixtures/v4/@v/v4.2.1.zip -o /tmp/pkg.zip
</span></span><span style="display:flex;"><span>  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
</span></span><span style="display:flex;"><span>                                 Dload  Upload   Total   Spent    Left  Speed
</span></span><span style="display:flex;"><span>  <span style="color:#0000cf;font-weight:bold">2</span> 93.4M    <span style="color:#0000cf;font-weight:bold">2</span> 2623k    <span style="color:#0000cf;font-weight:bold">0</span>     <span style="color:#0000cf;font-weight:bold">0</span>   181k      <span style="color:#0000cf;font-weight:bold">0</span>  0:08:48  0:00:14  0:08:34  147k
</span></span><span style="display:flex;"><span>ø&gt; curl https://goproxy.cn/github.com/go-git/go-git-fixtures/v4/@v/v4.2.1.zip -o /tmp/pkg.zip
</span></span><span style="display:flex;"><span>  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
</span></span><span style="display:flex;"><span>                                 Dload  Upload   Total   Spent    Left  Speed
</span></span><span style="display:flex;"><span> <span style="color:#0000cf;font-weight:bold">10</span> 93.4M   <span style="color:#0000cf;font-weight:bold">10</span>  9.7M    <span style="color:#0000cf;font-weight:bold">0</span>     <span style="color:#0000cf;font-weight:bold">0</span>  3712k      <span style="color:#0000cf;font-weight:bold">0</span>  0:00:25  0:00:02  0:00:23 3711k
</span></span><span style="display:flex;"><span> <span style="color:#0000cf;font-weight:bold">21</span> 93.4M   <span style="color:#0000cf;font-weight:bold">21</span> 20.2M    <span style="color:#0000cf;font-weight:bold">0</span>     <span style="color:#0000cf;font-weight:bold">0</span>  5605k      <span style="color:#0000cf;font-weight:bold">0</span>  0:00:17  0:00:03  0:00:14 5603k
</span></span></code></pre></div><p>goproxy.io 的下载速度竟然只有 147k，怪不得安装时会卡住</p>
<h2 id="参考链接">参考链接</h2>
<ul>
<li><a href="https://go.dev/ref/mod">https://go.dev/ref/mod</a></li>
</ul>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-e8eaec0059b446cf3655c3f76c3de6b5">16.10 - Golang 中空数组是否是 nil</h1>
    
	<hr>
<h2 id="tips">Tips</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">t1</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span><span style="color:#000">t2</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span><span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;t1&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">t1</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t1</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#8f5902;font-style:italic">// t1 true 0
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;t2&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">t2</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t2</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#8f5902;font-style:italic">// t2 false 0
</span></span></span></code></pre></div><p>在上述的声明中，</p>
<ul>
<li>t1 未初始化，所以它是 nil</li>
<li>t2 已经初始化了一个底层数组，底层数组的长度是0，所以它不是 nil</li>
</ul>
<h2 id="参考链接">参考链接</h2>
<ul>
<li><a href="https://ieevee.com/tech/2019/07/26/slice-nil-empty.html">小贴士：Golang的空数组是否为nil</a></li>
</ul>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-5e7f1bf4777000a4a638a29b3b04d48f">16.11 - Golang 链接时注入额外信息</h1>
    
	<blockquote>
<p>Go 编译器注入 git 版本，时间等信息到可执行文件中</p>
</blockquote>
<hr>
<h2 id="go-链接时的--x-选项">Go 链接时的 -X 选项</h2>
<blockquote>
<p>-X importpath.name=value</p>
<p>Set the value of the string variable in importpath named name to value.
This is only effective if the variable is declared in the source code either uninitialized
or initialized to a constant string expression. -X will not work if the initializer makes
a function call or refers to other variables.
Note that before Go 1.5 this option took two separate arguments.</p>
</blockquote>
<p><strong>链接:</strong> go 编译工具读取 package main 和它的依赖(是 archive 文件或对象)，将它们组合在一起生成一个可执行文件。</p>
<p>Go 在链接时支持 <code>-X</code> 选项，它的用法为 <code>-X importpath.name=value</code>，它将会替换 <strong>字符串变量</strong> <code>importpath.name</code>的值，将其设置为<code>value</code>。</p>
<ul>
<li>
<p><strong>注意1</strong>: 只有在<code>importpath.name</code>未初始化或者初始化为常量字符串的时候才会生效。如果 <code>importpath.name</code> 是通过一个函数调用或者变量来初始化的话，<code>-X</code>选项将不会生效。</p>
</li>
<li>
<p><strong>注意2</strong>: <code>value</code>中有空格时， -X 后面的值都要用单引号包起来，例如 <code>-X '${REPO_PATH}/version.BuildTimeStamp=${BuildTimeStamp} UTC'</code></p>
</li>
<li>
<p><strong>注意3</strong>: Go 1.5 版本以下 -X 选项的格式是 <code>-X importpath.name value</code></p>
</li>
</ul>
<h2 id="运行效果">运行效果</h2>
<ul>
<li>源码: <a href="https://github.com/bwangelme/build_git_version">bwangelme/build_git_version</a></li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>ø&gt; ./build.sh <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> ./bin/runme
</span></span><span style="display:flex;"><span>Git Version c530ca1
</span></span><span style="display:flex;"><span>Build TimeStamp 2021-05-07_04:01:35AM UTC
</span></span><span style="display:flex;"><span>Build Go Version go version go1.16 darwin/amd64
</span></span></code></pre></div><h2 id="参考链接">参考链接</h2>
<ul>
<li><a href="https://golang.org/cmd/link/">Go cmd Link</a></li>
<li><a href="https://ms2008.github.io/2018/10/08/golang-build-version/">Golang -ldflags 的一个技巧 go version 信息注入</a></li>
<li><a href="https://groups.google.com/forum/#!topic/golang-nuts/aNDB4FrmEiA">v1.5 -ldflags -X change breaks when string has a space</a></li>
</ul>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-495e45c0b281c859ecdd31687f35d51b">16.12 - 《Golang Error》学习笔记</h1>
    
	<blockquote>
<p>Golang Error 学习笔记</p>
</blockquote>
<hr>
<h2 id="panic-的使用场景">Panic 的使用场景</h2>
<ol>
<li>MySQL 无法链接，redis 可以连接，这时候是可以启动 <strong>读多写少</strong> 的服务的，不用强制 panic ，因为此时服务还是能够通过缓存来工作，数据无法写入，也不会导致写入脏数据。</li>
<li>配置文件检查失败时，可以执行 Panic</li>
<li>依赖的 RPC 无法启动时，可以先启动，但是服务会大量报错。</li>
</ol>
<p>对于真正出意外的情况，表示不可恢复的程序错误，例如索引越界，不可回复的环境问题，栈溢出，我们才使用 <code>panic</code>，逻辑上的错误，我们应该使用 error 来进行判断。</p>
<blockquote>
<p>You only need to check the error value if you care about the result &ndash; Dave</p>
</blockquote>
<h2 id="sentinel-error">Sentinel Error</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">os</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ErrInvalid</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">errInvalid</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#8f5902;font-style:italic">// &#34;invalid argument&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ErrPermission</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">errPermission</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#8f5902;font-style:italic">// &#34;permission denied&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">ErrExist</span>      <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">errExist</span><span style="color:#000;font-weight:bold">()</span>      <span style="color:#8f5902;font-style:italic">// &#34;file already exists&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">ErrNotExist</span>   <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">errNotExist</span><span style="color:#000;font-weight:bold">()</span>   <span style="color:#8f5902;font-style:italic">// &#34;file does not exist&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">ErrClosed</span>     <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">errClosed</span><span style="color:#000;font-weight:bold">()</span>     <span style="color:#8f5902;font-style:italic">// &#34;file already closed&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">ErrNoDeadline</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">errNoDeadline</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#8f5902;font-style:italic">// &#34;file type does not support deadline&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>预定义的特定错误，我们叫做 <code>Sentinel Error</code>。</p>
<ol>
<li>Sentinel Error 会成为 API 的公共部分。</li>
<li>Sentinel Error 在两个包之间创建了依赖。</li>
<li>Sentinel Error 让调用者无法返回更多的信息。</li>
</ol>
<p>应该尽可能避免 Sentinel Error。</p>
<h2 id="struct-error">Struct Error</h2>
<p>定义一个结构体实现 error 接口，里面包含了相关的上下文信息</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">net</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">OpError</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// Op is the operation which caused the error, such as
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// &#34;read&#34; or &#34;write&#34;.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">Op</span> <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// Net is the network type on which this error occurred,
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// such as &#34;tcp&#34; or &#34;udp6&#34;.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">Net</span> <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// For operations involving a remote network connection, like
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// Dial, Read, or Write, Source is the corresponding local
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// network address.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">Source</span> <span style="color:#000">Addr</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// Addr is the network address for which this error occurred.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// For local operations, like Listen or SetDeadline, Addr is
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// the address of the local endpoint being manipulated.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// For operations involving a remote network connection, like
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// Dial, Read, or Write, Addr is the remote address of that
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// connection.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">Addr</span> <span style="color:#000">Addr</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// Err is the error that occurred during the operation.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">Err</span> <span style="color:#204a87;font-weight:bold">error</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="opaque-error">Opaque Error</h2>
<p>对外暴露一个函数来检测错误的信息，而不是直接暴露 Error 类型给外部。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">temporary</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">Temporary</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">bool</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">IsTemporary</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">bool</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">te</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ok</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">.(</span><span style="color:#000">temporary</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">ok</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">te</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Temporary</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="通过消除错误来优化错误处理代码">通过消除错误来优化错误处理代码</h2>
<ul>
<li>原始代码</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Header</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Value</span> <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Status</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Code</span>   <span style="color:#204a87;font-weight:bold">int</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Reason</span> <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">BadWriteResponse</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">w</span> <span style="color:#000">io</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Writer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">st</span> <span style="color:#000">Status</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">headers</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#000">Header</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">body</span> <span style="color:#000">io</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Reader</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">w</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;HTTP/1.1 %d %s\r\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">st</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Code</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">st</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Reason</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">h</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">headers</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">w</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;%s: %s\r\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">h</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">h</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Value</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">w</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;\r\n&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">io</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Copy</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">w</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">body</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><ul>
<li>优化后的代码</li>
</ul>
<p>通过将错误状态存储起来，后续的调用，如果有错误状态的话，那就不执行写入。
最后将错误状态返回，错误状态存储的是第一个遇到的错误值，所以这里的代码和原始代码的效果是一样的。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">errWriter</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">io</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Writer</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">e</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">errWriter</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Write</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">buf</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">byte</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">e</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">e</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">n</span> <span style="color:#204a87;font-weight:bold">int</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">n</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">e</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">e</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Writer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Write</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">buf</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">n</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">GoodWriteResponse</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">w</span> <span style="color:#000">io</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Writer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">st</span> <span style="color:#000">Status</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">headers</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#000">Header</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">body</span> <span style="color:#000">io</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Reader</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ew</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">errWriter</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">Writer</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">w</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ew</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;HTTP/1.1 %d %s\r\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">st</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Code</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">st</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Reason</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">h</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">headers</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ew</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;%s: %s\r\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">h</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">h</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Value</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ew</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;\r\n&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">io</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Copy</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ew</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">body</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">ew</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">err</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="wrap-errors">Wrap Errors</h2>
<blockquote>
<p>You should only handle errors once. Handing an error means inspecting the error value, and making a single decision.</p>
</blockquote>
<p>Go 中的错误处理有契约约定，在出现错误的情况下，不能对其他返回值的内容作出任何假设。</p>
<p>如果代码要吞掉 error，那么也要对相应的返回值负责(例如返回降级后的默认值)。</p>
<p>日志记录与错误无关且对调试没有帮助的信息应该被视为噪音，应予以质疑。
记录的原因是因为某些东西失败了，且日志中应该包含了答案。</p>
<ul>
<li>错误要被日志记录</li>
<li>应用程序通过日志记录错误，返回一个降级的值(保证100%的完整性)，且不再往上抛错误</li>
<li>应用程序单纯地将错误往上抛，不需要做任何处理</li>
</ul>
<h3 id="pkg-errors-库">pkg errors 库</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">ReadFile</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">path</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">([]</span><span style="color:#204a87;font-weight:bold">byte</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">f</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Open</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">path</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">errors</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Wrap</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;open failed&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">f</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Close</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">buf</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">ioutil</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ReadAll</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">f</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">errors</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Wrap</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;read failed&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">buf</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">ReadConfig</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">([]</span><span style="color:#204a87;font-weight:bold">byte</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">home</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Getenv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;HOME&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">config</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">ReadFile</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">filepath</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Join</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">home</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;.settings.xml&#34;</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">config</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">errors</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WithMessage</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;counld not read config&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">ReadConfig</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#8f5902;font-style:italic">// Cause 会拿到最底层的错误
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>            <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;original error: %T %v\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">errors</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Cause</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">errors</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Cause</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>            <span style="color:#8f5902;font-style:italic">// %+v 会打印堆栈信息
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>            <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;stack trace:\n%+v\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Exit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><ul>
<li>输出</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>ø&gt; go run pkgerror.go
</span></span><span style="display:flex;"><span>original error: *os.PathError open /home/xuyundong/.settings.xml: no such file or directory
</span></span><span style="display:flex;"><span>stack trace:
</span></span><span style="display:flex;"><span>open /home/xuyundong/.settings.xml: no such file or directory  <span style="color:#8f5902;font-style:italic"># 这是原始错误</span>
</span></span><span style="display:flex;"><span>open failed  <span style="color:#8f5902;font-style:italic"># 这是原始错误包装后的信息</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 下面是堆栈信息</span>
</span></span><span style="display:flex;"><span>main.ReadFile
</span></span><span style="display:flex;"><span>        /home/xuyundong/Github/Golang/GoDemo/pkgerror.go:15
</span></span><span style="display:flex;"><span>main.ReadConfig
</span></span><span style="display:flex;"><span>        /home/xuyundong/Github/Golang/GoDemo/pkgerror.go:28
</span></span><span style="display:flex;"><span>main.main
</span></span><span style="display:flex;"><span>        /home/xuyundong/Github/Golang/GoDemo/pkgerror.go:33
</span></span><span style="display:flex;"><span>runtime.main
</span></span><span style="display:flex;"><span>        /home/xuyundong/.local/go/src/runtime/proc.go:204
</span></span><span style="display:flex;"><span>runtime.goexit
</span></span><span style="display:flex;"><span>        /home/xuyundong/.local/go/src/runtime/asm_amd64.s:1374
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 这是在 wraperror 上又包装的信息</span>
</span></span><span style="display:flex;"><span>counld not <span style="color:#204a87">read</span> config
</span></span><span style="display:flex;"><span><span style="color:#204a87">exit</span> status <span style="color:#0000cf;font-weight:bold">1</span>
</span></span></code></pre></div><h3 id="pkg-errors-使用规则">pkg-errors 使用规则</h3>
<ul>
<li>在应用代码中，使用 errors.New 或者 errors.Errorf 返回错误</li>
<li>如果调用其他包内的函数(其他包已经保持了堆栈信息)，通常简单的直接返回</li>
<li>如果和第三方库进行协作(Github 第三方库，公司基础库, 标准库，没有保存堆栈信息)，考虑使用 <code>errors.Wrap</code> 保存根 err 和堆栈信息</li>
<li>直接返回错误，而不是在每个错误产生的地方打日志</li>
<li>在程序的顶部，或者工作的 goroutine 顶部(请求入口)，使用 <code>%+v</code> 将堆栈信息打印出来</li>
<li>可以使用 <code>errors.Cause</code> 获取根 err，将 sentinel error 进行对比</li>
</ul>
<p><strong>注意:</strong></p>
<ol>
<li><code>Packages that are reusable across many projects only return root error values</code> 基础库(重用性高)不应该 wrap error，只有应用库适合 wrap error</li>
<li><code>if the error is not going to be handled, wrap and return up the call stack</code> 如果不打算处理错误的话(降级错误)，那么应该 wrap 起来继续往上抛，额外的上下文可以是输入的参数或者失败的 SQL 语句。</li>
<li><code>Once an error is handled, it is not allowed to be passed up the call stack any longer.</code> 一旦一个错误被处理过了，那就不应该继续往上抛了，返回一个降级的值就可以了。</li>
</ol>
<h2 id="go-113-中新增的错误处理方法">Go 1.13 中新增的错误处理方法</h2>
<p>pkg-errors 的作者 <a href="https://github.com/davecheney">Dave</a> 的意见被 Go 官方采纳，Go 1.13 中新增了一些错误的处理方法 <code>Unwrap</code>，<code>Is</code> 和 <code>As</code></p>
<ul>
<li><code>Is</code> 类似于 Python 中的 <code>isubclass</code></li>
<li><code>As</code> 是检查 error 是否是某个特定类型的 error，如果是的话，那么就返回true，且将参数设置为对应类型的 error</li>
<li><code>fmt.Errorf</code> 新增 <code>%w</code> 格式字符串，可以将原始错误包裹起来。<a href="https://github.com/bwangelme/go-1.13/blob/6ece83485f77117120693f16ff516c768a31c02a/src/fmt/errors.go#L32">相关源代码</a></li>
</ul>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-6be775a3d57f960eb07e45a142768f29">16.13 - Go 的调度模型学习笔记</h1>
    
	<blockquote>
<p>阅读 <a href="https://wudaijun.com/2018/01/go-scheduler/">Go 调度模型</a> 后记的笔记</p>
</blockquote>
<hr>
<h2 id="gpm-模型">GPM 模型</h2>
<ul>
<li>G: 每个Goroutine都会对应一个 <a href="https://github.com/bwangelme/go-1.13/blob/6ece83485f77117120693f16ff516c768a31c02a/src/runtime/runtime2.go#L387-L386">G 结构体</a>，它保存了函数执行的栈。</li>
<li>P: Processor，逻辑上的处理器，对应 <a href="https://github.com/bwangelme/go-1.13/blob/6ece83485f77117120693f16ff516c768a31c02a/src/runtime/runtime2.go#L523">P 结构体</a>。在 Go 程序启动后，会创建和CPU内核数相等的 P。用户可以通过<code>GOMAXPROCS</code>调整P的数量，不过这个函数会 <a href="https://github.com/bwangelme/go-1.13/blob/6ece83485f77117120693f16ff516c768a31c02a/src/runtime/debug.go#L29">STW</a>，尽量少调用这个函数。</li>
<li>M: Machine, 对应 <a href="https://github.com/bwangelme/go-1.13/blob/6ece83485f77117120693f16ff516c768a31c02a/src/runtime/runtime2.go#L452">M 结构体</a>，通过 <a href="http://man7.org/linux/man-pages/man2/clone.2.html">clone</a> 创建的系统级线程，任务的实际执行者。G 和 P 绑定后， P 会放到 M 上执行，M 不保存 G 的状态，所以 G 可以跨 M 执行。</li>
</ul>
<ul>
<li><code>GRQ</code>: Globale Runable Queue，Goroutine 的全局运行队列</li>
<li><code>LRQ</code>: Local Runable Queue， P 本地保存的 Goroutine 运行队列</li>
</ul>
<p>Goroutine 创建后，会创建一个G对象，它会先尝试加入到 P 的 runnext中，如果不行的话，会接着尝试 P 的 LRQ，如果仍然不行，会放入到 GRQ 中，同时将当前P的 LRQ 中的一半任务放入到 GRQ 中。</p>
<p>P 运行时会从 LRQ 中取出一个 G，和它绑定到一起，在 M 上运行。
P取 G 的顺序是: <code>LRQ &gt; GRQ &gt; 从其他 P 偷 G</code></p>
<h2 id="用户态的阻塞唤醒">用户态的阻塞/唤醒</h2>
<p>当 G 在用户态阻塞的时候(例如从 channel 读/写)，会将当前 G 的状态从 Running 改为 Wait，同时将 G 放入到一个 wait 队列中(例如 channel 的 wait 队列)。</p>
<p>当 G 被另外一个 G2 唤醒时(通过 <a href="https://github.com/bwangelme/go-1.13/blob/6ece83485f77117120693f16ff516c768a31c02a/src/runtime/chan.go#L299">goready 函数</a>)，那么 G 就会尝试加入到 G2 所在 P 的 runnext 中，如果不成的话，会依次尝试 LRQ 和 GRQ。</p>
<h2 id="系统态的阻塞唤醒">系统态的阻塞/唤醒</h2>
<p>当 G 在 M 上执行系统调用后，它会阻塞，并将状态设置为 syscall 状态。M 也会进行阻塞。G 所绑定的 P 会和当前 G 和 M 解绑，寻找空闲 M，或创建新的 M，继续运行它队列中的其他 G .</p>
<p>当 M 执行完系统调用后，G 会重新寻找一个空闲的 P，进行运行，如果没有空闲的 P，那么它就会进入 GRQ。</p>
<h2 id="netpoller">NetPoller</h2>
<p>Go 将 epoll 进行了包装(使用了垂直触发)，会单独创建一个名为 NetPoller 的 M 异步处理网络IO，它不需要和 P 进行绑定。</p>
<p>当 G 执行网络 IO 的时候，G 会将当前 M 和 P 解绑，进入到 NetPoller 的 M 中，等待网络 IO 完成，这样即使执行网络 IO 的系统调用，也不会产生阻塞的 M.</p>
<p>当网络 IO 完成后，M 的 Schedule 函数，会通过 <a href="https://github.com/bwangelme/go-1.13/blob/6ece83485f77117120693f16ff516c768a31c02a/src/runtime/proc.go#L2210">findrunable函数</a> 取到这个 G，继续运行它。</p>
<h2 id="抢占式调度">抢占式调度</h2>
<p>当 G 执行的时间超过 10ms 时，一个名为 sysmon 的 M 就会向其发起抢占式调度。由于 Go 是用户态的代码，并没有时间片和硬中断的概念，所以 Go 抢占式调度的方式是运行方主动将自己挂起。</p>
<p>sysmon 如果要抢占某个 G 的执行权，那么就会设置它的抢占标记(<a href="https://github.com/bwangelme/go-1.13/blob/6ece83485f77117120693f16ff516c768a31c02a/src/runtime/runtime2.go#L396">g.stackguard0</a>)。G 在执行函数的时候(具体来说是 <a href="https://github.com/bwangelme/go-1.13/blob/6ece83485f77117120693f16ff516c768a31c02a/src/runtime/stack.go#L916">newstack函数</a>)，会检查抢占标记，如果这个标记已经被设置了，那么它就会通过 <a href="https://github.com/bwangelme/go-1.13/blob/6ece83485f77117120693f16ff516c768a31c02a/src/runtime/stack.go#L1036-L1038">Gosched</a> 的方式将自己放到 GRQ 中，重新等待执行。</p>
<h2 id="参考链接">参考链接</h2>
<ol>
<li><a href="https://wudaijun.com/2018/01/go-scheduler/">Go 调度模型</a></li>
<li><a href="https://www.youtube.com/watch?v=oFJL8S1dwsw">#64 深入浅出 Golang Runtime</a></li>
<li><a href="https://speakerdeck.com/retervision/go-runtime-scheduler">Go Runtime Scheduler</a></li>
<li><a href="https://colobu.com/2017/05/04/go-scheduler/">[译]Go 调度器: M, P 和 G</a></li>
<li><a href="https://studygolang.com/articles/16407">Golang并发原理及GPM调度策略（一）</a></li>
<li><a href="https://github.com/bwangelme/go-1.13/blob/master/src/runtime/runtime2.go">Go 代码 runtime/runtime2.go runtime/proc.go runtime/stack.go</a></li>
</ol>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-178be9a96e629507fb20f27aff2c9a50">16.14 - Golang 中的 ServeMux 路由简介</h1>
    
	<blockquote>
<p>简单介绍了一下 Golang 中 ServeMux 的功能以及路由方式。</p>
</blockquote>
<hr>
<h2 id="功能简介">功能简介</h2>
<p>根据 <a href="https://golang.org/pkg/net/http/#ServeMux">Golang 文档</a> 中的介绍，ServeMux 是一个 HTTP 请求多路复用器(<code>HTTP Request multiplexer</code>)。</p>
<p>具体来说，它主要有以下两个功能:</p>
<ol>
<li>路由功能，将请求的 URL 与一组已经注册的路由模式(<code>pattern</code>)进行匹配，并选择一个最接近模式，调用其处理函数。</li>
<li>它会清理请求 URL 与 <code>Host</code> 请求头，清除端口号，并对包含 <code>..</code> 和重复<code>/</code>的URL进行处理。</li>
</ol>
<h2 id="注册名字固定的路径">注册名字固定的路径</h2>
<p>ServeMux 注册路由模式的方式有两种，<code>注册名字固定的路径</code>与<code>注册根路径子树</code>。</p>
<p><code>注册名字固定的路径</code>就是指定一个固定的 URL 和请求进行精确匹配。需要注意的是 <code>/</code> 路由模式会匹配所有未被其他路由模式匹配的请求。</p>
<p>例如下面的代码，请求<code>/a</code>会匹配<code>/a</code>路由模式，请求<code>/abc</code>会匹配<code>/</code>路由模式。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;net/http&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HandleFunc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/a&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">writer</span> <span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ResponseWriter</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">request</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Request</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fprintln</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">writer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;/a&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">request</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">URL</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EscapedPath</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HandleFunc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">writer</span> <span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ResponseWriter</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">request</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Request</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fprintln</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">writer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;default&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">request</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">URL</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EscapedPath</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatalln</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListenAndServe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;:8080&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>&gt;&gt;&gt; curl <span style="color:#4e9a06">&#39;localhost:8080/a&#39;</span>
</span></span><span style="display:flex;"><span>/a /a
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; curl <span style="color:#4e9a06">&#39;localhost:8080/abc&#39;</span>
</span></span><span style="display:flex;"><span>default /abc
</span></span></code></pre></div><h2 id="注册根路径子树">注册根路径子树</h2>
<p><code>注册根路径子树</code>就是注册一个子路径，所有以这个子路径开头的请求都会转发到对应的 handler 中。注意子路径__必须__以 <code>/</code> 结尾。</p>
<p>例如下面的代码中，所有以 <code>/user/</code> 开头的请求，都会被匹配。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;net/http&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HandleFunc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/user/&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">writer</span> <span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ResponseWriter</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">request</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Request</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fprintln</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">writer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;user&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">request</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">URL</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EscapedPath</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatalln</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListenAndServe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;:8080&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>&gt;&gt;&gt; curl <span style="color:#4e9a06">&#39;0.0.0.0:8080/user/1&#39;</span>
</span></span><span style="display:flex;"><span>user /user/1
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; curl <span style="color:#4e9a06">&#39;0.0.0.0:8080/user/2&#39;</span>
</span></span><span style="display:flex;"><span>user /user/2
</span></span></code></pre></div><h3 id="最长匹配">最长匹配</h3>
<p><code>注册根路径子树</code>是符合最长路径匹配的原则的，例如我们注册了两个子路径，<code>/image/gif/</code>和<code>/image/</code>，URL 为<code>/image/gif/</code>的请求会优先匹配第一个路由模式。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;net/http&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 注意我把 /image/ 写在了前面
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HandleFunc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/image/&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">writer</span> <span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ResponseWriter</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">request</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Request</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fprintln</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">writer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;image&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">request</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">URL</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EscapedPath</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HandleFunc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/image/gif/&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">writer</span> <span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ResponseWriter</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">request</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Request</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fprintln</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">writer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;gif&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">request</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">URL</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EscapedPath</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatalln</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListenAndServe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;:8080&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>&gt;&gt;&gt; curl <span style="color:#4e9a06">&#39;0.0.0.0:8080/image/gif/&#39;</span>
</span></span><span style="display:flex;"><span>gif /image/gif/
</span></span></code></pre></div><h3 id="append_slash"><code>APPEND_SLASH</code></h3>
<p><code>APPEND_SLASH</code>是 Django 中的一个配置，是指如果我们注册了一个路由模式<code>/something/</code>，且<code>APPEND_SLASH=True</code>的话，那么 URL 为 <code>/something</code> 的请求会自动重定向为<code>/something/</code>。</p>
<p><code>注册根路径子树</code>默认也是有这种功能的，请看下面的代码:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;net/http&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HandleFunc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/image/&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">writer</span> <span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ResponseWriter</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">request</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Request</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fprintln</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">writer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;image&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">request</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">URL</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EscapedPath</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatalln</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListenAndServe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;:8080&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>&gt;&gt;&gt; curl -v <span style="color:#4e9a06">&#39;0.0.0.0:8080/image&#39;</span>
</span></span><span style="display:flex;"><span>&gt; GET /image HTTP/1.1
</span></span><span style="display:flex;"><span>&gt; Host: 0.0.0.0:8080
</span></span><span style="display:flex;"><span>&gt; User-Agent: curl/7.64.1
</span></span><span style="display:flex;"><span>&gt; Accept: */*
</span></span><span style="display:flex;"><span>&gt;
</span></span><span style="display:flex;"><span>&lt; HTTP/1.1 <span style="color:#0000cf;font-weight:bold">301</span> Moved Permanently
</span></span><span style="display:flex;"><span>&lt; Content-Type: text/html<span style="color:#000;font-weight:bold">;</span> <span style="color:#000">charset</span><span style="color:#ce5c00;font-weight:bold">=</span>utf-8
</span></span><span style="display:flex;"><span>&lt; Location: /image/
</span></span><span style="display:flex;"><span>&lt; Date: Sat, <span style="color:#0000cf;font-weight:bold">30</span> Nov <span style="color:#0000cf;font-weight:bold">2019</span> 11:30:14 GMT
</span></span><span style="display:flex;"><span>&lt; Content-Length: <span style="color:#0000cf;font-weight:bold">42</span>
</span></span><span style="display:flex;"><span>&lt;
</span></span><span style="display:flex;"><span>&lt;a <span style="color:#000">href</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;/image/&#34;</span>&gt;Moved Permanently&lt;/a&gt;.
</span></span></code></pre></div><p>我们注册了子路径<code>/image/</code>，服务器会自动将<code>/image</code>请求重定向为<code>/image/</code>。</p>
<p>如果我们不想让服务器自动重定向的话，只需要添加一个<code>/image</code>模式就好了。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;net/http&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HandleFunc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/image/&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">writer</span> <span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ResponseWriter</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">request</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Request</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fprintln</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">writer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;sub image&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">request</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">URL</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EscapedPath</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HandleFunc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/image&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">writer</span> <span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ResponseWriter</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">request</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Request</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fprintln</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">writer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;image&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">request</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">URL</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EscapedPath</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatalln</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListenAndServe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;:8080&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>&gt;&gt;&gt; curl <span style="color:#4e9a06">&#39;0.0.0.0:8080/image&#39;</span>
</span></span><span style="display:flex;"><span>image /image
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; curl <span style="color:#4e9a06">&#39;0.0.0.0:8080/image/&#39;</span>
</span></span><span style="display:flex;"><span>sub image /image/
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; curl <span style="color:#4e9a06">&#39;0.0.0.0:8080/image/gif&#39;</span>
</span></span><span style="display:flex;"><span>sub image /image/gif
</span></span></code></pre></div><h2 id="使用域名匹配">使用域名匹配</h2>
<p>ServeMux 还支持根据主机名精确匹配，没有指定主机名的路径<code>/</code>路由模式将会是所有未匹配请求的缺省值。</p>
<p>下面的代码中，主机名为 <code>localhost</code> 请求将会默认匹配<code>localhost/</code>路由模式，其他主机名的请求会匹配<code>/</code>路由模式。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;net/http&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HandleFunc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;localhost/&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">writer</span> <span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ResponseWriter</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">request</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Request</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fprintln</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">writer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;localhost&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">request</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">URL</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EscapedPath</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HandleFunc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">writer</span> <span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ResponseWriter</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">request</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Request</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fprintln</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">writer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;default&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">request</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">URL</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EscapedPath</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatalln</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListenAndServe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;:8080&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>&gt;&gt;&gt; curl -v <span style="color:#4e9a06">&#39;127.0.0.1:8080/&#39;</span>
</span></span><span style="display:flex;"><span>&gt; GET / HTTP/1.1
</span></span><span style="display:flex;"><span>&gt; Host: 127.0.0.1:8080
</span></span><span style="display:flex;"><span>&gt; User-Agent: curl/7.64.1
</span></span><span style="display:flex;"><span>&gt; Accept: */*
</span></span><span style="display:flex;"><span>&gt;
</span></span><span style="display:flex;"><span>&lt; HTTP/1.1 <span style="color:#0000cf;font-weight:bold">200</span> OK
</span></span><span style="display:flex;"><span>&lt; Date: Sat, <span style="color:#0000cf;font-weight:bold">30</span> Nov <span style="color:#0000cf;font-weight:bold">2019</span> 11:39:04 GMT
</span></span><span style="display:flex;"><span>&lt; Content-Length: <span style="color:#0000cf;font-weight:bold">10</span>
</span></span><span style="display:flex;"><span>&lt; Content-Type: text/plain<span style="color:#000;font-weight:bold">;</span> <span style="color:#000">charset</span><span style="color:#ce5c00;font-weight:bold">=</span>utf-8
</span></span><span style="display:flex;"><span>&lt;
</span></span><span style="display:flex;"><span>default /
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; curl -v <span style="color:#4e9a06">&#39;0.0.0.0:8080/&#39;</span>
</span></span><span style="display:flex;"><span>&gt; GET / HTTP/1.1
</span></span><span style="display:flex;"><span>&gt; Host: 0.0.0.0:8080
</span></span><span style="display:flex;"><span>&gt; User-Agent: curl/7.64.1
</span></span><span style="display:flex;"><span>&gt; Accept: */*
</span></span><span style="display:flex;"><span>&gt;
</span></span><span style="display:flex;"><span>&lt; HTTP/1.1 <span style="color:#0000cf;font-weight:bold">200</span> OK
</span></span><span style="display:flex;"><span>&lt; Date: Sat, <span style="color:#0000cf;font-weight:bold">30</span> Nov <span style="color:#0000cf;font-weight:bold">2019</span> 11:39:14 GMT
</span></span><span style="display:flex;"><span>&lt; Content-Length: <span style="color:#0000cf;font-weight:bold">10</span>
</span></span><span style="display:flex;"><span>&lt; Content-Type: text/plain<span style="color:#000;font-weight:bold">;</span> <span style="color:#000">charset</span><span style="color:#ce5c00;font-weight:bold">=</span>utf-8
</span></span><span style="display:flex;"><span>&lt;
</span></span><span style="display:flex;"><span>default /
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; curl -v <span style="color:#4e9a06">&#39;localhost:8080/&#39;</span>
</span></span><span style="display:flex;"><span>&gt; GET / HTTP/1.1
</span></span><span style="display:flex;"><span>&gt; Host: localhost:8080
</span></span><span style="display:flex;"><span>&gt; User-Agent: curl/7.64.1
</span></span><span style="display:flex;"><span>&gt; Accept: */*
</span></span><span style="display:flex;"><span>&gt;
</span></span><span style="display:flex;"><span>&lt; HTTP/1.1 <span style="color:#0000cf;font-weight:bold">200</span> OK
</span></span><span style="display:flex;"><span>&lt; Date: Sat, <span style="color:#0000cf;font-weight:bold">30</span> Nov <span style="color:#0000cf;font-weight:bold">2019</span> 11:39:19 GMT
</span></span><span style="display:flex;"><span>&lt; Content-Length: <span style="color:#0000cf;font-weight:bold">12</span>
</span></span><span style="display:flex;"><span>&lt; Content-Type: text/plain<span style="color:#000;font-weight:bold">;</span> <span style="color:#000">charset</span><span style="color:#ce5c00;font-weight:bold">=</span>utf-8
</span></span><span style="display:flex;"><span>&lt;
</span></span><span style="display:flex;"><span>localhost /
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; curl -v <span style="color:#4e9a06">&#39;localhost:8080/abc&#39;</span>
</span></span><span style="display:flex;"><span>&gt; GET /abc HTTP/1.1
</span></span><span style="display:flex;"><span>&gt; Host: localhost:8080
</span></span><span style="display:flex;"><span>&gt; User-Agent: curl/7.64.1
</span></span><span style="display:flex;"><span>&gt; Accept: */*
</span></span><span style="display:flex;"><span>&gt;
</span></span><span style="display:flex;"><span>&lt; HTTP/1.1 <span style="color:#0000cf;font-weight:bold">200</span> OK
</span></span><span style="display:flex;"><span>&lt; Date: Sat, <span style="color:#0000cf;font-weight:bold">30</span> Nov <span style="color:#0000cf;font-weight:bold">2019</span> 12:01:47 GMT
</span></span><span style="display:flex;"><span>&lt; Content-Length: <span style="color:#0000cf;font-weight:bold">15</span>
</span></span><span style="display:flex;"><span>&lt; Content-Type: text/plain<span style="color:#000;font-weight:bold">;</span> <span style="color:#000">charset</span><span style="color:#ce5c00;font-weight:bold">=</span>utf-8
</span></span><span style="display:flex;"><span>&lt;
</span></span><span style="display:flex;"><span>localhost /abc
</span></span></code></pre></div><h2 id="处理冗余的-url">处理冗余的 URL</h2>
<ul>
<li>针对 URL 中包含<code>..</code>的请求，ServeMux 会对其 Path 进行整理，并匹配到合适的路由模式上。</li>
<li>针对 URL 中包含重复<code>/</code>的请求，ServeMux 会对其进行重定向。</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;net/http&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HandleFunc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/image/png/1&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">writer</span> <span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ResponseWriter</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">request</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Request</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fprintln</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">writer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;default&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">request</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">URL</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">EscapedPath</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatalln</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListenAndServe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;:8080&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>&gt;&gt;&gt; curl -v <span style="color:#4e9a06">&#39;localhost:8080/image/gif/../png/1&#39;</span>
</span></span><span style="display:flex;"><span>&gt; GET /image/png/1 HTTP/1.1
</span></span><span style="display:flex;"><span>&gt; Host: localhost:8080
</span></span><span style="display:flex;"><span>&gt; User-Agent: curl/7.64.1
</span></span><span style="display:flex;"><span>&gt; Accept: */*
</span></span><span style="display:flex;"><span>&gt;
</span></span><span style="display:flex;"><span>&lt; HTTP/1.1 <span style="color:#0000cf;font-weight:bold">200</span> OK
</span></span><span style="display:flex;"><span>&lt; Date: Sat, <span style="color:#0000cf;font-weight:bold">30</span> Nov <span style="color:#0000cf;font-weight:bold">2019</span> 11:42:00 GMT
</span></span><span style="display:flex;"><span>&lt; Content-Length: <span style="color:#0000cf;font-weight:bold">23</span>
</span></span><span style="display:flex;"><span>&lt; Content-Type: text/plain<span style="color:#000;font-weight:bold">;</span> <span style="color:#000">charset</span><span style="color:#ce5c00;font-weight:bold">=</span>utf-8
</span></span><span style="display:flex;"><span>&lt;
</span></span><span style="display:flex;"><span>localhost /image/png/1
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; curl -v <span style="color:#4e9a06">&#39;localhost:8080/image/gif/../png//1&#39;</span>
</span></span><span style="display:flex;"><span>&gt; GET /image/png//1 HTTP/1.1
</span></span><span style="display:flex;"><span>&gt; Host: localhost:8080
</span></span><span style="display:flex;"><span>&gt; User-Agent: curl/7.64.1
</span></span><span style="display:flex;"><span>&gt; Accept: */*
</span></span><span style="display:flex;"><span>&gt;
</span></span><span style="display:flex;"><span>&lt; HTTP/1.1 <span style="color:#0000cf;font-weight:bold">301</span> Moved Permanently
</span></span><span style="display:flex;"><span>&lt; Content-Type: text/html<span style="color:#000;font-weight:bold">;</span> <span style="color:#000">charset</span><span style="color:#ce5c00;font-weight:bold">=</span>utf-8
</span></span><span style="display:flex;"><span>&lt; Location: /image/png/1
</span></span><span style="display:flex;"><span>&lt; Date: Sat, <span style="color:#0000cf;font-weight:bold">30</span> Nov <span style="color:#0000cf;font-weight:bold">2019</span> 11:42:14 GMT
</span></span><span style="display:flex;"><span>&lt; Content-Length: <span style="color:#0000cf;font-weight:bold">47</span>
</span></span><span style="display:flex;"><span>&lt;
</span></span><span style="display:flex;"><span>&lt;a <span style="color:#000">href</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;/image/png/1&#34;</span>&gt;Moved Permanently&lt;/a&gt;.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; curl -v <span style="color:#4e9a06">&#39;localhost:8080/image/png//1&#39;</span>
</span></span><span style="display:flex;"><span>&gt; GET /image/png//1 HTTP/1.1
</span></span><span style="display:flex;"><span>&gt; Host: localhost:8080
</span></span><span style="display:flex;"><span>&gt; User-Agent: curl/7.64.1
</span></span><span style="display:flex;"><span>&gt; Accept: */*
</span></span><span style="display:flex;"><span>&gt;
</span></span><span style="display:flex;"><span>&lt; HTTP/1.1 <span style="color:#0000cf;font-weight:bold">301</span> Moved Permanently
</span></span><span style="display:flex;"><span>&lt; Content-Type: text/html<span style="color:#000;font-weight:bold">;</span> <span style="color:#000">charset</span><span style="color:#ce5c00;font-weight:bold">=</span>utf-8
</span></span><span style="display:flex;"><span>&lt; Location: /image/png/1
</span></span><span style="display:flex;"><span>&lt; Date: Sat, <span style="color:#0000cf;font-weight:bold">30</span> Nov <span style="color:#0000cf;font-weight:bold">2019</span> 11:45:18 GMT
</span></span><span style="display:flex;"><span>&lt; Content-Length: <span style="color:#0000cf;font-weight:bold">47</span>
</span></span><span style="display:flex;"><span>&lt;
</span></span><span style="display:flex;"><span>&lt;a <span style="color:#000">href</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;/image/png/1&#34;</span>&gt;Moved Permanently&lt;/a&gt;.
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-36c9684d6cddd541223c056c73698ec0">16.15 - Review 《github.com/stretchr/testify》</h1>
    
	<blockquote>
<ul>
<li>原文地址: <a href="https://github.com/stretchr/testify">https://github.com/stretchr/testify</a></li>
</ul>
</blockquote>
<hr>
<p>testify 是一组工具包，它里面的很多工具可以让你更舒适地写 Go 测试代码。</p>
<p>它包含以下特征:</p>
<ul>
<li><a href="https://github.com/stretchr/testify#assert-package">更好用的 assert</a></li>
<li><a href="https://github.com/stretchr/testify#mock-package">Mocking</a></li>
<li><a href="https://github.com/stretchr/testify#suite-package">Testing suite 的接口和函数</a></li>
</ul>
<p>知识索引:</p>
<ul>
<li>使用<a href="https://github.com/stretchr/testify#installation">一行代码安装 testify</a>,使用<a href="https://github.com/stretchr/testify#staying-up-to-date">另一行代码</a>来更新它</li>
<li>在 Go 中写测试代码的相关介绍, 请参考 <a href="http://golang.org/doc/code.html#Testing">http://golang.org/doc/code.html#Testing</a></li>
<li>在 <a href="http://godoc.org/github.com/stretchr/testify">http://godoc.org/github.com/stretchr/testify</a> 查看我们的 API 文档</li>
<li>为了让你的测试生活更简单一些，建议使用我们开发的测试工具 <a href="http://github.com/stretchr/gorc">gorc</a></li>
<li>关于 <a href="http://en.wikipedia.org/wiki/Test-driven_development">Test-Driven Development (TDD)</a> 的一点点介绍</li>
</ul>
<h2 id="asserthttpgodocorggithubcomstretchrtestifyassert-包"><a href="http://godoc.org/github.com/stretchr/testify/assert">assert</a> 包</h2>
<p>assert 包提供了一些有用的方法，可以让你写出更友好的测试代码。它具有以下特性:</p>
<ul>
<li>打印友好，很容易去阅读错误信息</li>
<li>可以开发出易阅读的代码</li>
<li>可以在每个<code>assert</code>后添加一个可选的注解信息</li>
</ul>
<p>让我们通过一个实际例子来了解它:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">testify_exam</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;testing&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;github.com/stretchr/testify/assert&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">TestSomething</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">testing</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">T</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 测试相等
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">assert</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Equal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">123</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">123</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;they should be equal&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 测试不相等
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">assert</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NotEqual</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">123</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">456</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;they should not be equal&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">obj</span> <span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 测试 nil，常用于错误值的判断
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">assert</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Nil</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">obj</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">obj2</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Value</span> <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Value</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Something&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 测试不为 nil，常用于你希望返回的结果值拥有某些东西的时候
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">assert</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NotNil</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">obj2</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// 现在我们知道 obj2 的值不是 nil了，我们可以在这个基础上**安全地**访问它的字段。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">assert</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Equal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Something&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">obj2</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Value</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><ul>
<li>每个<code>assert</code>函数都使用 <code>testing.T</code> 来作为它的第一个参数，这就是它通过正常的 go 测试功能将错误输出写出来的方式。</li>
<li>每个<code>assert</code>函数返回了一个布尔值，表示这个断言成功与否，如果你想在某个断言结果的基础上做出更多的断言，可以用到它的返回值。</li>
</ul>
<p>如果你使用断言很多次，可以使用如下的代码:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">testify_exam</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;testing&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;github.com/stretchr/testify/assert&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">TestEasyAssert</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">testing</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">T</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">assert</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">assert</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">New</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">assert</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Equal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">123</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">123</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;they should be equal&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">assert</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NotEqual</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">123</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">456</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;they should not be equal&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">obj</span> <span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">assert</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Nil</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">obj</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">obj2</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Value</span> <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Value</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Something&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">assert</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NotNil</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">obj2</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">assert</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Equal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Something&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">obj2</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Value</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="requirehttpgodocorggithubcomstretchrtestifyrequire-包"><a href="http://godoc.org/github.com/stretchr/testify/require">require</a> 包</h2>
<p><code>require</code>包中拥有和<code>assert</code>包相同的全局函数，它和<code>assert</code>的不同在于，它不会再返回一个布尔值表示测试运行成功与否，而是直接结束当前测试</p>
<p>可以参考 <a href="http://golang.org/pkg/testing/#T.FailNow">t.FailNow</a> 函数了解更多的信息</p>
<p>下面是一个<code>require</code>包和<code>assert</code>包的比较示例:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">testify_exam</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;sync/atomic&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;testing&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;github.com/stretchr/testify/assert&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;github.com/stretchr/testify/require&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// `require.True` 失败后会将测试 TestEx1 停掉，不会再执行后面的 require.Equal 断言
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// `assert.True` 失败后并不会将 TestEx2 停掉，在后面的断言中，Add 依然会被执行，
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 所以 Add 会在 TestEx2 中执行一次， count 的最终结果是1
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">count</span> <span style="color:#204a87;font-weight:bold">int32</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">Add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">b</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">atomic</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddInt32</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">count</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">a</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">b</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">TestEx1</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">testing</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">T</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">require</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">True</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">require</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Equal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">TestEx2</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">testing</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">T</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">assert</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">True</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">assert</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Equal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">assert</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Equal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">count</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">int32</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 下面是程序的运行结果
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//&gt;&gt;&gt; go test -v testify_exam/require_test.go                                                                                                                      23:30:19 (06-02)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//=== RUN   TestEx1
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//--- FAIL: TestEx1 (0.00s)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//Error Trace:    require_test.go:19
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//Error:          Should be true
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//=== RUN   TestEx2
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//--- FAIL: TestEx2 (0.00s)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//Error Trace:    require_test.go:24
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//Error:          Should be true
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//FAIL
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//FAIL    command-line-arguments  0.018s
</span></span></span></code></pre></div><h2 id="mockhttpsgodocorggithubcomstretchrtestifymock-包"><a href="https://godoc.org/github.com/stretchr/testify/mock">mock</a> 包</h2>
<p><code>mock</code>提供了一种机制，可以在编写测试代码的时候轻松编写可用于替代实际对象的模拟对象。</p>
<p>下面是一段示例代码，它测试了一段依赖于外部对象<code>testObj</code>的代码，并且能够设置期望(<code>testify</code>)且断言他们确实发生了。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">yours</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;testing&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;github.com/stretchr/testify/mock&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">/*
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">  Test objects
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">*/</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// MyMockedObject is a mocked object that implements an interface
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// that describes an object that the code I am testing relies on.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">MyMockedObject</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">mock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Mock</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// DoSomething is a method on MyMockedObject that implements some interface
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// and just records the activity, and returns what the Mock object tells it to.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// In the real object, this method would do something useful, but since this
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// is a mocked object - we&#39;re just going to stub it out.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// NOTE: This method is not being tested here, code that uses this object is.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">m</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">MyMockedObject</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">DoSomething</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">number</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">bool</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">args</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Called</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">number</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Bool</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Error</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">/*
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">  Actual test functions
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">*/</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// TestSomething is an example of how to use our test object to
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// make assertions about some target code we are testing.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">TestSomething</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">testing</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">T</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// create an instance of our test object
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">testObj</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">new</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">MyMockedObject</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// set up expectations
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">testObj</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">On</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;DoSomething&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">123</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Return</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// call the code we are testing
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">targetFuncThatDoesSomethingWithObj</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">testObj</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// assert that the expectations were met
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">testObj</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AssertExpectations</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// TestSomethingWithPlaceholder is a second example of how to use our test object to
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// make assertions about some target code we are testing.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// This time using a placeholder. Placeholders might be used when the
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// data being passed in is normally dynamically generated and cannot be
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// predicted beforehand (eg. containing hashes that are time sensitive)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">TestSomethingWithPlaceholder</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">testing</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">T</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// create an instance of our test object
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">testObj</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">new</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">MyMockedObject</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// set up expectations with a placeholder in the argument list
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">testObj</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">On</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;DoSomething&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">mock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Anything</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Return</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// call the code we are testing
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">targetFuncThatDoesSomethingWithObj</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">testObj</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// assert that the expectations were met
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">testObj</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AssertExpectations</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// TestSomethingElse2 is a third example that shows how you can use
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// the Unset method to cleanup handlers and then add new ones.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">TestSomethingElse2</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">testing</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">T</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// create an instance of our test object
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">testObj</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">new</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">MyMockedObject</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// set up expectations with a placeholder in the argument list
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">mockCall</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">testObj</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">On</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;DoSomething&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">mock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Anything</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Return</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// call the code we are testing
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">targetFuncThatDoesSomethingWithObj</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">testObj</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// assert that the expectations were met
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">testObj</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AssertExpectations</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// remove the handler now so we can add another one that takes precedence
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">mockCall</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Unset</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// return false now instead of true
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">testObj</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">On</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;DoSomething&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">mock</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Anything</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Return</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">testObj</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AssertExpectations</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-e9992c55d10cbbee93c95c796a5e0152">16.16 - Go 并发模式之发布订阅模型</h1>
    
	<blockquote>
<p>发布订阅模型的一个简易单机实现</p>
</blockquote>
<hr>
<h2 id="前言">前言</h2>
<p>这是我在阅读《Go 高级编程》中看到的一个实现发布订阅的简单例子，并不是真正的发布订阅服务器，仅供参考。</p>
<h2 id="pubsub-说明">Pub/Sub 说明</h2>
<p>发布订阅并发模型通常由两部分组成，<code>Publisher</code>和<code>Subcriber</code>，<code>Subscriber</code>可以通过<code>Topic</code>仅订阅自己关心的消息。</p>
<p>在本文的示例中，我们将<code>chan interface{}</code>定义为<code>Subscriber</code>，将一个过滤函数定义成<code>Topic</code>。
<code>Subscriber</code>和它的<code>Topic</code>一起注册到<code>Publisher</code>中。</p>
<p><code>Publisher</code>写消息的时候，会将数据发给它所有注册的订阅者，订阅者通过<code>Topic</code>过滤掉自己不感兴趣的消息，将感兴趣的消息写入到 channel 中。</p>
<h2 id="程序代码">程序代码</h2>
<ul>
<li>pubsub.go</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">pubsub</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;sync&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Subscriber</span> <span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">TopicFunc</span>  <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">v</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#204a87;font-weight:bold">bool</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Publisher</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// subscribers 是程序的核心，订阅者都会注册在这里，publisher发布消息的时候也会从这里开始
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">subscribers</span> <span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">Subscriber</span><span style="color:#000;font-weight:bold">]</span><span style="color:#000">TopicFunc</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">buffer</span>      <span style="color:#204a87;font-weight:bold">int</span>           <span style="color:#8f5902;font-style:italic">// 订阅者的缓冲区长度
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">timeout</span>     <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Duration</span> <span style="color:#8f5902;font-style:italic">// publisher 发送消息的超时时间
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// m 用来保护 subscribers
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// 当修改 subscribers 的时候(即新加订阅者或删除订阅者)使用写锁
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// 当向某个订阅者发送消息的时候(即向某个 Subscriber channel 中写入数据)，使用读锁
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">m</span> <span style="color:#000">sync</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RWMutex</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">NewPublisher</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">publishTimeout</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Duration</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">buffer</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Publisher</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">Publisher</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">buffer</span><span style="color:#000;font-weight:bold">:</span>      <span style="color:#000">buffer</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">timeout</span><span style="color:#000;font-weight:bold">:</span>     <span style="color:#000">publishTimeout</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">subscribers</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">Subscriber</span><span style="color:#000;font-weight:bold">]</span><span style="color:#000">TopicFunc</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Publisher</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Subscribe</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">Subscriber</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SubscribeTopic</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Publisher</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">SubscribeTopic</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">topic</span> <span style="color:#000">TopicFunc</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Subscriber</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ch</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Subscriber</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">buffer</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Lock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">subscribers</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">ch</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">topic</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Unlock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">ch</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//Evict 删除掉某个订阅者
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Publisher</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Evict</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">sub</span> <span style="color:#000">Subscriber</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Lock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Unlock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87">delete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">subscribers</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">sub</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">sub</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Publisher</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Publish</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">v</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RLock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RUnlock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">wg</span> <span style="color:#000">sync</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WaitGroup</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 同时向所有订阅者写消息，订阅者利用 topic 过滤消息
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">sub</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">topic</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">subscribers</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">wg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">sendTopic</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">sub</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">topic</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">wg</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">wg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Wait</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//Close 关闭 Publisher，删除所有订阅者
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Publisher</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Close</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Lock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Unlock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">sub</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">subscribers</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87">delete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">subscribers</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">sub</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">sub</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Publisher</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">sendTopic</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">sub</span> <span style="color:#000">Subscriber</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">topic</span> <span style="color:#000">TopicFunc</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{},</span> <span style="color:#000">wg</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">sync</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WaitGroup</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">wg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Done</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">topic</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">topic</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">v</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">select</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">sub</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">v</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">After</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">timeout</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="相关测试代码">相关测试代码</h2>
<ul>
<li>pubsub_test.go</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">pubsub</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;runtime&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;strings&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;sync&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;sync/atomic&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;testing&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;github.com/stretchr/testify/assert&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">TestPubSub</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">testing</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">T</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">p</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">NewPublisher</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">100</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Millisecond</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Close</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// all 订阅者订阅所有消息
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">all</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Subscribe</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// golang 订阅者仅订阅包含 golang 的消息
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">golang</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SubscribeTopic</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">v</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#204a87;font-weight:bold">bool</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ok</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">v</span><span style="color:#000;font-weight:bold">.(</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">ok</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">strings</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Contains</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;golang&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Publish</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;hello, world!&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Publish</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;hello, golang!&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">wg</span> <span style="color:#000">sync</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WaitGroup</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">wg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">msg</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">all</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ok</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">msg</span><span style="color:#000;font-weight:bold">.(</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">assert</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">True</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ok</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">wg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Done</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">msg</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">golang</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">v</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ok</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">msg</span><span style="color:#000;font-weight:bold">.(</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">assert</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">True</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ok</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">assert</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">True</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">strings</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Contains</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">v</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;golang&#34;</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">wg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Done</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Close</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">wg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Wait</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="参考链接">参考链接</h2>
<ol>
<li><a href="https://chai2010.cn/advanced-go-programming-book/ch1-basic/ch1-06-goroutine.html">《Go 语言高级编程》&ndash; 常见的并发模式</a></li>
</ol>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-4919bce0c97dc0297f848829c794b4e8">16.17 - strings.Builder 转换字符串的时候为什么比 bytes.Buffer 要快</h1>
    
	<p><code>strings.Builder</code>和<code>bytes.Buffer</code>底层都是<code>[]byte</code>，
为什么<code>strings.Builder</code>的<code>String()</code>方法比<code>bytes.Buffer</code>的要快？</p>
<hr>
<h2 id="unsafepointer-的用法">unsafe.Pointer 的用法</h2>
<p><code>Pointer</code>类型代表了任意一种类型的指针，类型<code>Pointer</code>有四种专属的操作：</p>
<ul>
<li>任意类型的指针能够被转换成<code>Pointer</code>值</li>
<li>一个<code>Pointer</code>值能够被转换成任意类型的指针值</li>
<li>一个<code>uintptr</code>值能够被转换从<code>Pointer</code>值</li>
<li>一个<code>Pointer</code>值能够被转换成<code>uintptr</code>值</li>
</ul>
<p>因此<code>Pointer</code>类型允许一个程序绕过类型系统，读，写任意内存。它应该被非常谨慎地使用</p>
<p><code>Pointer</code>通过特定的模式来使用。如果某些代码不以 Go 文档中指定的模式来使用，Go 将无法保证它在现在或者未来是有效的
下面的每个模式都有非常重要的注意事项。</p>
<p>运行<code>go vet</code>命令可以检测<code>Pointer</code>的用法是否超出 Go 文档中指定的模式，
但是<code>go vet</code>没有检测到异常并不代表所检测的代码一定是有效的。</p>
<p>下面我们将简单介绍类型转换模式，更多的模式请参考 <a href="https://golang.org/pkg/unsafe/#Pointer">Go Pointer 文档</a></p>
<h3 id="类型转换模式">类型转换模式</h3>
<p>可以通过<code>*T1 =&gt; Pointer =&gt; *T2</code>的方式来完成类型转换。</p>
<p>需要保证<code>T2</code>的内存 &lt;= <code>T1</code>的内存，而且转换以后它们使用的是同一片内存数据。
这个转换允许将一片内存区中的数据从一种类型变成另外一种类型。
使用这个转换的一个例子是<code>math.Float64bits</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">Float64bits</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">f</span> <span style="color:#204a87;font-weight:bold">float64</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">uint64</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#204a87;font-weight:bold">uint64</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#000">unsafe</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pointer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">f</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="针对-byte-和-string-执行类型转换">针对 []byte 和 string 执行类型转换</h2>
<p>了解了类型转换模式后，我们来看一段 <code>[]byte</code> 转换成 <code>string</code> 的代码:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;unsafe&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">b</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">byte</span><span style="color:#000;font-weight:bold">{</span><span style="color:#4e9a06">&#39;H&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#39;E&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#39;L&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#39;L&#39;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#39;O&#39;</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">s</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#000">unsafe</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pointer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">b</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;b =&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">b</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;s =&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">b</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#4e9a06">&#39;B&#39;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;s =&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">s</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;WORLD&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;b =&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">b</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;s =&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">//b = [72 69 76 76 79]
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//s = HELLO
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//s = HBLLO
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//b = [72 66 76 76 79]
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//s = WORLD
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>可以看到，将<code>b []byte</code>转换成<code>s string</code>后，他们还是用同一片内存空间，
所以针对<code>b</code>的改变也会影响到<code>s</code>。
但是对<code>s</code>重新赋值后，它们所使用的内存空间不同了，所以<code>s</code>改变后，<code>b</code>并不会改变。</p>
<h2 id="比较-stringsbuilder-和-bytesbuffer">比较 strings.Builder 和 bytes.Buffer</h2>
<p><code>strings.Builder</code>和<code>bytes.Buffer</code>底层都是使用<code>[]byte</code>实现的，
但是<a href="https://gist.github.com/bwangelme/37facf96621fef19e2e70bce7a7b8457">性能测试的结果显示</a>，
执行<code>String()</code>函数的时候，<code>strings.Builder</code>却比<code>bytes.Buffer</code>快很多。</p>
<p>区别就在于 <code>bytes.Buffer</code> 是重新申请了一块空间，存放生成的<code>string</code>变量，
而<code>strings.Builder</code>直接将底层的<code>[]byte</code>转换成了<code>string</code>类型返回了回来。</p>
<p>在<code>bytes.Buffer</code>中也说明了，如果想更有效率地(<strong>efficiently</strong>)构建字符串，请使用<code>strings.Builder</code>类型</p>
<ul>
<li>bytes.Buffer</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// String returns the contents of the unread portion of the buffer
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// as a string. If the Buffer is a nil pointer, it returns &#34;&lt;nil&gt;&#34;.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// To build strings more efficiently, see the strings.Builder type.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">b</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Buffer</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">String</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">b</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// Special case, useful in debugging.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#4e9a06">&#34;&lt;nil&gt;&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87">string</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">b</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">buf</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">b</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">off</span><span style="color:#000;font-weight:bold">:])</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><ul>
<li>strings.Builder</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// String returns the accumulated string.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">b</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Builder</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">String</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#000">unsafe</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Pointer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">b</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">buf</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-e1a7e1284329bbee1f24564b5e0a8a09">16.18 - Review 《Golang Trick: Export unexport method for test》</h1>
    
	<blockquote>
<ul>
<li>原文地址: <a href="https://medium.com/@robiplus/golang-trick-export-for-test-aa16cbd7b8cd">https://medium.com/@robiplus/golang-trick-export-for-test-aa16cbd7b8cd</a></li>
</ul>
</blockquote>
<p>在 Go 语言中， 导出的标识符是以大写字母开头的，小写字母开头的标识符只可以在它所在的包中使用。我们在开发过程中，仅仅应该导出真正需要的标识符给调用者， 来让我们的API易于使用且易于维护。</p>
<h2 id="go-测试">Go 测试</h2>
<p>Go 中的测试代码通常写在源代码的旁边， 以<code>xxx_test.go</code>命名。例如我们的源码文件叫做<code>sum.go</code>，测试代码应该写 在<code>sum_test.go</code> 中。</p>
<p>在测试代码中命名<code>package</code>的时候，我们有两个选择。</p>
<ol>
<li>使用和源码文件相同的<code>package</code>名，例如源码文件和测试文件都是<code>package math</code></li>
<li>使用和源码文件不同的<code>package</code>名，通常是<code>xxx_test</code>。例如源码文件是<code>package math</code>，测试文件是<code>package math_test</code></li>
</ol>
<p>通常情况下，我们会选择第二种命名方式。因为测试文件和源码文件使用不同的<code>package</code>，被测代码就是一个黑盒，能够让我们专注地基于其 API(以大写字母开头的__导出标识符__) 进行开发，以帮助我们设计出更易用的 API 出来。</p>
<h2 id="export_testgo">export_test.go</h2>
<p>源码文件和测试文件使用不同的<code>package</code>名称，通常情况都是可以的，但在一些特殊 TestCase 下我们可能需要使用未导出的标识符，此时就需要<code>export_test.go</code>文件登场了。</p>
<p>整理一下，我们的需求是这样的:</p>
<ol>
<li>不将未导出标识符导出到生产代码中</li>
<li>将一些未导出标识符导出到测试代码中</li>
</ol>
<p>此时我们就可以将一些未__导出标识符__包裹成__导出标识符__，放到<code>export_test.go</code>文件中，供测试代码使用。</p>
<p><em>export_test.go</em> 文件仅仅在运行<code>go test</code>命令的时候会被包括进来，所以它不会污染包所提供的API，用户也无法访问到它(不像 Java 中的<code>@VisibleForTesting</code>)。</p>
<p>它建立了一座桥梁，让测试代码能够访问到未导出的标识符。</p>
<p><code>export_test.go</code>这个名字不是限定死的，也可以使用其他名字，但注意必须以<code>_test.go</code>结尾。</p>
<h2 id="使用-export_testgo-的实例">使用 export_test.go 的实例</h2>
<ul>
<li>包<code>math</code>的目录结构如下:</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>math
</span></span><span style="display:flex;"><span>├── export_test.go
</span></span><span style="display:flex;"><span>├── math.go
</span></span><span style="display:flex;"><span>└── math_test.go
</span></span></code></pre></div><ul>
<li><code>sum.go</code>文件中有未导出标识符<code>sum</code>函数</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//sum.go
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">math</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">sum</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">b</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">a</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">b</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">Name</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><ul>
<li><code>export_test.go</code>文件命名了<code>Sum</code>函数作为<code>sum</code>函数的副本</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//export_test.go
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">math</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">Sum</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">sum</span>
</span></span></code></pre></div><ul>
<li><code>sum_test.go</code>测试文件使用的包名是<code>package math_test</code>，它通过<code>export_test.go</code>访问到了<code>math</code>未导出的标识符<code>Sum</code></li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//sum_test.go
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">math_test</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;github.com/d5/tengo/assert&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;testing&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;xxx/math&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">TestName</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">testing</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">T</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">assert</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Equal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">math</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sum</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="go-标准库中的应用">Go 标准库中的应用</h2>
<p>在 Go 1.12的 strings 库中，存在以下定义</p>
<ol>
<li><code>search.go</code>中定义的函数<code>makeStringFinder</code>是未导出的。</li>
<li><code>search_test.go</code>和<code>search.go</code>使用了不同的<code>package</code>名称，分别是<code>strings</code>和<code>strings_test</code></li>
<li>为了让<code>search_test.go</code>中能够使用到<code>makeStringFinder</code>函数，在<code>export_test.go</code>中定义了<code>StringFind</code>函数，供其使用。</li>
</ol>
<p>以下是代码链接，大家可以参考阅读。</p>
<ul>
<li><a href="(https://github.com/golang/go/tree/release-branch.go1.12/src/strings)">strings 目录</a></li>
<li><a href="https://github.com/golang/go/blob/release-branch.go1.12/src/strings/search.go#L5">search.go</a></li>
<li><a href="https://github.com/golang/go/blob/release-branch.go1.12/src/strings/search_test.go#L5">search_test.go</a></li>
<li><a href="https://github.com/golang/go/blob/release-branch.go1.12/src/strings/export_test.go#L40-L42">export_test.go</a></li>
</ul>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-933310794a5909e0ef26a5c59969a86e">16.19 - urfave/cli 学习笔记</h1>
    
	<blockquote>
<ul>
<li>原文地址: <a href="https://github.com/urfave/cli/tree/v1.20.0#overview">https://github.com/urfave/cli/tree/v1.20.0#overview</a></li>
</ul>
</blockquote>
<h2 id="环境说明">环境说明</h2>
<table>
<thead>
<tr>
<th>Key</th>
<th>Value</th>
</tr>
</thead>
<tbody>
<tr>
<td>cli 版本</td>
<td>v1.20.0</td>
</tr>
<tr>
<td>cli Git Commit</td>
<td><a href="https://github.com/urfave/cli/commit/cfb38830724cc34fedffe9a2a29fb54fa9169cd1">cfb38830724cc34fedffe9a2a29fb54fa9169cd1</a></td>
</tr>
<tr>
<td>Go 版本</td>
<td>go version go1.11.5 darwin/amd64</td>
</tr>
</tbody>
</table>
<h2 id="指定版本">指定版本</h2>
<ul>
<li>指定<code>V2</code>版本(注意：V2 版本目前(2019年04月21日)还在开发中，属于<code>unstable</code>状态)</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ go get gopkg.in/urfave/cli.v2
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;gopkg.in/urfave/cli.v2&#34;</span> <span style="color:#8f5902;font-style:italic">// imports as package &#34;cli&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">...</span>
</span></span></code></pre></div><ul>
<li>指定<code>V1</code>版本</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ go get gopkg.in/urfave/cli.v1
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;gopkg.in/urfave/cli.v1&#34;</span> <span style="color:#8f5902;font-style:italic">// imports as package &#34;cli&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">...</span>
</span></span></code></pre></div><h2 id="基本用法">基本用法</h2>
<ul>
<li>下面的代码没有添加 command，只有一个默认的动作。</li>
<li>所有命令后跟着的参数都会被放到 <code>c.Args</code> 中</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;gopkg.in/urfave/cli.v1&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">app</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">cli</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewApp</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">app</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;watch&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">app</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Usage</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;fight the loneliness!&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">app</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Action</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">cli</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Hello %q!&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Args</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">app</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Args</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatalln</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="添加全局-flag">添加全局 flag</h2>
<ul>
<li>下面的代码中添加了全局的__flag__: <code>--lang</code></li>
<li>__flag__的<code>Value</code>既可以通过<code>Destination</code>属性存储到自定义变量中，也可以使用<code>c.String(&quot;lang&quot;)</code>的方式来获取</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;gopkg.in/urfave/cli.v1&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">app</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">cli</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewApp</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">language</span> <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">app</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Flags</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#000">cli</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Flag</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">cli</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StringFlag</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">Name</span><span style="color:#000;font-weight:bold">:</span>  <span style="color:#4e9a06">&#34;lang&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">Value</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;english&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">Usage</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;language for the greeting&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">Destination</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">language</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">app</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Action</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">cli</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">name</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#4e9a06">&#34;bwangel&#34;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NArg</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">name</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Args</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// if c.String(&#34;lang&#34;) == &#34;chinese&#34; {
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">language</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#34;chinese&#34;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;你好&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Hello&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">app</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Args</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatalln</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="在-usage-中放上占位符">在 Usage 中放上占位符</h2>
<ul>
<li>有时候我们想在<code>Usage</code>中放上__flag__的<code>Value</code>占位符，可以在<code>Usage</code>中放置反引号包裹的内容</li>
<li>这段代码输出的<code>Usage</code>如下:</li>
</ul>
<pre tabindex="0"><code>GLOBAL OPTIONS:
   --config YOUR_CONFIG_FILE, -c YOUR_CONFIG_FILE  Load configuration from YOUR_CONFIG_FILE
   --help, -h                                      show help
   --version, -v                                   print the version
</code></pre><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;gopkg.in/urfave/cli.v1&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">app</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">cli</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewApp</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">app</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Flags</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#000">cli</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Flag</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">cli</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StringFlag</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">Name</span><span style="color:#000;font-weight:bold">:</span>  <span style="color:#4e9a06">&#34;config, c&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">Usage</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Load configuration from `YOUR_CONFIG_FILE`&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">app</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Args</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatalln</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="flag-的别名">Flag 的别名</h2>
<ul>
<li>有时候我们想要让一个 flag 有多个名称，例如<code>language</code>, <code>lang</code>, <code>l</code>，可以在<code>Name</code>中指定多个由__逗号__分割的名称，cli 将会自动为其创建别名</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;gopkg.in/urfave/cli.v1&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">app</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">cli</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewApp</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">app</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;greet&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">app</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Usage</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;A greeting app&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">app</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Flags</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#000">cli</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Flag</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">cli</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StringFlag</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">Name</span><span style="color:#000;font-weight:bold">:</span>  <span style="color:#4e9a06">&#34;language, lang, l&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">Value</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;english&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">Usage</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;language for greeting&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">app</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Args</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatalln</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">//GLOBAL OPTIONS:
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//--language value, --lang value, -l value  language for greeting (default: &#34;english&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//--help, -h                                show help
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//--version, -v                             print the version
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><ul>
<li>注意，__同一个命令中的 flag 名称__不能被定义两次，否则将会导致 panic</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;gopkg.in/urfave/cli.v1&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">app</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">cli</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewApp</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">app</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;greet&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">app</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Usage</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;A greeting app&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">app</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Flags</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#000">cli</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Flag</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">cli</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StringFlag</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">Name</span><span style="color:#000;font-weight:bold">:</span>  <span style="color:#4e9a06">&#34;language, lang, l&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">Value</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;english&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">Usage</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;language for greeting&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">cli</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Int64Flag</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">Name</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;length, l&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">Value</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">Usage</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;length of users&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">app</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Args</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatalln</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">//Out
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//	&gt;&gt;&gt; go build &amp;&amp; ./watcher
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//	greet flag redefined: l
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//	panic: greet flag redefined: l
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//	goroutine 1 [running]:
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//	flag.(*FlagSet).Var(0xc000084180, 0x1175d40, 0xc000074018, 0x1153226, 0x1, 0x1153f78, 0xf)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//	/usr/local/opt/go/libexec/src/flag/flag.go:805 +0x529
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//	flag.(*FlagSet).Int64Var(0xc000084180, 0xc000074018, 0x1153226, 0x1, 0x0, 0x1153f78, 0xf)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//	/usr/local/opt/go/libexec/src/flag/flag.go:630 +0x71
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//	flag.(*FlagSet).Int64(0xc000084180, 0x1153226, 0x1, 0x0, 0x1153f78, 0xf, 0x1)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//	/usr/local/opt/go/libexec/src/flag/flag.go:643 +0x77
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//	gopkg.in/urfave/cli.v1.Int64Flag.ApplyWithError.func1(0x1153226, 0x1)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//	/Users/michaeltsui/go/pkg/mod/gopkg.in/urfave/cli.v1@v1.20.0/flag.go:488 +0xad
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//	gopkg.in/urfave/cli.v1.eachName(0x115321e, 0x9, 0xc0000a7b88)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//	/Users/michaeltsui/go/pkg/mod/gopkg.in/urfave/cli.v1@v1.20.0/flag.go:94 +0xc6
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//	gopkg.in/urfave/cli.v1.Int64Flag.ApplyWithError(0x115321e, 0x9, 0x1153f78, 0xf, 0x0, 0x0, 0x0, 0x0, 0x0, 0xc000084180, ...)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//	/Users/michaeltsui/go/pkg/mod/gopkg.in/urfave/cli.v1@v1.20.0/flag.go:483 +0x113
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//	gopkg.in/urfave/cli.v1.flagSet(0x115293c, 0x5, 0xc000076080, 0x4, 0x4, 0xc000062190, 0x1, 0x1)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//	/Users/michaeltsui/go/pkg/mod/gopkg.in/urfave/cli.v1@v1.20.0/flag.go:80 +0x128
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//	gopkg.in/urfave/cli.v1.(*App).Run(0xc000078340, 0xc000062190, 0x1, 0x1, 0x0, 0x0)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//	/Users/michaeltsui/go/pkg/mod/gopkg.in/urfave/cli.v1@v1.20.0/app.go:187 +0xfa
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//	main.main()
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//	/Users/michaeltsui/Github/Golang/watcher/main.go:28 +0x22d
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="排序">排序</h2>
<p><code>flags</code>和<code>commands</code>默认是根据定义的顺序展示的，但是如果让他们按照字母顺序输出，可以使用<code>FlagsByName</code>和<code>CommandsByName</code>和<code>sort</code>来排序。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;sort&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;gopkg.in/urfave/cli.v1&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">app</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">cli</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewApp</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">app</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Flags</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#000">cli</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Flag</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">cli</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StringFlag</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">Name</span><span style="color:#000;font-weight:bold">:</span>  <span style="color:#4e9a06">&#34;lang, l&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">Value</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;english&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">Usage</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Language for the greeting&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">cli</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StringFlag</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">Name</span><span style="color:#000;font-weight:bold">:</span>  <span style="color:#4e9a06">&#34;config, c&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">Usage</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Load configuration from `FILE`&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">app</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Commands</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#000">cli</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Command</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">Name</span><span style="color:#000;font-weight:bold">:</span>    <span style="color:#4e9a06">&#34;complete&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">Aliases</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">{</span><span style="color:#4e9a06">&#34;c&#34;</span><span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">Usage</span><span style="color:#000;font-weight:bold">:</span>   <span style="color:#4e9a06">&#34;complete a task on the list&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">Action</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">cli</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Command</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">Name</span><span style="color:#000;font-weight:bold">:</span>    <span style="color:#4e9a06">&#34;add&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">Aliases</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">{</span><span style="color:#4e9a06">&#34;a&#34;</span><span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">Usage</span><span style="color:#000;font-weight:bold">:</span>   <span style="color:#4e9a06">&#34;add a task to the list&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">Action</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">cli</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Command</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">sort</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sort</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cli</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FlagsByName</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">app</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Flags</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">sort</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sort</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cli</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CommandsByName</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">app</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Commands</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">app</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Args</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatalln</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">//Out
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//COMMANDS:
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//add, a       add a task to the list
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//complete, c  complete a task on the list
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//help, h      Shows a list of commands or help for one command
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//GLOBAL OPTIONS:
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//--config FILE, -c FILE  Load configuration from FILE
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//--lang value, -l value  Language for the greeting (default: &#34;english&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//--help, -h              show help
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//--version, -v           print the version
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="从环境变量中获取值">从环境变量中获取值</h2>
<ul>
<li>也可以通过<code>EnvVar</code>从环境变量中获取默认的值，可以使用<code>,</code>分割的方式匹配多个环境变量:</li>
<li>环境变量会按照从前往后的顺序匹配</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;strings&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;gopkg.in/urfave/cli.v1&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">app</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">cli</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewApp</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">app</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Flags</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#000">cli</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Flag</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">cli</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StringFlag</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">Name</span><span style="color:#000;font-weight:bold">:</span>   <span style="color:#4e9a06">&#34;lang, l&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">Value</span><span style="color:#000;font-weight:bold">:</span>  <span style="color:#4e9a06">&#34;english&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">Usage</span><span style="color:#000;font-weight:bold">:</span>  <span style="color:#4e9a06">&#34;Language for the greeting&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#8f5902;font-style:italic">// 可以使用,分割多个环境变量，变量会按照从前往后的顺序匹配
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#000">EnvVar</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;APP_LANG,LANG&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">app</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Action</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">cli</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">String</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;lang&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#34;chinese&#34;</span> <span style="color:#ce5c00;font-weight:bold">||</span> <span style="color:#000">strings</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HasPrefix</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">String</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;lang&#34;</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#4e9a06">&#34;zh_CN&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;你好，工程师&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Hello, Engineer&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">app</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Args</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatalln</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">//Out
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//$ make bin &amp;&amp; APP_LANG=english ./bin/watcher # 这里优先匹配 APP_LANG 而非 LANG
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//go build -o bin/watcher
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//Hello, Engineer
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">//$ make bin &amp;&amp; ./bin/watcher
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//go build -o bin/watcher
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//你好，工程师
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="从文件中读取配置项">从文件中读取配置项</h2>
<ul>
<li>引入<code>gopkg.in/urfave/cli.v1/altsrc</code>即可从文件中读取配置项</li>
<li><strong>命令行中指定的配置项值优先级高于配置文件中指定的配置项</strong></li>
<li><strong>注意</strong>: <code>altsrc</code>依赖于<code>gopkg.in/urfave/cli.v1</code>，所以使用<code>altsrc</code>的时候，要执行如下的<code>import</code>:</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">cli</span> <span style="color:#4e9a06">&#34;gopkg.in/urfave/cli.v1&#34;</span> <span style="color:#8f5902;font-style:italic">// 从gopkg.in 引入 cli 而非从 GitHub 引入
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#4e9a06">&#34;gopkg.in/urfave/cli.v1/altsrc&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><ul>
<li>支持从配置文件读取的配置项需要使用<code>altsrc.NewXXXFlag</code>包裹</li>
<li>配置文件也要当做一个配置项写入到<code>app.Flags</code>中</li>
<li>从配置文件添加配置项，需要使用<code>InitInputSourceWithContext</code>进行初始化</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// config 表示配置文件的配置项名称
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">app</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Before</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">altsrc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">InitInputSourceWithContext</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">flags</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">altsrc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewYamlSourceFromFlagFunc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;config&#34;</span><span style="color:#000;font-weight:bold">))</span>
</span></span></code></pre></div><ul>
<li>
<p>目前<code>altsrc</code>仅支持<code>TOML</code>, <code>YAML</code>配置文件，如需要其他格式的配置文件，可自行实现<code>altsrc.InputSourceContext</code></p>
</li>
<li>
<p>示例代码</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">cli</span> <span style="color:#4e9a06">&#34;gopkg.in/urfave/cli.v1&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;gopkg.in/urfave/cli.v1/altsrc&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">app</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">cli</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewApp</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">flags</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#000">cli</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Flag</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">altsrc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewIntFlag</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">cli</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">IntFlag</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;count&#34;</span><span style="color:#000;font-weight:bold">}),</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">cli</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StringFlag</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">Name</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;config&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">app</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Action</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">cli</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">count</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Int</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;count&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Echo %d count\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">count</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#000">count</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;yml is readed&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">app</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Before</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">cli</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">BeforeFunc</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">altsrc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">InitInputSourceWithContext</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">flags</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">altsrc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewYamlSourceFromFlagFunc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;config&#34;</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">_</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">BeforeFunc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">app</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Flags</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">flags</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">app</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Args</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatalln</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><ul>
<li>输出</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>&gt;&gt;&gt; make bin <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> ./bin/watcher
</span></span><span style="display:flex;"><span>go build -o bin/watcher
</span></span><span style="display:flex;"><span>Echo <span style="color:#0000cf;font-weight:bold">0</span> count
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; make bin <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> ./bin/watcher --count <span style="color:#0000cf;font-weight:bold">4</span>
</span></span><span style="display:flex;"><span>go build -o bin/watcher
</span></span><span style="display:flex;"><span>Echo <span style="color:#0000cf;font-weight:bold">4</span> count
</span></span><span style="display:flex;"><span>yml is readed
</span></span><span style="display:flex;"><span>yml is readed
</span></span><span style="display:flex;"><span>yml is readed
</span></span><span style="display:flex;"><span>yml is readed
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; cat app.yaml
</span></span><span style="display:flex;"><span>count: <span style="color:#0000cf;font-weight:bold">10</span>
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; make bin <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> ./bin/watcher --config ./app.yaml
</span></span><span style="display:flex;"><span>go build -o bin/watcher
</span></span><span style="display:flex;"><span>Echo <span style="color:#0000cf;font-weight:bold">10</span> count
</span></span><span style="display:flex;"><span>yml is readed
</span></span><span style="display:flex;"><span>yml is readed
</span></span><span style="display:flex;"><span>yml is readed
</span></span><span style="display:flex;"><span>yml is readed
</span></span><span style="display:flex;"><span>yml is readed
</span></span><span style="display:flex;"><span>yml is readed
</span></span><span style="display:flex;"><span>yml is readed
</span></span><span style="display:flex;"><span>yml is readed
</span></span><span style="display:flex;"><span>yml is readed
</span></span><span style="display:flex;"><span>yml is readed
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; make bin <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> ./bin/watcher --config ./app.yaml --count <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>go build -o bin/watcher
</span></span><span style="display:flex;"><span>Echo <span style="color:#0000cf;font-weight:bold">1</span> count
</span></span><span style="display:flex;"><span>yml is readed
</span></span></code></pre></div><h2 id="子命令">子命令</h2>
<ul>
<li>cli 默认为根命令，每个命令可以添加子命令和选项</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">cli</span> <span style="color:#4e9a06">&#34;gopkg.in/urfave/cli.v1&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">app</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">cli</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewApp</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">app</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Commands</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#000">cli</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Command</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">Name</span><span style="color:#000;font-weight:bold">:</span>    <span style="color:#4e9a06">&#34;add&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">Aliases</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">{</span><span style="color:#4e9a06">&#34;a&#34;</span><span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">Usage</span><span style="color:#000;font-weight:bold">:</span>   <span style="color:#4e9a06">&#34;add a task to the list&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">Action</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">cli</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;added task: &#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Args</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">First</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">Name</span><span style="color:#000;font-weight:bold">:</span>    <span style="color:#4e9a06">&#34;complete&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">Aliases</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">{</span><span style="color:#4e9a06">&#34;c&#34;</span><span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">Usage</span><span style="color:#000;font-weight:bold">:</span>   <span style="color:#4e9a06">&#34;complete a task on the list&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">Action</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">cli</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;completed task: &#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Args</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">First</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">Name</span><span style="color:#000;font-weight:bold">:</span>    <span style="color:#4e9a06">&#34;template&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">Aliases</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">{</span><span style="color:#4e9a06">&#34;t&#34;</span><span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">Usage</span><span style="color:#000;font-weight:bold">:</span>   <span style="color:#4e9a06">&#34;options for task templates&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">Subcommands</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#000">cli</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Command</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#000">Name</span><span style="color:#000;font-weight:bold">:</span>  <span style="color:#4e9a06">&#34;add&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>					<span style="color:#000">Usage</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;add a new template&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>					<span style="color:#000">Flags</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#000">cli</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Flag</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>						<span style="color:#000">cli</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StringFlag</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>							<span style="color:#000">Name</span><span style="color:#000;font-weight:bold">:</span>  <span style="color:#4e9a06">&#34;path,p&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>							<span style="color:#000">Usage</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;template path&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>						<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>					<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>					<span style="color:#000">Action</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">cli</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>						<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;new task template: %s from %s\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Args</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">First</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">String</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;path&#34;</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>						<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>					<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#000">Name</span><span style="color:#000;font-weight:bold">:</span>  <span style="color:#4e9a06">&#34;remove&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>					<span style="color:#000">Usage</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;remove an existing template&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>					<span style="color:#000">Action</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">cli</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>						<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;removed task template: &#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Args</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">First</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>						<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>					<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">app</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Args</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatalln</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>&gt;&gt;&gt; make bin <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> ./bin/watcher template add -h                                                        17:32:18 <span style="color:#ce5c00;font-weight:bold">(</span>04-21<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>go build -o bin/watcher
</span></span><span style="display:flex;"><span>NAME:
</span></span><span style="display:flex;"><span>   watcher template add - add a new template
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>USAGE:
</span></span><span style="display:flex;"><span>   watcher template add <span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#204a87">command</span> options<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">[</span>arguments...<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>OPTIONS:
</span></span><span style="display:flex;"><span>   --path value, -p value  template path
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; make bin <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> ./bin/watcher template add -p /tmpdir xff                                            17:32:49 <span style="color:#ce5c00;font-weight:bold">(</span>04-21<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>go build -o bin/watcher
</span></span><span style="display:flex;"><span>new task template: xff from /tmpdir
</span></span></code></pre></div><h2 id="子命令分类">子命令分类</h2>
<ul>
<li>可以通过<code>Category</code>选项让命令的帮助文本在一组中输出</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">cli</span> <span style="color:#4e9a06">&#34;gopkg.in/urfave/cli.v1&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">app</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">cli</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewApp</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">app</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Commands</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#000">cli</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Command</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">Name</span><span style="color:#000;font-weight:bold">:</span>     <span style="color:#4e9a06">&#34;env&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">Category</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;info&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">Name</span><span style="color:#000;font-weight:bold">:</span>     <span style="color:#4e9a06">&#34;add&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">Category</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;template&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">Name</span><span style="color:#000;font-weight:bold">:</span>     <span style="color:#4e9a06">&#34;remove&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">Category</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;template&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">app</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Args</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatalln</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>&gt;&gt;&gt; make bin <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> ./bin/watcher -h                                                                     17:37:44 <span style="color:#ce5c00;font-weight:bold">(</span>04-21<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>go build -o bin/watcher
</span></span><span style="display:flex;"><span>NAME:
</span></span><span style="display:flex;"><span>   watcher - A new cli application
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>USAGE:
</span></span><span style="display:flex;"><span>   watcher <span style="color:#ce5c00;font-weight:bold">[</span>global options<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#204a87">command</span> <span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#204a87">command</span> options<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">[</span>arguments...<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>VERSION:
</span></span><span style="display:flex;"><span>   0.0.0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>COMMANDS:
</span></span><span style="display:flex;"><span>     help, h  Shows a list of commands or <span style="color:#204a87">help</span> <span style="color:#204a87;font-weight:bold">for</span> one <span style="color:#204a87">command</span>
</span></span><span style="display:flex;"><span>   info:
</span></span><span style="display:flex;"><span>     env
</span></span><span style="display:flex;"><span>   template:
</span></span><span style="display:flex;"><span>     add
</span></span><span style="display:flex;"><span>     remove
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>GLOBAL OPTIONS:
</span></span><span style="display:flex;"><span>   --help, -h     show <span style="color:#204a87">help</span>
</span></span><span style="display:flex;"><span>   --version, -v  print the version
</span></span></code></pre></div><h2 id="返回码">返回码</h2>
<ul>
<li><code>app.Run</code>默认不会调用<code>os.Exit</code>，所以程序的默认返回码是0</li>
<li>可以在<code>Action</code>指定错误返回值为<code>ExitCoder</code>或<code>MultiError</code>指定程序返回码</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;gopkg.in/urfave/cli.v1&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">app</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">cli</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewApp</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">app</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Flags</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#000">cli</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Flag</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">cli</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">BoolTFlag</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">Name</span><span style="color:#000;font-weight:bold">:</span>  <span style="color:#4e9a06">&#34;ginger-crouton,g&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">Usage</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;is it in the soup?&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">app</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Action</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">cli</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Bool</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;ginger-crouton&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">cli</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewExitError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;it is not in the soup&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">86</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">app</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Args</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatalln</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>&gt;&gt;&gt; make bin <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> ./bin/watcher -g<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">false</span>                                                               17:46:34 <span style="color:#ce5c00;font-weight:bold">(</span>04-21<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>go build -o bin/watcher
</span></span><span style="display:flex;"><span>it is not in the soup
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">1371</span> <span style="color:#ce5c00;font-weight:bold">(</span>michaeldeMacBook-Air<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#0000cf;font-weight:bold">86</span> ~/Github/Golang/watcher
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; make bin <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> ./bin/watcher -g<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">0</span>                                                                   17:46:36 <span style="color:#ce5c00;font-weight:bold">(</span>04-21<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>go build -o bin/watcher
</span></span><span style="display:flex;"><span>it is not in the soup
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">1372</span> <span style="color:#ce5c00;font-weight:bold">(</span>michaeldeMacBook-Air<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#0000cf;font-weight:bold">86</span> ~/Github/Golang/watcher
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; make bin <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> ./bin/watcher -g<span style="color:#ce5c00;font-weight:bold">=</span>f                                                                   17:46:38 <span style="color:#ce5c00;font-weight:bold">(</span>04-21<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>go build -o bin/watcher
</span></span><span style="display:flex;"><span>it is not in the soup
</span></span></code></pre></div><h2 id="生成帮助文本">生成帮助文本</h2>
<ul>
<li>帮助文本的模板通过<code>AppHelpTemplate</code>, <code>CommandHelpTemplate</code>, <code>SubcommandHelpTemplate</code>这三个变量来定义，可以将它们重新赋值来改变帮助文本的样式</li>
<li>也可以改变<code>cli.HelpPrinter</code>来重新定义帮助函数</li>
</ul>
<pre tabindex="0"><code>package main

import (
	&#34;fmt&#34;
	&#34;os&#34;

	cli &#34;gopkg.in/urfave/cli.v1&#34;
)

func main() {
	// EXAMPLE: Append to an existing template
	cli.AppHelpTemplate = fmt.Sprintf(`%s

WEBSITE: http://awesometown.example.com

SUPPORT: support@awesometown.example.com

`, cli.AppHelpTemplate)

	// EXAMPLE: Override a template
	cli.AppHelpTemplate = `NAME:
   {{.Name}} - {{.Usage}}
USAGE:
   {{.HelpName}} {{if .VisibleFlags}}[global options]{{end}}{{if .Commands}} command [command options]{{end}} {{if .ArgsUsage}}{{.ArgsUsage}}{{else}}[arguments...]{{end}}
   {{if len .Authors}}
AUTHOR:
   {{range .Authors}}{{ . }}{{end}}
   {{end}}{{if .Commands}}
COMMANDS:
{{range .Commands}}{{if not .HideHelp}}   {{join .Names &#34;, &#34;}}{{ &#34;\t&#34;}}{{.Usage}}{{ &#34;\n&#34; }}{{end}}{{end}}{{end}}{{if .VisibleFlags}}
GLOBAL OPTIONS:
   {{range .VisibleFlags}}{{.}}
   {{end}}{{end}}{{if .Copyright }}
COPYRIGHT:
   {{.Copyright}}
   {{end}}{{if .Version}}
VERSION:
   {{.Version}}
   {{end}}
`

	// EXAMPLE: Replace the `HelpPrinter` func
	cli.HelpPrinter = func(w io.Writer, templ string, data interface{}) {
		fmt.Println(&#34;Ha HA.  I pwnd the help!!1&#34;)
	}

	cli.NewApp().Run(os.Args)
}
</code></pre><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>&gt;&gt;&gt; make bin <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> ./bin/watcher                                                                        18:04:34 <span style="color:#ce5c00;font-weight:bold">(</span>04-21<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>go build -o bin/watcher
</span></span><span style="display:flex;"><span>Ha HA.  I pwnd the help!!1
</span></span></code></pre></div><ul>
<li><code>help</code>命令的属性可以通过<code>cli.HelpFlag</code>来改变</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">cli</span> <span style="color:#4e9a06">&#34;gopkg.in/urfave/cli.v1&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">cli</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HelpFlag</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">cli</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">BoolFlag</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Name</span><span style="color:#000;font-weight:bold">:</span>   <span style="color:#4e9a06">&#34;halp, haaaaalp&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Usage</span><span style="color:#000;font-weight:bold">:</span>  <span style="color:#4e9a06">&#34;HALP&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">EnvVar</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;SHOW_HALP,HALPPLZ&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">cli</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewApp</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Args</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>&gt;&gt;&gt; make bin <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> ./bin/watcher --haaaaalp                                                             18:05:53 <span style="color:#ce5c00;font-weight:bold">(</span>04-21<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>go build -o bin/watcher
</span></span><span style="display:flex;"><span>NAME:
</span></span><span style="display:flex;"><span>   watcher - A new cli application
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>USAGE:
</span></span><span style="display:flex;"><span>   watcher <span style="color:#ce5c00;font-weight:bold">[</span>global options<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#204a87">command</span> <span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#204a87">command</span> options<span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">[</span>arguments...<span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>VERSION:
</span></span><span style="display:flex;"><span>   0.0.0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>COMMANDS:
</span></span><span style="display:flex;"><span>     help, h  Shows a list of commands or <span style="color:#204a87">help</span> <span style="color:#204a87;font-weight:bold">for</span> one <span style="color:#204a87">command</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>GLOBAL OPTIONS:
</span></span><span style="display:flex;"><span>   --halp, --haaaaalp  HALP <span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#000">$SHOW_HALP</span>, <span style="color:#000">$HALPPLZ</span><span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>   --version, -v       print the version
</span></span></code></pre></div><h2 id="版本标志">版本标志</h2>
<ul>
<li>默认情况下版本是通过<code>cli.VersionFlag</code>标识符来指定的，在cli内部，<code>cli.VersionPrinter</code>将会获取它来打印<code>App.Version</code></li>
</ul>
<pre tabindex="0"><code>package main

import (
	&#34;os&#34;

	cli &#34;gopkg.in/urfave/cli.v1&#34;
)

func main() {
	cli.VersionFlag = cli.BoolFlag{
		Name:  &#34;print-version, V&#34;,
		Usage: &#34;print only the version&#34;,
	}

	app := cli.NewApp()
	app.Name = &#34;partay&#34;
	app.Version = &#34;19.99.0&#34;
	app.Run(os.Args)
}
</code></pre><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>&gt;&gt;&gt; make bin <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> ./bin/watcher -V                                                                     18:09:26 <span style="color:#ce5c00;font-weight:bold">(</span>04-21<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>go build -o bin/watcher
</span></span><span style="display:flex;"><span>partay version 19.99.0
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; make bin <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> ./bin/watcher -v                                                                     18:09:29 <span style="color:#ce5c00;font-weight:bold">(</span>04-21<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>go build -o bin/watcher
</span></span><span style="display:flex;"><span>Incorrect Usage. flag provided but not defined: -v
</span></span></code></pre></div><ul>
<li>也可以通过更改<code>cli.VersionPrinter</code>来修改打印 Version 的函数</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;github.com/urfave/cli&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">Revision</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;xiaofafa&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">cli</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">VersionPrinter</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">cli</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;version=%s revision=%s\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">App</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Version</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Revision</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">app</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">cli</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewApp</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">app</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;partay&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">app</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Version</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;19.99.0&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">app</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Run</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Args</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>&gt;&gt;&gt; make bin <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> ./bin/watcher -v                                                                     18:10:12 <span style="color:#ce5c00;font-weight:bold">(</span>04-21<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>go build -o bin/watcher
</span></span><span style="display:flex;"><span><span style="color:#000">version</span><span style="color:#ce5c00;font-weight:bold">=</span>19.99.0 <span style="color:#000">revision</span><span style="color:#ce5c00;font-weight:bold">=</span>xiaofafa
</span></span></code></pre></div><h2 id="示例代码">示例代码</h2>
<ul>
<li><a href="https://gist.github.com/bwangelme/078d4dab53b89e06a14572611c6e95e8">Cli 学习示例代码</a></li>
</ul>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-635fed7c7f961ced2f2b68e493f04ffb">16.20 - 关于线程同步操作的一道面试题</h1>
    
	<h2 id="前言">前言</h2>
<p>前两天在 V2EX 上发现了<a href="https://www.v2ex.com/t/547045">一道好玩的面试题</a>，兴致冲冲地写了答案出来，并发到了 <a href="https://www.v2ex.com/t/552620">V2EX</a> 上。结果发现自己实现的思路完全是错误的，遂把上篇文章推翻，重新写一篇。</p>
<h2 id="问题描述及解析">问题描述及解析</h2>
<h3 id="问题描述">问题描述</h3>
<blockquote>
<p>编写一个程序，开启 3 个线程A,B,C，这三个线程的输出分别为 A、B、C，每个线程将自己的输出在屏幕上打印 10 遍，要求输出的结果必须按顺序显示。如：ABCABCABC&hellip;.</p>
</blockquote>
<p>为了能够踩到更多的坑，我把上述问题升级了一下，线程数量和打印次数不是一个固定的值，具体如下:</p>
<blockquote>
<ul>
<li>编写一个程序，开启 N 个线程A,B,C&hellip;，这N个线程的输出分别为 A、B、C&hellip;，每个线程将自己的输出在屏幕上打印 M 遍，要求输出的结果必须按顺序显示。如：ABC&hellip;ABC&hellip;ABC&hellip;</li>
<li>其中 N &lt;= 1000, M &lt;= 1000</li>
</ul>
</blockquote>
<p><strong>注意</strong>:</p>
<ul>
<li>输出要在各自的线程中输出，不能在主线程中输出</li>
</ul>
<h3 id="题目解析">题目解析</h3>
<p>引用自 V友 <a href="https://www.v2ex.com/t/552620#r_7144214">@hjc4869</a></p>
<blockquote>
<p>这个问题本质上是在实现同步，而不是互斥。同步强调的是做事的先后顺序而不是多线程访问资源的冲突。虽然二者是包含关系并且可以互相实现，但是如果这里第一眼看到题就只是想到用 lock/mutex 而不是 semaphore/channel 去实现，那么显然是对后者的应用不熟，面试要挂的</p>
</blockquote>
<h2 id="利用-channel-做信号量的解法">利用 Channel 做信号量的解法</h2>
<p>使用信号量的话，这个题的解题思路就很简单:</p>
<ul>
<li>创建 N 个Goroutine 执行输出操作。</li>
<li>每个 Goroutine 的具体操作可用以下伪代码来表示:</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">echo</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">threadNum</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Upstream</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Downstream</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#204a87;font-weight:bold">in</span> <span style="color:#204a87">range</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">M</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">wait</span> <span style="color:#000">Upstream</span>  <span style="color:#ce5c00;font-weight:bold">//</span> <span style="color:#000">等待上游的信号</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">threadNum</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">signal</span> <span style="color:#000">Downstream</span> <span style="color:#ce5c00;font-weight:bold">//</span> <span style="color:#000">给下游发送信号</span>
</span></span></code></pre></div><p>其中<code>Upstream</code> 和 <code>Downstream</code> 都表示信号量，<code>A</code> Goroutine 的 <code>Downstream</code> 是 <code>B</code> Goroutine 的 <code>Upstream</code>，依此类推，所有 Goroutine 会形成一个链式的关系。</p>
<p>可以使用下图来表示:</p>
<p><img src="https://passage-1253400711.cos-website.ap-beijing.myqcloud.com/2019-04-14-012629.png" alt=""></p>
<p>具体代码如下:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">N</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">5</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">M</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">wait</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">sig</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">firstWait</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">lastSig</span> <span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">wait</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">firstWait</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">wait</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#000">N</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">sig</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{})</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">lastSig</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">sig</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">echo</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">wait</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">sig</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">wait</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">sig</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#000">M</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">firstWait</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{}{}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#000">lastSig</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">firstWait</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ok</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#000">lastSig</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">ok</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatalln</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Channel not closed&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Out
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// 0: A
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// 1: B
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// 2: C
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// 3: D
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// 4: E
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// 0: A
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// 1: B
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// 2: C
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// 3: D
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// 4: E
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// 0: A
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// 1: B
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// 2: C
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// 3: D
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// 4: E
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// Close A
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// Close B
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// Close C
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// Close D
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// Close E
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">echo</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">threadNum</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">wait</span> <span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{},</span> <span style="color:#000">sig</span> <span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">threadName</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">string</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;A&#39;</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">threadNum</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">wait</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%d: %s\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">threadNum</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">threadName</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">sig</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{}{}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">sig</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 这句是我打印出来为了确认所有的 Goroutine 已经关闭了，实际不需要
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Close&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">threadName</span><span style="color:#000;font-weight:bold">)</span> 
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="fanin-的方式">FanIn 的方式</h2>
<blockquote>
<p>根据题目要求来看，在主线程中输出结果，有些不符合要求，但有个答案的实现很有意思，我就也放上来了</p>
</blockquote>
<p>经V友 @Mark3K 的<a href="https://www.v2ex.com/t/552620#r_7143193">补充</a>，还可以使用多个 channel 执行扇入(Fan In)操作，避免使用锁。</p>
<p>首先说一下扇入的定义，Go blog 中是这样描述的：</p>
<blockquote>
<p>A function can read from multiple inputs and proceed until all are closed by multiplexing the input channels onto a single channel that&rsquo;s closed when all the inputs are closed. This is called fan-in.</p>
</blockquote>
<p>通过将多个输入 channel 多路复用到单个处理 channel 的方式，一个函数能够从多个输入 channel 中读取数据并处理。当所有的输出 channel 都关闭的时候，单个处理 channel 也会关闭。这就叫做扇入。</p>
<p>在维基百科中描述的逻辑门的扇入如下(大家也可以参考这个来理解 Go 中的扇入):</p>
<blockquote>
<p>Fan-in is the number of inputs a logic gate can handle. For instance the fan-in for the AND gate shown in the figure is 3. Physical logic gates with a large fan-in tend to be slower than those with a small fan-in. This is because the complexity of the input circuitry increases the input capacitance of the device. Using logic gates with higher fan-in will help reducing the depth of a logic circuit.</p>
</blockquote>
<p><img src="https://passage-1253400711.cos-website.ap-beijing.myqcloud.com/2019-04-07-040937.jpg" alt=""></p>
<blockquote>
<p>逻辑门中的扇入定义: 一个逻辑门将多个输入处理成一个输出，它能够处理的输入数量就叫做扇入。</p>
</blockquote>
<p>理解了扇入的概念后，上述问题的答案也呼之欲出了。我们可以为<code>A,B,C,...</code>这N个 Goroutine 创建N个 channel。然后通过一个 FanIn 函数将N个 channel 的输出输入到一个 channel 中。具体代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">N</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">5</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">M</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">5</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">gen</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">v</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">times</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ch</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#204a87">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ch</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#000">times</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">ch</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">v</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">ch</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">fanIn</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">times</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">inputs</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ch</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#204a87">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ch</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#000">times</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">input</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">inputs</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">v</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#000">input</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">ch</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">v</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">ch</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">times</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">M</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">inputs</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">([]</span><span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">N</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#000">N</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">threadName</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">string</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;A&#39;</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">i</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">inputs</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">inputs</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">gen</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">threadName</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">times</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">char</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">fanIn</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">times</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">inputs</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">char</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="使用锁的解决方案">使用锁的解决方案</h2>
<p>使用锁并不是这个问题的正确解决思路，<strong>甚至会将人的思维带入歧途</strong>，所以不推荐大家使用锁解决。</p>
<p>这是我之前写的旧文，<a href="/2019/03/26/go-lock/">线程同步操作面试题使用锁的解法</a>，个人觉得某些地方还有一些参考价值，请大家酌情阅读。</p>
<h2 id="使用-atomicinteger-的解决方案">使用 AtomicInteger 的解决方案</h2>
<p>使用<code>AtomicInteger</code>并不是一种好的解决方案(因为这个解法让 CPU 持续空转)，但是通过这个解法我们可以了解到 Go 调度器阻塞的一个陷阱，所以也把这种解法放了上来，感兴趣的朋友可以查看我的另一篇文章 <a href="/2019/04/10/go-scheduler-pitfall/">Go 调度器的一个无法执行陷阱</a>。</p>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-e7414abf063a165b8718b37f17cb4f2f">16.21 - Go 调度器的一个无法执行陷阱</h1>
    
	<blockquote>
<p><strong>注意</strong>: 这篇文章的答案可以有正确的结果，但解题思路是不对的，正确的思路请参考 <a href="/2019/04/13/go-sync-channel/">关于线程同步操作的一道面试题</a></p>
</blockquote>
<h2 id="2020年03月16日补充说明">2020年03月16日补充说明</h2>
<p>Go 1.14 加入了基于信号的抢占式调度，这个问题在 go 1.14 上已经复现不了了。参考 <a href="http://xiaorui.cc/archives/6535">go1.14基于信号的抢占式调度实现原理</a></p>
<h2 id="背景说明">背景说明</h2>
<p>前两天遇到了这样一道题目:</p>
<blockquote>
<p>编写一个程序，开启 3 个线程A,B,C，这三个线程的输出分别为 A、B、C，每个线程将自己的 输出在屏幕上打印 10 遍，要求输出的结果必须按顺序显示。如：ABCABCABC&hellip;.</p>
</blockquote>
<p><strong>注意</strong>:</p>
<ul>
<li>输出要在各自的线程中输出，不能在主线程中输出</li>
</ul>
<h2 id="错误答案">错误答案</h2>
<p>当时想到一种思路是使用 Go <code>atomic</code> 包中提供的原子操作来完成上述功能。
即每个<code>Goroutine</code>原子性地获得<code>i</code>的值，如果符合<code>i % 3 == threadNum</code>的条件，则执行操作，否则作自旋。代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;sync/atomic&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">end</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">i</span>   <span style="color:#204a87;font-weight:bold">int32</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">threadPrint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">threadNum</span> <span style="color:#204a87;font-weight:bold">int32</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">threadName</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">v</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">atomic</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">LoadInt32</span><span style="color:#000;font-weight:bold">((</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#204a87;font-weight:bold">int32</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">v</span> <span style="color:#ce5c00;font-weight:bold">&gt;=</span> <span style="color:#0000cf;font-weight:bold">30</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">break</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">v</span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#0000cf;font-weight:bold">3</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">threadNum</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%d: %s\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">i</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">threadName</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">atomic</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddInt32</span><span style="color:#000;font-weight:bold">((</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#204a87;font-weight:bold">int32</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#204a87">int32</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">end</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{}{}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">names</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">{</span><span style="color:#4e9a06">&#34;A&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;B&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;C&#34;</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">idx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">name</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">names</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">threadPrint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">int32</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">idx</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">names</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#000">end</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>这个程序当时跑的是没有问题的。我把答案发到 V2EX 论坛上之后， V友 @whoisghost 指出了<a href="https://www.v2ex.com/t/552620#r_7143228">问题</a></p>
<blockquote>
<p>把 names 再追加 “ D ”, &ldquo;E&rdquo;, 把 3 =&gt; 5, 30 =&gt; 50, 还能正常运行吗？</p>
</blockquote>
<p>我照着它的说明试了一下，发现程序会阻塞起来。后来我去查了一下资料，才了解到 Go 的调度器中还有一个隐藏的陷阱。在了解这个陷阱之前，我们需要先了解一下操作系统的线程调度器和 Go 的调度器。</p>
<h2 id="操作系统线程调度器">操作系统线程调度器</h2>
<p>操作系统线程调度器的执行逻辑如下:</p>
<ul>
<li>操作系统的调度器维护了一组线程的信息，这些线程分别处于<code>running</code>, <code>runnable</code>, <code>non-runnable</code>的状态。</li>
<li>当一个线程在一个 CPU 核心上运行超过一个时间片以后，它就会被系统时钟中断给中断掉。</li>
<li>被中断的线程会保存它的上下文信息，并执行中断处理函数。</li>
<li>中断处理函数会将执行权转交给操作系统的调度器，操作系统的调度器会调取其他的线程来这个 CPU 核心上运行。</li>
</ul>
<h2 id="go-调度器">Go 调度器</h2>
<p>Go 语言中使用<code>Goroutine</code>来实现并发，<code>Goroutine</code>类似于线程，但它又是非常轻量的。一个创造成千上万个<code>Goroutine</code>的程序很常见，但是创造成千上万个线程的程序却很少见。</p>
<p><code>Goroutine</code>是在用户层实现的，当 Go 程序启动的时候，Go 的运行时会创建<code>GOMAXPROCS</code>个系统级线程，然后<code>Goroutine</code>就被它在这<code>GOMAXPROCS</code>个系统级线程上调度。</p>
<p>Go 语言实现了一个协同式的，部分中断调度器(Golang implements a co-operative partially preemptive scheduler.)。它没有基于时钟中断来实现调度，但调度器可以在系统级线程上并行地运行多个 Goroutine。</p>
<p>在<code>runtime</code>提供的构造体，库，系统调用函数中，Go 添加了钩子函数，这些钩子函数能够协同式地启动 Go 的调度器。
Go 通过这种方式来将执行权切换到 Go 调度器，从而避免通过时钟中断来将执行权切换到 Go 调度器。<code>runtime</code>提供的这些函数也成为了进入 Go 调度器的入口。
但是如果我们在<code>Goroutine</code>中没有调用 <code>runtime</code> 的任何函数会发生什么情况呢？</p>
<h2 id="代码错误原因简析">代码错误原因简析</h2>
<p>在上述代码中，我们启动了5个 Goroutine，在我的电脑上<code>GOMAXPROCS</code> 是4。
也就是说有4个<code>Goroutine</code>会各自占用一个系统级线程进行自旋操作，但因为它们没有调用<code>runtime</code>中的函数，所以它们并不会主动将执行权交给 Go 调度器。
这样始终有一个<code>Goroutine</code>无法获得执行的机会，整个程序也就被阻塞住了。</p>
<h2 id="解决方案">解决方案</h2>
<p>在生产环境中，我们遇到上述错误的机会很少。因为我们的程序基本都会执行<code>runtime</code>中提供的一些功能，例如<code>channel</code>，<code>系统调用</code>, <code>fmt.Sprint</code>, <code>Mutex</code>, <code>time.Sleep</code>等。</p>
<p>例如如果我们在上述代码第加入一句<code>time.Sleep(0)</code>，程序就不会阻塞了，因为<code>time.Sleep</code>中包含的钩子函数启动了 Go 调度器，第五个 goroutine 有了执行的机会。</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">v</span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#0000cf;font-weight:bold">3</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">threadNum</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%d: %s\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">i</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">threadName</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">atomic</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddInt32</span><span style="color:#000;font-weight:bold">((</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#204a87;font-weight:bold">int32</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#204a87">int32</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sleep</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic">// 加入这条语句
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#204a87;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span></span></span></code></pre></td></tr></table>
</div>
</div>
<p>如果我们在生产环境中遇到了这个问题的话，正确的做法应该是加入一句 <a href="https://golang.org/pkg/runtime/#Gosched">runtime.Gosched()</a>，如下所示:</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">v</span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#0000cf;font-weight:bold">3</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">threadNum</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%d: %s\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">i</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">threadName</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">atomic</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddInt32</span><span style="color:#000;font-weight:bold">((</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#204a87;font-weight:bold">int32</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#204a87">int32</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">runtime</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Gosched</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#8f5902;font-style:italic">// 加入这条语句
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#204a87;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span></span></span></code></pre></td></tr></table>
</div>
</div>
<p>这样当<code>Goroutine</code>自旋的时候，就会主动地去启动 Go 调度器，让其他<code>Goroutine</code>获得执行的机会。</p>
<h2 id="参考链接">参考链接</h2>
<ul>
<li><a href="http://www.sarathlakshman.com/2016/06/15/pitfall-of-golang-scheduler">A pitfall of golang scheduler</a></li>
</ul>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-fbbcf89e72ac3f247786060b50fa9d08">16.22 - Go Panic 的触发及恢复过程</h1>
    
	<blockquote>
<ul>
<li>Panic 过程</li>
<li>recover 函数</li>
<li>defer 函数</li>
</ul>
</blockquote>
<h2 id="panic-过程">Panic 过程</h2>
<ul>
<li>当代码触发<code>panic</code>的时候，<code>panic详情</code>就会被初始化。随后程序的控制权从最底端的调用函数一级一级向上传递到最顶端的调用函数。</li>
<li>到了最顶端调用函数后，控制权会被移交给 Go 语言的运行时系统，Go 语言的运行时系统打印出<code>panic详情</code>，并结束程序的运行。</li>
<li>在控制权传递的过程中<code>panic详情</code>会被逐渐积累起来。所以最后程序输出<code>panic详情</code>的时候，会从最底端的函数一直输出到最顶端的函数。我们查看调用栈的信息的时候，应该从底部<code>exit status 2</code>这一行向上看。</li>
</ul>
<h2 id="recover-函数">recover 函数</h2>
<ul>
<li>因为<code>panic</code>发生的时候，<code>panic</code>函数后面的语句都不会执行了，所以<code>recover</code>函数不能放在<code>panic</code>语句后面执行，而要放在<code>defer</code>函数中执行。</li>
</ul>
<h2 id="defer-函数">defer 函数</h2>
<ul>
<li>defer 函数的执行顺序和它的定义顺序是完全相反的</li>
<li>defer 语句每次执行的时候，Go 会把它携带的 defer 函数及其参数值存储到另一个栈中，这个栈是遵循 FILO(First Input Last Output)原则的。</li>
<li>defer 函数中也可以引发<code>panic</code>，这样可以把<code>recover</code>捕获的<code>panic</code>包装一下再抛出去。</li>
</ul>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-4b954ae7a79512193186d57a0ec102ff">16.23 - 线程同步操作面试题使用锁的解法</h1>
    
	<blockquote>
<p><strong>注意</strong>: 这篇文章的思路是不正确的，正确的思路请参考 <a href="/2019/04/13/go-sync-channel/">关于线程同步操作的一道面试题</a></p>
</blockquote>
<h2 id="前言">前言</h2>
<p>前两天在 V2ex 上看到了一篇博文，<a href="http://samray.me/%E4%B8%80%E6%9D%A1%E7%BB%8F%E5%85%B8%E9%9D%A2%E8%AF%95%E9%A2%98%E5%BC%95%E5%8F%91%E7%9A%84%E6%80%9D%E8%80%83">《一条经典面试题引发的思考》</a>，感觉很有意思，我就用 Go 把它的答案实现了一遍。</p>
<h2 id="问题描述及一个错误解法">问题描述及一个错误解法</h2>
<p>问题如下:</p>
<blockquote>
<p>编写一个程序，开启 3 个线程A,B,C，这三个线程的输出分别为 A、B、C，每个线程将自己的 输出在屏幕上打印 10 遍，要求输出的结果必须按顺序显示。如：ABCABCABC&hellip;.</p>
</blockquote>
<p>一个错误解法如下:</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="background-color:#dfdfdf"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span></span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="background-color:#dfdfdf"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span></span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">68
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;sync&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">mu</span> <span style="color:#000">sync</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Mutex</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">index</span> <span style="color:#204a87;font-weight:bold">int</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">endSignal</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{})</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">echoRoutine</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">routineIndex</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">routineName</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex; background-color:#dfdfdf"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">index</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">30</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">mu</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Lock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">index</span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#0000cf;font-weight:bold">3</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">routineIndex</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">index</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">routineName</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex; background-color:#dfdfdf"><span>			<span style="color:#000">index</span><span style="color:#ce5c00;font-weight:bold">++</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">mu</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Unlock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">endSignal</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{}{}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">routineNames</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">{</span><span style="color:#4e9a06">&#34;A&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;B&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;C&#34;</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">idx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">name</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">routineNames</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">echoRoutine</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">idx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">routineNames</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#000">endSignal</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">//Output:
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//0 A
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//1 B
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//2 C
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//3 A
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//4 B
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//5 C
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//6 A
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//7 B
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//8 C
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//9 A
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//10 B
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//11 C
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//12 A
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//13 B
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//14 C
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//15 A
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//16 B
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//17 C
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//18 A
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//19 B
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//20 C
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//21 A
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//22 B
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//23 C
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//24 A
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//25 B
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//26 C
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//27 A
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//28 B
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//29 C
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//30 A
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//31 B
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span></span></span></code></pre></td></tr></table>
</div>
</div>
<p>从上面的输出可以看到，程序还额外输出了两次 A 和 B。首先说结论，这是因为检查条件<code>index &lt; 30</code> <strong>没有加锁</strong>。为了理解这个错误，首先我们需要了解一下 Go 的内存模型。</p>
<h2 id="go-语言的内存模型">Go 语言的内存模型</h2>
<p>首先说什么是 Go 的内存模型，在官方文档中是这样定义的:</p>
<blockquote>
<p>The Go memory model specifies the conditions under which reads of a variable in one goroutine can be guaranteed to observe values produced by writes to the same variable in a different goroutine.</p>
</blockquote>
<p>Go 语言的内存模型规定了一个 Goroutine 可以看见另外一个 Goroutine 修改同一个变量的值的条件，这类似于 Java 内存模型中 <strong>内存可见性</strong> 问题。</p>
<h3 id="happens-before-原则">Happens Before 原则</h3>
<p>在 Go 语言中，编译器和处理器会对执行的指令进行重排序。Go 语言会保证的是，在单个 Goroutine 内，重排序后的执行效果和未进行重排序(即在代码中定义的执行顺序)的执行效果是一样。但是在多个 Goroutine 的运行环境下，由于重排序的原因，一个 Goroutine 观察到的执行顺序可能和另外一个 Goroutine 观察到的不一样。例如一个 Goroutine 执行<code>a = 1; b = 2</code>，另一个 Goroutine 可能会在<code>a</code>被赋值之前先观察到<code>b</code>被赋值了。</p>
<p>为了规范读和写的操作，Go 定义了 <strong>happens before</strong> 原则。对于变量读写操作，我们可以将其称作是事件。事件之间的顺序可以定义为三种，E1 发生在 E2 之前，E1 发生在 E2 之后，E1 和 E2同时发生。</p>
<p>在单个 Goroutine 内，<strong>happens before</strong> 顺序就是程序执行的顺序，如果下面两个条件都被满足的话，变量<code>v</code>的读取事件<code>r</code>，可以观察到变量<code>v</code>的写入事件<code>w</code>。</p>
<ol>
<li><code>r</code>没有在<code>w</code>之前发生。</li>
<li>在<code>w</code>之后，<code>r</code>之前，没有另外一个变量<code>v</code>的写入事件<code>w'</code>发生。</li>
</ol>
<p>总的来说，在单个 Goroutine 的环境下，读事件<code>r</code>会观察到最近的一个写事件<code>w</code>。</p>
<p>在多个 Goroutine 的运行环境下，如果需要让<code>v</code>的读取事件<code>r</code>观察到其写入事件<code>w</code>。需要满足更严格的条件：</p>
<ol>
<li><code>w</code>发生在<code>r</code>之前</li>
<li>任何针对共享变量<code>v</code>的写入事件都发生在<code>w</code>之前或者<code>r</code>之后。</li>
</ol>
<p>因为在多个 Goroutine 的运行环境下，读写事件可能并行地发生，所以第一点更严格了一些，要求<code>w</code>必须在<code>r</code>之前发生，两者不能同时发生，且它们之间没有其他的写事件<code>w'</code>。
因此在多个 Goroutine 访问一个共享变量<code>v</code>的时候，我们必须使用<a href="https://golang.org/ref/mem#tmp_3">同步事件</a>去建立一个 <strong>happens before</strong> 条件来让读事件观察到目标写事件。</p>
<p>此外，还需要注意的是：</p>
<ol>
<li>在变量<code>v</code>发生写事件之前，它被初始化成对应类型的零值。</li>
<li>大于一个机器字的变量的读写事件，会表现成 <strong>未指定顺序</strong> 的多次机器字大小的读写操作。</li>
</ol>
<h2 id="正确答案-v1">正确答案 V1</h2>
<p>了解了 Go 内存模型中的 <strong>Happens Before</strong> 原则之后，我们接着再来分析上述的错误代码。</p>
<ul>
<li>在 B Goroutine 输出完28之后，A, B, C 都会再循环了一次。</li>
<li>接着会由 C 先来执行输出操作。由于 C 执行第17行<code>i++</code>的写操作和 A 和 B 执行第13行<code>index &lt; 30</code>读操作是并行发生的，所以 A 和 B 可能读取到的值是29并进入循环。</li>
<li>因为此时 A 和 B 都已经进入循环了，所以会出现多输出一次的情况。</li>
<li>A 和 B 进入循环后，由于锁的存在，它们能够获取到正确的<code>index</code>的值，所以最后多输出的结果是30和31。</li>
</ul>
<p>理解了这个错误之后，我们可以把代码稍微改一下，将<code>index &lt; 30</code>这个比较操作也置于锁的保护中，就能够得到正确的结果了。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;sync&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">i</span> <span style="color:#204a87;font-weight:bold">int</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">mu</span> <span style="color:#000">sync</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Mutex</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">endSignal</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{})</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">threadPrint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">threadNum</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">threadName</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">mu</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Lock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&gt;=</span> <span style="color:#0000cf;font-weight:bold">30</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">mu</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Unlock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">break</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#0000cf;font-weight:bold">3</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">threadNum</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%d: %s\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">i</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">threadName</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">mu</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Unlock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">endSignal</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{}{}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">names</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">{</span><span style="color:#4e9a06">&#34;A&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;B&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;C&#34;</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">idx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">name</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">names</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">threadPrint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">idx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">names</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#000">endSignal</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="正确答案-v2----公平锁">正确答案 V2 &ndash; 公平锁</h2>
<p>上述代码是得到的结果是正确的，但是还存在一些问题。我们想要的执行顺讯是有序的，
但每次解锁的时候，都是 A, B, C 三个 Goroutine 上去抢锁资源。有时候某个 Goroutine 抢到了锁资源，但是其并不符合执行要求(<code>i%3 != threadNum</code>)。它就会将锁释放，然后让大家重新再来抢。</p>
<p>这样的争抢索锁资源造成了时间上的浪费，执行了一些不必要的操作。</p>
<p>为了避免这些浪费，我们可以参考 Java 中的公平锁，让解锁的顺序和上锁的顺序匹配，每次只有一个 Goroutine 获得锁资源，大家不必每次都去争抢锁资源。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;sync&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">endNum</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">30</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">FairLock</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">mu</span>        <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">sync</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Mutex</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">cond</span>      <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">sync</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Cond</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">isHold</span>    <span style="color:#204a87;font-weight:bold">bool</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">holdCount</span> <span style="color:#204a87;font-weight:bold">int</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">NewFairLock</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">sync</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Locker</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">mu</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">new</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">sync</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Mutex</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">cond</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">sync</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewCond</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">mu</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">FairLock</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">holdCount</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">isHold</span><span style="color:#000;font-weight:bold">:</span>    <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">mu</span><span style="color:#000;font-weight:bold">:</span>        <span style="color:#000">mu</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">cond</span><span style="color:#000;font-weight:bold">:</span>      <span style="color:#000">cond</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">fl</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">FairLock</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Lock</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">mu</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Lock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">fl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">mu</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Unlock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">fl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">isHold</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">holdCount</span><span style="color:#ce5c00;font-weight:bold">++</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">isHold</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">holdCount</span><span style="color:#ce5c00;font-weight:bold">++</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">fl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">isHold</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cond</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Wait</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">isHold</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">fl</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">FairLock</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Unlock</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">mu</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Lock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">fl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">mu</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Unlock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">fl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">isHold</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;unlock of UnLocked mutex&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">fl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">holdCount</span> <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cond</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Signal</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">isHold</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">holdCount</span><span style="color:#ce5c00;font-weight:bold">--</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">end</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">i</span>   <span style="color:#204a87;font-weight:bold">int</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">threadPrint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">threadNum</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">threadName</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">locker</span> <span style="color:#000">sync</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Locker</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#000">endNum</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">locker</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Lock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&gt;=</span> <span style="color:#000">endNum</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">locker</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Unlock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#0000cf;font-weight:bold">3</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">threadNum</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">locker</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Unlock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%d: %s\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">i</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">threadName</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">locker</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Unlock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">end</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{}{}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">mu</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">NewFairLock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">names</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">{</span><span style="color:#4e9a06">&#34;A&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;B&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;C&#34;</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">idx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">name</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">names</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">threadPrint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">idx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">mu</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">names</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#000">end</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><strong>注意</strong>： 由于可见性的原因，需要在<code>70~72</code>行上锁之后加一个判断，保证<code>i</code>的值是最新的值。</p>
<p>经 V友 @hheedat 的<a href="https://www.v2ex.com/t/552620#r_7183057">提醒</a>，<code>cond.Wait</code>操作需要放在 <code>for</code> 循环中，因为阻塞的 Goroutine 可能会被误唤醒。</p>
<p>Go 的文档中也说明 <a href="https://golang.org/pkg/sync/#Cond.Wait"><code>Wait</code>需要放在<code>for</code>循环中</a>。因为在 <code>Wait</code> 的过程中，<code>cond</code> 相关的锁并没有上锁，所以<code>Wait</code>唤醒后，相关的条件不一定是正确的。</p>
<h2 id="公平锁的一个错误尝试">公平锁的一个错误尝试</h2>
<p>在之前的代码中，我尝试利用公平锁上锁和解锁的有序性，来让3个 Goroutine 顺序执行并按顺序输出<code>A,B,C</code>。后经V友 <a href="https://www.v2ex.com/t/552620#r_7173035">hheedat</a> 指出了错误，发现这样的想法是不可行的。因为以下两点是冲突的：</p>
<ol>
<li>让 Goroutine 在无法获得锁资源的时候阻塞</li>
<li>让 Goroutine 按照 <code>A,B,C</code> 的顺序上锁</li>
</ol>
<ul>
<li>因为 Goroutine 的启动时间和接收到信号量的时间都是无序的，所以正常情况下无法让 Goroutine 按顺序上锁。</li>
<li>我尝试让 Goroutine 上锁之后使用一个信号通知<code>main</code>Goroutine，让<code>main</code>Goroutine 再去通知下一个 Goroutine 去上锁。</li>
<li>但由于 Goroutine 上锁之后是阻塞的，所以使用信号通知<code>main</code>Goroutine 的方案也是不可行的。</li>
</ul>
<p>或许还有其他方案，但我认为这样思考的思路是不对的，<strong>这个同步问题本来就应该使用信号量来解决，使用锁并尝试按顺序上锁只是在歧路上越走越远</strong>。</p>
<h2 id="参考链接">参考链接</h2>
<ul>
<li><a href="http://samray.me/%E4%B8%80%E6%9D%A1%E7%BB%8F%E5%85%B8%E9%9D%A2%E8%AF%95%E9%A2%98%E5%BC%95%E5%8F%91%E7%9A%84%E6%80%9D%E8%80%83">一条经典面试题引发的思考</a></li>
<li><a href="https://en.wikipedia.org/wiki/Memory_barrier#Multithreaded_programming_and_memory_visibility">Memory barrier &ndash; Wikipedia</a></li>
<li><a href="https://www.zhihu.com/question/36964449/answer/69790971">什么是Java中的公平锁？</a></li>
<li><a href="https://golang.org/ref/mem#tmp_2">The Go Memory Model</a></li>
<li><a href="http://ifeve.com/golang-mem/">GoLang内存模型</a></li>
<li><a href="https://blog.csdn.net/u012233832/article/details/82501839">go reentrant lock(可重入锁) 简单实现</a></li>
<li><a href="https://blog.golang.org/pipelines">Go Concurrency Patterns: Pipelines and cancellation</a></li>
<li><a href="https://en.wikipedia.org/wiki/Fan-in">Fan-In Wikipedia</a></li>
<li><a href="https://www.v2ex.com/t/552620#r_7143193">V友 Mark3K的评论</a></li>
<li><a href="https://www.v2ex.com/t/552620#r_7173035">一条面试题引发的思考 Go 版本</a></li>
</ul>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-770a44637da1a99d5af0d32fd0c958e9">16.24 - Go 的测试</h1>
    
	<blockquote>
<p>主要讲了 Go 相关的测试</p>
</blockquote>
<h2 id="测试的基本规则和流程">测试的基本规则和流程</h2>
<p>单元测试分为三类：</p>
<ol>
<li>功能测试(test)</li>
<li>基准测试(benchmark)</li>
<li>示例测试(example)</li>
</ol>
<h2 id="go-test流程"><code>go test</code>流程</h2>
<ol>
<li>做准备工作（判断给出的代码包和源码文件是否有效，判断给予的标记是否合法）</li>
<li>针对每个被测试的代码包，依次地进行构建、执行包中符合要求的测试函数，清理临时文件，打印测试结果。（为了加快测试速度，go test 会并发地对多个被测代码包进行功能测试，在最后打印结果时，它会依照我们给定的顺序逐个进行）</li>
<li>为了不影响性能测试结果，性能测试都是串行地运行的。</li>
</ol>
<h2 id="功能测试">功能测试</h2>
<h3 id="测试缓存">测试缓存</h3>
<ul>
<li>go 会将构建和测试的结果缓存起来，缓存目录可以通过<code>go env GOCACHE</code>命令看到</li>
<li><code>go clean -cache</code>命令可以删除所有缓存，<code>go clean -testcache</code>可以删除所有的测试结果缓存</li>
<li>通过设置环境变量<code>GODEBUG=&quot;gocacheverify=1&quot;</code>将会导致 go 命令绕过任何的缓存数据，而真正地执行操作，并重新生成所有结果，然后再去检查新的结果与现在的缓存数据是否一致</li>
<li>我们不需要在意缓存数据的存在，因为它们肯定不会妨碍<code>go test</code>命令打印正确的测试结果</li>
<li>对于失败测试的结果，<code>go test</code>命令并不会进行缓存</li>
</ul>
<h3 id="测试日志">测试日志</h3>
<ul>
<li><code>t.Log</code>和<code>t.Logf</code>方法用来打印常规的测试日志，只有测试失败时，这类日志才会被打印。如果测试成功了，它们不会被打印。如果想在测试成功时看到这类日志，可以在<code>go test</code>命令上加上<code>-v</code>选项。</li>
</ul>
<h3 id="测试方法">测试方法</h3>
<ul>
<li><code>t.Fail</code>方法会让当前测试失败，但不会立刻终止当前测试。</li>
<li><code>t.FailNow</code>方法会让当前测试失败，且立刻终止当前测试（注意，是终止当前测试，并不是终止整个测试程序，其他测试还会继续正常运行）。</li>
</ul>
<h2 id="性能测试">性能测试</h2>
<h3 id="执行性能测试">执行性能测试</h3>
<blockquote>
<p><code>go test -bench=. -run='^$' puzzlers/article20/q3</code></p>
</blockquote>
<ul>
<li><code>-bench=.</code>表示执行任意名称的性能测试函数</li>
<li><code>-run='^$'</code>表示执行空名称的功能测试函数，即不执行任何功能测试函数。（不加<code>--run=^$'</code>的话也会执行此测试包中的功能测试函数）</li>
<li><code>-bench=</code>和<code>-run</code>都必须使用正则表达式</li>
</ul>
<h3 id="性能测试结果">性能测试结果</h3>
<pre tabindex="0"><code>&gt;&gt;&gt; go test -v -bench=. -run=&#39;^$&#39; puzzlers/article20/q3                                                               20:02:05 (03-03)
goos: darwin
goarch: amd64
pkg: puzzlers/article20/q3
BenchmarkGetPrimes-4      300000              5571 ns/op
PASS
ok      puzzlers/article20/q3   1.739s
</code></pre><ul>
<li>重点描述倒数第三行，<code>BenchmarkGetPrimes-4</code>被称为单个性能测试的名称，它表示执行了性能测试<code>BenchmarkGetPrimes</code>，并且当时所用的最大 P 的数量为4。
<ul>
<li>最大 P 的数量相当于可以同时运行 Goroutine 的逻辑 CPU 的最大个数，这里的逻辑 CPU 也可以被称为 CPU 核心，但它并不等同于计算机中真正的 CPU，只是 Go 语言运行时系统内部的一个概念，代表着它同时运行 Goroutine 的能力。</li>
<li>可以在测试时通过<code>-cpu 8</code>选项来调整最大 P 个数，它可以模拟被测程序在计算能力不同的计算机中的性能表现</li>
</ul>
</li>
<li><code>300000</code>表示被测试函数的执行次数</li>
<li><code>5571 ns/op</code>表示执行被测试函数的平均执行时间是 5571 纳秒。</li>
</ul>
<p><img src="https://static001.geekbang.org/resource/image/78/69/78d4c73a9aa9d48b59d3fd304d4b2069.png" alt=""></p>
<h3 id="性能测试过程">性能测试过程</h3>
<ul>
<li>
<p>在测试时间上限不变的情况下，<code>go test</code>会不断调整<code>b.N</code>的值，直到找到被测程序的最大执行次数。这样的过程称为 <strong>对性能测试函数的一次探索式执行</strong> 。</p>
</li>
<li>
<p>测试函数的实际执行次数</p>
</li>
</ul>
<p><img src="https://passage-1253400711.cos-website.ap-beijing.myqcloud.com/2019-03-06-235218.jpg" alt=""></p>
<h3 id="性能测试的计时器">性能测试的计时器</h3>
<ul>
<li><code>b.StopTimer</code>和<code>b.StartTimer</code>可以停止和启动计时器，将某些代码的执行过程不计入总的执行时间中</li>
<li><code>b.ResetTimer</code>用于去除在调用它之前的那些代码的执行时间</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">q3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;testing&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">BenchmarkGetPrimes</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">b</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">testing</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">B</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 你可以注释或者还原下面这四行代码中的第一行和第四行，
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// 并观察测试结果的不同。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">b</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StopTimer</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sleep</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Millisecond</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">500</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic">// 模拟某个耗时但与被测程序关系不大的操作。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">max</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#0000cf;font-weight:bold">10000</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">b</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StartTimer</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#000">b</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">N</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">GetPrimes</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">max</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>&gt;&gt;&gt; go <span style="color:#204a87">test</span> -count<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">2</span> -bench<span style="color:#ce5c00;font-weight:bold">=</span>. -v puzzlers/article21/q3                                                                08:10:39 <span style="color:#ce5c00;font-weight:bold">(</span>03-07<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>goos: darwin
</span></span><span style="display:flex;"><span>goarch: amd64
</span></span><span style="display:flex;"><span>pkg: puzzlers/article21/q3
</span></span><span style="display:flex;"><span>BenchmarkGetPrimes-4       <span style="color:#0000cf;font-weight:bold">20000</span>             <span style="color:#0000cf;font-weight:bold">67431</span> ns/op
</span></span><span style="display:flex;"><span>BenchmarkGetPrimes-4       <span style="color:#0000cf;font-weight:bold">20000</span>             <span style="color:#0000cf;font-weight:bold">68273</span> ns/op
</span></span><span style="display:flex;"><span>PASS
</span></span><span style="display:flex;"><span>ok      puzzlers/article21/q3   8.069s
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; go <span style="color:#204a87">test</span> -count<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">2</span> -bench<span style="color:#ce5c00;font-weight:bold">=</span>. -v puzzlers/article21/q3                                                                08:11:00 <span style="color:#ce5c00;font-weight:bold">(</span>03-07<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>goos: darwin
</span></span><span style="display:flex;"><span>goarch: amd64
</span></span><span style="display:flex;"><span>pkg: puzzlers/article21/q3
</span></span><span style="display:flex;"><span>BenchmarkGetPrimes-4       <span style="color:#0000cf;font-weight:bold">10000</span>            <span style="color:#0000cf;font-weight:bold">113835</span> ns/op
</span></span><span style="display:flex;"><span>BenchmarkGetPrimes-4       <span style="color:#0000cf;font-weight:bold">10000</span>            <span style="color:#0000cf;font-weight:bold">115399</span> ns/op
</span></span><span style="display:flex;"><span>PASS
</span></span><span style="display:flex;"><span>ok      puzzlers/article21/q3   11.993s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 注释掉计时器相关的代码后，程序的平均执行时间增加了500毫秒左右</span>
</span></span></code></pre></div><h2 id="思考题">思考题</h2>
<h3 id="-benchmem标记和-benchtime标记的作用分别是什么"><code>-benchmem</code>标记和<code>-benchtime</code>标记的作用分别是什么？</h3>
<p><code>-benchmem</code> 输出基准测试的内存分配统计信息。
<code>-benchtime</code> 用于指定基准测试的探索式测试执行时间上限</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ go <span style="color:#204a87">test</span> -bench<span style="color:#ce5c00;font-weight:bold">=</span>. word
</span></span><span style="display:flex;"><span>goos: linux
</span></span><span style="display:flex;"><span>goarch: amd64
</span></span><span style="display:flex;"><span>pkg: word
</span></span><span style="display:flex;"><span>BenchmarkIsPalindrome-4     <span style="color:#0000cf;font-weight:bold">2000000000</span>     0.00 ns/op
</span></span><span style="display:flex;"><span>PASS
</span></span><span style="display:flex;"><span>ok     word    0.002s
</span></span><span style="display:flex;"><span>$ go <span style="color:#204a87">test</span> -bench<span style="color:#ce5c00;font-weight:bold">=</span>. -benchmem -benchtime 10s word
</span></span><span style="display:flex;"><span>goos: linux
</span></span><span style="display:flex;"><span>goarch: amd64
</span></span><span style="display:flex;"><span>pkg: word
</span></span><span style="display:flex;"><span>BenchmarkIsPalindrome-4     <span style="color:#0000cf;font-weight:bold">10000000000</span>     0.00 ns/op     <span style="color:#0000cf;font-weight:bold">0</span> B/op     <span style="color:#0000cf;font-weight:bold">0</span> allocs/op
</span></span><span style="display:flex;"><span>PASS
</span></span><span style="display:flex;"><span>ok     word    0.003s
</span></span></code></pre></div><ul>
<li>注意输出部分多的那两部分（0 B/op，0 allocs/op）以及执行次数。</li>
</ul>
<h3 id="怎样在测试的时候开启测试覆盖度分析如果开启会有什么副作用吗">怎样在测试的时候开启测试覆盖度分析？如果开启，会有什么副作用吗？</h3>
<ul>
<li>使用<code>-coverprofile=xxxx.out</code>输出覆盖率的out文件，使用<code>go tool cover -html=xxxx.out</code>命令转换成Html的覆盖率测试报告。</li>
<li>覆盖率测试将被测试的代码拷贝一份，在每个语句块中加入bool标识变量，测试结束后统计覆盖率并输出成out文件，因此性能上会有一定的影响。</li>
<li>使用<code>-covermode=count</code>标识参数将插入的标识变量由bool类型转换为计数器，在测试过程中，记录执行次数，用于找出被频繁执行的代码块，方便优化。</li>
</ul>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-aabb7b6e45359f405fea1a56992f5042">16.25 - Dependency injection in Golang using higher order functions</h1>
    
	<blockquote>
<ul>
<li>原文地址: <a href="https://stein.wtf/posts/2019-03-12/inject/">https://stein.wtf/posts/2019-03-12/inject/</a></li>
<li>相关代码: <a href="https://github.com/steinfletcher/func-dependency-injection-go">https://github.com/steinfletcher/func-dependency-injection-go</a></li>
</ul>
</blockquote>
<ul>
<li>以下分别为 Go 实现和 Java 实现的对比</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000">DB</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">User</span> <span style="color:#000">SelectUser</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">String</span> <span style="color:#000">id</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">UserService</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#204a87;font-weight:bold">final</span> <span style="color:#000">DB</span> <span style="color:#000">db</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">UserService</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">DB</span> <span style="color:#000">db</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">this</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">DB</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">db</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#000">UserProfile</span> <span style="color:#000">getUserProfile</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">String</span> <span style="color:#000">id</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">User</span> <span style="color:#000">user</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">this</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">DB</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">SelectUser</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">id</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">UserProfile</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">DB</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">SelectUser</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">User</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">getUserProfile</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">UserProfile</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">newGetUserProfile</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">db</span> <span style="color:#000">DB</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">getUserProfile</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">UserProfile</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">user</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">db</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SelectUser</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">userProfile</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><ul>
<li>从以上的代码可以看出，Go 的实现中没有刻意去创建对象，而是实现了一个工厂函数，所以整体的实现更精简一些。</li>
</ul>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-c7d2056c34effb010b85e592bf9d77d9">16.26 - Go 模板</h1>
    
	<p>关于 Go 模板的笔记</p>
<h2 id="字段操作">字段操作</h2>
<p>Go 语言的模板通过<code>{{}}</code>来插入变量，<code>{{.}}</code>表示当前对象，类似于 C++ 中的 this 或者 Python 中的 self。<code>{{ .FieldName }}</code>用来获取当前对象中的字段<code>FieldName</code>，需要注意的是字段名必须是<code>exported</code>的(即变量的首字母必须是大写)。</p>
<p>如果字段名不是<code>exported</code>的，那么就会有如下错误:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">template</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">header</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">html</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">14</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">executing</span> <span style="color:#4e9a06">&#34;header.html&#34;</span> <span style="color:#000">at</span> <span style="color:#000;font-weight:bold">&lt;.</span><span style="color:#000">title</span><span style="color:#000;font-weight:bold">&gt;:</span> <span style="color:#000">title</span> <span style="color:#000">is</span> <span style="color:#000">an</span> <span style="color:#000">unexported</span> <span style="color:#000">field</span> <span style="color:#000">of</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#204a87;font-weight:bold">type</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Env</span> <span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">title</span> <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><ul>
<li>可以用下面这种形式输出字符串变量<code>string</code></li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{{</span> <span style="color:#4e9a06">`string`</span> <span style="color:#000;font-weight:bold">}}</span>
</span></span></code></pre></div><h2 id="输出嵌套内容">输出嵌套内容</h2>
<p><code>with</code>操作可以更改当前<code>{{ . }}</code>所指向的对象。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">t</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">template</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">New</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;test_with&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Parse</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">`</span><span style="color:#8f5902;font-style:italic">{{</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">with</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#c4a000">.Env</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">}}{{</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">range</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">$key</span><span style="color:#ce5c00;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">$val</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">:=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#c4a000">.</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">}}</span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    </span><span style="color:#8f5902;font-style:italic">{{</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">$key</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">}}</span><span style="color:#4e9a06">: </span><span style="color:#8f5902;font-style:italic">{{</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">$val</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">}}</span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    </span><span style="color:#8f5902;font-style:italic">{{</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">end</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">}}{{</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">end</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">}}</span><span style="color:#4e9a06">`</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Execute</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Stdout</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">Env</span> <span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">]</span><span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">Env</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#4e9a06">&#34;Home&#34;</span><span style="color:#000;font-weight:bold">:</span>  <span style="color:#4e9a06">&#34;jc&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#4e9a06">&#34;Lover&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;xff&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="pipelines">pipelines</h2>
<ul>
<li>在 Go 语言模板中，任何<code>{{}}</code>里面的内容都是pipelines数据</li>
<li>pipelines数据之间可以通过<code>|</code>联系起来，例如: <code>{{ &quot;&lt;output&gt;&quot; | html }}</code></li>
</ul>
<h2 id="自定义函数">自定义函数</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;html/template&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;strings&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Friend</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">Fname</span> <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Person</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">UserName</span> <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">Emails</span>   <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">Friends</span>  <span style="color:#000;font-weight:bold">[]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Friend</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">EmailDealWith</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">args</span> <span style="color:#ce5c00;font-weight:bold">...</span><span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">ok</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">s</span> <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">args</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">s</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ok</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">].(</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">ok</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">s</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sprint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">args</span><span style="color:#ce5c00;font-weight:bold">...</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// find the @ symbol
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">substrs</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">strings</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Split</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;@&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">substrs</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#0000cf;font-weight:bold">2</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">s</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// replace the @ by &#34; at &#34;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">substrs</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#4e9a06">&#34; at &#34;</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">substrs</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">])</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">Upper</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">args</span> <span style="color:#ce5c00;font-weight:bold">...</span><span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">ok</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">s</span> <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">args</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">s</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ok</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">].(</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">ok</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">s</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sprint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">args</span><span style="color:#ce5c00;font-weight:bold">...</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">strings</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ToUpper</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">EmailDealWith</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;a&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;b&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;@&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;c&#34;</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">f1</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">Friend</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">Fname</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;minux.ma&#34;</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">f2</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">Friend</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">Fname</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;xushiwei&#34;</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">t</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">template</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">New</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;fieldname example&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">t</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Funcs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">template</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FuncMap</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;emailDeal&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">EmailDealWith</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;upper&#34;</span><span style="color:#000;font-weight:bold">:</span>     <span style="color:#000">Upper</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">t</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">_</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Parse</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">`hello </span><span style="color:#8f5902;font-style:italic">{{</span><span style="color:#c4a000">.UserName</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">upper</span><span style="color:#8f5902;font-style:italic">}}</span><span style="color:#4e9a06">!
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">                </span><span style="color:#8f5902;font-style:italic">{{</span><span style="color:#204a87;font-weight:bold">range</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#c4a000">.Emails</span><span style="color:#8f5902;font-style:italic">}}</span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">                    an emails </span><span style="color:#8f5902;font-style:italic">{{</span><span style="color:#c4a000">.</span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#000">emailDeal</span><span style="color:#8f5902;font-style:italic">}}</span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">                </span><span style="color:#8f5902;font-style:italic">{{</span><span style="color:#204a87;font-weight:bold">end</span><span style="color:#8f5902;font-style:italic">}}</span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">                </span><span style="color:#8f5902;font-style:italic">{{</span><span style="color:#204a87;font-weight:bold">with</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#c4a000">.Friends</span><span style="color:#8f5902;font-style:italic">}}</span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">                </span><span style="color:#8f5902;font-style:italic">{{</span><span style="color:#204a87;font-weight:bold">range</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#c4a000">.</span><span style="color:#8f5902;font-style:italic">}}</span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">                    my friend name is </span><span style="color:#8f5902;font-style:italic">{{</span><span style="color:#c4a000">.Fname</span><span style="color:#8f5902;font-style:italic">}}</span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">                </span><span style="color:#8f5902;font-style:italic">{{</span><span style="color:#204a87;font-weight:bold">end</span><span style="color:#8f5902;font-style:italic">}}</span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">                </span><span style="color:#8f5902;font-style:italic">{{</span><span style="color:#204a87;font-weight:bold">end</span><span style="color:#8f5902;font-style:italic">}}</span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">                `</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">p</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">Person</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">UserName</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Astaxie&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">Emails</span><span style="color:#000;font-weight:bold">:</span>  <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">{</span><span style="color:#4e9a06">&#34;astaxie@beego.me&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;astaxie@gmail.com&#34;</span><span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">Friends</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Friend</span><span style="color:#000;font-weight:bold">{</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">f1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">f2</span><span style="color:#000;font-weight:bold">}}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Execute</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Stdout</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><ul>
<li>Go 模板包中还提供了许多自定义函数，<a href="https://golang.org/pkg/text/template/#hdr-Functions">相关文档</a></li>
</ul>
<h2 id="must">Must</h2>
<p><code>Must</code>是一个 helper 函数，用来检查模板编译是否正确，如果不正确就会panic。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">tErr</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">template</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">New</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;terr&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">template</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Must</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">tErr</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Parse</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">`some error </span><span style="color:#8f5902;font-style:italic">{{</span><span style="color:#000">text</span><span style="color:#a40000">}</span><span style="color:#4e9a06">`</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// panic: template: terr:1: function &#34;text&#34; not defined
</span></span></span></code></pre></div><h2 id="模板嵌套">模板嵌套</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span>// header.html
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">&lt;!DOCTYPE html&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">html</span> <span style="color:#c4a000">lang</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;en&#34;</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">head</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">meta</span> <span style="color:#c4a000">charset</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;UTF-8&#34;</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">title</span><span style="color:#000;font-weight:bold">&gt;</span>{{ .Title }}<span style="color:#000;font-weight:bold">&lt;/</span><span style="color:#204a87;font-weight:bold">title</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">&lt;/</span><span style="color:#204a87;font-weight:bold">head</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">body</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span>    {{ template &#34;body&#34; . }}
</span></span><span style="display:flex;"><span>    {{ with .Env }}
</span></span><span style="display:flex;"><span>        {{ range $key, $val := . }}
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">li</span><span style="color:#000;font-weight:bold">&gt;</span>{{ $key }} -- {{ $val }}<span style="color:#000;font-weight:bold">&lt;/</span><span style="color:#204a87;font-weight:bold">li</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span>        {{ end }}
</span></span><span style="display:flex;"><span>    {{ end }}
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">&lt;/</span><span style="color:#204a87;font-weight:bold">body</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">&lt;/</span><span style="color:#204a87;font-weight:bold">html</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>// body.html
</span></span><span style="display:flex;"><span>{{ define &#34;body&#34; }}
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">ul</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span>    {{ range $key, $val := .Env }}
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">li</span><span style="color:#000;font-weight:bold">&gt;</span>{{ $key }} -- {{ $val }}<span style="color:#000;font-weight:bold">&lt;/</span><span style="color:#204a87;font-weight:bold">li</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span>    {{ end }}
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">&lt;/</span><span style="color:#204a87;font-weight:bold">ul</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span>{{ end }}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// main.go
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;text/template&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">t</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">template</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ParseFiles</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;header.html&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;body.html&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatalln</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">env</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#4e9a06">&#34;Home&#34;</span><span style="color:#000;font-weight:bold">:</span>  <span style="color:#4e9a06">&#34;/Users/michaletsui&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#4e9a06">&#34;Shell&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;/bin/bash&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Execute</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Stdout</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Env</span>   <span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">]</span><span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Title</span> <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Env</span><span style="color:#000;font-weight:bold">:</span>   <span style="color:#000">env</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Title</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Go 模板&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatalln</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><ul>
<li><code>{{ define &quot;blockname&quot; }}...{{ end }}</code>可以定义一个 block</li>
<li><code>{{ template &quot;blockname&quot; }}</code> 将会调用一个 block</li>
<li><code>t.Execute</code>传递的对象并不会直接传递给 block，需要<code>{{ block &quot;body&quot; . }}</code>这样显示传递</li>
<li>同一个集合类的模板是互相知晓的，如果同一模板被多个集合使用，则它需要在多个集合中分别解析</li>
<li><code>template.ParseFiles</code>将第一个文件作为主模板</li>
<li><code>t.ExecuteTemplate</code>可以指定要执行的主模板</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">t</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">template</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ParseFiles</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;body.html&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;header.html&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatalln</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">env</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;Home&#34;</span><span style="color:#000;font-weight:bold">:</span>  <span style="color:#4e9a06">&#34;/Users/michaletsui&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;Shell&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;/bin/bash&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">data</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">Env</span>   <span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">]</span><span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">Title</span> <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">Env</span><span style="color:#000;font-weight:bold">:</span>   <span style="color:#000">env</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">Title</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Go 模板&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// 因为 body.html 作为主模板除了定义的block外没有其它内容，所以`t.Execute`没有不会输出任何内容
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// 故这里通过 `t.ExecuteTemplate` 来指定主模板
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// 也可以通过下面的方式
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// t = t.Lookup(&#34;header.html&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// err = t.Execute(os.Stdout, data)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ExecuteTemplate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Stdout</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;header.html&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">data</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatalln</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="参考链接">参考链接</h2>
<ul>
<li>
<p><a href="https://colobu.com/2016/10/09/Go-embedded-template-best-practices/">Go 模板嵌套最佳实践
</a></p>
</li>
<li>
<p><a href="https://github.com/astaxie/build-web-application-with-golang/blob/master/zh/07.4.md#must%E6%93%8D%E4%BD%9C">build-web-application-with-golang 07.4</a></p>
</li>
</ul>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-c6e65801f450a5190e19f70c05c579be">16.27 - Go mod 说明</h1>
    
	<p>关于 Go mod 的介绍</p>
<ul>
<li><a href="https://roberto.selbach.ca/intro-to-go-modules/">Introduction to Go Modules</a></li>
<li><a href="https://github.com/bwangelme/testmod">Github 仓库</a></li>
<li><a href="https://github.com/bwangelme/testmod_demo">使用这个仓库的Demo</a></li>
</ul>
<h2 id="版本号的说明">版本号的说明</h2>
<ul>
<li>版本号由三个部分组成: <code>主版本.副版本.修订号</code></li>
<li>修订号的增加表示修复了一些BUG</li>
<li>副版本号的增加表示修改了一些内部实现的逻辑，但是对外提供的接口没有改变</li>
<li>主版本号的增加表示修改了对外提供的接口，主版本之间是可以不兼容的</li>
</ul>
<h2 id="go-module-模式下的核心原则">Go Module 模式下的核心原则</h2>
<p>Go Module 模式是指 <code>GO111MODULE=on</code> 时:</p>
<ol>
<li>一个包的导入路径定义了该包的唯一标识。
<ul>
<li>具有不同导入路径的包被视为不同的包。</li>
<li>具有相同导入路径的包被视为相同的包（即使 VCS 标签说这些包有不同的主要版本，Go 也认为它们是同一个包）。</li>
</ul>
</li>
<li>没有 <code>/vN</code> 的导入路径被视为v1或v0模块，即使导入的包没有选择加入模块模式(无 go.mod 文件)，并且 VCS 标签显示主版本号大于1，Go 也认为其主版本号是 V0 或 V1。</li>
<li>在一个模块的 go.mod 文件的开头所声明的模块路径（如模块foo/v2）有两层含义。
<ul>
<li>对该模块身份的明确声明</li>
<li>关于该模块该如何被消费代码导入的正确声明</li>
</ul>
</li>
</ol>
<h2 id="go-mod-版本管理">Go mod 版本管理</h2>
<ul>
<li><strong>注意</strong>: 使用 go mod 进行管理的仓库必须放置在<code>GOPATH</code>外</li>
<li>Go mod 通过 Git 的标签来标记版本 <code>git tag v1.0.0 &amp;&amp; git push --tags</code></li>
<li>建议为每个主版本新建一个分支(<code>git checkout -b v1</code>)</li>
<li><code>go mod init reponame</code>可以创建一个库</li>
<li><code>go build</code>命令会自动分析代码中的依赖，并获取相应版本的库</li>
<li><code>go get -u</code>将会升级依赖的副版本号或者修订号</li>
<li><code>go get -u=patch</code>将会升级修订号，但是不会升级副版本号</li>
<li><code>go get package@version</code>表示安装特定版本的的依赖</li>
<li>Go会将依赖写在仓库下的<code>go.mod</code>和<code>go.sum</code>文件中</li>
</ul>
<h2 id="主版本升级">主版本升级</h2>
<ul>
<li>当仓库的主版本发生变化时，其导入路径也应该随之改变，具体就是将<code>go.mod</code>中的<code>github.com/user/repo</code>改成<code>github.com/user/repo/v2</code></li>
</ul>
<p>在Golang中，一个依赖可以同时存在两个主版本不同的<code>import</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;github.com/user/repo&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">repov2</span> <span style="color:#4e9a06">&#34;github.com/user/repo/v2&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>故当一个仓库需要升级某个依赖的主版本时，其代码导入路径要随之改变。如果依赖的API变了，那么仓库也要进行相应的更改。</p>
<h2 id="清除依赖">清除依赖</h2>
<p><code>go mod tidy</code>命令可以移除<code>go.mod</code>中不再使用的依赖</p>
<h2 id="go-mod-和-vendoring">Go mod 和 Vendoring</h2>
<ul>
<li>Go 1.12 支持使用<code>go mod verdor</code>命令将依赖安装在仓库的<code>vendor</code>目录下</li>
<li><code>go build</code>命令会忽略掉<code>vendor</code>目录，<code>go build -mod vendor</code>命令会从当前目录的<code>vendor</code>目录下寻找依赖</li>
</ul>
<h2 id="安装位置">安装位置</h2>
<p>Go 将依赖安装在<code>GOPATH/pkg/mod</code>中，并且依赖的每个版本会分开安装</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>&gt;&gt;&gt; tree <span style="color:#000">$GOPATH</span>/pkg/mod/github.com/bwangelme/
</span></span><span style="display:flex;"><span>/Users/michaeltsui/go/pkg/mod/github.com/bwangelme/
</span></span><span style="display:flex;"><span>├── testmod
</span></span><span style="display:flex;"><span>│   └── v2@v2.0.0
</span></span><span style="display:flex;"><span>│       ├── README.md
</span></span><span style="display:flex;"><span>│       ├── go.mod
</span></span><span style="display:flex;"><span>│       └── testmod.go
</span></span><span style="display:flex;"><span>├── testmod@v1.0.0
</span></span><span style="display:flex;"><span>│   ├── README.md
</span></span><span style="display:flex;"><span>│   ├── go.mod
</span></span><span style="display:flex;"><span>│   └── testmod.go
</span></span><span style="display:flex;"><span>└── testmod@v1.0.1
</span></span><span style="display:flex;"><span>    ├── README.md
</span></span><span style="display:flex;"><span>    ├── go.mod
</span></span><span style="display:flex;"><span>    └── testmod.go
</span></span></code></pre></div><h2 id="查看依赖">查看依赖</h2>
<ul>
<li>查看当前仓库依赖的所有 module</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>go list -m -json all
</span></span></code></pre></div><ul>
<li>查看 github.com 域名下所有的 module</li>
</ul>
<pre tabindex="0"><code>go list -m -json &#39;github.com/...&#39;
</code></pre><p><code>-m</code> 选项让 go list 列出所有的 module 而不是包。在这种模式下，<code>go list</code> 的参数可以是模块或模块模式(包含 <code>...</code> 通配符)，<a href="https://go.dev/ref/mod#version-queries">Version Query</a>，或者特殊模式 <code>all</code>(匹配<a href="https://go.dev/ref/mod#glos-build-list">构建列表</a>中的所有模块)。如果没有指定参数，<a href="https://go.dev/ref/mod#glos-main-module">主模块</a>将被列出。</p>
<h2 id="关于-incompatible-版本标签的说明">关于 incompatible 版本标签的说明</h2>
<ul>
<li>被导入的包没有选择加入 module 模式，无 go.mod 文件</li>
<li>被导入的包有语义化版本号 VCS 标签，且该标签表示的版本主版本号大于1</li>
<li>Go Module 核心原则第2点生效，导入路径中没有 <code>/vN</code>，它将被视为 v1 或 v0 模块，VCS 标签不生效</li>
</ul>
<p>当 Go 处于 Module 模式时，它将假设一个非 module 模式的 V2+ 版本的包不理解 <code>语义化导入版本控制(Semantic Import Versioning)</code>，从而将其视为该包 V1 版本系列的不兼容扩展。<code>incompatible</code> 后缀即表示该包是一个不兼容 V1 旧版本的 V1 扩展版本。</p>
<h2 id="版本选择">版本选择</h2>
<p>如果你在你的代码中添加了一个新的导入，而这个导入还没有被 go.mod 中的 require 指令所覆盖。
大多数go命令如 <code>go build</code> 和 <code>go test</code> 会自动查找合适的模块，并将这个新的直接依赖的最高版本作为 require 指令添加到你的模块的 go.mod 中。</p>
<p>例如，如果你的新导入对应的依赖 M 包的最新标签发布版本是v1.2.3，你的模块的 go.mod 中将添加指令 <code>require M v1.2.3</code>，这表明模块 M 是一个允许版本 <code>&gt;= v1.2.3</code> 的依赖关系，并且 <code>&lt; v2</code>，因为v2被认为与v1不兼容。</p>
<p><code>最小版本选择算法 (Minimal Version Selection Algorithm)</code> 被用来选择在构建中使用的所有模块的版本。对于构建中的每个模块，通过最小版本选择算法所选择的版本总是语义上最高的版本，该版本由主模块或其依赖关系中的 require 指令明确列出。</p>
<p>例如，主模块依赖模块A，而模块A有一个 require D v1.0.0，主模块也依赖模块B，而模块B有一个 require D v1.1.1，那么最小版本选择算法会选择 D 的 v1.1.1 版本用来包含在构建中（因为它是列出的最高 require 版本）。
即使后来 D 的 v1.2.0 版本发布了，在构建中仍然会选择 v1.1.1。这是一个模块系统如何提供 100% 可重复构建的例子。
当准备就绪时，模块作者或用户可以选择升级到D的最新可用版本或为D选择一个明确的版本。</p>
<h2 id="参考链接">参考链接</h2>
<ul>
<li><a href="https://go.dev/ref/mod">https://go.dev/ref/mod</a></li>
<li><a href="https://github.com/golang/go/wiki/Modules">https://github.com/golang/go/wiki/Modules</a></li>
</ul>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-d5aeefffc066619e66f31549c58e377a">16.28 - 素数生成器</h1>
    
	<p>一个不太优雅的素数生成器，主要用来观察“Go-routine + 管道”的开发方式</p>
<h2 id="前言">前言</h2>
<p>在阅读《Go高级编程》的时候，里面有个用 Newsqueak 编写的生成素数的例子，感觉这个例子很有意思，我就把它用Go重写了一下，特来此记录一下。</p>
<h2 id="代码">代码</h2>
<p>下面的程序实现了一个“素数生成器”，它将会输出前<code>N</code>个素数:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">counter</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#0000cf;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">i</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">/*
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * FilterPrime 将素数`prime`的倍数过滤掉，将不是`prime`倍数的数字输出
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> *
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 图示说明: https://passage-1253400711.cos.ap-beijing.myqcloud.com/2018-08-13-150647.png
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">FilterPrime</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">prime</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">listen</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">send</span> <span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">i</span> <span style="color:#204a87;font-weight:bold">int</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">i</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#000">listen</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#000">prime</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">send</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">i</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">sieve</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">prime</span> <span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">counter</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">prime</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">p</span> <span style="color:#204a87;font-weight:bold">int</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">newc</span> <span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">int</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">p</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#000">c</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">prime</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">p</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">newc</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">FilterPrime</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">newc</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">c</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">newc</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">prime</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 这种方法计算素数，每产生一个素数，就需要新建一个goroutine。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// 例如求前N个素数，空间复杂度为O(N)，时间复杂度为O(M)，M表示第N个素数的大小
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">prime</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">sieve</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">N</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">100</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">times</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#000">N</span><span style="color:#000;font-weight:bold">][</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span><span style="color:#204a87;font-weight:bold">int</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">times</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">p</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#000">prime</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="分析">分析</h2>
<p>整个素数生成器可以用下面这张流程图来表示。</p>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2018-08-13-150647.png" alt="素数生成器流程图"></p>
<p>上图中各个 Goroutine 的说明如下</p>
<ul>
<li>Counter 用来生成从2到N的数字</li>
<li><code>FilterPrimer(prime, listen, send)</code> 从<code>listen</code>__输入管道__中读取数字，将素数<code>prime</code>的倍数过滤掉，然后将结果输出到<code>send</code>__输出管道__中</li>
<li><code>sieve</code>负责从读取素数，并根据产生的素数新建<code>FilterPrime</code>进行后续的过滤</li>
</ul>
<p>整个程序的流程如下：</p>
<ul>
<li>Counter 产生第一个素数2，<code>sieve</code> Goroutine 将2输出到<code>prime</code>管道中，并以此建立 Goroutine <code>FilterPrime(2)</code>，<code>Counter</code>的输出管道会成为<code>FilterPrime(2)</code>的输入管道</li>
<li><code>FilterPrime(2)</code>从输入管道中读取数字并过滤输出，它输出的第一个数字是素数3。<code>sieve</code> Goroutine 将3输出到<code>prime</code>管道中，并以此建立 Goroutine <code>FilterPrime(3)</code>，<code>FilterPrime(2)</code>的输出管道会作为<code>FilterPrime(3)</code>的输入管道</li>
<li><code>FilterPrime(3)</code>从输入管道读取数字并过滤输出，它输出的第一个数字是素数5（4已经被<code>FilterPrime(2)</code>过滤掉了）。<code>sieve</code> Goroutine 将5输出到<code>prime</code>管道中，并以此建立 Goroutine <code>FilterPrime(5)</code>，<code>FilterPrime(3)</code>的输出管道会作为<code>FilterPrime(5)</code>的输入管道</li>
<li>依次类推。。。</li>
<li>最终可以从管道<code>prime</code>中读取出素数，<code>prime</code>管道每次读取，数字都会从<code>Counter</code>产生，然后经过一层层过滤，最终将素数输出出来，并根据这个输出的素数，建立下一个<code>FilterPrime</code> Goroutine。</li>
</ul>
<p>从上面的分析中我们可以看出，如果我们想要获取前N个素数，那么就需要建立N+2个 Goroutine 和N+1个 Channel 。故其空间复杂度为O(2N)。同时，整个程序的流程就是<code>Counter</code>产生数字，然后经历一个一个的<code>FilterPrime</code>，最终将素数过滤出来，整个循环只进行一次，所以时间复杂度为O(M)，其中M表示第N个素数的值。</p>
<h2 id="参考文章">参考文章</h2>
<ul>
<li><a href="https://chai2010.gitbooks.io/advanced-go-programming-book/content/ch1-basic/ch1-02-hello-revolution.html">《Go高级编程》1.2.3小节</a></li>
</ul>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-5d60a98a1071c1eb27363bb8fd0863bf">16.29 - Go 语言的 Type Switch 语句解析</h1>
    
	<p>讲述了Go语言中 Type Swith 的用法以及获取对应变量的一些特殊情况。</p>
<h2 id="type-switch-的基本用法">Type Switch 的基本用法</h2>
<p>Type Switch 是 Go 语言中一种特殊的 switch 语句，它比较的是类型而不是具体的值。它判断某个接口变量的类型，然后根据具体类型再做相应处理。注意，在 Type Switch 语句的 case 子句中不能使用<code>fallthrough</code>。</p>
<p>它的用法如下。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">switch</span> <span style="color:#000">x</span><span style="color:#000;font-weight:bold">.(</span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">Type1</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">doSomeThingWithType1</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">Type2</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">doSomeThingWithType2</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">default</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">doSomeDefaultThing</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>其中，<code>x</code>必须是一个接口类型的变量，而所有的<code>case</code>语句后面跟的类型必须实现了<code>x</code>的接口类型。</p>
<p>为了便于理解，我们可以结合下面这个例子来看:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;reflect&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Animal</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">shout</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Dog</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">self</span> <span style="color:#000">Dog</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">shout</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;wang wang&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Cat</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">self</span> <span style="color:#000">Cat</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">shout</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;miao miao&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">animal</span> <span style="color:#000">Animal</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">Dog</span><span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">switch</span> <span style="color:#000">animal</span><span style="color:#000;font-weight:bold">.(</span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">Dog</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;animal&#39;type is Dog&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">Cat</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;animal&#39;type is Cat&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>在上面的例子中，<code>Cat</code>和<code>Dog</code>类型都实现了接口<code>Animal</code>，所以它们可以跟在<code>case</code>语句后面，判断接口变量<code>animal</code>是否是对应的类型。</p>
<h2 id="在switch的语句表达式中声明变量">在Switch的语句表达式中声明变量</h2>
<p>如果我们不仅想要判断某个接口变量的类型，还想要获得其类型转换后的值的话，我们可以在 Switch 的语句表达式中声明一个变量来获得这个值。</p>
<p>其用法如下所示:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;reflect&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Animal</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">shout</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Dog</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">name</span> <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">self</span> <span style="color:#000">Dog</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">shout</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;wang wang&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Cat</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">name</span> <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">self</span> <span style="color:#000">Cat</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">shout</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;miao miao&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Tiger</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">name</span> <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">self</span> <span style="color:#000">Tiger</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">shout</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;hou hou&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// var animal Animal = Tiger{}
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// var animal Animal  // 验证 case nil
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// var animal Animal = Wolf{} // 验证 default
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">animal</span> <span style="color:#000">Animal</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">Dog</span><span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">switch</span> <span style="color:#000">a</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">animal</span><span style="color:#000;font-weight:bold">.(</span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#8f5902;font-style:italic">// a的类型是 Animal
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;nil&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">a</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">Dog</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Cat</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#8f5902;font-style:italic">// a的类型是 Animal
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic">// 输出 {}
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// fmt.Println(a.name) 这里会报错，因为 Animal 类型没有成员name
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">Tiger</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#8f5902;font-style:italic">// a的类型是 Tiger
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">shout</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">a</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic">// 这里可以直接取出 name 成员
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">default</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#8f5902;font-style:italic">// a的类型是 Animal
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;default&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">reflect</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">TypeOf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">a</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>在上述代码中，我们可以看到<code>a := animal.(type)</code>语句隐式地为每个<code>case</code>子句声明了一个变量<code>a</code>。</p>
<p>变量<code>a</code>类型的判定规则如下:</p>
<ul>
<li>如果<code>case</code>后面跟着<strong>一个</strong>类型，那么变量<code>a</code>在这个<code>case</code>子句中就是这个类型。例如在<code>case Tiger</code>子句中<code>a</code>的类型就是<code>Tiger</code></li>
<li>如果<code>case</code>后面跟着<strong>多个</strong>类型，那么变量<code>a</code>的类型就是接口变量<code>animal</code>的类型，例如在<code>case Dog, Cat</code>子句中<code>a</code>的类型就是<code>Animal</code></li>
<li>如果<code>case</code>后面跟着<code>nil</code>，那么变量<code>a</code>的类型就是接口变量<code>animal</code>的类型<code>Animal</code>，通常这种子句用来判断未赋值的接口变量</li>
<li><code>default</code>子句中变量<code>a</code>的类型是接口变量<code>animal</code>的类型</li>
</ul>
<p>为了更好地理解上述规则，我们可以用<code>if</code>语句和类型断言来重写这个<code>switch</code>语句，如下所示：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>	<span style="color:#000">v</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">animal</span>   <span style="color:#8f5902;font-style:italic">// animal 只会被求值一次
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">v</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#8f5902;font-style:italic">// case nil 子句
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">a</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">v</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;nil&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">a</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">a</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">isTiger</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">v</span><span style="color:#000;font-weight:bold">.(</span><span style="color:#000">Tiger</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">isTiger</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#8f5902;font-style:italic">// case Tiger 子句
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">shout</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">a</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">isDog</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">v</span><span style="color:#000;font-weight:bold">.(</span><span style="color:#000">Dog</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">isCat</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">v</span><span style="color:#000;font-weight:bold">.(</span><span style="color:#000">Cat</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">isDog</span> <span style="color:#ce5c00;font-weight:bold">||</span> <span style="color:#000">isCat</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#8f5902;font-style:italic">// case Dog, Cat 子句
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#000">a</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">v</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#8f5902;font-style:italic">// fmt.Println(a.name)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#8f5902;font-style:italic">// default 子句
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#000">a</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">v</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;default&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">reflect</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">TypeOf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">a</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="参考链接">参考链接</h2>
<ul>
<li><a href="https://golang.org/ref/spec#Type_switches">The Go Programming Language Specification</a></li>
</ul>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-05bc77af5135b5de6472208f6d8b18f0">16.30 - Go的并发编程简述</h1>
    
	<p>简述了 Go 中的 goroutine，channel 和 WaitGroup，并通过例子来展示了这些功能的用法</p>
<h2 id="goroutine-简述">Goroutine 简述</h2>
<p>Go 对于异步编程提供了语言级别的支持，我们可以使用它的 goroutine 很方便地写出异步的代码。首先我们先通过一个简单的例子来认识 Go 的 goroutine。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;runtime&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 这里设置同时执行程序的最大CPU数为逻辑CPU的数量
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">runtime</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GOMAXPROCS</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">runtime</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NumCPU</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">number</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#0000cf;font-weight:bold">10</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#000">number</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">Count</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sleep</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">10</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Second</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">Count</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">index</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">sum</span> <span style="color:#204a87;font-weight:bold">int64</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">1000000000</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">sum</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#204a87">int64</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">index</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">sum</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 程序的输出结果
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span><span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">run</span> <span style="color:#000">goroutine</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">go</span>                                                                            <span style="color:#0000cf;font-weight:bold">20</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">32</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">31</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">09</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">19</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">4</span> <span style="color:#0000cf;font-weight:bold">499999999500000000</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">2</span> <span style="color:#0000cf;font-weight:bold">499999999500000000</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">3</span> <span style="color:#0000cf;font-weight:bold">499999999500000000</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">5</span> <span style="color:#0000cf;font-weight:bold">499999999500000000</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#0000cf;font-weight:bold">499999999500000000</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#0000cf;font-weight:bold">499999999500000000</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">7</span> <span style="color:#0000cf;font-weight:bold">499999999500000000</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">8</span> <span style="color:#0000cf;font-weight:bold">499999999500000000</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">9</span> <span style="color:#0000cf;font-weight:bold">499999999500000000</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">6</span> <span style="color:#0000cf;font-weight:bold">499999999500000000</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">run</span> <span style="color:#000">goroutine</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">go</span>  <span style="color:#0000cf;font-weight:bold">7.40</span><span style="color:#000">s</span> <span style="color:#000">user</span> <span style="color:#0000cf;font-weight:bold">0.09</span><span style="color:#000">s</span> <span style="color:#000">system</span> <span style="color:#0000cf;font-weight:bold">73</span><span style="color:#ce5c00;font-weight:bold">%</span> <span style="color:#000">cpu</span> <span style="color:#0000cf;font-weight:bold">10.239</span> <span style="color:#000">total</span>
</span></span></code></pre></div><p>在上面的代码中，我们启动了10个 goroutine 计算了10次{ 1 - 1000000000 }的和，主程序睡眠了10秒钟等待10个 goroutine 的结束。</p>
<p>goroutine 类似于 Python 中的协程。Go 语言自己实现了一个调度程序，负责调度 goroutine 的执行，每当 goroutine 程序遇到阻塞操作的时候，就把程序的控制权主动交还给调度程序，并保存自己的堆栈信息。Go 语言的调度程序拥有控制权后再来启动其他的 goroutine，其他的 goroutine 继续执行，当遇到阻塞操作后再把控制权交还给调度程序，以此往复，直到程序结束。</p>
<h2 id="main-程序等待-goroutine-结束">main 程序等待 goroutine 结束</h2>
<p>在上面的代码中，我们的主程序是通过<code>time.Sleep</code>来等待其他 goroutine 的结束，但是这样的方法很笨。我们需要在所有的 goroutine 运行完成之后，通知主程序退出，而不是让主程序傻傻地等一个固定时间。要实现这样的功能，我们可以使用<code>channel</code>或者<code>sync</code>包的<code>WaitGroup</code>类型。</p>
<h3 id="channel">Channel</h3>
<p>channel 是 Go 中的数据数据类型，可以被用来接收和发送数据，它具有一下特点:</p>
<ul>
<li>channel 必须要通过<code>make</code>函数创建</li>
<li>channel 是带有是类型的，<code>ch := make(chan int)</code>表示声明一个 channel，其接收和发送的数据只能为<code>int</code>类型。</li>
<li>管道可以有缓存，<code>ch := make(chan int, 20)</code>表示管道的缓存大小为20个int类型的数据。
<ul>
<li>管道的缓存满了的时候，发送操作会阻塞</li>
<li>管道的缓存空的时候，接收操作会阻塞</li>
<li>如果整个程序所有的 goroutine 都是阻塞的，那么程序就会抛出异常，这样做是为了预防死锁</li>
</ul>
</li>
</ul>
<p>我们可以通过 channel 来改造我们上面的代码，创建一个 channel 在主程序和 goroutine 之间通信，当所有的 goroutine 都完成之后，再来通知主程序退出。改进后的程序代码如下:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;runtime&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 这里设置同时执行程序的最大CPU数为逻辑CPU的数量
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">runtime</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GOMAXPROCS</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">runtime</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NumCPU</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">number</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#0000cf;font-weight:bold">10</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 在这里创建的一个 channel，channel 的缓存大小为我们需要运行的 goroutine 的数量
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// 这样当多个 goroutine 同时向 channel 中写入数据的时候也不会阻塞
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">bool</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">number</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#000">number</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">Count</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#000">number</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// 主程序在这里会从 channel 中读取 number 个值，所有的值都被读取成功之后，主程序才会结束
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#000">c</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">Count</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">index</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">c</span> <span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">bool</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 这里需要注意，尽管我们没有显示地声明，但是 channel 传递给函数的时候，是通过引用的方式传递的，
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// 因为如果是通过值传递的话， goroutine 中对 channel 写入的数据就无法通知到主程序了。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">sum</span> <span style="color:#204a87;font-weight:bold">int64</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">1000000000</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">sum</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#204a87">int64</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">index</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">sum</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// goroutine 在这里向 channel 中写入数据
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#204a87;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 程序的输出结果
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span><span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">run</span> <span style="color:#000">channel</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">go</span>                                               <span style="color:#0000cf;font-weight:bold">22</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">54</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">39</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">09</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">19</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">5</span> <span style="color:#0000cf;font-weight:bold">499999999500000000</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">2</span> <span style="color:#0000cf;font-weight:bold">499999999500000000</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">9</span> <span style="color:#0000cf;font-weight:bold">499999999500000000</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#0000cf;font-weight:bold">499999999500000000</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">3</span> <span style="color:#0000cf;font-weight:bold">499999999500000000</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">8</span> <span style="color:#0000cf;font-weight:bold">499999999500000000</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">7</span> <span style="color:#0000cf;font-weight:bold">499999999500000000</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#0000cf;font-weight:bold">499999999500000000</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">4</span> <span style="color:#0000cf;font-weight:bold">499999999500000000</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">6</span> <span style="color:#0000cf;font-weight:bold">499999999500000000</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">run</span> <span style="color:#000">channel</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">go</span>  <span style="color:#0000cf;font-weight:bold">7.44</span><span style="color:#000">s</span> <span style="color:#000">user</span> <span style="color:#0000cf;font-weight:bold">0.14</span><span style="color:#000">s</span> <span style="color:#000">system</span> <span style="color:#0000cf;font-weight:bold">299</span><span style="color:#ce5c00;font-weight:bold">%</span> <span style="color:#000">cpu</span> <span style="color:#0000cf;font-weight:bold">2.534</span> <span style="color:#000">total</span>
</span></span></code></pre></div><p>从上述程序的输出结果中我们可以看到，程序的运行时间明显减短了，我们也不用担心某些没有运行完的 goroutine 因为主程序的退出而被强制结束。</p>
<h3 id="waitgroup">WaitGroup</h3>
<p>完成主程序和协程的同步工作，除了使用 channel 之外，我们还可以使用 Go 的<code>sync.WaitGroup</code>类型，它可以让主程序阻塞地等待一组 goroutine 的结束，它的具体用法如下所示:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;runtime&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;sync&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 这里设置同时执行程序的最大CPU数为逻辑CPU的数量
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">runtime</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GOMAXPROCS</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">runtime</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NumCPU</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">number</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#0000cf;font-weight:bold">10</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 这里使用了一个WaitGroup来演示程序的并发效果
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// wg.Add(number) 表示一共有 number 个 goroutine 需要等待完成
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// wg.Done() 表示一个 goroutine 完成了
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// wg.Wait() 表示阻塞地等待 number 个 wg.Done() 的通知
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 需要注意的是wg传递给函数的时候，需要传递指针类型
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">wg</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">sync</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WaitGroup</span><span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">wg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">number</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#000">number</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">Count</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">wg</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">wg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Wait</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">Count</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">index</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">wg</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">sync</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WaitGroup</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">sum</span> <span style="color:#204a87;font-weight:bold">int64</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">1000000000</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">sum</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#204a87">int64</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">index</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">sum</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">wg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Done</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 程序的输出结果
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span><span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">run</span> <span style="color:#000">wait_group</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">go</span>                                            <span style="color:#0000cf;font-weight:bold">23</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">19</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">19</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">09</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">19</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">2</span> <span style="color:#0000cf;font-weight:bold">499999999500000000</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">9</span> <span style="color:#0000cf;font-weight:bold">499999999500000000</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">5</span> <span style="color:#0000cf;font-weight:bold">499999999500000000</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">7</span> <span style="color:#0000cf;font-weight:bold">499999999500000000</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#0000cf;font-weight:bold">499999999500000000</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">8</span> <span style="color:#0000cf;font-weight:bold">499999999500000000</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">3</span> <span style="color:#0000cf;font-weight:bold">499999999500000000</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">6</span> <span style="color:#0000cf;font-weight:bold">499999999500000000</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#0000cf;font-weight:bold">499999999500000000</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">4</span> <span style="color:#0000cf;font-weight:bold">499999999500000000</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">run</span> <span style="color:#000">wait_group</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">go</span>  <span style="color:#0000cf;font-weight:bold">7.38</span><span style="color:#000">s</span> <span style="color:#000">user</span> <span style="color:#0000cf;font-weight:bold">0.13</span><span style="color:#000">s</span> <span style="color:#000">system</span> <span style="color:#0000cf;font-weight:bold">302</span><span style="color:#ce5c00;font-weight:bold">%</span> <span style="color:#000">cpu</span> <span style="color:#0000cf;font-weight:bold">2.485</span> <span style="color:#000">total</span>
</span></span></code></pre></div><h2 id="使用-select-等待多个-channel">使用 select 等待多个 channel</h2>
<p>上面的代码中，我们演示的都是一个 goroutine 中操作一个 channel，当我们需要在 goroutine 中同时操作多个 channel 时该怎么办呢？这就需要用到我们的<code>select</code>语句，<code>select</code>语句和<code>switch</code>语句非常相似，只不过不同的是，<code>select</code>判断的是一个 channel 是否是可读写的，而不是表达式的值。我们可以通过下面的代码来查看<code>select</code>语句的用法:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 一下的程序演示了通过select语句动态地检查channel
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 这里创建了两个 channel c1和c2
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">c1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">c2</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 这里创建了一个判断结束的 channel o
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">o</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">bool</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// c1Close 和 c2Close 是两个标记，用来标记 goroutine 中 channel 是否已经关闭
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">c1Close</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">c2Close</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">select</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">v</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ok</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#000">c1</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>				<span style="color:#8f5902;font-style:italic">// c1 关闭以后 ok 会为False
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>				<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">ok</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">c1Close</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>						<span style="color:#8f5902;font-style:italic">// 第一次读取到 c1 的关闭信息时执行 if 语句块内的内容，以后再次读取到的时候则忽略
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>						<span style="color:#000">o</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#204a87;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>						<span style="color:#000">c1Close</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>					<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;c1:&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">v</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ok</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#000">c2</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">ok</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">c2Close</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>						<span style="color:#000">o</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#204a87;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>						<span style="color:#000">c2Close</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>					<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;c2:&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#8f5902;font-style:italic">// 只有当两个channel 都关闭的时候，goroutine 才会退出
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">c1Close</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">c2Close</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;c1:&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">c1Close</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;c2:&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">c2Close</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">break</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 主程序向两个 channel 中写入值
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">c1</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">c2</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#4e9a06">&#34;hi&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">c1</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#0000cf;font-weight:bold">3</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">c2</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#4e9a06">&#34;hello&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 关闭两个 channel
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c2</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 等待 goroutine 的退出
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Close&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">v</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#000">o</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 程序的输出
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span><span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">run</span> <span style="color:#204a87;font-weight:bold">select</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">go</span>                                                <span style="color:#0000cf;font-weight:bold">23</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">25</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">11</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">09</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">19</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">c1</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span><span style="color:#000">c2</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">hi</span>
</span></span><span style="display:flex;"><span><span style="color:#000">c1</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">3</span>
</span></span><span style="display:flex;"><span><span style="color:#000">c2</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">hello</span>
</span></span><span style="display:flex;"><span><span style="color:#000">Close</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#204a87;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#204a87;font-weight:bold">true</span>
</span></span></code></pre></div><p>上述代码简单地展示了如何利用<code>select</code>语句来处理多个 channel，需要注意的是，<code>case v, ok := &lt;-c1</code>这条判断<code>c1</code>是否已经关闭的语句可能会执行多遍，也就是说如果<code>c1</code>关闭了，<code>case v, ok := &lt;-c1</code>还是永远可以读取出值来，且读取出来的<code>ok</code>始终为<code>false</code>。</p>
<p>如果我们不搞一个<code>c1Close</code>来进行判断的话，那么<code>o</code>中写入的两个值都可能是在判断<code>c1</code>关闭的时候写入的。</p>
<h2 id="ping-pong-示例代码">ping-pong 示例代码</h2>
<p>OK，看了上面那么多描述之后，我们可以看一个简单的例子，这个例子来自演讲<a href="https://www.youtube.com/watch?v=QDDwwePbDtw"> Advanced Go Concurrency Patterns </a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 下面的代码演示了一个乒乓球程序，只有一个球在table上，然后两个player来获取这个球，互相获取了一段时间之后被主程序取走
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">ball</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">hits</span> <span style="color:#204a87;font-weight:bold">int</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">table</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ball</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">player</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;ping&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">table</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">player</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;pong&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">table</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">table</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#204a87">new</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ball</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sleep</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Second</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ball</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#000">table</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;hits:&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ball</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">hits</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">table</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">player</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">table</span> <span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ball</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 注意这里数据写到管道里以后，
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">ball</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ok</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#000">table</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">ok</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">break</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">ball</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">hits</span><span style="color:#ce5c00;font-weight:bold">++</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;total hits:&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ball</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">hits</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sleep</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">100</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Millisecond</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// 由于创建的chan缓存大小为0，这里的写操作会阻塞，直到有另一个goroutine来读
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">table</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">ball</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>上述的代码也并不复杂，但是我觉得很有趣，就贴上来了。channel 可以认为是一个乒乓球桌，channel 中的数据就可以认为是一个乒乓球，每个 goroutine 接收到乒乓球以后，将球的击打次数加1，然后就将乒乓球扔回到乒乓球桌上，等待另一个 goroutine 来接收，如此往复。只有当主程序从桌子上拿走了乒乓球以后（主程序接收到了 channel 中的数据），两个协程才退出。</p>
<h2 id="参考链接">参考链接</h2>
<ol>
<li><a href="https://talks.golang.org/2013/advconc.slide#1">Advanced Go Concurrency Patterns</a></li>
<li><a href="http://www.ucai.cn/index.php?app=fullstack&amp;mod=Train&amp;act=show&amp;cid=69&amp;sid=3259&amp;chid=4708">Go 编程基础 &ndash; 无闻</a></li>
<li><a href="http://www.sizeofvoid.net/goroutine-under-the-hood/">goroutine 背后的系统知识</a></li>
</ol>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-9c00886a50ca7b0f720c54623a097403">16.31 - Go 的反射包浅析</h1>
    
	<p>本文主要介绍了反射包中的常用类型和方法，并使用了几个例子进行了说明。</p>
<h2 id="类型">类型</h2>
<p>Golang 是一种静态类型的语言，我们在代码中定义的每个变量，都会有其类型，例如<code>var a int = 10, b string = &quot;acb&quot;</code>语句中，我们定义了两个变量<code>a</code>和<code>b</code>，它们的类型分别是<code>int</code>和<code>string</code>。</p>
<p>除了系统预定义的类型之外，我们还可以自定义类型，例如下面的语句中，我们定义了一个自定义类型<code>MyInt</code>，然后我们分别定义了两个变量<code>i1</code>和<code>i2</code>，尽管这两个变量的内容是相同的，但是他们由于类型不同，并不能够直接赋值，必须要经过类型转换以后才能赋值。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">MyInt</span> <span style="color:#204a87;font-weight:bold">int</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">i1</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">i2</span> <span style="color:#000">MyInt</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">i1</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">i2</span> <span style="color:#8f5902;font-style:italic">//cannot use i2 (type MyInt) as type int in assignment
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="接口">接口</h2>
<h3 id="接口类型的定义">接口类型的定义</h3>
<p>在Golang的类型中，还有一种重要的类型叫做接口类型，一个接口类型代表了一组固定的方法。一个接口变量可以存储任意合适的值，只要这个值实现了这个接口的所有方法。</p>
<p>在下面的代码中，我们定义了一个接口类型<code>Animal</code>，然后定义了两种结构体类型<code>Cat</code>和<code>Dog</code>，由于<code>Cat</code>和<code>Dog</code>都实现了<code>Animal</code>的两个方法，所以我们定义的<code>Animal</code>接口变量<code>i</code>既能存储<code>Dog</code>类型的值，又能存储<code>Cat</code>类型的值。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Animal</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">run</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">jump</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Dog</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">d</span> <span style="color:#000">Dog</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">run</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;A dog is running&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">d</span> <span style="color:#000">Dog</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">jump</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;A dog is jumping&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Cat</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#000">Cat</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">run</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;A cat is running&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#000">Cat</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">jump</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;A cat is jumping&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">i</span> <span style="color:#000">Animal</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">i</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">Dog</span><span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">i</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">jump</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">i</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">Cat</span><span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">i</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">run</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="空接口">空接口</h3>
<p>在接口类型中，有一种比较特殊，那就是空接口类型<code>interface{}</code>。空接口类型的方法集合为空集，意味着任意类型都实现了空接口，也就是说空接口类型的变量能够存储任意类型的值。正是由于空接口的这个特性，我们就可以动态地获取空接口类型变量的实际类型，并更改它的值，来实现我们的反射机制。</p>
<h3 id="接口类型的底层实现">接口类型的底层实现</h3>
<p>每一个接口类型的变量，它其实是由两部分组成，被赋的值的拷贝，和被赋的值的类型描述器。例如上面代码中的<code>i</code>变量，我们可以用这样一个二元组来表示: <code>(c, Cat)</code>，代表了变量<code>c</code>和它的类型<code>Cat</code>。</p>
<h2 id="type-和-value">Type 和 Value</h2>
<p>在上文中，我们了解到一个接口变量是由值和值类型两部分组成的，我们的反射相关函数主要就是获取这两部分。当我们调用<code>reflect.ValueOf</code>方法的时候，就是获取接口中的变量，并使用一个<code>reflect.Value</code>类型的变量来代表它。同理，当我们使用<code>reflect.TypeOf</code>方法的时候，它获取的就是接口中存储的变量类型，并使用一个<code>reflect.Type</code>类型的变量来代表它。关于<code>reflect</code>包中这些常用方法的描述如下所示:</p>
<h3 id="typeof-方法">TypeOf 方法</h3>
<p><code>reflect.TypeOf</code>方法的声明如下: <code>func TypeOf(i interface{}) Type</code>。</p>
<p>它接收一个__空接口类型变量__<code>i</code>作为参数，返回一个<code>Type</code>变量，代表了传入参数的类型。由于这个函数的参数是__空接口类型__，所以即使我们传入了一个其他类型的变量，参数也首先会被转换成__空接口类型__。</p>
<h3 id="valueof-方法">ValueOf 方法</h3>
<p><code>reflect.ValueOf</code>方法的声明如下：<code>func ValueOf(i interface{}) Value</code></p>
<p>它返回一个<code>Value</code>变量代表传入参数<code>i</code>运行时的数据。</p>
<p><code>Value.Interface()</code>方法是<code>ValueOf</code>方法的逆向方法，<code>Value</code>可以通过<code>Interface()</code>转换成接口。</p>
<h3 id="zero-方法">Zero 方法</h3>
<p><code>reflect.Zero</code>方法的声明如下: <code>func Zero(typ Type) Value</code></p>
<p>它接收一个<code>Type</code>变量，并且返回一个<code>Value</code>变量代表<code>typ</code>所对应的0值。</p>
<h3 id="kind-类型">Kind 类型</h3>
<p><code>reflect.Value</code>和<code>reflect.Type</code>类型有一个<code>Kind()</code>方法，它返回一个<code>reflect.Kind</code>类型的变量，代表了反射类型<code>reflect.Type</code>的具体分类。需要注意的是，<code>Kind</code>方法返回的是底层类型，而不是静态声明的类型，如果我们声明了自定义类型<code>type MyInt int</code>，通过<code>Value.Kind()</code>获取的类型仍然为<code>int</code>。具体例子请参考下面这段代码:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;reflect&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">User</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Name</span> <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Age</span>  <span style="color:#204a87;font-weight:bold">int</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">MyInt</span> <span style="color:#204a87;font-weight:bold">int</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">u</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">User</span><span style="color:#000;font-weight:bold">{</span><span style="color:#4e9a06">&#34;xff&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">19</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">i</span> <span style="color:#000">MyInt</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">42</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">t</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">reflect</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">TypeOf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">u</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// reflect.Struct是一个reflect.Kind类型的常量，代表了结构体类型
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Kind</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">reflect</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Struct</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic">// 输出 true
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">t</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">reflect</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">TypeOf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 这里变量i的类型是我们自定义的类型MyInt，但是Type.Kind()方法返回的类型是reflect.Int
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Kind</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">reflect</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Int</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic">// 输出true
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="value-的-settable">Value 的 settable</h3>
<p><code>settable</code>就是表示一个通过空接口反射出来的<code>Value</code>变量是否是可以修改原始的值，通过调用<code>Value.CanSet()</code>方法，我们可以查看某个<code>Value</code>的<code>settable</code>属性。那么什么情况下<code>Value</code>变量可以修改原始的值呢？请参考下面这段代码:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;reflect&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">x</span> <span style="color:#204a87;font-weight:bold">float64</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">4.1</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">xPointerValue</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">reflect</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ValueOf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">xPointerValue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CanSet</span><span style="color:#000;font-weight:bold">())</span>  <span style="color:#8f5902;font-style:italic">// 输出 false
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 只有 Interface 或 Ptr 类型的 Value 才能调用 Elem 方法
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">xPointerValueElem</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">xPointerValue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Elem</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">xPointerValueElem</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CanSet</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#8f5902;font-style:italic">// 输出 true
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">xValue</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">reflect</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ValueOf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">xValue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CanSet</span><span style="color:#000;font-weight:bold">())</span>  <span style="color:#8f5902;font-style:italic">// 输出 false
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">_</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">xValue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Elem</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#8f5902;font-style:italic">// 这里程序会报 panic
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>我们可以看到，变量<code>x</code>反射出来的变量<code>xValue</code>是不能修改原始值的，这是因为<code>reflect.ValueOf</code>方法其实是将<code>x</code>赋值到了一个空接口变量<code>o</code>上，<code>o</code>中保存的是<code>x</code>的拷贝和<code>x</code>的类型描述器，而<code>ValueOf()</code>方法返回的<code>xValue</code>变量指向的就是空接口变量<code>o</code>中保存的<code>x</code>的拷贝。如果<code>xValue</code>变量可以修改原始值，那么修改的也仅仅只是<code>x</code>的拷贝，并不能够修改<code>x</code>本身，所以<code>xValue</code>是不可修改的。</p>
<p>指针<code>&amp;x</code>反射出来的<code>xPointerValue</code>也是不能修改原始值的，原理和上文中讲述的类似，<code>xPointerValue</code>指向的是空接口变量<code>o</code>中保存的<code>x</code>的指针的拷贝，这个指针中保存的地址是不可修改的。</p>
<p>但是<code>xPointer</code>调用<code>Elem()</code>方法获取到的<code>xPointerValueElem</code>变量就是可以修改原始值的了，这是因为<code>xPointerValue.Elem()</code>方法返回的是这个指针指向的值，也就是<code>x</code>，也就是说<code>xPointerValueElem</code>指向的就是<code>x</code>，所以<code>xPointerValueElem</code>就是可以修改原始值的了。</p>
<p>这里的内容比较绕，理解起来可能不太容易，大家可以参考下面的图进行理解：</p>
<p><img src="http://owcwlb3jm.bkt.clouddn.com/2017-09-16-1505538303474.jpg" alt="golang-reflect"></p>
<h2 id="反射的示例">反射的示例</h2>
<p>OK，讲了一大串的理论，大家忍不住想要通过代码来验证一下自己的想法了吧，我们接下来就会通过几个例子，来演示一下 Golang 中反射的具体用法。</p>
<h3 id="简单数据的类型和内容解析">简单数据的类型和内容解析</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;reflect&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">x</span> <span style="color:#204a87;font-weight:bold">float64</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">4.1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">v</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">reflect</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ValueOf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Type:&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Type</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Kind is float64:&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Kind</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">reflect</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Float64</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;value:&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Float</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 输出内容
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// Type: float64
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// Kind is float64: true
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// value: 4.1
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>在上述代码中，我们设置了一个float64类型的变量x，并通过<code>reflect.ValueOf</code>方法来获取这个变量所对应的<code>reflect.Value</code>，并输出了这个<code>reflect.Value</code>的类型和值。</p>
<h3 id="结构体变量的类型和内容解析">结构体变量的类型和内容解析</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;reflect&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">User</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Id</span>   <span style="color:#204a87;font-weight:bold">int</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Name</span> <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Age</span>  <span style="color:#204a87;font-weight:bold">int</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">u</span> <span style="color:#000">User</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Hello</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 结构体方法的类型名参数其实就是函数的第一个参数，通过反射打印方法类型可以看出
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Hello, World.&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">u</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">User</span><span style="color:#000;font-weight:bold">{</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;wahahah&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">23</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Info</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">u</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">Info</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">o</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// TypeOf获取的某个对象的所有字段的名称和类型
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">t</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">reflect</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">TypeOf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">o</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Type:&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">t</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 由于`Type.Field()`方法只支持结构体类型，所以这里如果传入的变量不是结构体类型会直接返回。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">k</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Kind</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#000">k</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">reflect</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Error type&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// ValueOf获取的是某个对象的所有字段的值
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Fields:&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">v</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">reflect</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ValueOf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">o</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#000">v</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NumField</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// t.Filed(i) 返回的是一个`reflect.StructField`类型的变量，描述了结构体类型中的某个字段的类型信息
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">field_type</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Field</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// v.Filed(i) 返回了一个`reflect.Value`类型的变量，代表了结构体类型中某个字段的值
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">val</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">v</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Field</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Interface</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%6s: %v = %v\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">field_type</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">field_type</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Type</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">val</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Method获取的某个对象的所有方法的名字和类型(即方法签名)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NumMethod</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">m</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Method</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%6s: %v\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Type</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>上述代码中，我们遍历了一个结构体类型，输出了它的所有字段的类型和值，还输出了它所有方法的签名。它的输出结果如下所示:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>Type: main.User
</span></span><span style="display:flex;"><span>Fields:
</span></span><span style="display:flex;"><span>    Id: <span style="color:#000">int</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>  Name: <span style="color:#000">string</span> <span style="color:#ce5c00;font-weight:bold">=</span> wahahah
</span></span><span style="display:flex;"><span>   Age: <span style="color:#000">int</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">23</span>
</span></span><span style="display:flex;"><span> Hello: func<span style="color:#ce5c00;font-weight:bold">(</span>main.User<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span></code></pre></div><h3 id="嵌套结构体变量的类型和内容解析">嵌套结构体变量的类型和内容解析</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;reflect&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">User</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Id</span>   <span style="color:#204a87;font-weight:bold">int</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Name</span> <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Age</span>  <span style="color:#204a87;font-weight:bold">int</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Manager</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">User</span> <span style="color:#8f5902;font-style:italic">// 这是一个匿名字段，这个字段的名称也是User
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">title</span> <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">m</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">Manager</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">User</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">User</span><span style="color:#000;font-weight:bold">{</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;xff&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">19</span><span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">title</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;manager&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">t</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">reflect</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">TypeOf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">m</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Type: %#v\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Field</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#8f5902;font-style:italic">// 这里把User类型当做一个字段
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Type: %#v\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Field</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#8f5902;font-style:italic">// 这里打印的是title字段
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// t.FidleByIndex传入的是一个int的slice，第一个数字表示在大的结构体中的索引，第二个数字表示在User结构体中的索引
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// 打印 User 结构体的 ID 字段
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Type: %#v\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FieldByIndex</span><span style="color:#000;font-weight:bold">([]</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">{</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">}))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 这里获取的是User结构体的 Name 字段
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Type: %#v\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FieldByIndex</span><span style="color:#000;font-weight:bold">([]</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">{</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">}))</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="简单数据的内容修改">简单数据的内容修改</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;reflect&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">x</span> <span style="color:#204a87;font-weight:bold">float64</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">4.1</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">xPointerValue</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">reflect</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ValueOf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">val</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">xPointerValue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Elem</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 检查要更改原始值的 Value 的 settable 属性
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">val</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CanSet</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">val</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SetFloat</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">3.0</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic">// 输出3.0
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>在上面的代码中，我们演示了如何通过反射来更改一个<code>float64</code>类型变量的值。</p>
<h3 id="结构体类型变量的内容修改">结构体类型变量的内容修改</h3>
<p>下面的代码演示了如何从一个结构体变量中获取字段，并改变这个字段的值。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;reflect&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 本处代码演示的是如何通过反射动态地修改结构体类型的值
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">User</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Id</span>   <span style="color:#204a87;font-weight:bold">int</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Name</span> <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Age</span>  <span style="color:#204a87;font-weight:bold">int</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">u</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">User</span><span style="color:#000;font-weight:bold">{</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;bwangel&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">23</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">u</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">u</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">u</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">Set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">o</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">pointerValue</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">reflect</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ValueOf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">o</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 判断类型是指针
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">pointerValue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Kind</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">reflect</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Ptr</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pointerValue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Type</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#4e9a06">&#34;Cannot be set&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// pointerValue.Elem() 了一个Value类型的值， 代表的是这个指针所指向的值
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">pointerValue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Elem</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CanSet</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;is not settable&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 获取字段的名称，并且判断类型是否为字符串
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// Value.IsValid 方法判断一个 Value 类型是否有效地代表了一个值
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">field_name</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#4e9a06">&#34;Name&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">f</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">value</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FieldByName</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">field_name</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">f</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">IsValid</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">f</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Kind</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">reflect</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">String</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">f</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">reflect</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">TypeOf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">f</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>			<span style="color:#8f5902;font-style:italic">// Value.SetString 设置了这个类型所代表的对象的值
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#000">f</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SetString</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;xff&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Bad Field&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">field_name</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="结构体变量的方法调用">结构体变量的方法调用</h3>
<p>下面的代码演示了如何通过反射来实现结构体变量方法的调用</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;reflect&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">User</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Id</span>   <span style="color:#204a87;font-weight:bold">int</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Name</span> <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Age</span>  <span style="color:#204a87;font-weight:bold">int</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">u</span> <span style="color:#000">User</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Hello</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">number</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;hello,&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;my name is&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">u</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">number</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">123</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">u</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">User</span><span style="color:#000;font-weight:bold">{</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;bwangel&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">23</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">u</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Hello</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;xff&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">v</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">reflect</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ValueOf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">u</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">mv</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">v</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MethodByName</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Hello&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 动态地调用方法传递的参数必须是 reflect.Value 组成的一个切片
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// 可以通过 reflect.ValueOf 将任意值转换成 Value 类型
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">args</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#000">reflect</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Value</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">reflect</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ValueOf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;xff2&#34;</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">reflect</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ValueOf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">)}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// mv.Call函数执行了实际的方法调用
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// 它返回的是一个由 Value 类型变量组成的数组([]reflect.Value)，代表了所有的返回值
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">return_vals</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">mv</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Call</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">args</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">return_vals</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">return_vals</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">return_vals</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">])</span> <span style="color:#8f5902;font-style:italic">// 输出 `1 [&lt;int Value&gt;] 123`
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="参考链接">参考链接</h2>
<ol>
<li><a href="https://golang.org/pkg/reflect">Go reflect 包的文档</a></li>
<li><a href="https://blog.golang.org/laws-of-reflection">The Laws of Reflection</a></li>
<li><a href="http://www.ucai.cn/index.php?app=fullstack&amp;mod=Train&amp;act=show&amp;cid=69&amp;sid=3259&amp;chid=4707">Go编程基础（无闻）</a></li>
</ol>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-b1b44ecb9640ff866c61f446ee4b46a5">16.32 - Go 学习笔记</h1>
    
	<blockquote>
<p><strong>摘要</strong>:</p>
<ol>
<li>Golang的基础语法学习</li>
</ol>
</blockquote>
<h2 id="控制结构">控制结构</h2>
<h3 id="for-循环">for 循环</h3>
<p><code>range</code>分句能够迭代数组，切片，字符串，map，或者 channel 等多种数据结构。它会返回两个值，分别代表【索引，值】（数组，切片，字符串），【键，值】（map），【值，是否关闭】（channel）等多种情况。</p>
<p>如果你只想要取 range 返回的第一个值，可以直接丢掉第二个：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">key</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">{</span><span style="color:#4e9a06">&#34;Name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;bwangel&#34;</span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>如果你想获取 range 返回的第二个值，需要使用空白标识符<code>_</code>来丢弃第一个:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">{</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>对于字符串，range 分句做了很多事情，它通过解析 UTF-8 编码将字符串按照独立的码点分割开来。对于无效的编码，它认为其是一个独立的字节，并将其转换成了 rune U+FFFD 的形式。其中 rune 是 Go 语言中的一个术语，用来表示单个 Unicode 码点。下面的循环:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">pos</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">char</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#4e9a06">&#34;中国\x80汉字&#34;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%d: %#U\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pos</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">char</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>将会打印:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>0: U+4E2D <span style="color:#4e9a06">&#39;中&#39;</span>
</span></span><span style="display:flex;"><span>3: U+56FD <span style="color:#4e9a06">&#39;国&#39;</span>
</span></span><span style="display:flex;"><span>6: U+FFFD <span style="color:#4e9a06">&#39;�&#39;</span>
</span></span><span style="display:flex;"><span>7: U+6C49 <span style="color:#4e9a06">&#39;汉&#39;</span>
</span></span><span style="display:flex;"><span>10: U+5B57 <span style="color:#4e9a06">&#39;字&#39;</span>
</span></span></code></pre></div><p>最后，Go 将没有逗号的操作符和<code>++</code>，<code>--</code>视作语句而不是表达式，意味着<code>i++</code>无法成为右值进行赋值。如果你想要累加一个数字并进行赋值，可以考虑使用并行赋值(这样就杜绝了<code>++</code>和<code>--</code>的赋值):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Reverse a
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#000">j</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">j</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">j</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">a</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">a</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">a</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">a</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="switch-语句">switch 语句</h3>
<p>在 Go 语言中，并不需要使用<code>break</code>语句来跳出 switch 语句块，它碰到匹配的 case 子句并运行其中的代码后，就会自动退出。但是可以使用<code>break</code>语句来跳出外层的 for 循环。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">100</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">switch</span> <span style="color:#000">i</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">case</span> <span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">break</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>同时，<code>break</code>语句也可以跳到一个指定的标签上，</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//TODO: 下面这段代码还需要去理解一下
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">Loop</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">n</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">n</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">src</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">n</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#000">size</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">switch</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">src</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">n</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#000">sizeOne</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">validateOnly</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">break</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">size</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">update</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">src</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">n</span><span style="color:#000;font-weight:bold">])</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">src</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">n</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#000">sizeTwo</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">n</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">&gt;=</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">src</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">errShortInput</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">break</span> <span style="color:#000">Loop</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">validateOnly</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">break</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">size</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">update</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">src</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">n</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">src</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">n</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span><span style="color:#000">shift</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>最后，我们使用一个比较 byte 切片的函数来结束这一小节，</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">Compare</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">b</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">byte</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">i</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">b</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">switch</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">a</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#000">b</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">a</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#000">b</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]:</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">switch</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">b</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">b</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="类型-switch">类型 switch</h3>
<p>我们可以使用<code>v.(type)</code>来判断一个空接口类型变量的动态类型，当在<code>switch</code>的表达式内声明了一个变量，这个变量将会拥有合适的类型。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">t</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span><span style="color:#000">t</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">functionGetSomeType</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">switch</span> <span style="color:#000">t</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">t</span><span style="color:#000;font-weight:bold">.(</span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">default</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;unexpected type %T\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">t</span><span style="color:#000;font-weight:bold">)</span>     <span style="color:#8f5902;font-style:italic">// %T prints whatever type t has
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">case</span> <span style="color:#204a87;font-weight:bold">bool</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;boolean %t\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">t</span><span style="color:#000;font-weight:bold">)</span>             <span style="color:#8f5902;font-style:italic">// t has type bool
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">case</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;integer %d\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">t</span><span style="color:#000;font-weight:bold">)</span>             <span style="color:#8f5902;font-style:italic">// t has type int
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">case</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#204a87;font-weight:bold">bool</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;pointer to boolean %t\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic">// t has type *bool
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">case</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;pointer to integer %d\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic">// t has type *int
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>如果我们只关心一种类型，可以使用从 switch 语法分句那借来的语法进行类型判断。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// getString 如果 o 是 string 类型，解析的结果 str 会被转换成字符串类型，否则 str 会变成空字符串
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">getString</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">o</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">bool</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">str</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ok</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">o</span><span style="color:#000;font-weight:bold">.(</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Type of %v: %T\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">str</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">str</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">str</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ok</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">getString</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">getString</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;233&#34;</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Type of : string
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//  false
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// Type of 233: string
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// 233 true
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="函数">函数</h2>
<h3 id="defer">defer</h3>
<ul>
<li><code>defer</code>进行延迟调用的参数会立刻生成，但是在上层函数返回前defer指定的函数都不会被调用。</li>
<li>如果有多个<code>defer</code>函数，它们的执行顺序是按照 LIFO 顺序来执行的。</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">trace</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;entering:&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">s</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">un</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;leaving:&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">a</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">un</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">trace</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;a&#34;</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;in a&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">b</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 在函数进入的时候参数首先就被求值了
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">un</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">trace</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;b&#34;</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 这里的两个`defer`语句，b函数退出的时候会先执行`secondb` 再执行`b`，按照 LIFO 顺序
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">un</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">trace</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;second b&#34;</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;in b&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">a</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">b</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// entering: b
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// entering: second b
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// in b
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// entering: a
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// in a
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// leaving: a
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// leaving: second b
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// leaving: b
</span></span></span></code></pre></div><h3 id="闭包">闭包</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">initSeq</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 这里i一直保存的是历史的值
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">i</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">closure</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">y</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// 这里打印出来的两个地址是相同的，说明x引用的是自外部函数的值
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">x</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">y</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">closureFor</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#8f5902;font-style:italic">// 它引用的是外部i变量的指针，并没有将i的值复制，所有反映的是i实时的值
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">seq</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">initSeq</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">seq</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">seq</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">seq</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">add3</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">closure</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;add3:&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">add3</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">closureFor</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sleep</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Second</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 程序输出结果
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// &gt;&gt;&gt; go run closures.go                                                                           20:27:32 (09-20)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 6
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 7
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 8
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 0xc42006e1d0
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 0xc42006e1d0
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// add3: 7
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 4
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 10
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 10
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 10
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 10
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 10
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 10
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 10
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 10
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 10
</span></span></span></code></pre></div><h3 id="命名返回值">命名返回值</h3>
<p>Go 函数中的结果参数可以被命名，命名后就会像参数一样当做一个普通变量来对待。当函数初始化的时候，它们被初始化成对应类型的零值，当函数执行<code>return</code>语句的时候，结果参数的当前值就会被当做返回值。<strong>注意，当函数签名声明了返回值以后，函数必须要调用<code>return</code>语句进行返回</strong>。</p>
<p>结果参数的名字并不是强制的，但是它可以让代码变得更加清晰。有一版本的<code>io.ReadFull</code>就是这样做的的:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 注意传入的 buf 是一个数组，这个函数将会最多阅读 len(buf) 个字节到buf中
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">ReadFull</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">r</span> <span style="color:#000">Reader</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">buf</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">byte</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">n</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">buf</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">nr</span> <span style="color:#204a87;font-weight:bold">int</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">nr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Read</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">buf</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">n</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#000">nr</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// 刚开始 buf 是数组，这条语句调用后 buf 就变成切片了
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">buf</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">buf</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">nr</span><span style="color:#000;font-weight:bold">:]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="数据">数据</h2>
<h3 id="使用new分配">使用<code>new</code>分配</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#204a87">new</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Type</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Type</span>
</span></span></code></pre></div><p><code>new</code>将会生成一个<code>Type</code>的实例，这个实例将会被初始化成对应的0值。<code>sync.Mutex</code>类型的0值是一个未锁定的<code>mutex</code></p>
<h3 id="构造器和复合字面值">构造器和复合字面值</h3>
<p>有时候我们要初始化一个复合类型，但是它的值我们需要初始化成0值以外的其他值，例如当我们创建一个文件的时候:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">NewFile</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fd</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">name</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">File</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">fd</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">f</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">new</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">File</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">f</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">fd</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">fd</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">f</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">name</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">f</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">dirinfo</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">f</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">nepipe</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">f</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>上面很多赋值语句显得很冗余，我们可以使用复合字面值来初始化一个复合类型的实例:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">NewFile</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fd</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">name</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">File</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">fd</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">File</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">fd</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>需要注意的是，Go 和 C 不同，它可以返回一个局部变量的地址，和这个值相关的存储空间在函数返回以后继续存在。
事实上，获取一个复合字面值声明的地址每回在它求值的时候将会生成一个新的实例。</p>
<p>复合字面值的声明我们除了可以按照上面的方式声明外，我们也可以按照键值对的方式来声明:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">File</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">fd</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">fd</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">name</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">name</span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>没有传入的字段将会被初始化成对应的0值，如何它一个字段也没有传入，将会声明一个0值的类型。<code>&amp;File{}</code>等价于<code>new(File)</code>。</p>
<p>复合字面值也可以用来声明切片，数组和 map。它可以把字段名当做索引或者 map 的键。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Enone</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">iota</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Eio</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Einval</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">a</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#ce5c00;font-weight:bold">...</span><span style="color:#000;font-weight:bold">]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">Enone</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;no error&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Eio</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Eio&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Einval</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;invalid argument&#34;</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">s</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">Enone</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;no error&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Eio</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Eio&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Einval</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;invalid argument&#34;</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">m</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">Enone</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;no error&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Eio</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Eio&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Einval</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;invalid argument&#34;</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">m</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// [no error Eio invalid argument]
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// [no error Eio invalid argument]
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// map[0:no error 1:Eio 2:invalid argument]
</span></span></span></code></pre></div><h3 id="使用-make-分配空间">使用 make 分配空间</h3>
<p><code>slice</code>是一个三元组描述器，它们是一个指向数据的指针，长度和容量，在这三个元素被初始化之前，<code>slice</code>都是<code>nil</code>。
<code>make</code>仅仅用来创建<code>slice</code>，<code>map</code>和<code>channel</code>，<code>make</code>函数初始化好它们内部的数据结构，并准备好初始化的值。</p>
<p>下面的例子展示了制造<code>slice</code>时<code>make</code>和<code>new</code>的不同，</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// p 是一个指向切片的指针，不过这个切片的三元组描述器都没初始化，所以 *p == nil
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">p</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">new</span><span style="color:#000;font-weight:bold">([]</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)</span>       <span style="color:#8f5902;font-style:italic">// 很少用到
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// v 是一个切片，它的三元组描述器被初始化了，它指向一个容量为100的 int 数组
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">v</span>  <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">([]</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">100</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 不必要的复杂步骤
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">p</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">new</span><span style="color:#000;font-weight:bold">([]</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">p</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">([]</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">100</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">100</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 常用的初始化切片的方法
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">v</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">([]</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">100</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h3 id="数组">数组</h3>
<p>Go 中数组的一些特点:</p>
<ol>
<li>数组是值，将一个数组赋值给另外一个会拷贝它的所有元素</li>
<li>如何你给一个函数传递一个数组参数，函数将会接收数组的拷贝，而不是指向数组的指针</li>
<li>数组的长度是它类型的一部分，<code>[10]int</code>和<code>[20]int</code>是不同的类型</li>
</ol>
<h3 id="切片">切片</h3>
<p><code>append</code>向切片中添加元素，如果添加元素的长度超出了切片的容量(切片的容量可由cap函数获取)，那么就会重新分配一个切片。<code>append</code>函数会将原始的或者新分配的切片返回。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">s</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">([]</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">11</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;s: %p\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">])</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">s</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">20</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;s: %p\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">])</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">s</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">20</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 这里可以看到s[0]的地址变了，说明切片指向的数组进行了重新分配，变成了另外一个数组
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;s: %p\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">])</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// s: 0xc4200180c0
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// s: 0xc4200180c0
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// s: 0xc420076000
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="二维切片">二维切片</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Transform</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">][</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">]</span><span style="color:#204a87;font-weight:bold">float64</span>  <span style="color:#8f5902;font-style:italic">// 一个3x3的二维数组
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">LinesOfText</span> <span style="color:#000;font-weight:bold">[][]</span><span style="color:#204a87;font-weight:bold">byte</span>     <span style="color:#8f5902;font-style:italic">// 一个二维切片
</span></span></span></code></pre></div><p>因为切片的长度是由变量确定的(数组的长度是由类型确定的)，所以二维切片的每个内部切片都可以有不同的长度，就像我们声明的<code>LinesOfText</code>类型，它内部的每个切片的长度都是不同的。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">l</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">LinesOfText</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87">byte</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;竹杖芒鞋轻胜马&#34;</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87">byte</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;一蓑烟雨任平生&#34;</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>二维切片可以每次单独分配，也可以更有效的一次分配。</p>
<p>每次单独分配耗时会更多，但是每个内部的一维切片相互独立，不会相互影响。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Allocate the top-level slice.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">picture</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">([][]</span><span style="color:#204a87;font-weight:bold">uint8</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">YSize</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic">// One row per unit of y.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 在图片上循环，在每一行上分配一个表示当前行像素点的切片
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">picture</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">picture</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">([]</span><span style="color:#204a87;font-weight:bold">uint8</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">XSize</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 这种分配方式，每行的像素点存在一个数组中
</span></span></span></code></pre></div><p>一次分配耗时会更短，但是内部的每个一维切片不能增加或缩短，否则可能会影响到相邻的一维切片。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Allocate the top-level slice
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">picture</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">([][]</span><span style="color:#204a87;font-weight:bold">uint8</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">YSize</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic">// One row per unit of y.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 一次地分配好图片上所有的像素点
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">pixels</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">([]</span><span style="color:#204a87;font-weight:bold">uint8</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">XSize</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">YSize</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 在每一行上循环，每次将总的像素点前面的元素分配到图片的每一行上
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">picture</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">picture</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">pixels</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">pixels</span><span style="color:#000;font-weight:bold">[:</span><span style="color:#000">XSize</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">pixels</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">XSize</span><span style="color:#000;font-weight:bold">:]</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 这种分配方式，所有的像素点都存在同一个数组中
</span></span></span></code></pre></div><h3 id="map">map</h3>
<p>任何定义了相等操作符的类型都可以是<code>map</code>的<code>key</code>。整数，浮点数，复数，字符串，指针，接口（只要这个指针对应的动态类型定义了相等操作符），结构体和数组等都可以是<code>map</code>的<code>key</code>。
切片不能是<code>map</code>的<code>key</code>，因为切片没有定义相等操作符。</p>
<p><code>map</code>可以使用复合字面值的语法进行声明，使用冒号来分割键和值:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">timeZone</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">]</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;UTC&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">60</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">60</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;EST&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">5</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">60</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">60</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;CST&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">6</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">60</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">60</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;MST&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">7</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">60</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">60</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;PST&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">8</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">60</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">60</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>如果通过一个不存在的<code>key</code>从<code>map</code>中获取值的时候，<code>map</code>将会返回它的值的零值。<code>timeZone[&quot;NOT_EXIST&quot;] == 0</code>。我们可以通过这个特性来实现<code>set</code>类型。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">attended</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">]</span><span style="color:#204a87;font-weight:bold">bool</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;Ann&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;Joe&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// key 不存在的时候默认返回的是 bool 的零值也就是 false
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">attended</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">person</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">person</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;was at the meeting&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>有时候我们需要区分<code>map</code>中的一个<code>key</code>是不存在还是它的值就是零值，我们可以使用<code>map[key]</code>返回的第二个返回值进行区分。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">timeZone</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">]</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#4e9a06">&#34;UTC&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">60</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">60</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#4e9a06">&#34;EST&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">5</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">60</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">60</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#4e9a06">&#34;CST&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">6</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">60</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">60</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#4e9a06">&#34;MST&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">7</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">60</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">60</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#4e9a06">&#34;PST&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">8</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">60</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">60</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">seconds</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ok</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">timeZone</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;UTC&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#8f5902;font-style:italic">// ok == true
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">seconds</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ok</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">timeZone</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;UTF&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#8f5902;font-style:italic">// ok == false
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>像上面这种写法我们称之为&quot;comma ok&quot;方言，它可以和<code>if</code>语句一起组成一种优雅的写法:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">offset</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">tz</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">timeZone</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">]</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#4e9a06">&#34;UTC&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">60</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">60</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#4e9a06">&#34;EST&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">5</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">60</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">60</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#4e9a06">&#34;CST&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">6</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">60</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">60</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#4e9a06">&#34;MST&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">7</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">60</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">60</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#4e9a06">&#34;PST&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">8</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">60</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">60</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">seconds</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ok</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">timeZone</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">tz</span><span style="color:#000;font-weight:bold">];</span> <span style="color:#000">ok</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">seconds</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;unknown time zone:&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tz</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>如果只想查看某个<code>key</code>是否在<code>map</code>中存在而不关心它的值的话，我们可以使用<code>_</code>忽略掉值:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">present</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">timeZone</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">tz</span><span style="color:#000;font-weight:bold">]</span>
</span></span></code></pre></div><p>如果想要删除掉<code>map</code>中的某个<code>key</code>，我们可以使用<code>delte</code>內建函数，如果要删除的<code>key</code>在<code>map</code>中不存在的话，它也不会抛出任何异常。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87">delete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">timeZone</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;PDT&#34;</span><span style="color:#000;font-weight:bold">)</span>  <span style="color:#8f5902;font-style:italic">// 要删除的 key 不存在
</span></span></span></code></pre></div><h3 id="打印">打印</h3>
<p><code>Println</code>系列的函数会将每个逗号都变成空格，并且会在输出的结尾加上换行符</p>
<p><code>Print</code>系列函数仅仅会将两边都不是字符串的逗号变成空格。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">23</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;hello world&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">42</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic">// `23hello world42 true`
</span></span></span></code></pre></div><p><code>Fprint</code>系列的函数的第一个参数是实现了<code>io.Writer</code>接口的对象，变量<code>os.Stdout</code>和<code>os.Stderr</code>都是实现了这个接口的对象。</p>
<p>在 Go 中，格式化数字的字符串（例如%d）并不会向C语言那样传递是否有符号的标记，或者长度的标记（<code>%u</code>, <code>%lu</code>），它是根据参数的类型来输出对应的结果。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">x</span> <span style="color:#204a87;font-weight:bold">uint64</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span><span style="color:#0000cf;font-weight:bold">64</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#8f5902;font-style:italic">// x 为64位无符号整数的最大值
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%d %x, %d %x\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">x</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">x</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">int64</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#204a87">int64</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#8f5902;font-style:italic">// 将 x 转换成 int64 类型整数将会溢出
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 18446744073709551615 ffffffffffffffff, -1 -1
</span></span></span></code></pre></div><p>关于其他的格式化字符串，说明如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">point</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">x</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">y</span> <span style="color:#204a87;font-weight:bold">int</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">p</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">point</span><span style="color:#000;font-weight:bold">{</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 输出结构体的值或者其他任意类型的值
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// Print 和Println 函数默认使用的就是这个格式化字符串
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%v\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 输出结构体的变量名和值
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%+v\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 输出变量的 Go 语法表示
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%#v\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 输出变量的类型
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%T\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 直接格式化布尔值
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%t\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 输出数值
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%d\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">123</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 输出数字的二进制表示
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%b\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">14</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 输出数字编码所对应的字符
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%c\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">33</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 输出数字的十六进制表示
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%x\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">456</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 输出浮点数
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%f\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">78.9</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 输出数字的科学计数法，使用e
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%e\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">123400000.0</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 输出数字的科学计数法，使用E
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%E\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">123400000.0</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 输出字符串
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%s\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;\&#34;string\&#34;&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic">// &#34;string&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 输出原始未转义的字符串
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%q\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;\&#34;string\&#34;&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic">// &#34;\&#34;string\&#34;&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 输出不带转义符号的原始字符串
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%#q\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;\&#34;string\&#34;&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic">// `&#34;string&#34;`
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 输出数字的单引号表示
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%q\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic">// &#39;\x03&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 输出字符串的十六进制表示
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%x\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;hex this&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic">// 6865782074686973
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 在输出的字节中添加上空格
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%x\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;hex this&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic">// 68 65 78 20 74 68 69 73
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 输出指针的表示
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%p\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">p</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 控制输出长度
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;|%6d|%6d|\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">12</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">345</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 控制小数点后的总位数，6表示输出长度
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;|%6.2f|%6.2f|\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1.2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">3.45</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 用-进行左对齐
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;|%-6.2f|%-6.2f|\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1.2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">3.45</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 控制字符串的输出长度和对齐方式
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;|%6s|%6s|\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;b&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;|%-6s|%-6s|\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;foo&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;b&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 将字符串输出到字符串中
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">s</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;a %s&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;string&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 将字符串输出到IO流中
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Stderr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;an %s\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;error&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>如果你想要更改自定义类型的默认字符串格式，只需要给这个类型实现<code>String() string</code>方法即可。</p>
<p><strong>注意:</strong></p>
<ol>
<li>应该添加值方法<code>func (v CustomType) String() string</code>，指针方法<code>func (v *CustomType) String() string</code>不会生效</li>
<li>这个方法仅会修改<code>fmt</code>包中打印方法打印的值，不会修改<code>string(value)</code>的值。</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Point 是二维坐标中的一个点
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Point</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">x</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">y</span> <span style="color:#204a87;font-weight:bold">int</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 这个方法只会改变 *p 的格式化字符串
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Point</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">String</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;[%d, %d]&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">y</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 这个方法会改变 p 和 *p 的格式化字符串
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span> <span style="color:#000">Point</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">String</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;[%d, %d]&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">y</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">p</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">Point</span><span style="color:#000;font-weight:bold">{</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>注意在<code>String() string</code>方法中不要再来通过<code>Printf</code>系列的函数打印类型<code>p</code>本身，以免产生递归调用<code>String() string</code>方法的情况。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">MyString</span> <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">m</span> <span style="color:#000">MyString</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">String</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;MyString=%s&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">m</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic">// 这里将会产生递归调用的错误
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>如果想要避免上述的错误，只需要将类型<code>MyString</code>转换成基类就可以了</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">MyString</span> <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">m</span> <span style="color:#000">MyString</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">String</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;MyString=%s&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">string</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">m</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#8f5902;font-style:italic">// 这里将不再会产生递归调用的错误
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>我们还可以自定义传递任意个参数的打印函数，我们可以通过<code>v ...Type</code>声明一个类型是<code>Type</code>的参数v，表示这个参数有任意个。然后通过<code>v...</code>的方式将这个参数传递到可以接收任意个参数的函数中，<code>v...</code>表示v是多个参数，而不是单个切片参数。如果我们将<code>v</code>的类型声明成<code>interface{}</code>，那么就表示这个参数<code>v</code>可以是任意类型。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">User</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">nickname</span> <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">age</span>      <span style="color:#204a87;font-weight:bold">int</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">gender</span>   <span style="color:#204a87;font-weight:bold">bool</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">v</span> <span style="color:#ce5c00;font-weight:bold">...</span><span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Stderr</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WriteString</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sprintln</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">v</span><span style="color:#ce5c00;font-weight:bold">...</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">u</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">User</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">nickname</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;bwangel&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">age</span><span style="color:#000;font-weight:bold">:</span>      <span style="color:#0000cf;font-weight:bold">23</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">gender</span><span style="color:#000;font-weight:bold">:</span>   <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;xff&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">u</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>同时，我们也可以直接把切片当做<code>v...</code>传递进入函数中,下面这个获取最小值的整数，我们直接将整个切片传入进去，再返回其中的最小值。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">min</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">a</span> <span style="color:#ce5c00;font-weight:bold">...</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 将0取反再右移一位，会得到最大的有符号整数
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">minValue</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">int</span><span style="color:#000;font-weight:bold">(^</span><span style="color:#204a87">uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic">// 首先将 minValue 声明成最大的整数
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">a</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">value</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#000">minValue</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">minValue</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">value</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">minValue</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">a</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">{</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">min</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">a</span><span style="color:#ce5c00;font-weight:bold">...</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="整数">整数</h3>
<p>Go 中获取整数最大值和最小值的方法：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">MaxUint</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">^</span><span style="color:#204a87">uint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">MinUint</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">MaxInt</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">int</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">MaxUint</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">MinInt</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">MaxInt</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span></code></pre></div><p>整数的取值范围如下:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>uint8  : <span style="color:#0000cf;font-weight:bold">0</span> to <span style="color:#0000cf;font-weight:bold">255</span>
</span></span><span style="display:flex;"><span>uint16 : <span style="color:#0000cf;font-weight:bold">0</span> to <span style="color:#0000cf;font-weight:bold">65535</span>
</span></span><span style="display:flex;"><span>uint32 : <span style="color:#0000cf;font-weight:bold">0</span> to <span style="color:#0000cf;font-weight:bold">4294967295</span>
</span></span><span style="display:flex;"><span>uint64 : <span style="color:#0000cf;font-weight:bold">0</span> to <span style="color:#0000cf;font-weight:bold">18446744073709551615</span>
</span></span><span style="display:flex;"><span>int8   : -128 to <span style="color:#0000cf;font-weight:bold">127</span>
</span></span><span style="display:flex;"><span>int16  : -32768 to <span style="color:#0000cf;font-weight:bold">32767</span>
</span></span><span style="display:flex;"><span>int32  : -2147483648 to <span style="color:#0000cf;font-weight:bold">2147483647</span>
</span></span><span style="display:flex;"><span>int64  : -9223372036854775808 to <span style="color:#0000cf;font-weight:bold">9223372036854775807</span>
</span></span></code></pre></div><p>Go 中将一个数值赋值给一个整型变量的时候，数值不能超出这个整型变量的范围。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">b</span> <span style="color:#204a87;font-weight:bold">int8</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">int8</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">255</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 抛出panic，constant 255 overflows int8
</span></span></span></code></pre></div><p>上面的代码中将255类型强转了，但255并没有溢出转换成-1，而是抛出 panic 。</p>
<h3 id="append-函数">Append 函数</h3>
<p>Go 內建的<code>append</code>函数签名如下:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#204a87">append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">slice</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#000">T</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">elements</span> <span style="color:#ce5c00;font-weight:bold">...</span><span style="color:#000">T</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#000">T</span>
</span></span></code></pre></div><p>其中<code>T</code>是一个表示任意类型的占位符，你无法用 Go 语言实现这样一个<code>T</code>由调用者确定的函数，<code>append</code>的实现得到了编译器的支持，所以它是一个內建函数。</p>
<p>当我们想把两个切片合并的时候，只需要向上面那样通过<code>s...</code>的方式传递切片函数即可，</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">x</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">{</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">y</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">{</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">6</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">x</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">y</span><span style="color:#ce5c00;font-weight:bold">...</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>如果直接使用<code>append(x, y)</code>的话，程序将会抛出异常，因为<code>y</code>和<code>x</code>的元素的类型<code>int</code>不匹配。</p>
<h2 id="初始化">初始化</h2>
<h3 id="常量">常量</h3>
<p>Go 中的常量是在编译的时候由编译器创建的，它仅可以是数字，字符(runes)，字符串和布尔值。因为其在编译期创建的缘故，所以如果将一个表达式赋值给常量，这个表达式必须是可以被编译器求值的。例如<code>1 &lt;&lt; 3</code>就是可以被编译器求值的，而<code>math.Sin(math.Pi/4)</code>就不可以，因为函数的调用发生在运行时期。</p>
<p>使用<code>iota</code>枚举器可以生成若干个枚举的常量。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// ByteSize 表示字节类型
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">ByteSize</span> <span style="color:#204a87;font-weight:bold">float64</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 一些常用的字节单位常量
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">_</span>           <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">iota</span> <span style="color:#8f5902;font-style:italic">// 初始值 0 被忽略掉了
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">KB</span> <span style="color:#000">ByteSize</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">10</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#204a87;font-weight:bold">iota</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">MB</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">GB</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">TB</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">PB</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">EB</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ZB</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">YB</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 返回 ByteSize 的字符串表示
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 注意 fmt.Sprintf(&#34;%.2f&#34;, b)不会产生递归调用，
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//	因为只有当Sprintf想要获取某个类型对应的字符串表示的时候，其才会调用这个类型对应的String函数
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//	这里使用 %f 进行格式化，只需要 ByteSize 类型的浮点数表示，所以不会调用 String 函数
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">b</span> <span style="color:#000">ByteSize</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">String</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">switch</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">b</span> <span style="color:#ce5c00;font-weight:bold">&gt;=</span> <span style="color:#000">YB</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%.2fYB&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">b</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">YB</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">b</span> <span style="color:#ce5c00;font-weight:bold">&gt;=</span> <span style="color:#000">ZB</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%.2fZB&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">b</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">ZB</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">b</span> <span style="color:#ce5c00;font-weight:bold">&gt;=</span> <span style="color:#000">EB</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%.2fEB&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">b</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">EB</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">b</span> <span style="color:#ce5c00;font-weight:bold">&gt;=</span> <span style="color:#000">PB</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%.2fPB&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">b</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">PB</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">b</span> <span style="color:#ce5c00;font-weight:bold">&gt;=</span> <span style="color:#000">TB</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%.2fTB&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">b</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">TB</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">b</span> <span style="color:#ce5c00;font-weight:bold">&gt;=</span> <span style="color:#000">GB</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%.2fGB&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">b</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">GB</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">b</span> <span style="color:#ce5c00;font-weight:bold">&gt;=</span> <span style="color:#000">MB</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%.2fMB&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">b</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">MB</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">b</span> <span style="color:#ce5c00;font-weight:bold">&gt;=</span> <span style="color:#000">KB</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%.2fKB&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">b</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#000">KB</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%.2fb&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">b</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ByteSize</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">YB</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="变量">变量</h3>
<p>变量可以像常量一样初始化，不过它们可以使用在运行时计算值的表达式。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">home</span>   <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Getenv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;HOME&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">user</span>   <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Getenv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;USER&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">gopath</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Getenv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;GOPATH&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><h3 id="init-函数">init 函数</h3>
<ul>
<li>每个文件都可以包含<code>init</code>函数，<code>init</code>函数会在文件内所有的变量都被求值以后再执行，而变量求值会在所有导入文件都被执行以后再执行。</li>
<li><code>init</code>函数可以有多个，它们会按顺序执行。</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;flag&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">home</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Getenv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;HOME&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">user</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Getenv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;USER&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">gopath</span> <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">init</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">user</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#34;&#34;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;$USER not set&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">home</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#34;&#34;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">home</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;/home/&#34;</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">user</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">gopath</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#34;&#34;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">gopath</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">home</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#4e9a06">&#34;/go&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 在init函数中完成了命令行参数的绑定，flag包用来解析命令行参数
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// gopath may be overridden by --gopath flag on command line.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">flag</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StringVar</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">gopath</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;gopath&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">gopath</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;override default GOPATH&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">flag</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Parse</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">home</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">user</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">gopath</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="方法">方法</h2>
<h3 id="指针-vs--值">指针 VS  值</h3>
<p>在一个类型上实现的方法可以细分为__指针类型方法__和__值类型方法__。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// ByteSlice 字节切片
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">ByteSlice</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">byte</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Append 向 ByteSlice 中添加元素
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ByteSlice</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Write</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">data</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">byte</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">n</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">slice</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">p</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">l</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">slice</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">l</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#204a87">cap</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">slice</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#8f5902;font-style:italic">// reallocate
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// Allocate double what&#39;s needed, for future growth.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">newSlice</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">([]</span><span style="color:#204a87;font-weight:bold">byte</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">l</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">))</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// The copy function is predeclared and works for any slice type.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#204a87">copy</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">newSlice</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">slice</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">slice</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">newSlice</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">slice</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">slice</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">:</span> <span style="color:#000">l</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">)]</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">data</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">slice</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">l</span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">c</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">p</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">slice</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 返回 ByteSlice 变量的长度
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">b</span> <span style="color:#000">ByteSlice</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">String</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%d&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">b</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">b</span> <span style="color:#000">ByteSlice</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Fprintf函数使用指针的原因是， io.Write 接口 Write 是指针类型方法
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// 值类型方法可以被 *ByteSlice 和 ByteSlice 类型的变量调用，但是指针类型方法只可以被 *ByteSlice 类型的变量调用
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">b</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;hello, %s&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;golang&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%s&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">b</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>上面的代码中，Write 是指针类型方法，String 是值类型方法。</p>
<p>两者的调用规则是:</p>
<ul>
<li>值类型变量和指针类型变量都可以调用值类型方法</li>
<li>只有指针类型变量能够调用指针类型方法</li>
<li>使用值类型变量直接调用指针类型方法的时候，Go 编译器会自动插入取地址符。(b.Write -&gt; &amp;b.Write)</li>
<li>指针类型变量调用值类型方法是先通过引用获取到值，再传递给值类型方法，即实际传递的是一个新的值的拷贝</li>
</ul>
<p>这么规定的原因是指针类型方法传入的 receiver 是指针，它可以改变原始变量的值。如果值类型变量能够调用指针类型方法的话，那么传递给指针类型方法的 receiver 就是值的拷贝（例如当做函数参数的时候传入的是值的拷贝，再调用指针类型方法，改变的实际是函数的参数，而不是我们传入的值）。这样导致对于变量的修改无效，所以规定__只有指针类型变量能够调用指针类型方法__。</p>
<h2 id="接口">接口</h2>
<h3 id="接口的基础定义">接口的基础定义</h3>
<ul>
<li>在Go中，每个变量都有类型和值，一般来说，每个变量的值必须要和其类型对应。</li>
<li>接口就是定义一组方法的集合，如果某个类型实现了这些所有的方法集合，它就__实现__了这个接口</li>
<li>一个接口声明的变量我这里称之为__接口变量__，例如<code>var n interface{}</code>中，<code>n</code>就是一个接口变量。</li>
<li>接口变量可以存储多种类型的值，但是这些类型必须__都实现__了这个接口</li>
</ul>
<h3 id="接口的底层实现">接口的底层实现</h3>
<p>接口类型的变量在底层存储一对值，一个是实现了这个接口的数据项的值，即被赋值给这个接口变量的值。另一个是数据项的类型描述器，类型描述器完整地描述了数据项的类型。</p>
<p>例如下面这段代码中:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">r</span> <span style="color:#000">io</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Reader</span>
</span></span><span style="display:flex;"><span><span style="color:#000">tty</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">OpenFile</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/dev/tty&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">O_RDWR</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">r</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">tyy</span>
</span></span></code></pre></div><p>我们将<code>tty</code>赋值给了<code>r</code>，<code>r</code>实际上存储的是一个二元组<code>(tty, *os.File)</code>。</p>
<h3 id="空接口">空接口</h3>
<ul>
<li>空接口的含义就是没有定义任何方法的接口，这也就意味着__任意一个类型都已经实现了空接口__。</li>
<li>因为任意一个类型都实现了空接口，所以空接口的接口变量可以存储任意类型的值，例如下面的一段代码:</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// 因为j, k 是空接口类型的变量，所以它们能够存储任意类型的值。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">j</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">k</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">j</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">k</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34; hello, world &#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">k</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">k</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">j</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><ul>
<li>判断一个接口变量是否为空，就是要看它的值是否为该接口类型的空值，请看下面这段代码</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">n</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span><span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">n</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic">// 输出true
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">p</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 这句代码更改了接口变量n的值，令它的值变成了 *int 类型的nil
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">n</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">p</span>
</span></span><span style="display:flex;"><span><span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">n</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic">// 输出false
</span></span></span></code></pre></div><p>在上面的代码中我们可以看到，在执行了<code>n = p</code>语句之后，尽管<code>n</code>的值仍然为<code>nil</code>，但是变成了<code>*int</code>类型的<code>nil</code>，而不是<code>interface{}</code>类型的<code>nil</code>了，<code>n == nil</code>就会返回<code>false</code>。</p>
<h3 id="接口的转换">接口的转换</h3>
<ul>
<li>超集接口类型可以转换成子集接口类型，但是子集不能转换成超集。具体来说就是__方法多的接口能转换成方法少的，但是方法少的接口不能转换成方法多的__。请参看下面这段代码:</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Connector</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">Connect</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">USB</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">Name</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">Connector</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">PhoneConnector</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">name</span> <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">pc</span> <span style="color:#000">PhoneConnector</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Connect</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;connected:&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">pc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">pc</span> <span style="color:#000">PhoneConnector</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Name</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">pc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">u</span> <span style="color:#000">USB</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">u</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">USB</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">PhoneConnector</span><span style="color:#000;font-weight:bold">{</span><span style="color:#4e9a06">&#34;phone connector&#34;</span><span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">u</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Connect</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// 将USB类型转换成Connector类型，从方法多的接口类型转换成方法少的接口类型
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">c</span> <span style="color:#000">Connector</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">Connector</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">u</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Connect</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// 下面这个转换语句会报错，不能从方法少的接口类型转换成方法多的接口类型。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">u2</span> <span style="color:#000">USB</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">u2</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">USB</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="接口的嵌套定义">接口的嵌套定义</h3>
<ul>
<li>一个接口A的定义中可以包含另外一个接口B，则接口A所定义的方法集合中也就有了接口B的方法集合。例如下面这段代码:</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">USB</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">Name</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// 这里在USB接口中嵌入了一个Connector接口，USB接口默认有了Connector接口的方法
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">Connector</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Connector</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">Connect</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">TVConnector</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">name</span> <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">Connector</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">tv</span> <span style="color:#000">TVConnector</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Connect</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Connect:&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tv</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">tv</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">TVConnector</span><span style="color:#000;font-weight:bold">{</span><span style="color:#4e9a06">&#34;TV Connector&#34;</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">u</span> <span style="color:#000">USB</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// 这里会报错，无法将TVConnector类型的接口变量tv转换成USB类型。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">u</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">USB</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">tv</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">u</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Connect</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// ./interface.go:69: cannot convert tv (type TVConnector) to type USB:
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">//     TVConnector does not implement USB (missing Name method)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>在上面的代码中我们可以看到，实现<code>USB</code>接口需要实现两个方法，<code>Name() string</code>和<code>Connect()</code>，而<code>TVConnector</code>类型就只实现了一个方法，所以它不能被转换成<code>USB</code>类型的变量。</p>
<h3 id="例子">例子</h3>
<p>一个类型只要实现了<code>sort.Sort</code>规定的接口（即实现，Len, Less, Swap 这三个方法），就可以被<code>sort.Sort</code>函数调用。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;sort&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Sequence 整型序列类型
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Sequence</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">int</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Len 获取 Sequence 的长度
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span> <span style="color:#000">Sequence</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Len</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Less 比较 Sequence 中两个元素的大小
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span> <span style="color:#000">Sequence</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Less</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">j</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">bool</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Swap 交换 Sequence 中的两个元素
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span> <span style="color:#000">Sequence</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Swap</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">j</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">s</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">j</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// String 打印 Sequence 中的元素
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span> <span style="color:#000">Sequence</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">String</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">str</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#4e9a06">&#34;[&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">s</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">i</span> <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">str</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#4e9a06">&#34;, &#34;</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">str</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">str</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#4e9a06">&#34;]&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">str</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">s</span> <span style="color:#000">Sequence</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">{</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">9</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1e10</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Before sort:&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 只要一个类型实现了 Len, Less, Swap 这三个方法，他就可以被 sort 函数调用
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// sort.Sort(s)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// 也可以将 Sequence 类型转换成 []int 类型然后调用 []int 类型的方法进行排序
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">sort</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">IntSlice</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Sort</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;After sort:&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Before sort: [2, 3, 5, 9, -1, 0, 10000000000]
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// After sort: [-1, 0, 2, 3, 5, 9, 10000000000]
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>创建 HTTP 服务器。</p>
<p>HTTP 服务器的<code>ListenAndServe</code>第二个参数为实现了<code>http.Handler</code>接口的实例（即实现了<code>ServeHTTP(ResponseWriter, *Request)</code>方法），至于是如何实现的，它并不关心，所以它的第二个参数可以是结构体，布尔类型，甚至是函数。</p>
<p>当<code>ListenAndServe</code>方法的第二个参数是函数的时候，需要使用<code>http.HandlerFunc</code>做一层代理，即<code>http.HandlerFunc</code>实现了<code>ServeHTTP</code>方法，它在<code>ServeHTTP</code>方法中，再将请求和响应交给传入的函数进行处理。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;net/http&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Counter 页面访问次数统计
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Counter</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">n</span>  <span style="color:#204a87;font-weight:bold">int</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ch</span> <span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Request</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// ServerHTTP 可以作为一个 HTTP Handler
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctr</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Counter</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">ServeHTTP</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">w</span> <span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ResponseWriter</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">r</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Request</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ctr</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ch</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">r</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ctr</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">n</span><span style="color:#ce5c00;font-weight:bold">++</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctr</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">n</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fprintln</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">w</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;notifiction sent&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">counter</span> <span style="color:#000">Counter</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Receiver 接收请求的回调
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">Receiver</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">request</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#000">counter</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ch</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Receiver: request url is &#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">request</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">URL</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">init</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">counter</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">Counter</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Request</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">ArgServer</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">w</span> <span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ResponseWriter</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">r</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Request</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fprintln</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">w</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Args</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">Receiver</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 指针类型调用值类型方法的时候是先通过引用获得值，再进行赋值传递
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Server PV Service on 0.0.0.0:8000&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">server</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewServeMux</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">server</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Handle</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/args&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HandlerFunc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ArgServer</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">server</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Handle</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">counter</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListenAndServe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;:8000&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">server</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="空白标识符">空白标识符</h2>
<h3 id="未使用的包和变量">未使用的包和变量</h3>
<p>当我们在开发程序的时候，有时候程序写到一半，需要编译一下验证一下错误。但是这时可能存在一些导入了没有使用的包或者一些定义了但没有使用的变量。为了编译通过，我们通常会把这些包和变量先删除掉，编译过后再添加上，但这样显得太繁琐了，我们可以使用空白标识符来解决这个问题。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;io&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">_</span> <span style="color:#000">io</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ByteReader</span> <span style="color:#8f5902;font-style:italic">// delete when done
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">path</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#4e9a06">&#34;/tmp/&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Stat</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">path</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">IsNotExist</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%s does not exist&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">path</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fd</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Open</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/tmp/abcd&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">_</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">fd</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>上面的代码中我们的<code>io</code>包和变量<code>fd</code>都暂时没有使用，我们可以将他们用空白标识符声明，这一就可以编译通过了，同时我们应该写上注释，在完成后将这些语句删除。</p>
<h3 id="使用包的初始化功能">使用包的初始化功能</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;net/http&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">_</span> <span style="color:#4e9a06">&#34;net/http/pprof&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListenAndServe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;:8000&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>net/http/pprof</code>包在初始化函数中在默认的<code>ServerMux</code>上注册了几个 Handler，我们仅仅需要使用这些默认的 Handler，而不需要使用<code>net/http/pprof</code>包中的功能。</p>
<p>在这种情况下，我们可以使用<code>import _ &quot;net/http/pprof&quot;</code>语句，这样我们的程序默认只运行了<code>net/http/pprof</code>的初始化程序，但是不会导致有导入包未使用的编译错误。</p>
<h2 id="嵌套">嵌套</h2>
<ul>
<li>
<p>类型嵌套不同于继承，当我们嵌套一个类型的时候，类型的方法变成了外部类型的方法，但是当这个方法被调用的时候，方法的接收者是内部类型的实例，而不是外部的。</p>
</li>
<li>
<p>当我们想要重写嵌入类型的某个方法时，我们可以直接在外部类型上重写这个方法，然后方法内再调用这个内部类型的实例。</p>
</li>
</ul>
<h2 id="并发编程">并发编程</h2>
<h3 id="缓冲区的复用">缓冲区的复用</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">freeList</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Buffer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">100</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">serverChan</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Buffer</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">client</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">b</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Buffer</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// Grab a buffer if available; allocate if not.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">select</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">b</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#000">freeList</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#8f5902;font-style:italic">// Got one; nothing more to do.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">default</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#8f5902;font-style:italic">// None free, so allocate a new one.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>            <span style="color:#000">b</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">new</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Buffer</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">load</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">b</span><span style="color:#000;font-weight:bold">)</span>              <span style="color:#8f5902;font-style:italic">// Read next message from the net.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">serverChan</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">b</span>      <span style="color:#8f5902;font-style:italic">// Send to server.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">server</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">b</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#000">serverChan</span>    <span style="color:#8f5902;font-style:italic">// Wait for work.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">process</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">b</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// Reuse buffer if there&#39;s room.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">select</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">freeList</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">b</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#8f5902;font-style:italic">// Buffer on free list; nothing more to do.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">default</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#8f5902;font-style:italic">// Free list full, just carry on.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>上面的代码实现了缓冲区的复用，服务端每次处理完 buffer 中的数据后，就将这个缓冲区返回给客户端。客户端接收到缓冲区后继续使用，如果客户端接收不到缓冲区，则申请新的缓冲区来使用。服务端发现缓冲区队列写满了之后，会将无用的 Buffer 直接丢弃掉，重新从客户端那里读取（gc 会将其自动回收）。</p>
<h2 id="错误">错误</h2>
<ul>
<li>当一个自定义类型实现了<code>error</code>接口，那么当使用<code>fmt.Println</code>函数打印这个类型的时候，就会调用这个类型的<code>Error</code>函数，获取这个类型的错误信息。</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;math&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// ErrNegetiveSqrt 为自定义的异常
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">ErrNegetiveSqrt</span> <span style="color:#204a87;font-weight:bold">float64</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">e</span> <span style="color:#000">ErrNegetiveSqrt</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Error</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// 如果直接将e的值进行打印 fmt.Sprintf(&#34;%v&#34;, e)，程序就会陷入死循环
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// 因为e的类型为error，所以Sprintf函数打印的时候就会去调用Error函数获取返回值，结果就会陷入循环调用之中
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;cannot Sqrt negative number: %v&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87">float64</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">e</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">Sqrt</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span> <span style="color:#204a87;font-weight:bold">float64</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">float64</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// 因为这里声明了返回值为error，所以默认会将x转换成error,然后Println打印的时候就会获取Error函数的返回值。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">x</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ErrNegetiveSqrt</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">math</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sqrt</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">float64</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">)),</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Sqrt</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">val</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">Sqrt</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">val</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;---&gt;&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="io-模块">IO 模块</h2>
<p>ROT13解密的程序</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;io&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;strings&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">rot13Reader</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">r</span> <span style="color:#000">io</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Reader</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">v</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">rot13Reader</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Read</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">bytes</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">byte</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">input_bytes</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">([]</span><span style="color:#204a87;font-weight:bold">byte</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1024</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">2048</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">n</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">v</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Read</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">input_bytes</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#000">n</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">cipher</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">input_bytes</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">13</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">input_bytes</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">&gt;=</span> <span style="color:#0000cf;font-weight:bold">97</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">input_bytes</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">&lt;=</span> <span style="color:#0000cf;font-weight:bold">122</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">cipher</span> <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#0000cf;font-weight:bold">122</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">cipher</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">cipher</span> <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#0000cf;font-weight:bold">26</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">input_bytes</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">&gt;=</span> <span style="color:#0000cf;font-weight:bold">65</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">input_bytes</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">&lt;=</span> <span style="color:#0000cf;font-weight:bold">90</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">cipher</span> <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#0000cf;font-weight:bold">90</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#000">cipher</span> <span style="color:#ce5c00;font-weight:bold">-=</span> <span style="color:#0000cf;font-weight:bold">26</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">cipher</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">input_bytes</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">bytes</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">cipher</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">n</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">s</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">strings</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewReader</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Lbh penpxrq gur pbqr!&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">r</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">rot13Reader</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">io</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Copy</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Stdout</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">r</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="web-服务器">Web 服务器</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;flag&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;html/template&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;net/http&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">addr</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">flag</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">String</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;addr&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;:8888&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;server listen address&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">templ</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">template</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Must</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">template</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">New</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;qr&#34;</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Parse</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">templateStr</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">flag</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Parse</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HandleFunc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Chart</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListenAndServe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">addr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Chart 根路径的处理函数
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 将输入的内容更通过Google API 转换成二维码
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">Chart</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">w</span> <span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ResponseWriter</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">r</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Request</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">data</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#4e9a06">&#34;content&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FormValue</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;qr_content&#34;</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">data</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">templ</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Execute</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">w</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">data</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">templateStr</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#4e9a06">`
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&lt;html&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&lt;head&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&lt;title&gt;QR Link Generator&lt;/title&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&lt;/head&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&lt;body&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span><span style="color:#8f5902;font-style:italic">{{</span><span style="color:#204a87;font-weight:bold">if</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#c4a000">.content</span><span style="color:#8f5902;font-style:italic">}}</span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&lt;img src=&#34;http://chart.apis.google.com/chart?chs=300x300&amp;cht=qr&amp;choe=UTF-8&amp;chl=</span><span style="color:#8f5902;font-style:italic">{{</span><span style="color:#c4a000">.</span><span style="color:#8f5902;font-style:italic">}}</span><span style="color:#4e9a06">&#34; /&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&lt;br&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span><span style="color:#8f5902;font-style:italic">{{</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#c4a000">.content</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">}}</span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&lt;br&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&lt;br&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span><span style="color:#8f5902;font-style:italic">{{</span><span style="color:#204a87;font-weight:bold">end</span><span style="color:#8f5902;font-style:italic">}}</span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&lt;form action=&#34;/&#34; name=f method=&#34;POST&#34;&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">	&lt;input maxLength=1024 size=70 name=qr_content value=&#34;&#34; title=&#34;Text to QR Encode&#34;&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">	&lt;input type=submit value=&#34;Show QR&#34; name=qr&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&lt;/form&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&lt;/body&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">&lt;/html&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">`</span>
</span></span></code></pre></div><p>上面的代码创造了一个二维码生成网站，在网站上输入内容，即可通过 Google 的 API 生成相应地代码。</p>
</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-f0a22a813c843322c0d360d952e434ce">17 - 性能分析</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-38dd3702bb1bcc7da2f55f43923b479a">17.1 - QPS 和 RT 的关系</h1>
    
	<h2 id="术语说明">术语说明</h2>
<ul>
<li>QPS: Query Per Second</li>
<li>RT: Response Time</li>
<li>RT_CPU: 单个请求中的 CPU 时间</li>
<li>RT_WAIT: 单个请求中除了 CPU 时间外的其他时间(等待时间)</li>
</ul>
<h2 id="结论">结论</h2>
<p>单线程情况下, <code>QPS = 1000 / RT</code></p>
<p>多线程情况下，最好的情况(最佳线程数)是</p>
<blockquote>
<p>QPS = 1000 / RT_CPU</p>
</blockquote>
<blockquote>
<p>最佳线程数 = (RT_CPU+RT_WAIT) / RT_CPU * CPU核心</p>
<ul>
<li>线程数超过 最佳线程数 后, 系统的 QPS 不会再增加了，如果进一步增多，因为多个线程抢夺 CPU 资源导致的时间浪费，QPS 还会下降。</li>
</ul>
</blockquote>
<h2 id="说明">说明</h2>
<p>一个请求我们除了有 CPU 执行时间外，还有等待时间(等待IO/等待锁资源)。</p>
<ul>
<li>如果单个请求的等待时间占比很高，我们可以增加线程数，提升 CPU 的利用率，这样 QPS 也会随之增加。(CPU 利用率达到 85% 以上才比较正常)
<ul>
<li>线程本身也会消耗资源，它消耗的是 OS 级别的内存，不是进程内存，如果线程数小于 1000, 那么对于系统性能的影响可以忽略不计。</li>
</ul>
</li>
<li>如果单个请求的 CPU 时间占比很高，此时 CPU 成为系统瓶颈，那么系统整体的 QPS 已经没有提升空间了，要么优化程序，减少 CPU 指令数，要么增加 CPU 资源。</li>
<li>我们提升系统 QPS 的目的就是提升 CPU 的利用率，使 CPU 成为系统瓶颈。</li>
</ul>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-f65393dbe42ee15e5a5af9e8946cd970">18 - Thrift</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-1af692bb57d127b768eb69b3abc8a667">18.1 - Thrift golang client 如何设置超时时间</h1>
    
	<h2 id="简介">简介</h2>
<p>本文以 golang thrift binary 协议为例，讲述 thrift golang client 如何设置超时时间</p>
<h2 id="如何设置超时时间">如何设置超时时间</h2>
<p>golang thrift client 有两个超时时间</p>
<ol>
<li>socket timeout</li>
</ol>
<p>在创建 TSocket 的时候，我们可以传入 <code>ConnectTimeout</code> 和 <code>SocketTimeout</code> 两个配置。</p>
<ul>
<li><code>ConnectTimeout</code> 表示建立 TCP 连接的超时时间</li>
<li><code>SocketTimeout</code> 表示读写 Socket fd 时的超时时间</li>
</ul>
<p>当这两个超时触发时，thrift 会返回一个 <code>err.Timeout() == true</code> 的 error, 表示超时错误，thrift 会将其包装成 <code>TTransportException</code>，其 <code>typeId == thrift.TIMED_OUT</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>	<span style="color:#000">rawTransport</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">thrift</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewTSocketConf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">net</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">JoinHostPort</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;localhost&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;7303&#34;</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">thrift</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">TConfiguration</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">SocketTimeout</span><span style="color:#000;font-weight:bold">:</span>  <span style="color:#0000cf;font-weight:bold">5</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Second</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">ConnectTimeout</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">5</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Second</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">})</span>
</span></span></code></pre></div><ol start="2">
<li>context timeout</li>
</ol>
<p>在调用 thrift 函数时，需要传入 context 参数，我们可以在 ctx 参数中加上超时</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>		<span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cancel</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WithTimeout</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Background</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Second</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">res</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">client</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Triple</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">27</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic">// thrift 调用
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">cancel</span><span style="color:#000;font-weight:bold">()</span>
</span></span></code></pre></div><p>根据 context 的工作原理，</p>
<ol>
<li><code>cancel</code> 函数被调用</li>
<li>到了设置的超时时间，golang context 内部的的 goroutine 会调用 cancel 函数</li>
</ol>
<p>当上述两个条件满足其一时，会触发两个函数</p>
<ol>
<li><code>ctx.Done()</code> 返回的 channel 会 close</li>
<li><code>ctx.Error() != nil</code></li>
</ol>
<h2 id="设置超时时间的注意事项">设置超时时间的注意事项</h2>
<ol>
<li>socket timeout 必须比 context timeout 小</li>
<li>在弱网环境下，不能将 socket timeout 设置的非常小, context timeout 设置的特别大</li>
<li>遇到超时错误后应该将连接关闭</li>
</ol>
<p>为什么要遵循这些规则，我们先了解 timeout 工作原理，最后再来解答。</p>
<h2 id="超时时间是如何工作的">超时时间是如何工作的</h2>
<p>为了了解这两个超时时间是如何工作的，我们首先需要理清楚 binary protocol 中函数的调用关系</p>
<h3 id="binary-protocol-中的函数调用关系">binary protocol 中的函数调用关系</h3>
<p>在 <code>lib/go/thrift/protocol.go</code> 函数中，实现了 <code>TProtocol</code> 接口，此接口中定义了若干 ReadXXX 函数，这些函数负责从 Transport 中读取 thrift 请求体和响应体。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">TProtocol</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 若干 Write 函数
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">ReadMessageBegin</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">typeId</span> <span style="color:#000">TMessageType</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">seqid</span> <span style="color:#204a87;font-weight:bold">int32</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ReadMessageEnd</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ReadStructBegin</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ReadStructEnd</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ReadFieldBegin</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">typeId</span> <span style="color:#000">TType</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">id</span> <span style="color:#204a87;font-weight:bold">int16</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ReadFieldEnd</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ReadMapBegin</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">keyType</span> <span style="color:#000">TType</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">valueType</span> <span style="color:#000">TType</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">size</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ReadMapEnd</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ReadListBegin</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">elemType</span> <span style="color:#000">TType</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">size</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ReadListEnd</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ReadSetBegin</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">elemType</span> <span style="color:#000">TType</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">size</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ReadSetEnd</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ReadBool</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span> <span style="color:#204a87;font-weight:bold">bool</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ReadByte</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span> <span style="color:#204a87;font-weight:bold">int8</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ReadI16</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span> <span style="color:#204a87;font-weight:bold">int16</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ReadI32</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span> <span style="color:#204a87;font-weight:bold">int32</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ReadI64</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span> <span style="color:#204a87;font-weight:bold">int64</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ReadDouble</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span> <span style="color:#204a87;font-weight:bold">float64</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ReadString</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ReadBinary</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">byte</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ReadUUID</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span> <span style="color:#000">Tuuid</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>lib/go/thrift/binary_protocol.go</code> 文件提供了 <code>TProtocol</code> 的一种实现，它用于读取 <a href="https://github.com/apache/thrift/blob/master/doc/specs/thrift-binary-protocol.md">binary 协议格式</a>的 thrift 请求/响应。</p>
<p>其中, ReadXXX 函数的调用关系如下:</p>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2023-09-05-215706.png" alt=""></p>
<p>可以看到，除了若干以 <code>End</code> 结尾的函数，和 <code>ReadByte</code>, <code>ReadBool</code> 之外，所有的 Read 函数都调用了 <code>readAll</code> 函数。</p>
<p>而关于 thrift 超时时间的玄机就隐藏在 <code>readAll</code> 函数中</p>
<h3 id="readall-函数中如何检查超时">readAll 函数中如何检查超时</h3>
<p>这是 <code>readAll</code> 函数的代码,</p>
<p><code>read, err = io.ReadFull(p.trans, buf)</code> 表示从 protocol 底层的 transport 读取数据，读完之后进行一个复杂的 if 条件判断，决定重试还是返回错误。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>	<span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">deadlineSet</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Deadline</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">read</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">io</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ReadFull</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">trans</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">buf</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">deadlineSet</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">read</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">isTimeoutError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Err</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#8f5902;font-style:italic">// This is I/O timeout without anything read,
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#8f5902;font-style:italic">// and we still have time left, keep retrying.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#204a87;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// For anything else, don&#39;t retry
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#204a87;font-weight:bold">break</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">NewTProtocolException</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>它的 if 条件有四个子条件</p>
<ol>
<li>ctx 设置了 deadline, 即 ctx 用 <code>WithTimeout</code>, <code>WithDeadline</code> 包裹了</li>
<li>protocol 底层的 transport 中读取的数据为0</li>
<li>protocol 底层的 transport 读取时返回的 err 是 timeout error</li>
<li>ctx 的 cancel 函数没有被调用(这也表示 WithTimeout ctx 没有超时)，<code>ctx.Err() == nil</code></li>
</ol>
<p>当四个条件都满足时，它会重新重试，重新从 tranport 中读取数据，否则会将错误返回。</p>
<p>至此，我们可以将 thrift 客户端的超时逻辑梳理清楚了，protocol 通过 transport 去读取数据，当它遇到了 timeout error，但没有读到数据且 ctx 设置的超时时间未到，会重试继续读数据。否则就会返回超时错误。</p>
<p>我们可以用下面这张图来表示</p>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2023-09-05-222326.png" alt=""></p>
<ul>
<li><strong>step1</strong> 表示从 client 开始调用到 socket fd 返回第一个字节经过的时间</li>
<li><strong>step2</strong> 表示从 client 开始接受第一个字节，到接受整个请求所花费的时间</li>
</ul>
<ol>
<li>在 <strong>step1</strong> 中，client 遇到 socket timeout 会进行重试，直到到达了 ctx 设置的时间上限</li>
<li>在 <strong>step2</strong> 中，client 遇到 socket timeout ，大多数时候都是直接返回 timeout error, 只有 <strong>特别极端的案例</strong> ，才会进行重试。</li>
</ol>
<p><strong>特别极端的案例是什么:</strong></p>
<p>假设有这样的响应，</p>
<ol>
<li>socket fd 首先发会了 thrift message header,</li>
<li>正好发完 message header 之后, 网络阻塞了</li>
<li>此时 client 正在调用 <code>ReadFieldBegin</code> 函数读取参数结构体，它遇到 socket timeout error 就会进行重试</li>
</ol>
<p>在 golang server 中，响应是一起发送的，所以不存在 server 主动卡住的请求，TCP 发送字节的情况特别随机，几乎不可能存在正好发送完 message header 就卡住的情况(而且 message header 长度还是可变的)，所以可以认为这种特别极端的情况不存在。</p>
<h2 id="回到注意事项">回到注意事项</h2>
<p>了解完实现细节后，我们再来看文章开头提到的两个注意事项</p>
<ol>
<li>socket timeout 必须比 context timeout 小</li>
</ol>
<p>在上文的 <code>readAll</code> 函数中，当 socket timeout 触发时，会检查是否达到了 context timeout 的限制，如果我们设置了 <code>socket timeout</code> &gt; <code>context timeout</code>, 那么就会存在 <code>context timeout</code> 到了限制时间，但函数仍然阻塞在 <code>transport.Read</code> 中的情况</p>
<ol start="2">
<li>弱网环境中，socket timeout 不能设置的特别小</li>
</ol>
<p>在上一节的分析中，我们知道了在 <strong>step2</strong> 中遇到了 <code>socket timeout</code>时, 请求会直接失败，返回 <code>timeout error</code>。</p>
<p>那么在弱网环境中，如果我们将 <code>socket timeout</code> 设置的很小，但是 <code>context timeout</code> 很大，那么会遇到很多在 <strong>step2</strong> 中因为 <code>socket timeout</code> 导致的超时错误，而 <code>context timeout</code> 实际上还远远达不到。</p>
<ol start="3">
<li>遇到超时错误后，应该将连接关闭</li>
</ol>
<p>如果遇到超时错误了，client 会直接返回错误，但是过了一段时间 server 又将响应发回来了，后续的 <strong>新请求</strong> 就可能读到 <strong>旧响应</strong> 。</p>
<p>此时因为 thrift 请求和响应的 seq_id 或 method name 对不上，就会返回错误</p>
<pre tabindex="0"><code>{method_name}: out of order sequence response // seq id 对不上
{method_name}: wrong method name  // 方法名对不上
</code></pre><p>这部分检查代码在 <a href="https://github.com/apache/thrift/blob/v0.18.1/lib/go/thrift/client.go#L56-L66"><code>lib/go/thrift/client.go:56</code></a> 文件的 <code>func (p *TStandardClient) Recv</code> 函数中</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">TStandardClient</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Recv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">iprot</span> <span style="color:#000">TProtocol</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">seqId</span> <span style="color:#204a87;font-weight:bold">int32</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">method</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">result</span> <span style="color:#000">TStruct</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">rMethod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rTypeId</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rSeqId</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">iprot</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ReadMessageBegin</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">method</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">rMethod</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">NewTApplicationException</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">WRONG_METHOD_NAME</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%s: wrong method name&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">method</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">seqId</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">rSeqId</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">NewTApplicationException</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BAD_SEQUENCE_ID</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%s: out of order sequence response&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">method</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">...</span>
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-b127652654fb8cc62d6983427adc109f">18.2 - Thrift 协议学习笔记</h1>
    
	<p>本文主要讲了 thrift 的协议格式</p>
<hr>
<p>Thrift 是一个集序列化和服务通信功能于一身的 RPC 框架，主要包含三大部分，代码生成，序列化框架，RPC 框架。</p>
<p>Thrift 支持多种序列化协议，主要有 Binary, Compact, JSON, 本文主要讲解了 Binary 和 Compact 序列化协议。</p>
<h1 id="thrift-请求响应模型">Thrift 请求响应模型</h1>
<p>Binary 协议和 Compact 协议都假定底层的 transport 层会提供一个允许双向通信的字节流信道(例如 TCP 套接字)。它们都使用了如下的通信模式:</p>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2023-01-11-113200.png" alt=""></p>
<ol>
<li>Client 发送 Message 给 Server, Message 主要包括方法名，参数以及一些元信息</li>
<li>Client 将方法参数当作一个 Struct 发给 Server</li>
<li>Server 处理完后，发送 Message 给 Client。Message 主要包括方法名，消息类型和一些元信息</li>
<li>Server 发送 Struct 给 Client, 这个 Struct 包括响应或异常 body</li>
</ol>
<h2 id="binary-协议">Binary 协议</h2>
<h3 id="message-格式">Message 格式</h3>
<h4 id="编码格式">编码格式</h4>
<p>Binary 协议中, Message 的格式如下 (strict encoding)</p>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2023-01-11-121420.png" alt=""></p>
<table>
<thead>
<tr>
<th>字节索引</th>
<th>功能说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>第1字节的第一位固定是1, 表示使用 strict encoding</td>
</tr>
<tr>
<td>1-2</td>
<td><code>vvv</code> 前两个字节的后15位表示版本号, 固定是 1 (二进制格式是 <code>000 0000 0000 0001</code>)</td>
</tr>
<tr>
<td>3</td>
<td><code>unused</code> 第三个字节 unused 表示它不使用</td>
</tr>
<tr>
<td>4</td>
<td><code>mmm</code> 第四个字节格式为 00000mmm，后三位表示消息的类型</td>
</tr>
<tr>
<td>4-8</td>
<td><code>name length</code> 4-8 字节存储方法名的长度，它是一个32位有符号整数，使用大端序存储，这意味着方法名最长是 2^31-1</td>
</tr>
<tr>
<td>8..</td>
<td><code>name</code> 8字节后存储变长的方法名字符串，它使用 utf-8 编码</td>
</tr>
<tr>
<td>&hellip;4-end</td>
<td><code>seq id</code> 最后四个字节存储序列号</td>
</tr>
</tbody>
</table>
<h4 id="消息类型">消息类型</h4>
<table>
<thead>
<tr>
<th>Value</th>
<th>Binary</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>001</td>
<td><code>Call</code>: thrift 调用</td>
</tr>
<tr>
<td>2</td>
<td>010</td>
<td><code>Reply</code>: thrift 响应</td>
</tr>
<tr>
<td>3</td>
<td>011</td>
<td><code>Exception</code>: thrift server 返回了异常</td>
</tr>
<tr>
<td>4</td>
<td>100</td>
<td><code>Oneway</code>: thrift oneway 调用</td>
</tr>
</tbody>
</table>
<h4 id="序列号">序列号</h4>
<p>序列号是有符号的四字节整数，在一个传输层的连接上所有未完成的请求必须有唯一的序列号，客户端用序列号来处理响应的失序到达，实现请求和响应的匹配。服务端不需要检查序列号，也不应该在实现中对序列号有任何的依赖，只需要在响应的时候将其原样返回。</p>
<h4 id="old-encoding">old encoding</h4>
<p>上述讲的 binary 协议中的 strict encoding, 在 thrift 早期版本中，使用的是 old encoding 编码方式。old encoding 的编码方式如下</p>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2023-01-11-123231.png" alt=""></p>
<p>它没有版本号等信息，直接传输了方法名，类型以及 seq id</p>
<p>因为 old encoding 中，<code>name length</code> 是使用32位有符号数存储的，因为 <code>name length</code> 不能为负数，所以 old encoding 的第一位始终是0 (<code>name length</code> 在最前面)。strict encoding 中，将第一位设置成了1, 以此来区分 old encoding 和 strict encoding。</p>
<h3 id="struct-格式">struct 格式</h3>
<p>Struct 类型由两部分组成: Field + StopField</p>
<pre tabindex="0"><code>Struct := Field + StopField
Field := Field Header + Field Value
Field Header := field id + field value
</code></pre><p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2023-01-11-130322.png" alt=""></p>
<p>StopField 长度一个字节，全都置0，表示 Struct 或 Request/Response Body 的结束</p>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2023-01-11-130230.png" alt=""></p>
<p>Normal Field 的格式如上图所示，字段说明如下</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>tttttttt</td>
<td>field 类型，一个8位的有符号整数</td>
</tr>
<tr>
<td>field id</td>
<td>16位的有符号整数，使用大端字节序存储</td>
</tr>
<tr>
<td>field value</td>
<td>编码后的 field value</td>
</tr>
</tbody>
</table>
<p>field 类型的定义表</p>
<table>
<thead>
<tr>
<th>类型</th>
<th>field type number</th>
</tr>
</thead>
<tbody>
<tr>
<td>bool</td>
<td>2</td>
</tr>
<tr>
<td>byte</td>
<td>3</td>
</tr>
<tr>
<td>double</td>
<td>4</td>
</tr>
<tr>
<td>i16</td>
<td>6</td>
</tr>
<tr>
<td>i32</td>
<td>8</td>
</tr>
<tr>
<td>i64</td>
<td>10</td>
</tr>
<tr>
<td>string</td>
<td>11, used for binary and string fields</td>
</tr>
<tr>
<td>struct</td>
<td>12, used for struct and union fields</td>
</tr>
<tr>
<td>map</td>
<td>13</td>
</tr>
<tr>
<td>set</td>
<td>14</td>
</tr>
<tr>
<td>list</td>
<td>15</td>
</tr>
</tbody>
</table>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2023-01-11-130956.png" alt=""></p>
<p>上图是一个 thrift 请求的抓包，可以看到此请求的 struct 中，共有三个 Field，分别存储了 1, 0, 4 这三个 I32 整数。</p>
<h3 id="list-和-set-的格式">list 和 set 的格式</h3>
<p>list 和 set 类型使用的是相同的格式，如下图所示:</p>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2023-01-11-145100.png" alt=""></p>
<ul>
<li>tttttttt 表示集合元素类型，被编码成了 i8</li>
<li>size 表示集合中元素的格式，被编码成了 i32 (32位有符号整数)，且只允许是正数</li>
<li>elements 表示元素</li>
</ul>
<p>集合中元素的类型和 struct 中 field-types 使用相同的定义。</p>
<p>可以配置 list/set 最大的长度，默认没有设置，即是 i32 的最大值，(2^31-1, 2147483647)</p>
<h3 id="binarystring-格式">binary/string 格式</h3>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2023-01-11-170954.png" alt=""></p>
<p>binary 类型的格式如上图所示，4个字节的长度 + values。长度是 32位的有符号整数，这意味着 binary 数据的最大长度是 2^32-1, 2147483647</p>
<p>string 类型被 encode 成 utf-8 编码，然后使用 binary 的格式传输。</p>
<h3 id="map-格式">map 格式</h3>
<p>map 的格式如下:</p>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2023-01-11-145643.png" alt=""></p>
<ul>
<li>kkkkkkkk 表示 map 中 key 的元素类型，被编码成了 i8</li>
<li>vvvvvvvv 表示 map 中 value 的元素类型，被编码成了 i8</li>
<li>size 表示 map 的大小，被编码成了 i32，只允许是正数</li>
<li>key value pairs 表示被编码后的 key-value 对。</li>
</ul>
<p>可以配置 map 最大的长度，默认没有设置，即是 i32 的最大值，(2^31-1, 2147483647)</p>
<h3 id="request-格式">request 格式</h3>
<p>thrift Request 由两部分组成, Message + Data</p>
<ol>
<li>Message 的格式参考上文</li>
<li>Data 使用 struct 格式序列化的方法的参数</li>
</ol>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2023-01-11-150009.png" alt=""></p>
<p>上图是用 wireshark 抓到的 thrift 请求:</p>
<ol>
<li>它是一个 Call 消息，方法名是 <code>calculate</code>, seq id 是 0</li>
<li>它有两个参数，第一个参数是 i32 整数，第二个参数是一个结构体，这两个参数被用 struct 的方式序列化起来，变成了 Data</li>
</ol>
<h3 id="response-格式">response 格式</h3>
<p>thrift Response 由两部分组成，Message + Data</p>
<ol>
<li>Message 的格式参考上文</li>
<li>Data 是函数的返回值，它以 struct 的方式序列化，
<ul>
<li>返回值的 field id == 0 时，表示这是一个正常的响应</li>
<li>返回值的 field id == 1 时，表示这个响应是 server 抛出了一个 thrift idl 文件中定义的异常</li>
</ul>
</li>
</ol>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2023-01-11-151113.png" alt=""></p>
<p>上图抓到的 thrift 响应的包:</p>
<ul>
<li>Message 部分表示它是一个 Reply 类型的消息。</li>
<li>Data 部分，由于 field id == 1, 表示它返回了一个异常。</li>
<li>整个 Data 部分是一个 struct 格式的响应体，异常又是一个 struct 格式的数据</li>
<li>响应的异常包含了 i32 数字和 string 两个字段。</li>
</ul>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2023-01-11-151113.png" alt=""></p>
<h3 id="exception-格式">exception 格式</h3>
<p>thrift exception 响应表示 thrift server 出现了某种错误，无法正确地处理请求</p>
<p>它由两部分组成: Message + Exception</p>
<ol>
<li>Message 的格式参考上文</li>
<li>Exception 的 Data 也是按照 struct 格式来编码的</li>
</ol>
<p>下图是 thrift exception 响应抓取的包:</p>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2023-01-11-173446.png" alt=""></p>
<ul>
<li><code>00 00 00 2e</code> 是 frame 的长度</li>
<li><code>80 01 ... 6b 00 00 00 00</code> 这是 Message 的定义</li>
<li><code>0b</code> 表示第一个 field 是一个 string</li>
<li><code>00 01</code> 表示 field id == 1</li>
<li><code>00 00 00 0e</code> 表示 string 的长度是 14</li>
<li><code>49 6e 74 65 72 6e 61 6c 20 65 72 72 6f 72</code> 表示 <code>Internal error</code> 这个字符串</li>
<li><code>08</code> 表示第二个 field 是一个 i32</li>
<li><code>00 02</code> 表示 field id == 2</li>
<li><code>00 00 00 06</code> 表示 i32 的 值是6</li>
<li><code>00</code> 表示 StopField，代表这个 Struct 结束了</li>
</ul>
<p>thrift exception 中数字的含义如下:</p>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2023-01-11-173956.png" alt=""></p>
<h2 id="compact-协议">Compact 协议</h2>
<h3 id="var-int">var int</h3>
<p>Compact 协议中，使用 var int + zigzag int 的方式来将整数进行编码</p>
<ol>
<li>i32, i64 格式的整数被转换成 zigzag 格式的整数，这样所有整数都使用非负整数的格式存储</li>
<li>zigzag 整数被编码成了 var int 变长整数。i32 整数消耗 1-5 个字节，i64 整数消耗 1-10 个字节。</li>
</ol>
<ul>
<li>i16 首先被转换成 i32 之后，再进行 zigzag + var int 编码, i8 数字不会进行编码，直接进行传输。</li>
</ul>
<p>关于 zigzag 以及变长整数编码，可以参考我的另一篇文章: <a href="/2022/03/01/variant_zigzag/">ZigZag 变长整数编码</a></p>
<h3 id="message-如何编码">Message 如何编码</h3>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2023-01-11-125326.png" alt=""></p>
<p>Compact 协议中，Message 的编码格式如上图</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>pppppppp</td>
<td>协议 ID, 固定是 0x82, 1000 0010</td>
</tr>
<tr>
<td>mmm</td>
<td>消息类型，和 binary 协议中的消息类型定义相同</td>
</tr>
<tr>
<td>vvvvv</td>
<td>协议版本，无符号5位整数，固定是 00001</td>
</tr>
<tr>
<td>seq id</td>
<td>序列号 ID, 一个32位有符号整数被编码成了 var int</td>
</tr>
<tr>
<td>name length</td>
<td>方法名长度，一个有符号32位整数被编码成了 var int (name length &gt;= 0)</td>
</tr>
<tr>
<td>name</td>
<td>方法名, utf-8 编码的字符串</td>
</tr>
</tbody>
</table>
<h2 id="framed-vs-unframed">framed vs unframed</h2>
<ul>
<li>
<p>unframed 会将数据直接写入到 socket</p>
</li>
<li>
<p>使用 framed 格式，client/server 先将 request/response 写入到一个 buffer 中。最后向 socket 写入时，先写入一个四字节的 request/response 长度，再写入 request/response。</p>
</li>
<li>
<p>framed 格式下，请求的最大长度是 16384000 (16M)</p>
</li>
<li>
<p>thrift 引入 framed 格式的目的是为了方便异步处理器的实现。</p>
</li>
</ul>
<h2 id="参考链接">参考链接</h2>
<ul>
<li><a href="https://andrewpqc.github.io/2019/02/24/thrift/">Thrift序列化协议浅析</a></li>
<li><a href="https://erikvanoosten.github.io/thrift-missing-specification/">Thrift specification - Remote Procedure Call</a></li>
<li><a href="https://www.bwangel.me/2022/03/01/variant_zigzag/">ZigZag 变长整数编码</a></li>
</ul>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-1bb16dc0ca8a634867ed72c7e903ba28">18.3 - Thrft</h1>
    
	<h2 id="thrift-概念">thrift 概念</h2>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2018-05-27-060022.png" alt=""></p>
<h2 id="thrift-架构">thrift 架构</h2>
<p>Thrift 的架构图如下</p>
<p><img src="https://passage-1253400711.cos-website.ap-beijing.myqcloud.com/2021-12-17-100303.png" alt=""></p>
<p>Transport 层位于最底部，用户传输字节数据。</p>
<p>Transport 层提供的接口如下:</p>
<p><img src="https://passage-1253400711.cos-website.ap-beijing.myqcloud.com/2021-12-17-100415.png" alt=""></p>
<p>Transport 层可以由多个 TTransport 类组合起来，每个 TTransport 提供不同的功能。处于 TTransport 组合层次最下方，和设备(网络，磁盘，内存)直接打交道的 TTransport 类称为 <strong>Endpoint transports</strong>。例如 <code>TSocket</code>，它使用 Socket API 在 TCP/IP 网络上传输数据。</p>
<p><code>TFramedTransport</code> 有两个作用:</p>
<ol>
<li>分帧，它在每个消息的头部加了四字节的长度，让接受者能够准确地得知消息的大小，并申请合适的 buffer</li>
<li>缓存。当 <code>flush</code> 方法调用的时候，缓存的数据才会写入下一层 Transport</li>
</ol>
<p>当不需要分帧，仅需要缓存的时候，可以使用 <code>TBufferedTransport</code>。某些语言在 Endpoint Transport 中內建了缓存机制，就没有提供 <code>TBufferedTransport</code> 类。</p>
<h2 id="参考链接">参考链接</h2>
<ul>
<li><a href="https://livebook.manning.com/book/programmers-guide-to-apache-thrift/chapter-2/18">Chapter 2. Apache Thrift architecture</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-d3ce439f30c5ecaccd3e7225d6be37c5">18.4 - 翻译《Chapter 1. Introduction to Apache Thrift》</h1>
    
	<blockquote>
<ul>
<li>原文地址: <a href="https://livebook.manning.com/book/programmers-guide-to-apache-thrift/chapter-1/">https://livebook.manning.com/book/programmers-guide-to-apache-thrift/chapter-1/</a></li>
</ul>
</blockquote>
<hr>
<h2 id="12-与apache-thrift的应用集成">1.2. 与Apache Thrift的应用集成</h2>
<p>无论你的应用程序是否使用多平台和语言，它的操作很可能基于网络和时间跨越多个进程。有时，这些进程需要通过磁盘上的文件，内存中的缓冲区，或者网络进行通信。和 IPC (Interprocess communication) 相关的两个核心概念是:</p>
<ol>
<li>类型序列化</li>
<li>服务实现</li>
</ol>
<p>让我们依次来考虑这两个问题。</p>
<h3 id="121-类型序列化">1.2.1 类型序列化</h3>
<p>序列化是任何跨平台/语言通信的基本功能。例如，想象一下一个音乐行业应用程序，使用 NATS 作为消息系统，在进程之间移动歌曲数据。使用 NATS，该团队可以在他们用 Java 或 Python 编写的远程进程之间快速发送/接收消息。问题是，当歌曲信息在进程之间传递时，程序能读懂另一个进程发送的信息吗？Python 对象和 Java 对象在内存中的表示方式不同。如果 Python 进程发送音乐轨道数据的原始内存信息，就会出现问题。</p>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com//2021-12-17-145118.png" alt=""></p>
<p>为了解决这个问题，我们需要在信息传输平台上创建一个数据序列化层。有人可能会问，为什么不用 JSON 的形式来回发送一切呢？使用标准格式(例如 JSON) 可能是解决方案的一部分; 然而，我们仍必须回答这样的问题：</p>
<p>当发送多字段消息时，数据字段如何排序？ 当字段缺失时，会发生什么？一个不直接支持某种数据类型的语言在接收该数据类型的时，会做些什么？这些以及其他的问题，JSON, YAML 或 XML 等数据布局规范都无法解决。对于同一个数据集，不同语言经常产生不同但合法的格式。</p>
<ul>
<li><strong>IDL and Types</strong></li>
</ul>
<p>Apache Thrift提供了一个模块化的序列化框架来解决这些问题。
通过Apache Thrift，开发者在接口定义语言（IDL）中定义抽象数据类型。 然后这个IDL可以被编译成任何支持的语言的源代码。 生成的代码为用户定义的所有类型提供完整的序列化和反序列化逻辑。
Apache Thrift确保任何语言编写的类型都可以被任何其他语言读取。下面的代码显示了一个假设的音乐应用程序的Apache Thrift IDL 类型定义。</p>
<pre tabindex="0"><code>namespace * music

enum PerfRightsOrg {
    ASCAP = 1
    BMI = 2
    SESAC = 3
    Other = 4
}

typedef double Minutes

struct MusicTrack {
    1: string title
    2: string artist
    3: string publisher
    4: string composer
    5: Minutes duration
    6: PerfRightsOrg pro
}
</code></pre><p>有人抱怨说创建 IDL 是一个额外的步骤，减缓了开发进程。我发现恰恰相反。IDL 强迫你独立地小心考虑你的接口设计，而无需关心嘈杂的实现代码。这可能是你花在系统设计上最终要的时间。IDL 也是轻量级，易于修改和实验，并经常作为业务方面的通信工具而发挥作用。</p>
<p>用户可能会说无模式的系统更加灵活，而 IDL 很坚硬。事实上是，无论你是否记录了你的模式，当你读取和解释数据的时候，你都会需要一个模式。隐含模式会是非常危险的线上错误的来源，而且会给想要操作数据或扩展系统的人造成负担。</p>
<p>如果，除了读取和写入的代码，除此之外你对你读写的数据没有任何定义。当你想扩展系统的时候进展就会很缓慢。整个系统有多少代码依赖于这样的隐含模式？你如何改变这样一个东西？</p>
<p>许多无模式的 NoSQL 系统的流行，为 IDL 创造了另外一个角色。你现在可以在一个地方记录你的类型，并在使用消息系统和 NoSQL 存储系统(Redis, MongoDB 或其他 NoSQL 系统)的服务调用中使用这些类型。</p>
<p>有几个系统反其道而行之，从一个给定的编码方案中生成它们的模式。注释驱动的系统，如Java的JAX-RS，就以这种方式工作。这种方法很容易让实现细节影响接口定义，使可移植性和清晰性受到限制。一般来说，修改实现代码要比修改IDL的工作量大得多。另外，你不能保证另一个供应商的代码生成器会从一个外部模式中创建兼容的代码。当多个供应商参与到一个通信解决方案中时，这就是一个问题。</p>
<p>Apache Thrift通过提供唯一定义 Schema 来源，即 IDL ，避免了许多这些问题。Apache Thrift提供了独立于供应商的支持，在广泛的编程语言中使用单一的IDL，并且Apache Thrift的跨语言测试套装随着框架的发展不断地验证互操作性。</p>
<ul>
<li><strong>Interface evolution (接口演变)</strong></li>
</ul>
<p>IDL 创建了一个各方都可以依赖的契约，代码生成器可以用来创建工作的序列化操作，确保契约得到遵守。然而，IDL模式不需要很脆(brittle)。Apache Thrift IDL支持一系列的接口演化功能，如果使用得当，允许添加和删除字段，改变类型，等等。</p>
<p>对接口进化的支持大大简化了持续的软件维护和扩展的任务。现代工程意识，如微服务、持续集成（CI）和持续交付（CD）要求系统支持增量改进，而不影响平台的其他部分。那些不提供接口进化形式的工具，在改变时往往会 &ldquo;破坏世界&rdquo;。在这样的系统中，改变接口意味着所有使用该接口的客户端和服务器必须重写或重新编译，然后在大爆炸中重新部署。</p>
<p>Apache Thrift的接口进化功能允许多个接口版本在一个操作环境中无缝共存。这使得增量更新成为可能，使CI/CD管道成为可能，并使各个敏捷团队能够以他们自己的节奏交付商业价值。</p>
<ul>
<li><strong>Modular serialization</strong></li>
</ul>
<p>Apache Thrift提供了可插拔的序列化器，被称为协议，允许你使用几种序列化格式中的任何一种进行数据交换，包括 Binary (速度快)，compact(体积小)，以及JSON(可读性好)。即使你改变了序列化协议，同样的契约（IDL）也可以保持原样。这种模块化的方法也允许添加自定义的序列化协议。由于Apache Thrift是社区管理和开源的，你可以很容易地改变或增强功能，并在需要时向上游推送（Apache Thrift项目始终欢迎补丁）。</p>
</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-e3393de7e8466911640490b15485a33d">19 - 规范</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-e0e47e08b609b222268e029cf0817880">19.1 - 日期和时间格式</h1>
    
	<h2 id="w3-时间规范">w3 时间规范</h2>
<ul>
<li>ISO 8601 定义了大量的日期/时间格式，为了简化开发 &amp; 减少 bug, <a href="https://www.w3.org/TR/NOTE-datetime">w3 规范</a>定义了一个通用的时间格式
<ul>
<li><code>YYYY-MM-DDThh:mm:ss.STZD</code>
<ul>
<li>YYYY/MM/DD 四位数年份/月/日</li>
<li>T 表示后面跟了一个时间</li>
<li>hh:mm:ss 两位数的时分秒</li>
<li>S 一位或多位小数表示秒的一部分，最小是1, 最大不限制</li>
<li>TZD 时区指示符</li>
</ul>
</li>
</ul>
</li>
<li>W3 规范规定 TZD 可以有两种形式
<ol>
<li>表示一个 UTC 时间，TZD 可以写成一个 <code>Z</code>, 例如 <code>1994-11-05T13:15:30Z</code> 表示 utc 时间</li>
<li>表示本地时间, TZD 写成 <code>+HH:MM</code> 或 <code>-HH:MM</code>，表示当地时间相对 utc 时间的偏移量, 例如 <code>1994-11-05T13:15:30+08:00</code> 表示东八区时间，即北京时间</li>
</ol>
</li>
<li>协调世界时的缩写为UTC。国际电信联盟希望协调世界时能够在所有语言有单一的缩写。英语和法语区的人同时希望各自的语言缩写－CUT (Coordinated Universal Time) 和 TUC (Temps Universel Coordonné) 能够成为国际标准，最后妥协使用UTC。</li>
</ul>
<h2 id="参考链接">参考链接</h2>
<ul>
<li><a href="https://www.w3.org/TR/NOTE-datetime">Date and Time Formats</a></li>
<li><a href="https://blog.csdn.net/hsany330/article/details/70332483">关于时间格式 2016-08-9T10:01:54.123Z 20160809100154.123Z 处理方法</a></li>
<li><a href="https://zh.m.wikipedia.org/zh-hans/%E5%8D%8F%E8%B0%83%E4%B8%96%E7%95%8C%E6%97%B6#cite_ref-29">协调世界时</a></li>
</ul>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-546aa9afbb590e86cfb9df263df9d01c">20 - 编辑器</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-e9fb0115d808edb36ba1a3f492e95c4d">20.1 - Pycharm</h1>
    
	<h2 id="tabs---open-in-opposite-group">Tabs -&gt; Open in Opposite Group</h2>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2023-08-07-122300.png" alt=""></p>
<p>如图，窗口被分成了左右两个组。如果我想在右边的窗口组打开 <code>client.go</code> 文件，<strong>同时左边的文件不关闭</strong></p>
<p>可以右键点击 Tab 选择 <code>Open In Opposite Group</code>。</p>
<p>我在设置中将这个功能的快捷键设置成了 <code>Alt+Shift+H</code></p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-79874dcf5fd65d600b8e08e1641d3957">20.2 - Caps-lock mapping 成 Esc 在 vscode 中不生效</h1>
    
	<hr>
<h2 id="tips">Tips</h2>
<ul>
<li>问题: Linux 下将 caps-lock 键映射为 Esc。在 vscode 中失效。</li>
<li>解决方案:</li>
</ul>
<p>打开 <code>Preferences → Settings → Application → Keyboard → Dispatch</code> 设置为 <code>keyCode</code></p>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com//2021-10-18-113151.png" alt=""></p>
<h2 id="参考链接">参考链接</h2>
<ul>
<li><a href="https://linuxdev.io/howto-fix-caps-lock-escape-swap-not-working-in-vs-code/">Howto: Fix Caps Lock Escape Swap Not Working in VS Code</a></li>
</ul>
</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-5990d373ac824b52e97a76c2b3e2ff2c">21 - Linux</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-1c2b211e34ea807b66d53c40bac236f2">21.1 - curl</h1>
    
	<h2 id="curl-post-json-数据">curl POST JSON 数据</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>curl -X PUT -H <span style="color:#4e9a06">&#34;Content-Type: application/json&#34;</span> -d <span style="color:#4e9a06">&#39;@/tmp/demo.json&#39;</span> :9200/demo
</span></span><span style="display:flex;"><span>ø&gt; cat /tmp/demo.json
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;settings&#34;</span>: <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;number_of_shards&#34;</span>: 1,
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;number_of_replicas&#34;</span>: <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="使用---resolve-选项替换域名">使用 <code>--resolve</code> 选项替换域名</h2>
<ul>
<li>将 <a href="https://www.google.com">www.google.com</a> 替换成 127.0.0.1，并访问 8000 端口</li>
</ul>
<p><code>curl -v --resolve www.google.com:8000:127.0.0.1 http://www.google.com:8000/ping</code></p>
<ul>
<li>将 <a href="https://www.google.com">https://www.google.com</a> 替换成 127.0.0.1，此时 curl 会忽略证书和域名不匹配的问题</li>
</ul>
<p><code>curl -v --resolve www.google.com:443:127.0.0.1 https://www.google.com/ping</code></p>
<ul>
<li>将 <a href="http://www.google.com">http://www.google.com</a> 替换成 127.0.0.1，http 默认访问 80 端口</li>
</ul>
<p><code>curl -v --resolve www.google.com:80:127.0.0.1 http://www.google.com/ping</code></p>
<h2 id="--fail-和---fail-with-body"><code>--fail</code> 和 <code>--fail-with-body</code></h2>
<p>这两个选项都可以让 curl 在接收到 400 及以上的 HTTP 响应码的时候，将退出码设置为 22</p>
<p><code>--fail-with-body</code> 会输出服务端返回的内容到 stdout 或文件中</p>
<p><code>--fail</code> 不会有任何输出，当服务端返回的是认证相关的状态码时(401/407), 可能会让使用者误以为出错了</p>
<h3 id="使用场景">使用场景</h3>
<p>在一个 dockerfile 中，我期望下载项目的 <code>go.mod</code> 和 <code>go.sum</code> 文件，然后再执行 <code>go mod download</code>。
这样可以在 clone 代码之前，先下载 go module 文件。</p>
<p>如果项目的代码变了，但是依赖并没有变，因为 docker build 的缓存原理，可以省去下载 go module 的步骤。</p>
<pre tabindex="0"><code>...
ARG app_repo
ARG app_commit

RUN [[ ! -d /tmp/app ]] &amp;&amp; mkdir /tmp/app &amp;&amp; \
    curl -s https://raw.githubusercontent.com/${app_repo}/${app_commit}/go.mod -o /tmp/app/go.mod &amp;&amp; \
    curl -s https://raw.githubusercontent.com/${app_repo}/${app_commit}/go.sum -o /tmp/app/go.sum

RUN cd /tmp/app &amp;&amp; go mod download
...
</code></pre><p>当 app_repo 和 app_commit 参数错误，导致对应的 go.mod 文件不存在，curl 会得到 404 的 HTTP 响应码，此时我期望 docker build 出错。</p>
<p>但实际上并不会出错，docker build 会继续执行，直到 go mod download 文件无法识别 go.mod 文件，docker build 才会异常退出。</p>
<p>显示的错误内容如下:</p>
<pre tabindex="0"><code>0.467 go: errors parsing go.mod:
0.467 /tmp/app/go.mod:1: unknown directive: 404:
</code></pre><p>当我给 <code>curl</code> 加上了 <code>--fail</code> 选项之后，程序就会在下载 go.mod 出错时直接退出。显示的错误如下:</p>
<pre tabindex="0"><code>ERROR: failed to solve: 
	process &#34;
		/bin/bash -c [[ ! -d /tmp/app ]] &amp;&amp; mkdir /tmp/app &amp;&amp;
		curl --fail -s https://raw.githubusercontent.com/${app_repo}/${app_commit}/go.mod -o /tmp/app/go.mod &amp;&amp;
		curl -s https://raw.githubusercontent.com/${app_repo}/${app_commit}/go.sum -o /tmp/app/go.sum
	&#34; did not complete successfully: exit code: 22
</code></pre><p>最终的 dockerfile 代码及复现命令</p>
<pre tabindex="0"><code>FROM golang:1.19
SHELL [&#34;/bin/bash&#34;, &#34;-c&#34;]

ARG app_repo
ARG app_commit

RUN go env -w GOPROXY=https://goproxy.cn,direct

RUN [[ ! -d /tmp/app ]] &amp;&amp; mkdir /tmp/app &amp;&amp; \
    curl --fail -s https://raw.githubusercontent.com/${app_repo}/${app_commit}/go.mod -o /tmp/app/go.mod &amp;&amp; \
    curl -s https://raw.githubusercontent.com/${app_repo}/${app_commit}/go.sum -o /tmp/app/go.sum

RUN cd /tmp/app &amp;&amp; go mod download
RUN HTTP_PROXY=&#39;http://改成你自己的代理&#39; HTTPS_PROXY=&#39;http://改成你自己的代理&#39; git clone https://github.com/${app_repo}.git ~/app
RUN cd ~/app &amp;&amp; git reset --hard ${app_commit} &amp;&amp; go build .
</code></pre><ul>
<li>复现命令</li>
</ul>
<pre tabindex="0"><code># 注意这个 app_commit 是一个不存在的 commit
docker build -t curl_test --build-arg app_repo=bwangelme/rdcdemo --build-arg app_commit=2f24a0658d7feb0205e7d75b7ae218ff6495e8f3 .
</code></pre>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-a5f545a950366d730141f62b977f5c24">21.2 - lsof</h1>
    
	<h2 id="按照网络状态筛选进程的-fd">按照网络状态筛选进程的 fd</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo lsof -i -sTCP:LISTEN -a -p &lt;pid&gt;
</span></span></code></pre></div><ul>
<li>
<p><code>-a</code> 表示 and, 前后两个条件要一起生效</p>
</li>
<li>
<p><code>-i</code> 和 <code>-s</code> 一起用，表示可以按照 TCP/UDP 状态来筛选 fd</p>
</li>
<li>
<p>列出进程 <code>&lt;pid&gt;</code> 建立的所有 TCP 连接</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo lsof -i -sTCP:ESTABLISHED -a -p &lt;pid&gt;
</span></span></code></pre></div><ul>
<li>列出进程 <code>&lt;pid&gt;</code> 所有 IDLE 状态的 UDP 连接</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo lsof -i -sUDP:IDLE -a -p &lt;pid&gt;
</span></span></code></pre></div><p>根据 Unix 发行版本的不同，TCP/UDP 状态也会有不同的名字:</p>
<ul>
<li>常用的 TCP 状态是: <code>CLOSED</code>, <code>IDLE</code>, <code>BOUND</code>, <code>LISTEN</code>, <code>ESTABLISHED</code>, <code>SYN_SENT</code>, <code>SYN_RCDV</code>, <code>ESTABLISHED</code>, <code>CLOSE_WAIT</code>, <code>FIN_WAIT1</code>, <code>CLOSING</code>, <code>LAST_ACK</code>, <code>FIN_WAIT_2</code>, <code>TIME_WAIT</code>.</li>
<li>常用的 UDP 状态是: <code>Unbound</code>, <code>Idle</code></li>
</ul>
<h2 id="按照-fd-number-查找进程的-fd">按照 fd number 查找进程的 fd</h2>
<p>使用 <code>strace</code> 查看进程的系统调用的时候，经常能够看到在某个 fd 上执行读写操作，例如:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>write<span style="color:#ce5c00;font-weight:bold">(</span>267, <span style="color:#4e9a06">&#34;\1\0\0\0\0\0\0\0&#34;</span>, 8<span style="color:#ce5c00;font-weight:bold">)</span>       <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">8</span>
</span></span><span style="display:flex;"><span>read<span style="color:#ce5c00;font-weight:bold">(</span>5405, <span style="color:#4e9a06">&#34;# Kubernetes-managed hosts file &#34;</span>..., 4096<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">4096</span>
</span></span></code></pre></div><p>我们想要查一下这个 267 和 5405 具体代表了什么连接，可以用</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo lsof -d &lt;fd_number&gt; -a -p &lt;pid&gt;
</span></span></code></pre></div><p>例如我利用 strace 查看飞书 app 的系统调用，看到以下的信息</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ø&gt; sudo strace -p <span style="color:#0000cf;font-weight:bold">8261</span>
</span></span><span style="display:flex;"><span>strace: Process <span style="color:#0000cf;font-weight:bold">8261</span> attached
</span></span><span style="display:flex;"><span>restart_syscall<span style="color:#ce5c00;font-weight:bold">(</span>&lt;... resuming interrupted <span style="color:#204a87">read</span> ...&gt;<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>openat<span style="color:#ce5c00;font-weight:bold">(</span>AT_FDCWD, <span style="color:#4e9a06">&#34;/proc/self/status&#34;</span>, O_RDONLY<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">4</span>
</span></span><span style="display:flex;"><span>read<span style="color:#ce5c00;font-weight:bold">(</span>4, <span style="color:#4e9a06">&#34;Name:\tfeishu\nUmask:\t0002\nState:\t&#34;</span>..., 1024<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1024</span>
</span></span><span style="display:flex;"><span>close<span style="color:#ce5c00;font-weight:bold">(</span>4<span style="color:#ce5c00;font-weight:bold">)</span>                                <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>futex<span style="color:#ce5c00;font-weight:bold">(</span>0x7ff0a7ffead8, FUTEX_WAKE_PRIVATE, 2147483647<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>futex<span style="color:#ce5c00;font-weight:bold">(</span>0x7ff0a7ffea88, FUTEX_WAKE_PRIVATE, 1<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>recvmsg<span style="color:#ce5c00;font-weight:bold">(</span>23, <span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#000">msg_namelen</span><span style="color:#ce5c00;font-weight:bold">=</span>0<span style="color:#ce5c00;font-weight:bold">}</span>, 0<span style="color:#ce5c00;font-weight:bold">)</span>         <span style="color:#ce5c00;font-weight:bold">=</span> -1 EAGAIN <span style="color:#ce5c00;font-weight:bold">(</span>资源暂时不可用<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>recvmsg<span style="color:#ce5c00;font-weight:bold">(</span>23, <span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#000">msg_namelen</span><span style="color:#ce5c00;font-weight:bold">=</span>0<span style="color:#ce5c00;font-weight:bold">}</span>, 0<span style="color:#ce5c00;font-weight:bold">)</span>         <span style="color:#ce5c00;font-weight:bold">=</span> -1 EAGAIN <span style="color:#ce5c00;font-weight:bold">(</span>资源暂时不可用<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>poll<span style="color:#ce5c00;font-weight:bold">([{</span><span style="color:#000">fd</span><span style="color:#ce5c00;font-weight:bold">=</span>9, <span style="color:#000">events</span><span style="color:#ce5c00;font-weight:bold">=</span>POLLIN<span style="color:#ce5c00;font-weight:bold">}</span>, <span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#000">fd</span><span style="color:#ce5c00;font-weight:bold">=</span>10, <span style="color:#000">events</span><span style="color:#ce5c00;font-weight:bold">=</span>POLLIN<span style="color:#ce5c00;font-weight:bold">}</span>, <span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#000">fd</span><span style="color:#ce5c00;font-weight:bold">=</span>22, <span style="color:#000">events</span><span style="color:#ce5c00;font-weight:bold">=</span>POLLIN<span style="color:#ce5c00;font-weight:bold">}</span>, <span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#000">fd</span><span style="color:#ce5c00;font-weight:bold">=</span>23, <span style="color:#000">events</span><span style="color:#ce5c00;font-weight:bold">=</span>POLLIN<span style="color:#ce5c00;font-weight:bold">}</span>, <span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#000">fd</span><span style="color:#ce5c00;font-weight:bold">=</span>67, <span style="color:#000">events</span><span style="color:#ce5c00;font-weight:bold">=</span>POLLIN<span style="color:#ce5c00;font-weight:bold">}]</span>, 5, 0<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#ce5c00;font-weight:bold">(</span>Timeout<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>recvmsg<span style="color:#ce5c00;font-weight:bold">(</span>23, <span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#000">msg_namelen</span><span style="color:#ce5c00;font-weight:bold">=</span>0<span style="color:#ce5c00;font-weight:bold">}</span>, 0<span style="color:#ce5c00;font-weight:bold">)</span>         <span style="color:#ce5c00;font-weight:bold">=</span> -1 EAGAIN <span style="color:#ce5c00;font-weight:bold">(</span>资源暂时不可用<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>recvmsg<span style="color:#ce5c00;font-weight:bold">(</span>23, <span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#000">msg_namelen</span><span style="color:#ce5c00;font-weight:bold">=</span>0<span style="color:#ce5c00;font-weight:bold">}</span>, 0<span style="color:#ce5c00;font-weight:bold">)</span>         <span style="color:#ce5c00;font-weight:bold">=</span> -1 EAGAIN <span style="color:#ce5c00;font-weight:bold">(</span>资源暂时不可用<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>poll<span style="color:#ce5c00;font-weight:bold">([{</span><span style="color:#000">fd</span><span style="color:#ce5c00;font-weight:bold">=</span>9, <span style="color:#000">events</span><span style="color:#ce5c00;font-weight:bold">=</span>POLLIN<span style="color:#ce5c00;font-weight:bold">}</span>, <span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#000">fd</span><span style="color:#ce5c00;font-weight:bold">=</span>10, <span style="color:#000">events</span><span style="color:#ce5c00;font-weight:bold">=</span>POLLIN<span style="color:#ce5c00;font-weight:bold">}</span>, <span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#000">fd</span><span style="color:#ce5c00;font-weight:bold">=</span>22, <span style="color:#000">events</span><span style="color:#ce5c00;font-weight:bold">=</span>POLLIN<span style="color:#ce5c00;font-weight:bold">}</span>, <span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#000">fd</span><span style="color:#ce5c00;font-weight:bold">=</span>23, <span style="color:#000">events</span><span style="color:#ce5c00;font-weight:bold">=</span>POLLIN<span style="color:#ce5c00;font-weight:bold">}</span>, <span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#000">fd</span><span style="color:#ce5c00;font-weight:bold">=</span>67, <span style="color:#000">events</span><span style="color:#ce5c00;font-weight:bold">=</span>POLLIN<span style="color:#ce5c00;font-weight:bold">}]</span>, 5, 200<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">([{</span><span style="color:#000">fd</span><span style="color:#ce5c00;font-weight:bold">=</span>10, <span style="color:#000">revents</span><span style="color:#ce5c00;font-weight:bold">=</span>POLLIN<span style="color:#ce5c00;font-weight:bold">}])</span>
</span></span><span style="display:flex;"><span>read<span style="color:#ce5c00;font-weight:bold">(</span>10, <span style="color:#4e9a06">&#34;!&#34;</span>, 2<span style="color:#ce5c00;font-weight:bold">)</span>                        <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>futex<span style="color:#ce5c00;font-weight:bold">(</span>0x7ff0a7ffead8, FUTEX_WAKE_PRIVATE, 2147483647<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>futex<span style="color:#ce5c00;font-weight:bold">(</span>0x7ff0a7ffea88, FUTEX_WAKE_PRIVATE, 1<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>futex<span style="color:#ce5c00;font-weight:bold">(</span>0x7ff0a0001eb8, FUTEX_WAKE_PRIVATE, 1<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>openat<span style="color:#ce5c00;font-weight:bold">(</span>AT_FDCWD, <span style="color:#4e9a06">&#34;/proc/self/status&#34;</span>, O_RDONLY<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">4</span>
</span></span><span style="display:flex;"><span>read<span style="color:#ce5c00;font-weight:bold">(</span>4, <span style="color:#4e9a06">&#34;Name:\tfeishu\nUmask:\t0002\nState:\t&#34;</span>..., 1024<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1024</span>
</span></span></code></pre></div><p>我想知道 fd 4 代表了什么，执行 <code>sudo lsof -d 4 -a -p 8261</code>，可以看到它是我的电脑和 <code>220.181.131.241</code> 建立的一个 https 连接。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ø&gt; sudo lsof -d <span style="color:#0000cf;font-weight:bold">4</span> -a -p <span style="color:#0000cf;font-weight:bold">8261</span>
</span></span><span style="display:flex;"><span>COMMAND  PID      USER   FD   TYPE  DEVICE SIZE/OFF NODE NAME
</span></span><span style="display:flex;"><span>feishu  <span style="color:#0000cf;font-weight:bold">8261</span> xuyundong    4u  IPv4 <span style="color:#0000cf;font-weight:bold">2613086</span>      0t0  TCP 192.168.252.88:35810-&gt;220.181.131.241:https <span style="color:#ce5c00;font-weight:bold">(</span>ESTABLISHED<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span></code></pre></div><h2 id="查看端口占用">查看端口占用</h2>
<p>有时候我们启动程序的时候，发现端口被占用了，可以用 <code>lsof -i:xxx</code> 来查看端口被哪个进程占用了，例如:</p>
<p>下面这条命令显示 3306 端口被 <code>360702</code> 和 <code>360709</code> 两个进程占用了。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ø&gt; sudo lsof -i:3306
</span></span><span style="display:flex;"><span>COMMAND      PID USER   FD   TYPE  DEVICE SIZE/OFF NODE NAME
</span></span><span style="display:flex;"><span>docker-pr <span style="color:#0000cf;font-weight:bold">360702</span> root    4u  IPv4 <span style="color:#0000cf;font-weight:bold">1842886</span>      0t0  TCP *:mysql <span style="color:#ce5c00;font-weight:bold">(</span>LISTEN<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>docker-pr <span style="color:#0000cf;font-weight:bold">360709</span> root    4u  IPv6 <span style="color:#0000cf;font-weight:bold">1842889</span>      0t0  TCP *:mysql <span style="color:#ce5c00;font-weight:bold">(</span>LISTEN<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span></code></pre></div><h2 id="查看容器的网络调用">查看容器的网络调用</h2>
<h3 id="构建镜像">构建镜像</h3>
<ul>
<li>download.py</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#!/usr/bin/env python3</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># -*- coding: utf-8 -*-&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">requests</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">resp</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">requests</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;https://releases.ubuntu.com/22.04.2/ubuntu-22.04.2-desktop-amd64.iso?_ga=2.131295240.668169970.1684741981-917190618.1681460407&#39;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">resp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">status_code</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><ul>
<li>Dockerfile</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#4e9a06"> python:3.10</span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#204a87;font-weight:bold">RUN</span> pip install requests<span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#204a87;font-weight:bold">COPY</span> download.py /download.py<span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#204a87;font-weight:bold">ENTRYPOINT</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;python&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;/download.py&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#a40000">
</span></span></span></code></pre></div><p>准备上述两个文件，然后执行</p>
<pre tabindex="0"><code>docker build -t test_download .
</code></pre><p>构建我们用于调试的镜像, <code>test_download</code> 。</p>
<h3 id="启动阻塞的容器">启动阻塞的容器</h3>
<p>执行以下命令，启动一个阻塞在网络请求中的容器。</p>
<pre tabindex="0"><code>docker run --rm test_download
</code></pre><blockquote>
<p><strong>Note</strong>:</p>
<p>这个例子不太好，因为 <code>releases.ubuntu.com</code> 还比较健康，会持续地返回内容，现实中我们遇到的情况是，服务器完全不返回内容，客户端也没有设置超时时间，完全处于阻塞的状态。</p>
</blockquote>
<h3 id="查找容器的-pid">查找容器的 pid</h3>
<p>根据容器的 ID, 我们通过 <code>docker inspect &lt;id&gt;| rg -i pid</code> 可以获得容器的进程 ID</p>
<p>如果你使用的是 containerd, 可以使用 <code>crictl inspect &lt;id&gt; | rg -i pid</code></p>
<pre tabindex="0"><code>ø&gt; docker ps
CONTAINER ID   IMAGE           COMMAND                 CREATED          STATUS          PORTS     NAMES
bf5846384913   test_download   &#34;python /download.py&#34;   37 seconds ago   Up 36 seconds             friendly_wozniak
ø&gt; docker inspect bf5846384913 | rg -i pid
            &#34;Pid&#34;: 726678,
            &#34;PidMode&#34;: &#34;&#34;,
            &#34;PidsLimit&#34;: null,
</code></pre><h3 id="利用-strace-查看进程的状态">利用 strace 查看进程的状态</h3>
<p>从 strace 的输出中可以看到，进程一直在从 3 号 fd 上读取数据</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>root@Macmini:~# strace -p <span style="color:#0000cf;font-weight:bold">726678</span>
</span></span><span style="display:flex;"><span>strace: Process <span style="color:#0000cf;font-weight:bold">726678</span> attached
</span></span><span style="display:flex;"><span>read<span style="color:#ce5c00;font-weight:bold">(</span>3, <span style="color:#4e9a06">&#34;Z\263\351\331\315\17\330\205\222\361\21\235&#39;Kp\301w\256\365|\275K\326y\350@\305\300\325\262\fk&#34;</span>..., 13131<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1448</span>
</span></span><span style="display:flex;"><span>read<span style="color:#ce5c00;font-weight:bold">(</span>3, <span style="color:#4e9a06">&#34;\317GKJ\324O)1\5\272\\\&#34;\24\360s\177\263\223#\376\360\35\360\226\240\214mf\374\243\222\335&#34;</span>..., 11683<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">11683</span>
</span></span><span style="display:flex;"><span>read<span style="color:#ce5c00;font-weight:bold">(</span>3, <span style="color:#4e9a06">&#34;\27\3\3@\21&#34;</span>, 5<span style="color:#ce5c00;font-weight:bold">)</span>               <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">5</span>
</span></span><span style="display:flex;"><span>read<span style="color:#ce5c00;font-weight:bold">(</span>3, <span style="color:#4e9a06">&#34;\22c\367U@\243\377\325\255\n0\376\79J\244\v9O4\233Kq\0233\304k\6\356dy\20&#34;</span>..., 16401<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">16401</span>
</span></span><span style="display:flex;"><span>read<span style="color:#ce5c00;font-weight:bold">(</span>3, <span style="color:#4e9a06">&#34;\27\3\3@\21&#34;</span>, 5<span style="color:#ce5c00;font-weight:bold">)</span>               <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">5</span>
</span></span><span style="display:flex;"><span>read<span style="color:#ce5c00;font-weight:bold">(</span>3, <span style="color:#4e9a06">&#34;[\244K\30\7\30?[\210\313\364\335\t\321&gt;l\270\2\365\262\307|\376\211.\376\342%\361\34\31\246&#34;</span>..., 16401<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">16401</span>
</span></span><span style="display:flex;"><span>read<span style="color:#ce5c00;font-weight:bold">(</span>3, <span style="color:#4e9a06">&#34;\27\3\3@\21&#34;</span>, 5<span style="color:#ce5c00;font-weight:bold">)</span>               <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">5</span>
</span></span><span style="display:flex;"><span>read<span style="color:#ce5c00;font-weight:bold">(</span>3, <span style="color:#4e9a06">&#34;\335\373\354\320:SF\244o#\244\377Ll\21\366AT\374vgYD\2418\305\340\313||\243;&#34;</span>..., 16401<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">16401</span>
</span></span><span style="display:flex;"><span>read<span style="color:#ce5c00;font-weight:bold">(</span>3, <span style="color:#4e9a06">&#34;\27\3\3@\21&#34;</span>, 5<span style="color:#ce5c00;font-weight:bold">)</span>               <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">5</span>
</span></span><span style="display:flex;"><span>read<span style="color:#ce5c00;font-weight:bold">(</span>3, <span style="color:#4e9a06">&#34;X \300\240\252IoZ\352W</span>$<span style="color:#4e9a06">\255\266\324\304q\306\23\226-b\212\300\271\222pI\270\33\tcn&#34;</span>..., 16401<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">16401</span>
</span></span><span style="display:flex;"><span>read<span style="color:#ce5c00;font-weight:bold">(</span>3, <span style="color:#4e9a06">&#34;\27\3\3@\21&#34;</span>, 5<span style="color:#ce5c00;font-weight:bold">)</span>               <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">5</span>
</span></span><span style="display:flex;"><span>read<span style="color:#ce5c00;font-weight:bold">(</span>3, <span style="color:#4e9a06">&#34;\213\331\225\331b\2405\204\f\213\32\r\250;\250\326.\4l\221\230^0\272{\317\32he\262V\223&#34;</span>..., 16401<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">16401</span>
</span></span><span style="display:flex;"><span>brk<span style="color:#ce5c00;font-weight:bold">(</span>0x55fba8f48000<span style="color:#ce5c00;font-weight:bold">)</span>                     <span style="color:#ce5c00;font-weight:bold">=</span> 0x55fba8f48000
</span></span><span style="display:flex;"><span>read<span style="color:#ce5c00;font-weight:bold">(</span>3, <span style="color:#4e9a06">&#34;\27\3\3@\21&#34;</span>, 5<span style="color:#ce5c00;font-weight:bold">)</span>               <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">5</span>
</span></span><span style="display:flex;"><span>read<span style="color:#ce5c00;font-weight:bold">(</span>3, <span style="color:#4e9a06">&#34;\4\317\362`-R}\360\&#34;\266nZ\33\261s,\340\345\371\300;]\347\30\237\344\305\235m\360j\357&#34;</span>..., 16401<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">16401</span>
</span></span><span style="display:flex;"><span>read<span style="color:#ce5c00;font-weight:bold">(</span>3, <span style="color:#4e9a06">&#34;\27\3\3@\21&#34;</span>, 5<span style="color:#ce5c00;font-weight:bold">)</span>               <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">5</span>
</span></span><span style="display:flex;"><span>read<span style="color:#ce5c00;font-weight:bold">(</span>3, <span style="color:#4e9a06">&#34;1v\355\312]nG\347\240\4\210\350\241\34\257\333\307\233z\261\0\6\307\2234n\21V\27\305\272\371&#34;</span>..., 16401<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">16401</span>
</span></span><span style="display:flex;"><span>read<span style="color:#ce5c00;font-weight:bold">(</span>3, <span style="color:#4e9a06">&#34;\27\3\3@\21&#34;</span>, 5<span style="color:#ce5c00;font-weight:bold">)</span>               <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">5</span>
</span></span></code></pre></div><h3 id="利用-lsof-查看-fd-详细信息">利用 lsof 查看 fd 详细信息</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>nsenter -n -t <span style="color:#0000cf;font-weight:bold">726678</span> lsof -d <span style="color:#0000cf;font-weight:bold">3</span> -a -p <span style="color:#0000cf;font-weight:bold">726678</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>root@Macmini:~# nsenter -n -t <span style="color:#0000cf;font-weight:bold">726678</span> lsof -d <span style="color:#0000cf;font-weight:bold">3</span> -a -p <span style="color:#0000cf;font-weight:bold">726678</span>
</span></span><span style="display:flex;"><span>COMMAND    PID USER   FD   TYPE  DEVICE SIZE/OFF NODE NAME
</span></span><span style="display:flex;"><span>python  <span style="color:#0000cf;font-weight:bold">726678</span> root    3u  IPv4 <span style="color:#0000cf;font-weight:bold">9813984</span>      0t0  TCP 172.17.0.2:55378-&gt;https-services.aerodent.canonical.com:https <span style="color:#ce5c00;font-weight:bold">(</span>ESTABLISHED<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span></code></pre></div><p>可以看到，3号fd 是一个TCP 连接，本地的 <code>172.17.0.2:55378</code> 连接了远端的 <code>https-services.aerodent.canonical.com:https</code></p>
<blockquote>
<p><strong>Note</strong></p>
<p>如果我们不加 nsenter -n -t <pid> 来切换 network namespace 的话，lsof 输出的信息中就没有详细的客户端和服务端的地址了</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>root@Macmini:~# lsof -d <span style="color:#0000cf;font-weight:bold">3</span> -a -p <span style="color:#0000cf;font-weight:bold">729160</span>
</span></span><span style="display:flex;"><span>COMMAND    PID USER   FD   TYPE DEVICE SIZE/OFF    NODE NAME
</span></span><span style="display:flex;"><span>python  <span style="color:#0000cf;font-weight:bold">729160</span> root    3u  sock    0,8      0t0 <span style="color:#0000cf;font-weight:bold">9829458</span> protocol: TCP
</span></span></code></pre></div><h2 id="参考链接">参考链接</h2>
<ul>
<li><a href="https://linux.die.net/man/8/lsof">man lsof</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-69dc1da95bd41a25bf26e181c6ed42e5">21.3 - DNS</h1>
    
	<h2 id="a-记录">A 记录</h2>
<p>Address Mapping records, 指示了对应名称的IPv4地址, A记录用来将域名转换为ip地址.</p>
<h2 id="aaaa-记录">AAAA 记录</h2>
<p>类似于A记录, 只不过指示的是IPv6的地址。</p>
<p>因为 IPv6 地址长度是 IPv4 的四倍，所以用 AAAA 表示 IPv6 记录</p>
<h2 id="ns-记录">NS 记录</h2>
<ul>
<li>Name Server records, 用来指定对应名称的可信名称服务器 (authoritative name server)</li>
</ul>
<p>例如这段 dig 日志是 <code>j.gtld-servers.net</code> 告诉我们，它不知道 <code>www.baidu.com</code> 的 IP, 但是它告诉我们要查询 <code>baidu.com.</code> 域的地址，可以去 ns[12345].baidu.com 这5个地址中查。</p>
<pre tabindex="0"><code>baidu.com.              172800  IN      NS      ns2.baidu.com.
baidu.com.              172800  IN      NS      ns3.baidu.com.
baidu.com.              172800  IN      NS      ns4.baidu.com.
baidu.com.              172800  IN      NS      ns1.baidu.com.
baidu.com.              172800  IN      NS      ns7.baidu.com.
;; Received 849 bytes from 192.48.79.30#53(j.gtld-servers.net) in 316 ms
</code></pre><h2 id="ptr-记录">PTR 记录</h2>
<p>Pointer records, 通过 IP 反查域名，大部分域名服务器都不支持，目前只找到了 <code>dns.google.</code> 支持 PTR 查询</p>
<pre tabindex="0"><code>ø&gt; dig -x 8.8.4.4

;; QUESTION SECTION:
;4.4.8.8.in-addr.arpa.          IN      PTR

;; ANSWER SECTION:
4.4.8.8.in-addr.arpa.   1       IN      PTR     dns.google.
</code></pre><h2 id="cname-记录">CNAME 记录</h2>
<p>又称 alias 别名，是 A 记录的别名</p>
<p>例如以下的查询说明</p>
<ol>
<li><code>www.baidu.com.</code> 是 <code>www.a.shifen.com.</code> 的别名</li>
<li><code>www.a.shifen.com.</code> 指向了 <code>220.181.38.150</code> 和 <code>220.181.38.149</code></li>
</ol>
<pre tabindex="0"><code>ø&gt; dig -4 www.baidu.com

;; QUESTION SECTION:
;www.baidu.com.                 IN      A

;; ANSWER SECTION:
www.baidu.com.          70      IN      CNAME   www.a.shifen.com.
www.a.shifen.com.       53      IN      A       220.181.38.150
www.a.shifen.com.       53      IN      A       220.181.38.149
</code></pre><h2 id="查询方式">查询方式</h2>
<h3 id="递归查询">递归查询</h3>
<p>client 发送请求给局域网 DNS, 局域网 DNS 再去上游 DNS 服务器执行进一步查询。一级一级向上递归并回到局域网 DNS , 局域网 DNS 将查询的地址返回给客户端</p>
<p>dig 命令默认执行的就是递归查询</p>
<h3 id="集中查询">集中查询</h3>
<ol>
<li>client 发送请求给局域网 DNS 获得 DNS 根服务器的地址</li>
<li>client 请求根服务器获得下一级 DNS 服务器地址</li>
<li>以此往复，一级一级直到查到目标域名的 IP 地址</li>
</ol>
<p>以下用集中查询的方式查询 <a href="https://www.baidu.com">www.baidu.com</a> IP 地址的过程</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>ø&gt; dig -4 +trace www.baidu.com
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 获取根服务器的名字列表</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;</span> &lt;&lt;&gt;&gt; DiG 9.18.12-0ubuntu0.22.04.2-Ubuntu &lt;&lt;&gt;&gt; -4 +trace www.baidu.com
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;;</span> global options: +cmd
</span></span><span style="display:flex;"><span>.                       <span style="color:#0000cf;font-weight:bold">2229</span>    IN      NS      k.root-servers.net.
</span></span><span style="display:flex;"><span>.                       <span style="color:#0000cf;font-weight:bold">2229</span>    IN      NS      b.root-servers.net.
</span></span><span style="display:flex;"><span>.                       <span style="color:#0000cf;font-weight:bold">2229</span>    IN      NS      h.root-servers.net.
</span></span><span style="display:flex;"><span>.                       <span style="color:#0000cf;font-weight:bold">2229</span>    IN      NS      i.root-servers.net.
</span></span><span style="display:flex;"><span>.                       <span style="color:#0000cf;font-weight:bold">2229</span>    IN      NS      l.root-servers.net.
</span></span><span style="display:flex;"><span>.                       <span style="color:#0000cf;font-weight:bold">2229</span>    IN      NS      c.root-servers.net.
</span></span><span style="display:flex;"><span>.                       <span style="color:#0000cf;font-weight:bold">2229</span>    IN      NS      a.root-servers.net.
</span></span><span style="display:flex;"><span>.                       <span style="color:#0000cf;font-weight:bold">2229</span>    IN      NS      d.root-servers.net.
</span></span><span style="display:flex;"><span>.                       <span style="color:#0000cf;font-weight:bold">2229</span>    IN      NS      e.root-servers.net.
</span></span><span style="display:flex;"><span>.                       <span style="color:#0000cf;font-weight:bold">2229</span>    IN      NS      m.root-servers.net.
</span></span><span style="display:flex;"><span>.                       <span style="color:#0000cf;font-weight:bold">2229</span>    IN      NS      f.root-servers.net.
</span></span><span style="display:flex;"><span>.                       <span style="color:#0000cf;font-weight:bold">2229</span>    IN      NS      g.root-servers.net.
</span></span><span style="display:flex;"><span>.                       <span style="color:#0000cf;font-weight:bold">2229</span>    IN      NS      j.root-servers.net.
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;;</span> Received <span style="color:#0000cf;font-weight:bold">239</span> bytes from 10.8.0.1#53<span style="color:#ce5c00;font-weight:bold">(</span>10.8.0.1<span style="color:#ce5c00;font-weight:bold">)</span> in <span style="color:#0000cf;font-weight:bold">4</span> ms
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 根服务器返回通用定义域名的名字列表</span>
</span></span><span style="display:flex;"><span>com.                    <span style="color:#0000cf;font-weight:bold">172800</span>  IN      NS      a.gtld-servers.net.
</span></span><span style="display:flex;"><span>com.                    <span style="color:#0000cf;font-weight:bold">172800</span>  IN      NS      b.gtld-servers.net.
</span></span><span style="display:flex;"><span>com.                    <span style="color:#0000cf;font-weight:bold">172800</span>  IN      NS      c.gtld-servers.net.
</span></span><span style="display:flex;"><span>com.                    <span style="color:#0000cf;font-weight:bold">172800</span>  IN      NS      d.gtld-servers.net.
</span></span><span style="display:flex;"><span>com.                    <span style="color:#0000cf;font-weight:bold">172800</span>  IN      NS      e.gtld-servers.net.
</span></span><span style="display:flex;"><span>com.                    <span style="color:#0000cf;font-weight:bold">172800</span>  IN      NS      f.gtld-servers.net.
</span></span><span style="display:flex;"><span>com.                    <span style="color:#0000cf;font-weight:bold">172800</span>  IN      NS      g.gtld-servers.net.
</span></span><span style="display:flex;"><span>com.                    <span style="color:#0000cf;font-weight:bold">172800</span>  IN      NS      h.gtld-servers.net.
</span></span><span style="display:flex;"><span>com.                    <span style="color:#0000cf;font-weight:bold">172800</span>  IN      NS      i.gtld-servers.net.
</span></span><span style="display:flex;"><span>com.                    <span style="color:#0000cf;font-weight:bold">172800</span>  IN      NS      j.gtld-servers.net.
</span></span><span style="display:flex;"><span>com.                    <span style="color:#0000cf;font-weight:bold">172800</span>  IN      NS      k.gtld-servers.net.
</span></span><span style="display:flex;"><span>com.                    <span style="color:#0000cf;font-weight:bold">172800</span>  IN      NS      l.gtld-servers.net.
</span></span><span style="display:flex;"><span>com.                    <span style="color:#0000cf;font-weight:bold">172800</span>  IN      NS      m.gtld-servers.net.
</span></span><span style="display:flex;"><span>com.                    <span style="color:#0000cf;font-weight:bold">86400</span>   IN      DS      <span style="color:#0000cf;font-weight:bold">30909</span> <span style="color:#0000cf;font-weight:bold">8</span> <span style="color:#0000cf;font-weight:bold">2</span> E2D3C916F6DEEAC73294E8268FB5885044A833FC5459588F4A9184CF C41A5766
</span></span><span style="display:flex;"><span>com.                    <span style="color:#0000cf;font-weight:bold">86400</span>   IN      RRSIG   DS <span style="color:#0000cf;font-weight:bold">8</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#0000cf;font-weight:bold">86400</span> <span style="color:#0000cf;font-weight:bold">20230921210000</span> <span style="color:#0000cf;font-weight:bold">20230908200000</span> <span style="color:#0000cf;font-weight:bold">11019</span> . M02FKEukwDc7T/KjNtpdCfwvkzHx1STqPt3AO/eXQxqBU7jN9vrHbJMJ PNXpBlO5p+HgnZ9w0c7sR8qnDXFl1OziNAo0el1fRq0YFwBae9BgoLCg IeZVoZmqerXpVXCrpKX1Fb+ILjuIX1bL5li2xQ/gpq4u91EijGvZg6sQ UmBiQW0JlXKR927uOm+aJHN6Ujnzd7sZrOWpSXQAOVPf4dHjvCJNohfs V9cJkjBRI+QuOpArJ+gCGKoiMidjYZBuYXIsYV7PYLQbVfVZg2E3JFXX h5BkqZUlCZbabAcVCzQ6BGZMpxcs1A/J8g/7+eguU6bJFpbiBXeHEZhx <span style="color:#000">TS1zoQ</span><span style="color:#ce5c00;font-weight:bold">==</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;;</span> Received <span style="color:#0000cf;font-weight:bold">1173</span> bytes from 192.58.128.30#53<span style="color:#ce5c00;font-weight:bold">(</span>j.root-servers.net<span style="color:#ce5c00;font-weight:bold">)</span> in <span style="color:#0000cf;font-weight:bold">8</span> ms
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 通用顶级域名返回 baidu.com. 域的 DNS 服务器名字列表</span>
</span></span><span style="display:flex;"><span>baidu.com.              <span style="color:#0000cf;font-weight:bold">172800</span>  IN      NS      ns2.baidu.com.
</span></span><span style="display:flex;"><span>baidu.com.              <span style="color:#0000cf;font-weight:bold">172800</span>  IN      NS      ns3.baidu.com.
</span></span><span style="display:flex;"><span>baidu.com.              <span style="color:#0000cf;font-weight:bold">172800</span>  IN      NS      ns4.baidu.com.
</span></span><span style="display:flex;"><span>baidu.com.              <span style="color:#0000cf;font-weight:bold">172800</span>  IN      NS      ns1.baidu.com.
</span></span><span style="display:flex;"><span>baidu.com.              <span style="color:#0000cf;font-weight:bold">172800</span>  IN      NS      ns7.baidu.com.
</span></span><span style="display:flex;"><span>CK0POJMG874LJREF7EFN8430QVIT8BSM.com. <span style="color:#0000cf;font-weight:bold">86400</span> IN NSEC3 <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#0000cf;font-weight:bold">0</span> - CK0Q2D6NI4I7EQH8NA30NS61O48UL8G5 NS SOA RRSIG DNSKEY NSEC3PARAM
</span></span><span style="display:flex;"><span>CK0POJMG874LJREF7EFN8430QVIT8BSM.com. <span style="color:#0000cf;font-weight:bold">86400</span> IN RRSIG NSEC3 <span style="color:#0000cf;font-weight:bold">8</span> <span style="color:#0000cf;font-weight:bold">2</span> <span style="color:#0000cf;font-weight:bold">86400</span> <span style="color:#0000cf;font-weight:bold">20230915042421</span> <span style="color:#0000cf;font-weight:bold">20230908031421</span> <span style="color:#0000cf;font-weight:bold">4459</span> com. ACWanRvoDIwYH40J5TjA8G6UXUldpz8+aNZdFlLO1eY9GRalvfLnpa6H RqiP03pvORSpHJEv2+HuQ1HtWTCj/nlJOeiRKG0Bk/HjcjkH9yv1b6pF ASeyvdJYN2wYPp4e1KPVe3GuoxBETq6kPKfUhR289IzQFy5vLgIfeVWK <span style="color:#000">pR6z0kgCFKTKaO21nj2LxxWsxmfuIpe8ztJuPTF7lVhXhw</span><span style="color:#ce5c00;font-weight:bold">==</span>
</span></span><span style="display:flex;"><span>HPVV0C47Q7CQMTAJM90K1FBFJBRP4B4D.com. <span style="color:#0000cf;font-weight:bold">86400</span> IN NSEC3 <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#0000cf;font-weight:bold">0</span> - HPVVAN8CFKHHHMEIDVJHFNQEOI5G6C89 NS DS RRSIG
</span></span><span style="display:flex;"><span>HPVV0C47Q7CQMTAJM90K1FBFJBRP4B4D.com. <span style="color:#0000cf;font-weight:bold">86400</span> IN RRSIG NSEC3 <span style="color:#0000cf;font-weight:bold">8</span> <span style="color:#0000cf;font-weight:bold">2</span> <span style="color:#0000cf;font-weight:bold">86400</span> <span style="color:#0000cf;font-weight:bold">20230914060727</span> <span style="color:#0000cf;font-weight:bold">20230907045727</span> <span style="color:#0000cf;font-weight:bold">4459</span> com. oUS/iAWQKq/0KHQdg18vwuUvT1Ftl8tnpHZVCwdQPEaIq3gceZnmpE2Z u8pj+JPFOUqp/DWRNlWZYMmTuhSjJil7cCpahWk3+RJbeJQIWPtNvBkl BBmM1M3he1ELoS37YqcflA8U/q4CaNdEpIS7OiNy6f4efrkZMvqRZZ9U hRgI2CugaGb6C9mDeAfThooAqsc5xFCX9KjWGsNLr0pE+Q<span style="color:#ce5c00;font-weight:bold">==</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;;</span> Received <span style="color:#0000cf;font-weight:bold">849</span> bytes from 192.48.79.30#53<span style="color:#ce5c00;font-weight:bold">(</span>j.gtld-servers.net<span style="color:#ce5c00;font-weight:bold">)</span> in <span style="color:#0000cf;font-weight:bold">316</span> ms
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># ns3.baidu.com 返回 www.baidu.com 的解析结果</span>
</span></span><span style="display:flex;"><span>www.baidu.com.          <span style="color:#0000cf;font-weight:bold">1200</span>    IN      CNAME   www.a.shifen.com.
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;;</span> Received <span style="color:#0000cf;font-weight:bold">100</span> bytes from 153.3.238.93#53<span style="color:#ce5c00;font-weight:bold">(</span>ns3.baidu.com<span style="color:#ce5c00;font-weight:bold">)</span> in <span style="color:#0000cf;font-weight:bold">24</span> ms
</span></span></code></pre></div><p>这是集中查询的抓包过程(建议在新 tab 中打开图片对比说明查看)</p>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2023-09-09-143516.png" alt=""></p>
<table>
<thead>
<tr>
<th>包序号</th>
<th>包功能</th>
</tr>
</thead>
<tbody>
<tr>
<td>1, 2</td>
<td>从 10.8.0.1 DNS 服务器获得根服务器的地址</td>
</tr>
<tr>
<td>3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 24, 25, 26</td>
<td>向 192.168.1.1 和 10.8.0.1 查询根服务器的地址 (两个网卡都发送了查询请求)</td>
</tr>
<tr>
<td>14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 28, 29, 30, 31</td>
<td>10.8.0.1 和 192.168.1.1 返回 DNS 根服务器地址</td>
</tr>
<tr>
<td>26</td>
<td>向根服务器 <code>g.root-servers.net.</code> 查询 <code>www.baidu.com.</code> 的地址</td>
</tr>
<tr>
<td>32</td>
<td>根服务器 <code>g.root-servers.net.</code> 返回通用顶级域名列表及其地址 <code>[a-j].gtld-servers.net</code></td>
</tr>
<tr>
<td>33, 34, 35, 36, 37, 38, 39, 40, 42, 43, 44, 45</td>
<td>向 10.8.0.1 查询通用顶级域名的 IP</td>
</tr>
<tr>
<td>47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59</td>
<td>10.8.0.1 返回通用顶级域名的 IP</td>
</tr>
<tr>
<td>46</td>
<td>向通用顶级域名 DNS server <code>i.gtld-servers.net</code> 查询 <a href="https://www.baidu.com">www.baidu.com</a> 的 IP</td>
</tr>
<tr>
<td>60</td>
<td><code>i.gtld-servers.net</code> DNS返回 <code>baidu.com.</code> 域的 DNS 服务器 <code>ns[12347].baidu.com</code> 的名字</td>
</tr>
<tr>
<td>61, 62, 63, 64, 65, 69</td>
<td>向 192.168.1.1 和 10.8.0.1 查询 <code>ns[12347].baidu.com</code> 的 IP</td>
</tr>
<tr>
<td>66,67,68,71,72,73</td>
<td>192.168.1.1 和 10.8.0.1 返回 <code>ns[12347].baidu.com</code> 的 IP</td>
</tr>
<tr>
<td>70</td>
<td>向 <code>ns2.baidu.com</code> 查询 <code>www.baidu.com</code> 的地址</td>
</tr>
<tr>
<td>74</td>
<td><code>ns2.baidu.com</code> 返回 <code>www.baidu.com</code> 的地址，它是 <code>www.a.shifen.com</code> 地址的别名</td>
</tr>
</tbody>
</table>
<h2 id="参考链接">参考链接</h2>
<ul>
<li><a href="https://www.cnblogs.com/pannengzhi/p/6262076.html">关于DNS,你应该知道这些</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-634110a9992b6264c18b7b4beda6f789">21.4 - 在 Ubuntu 22.04 上搭建 NFS Server</h1>
    
	<h2 id="环境准备">环境准备</h2>
<p>我准备了两台机器</p>
<table>
<thead>
<tr>
<th>name</th>
<th>ip</th>
<th>user</th>
<th>user_id</th>
</tr>
</thead>
<tbody>
<tr>
<td>server</td>
<td>191.168.58.11</td>
<td>vagrant</td>
<td>1000</td>
</tr>
<tr>
<td>client</td>
<td>192.168.58.1</td>
<td>xuyundong</td>
<td>1000</td>
</tr>
</tbody>
</table>
<h2 id="安装组件">安装组件</h2>
<ul>
<li>服务端安装 nfs server</li>
</ul>
<pre tabindex="0"><code>sudo apt update
sudo apt install nfs-kernel-server
</code></pre><ul>
<li>客户端安装 nfs-common</li>
</ul>
<pre tabindex="0"><code>sudo apt update
sudo apt install nfs-common
</code></pre><h2 id="服务端创建目录并导出">服务端创建目录并导出</h2>
<h3 id="在服务端上创建挂载目录并设置权限">在服务端上创建挂载目录，并设置权限</h3>
<pre tabindex="0"><code>sudo mkdir -p /mnt/share
sudo chown vagrant:vagrant /mnt/share
sudo chmod 755 /mnt/share
</code></pre><h3 id="服务端上配置-nfs-export-目录">服务端上配置 nfs export 目录</h3>
<p>修改 <code>/etc/exports</code> 文件, 加入以下内容</p>
<pre tabindex="0"><code>/mnt/share       *(rw,async,no_subtree_check)
</code></pre><p>关于 export 选项的解释</p>
<ul>
<li><code>rw</code>: 客户端具有读和写的权限</li>
<li><code>sync</code>: 强制 nfs 在回复 client 之前将更改写入磁盘，这保证了 nfs server 的可靠性，但也降低了写入速度</li>
<li><code>no_subtree_check</code>: 此选项可防止子树检查，在子树检查过程中，主机必须为每个请求检查文件在导出的树中是否仍然可用。当客户端打开文件时重命名文件时，这可能会导致许多问题。<strong>通常建议禁用子树检查</strong>。</li>
<li><code>no_root_squash</code>: 当客户端以 root 权限写入文件时，nfs server 会将文件 owner 改成普通用户，当此选项开启时，nfs server 不修改 root 写入文件的 woner</li>
</ul>
<p>修改完以后执行以下命令载入配置</p>
<pre tabindex="0"><code>sudo systemctl restart nfs-kernel-server
</code></pre><h2 id="客户端挂载">客户端挂载</h2>
<p>客户端执行以下命令挂载</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 将服务端的 nfs 目录挂载到了客户端的 /home/xuyundong/tmp/nfs_exmaple 中</span>
</span></span><span style="display:flex;"><span>sudo mount 192.168.58.11:/mnt/share /home/xuyundong/tmp/nfs_exmaple
</span></span></code></pre></div><p>修改 <code>/etc/fstab</code> 文件，将以下内容写入可以让 client 在开机启动时自动挂载</p>
<pre tabindex="0"><code>192.168.58.11:/mnt/share   /home/xuyundong/tmp/nfs_exmaple   nfs auto,nofail,noatime,nolock,intr,tcp,actimeo=1800 0 0
</code></pre><h2 id="测试访问">测试访问</h2>
<p>在客户端的目录中，<strong>以 uid=1000 的用户执行</strong></p>
<pre tabindex="0"><code>echo &#34;abc&#34; &gt; test.txt
</code></pre><p>可以看到文件正常写入了。</p>
<p>这是因为 client 的写入的用户的 uid 是 1000, server 中目录的 owner 的 uid 也是 1000, owner 相同就能正常写入。</p>
<h2 id="取消挂载">取消挂载</h2>
<p>客户端执行以下命令可以取消挂载</p>
<pre tabindex="0"><code>sudo umount ~/tmp/nfs_exmaple
</code></pre><h2 id="参考链接">参考链接</h2>
<ul>
<li><a href="https://www.digitalocean.com/community/tutorials/how-to-set-up-an-nfs-mount-on-ubuntu-22-04">How To Set Up an NFS Mount on Ubuntu 22.04</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-dd6083187c74288b0bc340d1a5d75a6f">21.5 - ls Tips</h1>
    
	<h2 id="ls-按照修改时间排序">ls 按照修改时间排序</h2>
<ul>
<li><code>-t</code> 按照修改时间排序</li>
<li><code>-r</code> 逆序排序</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>xuyundong@Macmini:~/Github/blog$ ls -lt content/tips/
</span></span><span style="display:flex;"><span>-rw-rw-r-- <span style="color:#0000cf;font-weight:bold">1</span> xuyundong xuyundong  <span style="color:#0000cf;font-weight:bold">800</span> 8月  <span style="color:#0000cf;font-weight:bold">16</span> 23:13 ls-tips.md.md
</span></span><span style="display:flex;"><span>-rw-rw-r-- <span style="color:#0000cf;font-weight:bold">1</span> xuyundong xuyundong <span style="color:#0000cf;font-weight:bold">2644</span> 8月  <span style="color:#0000cf;font-weight:bold">16</span> 23:05 docker-registry.md
</span></span><span style="display:flex;"><span>-rw-rw-r-- <span style="color:#0000cf;font-weight:bold">1</span> xuyundong xuyundong <span style="color:#0000cf;font-weight:bold">1990</span> 8月  <span style="color:#0000cf;font-weight:bold">11</span> 22:01 stty.md
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>xuyundong@Macmini:~/Github/blog$ ls -lrt content/tips
</span></span><span style="display:flex;"><span>-rw-rw-r-- <span style="color:#0000cf;font-weight:bold">1</span> xuyundong xuyundong <span style="color:#0000cf;font-weight:bold">1990</span> 8月  <span style="color:#0000cf;font-weight:bold">11</span> 22:01 stty.md
</span></span><span style="display:flex;"><span>-rw-rw-r-- <span style="color:#0000cf;font-weight:bold">1</span> xuyundong xuyundong <span style="color:#0000cf;font-weight:bold">2644</span> 8月  <span style="color:#0000cf;font-weight:bold">16</span> 23:05 docker-registry.md
</span></span><span style="display:flex;"><span>-rw-rw-r-- <span style="color:#0000cf;font-weight:bold">1</span> xuyundong xuyundong  <span style="color:#0000cf;font-weight:bold">897</span> 8月  <span style="color:#0000cf;font-weight:bold">16</span> 23:11 ls-tips.md.md
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-d666840fe7c4f359e7566250aad67c80">21.6 - 查看信号的快捷键</h1>
    
	<hr>
<h2 id="tips">Tips</h2>
<p><code>stty</code>命令的作用是 <code>change and print terminal line settings</code>，查看或修改 Linux 终端的配置。</p>
<p>今天遇到的需求是想查一下 <code>Ctrl-C</code> 按键发送的系统信号 ( <a href="https://man7.org/linux/man-pages/man7/signal.7.html">man 7 signal</a> )，搜了一下发现 stty 是最方便的查询命令</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>ø&gt; stty -a
</span></span><span style="display:flex;"><span>speed <span style="color:#0000cf;font-weight:bold">38400</span> baud<span style="color:#000;font-weight:bold">;</span> rows 68<span style="color:#000;font-weight:bold">;</span> columns 128<span style="color:#000;font-weight:bold">;</span> <span style="color:#000">line</span> <span style="color:#ce5c00;font-weight:bold">=</span> 0<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">####################  我们主要关心这两行的内容</span>
</span></span><span style="display:flex;"><span><span style="color:#000">intr</span> <span style="color:#ce5c00;font-weight:bold">=</span> ^C<span style="color:#000;font-weight:bold">;</span> <span style="color:#000">quit</span> <span style="color:#ce5c00;font-weight:bold">=</span> ^<span style="color:#4e9a06">\;</span> <span style="color:#000">erase</span> <span style="color:#ce5c00;font-weight:bold">=</span> ^?<span style="color:#000;font-weight:bold">;</span> <span style="color:#204a87">kill</span> <span style="color:#ce5c00;font-weight:bold">=</span> ^U<span style="color:#000;font-weight:bold">;</span> <span style="color:#000">eof</span> <span style="color:#ce5c00;font-weight:bold">=</span> ^D<span style="color:#000;font-weight:bold">;</span> <span style="color:#000">eol</span> <span style="color:#ce5c00;font-weight:bold">=</span> &lt;undef&gt;<span style="color:#000;font-weight:bold">;</span> <span style="color:#000">eol2</span> <span style="color:#ce5c00;font-weight:bold">=</span> &lt;undef&gt;<span style="color:#000;font-weight:bold">;</span> <span style="color:#000">swtch</span> <span style="color:#ce5c00;font-weight:bold">=</span> &lt;undef&gt;<span style="color:#000;font-weight:bold">;</span> <span style="color:#000">start</span> <span style="color:#ce5c00;font-weight:bold">=</span> ^Q<span style="color:#000;font-weight:bold">;</span> <span style="color:#000">stop</span> <span style="color:#ce5c00;font-weight:bold">=</span> ^S<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">susp</span> <span style="color:#ce5c00;font-weight:bold">=</span> ^Z<span style="color:#000;font-weight:bold">;</span> <span style="color:#000">rprnt</span> <span style="color:#ce5c00;font-weight:bold">=</span> ^R<span style="color:#000;font-weight:bold">;</span> <span style="color:#000">werase</span> <span style="color:#ce5c00;font-weight:bold">=</span> ^W<span style="color:#000;font-weight:bold">;</span> <span style="color:#000">lnext</span> <span style="color:#ce5c00;font-weight:bold">=</span> ^V<span style="color:#000;font-weight:bold">;</span> <span style="color:#000">discard</span> <span style="color:#ce5c00;font-weight:bold">=</span> ^O<span style="color:#000;font-weight:bold">;</span> <span style="color:#000">min</span> <span style="color:#ce5c00;font-weight:bold">=</span> 1<span style="color:#000;font-weight:bold">;</span> <span style="color:#204a87">time</span> <span style="color:#ce5c00;font-weight:bold">=</span> 0<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">####################</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>-parenb -parodd -cmspar cs8 -hupcl -cstopb cread -clocal -crtscts
</span></span><span style="display:flex;"><span>-ignbrk -brkint -ignpar -parmrk -inpck -istrip -inlcr -igncr icrnl -ixon -ixoff -iuclc -ixany -imaxbel -iutf8
</span></span><span style="display:flex;"><span>opost -olcuc -ocrnl onlcr -onocr -onlret -ofill -ofdel nl0 cr0 tab0 bs0 vt0 ff0
</span></span><span style="display:flex;"><span>isig icanon iexten <span style="color:#204a87">echo</span> echoe echok -echonl -noflsh -xcase -tostop -echoprt echoctl echoke -flusho -extproc
</span></span></code></pre></div><p>stty 输出的解释如下:</p>
<ul>
<li><code>^C</code> (<code>ctrl+c</code>) 发送 interrupt 信号</li>
<li><code>^\</code> (<code>ctr+\</code>) 发送 quit 信号</li>
<li><code>^?</code> 清除上一个输入的字符</li>
<li><code>^U</code> 删除当前行</li>
<li><code>^D</code> 输入 EOF 字符(结束当前输入)</li>
<li><code>^S</code> 暂停输出</li>
<li><code>^Q</code> 在暂停输出后，重新开始输出</li>
<li><code>^Z</code> 发送一个 terminal stop 信号</li>
<li><code>^W</code> 删除最近输入的一个单词</li>
</ul>
<pre tabindex="0"><code>while true;do
    date;
    sleep 1
done
</code></pre><ul>
<li>(我用上面的代码测试 <code>^S</code> 和 <code>^Q</code>, 发现不生效)</li>
</ul>
<p>stty 其他输入的含义，请参考 <a href="https://linux.die.net/man/1/stty">man 1 stty</a></p>
<h2 id="参考链接">参考链接</h2>
<ul>
<li><a href="https://unix.stackexchange.com/a/362579/191858">List of terminal generated signals (eg Ctrl-C -&gt; SIGINT)</a></li>
<li><a href="https://linux.die.net/man/1/stty">man 1 stty</a></li>
</ul>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-549a76c189e9345d4226a12a7a7595fd">21.7 - Review 《File Descriptor Transfer over Unix Domain Sockets》</h1>
    
	<blockquote>
<ul>
<li><strong>使用 Unix 域套接字传输文件描述符</strong></li>
<li>原文地址: <a href="https://copyconstruct.medium.com/file-descriptor-transfer-over-unix-domain-sockets-dcbbf5b3b6ec">https://copyconstruct.medium.com/file-descriptor-transfer-over-unix-domain-sockets-dcbbf5b3b6ec</a></li>
</ul>
</blockquote>
<hr>
<blockquote>
<p><strong>12/31/2020 更新</strong></p>
<p>如果你使用的是较新的内核（Linux 5.6以上），随着一个新的系统调用 <code>pidfd_getfd</code> 的引入，这种复杂性大部分已经被消除了。更多细节请参考 2020年 12-31 发表的文章<a href="https://copyconstruct.medium.com/seamless-file-descriptor-transfer-between-processes-with-pidfd-and-pidfd-getfd-816afcd19ed4">《用 pidfd 和 pidfd_getfd 在进程间无缝传输文件描述符》</a>。</p>
</blockquote>
<p>昨天，我读了一篇惊人的论文，介绍了使用不同协议而且服务许多不同类型请求（长寿的TCP/UDP会话，涉及大块数据的请求等）的服务在Facebook是如何免中断发布的。</p>
<p>Facebook 使用的一种它们叫做 <code>Socket Takeover</code> 的技术。</p>
<p><code>Socket Takeover</code> 实现了 Proxygen 的零停机重启，它以并行方式启动了一个更新的实例，接管了监听的套接字，当旧的实例进入了优雅关闭阶段。新实例负责为新连接提供服务，并响应来自 L4LB Katran 的健康检查探针。老的连接由老的实例提供服务，直到完全关闭，之后其他机制（例如下游连接重用）开始发挥作用。</p>
<p>当我们把一个打开的FD从旧的进程传递给新的进程时，传递和接收的进程都共享监听套接字的同一个文件表项，并各自独立地处理接收的连接，在这些连接上提供连接级事务。我们利用了以下Linux内核的特性来实现这一点。</p>
<p><strong>CMSG</strong>：<code>sendmsg()</code> 的一个功能允许在本地进程之间发送控制信息（通常被称为辅助数据）。在 Level7 LB 进程的重启过程中，我们使用这一机制将所有 VIP ( Virtual IP of service) 的活动的监听套接字的 FD 集合从活动的实例发送至新启动的实例。这些数据是通过 <code>sendmsg</code> 和 <code>recvmsg</code> 在 UNIX 域套接字上交换的。</p>
<p><strong>SCM_RIGHTS</strong>: 我们设置这个选项来发送打开的文件描述符，其数据部分包含一个打开的FD的整数数组。在接收方，这些 文件描述符的行为就像它们是用 <code>dup(2)</code> 创建的一样。</p>
<p>我在 Twitter 上收到了一些人的回复，他们对这竟然是可能的表示惊讶。事实上，如果你对Unix域套接字的一些特性不是很熟悉，那么论文中的上述段落可能就很难理解了。</p>
<p>实际上，在 Unix 域套接字上传输 TCP 套接字是一种久经考验的方法，来实现 <strong>热重启</strong> 或 <strong>零停机时间重启</strong> 。流行的代理，如 HAProxy 和 Envoy ，使用非常类似的机制，将连接从代理的一个实例引流到另一个实例，而不丢弃任何连接。然而，许多类似的功能却并不广为人知。</p>
<p>在这篇文章中，我想探讨 Unix 域套接字的一些特性，这些特性使它成为这些场景下的合适候选者，特别是将套接字（或任何文件描述符）从一个进程转移到另一个进程，在这两个进程之间不一定存在父子关系。</p>
<h2 id="unix-域套接字">Unix 域套接字</h2>
<p>众所周知，Unix 域套接字允许同一主机系统上的进程之间进行通信。Unix域套接字在许多流行的系统中都有使用。HAProxy、Envoy、AWS的 Firecracker 虚拟机监视器、Kubernetes、Docker和 Istio 等等。</p>
<h3 id="一个简短的教程">一个简短的教程</h3>
<p>就像网络套接字一样，Unix 域套接字也支持流和数据报文类型。然而，与采用 IP 和端口作为地址的网络套接字不同，Unix域套接字使用路径名作为地址。与网络套接字不同，Unix域套接字的 I/O 不涉及对底层设备的操作（这使得Unix域套接字与网络套接字相比，在同一主机上执行IPC要快很多）。</p>
<p>用 <code>bind(2)</code> 将一个名字绑定到一个Unix域套接字，在文件系统中创建一个名为 <code>pathname</code> 的套接字文件。然而，这个文件与你可能创建的任何普通文件不同。</p>
<p>一个简单的Go程序在 Unix 域套接字上创建一个监听的 &ldquo;Echo 服务器&rdquo;，如下所示:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;io&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;net&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;syscall&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">addr</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;/tmp/uds.sock&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">syscall</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Unlink</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">addr</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">l</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">net</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Listen</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;unix&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">addr</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">l</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Close</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">c</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">l</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Accept</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#000">net</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Conn</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">io</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Copy</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Close</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}(</span><span style="color:#000">c</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>如果你建立并运行这个程序，可以观察到几个有趣的事实。</p>
<h3 id="socket-文件--普通文件">Socket 文件 != 普通文件</h3>
<p>首先，套接字文件 <code>/tmp/uds.sock</code> 被标记为一个套接字。当使用 <code>stat()</code> 调用查看这个路径名时，它在stat结构的<code>st_mode</code>字段的文件类型部分返回值 <code>S_IFSOCK</code> 。</p>
<p>当用<code>ls -l</code>查看时，UNIX 域套接字在第一列显示为s类型，而 <code>ls -F</code> 在套接字路径名上附加一个等号（=）。</p>
<pre tabindex="0"><code>root@1fd53621847b:~/uds# ./uds
^C
root@1fd53621847b:~/uds# ls -ls /tmp
total 0
0 srwxr-xr-x 1 root root 0 Aug  5 01:45 uds.sock
root@1fd53621847b:~/uds# stat /tmp/uds.sock
File: /tmp/uds.sock
Size: 0          Blocks: 0          IO Block: 4096   socket
Device: 71h/113d Inode: 1835567     Links: 1
Access: (0755/srwxr-xr-x)  Uid: (    0/    root)   Gid: (    0/    root)
Access: 2020-08-05 01:45:41.650709000 +0000
Modify: 2020-08-05 01:45:41.650709000 +0000
Change: 2020-08-05 01:45:41.650709000 +0000

Birth: -

root@5247072fc542:~/uds# ls -F /tmp
uds.sock=
root@5247072fc542:~/uds#
</code></pre><p>对文件起作用的普通系统调用在套接字文件上不起作用：这意味着像 <code>open()</code> 、<code>close()</code> 、<code>read()</code> 这样的系统调用不能用于套接字文件。相反，像 <code>socket()</code> 、<code>bind()</code> 、<code>recv()</code> 、<code>sendmsg()</code> 、<code>recvmsg()</code> 等套接字相关的系统调用可以在 Unix域套接字上工作。</p>
<p>另一个关于套接字的有趣事实是，它不是在套接字被关闭的时候删除，而是通过系统调用来删除</p>
<ul>
<li>在 MacOS 上调用 <code>unlink(2)</code></li>
<li>在 Linux 上调用 <code>remove()</code> 或使用地更普遍的 <code>unlink(2)</code></li>
</ul>
<p>在 Linux 上，Unix 域套接字的地址通过如下的结构来表示:</p>
<pre tabindex="0"><code>struct sockaddr_un {
      sa_family_t sun_family; /* Always AF_UNIX */
      char sun_path[108]; /* Pathname */
};
</code></pre><p>在 MacOS 上，地址通过如下的结构表示:</p>
<pre tabindex="0"><code>struct sockaddr_un {
     u_char  sun_len;
     u_char  sun_family;
     char    sun_path[104];
};
</code></pre><h3 id="使用-bind2-绑定一个已经存在的路径将会失败">使用 bind(2) 绑定一个已经存在的路径将会失败</h3>
<p><code>SO_REUSEPORT</code> 选项允许任何指定主机上的多个网络套接字连接到同一地址和端口。第一个试图绑定给定端口的套接字需要设置 <code>SO_REUSEPORT</code> 选项，任何后续的套接字都可以绑定到同一端口。</p>
<p>对 <code>SO_REUSEPORT</code> 的支持是在 Linux 3.9及以上版本中引入的。然而，在 Linux 上，所有想共享同一地址和端口组合的套接字必须属于共享同一有效UID的进程。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">fd</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">socket</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">domain</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">socktype</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">optval</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">setsockopt</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">sfd</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SOL_SOCKET</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">SO_REUSEPORT</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">optval</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">optval</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span><span style="color:#000">bind</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">sfd</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">sockaddr</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">addr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">addrlen</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>然而，两个 Unix 域套接字无法绑定相同的路径。</p>
<h2 id="socketpair">SOCKETPAIR</h2>
<p><code>socketpair()</code> 函数创建了两个套接字，然后将其连接在一起。从某种程度上说，这与 <strong>管道</strong> 非常相似，只是它支持数据的双向传输。</p>
<p><code>socketpair</code> 只对 Unix 域套接字起作用。它返回两个已经连接在一起的文件描述符（所以我们不必在开始传输数据之前
, 执行 <code>socket</code> -&gt; <code>bind</code> -&gt; <code>listen</code> -&gt; <code>accept</code>的流程来建立一个监听套接字。也不必在开始传输数据之前，执行 <code>socket</code> -&gt; <code>connect</code> 的流程创建一个连接到监听套接字的客户端）。</p>
<h2 id="在-unux-域套接字上传输数据">在 Unux 域套接字上传输数据</h2>
<p>现在我们已经确定 Unix 域套接字允许同一主机上的两个进程进行通信，现在是时候探索什么样的数据可以通过 Unix 域套接字传输。</p>
<p>由于Unix域套接字在许多方面与网络套接字相似，任何通常可以通过网络套接字发送的数据都可以通过Unix域套接字发送。</p>
<p>此外，特殊的系统调用 <code>sendmsg</code> 和 <code>recvmsg</code> 允许在Unix域套接字上发送一个特殊的消息。这个消息由内核特别处理，它允许从发送者向接收者传递打开的 <strong>File Descriptions</strong>。</p>
<h3 id="file-descriptors文件描述符-vs-file-description-文件描述">File Descriptors(文件描述符) VS File Description (文件描述)</h3>
<p>注意上一段我使用了术语 文件描述(<code>File descripTION</code>)，而不是文件描述符 (<strong>file descripTOR</strong>)。它们两者的区别是微妙的而且往往不被人理解。</p>
<p>文件描述符实际上只是一个进程内(不可跨进程使用)指向底层内核数据结构的指针，该结构被称为文件描述（<strong>File Description</strong>）。内核维护着一个所有打开的文件描述的表格，称为打开文件表(<strong>open file table</strong>)。如果两个进程（A和B）试图打开同一个文件，这两个进程可能有自己独立的文件描述符，它们指向开放文件表中的同一个文件描述。</p>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com//2021-11-30-142542.png" alt="img"></p>
<p>所以，在 Unix 域套接字上使用 <code>sendmsg</code> 发送文件描述符实际上意味着发送 <strong>文件描述</strong> 的引用。如果进程 A 向 进程 B 发送文件描述符 0 (fd0)，该文件描述符在进程 B 中很可能被数字3(fd3) 所引用。</p>
<p>发送进程在 Unix 域套接字上调用 <code>sendmsg</code> 发送文件描述符，接收进程在 Unix 域套接字上调用 <code>recvmsg</code> 来接受文件描述符。</p>
<p>发送进程通过 <code>sendmsg</code> 发送文件描述给接收进程，接收进程通过 <code>recvmsg</code> 接收该文件描述。即使发送进程在发送完成后关闭了该文件描述所对应的文件描述符，而接收进程还未调用 <code>recvmsg</code> 接收它，该文件描述依然对接收进程保持打开状态。</p>
<p><strong>发送文件描述符时，文件描述的引用次数会+1,直到文件描述的引用次数下降到0, 内核才会将文件描述从 <code>打开文件表(open file table)</code> 中删除该文件描述。</strong></p>
<p>即使发送进程在接收进程调用 recvmsg 之前关闭了引用通过 sendmsg 传递的文件描述的文件描述符，该文件描述符仍然对接收进程开放。发送描述符时，描述符的引用次数会增加1。内核只有在引用计数下降到0时才会从其开放文件表中删除文件描述。</p>
<h3 id="sendmsg-和-recvmsg">sendmsg 和 recvmsg</h3>
<p>在 Linux 中 <code>sendmsg</code> 函数的签名如下:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">ssize_t</span> <span style="color:#000">sendmsg</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">socket</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">msghdr</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">message</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">flags</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>与 <code>sendmsg</code> 对应的是 <code>recvmsg</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">ssize_t</span> <span style="color:#000">recvmsg</span><span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>     <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">sockfd</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>     <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">msghdr</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">msg</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>     <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">flags</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>人们可以用 <code>sendmsg</code> 在 Unix 域套接字上传输的特殊消息是由 <code>msghdr</code> 指定的。希望将文件描述发送给另一个进程的进程创建一个 <code>msghdr</code> 结构，其中包含要传递的描述。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">msghdr</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">void</span>            <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">msg_name</span><span style="color:#000;font-weight:bold">;</span>      <span style="color:#8f5902;font-style:italic">/* optional address */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">socklen_t</span>       <span style="color:#000">msg_namelen</span><span style="color:#000;font-weight:bold">;</span>    <span style="color:#8f5902;font-style:italic">/* size of address */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span>          <span style="color:#000">iovec</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">msg_iov</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">/* scatter/gather array */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span>             <span style="color:#000">msg_iovlen</span><span style="color:#000;font-weight:bold">;</span>     <span style="color:#8f5902;font-style:italic">/* # elements in msg_iov */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">void</span>            <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">msg_control</span><span style="color:#000;font-weight:bold">;</span>   <span style="color:#8f5902;font-style:italic">/* ancillary data, see below */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">socklen_t</span>       <span style="color:#000">msg_controllen</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">/* ancillary data buffer len */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span>             <span style="color:#000">msg_flags</span><span style="color:#000;font-weight:bold">;</span>      <span style="color:#8f5902;font-style:italic">/* flags on received message */</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">};</span>
</span></span></code></pre></div><p><code>msghdr</code> 结构的 <code>msg_control</code> 成员，其长度为 <code>msg_controllen</code> ，指向一个如下形式的消息缓冲区:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">cmsghdr</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">socklen_t</span> <span style="color:#000">cmsg_len</span><span style="color:#000;font-weight:bold">;</span>    <span style="color:#8f5902;font-style:italic">/* data byte count, including header */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span>       <span style="color:#000">cmsg_level</span><span style="color:#000;font-weight:bold">;</span>  <span style="color:#8f5902;font-style:italic">/* originating protocol */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span>       <span style="color:#000">cmsg_type</span><span style="color:#000;font-weight:bold">;</span>   <span style="color:#8f5902;font-style:italic">/* protocol-specific type */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">/* followed by */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#000">cmsg_data</span><span style="color:#000;font-weight:bold">[];</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">};</span>
</span></span></code></pre></div><p>在 POSIX 中，带有附加数据的 <code>cmsghdr</code> 结构的缓冲区被称为辅助数据(ancillary data)。在 Linux 上，每个套接字允许的最大缓冲区大小可以通过修改 <code>/proc/sys/net/core/optmem_max</code> 来设置。</p>
<h2 id="辅助数据传输">辅助数据传输</h2>
<p>虽然这种数据传输有大量的陷阱，但如果使用得当，它可以成为一个相当强大的机制来实现一些目标。</p>
<p>在Linux上，有三种类型的辅助数据可以在两个Unix域套接字之间共享。</p>
<ul>
<li><code>SCM_RIGHTS</code></li>
<li><code>SCM_CREDENTIALS</code></li>
<li><code>SCM_SECURITY</code></li>
</ul>
<p>这三种类型的辅助数组仅应该通过下面的宏定义来访问，而不应该直接使用</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">cmsghdr</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">CMSG_FIRSTHDR</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">msghdr</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">msgh</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">cmsghdr</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">CMSG_NXTHDR</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">msghdr</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">msgh</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">cmsghdr</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">cmsg</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">size_t</span> <span style="color:#000">CMSG_ALIGN</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">size_t</span> <span style="color:#000">length</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">size_t</span> <span style="color:#000">CMSG_SPACE</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">size_t</span> <span style="color:#000">length</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">size_t</span> <span style="color:#000">CMSG_LEN</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">size_t</span> <span style="color:#000">length</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">CMSG_DATA</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">cmsghdr</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">cmsg</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>我从来没有使用后两者的需要，<code>SCM_RIGHTS</code> 是我希望在这篇文章中进一步探讨的。</p>
<h3 id="scm_rights">SCM_RIGHTS</h3>
<p><code>SCM_RIGHTS</code> 允许进程使用 <code>sendmsg/recvmsg</code> 从另一个进程发送/接收一组打开的文件描述符。</p>
<p><code>cmsghdr</code> 结构体的成员 <code>cmsg_data</code> 可以包含一个进程想要发送的文件描述符的数组。</p>
<pre tabindex="0"><code>struct cmsghdr {
    socklen_t cmsg_len;    /* data byte count, including header */
    int       cmsg_level;  /* originating protocol */
    int       cmsg_type;   /* protocol-specific type */
    /* followed by */
    unsigned char cmsg_data[];
};
</code></pre><p>接收进程使用 <code>recvmsg</code> 接收数据。</p>
<p>《Linux Programming Interface》有一个使用 <code>sendmsg</code> 和 <code>recvmsg</code> 函数的<a href="https://man7.org/tlpi/code/online/dist/sockets/scm_rights_send.c.html">良好示例</a>。</p>
<h2 id="scm_rights-的陷阱">SCM_RIGHTS 的陷阱</h2>
<p>正如上文所讲，使用 Unix 域套接字传输辅助数据有很多的陷阱。</p>
<blockquote>
<p><strong>Need to send some “real” data along with the ancillary message</strong></p>
<p>需要在发送辅助数据的同时发送一些真实的数据</p>
</blockquote>
<p>在 Linux 上，如果想要成功地在 <strong>流式(stream)</strong> Unix 域套接字上发送辅助数据，至少要发送一个字节的真实数据。</p>
<p>然而，如果想要在 <strong>数据报式(datagram)</strong> 的 Unix 域套接字上发送辅助数据，不需要发送任何附带的真实数据。也就是说，在通过数据报套接字发送辅助数据时，便携式应用程序还应该包括至少一个字节的真实数据。</p>
<blockquote>
<p>File Descriptors can be dropped</p>
<p>文件描述符可以被丢弃</p>
</blockquote>
<p>如果用于接收包含文件描述符的辅助数据的缓冲区 <code>cmsg_data</code> 太小（或没有），那么辅助数据被截断（或丢弃），多余的文件描述符在接收进程中被自动关闭。</p>
<p>如果在辅助数据中收到的文件描述符的数量导致进程超过其 <code>RLIMIT_NOFILE</code> 资源限制，则多余的文件描述符将在接收进程中自动关闭。不能在多个 <code>recvmsg</code> 调用中分割列表。</p>
<blockquote>
<p>recvmsg quirks</p>
<p>recvmsg 的怪异情况</p>
</blockquote>
<p><code>sendmsg</code> 和 <code>recvmsg</code> 的作用类似于 <code>send</code> 和 <code>recv</code> 系统调用，在每个 <code>send</code> 调用和每个 <code>recv</code> 调用之间没有1：1的映射。</p>
<p>一个 <code>recvmsg</code> 调用可以从多个 <code>sendmsg</code> 调用中读取数据。同样地，它可能需要多个<code>recvmsg</code>调用来消耗一个<code>sendmsg</code> 调用所发送的数据。这有严重的、令人惊讶的影响，其中一些已经在这里报告。</p>
<blockquote>
<p>Limit on the number of File Descriptions</p>
<p>文件描述符的数量限制</p>
</blockquote>
<p>内核常量 <code>SCM_MAX_FD</code> ( 253 (或者在2.6.38之前的内核中为255))定义了数组中文件描述符的数量限制。</p>
<p>试图发送一个大于这个限制的数组会导致 <code>sendmsg</code> 失败，错误是 <code>EINVAL</code>。</p>
<h2 id="什么时候发送文件描述符是有用的">什么时候发送文件描述符是有用的</h2>
<p>一个非常具体的现实世界的使用案例是零停机时间的代理重载。</p>
<p>任何曾经使用过HAProxy的人都可以证明，&ldquo;零停机时间的配置重载 &ldquo;在很长一段时间内并不是一个真正的东西。通常，大量的<a href="https://engineeringblog.yelp.com/2015/04/true-zero-downtime-haproxy-reloads.html">Rube Goldberg-esque</a> Hack 被用来实现这一目标。</p>
<p>在2017年底，HAProxy 1.8 支持无中断重载，通过将监听套接字文件描述符从旧的 HAProxy 进程转移到新的进程中来实现。Envoy使用 <a href="https://blog.envoyproxy.io/envoy-hot-restart-1d16b14555b5">类似的机制</a> 进行热重启，文件描述符通过Unix域套接字传递。</p>
<p>2018年底，Cloudflare 在<a href="https://blog.cloudflare.com/know-your-scm_rights/">博客</a> 中介绍了其使用的将文件描述符从nginx转移到Go TLS 1.3代理。</p>
<p>促使我写下这篇博文的关于Facebook如何实现零停机发布的论文，使用了与 <code>CMSG + SCM_RIGHTS</code> 相同的技巧，将活的文件描述符从将要结束的进程传递到新发布的进程。</p>
<h2 id="总结">总结</h2>
<p>如果使用得当，通过Unix域套接字传输文件描述符可以被证明是非常强大的。我希望这篇文章能让你对Unix域套接字和它的功能有一个更好的理解。</p>
<h2 id="references">References:</h2>
<ul>
<li><a href="https://www.man7.org/linux/man-pages/man7/unix.7.html">https://www.man7.org/linux/man-pages/man7/unix.7.html</a></li>
<li><a href="https://blog.cloudflare.com/know-your-scm_rights/">https://blog.cloudflare.com/know-your-scm_rights/</a></li>
<li>LWN.net has an interesting article on creating cycles when passing file descriptions over a Unix domain socket and implications for the fabulous new io_uring kernel API. <a href="https://lwn.net/Articles/779472/">https://lwn.net/Articles/779472/</a></li>
<li>The Linux Programming Interface <a href="https://learning.oreilly.com/library/view/the-linux-programming/9781593272203/">https://learning.oreilly.com/library/view/the-linux-programming/9781593272203/</a></li>
<li>UNIX Network Programming: The Sockets Networking API <a href="https://learning.oreilly.com/library/view/the-sockets-networking/0131411551/">https://learning.oreilly.com/library/view/the-sockets-networking/0131411551/</a></li>
</ul>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-50e13d0c712358d46277160b2eed624c">21.8 - Glob 语法解析</h1>
    
	<p>Glob 语法</p>
<hr>
<h2 id="tips">Tips</h2>
<table>
<thead>
<tr>
<th>通配符</th>
<th>描述</th>
<th>例子</th>
<th>匹配</th>
<th>不匹配</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>*</code></td>
<td>匹配任意数量的任何字符，包括无</td>
<td><code>Law*</code></td>
<td>Law, Laws, Lawyer</td>
<td>GrokLaw, La, aw</td>
</tr>
<tr>
<td>?</td>
<td>匹配任何 单个 字符</td>
<td>?at</td>
<td>Cat, cat, Bat, bat</td>
<td>at</td>
</tr>
<tr>
<td>[abc]</td>
<td>匹配括号中给出的一个字符</td>
<td>[CB]at</td>
<td>Cat, Bat</td>
<td>cat, bat</td>
</tr>
<tr>
<td>[a-z]</td>
<td>匹配括号中给出的范围中的一个字符</td>
<td>Letter[0-9]</td>
<td>Letter0, Letter1 … Letter9</td>
<td>Letters, Letter, Letter10</td>
</tr>
<tr>
<td>[!abc]</td>
<td>匹配括号中未给出的一个字符</td>
<td>[!C]at</td>
<td>Bat, bat, cat</td>
<td>Cat</td>
</tr>
<tr>
<td>[!a-z]</td>
<td>匹配不在括号内给定范围内的一个字符</td>
<td>Letter[!3-5]</td>
<td>Letter1…</td>
<td>Letter3 … Letter5, Letterxx</td>
</tr>
</tbody>
</table>
<ul>
<li>Gitignore</li>
</ul>
<p>git 的 .gitignore 文件可以使用 glob 模式匹配， 另外还有一些规则：</p>
<p>所有空行或者以 # 开头的行都会被 Git 忽略
匹配模式可以以 / 开头防止递归
匹配模式可以以 / 结尾指定目录
要忽略指定模式以外的文件或目录，可以在模式前加上惊叹号 ! 取反</p>
<ul>
<li>Python</li>
</ul>
<p>Python 有进行 glob 匹配的标准库， 使用也很简单：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># -*- coding: utf-8 -*-</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">glob</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># glob 只有两个函数， 功能差不多， 只不过一个返回列表， 一个返回迭代器</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">glob</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">glob</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;*.org&#39;</span><span style="color:#000;font-weight:bold">)</span>  <span style="color:#8f5902;font-style:italic"># 返回所有后缀名为 .org 的文件</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">glob</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">iglob</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;*/&#39;</span><span style="color:#000;font-weight:bold">)</span>  <span style="color:#8f5902;font-style:italic"># 返回匹配所有目录的迭代器</span>
</span></span></code></pre></div><h2 id="参考链接">参考链接</h2>
<ul>
<li><a href="https://rgb-24bit.github.io/blog/2018/glob.html">Glob 语法及解析</a></li>
</ul>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-efaf8b11c2c533130e7721f968b66120">21.9 - 词法分析器生成工具 Lex 简介</h1>
    
	<blockquote>
<p>结合例子简单介绍了Lex 程序和 Lex 工具的用法</p>
</blockquote>
<hr>
<h2 id="lex-说明">Lex 说明</h2>
<p>Lex 是一个词法分析器的生成工具，它支持使用正则表达式来描述各个词法单元的模式，由此给出一个词法分析器的规约，并生成相应的实现代码。
Lex 程序的输入方法称为 Lex 语言，而 Lex 程序本身被称为 Lex 编译器，Flex 是 Lex 编译器的一种替代实现( lex，flex 的关系和 cc，gcc 的关系很相似)。</p>
<p>在本文中，我们将会介绍 Lex 语言，并书写一个简单的 Lex 程序，进行词法分析，并输出分析结果。</p>
<h2 id="lex-程序的使用">Lex 程序的使用</h2>
<p>Lex 程序的使用方法如下图所示:</p>
<p><img src="https://passage-1253400711.cos-website.ap-beijing.myqcloud.com/2019-12-15-101534.jpg" alt=""></p>
<ol>
<li>通过 lex 语言写一个 lex 源程序 lex.l</li>
<li>使用 Lex 编译器 flex 将 lex.l 编译成 C 代码, lex.yy.c</li>
<li>通过 C 编译器 cc 将 lex.yy.c 编译成可执行程序</li>
<li>运行可执行程序，输入源程序，输出词法单元序列</li>
</ol>
<h2 id="lex-程序的结构">Lex 程序的结构</h2>
<p>一个 Lex 程序通常具有如下形式:</p>
<pre tabindex="0"><code>声明部分
%%
转换规则
%%
辅助函数
</code></pre><h3 id="声明部分">声明部分</h3>
<p>声明部分通常包括<code>变量</code>，<code>明示常量</code>和正则表达式的定义，<code>明示常量</code>是一个值为数字的标识符，用来表示词法单元的类型。</p>
<h3 id="转换规则">转换规则</h3>
<p>转换规则具有如下的形式: <code>模式 { 动作 }</code>。每个模式是一个正则表达式，可以使用声明部分给出的正则定义。动作部分是代码片段，通常用 C 语言编写。</p>
<h3 id="辅助函数">辅助函数</h3>
<p>这个部分中定义了各个动作所需要的函数，也可以包含 main 函数，这部分的代码将会放到输出的 C 代码中。</p>
<h2 id="lex-程序的工作方式">Lex 程序的工作方式</h2>
<p>Lex 程序提供了一个函数<code>int yylex()</code>和两个变量<code>yyleng</code>，<code>yytext</code>供外部(通常是语法分析器)读取，调用。</p>
<p>当调用<code>yylex</code>的时候，程序会从<code>yyin</code>指针所指向的输入流中逐个读入字符，程序发现了最长的与某个模式 $P_i$ 匹配的字符串后，会将该字符串存入到<code>yytext</code>变量中，并设置<code>yyleng</code>变量为该字符串的长度，该字符串也就是词法分析程序分析出来的一个词法单元。</p>
<p>然后，词法分析程序会执行模式 $P_i$ 对应的动作 $A_i$，并使用<code>yylex</code>函数返回 $A_i$ 的返回值(通常是词法单元的类型)。</p>
<h2 id="词法分析的例子">词法分析的例子</h2>
<p>在下面的例子中，我们将会编写 Lex 程序，并生成生成一个词法分析器，分析 <code>test1.p</code> 程序，输出其词法单元和类型。</p>
<ul>
<li>test1.p</li>
</ul>
<pre tabindex="0"><code>while a &gt;= -1.2E-2
do b&lt;=2
</code></pre><h3 id="声明部分-1">声明部分</h3>
<p>首先定义的是声明部分，其中包含词法单元的类型，和一些正则表达式的定义</p>
<pre tabindex="0"><code class="language-lex" data-lang="lex">/* 明示常量的定义 */
#define IF 1
#define THEN 2
#define ELSE 3
#define ID 4
#define NUMBER 5
#define RELOP 6
#define DO 7
#define WHILE 8

%}

/* 正则表达式的定义 */
delim       [ \t\n]
ws          {delim}+
letter      [A-Za-z]
digit       [0-9]
id          {letter}({letter}|{digit})*
number      [+-]?{digit}+(\.{digit}+)?(E[+-]?{digit}+)?
</code></pre><p>需要注意的是，正则表达式中使用大括号包裹起来的内容表示嵌入另外一个正则表达式，例如<code>ws</code>的定义<code>{delim}+</code>就表示将之前定义的正则表达式<code>delim</code>嵌入进来。</p>
<h3 id="转换部分">转换部分</h3>
<p>然后是转换部分，定义如下:</p>
<pre tabindex="0"><code class="language-lex" data-lang="lex">{ws}        {  }
if          { return(IF); }
then        { return(THEN); }
while       { return(WHILE); }
do          { return(DO); }
else        { return(ELSE); }
{id}        { return(ID); }
{number}    { return(NUMBER); }
&#34;&lt;&#34;         { return(RELOP); }
&#34;&lt;=&#34;        { return(RELOP); }
&#34;&lt;&gt;&#34;        { return(RELOP); }
&#34;&gt;&#34;         { return(RELOP); }
&#34;&gt;=&#34;        { return(RELOP); }
&#34;=&#34;         { return(RELOP); }
</code></pre><p>这里的规则对应的动作都很简单，直接返回词法单元对应的类型。</p>
<h3 id="辅助函数-1">辅助函数</h3>
<p>最后是辅助函数部分，由于我们想输出一个可执行文件，所以这里会写一个 main 函数</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">writeout</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">switch</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span><span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">case</span> <span style="color:#f57900">RELOP</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">yyout</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;(RELOP, </span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">%s</span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">)</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">yytext</span><span style="color:#000;font-weight:bold">);</span><span style="color:#204a87;font-weight:bold">break</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">case</span> <span style="color:#f57900">WHILE</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">yyout</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;(WHILE, </span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">%s</span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">)</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">yytext</span><span style="color:#000;font-weight:bold">);</span><span style="color:#204a87;font-weight:bold">break</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">case</span> <span style="color:#f57900">DO</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">yyout</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;(DO, </span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">%s</span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">)</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">yytext</span><span style="color:#000;font-weight:bold">);</span><span style="color:#204a87;font-weight:bold">break</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">case</span> <span style="color:#f57900">NUMBER</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">yyout</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;(NUM, </span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">%s</span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">)</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">yytext</span><span style="color:#000;font-weight:bold">);</span><span style="color:#204a87;font-weight:bold">break</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">case</span> <span style="color:#f57900">ID</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">yyout</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;(ID, </span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">%s</span><span style="color:#4e9a06">\&#34;</span><span style="color:#4e9a06">)</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">yytext</span><span style="color:#000;font-weight:bold">);</span><span style="color:#204a87;font-weight:bold">break</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">default</span><span style="color:#ce5c00;font-weight:bold">:</span><span style="color:#204a87;font-weight:bold">break</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">main</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">argc</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">**</span> <span style="color:#000">argv</span><span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">argc</span><span style="color:#ce5c00;font-weight:bold">&gt;=</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">((</span><span style="color:#000">yyin</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">fopen</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">argv</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#4e9a06">&#34;r&#34;</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87">NULL</span><span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Can&#39;t open file %s</span><span style="color:#4e9a06">\n</span><span style="color:#4e9a06">&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">argv</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">argc</span><span style="color:#ce5c00;font-weight:bold">&gt;=</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">yyout</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">fopen</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">argv</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#4e9a06">&#34;w&#34;</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">/* yyin和yyout是lex中定义的输入输出文件指针，它们指明了
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * lex生成的词法分析器从哪里获得输入和输出到哪里。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     * 默认：stdin，stdout。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">while</span> <span style="color:#000;font-weight:bold">((</span><span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">yylex</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">writeout</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">argc</span><span style="color:#ce5c00;font-weight:bold">&gt;=</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">){</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fclose</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">yyin</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">argc</span><span style="color:#ce5c00;font-weight:bold">&gt;=</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">fclose</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">yyout</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>我们在 main 函数中调用<code>yylex</code>函数获取到一个词法单元，然后调用<code>writeout</code>函数，将这个词法单元及其类型，输出到<code>stdout</code>中。</p>
<h3 id="程序的编译执行">程序的编译执行</h3>
<p>将上述程序写入到 lex.l 中，在 Mac 系统上，执行以下命令:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>// flex 可以通过 brew install flex 安装
</span></span><span style="display:flex;"><span>flex lex.l
</span></span><span style="display:flex;"><span>cc lex.yy.c -o lex -ll
</span></span></code></pre></div><p>上述程序会生成可执行文件<code>lex</code>，然后我们执行 <code>./lex test1.p</code>，就可以看到程序输出了词法单元及其类型。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>&gt;&gt;&gt; ./lex test1.p
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span>WHILE, <span style="color:#4e9a06">&#34;while&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span>ID, <span style="color:#4e9a06">&#34;a&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span>RELOP, <span style="color:#4e9a06">&#34;&gt;=&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span>NUM, <span style="color:#4e9a06">&#34;-1.2E-2&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span>DO, <span style="color:#4e9a06">&#34;do&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span>ID, <span style="color:#4e9a06">&#34;b&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span>RELOP, <span style="color:#4e9a06">&#34;&lt;=&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span>NUM, <span style="color:#4e9a06">&#34;2&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span></code></pre></div><p>上述例子的完整代码可以在 <a href="https://github.com/bwangelme/simple_calc/tree/896cc28/lex_tutorial">Github@896cc28</a> 中找到。</p>
<h2 id="lex-中的冲突解决">Lex 中的冲突解决</h2>
<p>在 Lex 编译器解析输入流时，针对同一个字符串可能会有多种解析模式，例如上述例子中，<code>&lt;=</code>可以解析成<code>(RELOP, &quot;&lt;&quot;)</code>, <code>(RELOP, &quot;=&quot;)</code>，也可以解析成<code>(RELOP, &quot;&lt;=&quot;)</code>。当遇到这种冲突情况时，Lex 编译器遵循以下的规则:</p>
<ol>
<li>总是选择最长的前缀进行匹配</li>
<li>如果最长的可能前缀与多个模式匹配，总是选择在 Lex 程序中先被列出的模式。</li>
</ol>
<p>根据第二点可得，在上述例子中，<code>{id}</code>需要定义在<code>if</code>, <code>then</code>等关键字的后面，否则这些关键字就会被解析成 ID 了。</p>
<h2 id="参考资料">参考资料</h2>
<ul>
<li><a href="https://book.douban.com/subject/3296317/">编译原理 3.5 节</a></li>
</ul>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-25c9fa87749c3a8b80df79ec7693c21d">21.10 - 【流水账】利用闲置笔记本搭建自己的开发服务器</h1>
    
	<ol>
<li>对Ubuntu服务器进行基础配置</li>
<li>配置dnsmasq服务器</li>
<li>文章没什么技术含量，主要记录一些配置文件的位置</li>
</ol>
<h2 id="前言">前言</h2>
<p>最近新入手了一台MacBook Air，原来的ThinkPad就闲置下来了，感觉一直放着太浪费了，就重装了一个Ubuntu Server 16.04的系统，用来做自己的开发服务器。折腾了几个小时，就都搞定了，特意写下这篇文章，来记录一下自己折腾的过程。</p>
<h2 id="基础配置">基础配置</h2>
<p>服务器安装的过程就不说了，大都是那么几步。有一个奇怪的问题就是安装的时候，需要设置时区，我竟然没有找到东八区，只好先设置了一个太平洋时区，好尴尬，不知道是不是Ubuntu的文本安装界面没有东八区这个选项，还是我英文太差了，没有找到。</p>
<h3 id="设置时间">设置时间</h3>
<p>由于安装时我们设置了错误的时区，所以首先需要调整一下时区。Ubuntu 16.04已经完全集成了Systemd，所以我们只需要通过<code>sudo timedatectl set-timezone Asia/Shanghai</code>命令，就可以将时区设置为亚洲/上海了，同时我们也可以运行<code>sudo timedatectl set-ntp 1</code>命令，打开自动从 NTP 服务器同步时间，一会之后服务器时间就正常了。<code>timedatectl</code>命令还有一个选项是<code>set-local-rtc</code>，用来将硬件时间设置为本地时间，而不是UTC时间，这个选项我默认是关闭的。</p>
<h3 id="更改软件源为中科大源">更改软件源为中科大源</h3>
<p>接下来，就是更改源了，打开<code>/etc/apt/sources.list</code>文件，将所有的<code>us.archive.ubuntu.com</code>替换成<code>mirrors.ustc.edu.cn</code>就可以了，注意这里由于我安装的时候选择的是美国的源，所以域名为<code>us.archive.ubuntu.com</code>，如果选择了其他地方的源，域名可能不一样。</p>
<p>同时要注意，<code>security.ubuntu.com</code>这个源表示的是 Ubuntu 进行安全更新的源，用来推送紧急安全更新的补丁，这个源我建议保持原样，因为紧急安全更新的补丁还是从 Ubuntu 官方下载比较好，不建议从其他地方来下载。</p>
<h3 id="设置关闭盖子不休眠">设置关闭盖子不休眠</h3>
<p>由于我的电脑是笔记本，尽管没有装图形界面，但是在合上盖子之后，系统仍然会自动休眠，所以需要将这个自动休眠的功能关掉。我在网上搜索了一下，在 Askubuntu 上找到了一个相关的<a href="http://askubuntu.com/questions/141866/keep-ubuntu-server-running-on-a-laptop-with-the-lid-closed">问题</a>，按照问题中的答案所说，向<code>/etc/systemd/logind.conf</code>文件中添加一行<code>HandleLidSwitch=ignore</code>，然后重启<code>systemd-logind.service</code>服务，就关闭掉这个功能啦。</p>
<h2 id="配置网络环境">配置网络环境</h2>
<p>将服务器配置好以后，接下来我们就需要配置网络了。</p>
<h3 id="设置dhcp">设置DHCP</h3>
<p>我的笔记本是通过网线连接到路由器上的，所以，首先我们需要将有线网卡通过 DHCP 自动连接网络的功能打开。这里我在网上搜索了一下，搜到了一篇文章：<a href="http://www.ubuntugeek.com/ubuntu-networking-configuration-using-command-line.html">Ubuntu Networking Configuration Using Command Line </a>。这篇文章很详细地介绍了Ubuntu如何设置动态IP和静态IP。我的电脑在刚装好系统的时候，没有任何关于有线网卡的配置文件，仅能够通过<code>ip addr</code>命令来看到当前系统的网卡，在了解到有线网卡的名称为<code>enp12s0</code>之后，我新建了一个文件<code>/etc/network/interfaces.d/enp12s0.conf</code>，然后向其中添加了如下的内容，</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 设置网卡enp12s0在开机的时候通过 DHCP 自动连接到网络。</span>
</span></span><span style="display:flex;"><span>auto enp12s0
</span></span><span style="display:flex;"><span>iface enp12s0 inet dhcp
</span></span></code></pre></div><p>上面两句配置就表示设置网卡enp12s0在开机的时候通过 DHCP 自动连接到网络。</p>
<h3 id="设置默认网关">设置默认网关</h3>
<p>设置好网卡的 DHCP 以后，我的服务器能够 ping 通路由器网关了，但是仍然无法 ping 通外网，显然，这是由于服务器本机的网关没有配置好，后来我又上网去搜索，发现了<a href="http://askubuntu.com/questions/522420/how-to-get-default-gateway-with-a-dhcp">Askubuntu 上一个类似的问题</a>，其中有个答案提到，<code>dhclient</code>只在当前服务器没有设置默认网关的时候，才会设置由 DHCP 服务器提供的路由器地址为默认网关。我通过<code>ip route</code>看了一下我的服务器的路由表，发现默认网关为网卡<code>lo</code>，所以 DHCP 服务器下发下来的网关地址并不会生效。我又在<code>/etc/network/interfaces</code>中添加了如下的配置：<code>post-up route del default dev lo</code>，删除掉默认走<code>lo</code>设备的路由配置。</p>
<p>然后我再来重启电脑，就发现服务器一开机就能够正常 ping 通外网了。</p>
<h3 id="设置路由器">设置路由器</h3>
<p>看到这里，相信大家肯定都有一些疑惑，服务器不应该是默认设置为静态IP吗，为什么你要配置 DHCP 呢。原因就在这一小节，我用的路由器是华硕的RT - N12，它的 DHCP 服务器有一个功能，就是将MAC地址和IP地址进行绑定，所以，我只需要在路由器上配置好MAC地址和IP地址的绑定，这样就相当于起到了静态IP的作用了，而且更改起来也比较方便，不需要服务器和路由器两头改。</p>
<h2 id="配置dns">配置DNS</h2>
<p>由于我访问我的服务器的时候想通过域名来访问(方便以后添加HTTPS证书)，所以我需要在我的内网中自己搭建一个DNS服务器，来负责服务器的域名解析。</p>
<h3 id="安装并设置dnsmasq">安装并设置dnsmasq</h3>
<p>由于我的需求很简单，只需要进行一个域名解析就可以了，所以我选择了<a href="http://www.thekelleys.org.uk/dnsmasq/docs/dnsmasq-man.html">dnsmasq</a>，而不是比较复杂的bind9。</p>
<p><code>dnsmasq</code>在Ubuntu的源中直接有deb安装包，所以我们直接通过<code>sudo apt install dnsmasq</code>命令安装即可。</p>
<p><code>dnsmasq</code>的配置我参考了文章<a href="http://cjting.me/misc/2016-08-20-%E4%BD%BF%E7%94%A8Dnsmasq%E6%90%AD%E5%BB%BA%E5%86%85%E7%BD%91DNS%E6%9C%8D%E5%8A%A1%E5%99%A8.html">使用Dnsmasq搭建内网DNS服务器</a>。使用了如下的配置：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 设置服务器的监听地址为192.168.X.X和127.0.0.1</span>
</span></span><span style="display:flex;"><span>listen-address<span style="color:#ce5c00;font-weight:bold">=</span>192.168.X.X,127.0.0.1
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 所有没有.号的域名(plain names)都不会向上游DNS Server转发，只查询hosts文件</span>
</span></span><span style="display:flex;"><span>domain-needed
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 所有保留IP地址段内的反向查询都不会向上游DNS Server转发，只查询hosts文件</span>
</span></span><span style="display:flex;"><span>bogus-priv
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 不要读取/etc/resolver中的DNS Server的配置</span>
</span></span><span style="display:flex;"><span>no-resolv
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 不要poll /etc/resolver文件的更新</span>
</span></span><span style="display:flex;"><span>no-poll
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 配置上游服务器为DNSPod的公共DNS</span>
</span></span><span style="display:flex;"><span><span style="color:#000">server</span><span style="color:#ce5c00;font-weight:bold">=</span>119.29.29.29
</span></span><span style="display:flex;"><span><span style="color:#000">server</span><span style="color:#ce5c00;font-weight:bold">=</span>182.254.116.116
</span></span></code></pre></div><p>配置好了以后，我们可以通过<code>dnsmasq --test</code>命令来检查<code>dnsmasq</code>的配置文件语法是否正确。</p>
<p>然后我们在服务器的<code>/etc/hosts</code>中添加我们想要设置的解析记录，比如这台服务器我设置了如下的记录：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>192.168.X.X dev.bwangel.me
</span></span></code></pre></div><p>然后通过<code>sudo systemctl enable dnsmasq &amp;&amp; sudo systemctl restart dnsmasq</code>命令启动<code>dnsmasq</code>服务即可。</p>
<p>最后我们可以通过<code>dig</code>命令测试一下，运行如下命令: <code>dig dev.bwangel.me @localhost</code>，看返回的IP地址是否和我们设置的解析记录相同。</p>
<h3 id="设置路由器-1">设置路由器</h3>
<p>配置好了DNS服务器以后，我们再来修改路由器的 DHCP 策略，设置下发的DNS服务器IP地址为我们的DNS服务器地址，这样内网中所有的DNS查询都会先经过这台DNS服务器。而我们的<code>dev.bwangel.me</code>域名也就能够成功解析了。至此，我们的开发服务器就已经搭建好了，我们可以通过SSH连接上来，搭建我们想要的服务了。</p>
<h2 id="遇到的一些小坑">遇到的一些小坑</h2>
<h3 id="dnsmasq没有绑定本地地址">dnsmasq没有绑定本地地址</h3>
<p>配置好了 DNS 服务器以后，我在服务器上 ping 百度的时候会一直卡着，但是 ping 公网 IP 却是可以 ping 通的，当时我第一反应就是DNS解析出错了，只是不知道是DNS服务器配置的有问题，还是DNS服务器的IP地址路由器没有正确地下发下来。</p>
<p>接着我就利用dig来测试，发现使用<code>dig www.baidu.com @192.168.X.X</code>命令可以得到正常结果，而<code>dig www.baidu.com @127.0.0.1</code>就会卡着。然后我就觉得应该是dnsmasq没有监听<code>127.0.0.1</code>导致的问题。最后发现服务器DNS的配置文件<code>/etc/resolv.conf</code>中设置的默认DNS为<code>127.0.0.1</code>，而它去查询<code>127.0.0.1</code>的时候会卡着，也不报错，导致服务器不会使用备选的DNS服务器来查询域名，最终导致出现了 ping 百度卡着这种情况。我将dnsmasq的监听地址加上<code>127.0.0.1</code>之后就OK了。</p>
<p>这里还有一点没有搞清楚，路由器的 DHCP 中配置的DNS服务器并没有正确地应用，服务器还是默认遵循<code>/etc/resolv.conf</code>文件中的配置，这个还需要进一步了解一下。</p>
<h3 id="ssh出现locale报错">ssh出现locale报错</h3>
<p>这个问题经常遇到了，在Mac上通过SSH连接到Ubuntu上之后，在安装更新的过程中，出现了如下的报错：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>perl: warning: Setting locale failed.
</span></span><span style="display:flex;"><span>perl: warning: Please check that your locale settings:
</span></span><span style="display:flex;"><span>    <span style="color:#000">LANGUAGE</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87">unset</span><span style="color:#ce5c00;font-weight:bold">)</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#000">LC_ALL</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87">unset</span><span style="color:#ce5c00;font-weight:bold">)</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#000">LC_MESSAGES</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;zh_CN.UTF-8&#34;</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#000">LANG</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;zh_CN.UTF-8&#34;</span>
</span></span><span style="display:flex;"><span>    are supported and installed on your system.
</span></span><span style="display:flex;"><span>perl: warning: Falling back to the standard locale <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;C&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>.
</span></span></code></pre></div><p>这是由于终端SSH的时候，会将本地的locale配置传到服务端上去，我的本地设置的语系是<code>zh_CN.UTF-8</code>，但是服务器上只安装了<code>en_US.UTF-8</code>，所以就会报错提示说找不到语系<code>zh_CN.UTF-8</code>相关的文件。这里我们只需要修改一下服务器的<code>/etc/locale.gen</code>配置文件，将<code>zh_CN.UTF-8</code>相关的配置取消注释，然后再来运行<code>locale-gen</code>命令，就会安装上<code>zh_CN.UTF-8</code>语系相关的文件了，再来运行<code>perl</code>程序就不会报错了。</p>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-3b4ec5fedefcf82985dda74fa4bef98c">21.11 - 【非技术】 Arch 下的无线自动断开</h1>
    
	<p><strong>摘要</strong>:</p>
<blockquote>
<ol>
<li>折腾 ThinkPad E430 在 Arch WiFi 自动断开的问题</li>
<li>无线网卡型号推荐</li>
</ol>
</blockquote>
<h2 id="问题描述">问题描述</h2>
<p>首先说明，这个问题我最终还是没有解决，最后的办法就是去上网买了一块无线网卡，所以我在标题上写上非技术的字样，表明这篇文章技术含量并不大。</p>
<p>先说我的硬件环境吧，电脑是 ThinkPad E430，无线网卡的芯片型号是瑞昱的RTL8188CE，系统内核版本是4.8.13。</p>
<p>出现的问题就是无线连上一段时间以后，网络会自动断开，ping 不通任何网站。而系统却还显示网络已经连接，<code>ip address</code> 命令也能够看到无线网卡的IP地址。</p>
<h2 id="尝试的解决方案">尝试的解决方案</h2>
<h3 id="方案1更改etcpppoptions配置文件">方案1：更改<code>/etc/ppp/options</code>配置文件</h3>
<p>遇到问题当然要先谷歌啦，首先我以<code>arch wifi auto disconnect</code>关键字来搜索，结果搜到了很多相关度不大的页面，后来又以<code>thinkpad e430 wifi auto disconnect</code>关键字来搜索，就搜索到了<a href="https://www.oschina.net/question/571626_234750">开源中国社区上的一个问题</a>，额，前两个回答看起来还是让人很不爽的，不禁让我想起来教主的这条<a href="http://weibo.com/1401527553/EirySEJV9?type=comment">微博</a>，然后果断举报了。</p>
<p>接着我在下面看到有人回答说可以更改<code>/etc/ppp/options</code>文件中的一个配置项，我就照着去更改了，重启后发现该 WiFi 依旧抽风，方案1失败。</p>
<h3 id="方案2更改rtl8192ce内核模块的选项">方案2：更改<code>rtl8192ce</code>内核模块的选项</h3>
<p>后来我一想，是不是因为我的搜索关键字范围太广了，就把关键字搞得更精确一点。我就去以<code>RTL8188CE linux disconnect</code>和<code>RTL8188CE linux disconnect</code>着两个关键字去搜索，果然一下子发现了有价值的内容。</p>
<p>首先找到了是这个帖子：<a href="https://forums.linuxmint.com/viewtopic.php?t=194086">【SOLVED】 wifi connection problems Realtek RTL8188CE</a>。发现这个帖子的时候，我感觉特别兴奋的，因为这位网友描述的问题，和我的几乎一模一样，它的网卡型号也和我的一模一样。
然后照着下面的回复，给<code>rtl8192ce</code>模块添加了<code>fwlps=0 ips=0</code>这两个参数，重启后发现依然跪，好吧，真是大坑。后来又去尝试编译这篇帖子中提到了<code>backports-20150313.tar.xz</code>程序，直接出现了语法错误，好吧，果断放弃了。</p>
<p>后来有搜索到了Arch论坛上有人讨论相关的问题，然后我就照着论坛里面人们的讨论，稀里糊涂地发现了 ThinkPad E430 在 Arch 上的 <a href="https://wiki.archlinux.org/index.php/Lenovo_ThinkPad_Edge_E430#Wireless">Wiki页面</a>。Wiki 中就提到了无线网络的问题，然后它给出的答案也是更改<code>RTL8188CE</code>这个内核模块的参数，不过是只需要添加一个<code>fwlps=0</code>就好了，如果不行的话，直接去买一块 Intel Centrino wlan/bluetooth 4.0 卡吧。
我照着这个方案试了一下，果断不行，WiFi 依然跪，方案2也失败了。</p>
<h3 id="方案3求助于-archlinux-的邮件列表">方案3：求助于 ArchLinux 的邮件列表</h3>
<p>到此时，我已经感觉到山穷水尽了，好像真的没有办法了，于是乎就去 ArchLinux 邮件列表上发了一个<a href="https://groups.google.com/forum/#!topic/archlinux-cn/UgGVBn99UOs">求助帖</a>：一方面想看看还能不能找到解决办法，另一方面想请教一下如果要再买一个无线网卡的话，该买什么型号的？</p>
<h2 id="原因分析">原因分析</h2>
<p>最后，在邮件列表中，大家分析过后，认为很有可能网卡驱动有问题。</p>
<p>因为在网络实际上已经断开的情况下，内核依然没有收到网络断开的消息，依然认为网络是连接着的。这种情况下可能的原因是：</p>
<ol>
<li>内核有 BUG 导致驱动报告的事件没有反应到其他部分。</li>
<li>驱动有 BUG 没有正确地将网络断开事件报告给内核。</li>
<li>驱动有 BUG 在网络已经断开的情况下没有报告网络已经断开这个事件。</li>
</ol>
<p>而一般看来，驱动是故障的高发区。</p>
<p>后来我又用 Wireshark 抓了一下包，发现当WiFI自动断开后，有大量的 ARP 请求，此时应该就是因为驱动有问题导致网卡罢工了，内核让它发的包发布出去，它也接受不到任何的包。</p>
<h2 id="网卡推荐">网卡推荐</h2>
<p>至此，看来这个驱动问题我是没法解决了，只好去重新买一块无线网卡，为了一个操作系统花上几十块钱买块网卡，虽说听起来很2，但是自己觉得还是很划算的。</p>
<p>目前无线网卡的芯片主要有这么几种：</p>
<ul>
<li>Ralink(雷凌，台湾)</li>
</ul>
<blockquote>
<p>Ralink Technology公司成立于2001年，总部位于台湾新竹，并在美国加州Cupertino设有研发中心。目前已知的Edimax、Tenda、ASUS及D-link都有采用Ralink的产品。</p>
</blockquote>
<ul>
<li>oroadcomd(博通，美国)</li>
</ul>
<blockquote>
<p>Broadcom芯片是最成熟、最稳定的一种，而且还可以使用DD-WRT这种第三方开源固件改善性能，增加功能。</p>
</blockquote>
<ul>
<li>Atheros(创锐讯，美国)</li>
</ul>
<blockquote>
<p>Atheros 在1999年由斯坦福大学的Teresa Meng博士和斯坦福大学校长，MIPS创始人John Hennessy博士共同在硅谷创办。Atheros的芯片被各大厂商所广泛采用，Netgear、D-Link、Intel等厂商均为Atheros客户。</p>
</blockquote>
<ul>
<li>Realtek(瑞昱，台湾)</li>
</ul>
<blockquote>
<p>瑞昱半导体于1987年在台湾的新竹科学园区成立，我的电脑的无线网卡芯片就是这个牌子的。</p>
</blockquote>
<p>总的来说，无论是抓包，开热点还是兼容性(不仅针对 Linux)，Atheros 的 AR9271 都是比较合适的。据同事说，使用下来最稳定的 USB 网卡就是网件的 WNA1100，某宝上二手的洋垃圾也就十几块钱。</p>
<h2 id="写在最后">写在最后</h2>
<p>最终我还是去某宝上买了一块 USB 无线网卡。再此，要感谢邮件列表中的热心群众，感谢他们能够帮我解决问题和推荐网卡，我从中也学到了很多。</p>
<p>最后附上我在解决问题的过程中参考到的页面：</p>
<ul>
<li><a href="https://www.oschina.net/question/571626_234750">ubuntu14.04 wifi频繁掉线</a></li>
<li><a href="https://forums.linuxmint.com/viewtopic.php?t=194086">【SOLVED】wifi connection problems Realtek RTL8188CE</a></li>
<li><a href="https://wiki.archlinux.org/index.php/Lenovo_ThinkPad_Edge_E430#Wireless">Lenovo ThinkPad Edge E430 - Arch Wiki</a></li>
<li><a href="https://item.taobao.com/item.htm?spm=a230r.1.14.62.DbhWkt&amp;id=538494346626&amp;ns=1&amp;abbucket=19#detail">没错，你没有看错，这是一个淘宝页面，我参考了它的宝贝详情</a></li>
<li><a href="https://groups.google.com/forum/#!topic/archlinux-cn/UgGVBn99UOs">ArchLinux 的邮件列表</a></li>
</ul>
</div>



    
	
  

    
	
  



          </main>
        </div>
      </div>
      <footer class="td-footer row d-print-none">
  <div class="container-fluid">
    <div class="row mx-md-2">
      <div class="col-6 col-sm-4 text-xs-center order-sm-2">
        
        
        
      </div>
      <div class="col-6 col-sm-4 text-end text-xs-center order-sm-3">
        
        
        
<ul class="td-footer__links-list">
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="GitHub" aria-label="GitHub">
    <a target="_blank" rel="noopener" href="https://github.com/bwangelme/" aria-label="GitHub">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="td-footer__copyright-etc col-12 col-sm-4 text-center py-2 order-sm-2">
        <span>&copy; 2023 力行近乎仁，好问近乎智，知耻近乎勇 </span>
        <span class="ms-1"><a href="https://policies.google.com/privacy" target="_blank" rel="noopener"></a></span>
        
      </div>
    </div>
  </div>
</footer>
    </div>
    
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css"
      integrity="sha512-mQwom8Ns4op+H29oDkD/LXO/OsXPvCFfkgZkFAVrhhePzRLU8NUI3Nkm43NhWUSmj3p5Cca2HTEkMQmXQRwDQQ==" crossorigin="anonymous">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.js"
        integrity="sha512-sHSNLECRJSK+BFs7E8DiFc6pf6n90bLI85Emiw1jhreduZhK3VXgq9l4kAt9eTIHYAcuQBKHL01QKs4/3Xgl8g=="
        crossorigin="anonymous">
</script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/contrib/auto-render.min.js"
       integrity="sha512-iWiuBS5nt6r60fCz26Nd0Zqe0nbk1ZTIQbl3Kv7kYsX+yKMUFHzjaH2+AnM6vp2Xs+gNmaBAVWJjSmuPw76Efg==" crossorigin="anonymous"
       onload='renderMathInElement(document.body, null);'>
</script>
<script src="/647/js/main.min.4f6bdd3cd8cde411a9b8cc8c9f435ab27b7a07d49198bf6bc750cdcd26e6e429.js" integrity="sha256-T2vdPNjN5BGpuMyMn0Nasnt6B9SRmL9rx1DNzSbm5Ck=" crossorigin="anonymous"></script>
<script src='/647/js/prism.js'></script>
<script src='/647/js/tabpane-persist.js'></script>

  </body>
</html>
