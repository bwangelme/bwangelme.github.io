<!doctype html>
<html itemscope itemtype="http://schema.org/WebPage" lang="cn" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.117.0">
<link rel="canonical" type="text/html" href="https://bwangelme.github.io/647/docs/">
<link rel="alternate" type="application/rss&#43;xml" href="https://bwangelme.github.io/647/docs/index.xml">
<meta name="robots" content="noindex, nofollow">


<link rel="shortcut icon" href="/647/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/647/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/647/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/647/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/647/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/647/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/647/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/647/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/647/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/647/favicons/android-192x192.png" sizes="192x192">

<title>Documentation | 647 Universe</title>
<meta name="description" content="宇宙很大，生活更大，也许以后还有缘相见">
<meta property="og:title" content="Documentation" />
<meta property="og:description" content="宇宙很大，生活更大，也许以后还有缘相见" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://bwangelme.github.io/647/docs/" /><meta property="og:site_name" content="647号宇宙" />
<meta itemprop="name" content="Documentation">
<meta itemprop="description" content="宇宙很大，生活更大，也许以后还有缘相见"><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Documentation"/>
<meta name="twitter:description" content="宇宙很大，生活更大，也许以后还有缘相见"/>




<link rel="preload" href="/647/scss/main.min.291c723daa8f2fb6b09f56ac9a2ca71406607a4268e1fe586dddad1a8583b4e7.css" as="style">
<link href="/647/scss/main.min.291c723daa8f2fb6b09f56ac9a2ca71406607a4268e1fe586dddad1a8583b4e7.css" rel="stylesheet" integrity="">

<script
  src="https://code.jquery.com/jquery-3.6.3.min.js"
  integrity="sha512-STof4xm1wgkfm7heWqFJVn58Hm3EtS31XFaagaa8VMReCXAkQnJZ+jEy8PCC/iT18dFy95WcExNHFTqLyp72eQ=="
  crossorigin="anonymous"></script>
<link rel="stylesheet" href="/647/css/prism.css"/>

  </head>
  <body class="td-section">
    <header>
      <nav class="td-navbar navbar-dark js-navbar-scroll">
<div class="container-fluid flex-column flex-md-row">
  <a class="navbar-brand" href="/647/"><span class="navbar-brand__logo navbar-logo"><svg id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 500 500" style="enable-background:new 0 0 500 500"><g><path style="fill:#fff" d="M116.8525 421.9722c-5.7041.0-10.3442-4.3127-10.3442-9.6129V88.183c0-5.3002 4.6401-9.6117 10.3442-9.6117H320.858c3.0347.0 9.3959.5498 11.7506 2.6302l.3545.3442 58.905 63.2912c2.3101 2.491 2.9202 8.4928 2.9202 11.3184v256.2039c0 5.3002-4.6407 9.6129-10.3436 9.6129H116.8525z"/><g><g><g><path style="fill:#767676" d="M384.4445 423.2066H116.852c-6.3839.0-11.5786-4.8658-11.5786-10.8474V88.1831c0-5.9804 5.1947-10.8461 11.5786-10.8461h204.0062c.377.0 9.2786.0329 12.568 2.9389l.3947.3833 58.9508 63.337c3.2135 3.4652 3.2514 11.7924 3.2514 12.1593v256.2036C396.0231 418.3408 390.8284 423.2066 384.4445 423.2066zM116.5079 411.9189c.0848.0278.1999.0531.3441.0531h267.5925c.1442.0.2581-.0253.3441-.0531V156.1556c-.0076-.9033-.3593-3.7347-.7034-5.0037l-57.6527-61.9416c-1.4651-.3176-4.4533-.6389-5.5742-.6389H116.852c-.143.0-.2594.024-.3441.0531V411.9189zm267.4533-261.149zM327.0321 89.371v.0013V89.371z"/></g></g></g><g><g><path style="fill:#5b7fc0" d="M189.0874 210.1754l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4473C177.5953 212.627 183.0601 210.1742 189.0874 210.1754zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 234.1722 197.0804 232.033z"/><path style="opacity:.3;fill:#fff" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/><g><defs><path id="SVGID_1_" d="M194.7376 237.6875c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 234.2399 196.1861 236.239 194.7376 237.6875z"/></defs><clipPath id="SVGID_2_"><use xlink:href="#SVGID_1_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_2_);fill:#fff" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/><path style="opacity:.13;clip-path:url(#SVGID_2_);fill:#020202" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/></g><g><defs><path id="SVGID_3_" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/></defs><clipPath id="SVGID_4_"><use xlink:href="#SVGID_3_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_4_);fill:#5b7fc0" d="M172.6595 215.6045c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8475-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 209.1953 176.6171 211.647 172.6595 215.6045z"/></g></g><rect x="198.8952" y="225.1043" style="fill:#5b7fc0" width="122.6266" height="13.8671"/></g><g><path style="fill:#d95140" d="M189.0874 155.7611l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.0249 2.454-11.4897 6.4116-15.4473C177.5953 158.2128 183.0601 155.7599 189.0874 155.7611zm7.993 21.8577c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.2508 181.7667 197.0816 179.758 197.0804 177.6188z"/><path style="opacity:.3;fill:#fff" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/><g><defs><path id="SVGID_5_" d="M194.7376 183.2733c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 179.8256 196.1861 181.8248 194.7376 183.2733z"/></defs><clipPath id="SVGID_6_"><use xlink:href="#SVGID_5_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_6_);fill:#fff" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/><path style="opacity:.13;clip-path:url(#SVGID_6_);fill:#020202" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/></g><g><defs><path id="SVGID_7_" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/></defs><clipPath id="SVGID_8_"><use xlink:href="#SVGID_7_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_8_);fill:#d95140" d="M172.6595 161.1903c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 154.7811 176.6171 157.2327 172.6595 161.1903z"/></g><rect x="198.8952" y="170.69" style="fill:#d95140" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#56a55c" d="M189.5379 264.6147l.0012-.0012c7.7751.0012 15.0294 4.1862 18.932 10.9235 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032-5.8394.0-11.3281-2.2733-15.458-6.4032-4.13-4.13-6.4032-9.6186-6.4056-15.4628.0012-6.0249 2.454-11.4897 6.4116-15.4472C178.0458 267.0663 183.5105 264.6135 189.5379 264.6147zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6538 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.7013 290.6202 197.5321 288.6115 197.5309 286.4723z"/><path style="opacity:.3;fill:#fff" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/><g><defs><path id="SVGID_9_" d="M195.1881 292.1268c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9941 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.5344 288.6792 196.6366 290.6783 195.1881 292.1268z"/></defs><clipPath id="SVGID_10_"><use xlink:href="#SVGID_9_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_10_);fill:#fff" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/><path style="opacity:.13;clip-path:url(#SVGID_10_);fill:#020202" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/></g><g><defs><path id="SVGID_11_" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/></defs><clipPath id="SVGID_12_"><use xlink:href="#SVGID_11_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_12_);fill:#56a55c" d="M173.11 270.0439c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7325-11.1497-10.9151-18.926-10.9151C182.5311 263.6346 177.0676 266.0863 173.11 270.0439z"/></g></g><rect x="199.3456" y="279.5436" style="fill:#56a55c" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#f1bc42" d="M189.0874 318.7208l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3305-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4472C177.5953 321.1724 183.0601 318.7196 189.0874 318.7208zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 342.7176 197.0804 340.5784z"/><path style="opacity:.3;fill:#fff" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/><g><defs><path id="SVGID_13_" d="M194.7376 346.2329c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 342.7853 196.1861 344.7844 194.7376 346.2329z"/></defs><clipPath id="SVGID_14_"><use xlink:href="#SVGID_13_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_14_);fill:#fff" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/><path style="opacity:.13;clip-path:url(#SVGID_14_);fill:#020202" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/></g><g><defs><path id="SVGID_15_" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/></defs><clipPath id="SVGID_16_"><use xlink:href="#SVGID_15_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_16_);fill:#f1bc42" d="M172.6595 324.15c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8474-1.0151-7.6327-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 317.7407 176.6171 320.1924 172.6595 324.15z"/></g></g><rect x="198.8952" y="333.6497" style="fill:#f1bc42" width="122.6266" height="13.8671"/></g></g></svg></span><span class="navbar-brand__name">647 Universe</span></a>
  <div class="td-navbar-nav-scroll ms-md-auto" id="main_navbar">
    <ul class="navbar-nav">
      <li class="nav-item">
        <a class="nav-link active" href="/647/docs/"><span>Docs</span></a>
      </li>
      </ul>
  </div>
  <div class="d-none d-lg-block">
    
  </div>
</div>
</nav>
    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <main class="col-12 col-md-9 col-xl-8 ps-md-5" role="main">
            




<div class="td-content">
<div class="pageinfo pageinfo-primary d-print-none">
<p>

<a href="#" onclick="print();return false;"></a>.
</p><p>
<a href="/647/docs/"></a>.
</p>
</div>



<h1 class="title">Documentation</h1>





    <ul>
    
  
  
  
  

  
    
    
	
<li>1: <a href="#pg-0d3382c151725c975fa7e12e83c234f9">WireShark</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>1.1: <a href="#pg-228f2acd9c0ff088f1229559fcdd6503">利用 VirtualBox 和 Ubuntu 22 重现抓包实验</a></li>


    
  

    </ul>
    
  
    
    
	
<li>2: <a href="#pg-fb8915bbd249021082eebe2c7dfd52f0">Golang</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>2.1: <a href="#pg-c374734838a7da2e3834d1091952177f">泛型</a></li>


    
  
    
    
	
<li>2.2: <a href="#pg-8aa7d3f7c05390359a87acf37c95a33b">YAML</a></li>


    
  
    
    
	
<li>2.3: <a href="#pg-434a02cf1a3ee72f31be04b770f0fabb">Golang 的版本发布计划</a></li>


    
  
    
    
	
<li>2.4: <a href="#pg-411c7d44b39c2c01f271102f90652135">Go proxy 的说明</a></li>


    
  

    </ul>
    
  
    
    
	
<li>3: <a href="#pg-f0a22a813c843322c0d360d952e434ce">性能分析</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>3.1: <a href="#pg-38dd3702bb1bcc7da2f55f43923b479a">QPS 和 RT 的关系</a></li>


    
  

    </ul>
    
  
    
    
	
<li>4: <a href="#pg-f65393dbe42ee15e5a5af9e8946cd970">Thrift</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>4.1: <a href="#pg-627b44310e536ffc3394a1aa2f824a8c">Thrft</a></li>


    
  

    </ul>
    
  
    
    
	
<li>5: <a href="#pg-e3393de7e8466911640490b15485a33d">规范</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>5.1: <a href="#pg-e0e47e08b609b222268e029cf0817880">日期和时间格式</a></li>


    
  

    </ul>
    
  
    
    
	
<li>6: <a href="#pg-546aa9afbb590e86cfb9df263df9d01c">编辑器</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>6.1: <a href="#pg-e9fb0115d808edb36ba1a3f492e95c4d">Pycharm</a></li>


    
  

    </ul>
    
  
    
    
	
<li>7: <a href="#pg-5990d373ac824b52e97a76c2b3e2ff2c">Linux</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>7.1: <a href="#pg-1c2b211e34ea807b66d53c40bac236f2">curl</a></li>


    
  
    
    
	
<li>7.2: <a href="#pg-a5f545a950366d730141f62b977f5c24">lsof</a></li>


    
  

    </ul>
    
  

    </ul>


<div class="content">
      <div><a id="td-block-0" class="td-offset-anchor"></a></div>
<section class="row td-box td-box--0 td-box--height-auto">
<div class="col">
<div class="container">
<p class="h1 text-center">宇宙很大，生活更大，也许以后还有缘相见</p>
</div>
</div>
</section>

</div>
</div>


  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-0d3382c151725c975fa7e12e83c234f9">1 - WireShark</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-228f2acd9c0ff088f1229559fcdd6503">1.1 - 利用 VirtualBox 和 Ubuntu 22 重现抓包实验</h1>
    
	<h2 id="实验介绍">实验介绍</h2>
<p>在 <a href="https://book.douban.com/subject/26268767/">《Wireshark网络分析就这么简单》</a> 第一章，讲述了一道面试题。</p>
<p>HostA 和 HostB 在同一个局域网中，它们的 IP 配置如下，请问这两台机器能否 ping 通?</p>
<pre tabindex="0"><code>HostA: 
    IP: 192.168.26.129/24
    Gateway: 192.168.26.2
HostB: 
    IP: 192.168.26.3/27
    Gateway: 192.168.26.2
</code></pre><p>答案是能够 ping 通，HostA 和 HostB 连同网关最终会形成一个奇怪的网络</p>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2023-08-23-103426.png" alt=""></p>
<p>具体通信过程如下:</p>
<ul>
<li>HostA(<code>192.168.26.129</code>) 发送 ping 请求给 HostB(<code>192.168.26.3</code>)
<ul>
<li>HostA 将 HostB 的 IP 和自己的掩码计算，发现 <code>192.168.26.3</code> 和自己是处于同一子网</li>
<li>HostA 通过 ARP 协议广播寻找 <code>192.168.26.3</code> 的 MAC 地址，由于 <code>192.168.26.3</code> 和它在同一局域网中，<code>192.168.26.3</code> 会应答自己的 MAC 地址</li>
<li>HostA 将 ping 请求直接发送给 <code>192.168.26.3</code>, 目的 MAC 地址使用的就是 <code>192.168.26.3</code> 的地址</li>
</ul>
</li>
<li>HostB(<code>192.168.26.3</code>) 收到 ping 请求，给 HostA 发送 ping 响应
<ul>
<li>HostB 将 HostA 的 IP 和自己的掩码计算，发现 <code>192.168.26.129</code> 和自己不是同一子网
<ul>
<li>192.168.26.3 &amp; 255.255.255.224 == 192.168.26.0</li>
<li>192.168.26.129 &amp; 255.255.255.224 == 192.168.26.128</li>
</ul>
</li>
<li>HostB 将 ping 响应发送给网关，由网关进行路由发送
<ul>
<li>HostB 通过 APR 协议广播寻找网关 <code>192.168.26.2</code> 的 MAC 地址，网关 <code>192.168.26.2</code> 告诉 HostB 自己的 MAC</li>
<li>HostB 发送 ping 响应包，目的 IP 是 <code>192.168.26.129</code>, 目的 MAC 是网关的 MAC 地址</li>
</ul>
</li>
<li>网关将 ping 响应发送给了 HostA</li>
</ul>
</li>
</ul>
<h2 id="开始实验">开始实验</h2>
<p>读完以后，感觉这个测试挺好玩，就尝试在本地复现了一下。</p>
<p>我的环境如下，3台安装了 Ubuntu 22.04 Vitualbox 虚拟机, 它们分别充当 HostA, HostB 和 网关</p>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2023-08-23-224057.png" alt=""></p>
<h3 id="配置-vagrant">配置 Vagrant</h3>
<p>我的 VirtualBox 是通过 Vagrant 启动的</p>
<ul>
<li>首先我们需要在 Vagrant 官网上下载 Ubuntu 22.04 的 Box</li>
</ul>
<p><a href="https://app.vagrantup.com/ubuntu/boxes/jammy64">ubuntu/jammy64 Vagrant box 下载地址</a></p>
<p>下载完成之后通过如下命令添加 Vagrant Box</p>
<pre tabindex="0"><code>vagrant box add ~/Downloads/jammy-server-cloudimg-amd64-vagrant.box --name ubuntu/jammy
</code></pre><p>添加完成后使用 <code>vagrant box list</code> 可以看到我们添加的 box 名字了</p>
<ul>
<li>接着我们再来安装 <code>vagrant-disksize</code> 插件</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 建议在执行命令前挂上 http 代理</span>
</span></span><span style="display:flex;"><span>vagrant plugin install vagrant-disksize
</span></span></code></pre></div><h3 id="启动并配置-vbox">启动并配置 VBox</h3>
<p>这是我的 Vagrantfile, 它启动了三个 virtualbox 虚拟机，分别命名为 vbox1, vbox2, vbox3。完整代码见 <a href="https://github.com/bwangelme/DockerVbox.git">github/bwangelme/DockerVbox.git</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># -*- mode: ruby -*-</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># vi: set ft=ruby :</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Verify whether required plugins are installed.</span>
</span></span><span style="display:flex;"><span><span style="color:#000">required_plugins</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">[</span> <span style="color:#4e9a06">&#34;vagrant-disksize&#34;</span> <span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#000">required_plugins</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">each</span> <span style="color:#204a87;font-weight:bold">do</span> <span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#000">plugin</span><span style="color:#ce5c00;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87;font-weight:bold">not</span> <span style="color:#000">Vagrant</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">has_plugin?</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">plugin</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">raise</span> <span style="color:#4e9a06">&#34;The vagrant plugin </span><span style="color:#4e9a06">#{</span><span style="color:#000">plugin</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06"> is required. Please run `vagrant plugin install </span><span style="color:#4e9a06">#{</span><span style="color:#000">plugin</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">`&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">end</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">Vagrant</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">configure</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;2&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">do</span> <span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#000">config</span><span style="color:#ce5c00;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">config</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">vm</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">box_check_update</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">$num_instances</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">3</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">..</span><span style="color:#000">$num_instances</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">each</span> <span style="color:#204a87;font-weight:bold">do</span> <span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">config</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">vm</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">define</span> <span style="color:#4e9a06">&#34;vbox</span><span style="color:#4e9a06">#{</span><span style="color:#000">i</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">&#34;</span> <span style="color:#204a87;font-weight:bold">do</span> <span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#000">node</span><span style="color:#ce5c00;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">node</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">vm</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">box</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;ubuntu/jammy&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">node</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">vm</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">hostname</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;vbox</span><span style="color:#4e9a06">#{</span><span style="color:#000">i</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">node</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">vm</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">provider</span> <span style="color:#4e9a06">&#34;virtualbox&#34;</span> <span style="color:#204a87;font-weight:bold">do</span> <span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#000">vb</span><span style="color:#ce5c00;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">vb</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">memory</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;1024&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">vb</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">cpus</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">vb</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">name</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;vbox</span><span style="color:#4e9a06">#{</span><span style="color:#000">i</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">end</span>
</span></span><span style="display:flex;"><span>      <span style="color:#8f5902;font-style:italic"># 单独执行 vagrant provision 也会执行一遍 install.sh 脚本</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">node</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">vm</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">provision</span> <span style="color:#4e9a06">&#34;shell&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">path</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;install.sh&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">end</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">end</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">end</span>
</span></span></code></pre></div><p>将 <a href="https://github.com/bwangelme/DockerVbox.git">github/bwangelme/DockerVbox.git</a> 克隆到本地，进入目录中执行</p>
<pre tabindex="0"><code>vagrant up
</code></pre><p>就可以创建并启动三个 Ubuntu 22.04 的 VirtualBox 虚机了</p>
<p>启动完成后，我们执行</p>
<pre tabindex="0"><code>vagrant halt
</code></pre><p>将虚拟机先停止，接着我们来手动设置网络。</p>
<h3 id="设置-vbox-网络">设置 VBox 网络</h3>
<ul>
<li>第一步，打开 VirtualBox 的 <strong>管理 -&gt; 全局设定</strong> ，打开网络 Tab, 添加一个 Nat 网络，设置名字为 <code>NatNetwork</code>，设置网段为 <code>192.168.26.0/24</code></li>
</ul>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2023-08-23-225440.png" alt=""></p>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2023-08-23-225556.png" alt=""></p>
<ul>
<li>第二步，分别在每个虚拟机上执行，在 <strong>虚拟机设置 -&gt; 网络</strong> 中添加网卡，<strong>连接方式</strong> 选 <code>Nat网络</code>, <strong>界面名称</strong> 选择我们刚刚创建的 <code>NatNetwork</code></li>
</ul>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2023-08-23-225755.png" alt=""></p>
<ul>
<li>第三步，手动启动三个虚拟机。</li>
</ul>
<p><strong>注意:</strong> 不能使用 <code>vagrant up</code> 启动, 否则我们创建的网卡就被关闭了</p>
<h3 id="手动设置机器的-ip">手动设置机器的 IP</h3>
<p>虚拟机启动后，使用如下命令可以登陆到对应的虚机上</p>
<pre tabindex="0"><code>vagrant ssh vbox1
</code></pre><p>接着我们修改 <code>/etc/netplan/50-cloud-init.yaml</code> 文件，加入我们 Nat 网卡 <code>enp0s8</code> 的配置</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-diff" data-lang="diff"><span style="display:flex;"><span> vagrant@vbox1:~$ cat /etc/netplan/50-cloud-init.yaml
</span></span><span style="display:flex;"><span> # This file is generated from information provided by the datasource.  Changes
</span></span><span style="display:flex;"><span> # to it will not persist across an instance reboot.  To disable cloud-init&#39;s
</span></span><span style="display:flex;"><span> # network configuration capabilities, write a file
</span></span><span style="display:flex;"><span> # /etc/cloud/cloud.cfg.d/99-disable-network-config.cfg with the following:
</span></span><span style="display:flex;"><span> # network: {config: disabled}
</span></span><span style="display:flex;"><span> network:
</span></span><span style="display:flex;"><span>     ethernets:
</span></span><span style="display:flex;"><span>         enp0s3:
</span></span><span style="display:flex;"><span>             dhcp4: true
</span></span><span style="display:flex;"><span>             match:
</span></span><span style="display:flex;"><span>                 macaddress: 02:20:c0:fe:1f:a9
</span></span><span style="display:flex;"><span>             set-name: enp0s3
</span></span><span style="display:flex;"><span><span style="color:#00a000">+        enp0s8:
</span></span></span><span style="display:flex;"><span><span style="color:#00a000">+            dhcp4: no
</span></span></span><span style="display:flex;"><span><span style="color:#00a000">+            addresses:
</span></span></span><span style="display:flex;"><span><span style="color:#00a000">+                - 192.168.26.129/24
</span></span></span><span style="display:flex;"><span><span style="color:#00a000">+            gateway4: 192.168.26.2
</span></span></span><span style="display:flex;"><span><span style="color:#00a000">+            nameservers:
</span></span></span><span style="display:flex;"><span><span style="color:#00a000">+                addresses: [223.5.5.5]
</span></span></span><span style="display:flex;"><span><span style="color:#00a000"></span>     version: 2
</span></span></code></pre></div><p>三台主机的配置如下</p>
<table>
<thead>
<tr>
<th>Hostname</th>
<th>网卡名称</th>
<th>IP/掩码</th>
<th>MAC 地址</th>
<th>网关</th>
</tr>
</thead>
<tbody>
<tr>
<td>vbox1</td>
<td>enp0s8</td>
<td>192.168.26.129/24</td>
<td>08:00:27:4c:f0:52</td>
<td>192.168.26.2</td>
</tr>
<tr>
<td>vbox2</td>
<td>enp0s8</td>
<td>192.168.26.3/27</td>
<td>08:00:27:69:22:ae</td>
<td>192.168.26.2</td>
</tr>
<tr>
<td>vbox3</td>
<td>enp0s8</td>
<td>192.168.26.2/24</td>
<td>08:00:27:d5:b5:13</td>
<td>192.168.26.1</td>
</tr>
</tbody>
</table>
<p>修改完配置文件后，使用以下命令将配置生效</p>
<pre tabindex="0"><code>sudo netplan apply
</code></pre><p>至此，所有的网络环境都配置成功了，我们可以开始抓包了。</p>
<h2 id="问题1-192168263-地址存在两个">问题1: 192.168.26.3 地址存在两个</h2>
<p>我在 vbox1 上执行以下抓包命令</p>
<pre tabindex="0"><code>sudo tcpdump -i enp0s8 --print -en -w vbox1_ping src host 192.168.26.3 or dst host 192.168.26.3
</code></pre><p>在另一个终端中执行 ping 发送 ICMP 包</p>
<pre tabindex="0"><code>ping -c 3 192.168.26.3
</code></pre><p>此时，很奇怪的问题出现了</p>
<p><code>192.168.26.3</code> 能够 ping 通，但请求不是从 vbox2 发回来的，而是从一个 MAC 地址为 <code>08:00:27:ae:84:b6</code> 的网卡发回来的。</p>
<pre tabindex="0"><code>01:26:47.254731 08:00:27:4c:f0:52 &gt; 08:00:27:ae:84:b6, ethertype IPv4 (0x0800), length 98: 192.168.26.129 &gt; 192.168.26.3: ICMP echo request, id 9, seq 1, length 64
01:26:47.254885 08:00:27:ae:84:b6 &gt; 08:00:27:4c:f0:52, ethertype IPv4 (0x0800), length 98: 192.168.26.3 &gt; 192.168.26.129: ICMP echo reply, id 9, seq 1, length 64
01:26:48.275239 08:00:27:4c:f0:52 &gt; 08:00:27:ae:84:b6, ethertype IPv4 (0x0800), length 98: 192.168.26.129 &gt; 192.168.26.3: ICMP echo request, id 9, seq 2, length 64
01:26:48.275415 08:00:27:ae:84:b6 &gt; 08:00:27:4c:f0:52, ethertype IPv4 (0x0800), length 98: 192.168.26.3 &gt; 192.168.26.129: ICMP echo reply, id 9, seq 2, length 64
01:26:49.298910 08:00:27:4c:f0:52 &gt; 08:00:27:ae:84:b6, ethertype IPv4 (0x0800), length 98: 192.168.26.129 &gt; 192.168.26.3: ICMP echo request, id 9, seq 3, length 64
01:26:49.299089 08:00:27:ae:84:b6 &gt; 08:00:27:4c:f0:52, ethertype IPv4 (0x0800), length 98: 192.168.26.3 &gt; 192.168.26.129: ICMP echo reply, id 9, seq 3, length 64
01:26:52.370038 08:00:27:4c:f0:52 &gt; 08:00:27:ae:84:b6, ethertype ARP (0x0806), length 42: Request who-has 192.168.26.3 tell 192.168.26.129, length 28
01:26:52.370156 08:00:27:ae:84:b6 &gt; 08:00:27:4c:f0:52, ethertype ARP (0x0806), length 60: Reply 192.168.26.3 is-at 08:00:27:ae:84:b6, length 46

# 这个抓包更奇怪，vbox1 询问 192.168.26.3 的 MAC 地址，有两个地址发来了响应
vagrant@vbox1:~$ sudo tcpdump -i enp0s8 --print src host 192.168.26.3 or dst host 192.168.26.3 -w vbox1_ping
tcpdump: listening on enp0s8, link-type EN10MB (Ethernet), snapshot length 262144 bytes
16:50:54.672007 ARP, Request who-has 192.168.26.3 tell vbox1, length 28
16:50:54.672243 ARP, Reply 192.168.26.3 is-at 08:00:27:ae:84:b6 (oui Unknown), length 46
16:50:54.672243 ARP, Reply 192.168.26.3 is-at 08:00:27:69:22:ae (oui Unknown), length 46
</code></pre><p>这个困扰了我好久，我反复检查三台 vbox 的所有网卡和我宿主机所有网卡的 MAC 地址，没有一个是符合 <code>08:00:27:ae:84:b6</code> 的。</p>
<p>后来我突发奇想，这是不是 virtualbox Nat Network 默认创建的地址，于是我将 vbox2 和 vbox3 的地址全部换掉，发现</p>
<ul>
<li>192.168.26.1</li>
<li>192.168.26.2</li>
<li>192.168.26.3</li>
</ul>
<p>这三个地址依然是能够 ping 通的。</p>
<p>我用关键字 <code>vbox nat network gateway</code> 在 Google 中搜索，找到了 vbox 的一篇文档: <a href="https://www.virtualbox.org/manual/ch06.html#network_nat_service">6.4. Network Address Translation Service</a></p>
<p>文档中创建了一个 <code>192.168.15.0/24</code> 的 Nat 网络， 并说静态设置的网关默认被赋予地址 <code>192.168.15.1</code></p>
<blockquote>
<p>Here, natnet1 is the name of the internal network to be used and 192.168.15.0/24 is the network address and mask of the NAT service interface. By default in this static configuration the gateway will be assigned the address 192.168.15.1, the address following the interface address, though this is subject to change. To attach a DHCP server to the internal network, modify the example command as follows:</p>
</blockquote>
<p>这下我就明白了，<code>192.168.26.1</code>, <code>192.168.26.2</code>, <code>192.168.26.3</code> 是 Vbox Nat 网络的保留地址，<code>192.168.26.1</code> 是默认网关，<code>192.168.26.3</code> 是 DNS Server 的地址(因为它的 53 端口能用 UDP 连上), <code>192.168.26.2</code> 是干嘛的还没搞明白</p>
<p>为了不冲突，我们改一下我们三台机器的地址，新地址如下</p>
<table>
<thead>
<tr>
<th>Hostname</th>
<th>网卡名称</th>
<th>IP/掩码</th>
<th>MAC 地址</th>
<th>网关</th>
</tr>
</thead>
<tbody>
<tr>
<td>vbox1</td>
<td>enp0s8</td>
<td>192.168.26.129/24</td>
<td>08:00:27:4c:f0:52</td>
<td>192.168.26.123</td>
</tr>
<tr>
<td>vbox2</td>
<td>enp0s8</td>
<td>192.168.26.122/27</td>
<td>08:00:27:69:22:ae</td>
<td>192.168.26.123</td>
</tr>
<tr>
<td>vbox3</td>
<td>enp0s8</td>
<td>192.168.26.123/24</td>
<td>08:00:27:d5:b5:13</td>
<td>192.168.26.1</td>
</tr>
</tbody>
</table>
<h2 id="问题2-网关没有转发">问题2: 网关没有转发</h2>
<p>更新了 IP 地址后，我们接着在 vbox1 上 ping <code>192.168.26.122</code>, 此时出现的问题是 ping 不通了，看起来上一个问题解决了，但是新的问题出现了。</p>
<p>我在 vbox2 上抓了一下包，看到了如下内容</p>
<pre tabindex="0"><code>vagrant@vbox2:~$ sudo tcpdump -i enp0s8 --print -en
17:17:56.850218 08:00:27:4c:f0:52 &gt; 08:00:27:69:22:ae, ethertype IPv4 (0x0800), length 98: 192.168.26.129 &gt; 192.168.26.122: ICMP echo request, id 25, seq 8, length 64
17:17:56.850246 08:00:27:69:22:ae &gt; 08:00:27:d5:b5:13, ethertype IPv4 (0x0800), length 98: 192.168.26.122 &gt; 192.168.26.129: ICMP echo reply, id 25, seq 8, length 64
17:17:57.868013 08:00:27:4c:f0:52 &gt; 08:00:27:69:22:ae, ethertype IPv4 (0x0800), length 98: 192.168.26.129 &gt; 192.168.26.122: ICMP echo request, id 25, seq 9, length 64
17:17:57.868046 08:00:27:69:22:ae &gt; 08:00:27:d5:b5:13, ethertype IPv4 (0x0800), length 98: 192.168.26.122 &gt; 192.168.26.129: ICMP echo reply, id 25, seq 9, length 64
17:17:58.883354 08:00:27:4c:f0:52 &gt; 08:00:27:69:22:ae, ethertype IPv4 (0x0800), length 98: 192.168.26.129 &gt; 192.168.26.122: ICMP echo request, id 25, seq 10, length 64
17:17:58.883387 08:00:27:69:22:ae &gt; 08:00:27:d5:b5:13, ethertype IPv4 (0x0800), length 98: 192.168.26.122 &gt; 192.168.26.129: ICMP echo reply, id 25, seq 10, length 64
</code></pre><p>vbox2 收到了来自 vbox1 的 ping request, 并发送 ping reply 给网关 vbox3, 这和我们预期的行为一致，说明 vbox2 没问题。</p>
<p>接着我又在 vbox3 上抓了一下包</p>
<pre tabindex="0"><code>root@vbox3:~# tcpdump -i enp0s8 --print -en
listening on enp0s8, link-type EN10MB (Ethernet), snapshot length 262144 bytes
01:49:50.730850 08:00:27:69:22:ae &gt; 08:00:27:d5:b5:13, ethertype IPv4 (0x0800), length 98: 192.168.26.122 &gt; 192.168.26.129: ICMP echo reply, id 26, seq 1, length 64
01:49:51.790335 08:00:27:69:22:ae &gt; 08:00:27:d5:b5:13, ethertype IPv4 (0x0800), length 98: 192.168.26.122 &gt; 192.168.26.129: ICMP echo reply, id 26, seq 2, length 64
01:49:53.203978 08:00:27:69:22:ae &gt; 08:00:27:d5:b5:13, ethertype IPv4 (0x0800), length 98: 192.168.26.122 &gt; 192.168.26.129: ICMP echo reply, id 26, seq 3, length 64
01:49:55.993736 08:00:27:69:22:ae &gt; 08:00:27:d5:b5:13, ethertype ARP (0x0806), length 60: Request who-has 192.168.26.123 tell 192.168.26.122, length 46
01:49:55.993751 08:00:27:d5:b5:13 &gt; 08:00:27:69:22:ae, ethertype ARP (0x0806), length 42: Reply 192.168.26.123 is-at 08:00:27:d5:b5:13, length 28
01:52:10.616571 08:00:27:69:22:ae &gt; 08:00:27:d5:b5:13, ethertype IPv4 (0x0800), length 98: 192.168.26.122 &gt; 192.168.26.129: ICMP echo reply, id 27, seq 1, length 64
01:52:11.965582 08:00:27:69:22:ae &gt; 08:00:27:d5:b5:13, ethertype IPv4 (0x0800), length 98: 192.168.26.122 &gt; 192.168.26.129: ICMP echo reply, id 27, seq 2, length 64
01:52:12.992503 08:00:27:69:22:ae &gt; 08:00:27:d5:b5:13, ethertype IPv4 (0x0800), length 98: 192.168.26.122 &gt; 192.168.26.129: ICMP echo reply, id 27, seq 3, length 64
</code></pre><p>vbox3 收到了 vbox2 转发来的包，但它没有进一步的发送动作，此时我拍脑袋一想，Linux 可能默认有限制，不转发包，于是我用 <strong>ubuntu 开启路由转发</strong> 作为关键字搜了一下，找到了配置项 <code>net.ipv4.ip_forward</code>, 我又用 <strong>ubuntu ipv4_forward</strong> 作为关键字搜索了一下，找到了 <a href="https://linuxconfig.org/how-to-turn-on-off-ip-forwarding-in-linux">ubuntu 开启 IP Forward 的文章</a>。</p>
<p>我执行以下命令，在 vbox3 上临时开启了 ip 转发的功能</p>
<pre tabindex="0"><code>sysctl -w net.ipv4.ip_forward=1
</code></pre><p>改完上述配置后，在 vbox1 上 ping <code>192.168.26.122</code> 就能 ping 通了。</p>
<p>在 vbox3 上抓包也能看到转发的 ICMP reply 包</p>
<pre tabindex="0"><code>01:58:54.790382 08:00:27:d5:b5:13 &gt; 08:00:27:4c:f0:52, ethertype IPv4 (0x0800), length 98: 192.168.26.122 &gt; 192.168.26.129: ICMP echo reply, id 28, seq 1, length 64
</code></pre><p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2023-08-23-234135.png" alt=""></p>
<h2 id="参考链接">参考链接</h2>
<ul>
<li><a href="https://linux-audit.com/how-to-clear-the-arp-cache-on-linux/">How to clear the ARP cache on Linux?</a></li>
<li><a href="https://www.virtualbox.org/manual/ch06.html#network_nat_service">6.4. Network Address Translation Service</a></li>
<li><a href="https://linuxconfig.org/how-to-turn-on-off-ip-forwarding-in-linux">Linux IP forwarding – How to Disable/Enable using net.ipv4.ip_forward</a></li>
<li>其他用到的命令</li>
</ul>
<pre tabindex="0"><code># 查看 arp 表
arp -n
# 清空 arp 表
sudo ip -s -s neigh flush all
# 查看路由信息
route -n
</code></pre>
</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-fb8915bbd249021082eebe2c7dfd52f0">2 - Golang</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-c374734838a7da2e3834d1091952177f">2.1 - 泛型</h1>
    
	<h2 id="利用泛型实现的语法糖">利用泛型实现的语法糖</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Cond
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 条件表达式的简单实现，支持任意类型
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">Cond</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">T</span> <span style="color:#000">any</span><span style="color:#000;font-weight:bold">](</span><span style="color:#000">val</span> <span style="color:#204a87;font-weight:bold">bool</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">a</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">b</span> <span style="color:#000">T</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">T</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">val</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">a</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">b</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Or
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 返回 vals 中第一个不是对应类型0值的参数，如果没有，则返回对应类型的0值
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">Or</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">T</span> <span style="color:#000">comparable</span><span style="color:#000;font-weight:bold">](</span><span style="color:#000">vals</span> <span style="color:#ce5c00;font-weight:bold">...</span><span style="color:#000">T</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">T</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">val</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">vals</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">val</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#204a87">new</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">T</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">val</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#204a87">new</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">T</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><ul>
<li>用法</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">TestCond</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">testing</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">T</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">assert</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Equal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Cond</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">assert</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Equal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Cond</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">req</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Request</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">assert</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Equal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MethodGet</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Cond</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">req</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MethodGet</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MethodPost</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">TestOr</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">testing</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">T</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 范型函数可以不传类型参数
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// 我在 1.18, 1.19, 1.20 上测试均可以工作
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">assert</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Equal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Or</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">]())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">assert</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Equal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Or</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">assert</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Equal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Or</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">assert</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Equal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Or</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">assert</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Equal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Or</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-8aa7d3f7c05390359a87acf37c95a33b">2.2 - YAML</h1>
    
	<h2 id="gopkginyamlv3-在-unmarshal-时设置默认值">gopkg.in/yaml.v3 在 Unmarshal 时设置默认值</h2>
<p>使用 <a href="https://github.com/go-yaml/yaml/tree/v3.0.1">gopkg.in/yaml.v3</a> 解析 yaml 文件时，我们可以实现结构体的 UnmarshalYAML 接口</p>
<p>在 <code>UnmarshalYAML</code> 方法中，既可以在结构体创建的时候指定默认值，也可以在结构体 Decode 完成之后，设置更复杂的默认值</p>
<ul>
<li>test.yaml</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">application</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">snowave</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">runtime</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">golang</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">services</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">linaewen.fdoulist</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">handler</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">services/api/thrift.go</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">thrift</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">use_services</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">app</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">fm</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">grpc</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">version</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">6b15b80</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">app</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">music</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">version</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">e89b497be9ef0fb932d5e543ed866f920780750f</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">app</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pony</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">version</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">c5b2e21</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><ul>
<li>main.go</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;github.com/pkg/errors&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;gopkg.in/yaml.v3&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;strings&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">UseService</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">App</span>     <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#4e9a06">`yaml:&#34;app,omitempty&#34;`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Type</span>    <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#4e9a06">`yaml:&#34;type,omitempty&#34;`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Version</span> <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#4e9a06">`yaml:&#34;version&#34;`</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// UnmarshalYAML
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//	此程序演示了，在 Decode 之前设置 Type 字段的默认值为 thrift
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">u</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">UseService</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">UnmarshalYAML</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">yaml</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Node</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">tmp</span> <span style="color:#000">UseService</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ru</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">tmp</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Type</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;thrift&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">value</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Decode</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">ru</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">errors</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Wrap</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;UseService: failed to unmarshal&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">u</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">UseService</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ru</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Service</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Name</span>      <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#4e9a06">`yaml:&#34;name&#34;`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Interface</span> <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#4e9a06">`yaml:&#34;interface&#34;`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Type</span>      <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#4e9a06">`yaml:&#34;type&#34;`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Handler</span>   <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#4e9a06">`yaml:&#34;handler&#34;`</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// UnmarshalYAML
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//	此函数演示了更复杂的情况, Name 字段的默认值是根据 Interface 的值来设置的
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Name 是 Interface 中 `.` 分割的最后一段
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 如果 Interface 中没有 `.` , 则 Name == Interface
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Service</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">UnmarshalYAML</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">yaml</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Node</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">tmp</span> <span style="color:#000">Service</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">rs</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">tmp</span><span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">value</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Decode</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">rs</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">errors</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Wrap</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Service: failed to unmarshal&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">rs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#34;&#34;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// 注意这里，无论 rs.Interface 的值是什么， tokens 的长度一定 &gt;= 1,
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// 所以 tokens[len(tokens)-1] 不会 Panic
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">tokens</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">strings</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Split</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Interface</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;.&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">rs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">tokens</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">tokens</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">s</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">Service</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rs</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">AppConfig</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Application</span> <span style="color:#204a87;font-weight:bold">string</span>        <span style="color:#4e9a06">`yaml:&#34;application&#34;`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Runtime</span>     <span style="color:#204a87;font-weight:bold">string</span>        <span style="color:#4e9a06">`yaml:&#34;runtime&#34;`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Services</span>    <span style="color:#000;font-weight:bold">[]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Service</span>    <span style="color:#4e9a06">`yaml:&#34;services&#34;`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">UseServices</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">UseService</span> <span style="color:#4e9a06">`yaml:&#34;use_services&#34;`</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">config</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">AppConfig</span><span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">content</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">_</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ReadFile</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;test.yaml&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">yaml</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Unmarshal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">content</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">config</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatalln</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 输出
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//fdoulist linaewen.fdoulist
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">svc</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Services</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">svc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">svc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Interface</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 输出
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//fm grpc
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//music thrift
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//pony thrift
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">svc</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UseServices</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">svc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">App</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">svc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Type</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="参考链接">参考链接</h3>
<ul>
<li><a href="https://github.com/go-yaml/yaml/issues/165#issuecomment-727092641">https://github.com/go-yaml/yaml/issues/165#issuecomment-727092641</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-434a02cf1a3ee72f31be04b770f0fabb">2.3 - Golang 的版本发布计划</h1>
    
	<blockquote>
<p>Golang 的版本发布计划</p>
</blockquote>
<hr>
<h2 id="golang-的版本发布计划">Golang 的版本发布计划</h2>
<p>在 <a href="https://github.com/golang/go/wiki/Go-Release-Cycle">Go Release Cycle</a> 中写明了</p>
<p>每半年发布一个版本，每年的02月和08月发布一个 Major 版本。但是 Go 官方好像一直没有严格遵守过这个时间。</p>
<p>在 <a href="https://go.dev/doc/devel/release">Release History</a> 中可以看到最近的版本发布日期</p>
<table>
<thead>
<tr>
<th>版本</th>
<th>发布日期</th>
<th>是否还在维护</th>
</tr>
</thead>
<tbody>
<tr>
<td>go1.19</td>
<td><a href="https://groups.google.com/g/golang-dev/c/4xsD_D5oflI">2022-11-01?</a></td>
<td>开发中</td>
</tr>
<tr>
<td>go1.18</td>
<td>2022-03-15</td>
<td>是</td>
</tr>
<tr>
<td>go1.17</td>
<td>2021-08-16</td>
<td>是</td>
</tr>
<tr>
<td>go1.16</td>
<td>2021-02-16</td>
<td>否</td>
</tr>
<tr>
<td>go1.15</td>
<td>2020-08-11</td>
<td>否</td>
</tr>
<tr>
<td>go1.14</td>
<td>2020-02-25</td>
<td>否</td>
</tr>
<tr>
<td>go.1.13</td>
<td>2019-09-03</td>
<td>否</td>
</tr>
<tr>
<td>go1.12</td>
<td>2019-02-25</td>
<td>否</td>
</tr>
<tr>
<td>go1.11</td>
<td>2018-08-24</td>
<td>否</td>
</tr>
<tr>
<td>go1.10</td>
<td>2018-02-16</td>
<td>否</td>
</tr>
<tr>
<td>go1.9</td>
<td>2017-08-24</td>
<td>否</td>
</tr>
<tr>
<td>go1.8</td>
<td>2017-02-16</td>
<td>否</td>
</tr>
<tr>
<td>go1.7</td>
<td>2016-08-15</td>
<td>否</td>
</tr>
<tr>
<td>go1.6</td>
<td>2016-02-17</td>
<td>否</td>
</tr>
<tr>
<td>go1.5</td>
<td>2015-08-19</td>
<td>否</td>
</tr>
<tr>
<td>go1.4</td>
<td>2014-12-10</td>
<td>否</td>
</tr>
<tr>
<td>go1.3</td>
<td>2014-06-18</td>
<td>否</td>
</tr>
<tr>
<td>go1.2</td>
<td>2013-12-01</td>
<td>否</td>
</tr>
<tr>
<td>go1.1</td>
<td>2013-05-13</td>
<td>否</td>
</tr>
<tr>
<td>go1</td>
<td>2012-03-28</td>
<td>否</td>
</tr>
</tbody>
</table>
<h2 id="每个版本的维护计划">每个版本的维护计划</h2>
<blockquote>
<p>Each major Go release is supported until there are two newer major releases. For example, Go 1.5 was supported until the Go 1.7 release, and Go 1.6 was supported until the Go 1.8 release. We fix critical problems, including critical security problems, in supported releases as needed by issuing minor revisions (for example, Go 1.6.1, Go 1.6.2, and so on).</p>
</blockquote>
<p>每个 Major 版本会维护到下两个 Major 版本 release 的时候，例如 Go1.18 release 的，Go1.16 就放弃维护了。所以每个 Major 版本大致的支持时间是1年</p>
<h2 id="参考链接">参考链接</h2>
<ul>
<li><a href="https://dev.golang.org/release">Golang Release dashboard</a></li>
<li><a href="https://github.com/golang/go/wiki/Go-Release-Cycle">Go Release Cycle</a></li>
<li><a href="https://go.dev/doc/devel/release">Release History</a></li>
<li><a href="https://groups.google.com/g/golang-dev/c/4xsD_D5oflI">Go 1.19 release status</a></li>
</ul>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-411c7d44b39c2c01f271102f90652135">2.4 - Go proxy 的说明</h1>
    
	<hr>
<h2 id="查看-go-proxy-中包的信息">查看 Go Proxy 中包的信息</h2>
<h3 id="查看包的版本列表">查看包的版本列表</h3>
<pre tabindex="0"><code>ø&gt; curl https://proxy.golang.org/go.etcd.io/etcd/client/v3/@v/list
v3.5.0-beta.4
v3.5.4
v3.5.2
v3.5.0-alpha.0
v3.5.0-rc.0
v3.5.3
v3.5.0
v3.5.1
v3.5.0-beta.2
v3.6.0-alpha.0
v3.5.0-rc.1
v3.5.0-beta.3
</code></pre><h3 id="查看包的版本信息">查看包的版本信息</h3>
<pre tabindex="0"><code>curl https://proxy.golang.org/go.etcd.io/etcd/client/v3/@v/v3.0.0-20201116001935-06e48f04865f.info
</code></pre><h3 id="查看包的依赖">查看包的依赖</h3>
<p>即获取 go.mod 文件</p>
<pre tabindex="0"><code>curl https://proxy.golang.org/go.etcd.io/etcd/client/v3/@v/v3.0.0-20201116001935-06e48f04865f.mod
</code></pre><pre tabindex="0"><code>module go.etcd.io/etcd/client/v3

go 1.15

require (
        github.com/dustin/go-humanize v1.0.0
        github.com/google/uuid v1.1.2
        github.com/grpc-ecosystem/go-grpc-prometheus v1.2.0
        github.com/prometheus/client_golang v1.5.1
        go.etcd.io/etcd/api/v3 v3.5.0-pre
        go.etcd.io/etcd/pkg/v3 v3.5.0-pre
        go.uber.org/zap v1.16.0
        google.golang.org/grpc v1.29.1
        sigs.k8s.io/yaml v1.2.0
)

replace (
        go.etcd.io/etcd/api/v3 =&gt; ../../api
        go.etcd.io/etcd/pkg/v3 =&gt; ../../pkg
)

// Bad imports are sometimes causing attempts to pull that code.
// This makes the error more explicit.
replace (
        go.etcd.io/etcd =&gt; ./FORBIDDEN_DEPENDENCY
        go.etcd.io/etcd/v3 =&gt; ./FORBIDDEN_DEPENDENCY
        go.etcd.io/tests/v3 =&gt; ./FORBIDDEN_DEPENDENCY
)
</code></pre><h3 id="下载包">下载包</h3>
<pre tabindex="0"><code>curl https://proxy.golang.org/go.etcd.io/etcd/client/v3/@v/v3.0.0-20201116001935-06e48f04865f.zip
</code></pre><h2 id="proxy-测速">Proxy 测速</h2>
<p>2021-12-13 日晚安装包 <code>go-git/go-git-fixtures</code> 的时候卡着不动，测了一下两个 proxy 的速度</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>ø&gt; curl https://goproxy.io/github.com/go-git/go-git-fixtures/v4/@v/v4.2.1.zip -o /tmp/pkg.zip
</span></span><span style="display:flex;"><span>  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
</span></span><span style="display:flex;"><span>                                 Dload  Upload   Total   Spent    Left  Speed
</span></span><span style="display:flex;"><span>  <span style="color:#0000cf;font-weight:bold">2</span> 93.4M    <span style="color:#0000cf;font-weight:bold">2</span> 2623k    <span style="color:#0000cf;font-weight:bold">0</span>     <span style="color:#0000cf;font-weight:bold">0</span>   181k      <span style="color:#0000cf;font-weight:bold">0</span>  0:08:48  0:00:14  0:08:34  147k
</span></span><span style="display:flex;"><span>ø&gt; curl https://goproxy.cn/github.com/go-git/go-git-fixtures/v4/@v/v4.2.1.zip -o /tmp/pkg.zip
</span></span><span style="display:flex;"><span>  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
</span></span><span style="display:flex;"><span>                                 Dload  Upload   Total   Spent    Left  Speed
</span></span><span style="display:flex;"><span> <span style="color:#0000cf;font-weight:bold">10</span> 93.4M   <span style="color:#0000cf;font-weight:bold">10</span>  9.7M    <span style="color:#0000cf;font-weight:bold">0</span>     <span style="color:#0000cf;font-weight:bold">0</span>  3712k      <span style="color:#0000cf;font-weight:bold">0</span>  0:00:25  0:00:02  0:00:23 3711k
</span></span><span style="display:flex;"><span> <span style="color:#0000cf;font-weight:bold">21</span> 93.4M   <span style="color:#0000cf;font-weight:bold">21</span> 20.2M    <span style="color:#0000cf;font-weight:bold">0</span>     <span style="color:#0000cf;font-weight:bold">0</span>  5605k      <span style="color:#0000cf;font-weight:bold">0</span>  0:00:17  0:00:03  0:00:14 5603k
</span></span></code></pre></div><p>goproxy.io 的下载速度竟然只有 147k，怪不得安装时会卡住</p>
<h2 id="参考链接">参考链接</h2>
<ul>
<li><a href="https://go.dev/ref/mod">https://go.dev/ref/mod</a></li>
</ul>
</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-f0a22a813c843322c0d360d952e434ce">3 - 性能分析</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-38dd3702bb1bcc7da2f55f43923b479a">3.1 - QPS 和 RT 的关系</h1>
    
	<h2 id="术语说明">术语说明</h2>
<ul>
<li>QPS: Query Per Second</li>
<li>RT: Response Time</li>
<li>RT_CPU: 单个请求中的 CPU 时间</li>
<li>RT_WAIT: 单个请求中除了 CPU 时间外的其他时间(等待时间)</li>
</ul>
<h2 id="结论">结论</h2>
<p>单线程情况下, <code>QPS = 1000 / RT</code></p>
<p>多线程情况下，最好的情况(最佳线程数)是</p>
<blockquote>
<p>QPS = 1000 / RT_CPU</p>
</blockquote>
<blockquote>
<p>最佳线程数 = (RT_CPU+RT_WAIT) / RT_CPU * CPU核心</p>
<ul>
<li>线程数超过 最佳线程数 后, 系统的 QPS 不会再增加了，如果进一步增多，因为多个线程抢夺 CPU 资源导致的时间浪费，QPS 还会下降。</li>
</ul>
</blockquote>
<h2 id="说明">说明</h2>
<p>一个请求我们除了有 CPU 执行时间外，还有等待时间(等待IO/等待锁资源)。</p>
<ul>
<li>如果单个请求的等待时间占比很高，我们可以增加线程数，提升 CPU 的利用率，这样 QPS 也会随之增加。(CPU 利用率达到 85% 以上才比较正常)
<ul>
<li>线程本身也会消耗资源，它消耗的是 OS 级别的内存，不是进程内存，如果线程数小于 1000, 那么对于系统性能的影响可以忽略不计。</li>
</ul>
</li>
<li>如果单个请求的 CPU 时间占比很高，此时 CPU 成为系统瓶颈，那么系统整体的 QPS 已经没有提升空间了，要么优化程序，减少 CPU 指令数，要么增加 CPU 资源。</li>
<li>我们提升系统 QPS 的目的就是提升 CPU 的利用率，使 CPU 成为系统瓶颈。</li>
</ul>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-f65393dbe42ee15e5a5af9e8946cd970">4 - Thrift</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-627b44310e536ffc3394a1aa2f824a8c">4.1 - Thrft</h1>
    
	<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2018-05-27-060022.png" alt=""></p>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-e3393de7e8466911640490b15485a33d">5 - 规范</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-e0e47e08b609b222268e029cf0817880">5.1 - 日期和时间格式</h1>
    
	<h2 id="w3-时间规范">w3 时间规范</h2>
<ul>
<li>ISO 8601 定义了大量的日期/时间格式，为了简化开发 &amp; 减少 bug, <a href="https://www.w3.org/TR/NOTE-datetime">w3 规范</a>定义了一个通用的时间格式
<ul>
<li><code>YYYY-MM-DDThh:mm:ss.STZD</code>
<ul>
<li>YYYY/MM/DD 四位数年份/月/日</li>
<li>T 表示后面跟了一个时间</li>
<li>hh:mm:ss 两位数的时分秒</li>
<li>S 一位或多位小数表示秒的一部分，最小是1, 最大不限制</li>
<li>TZD 时区指示符</li>
</ul>
</li>
</ul>
</li>
<li>W3 规范规定 TZD 可以有两种形式
<ol>
<li>表示一个 UTC 时间，TZD 可以写成一个 <code>Z</code>, 例如 <code>1994-11-05T13:15:30Z</code> 表示 utc 时间</li>
<li>表示本地时间, TZD 写成 <code>+HH:MM</code> 或 <code>-HH:MM</code>，表示当地时间相对 utc 时间的偏移量, 例如 <code>1994-11-05T13:15:30+08:00</code> 表示东八区时间，即北京时间</li>
</ol>
</li>
<li>协调世界时的缩写为UTC。国际电信联盟希望协调世界时能够在所有语言有单一的缩写。英语和法语区的人同时希望各自的语言缩写－CUT (Coordinated Universal Time) 和 TUC (Temps Universel Coordonné) 能够成为国际标准，最后妥协使用UTC。</li>
</ul>
<h2 id="参考链接">参考链接</h2>
<ul>
<li><a href="https://www.w3.org/TR/NOTE-datetime">Date and Time Formats</a></li>
<li><a href="https://blog.csdn.net/hsany330/article/details/70332483">关于时间格式 2016-08-9T10:01:54.123Z 20160809100154.123Z 处理方法</a></li>
<li><a href="https://zh.m.wikipedia.org/zh-hans/%E5%8D%8F%E8%B0%83%E4%B8%96%E7%95%8C%E6%97%B6#cite_ref-29">协调世界时</a></li>
</ul>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-546aa9afbb590e86cfb9df263df9d01c">6 - 编辑器</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-e9fb0115d808edb36ba1a3f492e95c4d">6.1 - Pycharm</h1>
    
	<h2 id="tabs---open-in-opposite-group">Tabs -&gt; Open in Opposite Group</h2>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2023-08-07-122300.png" alt=""></p>
<p>如图，窗口被分成了左右两个组。如果我想在右边的窗口组打开 <code>client.go</code> 文件，<strong>同时左边的文件不关闭</strong></p>
<p>可以右键点击 Tab 选择 <code>Open In Opposite Group</code>。</p>
<p>我在设置中将这个功能的快捷键设置成了 <code>Alt+Shift+H</code></p>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-5990d373ac824b52e97a76c2b3e2ff2c">7 - Linux</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-1c2b211e34ea807b66d53c40bac236f2">7.1 - curl</h1>
    
	<h2 id="curl-post-json-数据">curl POST JSON 数据</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>curl -X PUT -H <span style="color:#4e9a06">&#34;Content-Type: application/json&#34;</span> -d <span style="color:#4e9a06">&#39;@/tmp/demo.json&#39;</span> :9200/demo
</span></span><span style="display:flex;"><span>ø&gt; cat /tmp/demo.json
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;settings&#34;</span>: <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;number_of_shards&#34;</span>: 1,
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;number_of_replicas&#34;</span>: <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="使用---resolve-选项替换域名">使用 <code>--resolve</code> 选项替换域名</h2>
<ul>
<li>将 <a href="https://www.google.com">www.google.com</a> 替换成 127.0.0.1，并访问 8000 端口</li>
</ul>
<p><code>curl -v --resolve www.google.com:8000:127.0.0.1 http://www.google.com:8000/ping</code></p>
<ul>
<li>将 <a href="https://www.google.com">https://www.google.com</a> 替换成 127.0.0.1，此时 curl 会忽略证书和域名不匹配的问题</li>
</ul>
<p><code>curl -v --resolve www.google.com:443:127.0.0.1 https://www.google.com/ping</code></p>
<ul>
<li>将 <a href="http://www.google.com">http://www.google.com</a> 替换成 127.0.0.1，http 默认访问 80 端口</li>
</ul>
<p><code>curl -v --resolve www.google.com:80:127.0.0.1 http://www.google.com/ping</code></p>
<h2 id="--fail-和---fail-with-body"><code>--fail</code> 和 <code>--fail-with-body</code></h2>
<p>这两个选项都可以让 curl 在接收到 400 及以上的 HTTP 响应码的时候，将退出码设置为 22</p>
<p><code>--fail-with-body</code> 会输出服务端返回的内容到 stdout 或文件中</p>
<p><code>--fail</code> 不会有任何输出，当服务端返回的是认证相关的状态码时(401/407), 可能会让使用者误以为出错了</p>
<h3 id="使用场景">使用场景</h3>
<p>在一个 dockerfile 中，我期望下载项目的 <code>go.mod</code> 和 <code>go.sum</code> 文件，然后再执行 <code>go mod download</code>。
这样可以在 clone 代码之前，先下载 go module 文件。</p>
<p>如果项目的代码变了，但是依赖并没有变，因为 docker build 的缓存原理，可以省去下载 go module 的步骤。</p>
<pre tabindex="0"><code>...
ARG app_repo
ARG app_commit

RUN [[ ! -d /tmp/app ]] &amp;&amp; mkdir /tmp/app &amp;&amp; \
    curl -s https://raw.githubusercontent.com/${app_repo}/${app_commit}/go.mod -o /tmp/app/go.mod &amp;&amp; \
    curl -s https://raw.githubusercontent.com/${app_repo}/${app_commit}/go.sum -o /tmp/app/go.sum

RUN cd /tmp/app &amp;&amp; go mod download
...
</code></pre><p>当 app_repo 和 app_commit 参数错误，导致对应的 go.mod 文件不存在，curl 会得到 404 的 HTTP 响应码，此时我期望 docker build 出错。</p>
<p>但实际上并不会出错，docker build 会继续执行，直到 go mod download 文件无法识别 go.mod 文件，docker build 才会异常退出。</p>
<p>显示的错误内容如下:</p>
<pre tabindex="0"><code>0.467 go: errors parsing go.mod:
0.467 /tmp/app/go.mod:1: unknown directive: 404:
</code></pre><p>当我给 <code>curl</code> 加上了 <code>--fail</code> 选项之后，程序就会在下载 go.mod 出错时直接退出。显示的错误如下:</p>
<pre tabindex="0"><code>ERROR: failed to solve: 
	process &#34;
		/bin/bash -c [[ ! -d /tmp/app ]] &amp;&amp; mkdir /tmp/app &amp;&amp;
		curl --fail -s https://raw.githubusercontent.com/${app_repo}/${app_commit}/go.mod -o /tmp/app/go.mod &amp;&amp;
		curl -s https://raw.githubusercontent.com/${app_repo}/${app_commit}/go.sum -o /tmp/app/go.sum
	&#34; did not complete successfully: exit code: 22
</code></pre><p>最终的 dockerfile 代码及复现命令</p>
<pre tabindex="0"><code>FROM golang:1.19
SHELL [&#34;/bin/bash&#34;, &#34;-c&#34;]

ARG app_repo
ARG app_commit

RUN go env -w GOPROXY=https://goproxy.cn,direct

RUN [[ ! -d /tmp/app ]] &amp;&amp; mkdir /tmp/app &amp;&amp; \
    curl --fail -s https://raw.githubusercontent.com/${app_repo}/${app_commit}/go.mod -o /tmp/app/go.mod &amp;&amp; \
    curl -s https://raw.githubusercontent.com/${app_repo}/${app_commit}/go.sum -o /tmp/app/go.sum

RUN cd /tmp/app &amp;&amp; go mod download
RUN HTTP_PROXY=&#39;http://改成你自己的代理&#39; HTTPS_PROXY=&#39;http://改成你自己的代理&#39; git clone https://github.com/${app_repo}.git ~/app
RUN cd ~/app &amp;&amp; git reset --hard ${app_commit} &amp;&amp; go build .
</code></pre><ul>
<li>复现命令</li>
</ul>
<pre tabindex="0"><code># 注意这个 app_commit 是一个不存在的 commit
docker build -t curl_test --build-arg app_repo=bwangelme/rdcdemo --build-arg app_commit=2f24a0658d7feb0205e7d75b7ae218ff6495e8f3 .
</code></pre>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-a5f545a950366d730141f62b977f5c24">7.2 - lsof</h1>
    
	<h2 id="按照网络状态筛选进程的-fd">按照网络状态筛选进程的 fd</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo lsof -i -sTCP:LISTEN -a -p &lt;pid&gt;
</span></span></code></pre></div><ul>
<li>
<p><code>-a</code> 表示 and, 前后两个条件要一起生效</p>
</li>
<li>
<p><code>-i</code> 和 <code>-s</code> 一起用，表示可以按照 TCP/UDP 状态来筛选 fd</p>
</li>
<li>
<p>列出进程 <code>&lt;pid&gt;</code> 建立的所有 TCP 连接</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo lsof -i -sTCP:ESTABLISHED -a -p &lt;pid&gt;
</span></span></code></pre></div><ul>
<li>列出进程 <code>&lt;pid&gt;</code> 所有 IDLE 状态的 UDP 连接</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo lsof -i -sUDP:IDLE -a -p &lt;pid&gt;
</span></span></code></pre></div><p>根据 Unix 发行版本的不同，TCP/UDP 状态也会有不同的名字:</p>
<ul>
<li>常用的 TCP 状态是: <code>CLOSED</code>, <code>IDLE</code>, <code>BOUND</code>, <code>LISTEN</code>, <code>ESTABLISHED</code>, <code>SYN_SENT</code>, <code>SYN_RCDV</code>, <code>ESTABLISHED</code>, <code>CLOSE_WAIT</code>, <code>FIN_WAIT1</code>, <code>CLOSING</code>, <code>LAST_ACK</code>, <code>FIN_WAIT_2</code>, <code>TIME_WAIT</code>.</li>
<li>常用的 UDP 状态是: <code>Unbound</code>, <code>Idle</code></li>
</ul>
<h2 id="按照-fd-number-查找进程的-fd">按照 fd number 查找进程的 fd</h2>
<p>使用 <code>strace</code> 查看进程的系统调用的时候，经常能够看到在某个 fd 上执行读写操作，例如:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>write<span style="color:#ce5c00;font-weight:bold">(</span>267, <span style="color:#4e9a06">&#34;\1\0\0\0\0\0\0\0&#34;</span>, 8<span style="color:#ce5c00;font-weight:bold">)</span>       <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">8</span>
</span></span><span style="display:flex;"><span>read<span style="color:#ce5c00;font-weight:bold">(</span>5405, <span style="color:#4e9a06">&#34;# Kubernetes-managed hosts file &#34;</span>..., 4096<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">4096</span>
</span></span></code></pre></div><p>我们想要查一下这个 267 和 5405 具体代表了什么连接，可以用</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo lsof -d &lt;fd_number&gt; -a -p &lt;pid&gt;
</span></span></code></pre></div><p>例如我利用 strace 查看飞书 app 的系统调用，看到以下的信息</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ø&gt; sudo strace -p <span style="color:#0000cf;font-weight:bold">8261</span>
</span></span><span style="display:flex;"><span>strace: Process <span style="color:#0000cf;font-weight:bold">8261</span> attached
</span></span><span style="display:flex;"><span>restart_syscall<span style="color:#ce5c00;font-weight:bold">(</span>&lt;... resuming interrupted <span style="color:#204a87">read</span> ...&gt;<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>openat<span style="color:#ce5c00;font-weight:bold">(</span>AT_FDCWD, <span style="color:#4e9a06">&#34;/proc/self/status&#34;</span>, O_RDONLY<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">4</span>
</span></span><span style="display:flex;"><span>read<span style="color:#ce5c00;font-weight:bold">(</span>4, <span style="color:#4e9a06">&#34;Name:\tfeishu\nUmask:\t0002\nState:\t&#34;</span>..., 1024<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1024</span>
</span></span><span style="display:flex;"><span>close<span style="color:#ce5c00;font-weight:bold">(</span>4<span style="color:#ce5c00;font-weight:bold">)</span>                                <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>futex<span style="color:#ce5c00;font-weight:bold">(</span>0x7ff0a7ffead8, FUTEX_WAKE_PRIVATE, 2147483647<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>futex<span style="color:#ce5c00;font-weight:bold">(</span>0x7ff0a7ffea88, FUTEX_WAKE_PRIVATE, 1<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>recvmsg<span style="color:#ce5c00;font-weight:bold">(</span>23, <span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#000">msg_namelen</span><span style="color:#ce5c00;font-weight:bold">=</span>0<span style="color:#ce5c00;font-weight:bold">}</span>, 0<span style="color:#ce5c00;font-weight:bold">)</span>         <span style="color:#ce5c00;font-weight:bold">=</span> -1 EAGAIN <span style="color:#ce5c00;font-weight:bold">(</span>资源暂时不可用<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>recvmsg<span style="color:#ce5c00;font-weight:bold">(</span>23, <span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#000">msg_namelen</span><span style="color:#ce5c00;font-weight:bold">=</span>0<span style="color:#ce5c00;font-weight:bold">}</span>, 0<span style="color:#ce5c00;font-weight:bold">)</span>         <span style="color:#ce5c00;font-weight:bold">=</span> -1 EAGAIN <span style="color:#ce5c00;font-weight:bold">(</span>资源暂时不可用<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>poll<span style="color:#ce5c00;font-weight:bold">([{</span><span style="color:#000">fd</span><span style="color:#ce5c00;font-weight:bold">=</span>9, <span style="color:#000">events</span><span style="color:#ce5c00;font-weight:bold">=</span>POLLIN<span style="color:#ce5c00;font-weight:bold">}</span>, <span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#000">fd</span><span style="color:#ce5c00;font-weight:bold">=</span>10, <span style="color:#000">events</span><span style="color:#ce5c00;font-weight:bold">=</span>POLLIN<span style="color:#ce5c00;font-weight:bold">}</span>, <span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#000">fd</span><span style="color:#ce5c00;font-weight:bold">=</span>22, <span style="color:#000">events</span><span style="color:#ce5c00;font-weight:bold">=</span>POLLIN<span style="color:#ce5c00;font-weight:bold">}</span>, <span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#000">fd</span><span style="color:#ce5c00;font-weight:bold">=</span>23, <span style="color:#000">events</span><span style="color:#ce5c00;font-weight:bold">=</span>POLLIN<span style="color:#ce5c00;font-weight:bold">}</span>, <span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#000">fd</span><span style="color:#ce5c00;font-weight:bold">=</span>67, <span style="color:#000">events</span><span style="color:#ce5c00;font-weight:bold">=</span>POLLIN<span style="color:#ce5c00;font-weight:bold">}]</span>, 5, 0<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#ce5c00;font-weight:bold">(</span>Timeout<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>recvmsg<span style="color:#ce5c00;font-weight:bold">(</span>23, <span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#000">msg_namelen</span><span style="color:#ce5c00;font-weight:bold">=</span>0<span style="color:#ce5c00;font-weight:bold">}</span>, 0<span style="color:#ce5c00;font-weight:bold">)</span>         <span style="color:#ce5c00;font-weight:bold">=</span> -1 EAGAIN <span style="color:#ce5c00;font-weight:bold">(</span>资源暂时不可用<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>recvmsg<span style="color:#ce5c00;font-weight:bold">(</span>23, <span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#000">msg_namelen</span><span style="color:#ce5c00;font-weight:bold">=</span>0<span style="color:#ce5c00;font-weight:bold">}</span>, 0<span style="color:#ce5c00;font-weight:bold">)</span>         <span style="color:#ce5c00;font-weight:bold">=</span> -1 EAGAIN <span style="color:#ce5c00;font-weight:bold">(</span>资源暂时不可用<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>poll<span style="color:#ce5c00;font-weight:bold">([{</span><span style="color:#000">fd</span><span style="color:#ce5c00;font-weight:bold">=</span>9, <span style="color:#000">events</span><span style="color:#ce5c00;font-weight:bold">=</span>POLLIN<span style="color:#ce5c00;font-weight:bold">}</span>, <span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#000">fd</span><span style="color:#ce5c00;font-weight:bold">=</span>10, <span style="color:#000">events</span><span style="color:#ce5c00;font-weight:bold">=</span>POLLIN<span style="color:#ce5c00;font-weight:bold">}</span>, <span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#000">fd</span><span style="color:#ce5c00;font-weight:bold">=</span>22, <span style="color:#000">events</span><span style="color:#ce5c00;font-weight:bold">=</span>POLLIN<span style="color:#ce5c00;font-weight:bold">}</span>, <span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#000">fd</span><span style="color:#ce5c00;font-weight:bold">=</span>23, <span style="color:#000">events</span><span style="color:#ce5c00;font-weight:bold">=</span>POLLIN<span style="color:#ce5c00;font-weight:bold">}</span>, <span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#000">fd</span><span style="color:#ce5c00;font-weight:bold">=</span>67, <span style="color:#000">events</span><span style="color:#ce5c00;font-weight:bold">=</span>POLLIN<span style="color:#ce5c00;font-weight:bold">}]</span>, 5, 200<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">([{</span><span style="color:#000">fd</span><span style="color:#ce5c00;font-weight:bold">=</span>10, <span style="color:#000">revents</span><span style="color:#ce5c00;font-weight:bold">=</span>POLLIN<span style="color:#ce5c00;font-weight:bold">}])</span>
</span></span><span style="display:flex;"><span>read<span style="color:#ce5c00;font-weight:bold">(</span>10, <span style="color:#4e9a06">&#34;!&#34;</span>, 2<span style="color:#ce5c00;font-weight:bold">)</span>                        <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>futex<span style="color:#ce5c00;font-weight:bold">(</span>0x7ff0a7ffead8, FUTEX_WAKE_PRIVATE, 2147483647<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>futex<span style="color:#ce5c00;font-weight:bold">(</span>0x7ff0a7ffea88, FUTEX_WAKE_PRIVATE, 1<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>futex<span style="color:#ce5c00;font-weight:bold">(</span>0x7ff0a0001eb8, FUTEX_WAKE_PRIVATE, 1<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>openat<span style="color:#ce5c00;font-weight:bold">(</span>AT_FDCWD, <span style="color:#4e9a06">&#34;/proc/self/status&#34;</span>, O_RDONLY<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">4</span>
</span></span><span style="display:flex;"><span>read<span style="color:#ce5c00;font-weight:bold">(</span>4, <span style="color:#4e9a06">&#34;Name:\tfeishu\nUmask:\t0002\nState:\t&#34;</span>..., 1024<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1024</span>
</span></span></code></pre></div><p>我想知道 fd 4 代表了什么，执行 <code>sudo lsof -d 4 -a -p 8261</code>，可以看到它是我的电脑和 <code>220.181.131.241</code> 建立的一个 https 连接。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ø&gt; sudo lsof -d <span style="color:#0000cf;font-weight:bold">4</span> -a -p <span style="color:#0000cf;font-weight:bold">8261</span>
</span></span><span style="display:flex;"><span>COMMAND  PID      USER   FD   TYPE  DEVICE SIZE/OFF NODE NAME
</span></span><span style="display:flex;"><span>feishu  <span style="color:#0000cf;font-weight:bold">8261</span> xuyundong    4u  IPv4 <span style="color:#0000cf;font-weight:bold">2613086</span>      0t0  TCP 192.168.252.88:35810-&gt;220.181.131.241:https <span style="color:#ce5c00;font-weight:bold">(</span>ESTABLISHED<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span></code></pre></div><h2 id="查看端口占用">查看端口占用</h2>
<p>有时候我们启动程序的时候，发现端口被占用了，可以用 <code>lsof -i:xxx</code> 来查看端口被哪个进程占用了，例如:</p>
<p>下面这条命令显示 3306 端口被 <code>360702</code> 和 <code>360709</code> 两个进程占用了。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ø&gt; sudo lsof -i:3306
</span></span><span style="display:flex;"><span>COMMAND      PID USER   FD   TYPE  DEVICE SIZE/OFF NODE NAME
</span></span><span style="display:flex;"><span>docker-pr <span style="color:#0000cf;font-weight:bold">360702</span> root    4u  IPv4 <span style="color:#0000cf;font-weight:bold">1842886</span>      0t0  TCP *:mysql <span style="color:#ce5c00;font-weight:bold">(</span>LISTEN<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>docker-pr <span style="color:#0000cf;font-weight:bold">360709</span> root    4u  IPv6 <span style="color:#0000cf;font-weight:bold">1842889</span>      0t0  TCP *:mysql <span style="color:#ce5c00;font-weight:bold">(</span>LISTEN<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span></code></pre></div><h2 id="查看容器的网络调用">查看容器的网络调用</h2>
<h3 id="构建镜像">构建镜像</h3>
<ul>
<li>download.py</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#!/usr/bin/env python3</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># -*- coding: utf-8 -*-&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">requests</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">resp</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">requests</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;https://releases.ubuntu.com/22.04.2/ubuntu-22.04.2-desktop-amd64.iso?_ga=2.131295240.668169970.1684741981-917190618.1681460407&#39;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">resp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">status_code</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><ul>
<li>Dockerfile</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#4e9a06"> python:3.10</span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#204a87;font-weight:bold">RUN</span> pip install requests<span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#204a87;font-weight:bold">COPY</span> download.py /download.py<span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#204a87;font-weight:bold">ENTRYPOINT</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;python&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;/download.py&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#a40000">
</span></span></span></code></pre></div><p>准备上述两个文件，然后执行</p>
<pre tabindex="0"><code>docker build -t test_download .
</code></pre><p>构建我们用于调试的镜像, <code>test_download</code> 。</p>
<h3 id="启动阻塞的容器">启动阻塞的容器</h3>
<p>执行以下命令，启动一个阻塞在网络请求中的容器。</p>
<pre tabindex="0"><code>docker run --rm test_download
</code></pre><blockquote>
<p><strong>Note</strong>:</p>
<p>这个例子不太好，因为 <code>releases.ubuntu.com</code> 还比较健康，会持续地返回内容，现实中我们遇到的情况是，服务器完全不返回内容，客户端也没有设置超时时间，完全处于阻塞的状态。</p>
</blockquote>
<h3 id="查找容器的-pid">查找容器的 pid</h3>
<p>根据容器的 ID, 我们通过 <code>docker inspect &lt;id&gt;| rg -i pid</code> 可以获得容器的进程 ID</p>
<p>如果你使用的是 containerd, 可以使用 <code>crictl inspect &lt;id&gt; | rg -i pid</code></p>
<pre tabindex="0"><code>ø&gt; docker ps
CONTAINER ID   IMAGE           COMMAND                 CREATED          STATUS          PORTS     NAMES
bf5846384913   test_download   &#34;python /download.py&#34;   37 seconds ago   Up 36 seconds             friendly_wozniak
ø&gt; docker inspect bf5846384913 | rg -i pid
            &#34;Pid&#34;: 726678,
            &#34;PidMode&#34;: &#34;&#34;,
            &#34;PidsLimit&#34;: null,
</code></pre><h3 id="利用-strace-查看进程的状态">利用 strace 查看进程的状态</h3>
<p>从 strace 的输出中可以看到，进程一直在从 3 号 fd 上读取数据</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>root@Macmini:~# strace -p <span style="color:#0000cf;font-weight:bold">726678</span>
</span></span><span style="display:flex;"><span>strace: Process <span style="color:#0000cf;font-weight:bold">726678</span> attached
</span></span><span style="display:flex;"><span>read<span style="color:#ce5c00;font-weight:bold">(</span>3, <span style="color:#4e9a06">&#34;Z\263\351\331\315\17\330\205\222\361\21\235&#39;Kp\301w\256\365|\275K\326y\350@\305\300\325\262\fk&#34;</span>..., 13131<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1448</span>
</span></span><span style="display:flex;"><span>read<span style="color:#ce5c00;font-weight:bold">(</span>3, <span style="color:#4e9a06">&#34;\317GKJ\324O)1\5\272\\\&#34;\24\360s\177\263\223#\376\360\35\360\226\240\214mf\374\243\222\335&#34;</span>..., 11683<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">11683</span>
</span></span><span style="display:flex;"><span>read<span style="color:#ce5c00;font-weight:bold">(</span>3, <span style="color:#4e9a06">&#34;\27\3\3@\21&#34;</span>, 5<span style="color:#ce5c00;font-weight:bold">)</span>               <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">5</span>
</span></span><span style="display:flex;"><span>read<span style="color:#ce5c00;font-weight:bold">(</span>3, <span style="color:#4e9a06">&#34;\22c\367U@\243\377\325\255\n0\376\79J\244\v9O4\233Kq\0233\304k\6\356dy\20&#34;</span>..., 16401<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">16401</span>
</span></span><span style="display:flex;"><span>read<span style="color:#ce5c00;font-weight:bold">(</span>3, <span style="color:#4e9a06">&#34;\27\3\3@\21&#34;</span>, 5<span style="color:#ce5c00;font-weight:bold">)</span>               <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">5</span>
</span></span><span style="display:flex;"><span>read<span style="color:#ce5c00;font-weight:bold">(</span>3, <span style="color:#4e9a06">&#34;[\244K\30\7\30?[\210\313\364\335\t\321&gt;l\270\2\365\262\307|\376\211.\376\342%\361\34\31\246&#34;</span>..., 16401<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">16401</span>
</span></span><span style="display:flex;"><span>read<span style="color:#ce5c00;font-weight:bold">(</span>3, <span style="color:#4e9a06">&#34;\27\3\3@\21&#34;</span>, 5<span style="color:#ce5c00;font-weight:bold">)</span>               <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">5</span>
</span></span><span style="display:flex;"><span>read<span style="color:#ce5c00;font-weight:bold">(</span>3, <span style="color:#4e9a06">&#34;\335\373\354\320:SF\244o#\244\377Ll\21\366AT\374vgYD\2418\305\340\313||\243;&#34;</span>..., 16401<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">16401</span>
</span></span><span style="display:flex;"><span>read<span style="color:#ce5c00;font-weight:bold">(</span>3, <span style="color:#4e9a06">&#34;\27\3\3@\21&#34;</span>, 5<span style="color:#ce5c00;font-weight:bold">)</span>               <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">5</span>
</span></span><span style="display:flex;"><span>read<span style="color:#ce5c00;font-weight:bold">(</span>3, <span style="color:#4e9a06">&#34;X \300\240\252IoZ\352W</span>$<span style="color:#4e9a06">\255\266\324\304q\306\23\226-b\212\300\271\222pI\270\33\tcn&#34;</span>..., 16401<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">16401</span>
</span></span><span style="display:flex;"><span>read<span style="color:#ce5c00;font-weight:bold">(</span>3, <span style="color:#4e9a06">&#34;\27\3\3@\21&#34;</span>, 5<span style="color:#ce5c00;font-weight:bold">)</span>               <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">5</span>
</span></span><span style="display:flex;"><span>read<span style="color:#ce5c00;font-weight:bold">(</span>3, <span style="color:#4e9a06">&#34;\213\331\225\331b\2405\204\f\213\32\r\250;\250\326.\4l\221\230^0\272{\317\32he\262V\223&#34;</span>..., 16401<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">16401</span>
</span></span><span style="display:flex;"><span>brk<span style="color:#ce5c00;font-weight:bold">(</span>0x55fba8f48000<span style="color:#ce5c00;font-weight:bold">)</span>                     <span style="color:#ce5c00;font-weight:bold">=</span> 0x55fba8f48000
</span></span><span style="display:flex;"><span>read<span style="color:#ce5c00;font-weight:bold">(</span>3, <span style="color:#4e9a06">&#34;\27\3\3@\21&#34;</span>, 5<span style="color:#ce5c00;font-weight:bold">)</span>               <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">5</span>
</span></span><span style="display:flex;"><span>read<span style="color:#ce5c00;font-weight:bold">(</span>3, <span style="color:#4e9a06">&#34;\4\317\362`-R}\360\&#34;\266nZ\33\261s,\340\345\371\300;]\347\30\237\344\305\235m\360j\357&#34;</span>..., 16401<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">16401</span>
</span></span><span style="display:flex;"><span>read<span style="color:#ce5c00;font-weight:bold">(</span>3, <span style="color:#4e9a06">&#34;\27\3\3@\21&#34;</span>, 5<span style="color:#ce5c00;font-weight:bold">)</span>               <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">5</span>
</span></span><span style="display:flex;"><span>read<span style="color:#ce5c00;font-weight:bold">(</span>3, <span style="color:#4e9a06">&#34;1v\355\312]nG\347\240\4\210\350\241\34\257\333\307\233z\261\0\6\307\2234n\21V\27\305\272\371&#34;</span>..., 16401<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">16401</span>
</span></span><span style="display:flex;"><span>read<span style="color:#ce5c00;font-weight:bold">(</span>3, <span style="color:#4e9a06">&#34;\27\3\3@\21&#34;</span>, 5<span style="color:#ce5c00;font-weight:bold">)</span>               <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">5</span>
</span></span></code></pre></div><h3 id="利用-lsof-查看-fd-详细信息">利用 lsof 查看 fd 详细信息</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>nsenter -n -t <span style="color:#0000cf;font-weight:bold">726678</span> lsof -d <span style="color:#0000cf;font-weight:bold">3</span> -a -p <span style="color:#0000cf;font-weight:bold">726678</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>root@Macmini:~# nsenter -n -t <span style="color:#0000cf;font-weight:bold">726678</span> lsof -d <span style="color:#0000cf;font-weight:bold">3</span> -a -p <span style="color:#0000cf;font-weight:bold">726678</span>
</span></span><span style="display:flex;"><span>COMMAND    PID USER   FD   TYPE  DEVICE SIZE/OFF NODE NAME
</span></span><span style="display:flex;"><span>python  <span style="color:#0000cf;font-weight:bold">726678</span> root    3u  IPv4 <span style="color:#0000cf;font-weight:bold">9813984</span>      0t0  TCP 172.17.0.2:55378-&gt;https-services.aerodent.canonical.com:https <span style="color:#ce5c00;font-weight:bold">(</span>ESTABLISHED<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span></code></pre></div><p>可以看到，3号fd 是一个TCP 连接，本地的 <code>172.17.0.2:55378</code> 连接了远端的 <code>https-services.aerodent.canonical.com:https</code></p>
<blockquote>
<p><strong>Note</strong></p>
<p>如果我们不加 nsenter -n -t <pid> 来切换 network namespace 的话，lsof 输出的信息中就没有详细的客户端和服务端的地址了</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>root@Macmini:~# lsof -d <span style="color:#0000cf;font-weight:bold">3</span> -a -p <span style="color:#0000cf;font-weight:bold">729160</span>
</span></span><span style="display:flex;"><span>COMMAND    PID USER   FD   TYPE DEVICE SIZE/OFF    NODE NAME
</span></span><span style="display:flex;"><span>python  <span style="color:#0000cf;font-weight:bold">729160</span> root    3u  sock    0,8      0t0 <span style="color:#0000cf;font-weight:bold">9829458</span> protocol: TCP
</span></span></code></pre></div><h2 id="参考链接">参考链接</h2>
<ul>
<li><a href="https://linux.die.net/man/8/lsof">man lsof</a></li>
</ul>

</div>



    
	
  

    
	
  



          </main>
        </div>
      </div>
      <footer class="td-footer row d-print-none">
  <div class="container-fluid">
    <div class="row mx-md-2">
      <div class="col-6 col-sm-4 text-xs-center order-sm-2">
        
        
        
      </div>
      <div class="col-6 col-sm-4 text-end text-xs-center order-sm-3">
        
        
        
<ul class="td-footer__links-list">
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="GitHub" aria-label="GitHub">
    <a target="_blank" rel="noopener" href="https://github.com/bwangelme/" aria-label="GitHub">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="td-footer__copyright-etc col-12 col-sm-4 text-center py-2 order-sm-2">
        <span>&copy; 2023 力行近乎仁，好问近乎智，知耻近乎勇 </span>
        <span class="ms-1"><a href="https://policies.google.com/privacy" target="_blank" rel="noopener"></a></span>
        
      </div>
    </div>
  </div>
</footer>
    </div>
    
  <script src="/647/js/main.min.6f5832c0d01e88c997eeb57e6b773ea3e1ac128fdf53739b3c750242f2355881.js" integrity="sha256-b1gywNAeiMmX7rV&#43;a3c&#43;o&#43;GsEo/fU3ObPHUCQvI1WIE=" crossorigin="anonymous"></script>
<script src='/647/js/prism.js'></script>
<script src='/647/js/tabpane-persist.js'></script>

  </body>
</html>
