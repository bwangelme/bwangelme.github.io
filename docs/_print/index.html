<!doctype html>
<html itemscope itemtype="http://schema.org/WebPage" lang="cn" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.115.2">
<link rel="canonical" type="text/html" href="https://bwangelme.github.io/647/docs/">
<link rel="alternate" type="application/rss&#43;xml" href="https://bwangelme.github.io/647/docs/index.xml">
<meta name="robots" content="noindex, nofollow">


<link rel="shortcut icon" href="/647/favicons/favicon.ico" >
<link rel="apple-touch-icon" href="/647/favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="/647/favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="/647/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/647/favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="/647/favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="/647/favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="/647/favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/647/favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="/647/favicons/android-192x192.png" sizes="192x192">

<title>Documentation | 647 Universe</title>
<meta name="description" content="宇宙很大，生活更大，也许以后还有缘相见">
<meta property="og:title" content="Documentation" />
<meta property="og:description" content="宇宙很大，生活更大，也许以后还有缘相见" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://bwangelme.github.io/647/docs/" /><meta property="og:site_name" content="647号宇宙" />
<meta itemprop="name" content="Documentation">
<meta itemprop="description" content="宇宙很大，生活更大，也许以后还有缘相见"><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Documentation"/>
<meta name="twitter:description" content="宇宙很大，生活更大，也许以后还有缘相见"/>




<link rel="preload" href="/647/scss/main.min.291c723daa8f2fb6b09f56ac9a2ca71406607a4268e1fe586dddad1a8583b4e7.css" as="style">
<link href="/647/scss/main.min.291c723daa8f2fb6b09f56ac9a2ca71406607a4268e1fe586dddad1a8583b4e7.css" rel="stylesheet" integrity="">

<script
  src="https://code.jquery.com/jquery-3.6.3.min.js"
  integrity="sha512-STof4xm1wgkfm7heWqFJVn58Hm3EtS31XFaagaa8VMReCXAkQnJZ+jEy8PCC/iT18dFy95WcExNHFTqLyp72eQ=="
  crossorigin="anonymous"></script>
<link rel="stylesheet" href="/647/css/prism.css"/>

  </head>
  <body class="td-section">
    <header>
      <nav class="td-navbar navbar-dark js-navbar-scroll">
<div class="container-fluid flex-column flex-md-row">
  <a class="navbar-brand" href="/647/"><span class="navbar-brand__logo navbar-logo"><svg id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 500 500" style="enable-background:new 0 0 500 500"><g><path style="fill:#fff" d="M116.8525 421.9722c-5.7041.0-10.3442-4.3127-10.3442-9.6129V88.183c0-5.3002 4.6401-9.6117 10.3442-9.6117H320.858c3.0347.0 9.3959.5498 11.7506 2.6302l.3545.3442 58.905 63.2912c2.3101 2.491 2.9202 8.4928 2.9202 11.3184v256.2039c0 5.3002-4.6407 9.6129-10.3436 9.6129H116.8525z"/><g><g><g><path style="fill:#767676" d="M384.4445 423.2066H116.852c-6.3839.0-11.5786-4.8658-11.5786-10.8474V88.1831c0-5.9804 5.1947-10.8461 11.5786-10.8461h204.0062c.377.0 9.2786.0329 12.568 2.9389l.3947.3833 58.9508 63.337c3.2135 3.4652 3.2514 11.7924 3.2514 12.1593v256.2036C396.0231 418.3408 390.8284 423.2066 384.4445 423.2066zM116.5079 411.9189c.0848.0278.1999.0531.3441.0531h267.5925c.1442.0.2581-.0253.3441-.0531V156.1556c-.0076-.9033-.3593-3.7347-.7034-5.0037l-57.6527-61.9416c-1.4651-.3176-4.4533-.6389-5.5742-.6389H116.852c-.143.0-.2594.024-.3441.0531V411.9189zm267.4533-261.149zM327.0321 89.371v.0013V89.371z"/></g></g></g><g><g><path style="fill:#5b7fc0" d="M189.0874 210.1754l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4473C177.5953 212.627 183.0601 210.1742 189.0874 210.1754zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 234.1722 197.0804 232.033z"/><path style="opacity:.3;fill:#fff" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/><g><defs><path id="SVGID_1_" d="M194.7376 237.6875c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 234.2399 196.1861 236.239 194.7376 237.6875z"/></defs><clipPath id="SVGID_2_"><use xlink:href="#SVGID_1_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_2_);fill:#fff" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/><path style="opacity:.13;clip-path:url(#SVGID_2_);fill:#020202" d="M190.0704 225.0237c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 225.7247 191.9774 225.0237 190.0704 225.0237z"/></g><g><defs><path id="SVGID_3_" d="M189.0898 210.176c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 212.6276 183.0612 210.176 189.0898 210.176zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 236.239 197.0839 234.2399 197.0839 232.0372z"/></defs><clipPath id="SVGID_4_"><use xlink:href="#SVGID_3_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_4_);fill:#5b7fc0" d="M172.6595 215.6045c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8475-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 209.1953 176.6171 211.647 172.6595 215.6045z"/></g></g><rect x="198.8952" y="225.1043" style="fill:#5b7fc0" width="122.6266" height="13.8671"/></g><g><path style="fill:#d95140" d="M189.0874 155.7611l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.0249 2.454-11.4897 6.4116-15.4473C177.5953 158.2128 183.0601 155.7599 189.0874 155.7611zm7.993 21.8577c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.2508 181.7667 197.0816 179.758 197.0804 177.6188z"/><path style="opacity:.3;fill:#fff" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/><g><defs><path id="SVGID_5_" d="M194.7376 183.2733c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 179.8256 196.1861 181.8248 194.7376 183.2733z"/></defs><clipPath id="SVGID_6_"><use xlink:href="#SVGID_5_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_6_);fill:#fff" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/><path style="opacity:.13;clip-path:url(#SVGID_6_);fill:#020202" d="M190.0704 170.6095c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9546.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.663-2.8588-6.116.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C193.7885 171.3104 191.9774 170.6095 190.0704 170.6095z"/></g><g><defs><path id="SVGID_7_" d="M189.0898 155.7617c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8066-21.8612-21.8613.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 158.2134 183.0612 155.7617 189.0898 155.7617zm7.9941 21.8613c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 181.8248 197.0839 179.8256 197.0839 177.623z"/></defs><clipPath id="SVGID_8_"><use xlink:href="#SVGID_7_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_8_);fill:#d95140" d="M172.6595 161.1903c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 154.7811 176.6171 157.2327 172.6595 161.1903z"/></g><rect x="198.8952" y="170.69" style="fill:#d95140" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#56a55c" d="M189.5379 264.6147l.0012-.0012c7.7751.0012 15.0294 4.1862 18.932 10.9235 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3304-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032-5.8394.0-11.3281-2.2733-15.458-6.4032-4.13-4.13-6.4032-9.6186-6.4056-15.4628.0012-6.0249 2.454-11.4897 6.4116-15.4472C178.0458 267.0663 183.5105 264.6135 189.5379 264.6147zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6538 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403C196.7013 290.6202 197.5321 288.6115 197.5309 286.4723z"/><path style="opacity:.3;fill:#fff" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/><g><defs><path id="SVGID_9_" d="M195.1881 292.1268c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.9989 7.9942-7.9941 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.5344 288.6792 196.6366 290.6783 195.1881 292.1268z"/></defs><clipPath id="SVGID_10_"><use xlink:href="#SVGID_9_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_10_);fill:#fff" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/><path style="opacity:.13;clip-path:url(#SVGID_10_);fill:#020202" d="M190.5209 279.463c-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7446-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9941 2.3802-1e-4 4.616 1.0833 6.1218 2.8788C194.239 280.164 192.4279 279.463 190.5209 279.463z"/></g><g><defs><path id="SVGID_11_" d="M189.5403 264.6153c7.7763.0 15.0283 4.1826 18.926 10.9151 1.9201 3.3135 2.9377 7.0987 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8613-12.0547.0024-21.8636-9.8065-21.8612-21.8613.0-6.0285 2.4516-11.492 6.4116-15.452C178.0482 267.0669 183.5117 264.6153 189.5403 264.6153zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9941.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.6366 290.6783 197.5344 288.6792 197.5344 286.4765z"/></defs><clipPath id="SVGID_12_"><use xlink:href="#SVGID_11_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_12_);fill:#56a55c" d="M173.11 270.0439c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8613 12.0547.0024 21.8636-9.797 21.8613-21.8613.0024-3.8474-1.0151-7.6326-2.9353-10.9462-3.8977-6.7325-11.1497-10.9151-18.926-10.9151C182.5311 263.6346 177.0676 266.0863 173.11 270.0439z"/></g></g><rect x="199.3456" y="279.5436" style="fill:#56a55c" width="122.6266" height="13.8671"/></g><g><g><path style="fill:#f1bc42" d="M189.0874 318.7208l.0012-.0012c7.7751.0012 15.0295 4.1862 18.932 10.9234 1.9177 3.3159 2.9305 7.1011 2.9293 10.9378.0 5.8394-2.2733 11.3305-6.4032 15.4604-4.1288 4.1288-9.6186 6.4032-15.458 6.4032s-11.328-2.2733-15.458-6.4032-6.4032-9.6186-6.4056-15.4628c.0012-6.025 2.454-11.4897 6.4116-15.4472C177.5953 321.1724 183.0601 318.7196 189.0874 318.7208zm7.993 21.8576c.0012-1.4042-.3687-2.7868-1.063-3.9887-1.4293-2.4684-4.0833-3.9995-6.9299-4.0019-4.4077.0024-7.993 3.5877-7.993 7.993.0 2.1356.832 4.1431 2.3427 5.6539 1.5083 1.5083 3.5159 2.3403 5.6503 2.3415 2.1356.0 4.1443-.8308 5.6539-2.3403S197.0816 342.7176 197.0804 340.5784z"/><path style="opacity:.3;fill:#fff" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/><g><defs><path id="SVGID_13_" d="M194.7376 346.2329c-1.4461 1.4461-3.4452 2.3439-5.6479 2.3439-4.4077-.0024-7.9918-3.5865-7.9942-7.9942.0024-4.4125 3.5937-7.999 7.9942-7.9942 2.8443.0 5.497 1.5323 6.924 3.9983.6991 1.2067 1.0702 2.5881 1.0702 3.9959C197.0839 342.7853 196.1861 344.7844 194.7376 346.2329z"/></defs><clipPath id="SVGID_14_"><use xlink:href="#SVGID_13_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_14_);fill:#fff" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/><path style="opacity:.13;clip-path:url(#SVGID_14_);fill:#020202" d="M190.0704 333.5691c-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0011 1.9547.7088 3.7452 1.8782 5.1354-1.7447-1.4674-2.8575-3.6631-2.8588-6.1161.0024-4.4125 3.5936-7.999 7.9942-7.9942 2.3802-1e-4 4.616 1.0834 6.1218 2.8788C193.7885 334.2701 191.9774 333.5691 190.0704 333.5691z"/></g><g><defs><path id="SVGID_15_" d="M189.0898 318.7214c7.7763.0 15.0283 4.1826 18.926 10.915 1.9201 3.3136 2.9377 7.0988 2.9353 10.9462.0024 12.0643-9.8065 21.8636-21.8613 21.8612-12.0547.0024-21.8636-9.8065-21.8612-21.8612.0-6.0285 2.4516-11.4921 6.4116-15.452C177.5977 321.173 183.0612 318.7214 189.0898 318.7214zm7.9941 21.8612c0-1.4078-.3711-2.7892-1.0702-3.9959-1.4269-2.466-4.0797-3.9983-6.924-3.9983-4.4005-.0048-7.9918 3.5817-7.9942 7.9942.0024 4.4077 3.5865 7.9918 7.9942 7.9942 2.2027.0 4.2018-.8978 5.6479-2.3439C196.1861 344.7844 197.0839 342.7853 197.0839 340.5826z"/></defs><clipPath id="SVGID_16_"><use xlink:href="#SVGID_15_" style="overflow:visible"/></clipPath><path style="clip-path:url(#SVGID_16_);fill:#f1bc42" d="M172.6595 324.15c-3.96 3.96-6.4116 9.4235-6.4116 15.452-.0024 12.0547 9.8066 21.8636 21.8613 21.8612 12.0547.0024 21.8636-9.797 21.8613-21.8612.0024-3.8474-1.0151-7.6327-2.9353-10.9462-3.8977-6.7324-11.1497-10.9151-18.926-10.9151C182.0806 317.7407 176.6171 320.1924 172.6595 324.15z"/></g></g><rect x="198.8952" y="333.6497" style="fill:#f1bc42" width="122.6266" height="13.8671"/></g></g></svg></span><span class="navbar-brand__name">647 Universe</span></a>
  <div class="td-navbar-nav-scroll ms-md-auto" id="main_navbar">
    <ul class="navbar-nav">
      <li class="nav-item">
        <a class="nav-link active" href="/647/docs/"><span>Docs</span></a>
      </li>
      </ul>
  </div>
  <div class="d-none d-lg-block">
    
  </div>
</div>
</nav>
    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <main class="col-12 col-md-9 col-xl-8 ps-md-5" role="main">
            




<div class="td-content">
<div class="pageinfo pageinfo-primary d-print-none">
<p>

<a href="#" onclick="print();return false;"></a>.
</p><p>
<a href="/647/docs/"></a>.
</p>
</div>



<h1 class="title">Documentation</h1>





    <ul>
    
  
  
  
  

  
    
    
	
<li>1: <a href="#pg-871466015f6090c36613870230e285c6">算法</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>1.1: <a href="#pg-a0f39954774aeefe139f67aba0845930">Go与数据结构之二叉搜索树</a></li>


    
  
    
    
	
<li>1.2: <a href="#pg-9be646f123e40dbca79fc8fe0683405b">算法复杂度小记</a></li>


    
  

    </ul>
    
  
    
    
	
<li>2: <a href="#pg-b5fadaa3f5f96e8c51757851d7668a4e">Redis</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>2.1: <a href="#pg-9f184c796063902888d119a9e9dbf239">Redis 主从同步细节</a></li>


    
  
    
    
	
<li>2.2: <a href="#pg-5e80ba3bff85aef5c731bcf3ecb0922c">Redis 源码阅读之 dict </a></li>


    
  
    
    
	
<li>2.3: <a href="#pg-24908c465f52816f8bd5bc366e5a5645">Redis Sort 命令简介</a></li>


    
  

    </ul>
    
  
    
    
	
<li>3: <a href="#pg-af68ff2ed3e54c426ada6b1cb8e61eaa">Kafka</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>3.1: <a href="#pg-c7b3f27b65643bf045308409a82ca6b8">Consumer</a></li>


    
  
    
    
	
<li>3.2: <a href="#pg-b0db364c520cdda052412caee9f7bb79">Broker</a></li>


    
  

    </ul>
    
  
    
    
	
<li>4: <a href="#pg-7eb9a6396b5cbd586e9b014377b38023">K8S</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>4.1: <a href="#pg-656e8e58e57239aefabf9b0ac3db78e9">Pod 状态笔记</a></li>


    
  
    
    
	
<li>4.2: <a href="#pg-aaf94f93d4f526a149b5434d89980c98">K8S 中观察 CPU Throttling 情况的指标</a></li>


    
  
    
    
	
<li>4.3: <a href="#pg-ed5c1d67de01b3a316614ab9172e7934">K8s Pod 如何结束</a></li>


    
  

    </ul>
    
  
    
    
	
<li>5: <a href="#pg-4aaad1b9f7ee3c127b91ab5b259ce456">Container</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>5.1: <a href="#pg-5dd2bc857390538c171fb56a14e4efb8">Ubuntu 中 Docker 设置容器中 DNS 服务器的地址</a></li>


    
  
    
    
	
<li>5.2: <a href="#pg-ebcaa5066994bddfb13c8bffcd9addae">从 none 开始，用网桥模式启动容器的网络</a></li>


    
  
    
    
	
<li>5.3: <a href="#pg-b711168a3d768a0c419283a9a611a17f">Ubuntu 下安装 Containerd 及配置代理</a></li>


    
  
    
    
	
<li>5.4: <a href="#pg-72ba781c964286a98ded46d175dfee82">Docker 客户端连接远程 Docker Daemon</a></li>


    
  

    </ul>
    
  
    
    
	
<li>6: <a href="#pg-5b8be070e024dee1528ca4106a3ef913">HTTP</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>6.1: <a href="#pg-674980be1abe17a6cece69ef854e0dca">HTTP 协议中带下划线的 header 说明</a></li>


    
  
    
    
	
<li>6.2: <a href="#pg-aed2ff328139f1dc7b767eb1eb9e5077">Nginx proxy_set_header 默认会覆盖上一层的设置</a></li>


    
  
    
    
	
<li>6.3: <a href="#pg-b21d7a632564e90b6152ef79c335936f">CentOS 下编译安装 Nginx</a></li>


    
  

    </ul>
    
  
    
    
	
<li>7: <a href="#pg-61067b04bc7fd549be32943b40ec4eac">Prometheus</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>7.1: <a href="#pg-22b5afb7c5e4cb0f2b2c329578af5ecd">Statsd Exporter 如何跳过 prom 的指标检查</a></li>


    
  

    </ul>
    
  
    
    
	
<li>8: <a href="#pg-e5a0a7efb242ec26125e2066bad47362">编码</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>8.1: <a href="#pg-573e3337b8ecb996b3dee636fc080527">ZigZag 变长整数编码</a></li>


    
  

    </ul>
    
  
    
    
	
<li>9: <a href="#pg-0d3382c151725c975fa7e12e83c234f9">WireShark</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>9.1: <a href="#pg-228f2acd9c0ff088f1229559fcdd6503">利用 VirtualBox 和 Ubuntu 22 重现抓包实验</a></li>


    
  

    </ul>
    
  
    
    
	
<li>10: <a href="#pg-fb8915bbd249021082eebe2c7dfd52f0">Golang</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>10.1: <a href="#pg-c374734838a7da2e3834d1091952177f">泛型</a></li>


    
  
    
    
	
<li>10.2: <a href="#pg-8aa7d3f7c05390359a87acf37c95a33b">YAML</a></li>


    
  
    
    
	
<li>10.3: <a href="#pg-52ff3e8194a92d6261809dbeed07036e">Logrus 添加预设字段</a></li>


    
  
    
    
	
<li>10.4: <a href="#pg-16c718411b1484a4cad9a403ef36fc6a">Golang Build 出错: error obtaining VCS status: exit status 128</a></li>


    
  
    
    
	
<li>10.5: <a href="#pg-83df69ae1444d01a6f7c0a195b54857e">pkg/errors 和 go1.13 中 errors 库发展历史</a></li>


    
  
    
    
	
<li>10.6: <a href="#pg-434a02cf1a3ee72f31be04b770f0fabb">Golang 的版本发布计划</a></li>


    
  
    
    
	
<li>10.7: <a href="#pg-3e6373393d3b5fc1fcfcf9263b1f83af">Go gcflags/ldflags 的说明</a></li>


    
  
    
    
	
<li>10.8: <a href="#pg-411c7d44b39c2c01f271102f90652135">Go proxy 的说明</a></li>


    
  
    
    
	
<li>10.9: <a href="#pg-5e7f1bf4777000a4a638a29b3b04d48f">Golang 链接时注入额外信息</a></li>


    
  
    
    
	
<li>10.10: <a href="#pg-495e45c0b281c859ecdd31687f35d51b">《Golang Error》学习笔记</a></li>


    
  
    
    
	
<li>10.11: <a href="#pg-6be775a3d57f960eb07e45a142768f29">Go 的调度模型学习笔记</a></li>


    
  
    
    
	
<li>10.12: <a href="#pg-e9992c55d10cbbee93c95c796a5e0152">Go 并发模式之发布订阅模型</a></li>


    
  
    
    
	
<li>10.13: <a href="#pg-635fed7c7f961ced2f2b68e493f04ffb">关于线程同步操作的一道面试题</a></li>


    
  
    
    
	
<li>10.14: <a href="#pg-e7414abf063a165b8718b37f17cb4f2f">Go 调度器的一个无法执行陷阱</a></li>


    
  
    
    
	
<li>10.15: <a href="#pg-fbbcf89e72ac3f247786060b50fa9d08">Go Panic 的触发及恢复过程</a></li>


    
  
    
    
	
<li>10.16: <a href="#pg-4b954ae7a79512193186d57a0ec102ff">线程同步操作面试题使用锁的解法</a></li>


    
  
    
    
	
<li>10.17: <a href="#pg-770a44637da1a99d5af0d32fd0c958e9">Go 的测试</a></li>


    
  
    
    
	
<li>10.18: <a href="#pg-c7d2056c34effb010b85e592bf9d77d9">Go 模板</a></li>


    
  
    
    
	
<li>10.19: <a href="#pg-c6e65801f450a5190e19f70c05c579be">Go mod 说明</a></li>


    
  
    
    
	
<li>10.20: <a href="#pg-5d60a98a1071c1eb27363bb8fd0863bf">Go 语言的 Type Switch 语句解析</a></li>


    
  
    
    
	
<li>10.21: <a href="#pg-05bc77af5135b5de6472208f6d8b18f0">Go的并发编程简述</a></li>


    
  
    
    
	
<li>10.22: <a href="#pg-9c00886a50ca7b0f720c54623a097403">Go 的反射包浅析</a></li>


    
  

    </ul>
    
  
    
    
	
<li>11: <a href="#pg-f0a22a813c843322c0d360d952e434ce">性能分析</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>11.1: <a href="#pg-38dd3702bb1bcc7da2f55f43923b479a">QPS 和 RT 的关系</a></li>


    
  

    </ul>
    
  
    
    
	
<li>12: <a href="#pg-f65393dbe42ee15e5a5af9e8946cd970">Thrift</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>12.1: <a href="#pg-1af692bb57d127b768eb69b3abc8a667">Thrift golang client 如何设置超时时间</a></li>


    
  
    
    
	
<li>12.2: <a href="#pg-b127652654fb8cc62d6983427adc109f">Thrift 协议学习笔记</a></li>


    
  
    
    
	
<li>12.3: <a href="#pg-1bb16dc0ca8a634867ed72c7e903ba28">Thrft</a></li>


    
  
    
    
	
<li>12.4: <a href="#pg-d3ce439f30c5ecaccd3e7225d6be37c5">翻译《Chapter 1. Introduction to Apache Thrift》</a></li>


    
  

    </ul>
    
  
    
    
	
<li>13: <a href="#pg-e3393de7e8466911640490b15485a33d">规范</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>13.1: <a href="#pg-e0e47e08b609b222268e029cf0817880">日期和时间格式</a></li>


    
  

    </ul>
    
  
    
    
	
<li>14: <a href="#pg-546aa9afbb590e86cfb9df263df9d01c">编辑器</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>14.1: <a href="#pg-e9fb0115d808edb36ba1a3f492e95c4d">Pycharm</a></li>


    
  

    </ul>
    
  
    
    
	
<li>15: <a href="#pg-5990d373ac824b52e97a76c2b3e2ff2c">Linux</a></li>


    
    <ul>
        
  
  
  
  

  
    
    
	
<li>15.1: <a href="#pg-1c2b211e34ea807b66d53c40bac236f2">curl</a></li>


    
  
    
    
	
<li>15.2: <a href="#pg-a5f545a950366d730141f62b977f5c24">lsof</a></li>


    
  
    
    
	
<li>15.3: <a href="#pg-69dc1da95bd41a25bf26e181c6ed42e5">DNS</a></li>


    
  
    
    
	
<li>15.4: <a href="#pg-634110a9992b6264c18b7b4beda6f789">在 Ubuntu 22.04 上搭建 NFS Server</a></li>


    
  
    
    
	
<li>15.5: <a href="#pg-d666840fe7c4f359e7566250aad67c80">查看信号的快捷键</a></li>


    
  
    
    
	
<li>15.6: <a href="#pg-729348d4b27273c38fd9756aca09119c">修复 Ubuntu 中 chrome vimium-c 插件失效的问题</a></li>


    
  

    </ul>
    
  

    </ul>


<div class="content">
      <div><a id="td-block-0" class="td-offset-anchor"></a></div>
<section class="row td-box td-box--0 td-box--height-auto">
<div class="col">
<div class="container">
<p class="h1 text-center">宇宙很大，生活更大，也许以后还有缘相见</p>
</div>
</div>
</section>

</div>
</div>


  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-871466015f6090c36613870230e285c6">1 - 算法</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-a0f39954774aeefe139f67aba0845930">1.1 - Go与数据结构之二叉搜索树</h1>
    
	<p><strong>简介</strong>: 利用Go语言实现二叉搜索树并为其编写单元测试</p>
<h2 id="说明">说明</h2>
<p>本文是我读了<a href="https://book.douban.com/subject/1139426/">《数据结构与算法分析 - C语言描述》</a>后总结的二叉搜索树的实现，在本文中涉及到的代码都可以在我的Github仓库 <a href="https://github.com/bwangel23/LeetCode/tree/daic/4chapter/searchtree">bwangel23/LeetCode</a> 中找到。</p>
<h2 id="描述">描述</h2>
<p>对于二叉树中的任意节点X，它的左子树中所有关键字的值小于X的关键字值，而它的右子树中所有关键字值大于X的关键字值，那么这棵树就是一颗二叉搜索树。这也意味着二叉搜索树中的所有节点都可以按照某种方式来排序。</p>
<p>二叉查找树树的平均深度是$O(log N)$</p>
<h2 id="定义">定义</h2>
<p>通过上面的描述，我们了解了二叉搜索树的概念，接下来我们使用 Go 语言来定义二叉搜索树及其上的操作。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">TreeNode</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">elem</span>  <span style="color:#204a87;font-weight:bold">int</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">left</span>  <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">TreeNode</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">right</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">TreeNode</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">MakeEmpty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">tree</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">TreeNode</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">TreeNode</span> <span style="color:#8f5902;font-style:italic">// 清空一棵树或者创造一棵空树
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">FindMin</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">tree</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">TreeNode</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">TreeNode</span>   <span style="color:#8f5902;font-style:italic">// 查找树中最小的节点
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">FindMax</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">tree</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">TreeNode</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">TreeNode</span>   <span style="color:#8f5902;font-style:italic">// 查找树中最大的节点
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">Find</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">elem</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tree</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">TreeNode</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">TreeNode</span>  <span style="color:#8f5902;font-style:italic">// 查找树中某个特定的节点
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">Insert</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">elem</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tree</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">TreeNode</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">TreeNode</span>  <span style="color:#8f5902;font-style:italic">// 向树中插入节点
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">Delete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">elem</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tree</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">TreeNode</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">TreeNode</span>  <span style="color:#8f5902;font-style:italic">// 从树中删除节点
</span></span></span></code></pre></div><p>从上面的定义中我们可以看到，二叉搜索树中的节点是通过<code>TreeNode</code>结构体来定义的，其中<code>elem</code>表示存储在这个树节点中的关键字值，<code>left</code>和<code>right</code>分别代表左右子树。</p>
<h2 id="实现">实现</h2>
<p>在二叉搜索树上我们一共定义了六个操作，接下来我们分别讨论它们的实现</p>
<h3 id="makeempty">MakeEmpty</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 创造一棵空树，或者将一棵搜索树清空
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">MakeEmpty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">tree</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">TreeNode</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">TreeNode</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">tree</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">MakeEmpty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">tree</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">left</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">tree</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">left</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">MakeEmpty</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">tree</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">right</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">tree</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">right</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>MakeEmpty</code>的功能说明:</p>
<ul>
<li>
<p>创建一棵空树: 不像其他一些数据结构中通过一个结构体来定义一棵空树，我们直接通过空指针来定义一棵空树，所以在<code>MakeEmpty</code>尾部我们直接返回了空指针来代表一棵空树。</p>
</li>
<li>
<p>清空一棵树: <code>MakeEmpty</code>函数还可以清空一棵树，由于Go语言中并不需要我们手动管理内存空间，所以删除树节点并不需要释放空间，只需要将指向树节点的指针置为<code>nil</code>即可。</p>
</li>
</ul>
<h3 id="findmin">FindMin</h3>
<p>二叉搜索树的<code>FindMin</code>操作的实现如下所示：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">FindMin</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">tree</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">TreeNode</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">TreeNode</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">tree</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">tree</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">left</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">tree</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">tree</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">left</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">tree</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>这部分功能我们是通过迭代来实现的，由于二叉搜索树中某个树节点的左子树的关键字始终小于这个树节点的关键字值，所以我们只需要一直遍历，找到__最左__的那个树节点，它就是整个树中最小的节点。</p>
<h3 id="findmax">FindMax</h3>
<p>二叉搜索树的<code>FindMax</code>操作的实现如下:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">FindMax</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">tree</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">TreeNode</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">TreeNode</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">tree</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">tree</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">right</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">tree</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">FindMax</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">tree</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">right</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>FindMax</code>的功能我们是通过递归来实现的，从二叉搜索树的特性可知，树节点的右子树中的值始终要比当前节点的值大。所以我们判断只要当前节点有右子树，就去寻找它右子树中的最大值，这样就可以找到二叉搜索树中的最大节点了。</p>
<h3 id="find">Find</h3>
<p>二叉搜索树的<code>Find</code>操作的实现如下:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">Find</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">elem</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tree</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">TreeNode</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">TreeNode</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">tree</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">tree</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">elem</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">elem</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">tree</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">elem</span> <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#000">tree</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">elem</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">Find</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">elem</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tree</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">right</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// 查找节点比当前树节点要小
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">Find</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">elem</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tree</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">left</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>Find</code>操作的功能是通过递归来实现的。判断当前树节点是否是要查找的节点，如果是则返回当前节点。否则，根据目标关键字的值的是否小于当前节点的关键字值分别去当前节点的左子树或右子树中去查找目标节点。</p>
<h3 id="insert">Insert</h3>
<p>二叉搜索树的<code>Insert</code>操作的实现如下:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">Insert</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">elem</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tree</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">TreeNode</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">TreeNode</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">tree</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">tree</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">TreeNode</span><span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">tree</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">left</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">tree</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">right</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">tree</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">elem</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">elem</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">elem</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#000">tree</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">elem</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">tree</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">left</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">Insert</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">elem</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tree</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">left</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">elem</span> <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#000">tree</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">elem</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">tree</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">right</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">Insert</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">elem</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tree</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">right</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// 该节点已经在这颗树中了，我们什么也不做
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">tree</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>从树的根节点开始，判断要插入的值是否比当前节点的要大，如果是的话，插入到当前节点的右子树，否则插入到当前节点的左子树。如果当前节点是一棵空树的话，我们就把目标值插入到当前节点上。</p>
<p><strong>注意</strong>，如果要插入的值已经在树中存在的话，我们什么也不做，我们不会在树中保存两个相同的值。</p>
<h3 id="insert-测试">Insert 测试</h3>
<p>为了验证我们的<code>Insert</code>操作的实现是否正确，我们可以利用 Go 的单元测试来为<code>Insert</code>操作编写测试代码，如下所示:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">TestInsert</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">testing</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">T</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">tree</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">TreeNode</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">tree</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">Insert</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tree</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">tree</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">Insert</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tree</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">tree</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">Insert</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tree</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">tree</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">Insert</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tree</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 构造出来的树
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//    3
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//   / \
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//   1  4
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//    \
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//     2
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">assert</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Equal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">FindMax</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">tree</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">elem</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">assert</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Equal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">FindMin</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">tree</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">elem</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">assert</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Nil</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Find</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tree</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">left</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">assert</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Nil</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Find</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tree</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">right</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>我们按顺序向树中插入<code>3, 4, 2, 1</code>四个节点，最终构造出来的树如下图所示:</p>
<p><strong>树1</strong> <img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2018-03-01-searchtree.png" alt="树1"></p>
<p>为了验证我们构造出来的树是否正确，我们使用<code>FindMax</code>和<code>FindMin</code>方法检验树中的最大值和最小值是否是4和1。
同时，我们也判断了树节点4的左右子树是否都为空。</p>
<h3 id="delete">Delete</h3>
<p>二叉搜索树的删除操作比较复杂，我们需要分情况来讨论:</p>
<ul>
<li>
<p>如果被删除的节点有0个子节点，那我们直接将它删除就好了</p>
</li>
<li>
<p>如果被删除的节点有1个子树，那么我们需要将它的子树移动到当前节点，再将当前节点删除</p>
</li>
</ul>
<p>例如有这样的一棵树2，我们要删除其中的节点3，那么我们需要将其存在的右子树移动到3节点所在的位置，再删除3节点。</p>
<p><strong>树2</strong> <img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2018-03-01-152637.png" alt="树2"></p>
<p>删除3节点后的树如树3所示</p>
<p><strong>树3</strong> <img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2018-03-01-153332.png" alt="树3"></p>
<ul>
<li>如果被删除的节点有两个子树，我们首先要将其右子树中的最小的节点移动到当前节点，然后再删除当前节点。</li>
</ul>
<p>例如上面提到的树2，如果我们要删除2节点，我们首先需要找出其右子树中最小的节点3，将节点3放到节点2所在的位置，如树4所示：</p>
<p><strong>树4</strong> <img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2018-03-01-153658.png" alt="树4"></p>
<p>然后再将原来节点2的右子树中的节点3删除，节点3的删除规则依然准遵循这里讨论的删除规则。由于这里节点3只有一个子树，所以只需要将其右子树移动到节点3所在的位置即可，如树5所示:</p>
<p><strong>树5</strong> <img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2018-03-01-153916.png" alt="树5"></p>
<p>至此，我们就从树2中成功删除了节点2。</p>
<p><code>Delete</code>操作的实现如下所示:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">Delete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">elem</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tree</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">TreeNode</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">TreeNode</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">tree</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatalf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Cannot find element %v in tree %v\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">elem</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tree</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">elem</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#000">tree</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">elem</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">tree</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">left</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">Delete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">elem</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tree</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">left</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">elem</span> <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#000">tree</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">elem</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">tree</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">right</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">Delete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">elem</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tree</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">right</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// 被删除的就是当前节点
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">tree</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">left</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">tree</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">right</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#8f5902;font-style:italic">// 被删除的节点有两个子节点
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#000">tmpNode</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">FindMin</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">tree</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">right</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">tree</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">elem</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">tmpNode</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">elem</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">tree</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">right</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">Delete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">tmpNode</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">elem</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tree</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">right</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#8f5902;font-style:italic">// 被删除的节点有0个或者1个子节点
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">tree</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">left</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">tree</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">tree</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">right</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">tree</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">right</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">tree</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">tree</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">left</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">tree</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">tree</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="delete-测试">Delete 测试</h3>
<p>我为<code>Delete</code>操作编写了两个单元测试，分别测试删除只有有右子树的节点，和删除有两个子树的节点，测试代码如下:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">TestDeleteRight</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">testing</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">T</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">tree</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">TreeNode</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 构造出来的树
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//     6
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//    / \
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//   2  8
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//  /\
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// 1 4
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//   \
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//    5
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">tree</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">Insert</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">6</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tree</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">tree</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">Insert</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tree</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">tree</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">Insert</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tree</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">tree</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">Insert</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tree</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">tree</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">Insert</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tree</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">tree</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">Insert</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tree</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 删除了节点4之后的树
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//     6
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//    / \
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//   2  8
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//  /\
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// 1 5
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">tree</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">Delete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tree</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">assert</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Equal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Find</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tree</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">right</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">elem</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">TestDeleteTwoChild</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">testing</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">T</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">tree</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">TreeNode</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 删除之前的树
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//     6
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//    / \
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//   2  8
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//  /\
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// 1 5
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//  /
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// 3
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// \
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//  4
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">tree</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">Insert</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">6</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tree</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">tree</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">Insert</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tree</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">tree</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">Insert</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tree</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">tree</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">Insert</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tree</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">tree</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">Insert</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tree</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">tree</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">Insert</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tree</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">tree</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">Insert</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tree</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 删除节点2之后的树
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//     6
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//    / \
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//   3  8
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//  /\
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// 1 5
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//  /
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// 4
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">tree</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">Delete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tree</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">node</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">Find</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">tree</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">assert</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Equal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">node</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">left</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">elem</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">assert</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Equal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">node</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">right</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">elem</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-9be646f123e40dbca79fc8fe0683405b">1.2 - 算法复杂度小记</h1>
    
	<p>本文主要书写了本人对于算法复杂度的一些理解，并辅以一些例子进行说明</p>
<h2 id="算法复杂度的概念">算法复杂度的概念</h2>
<h3 id="从一个简单的例子入手">从一个简单的例子入手</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">cal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">n</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">sum</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;=</span><span style="color:#000">n</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">sum</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">sum</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">i</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">sum</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>cal</code> 是一个简单的求和函数, 我们将它的执行时间定义为 \( T(n) \) 。从 CPU 的角度来看，每一行代码都执行着类似的操作 <strong>读数据 - 运算 - 写数据</strong> 。</p>
<p>尽管每行代码编译出来的汇编代码都是不同的(汇编指令的个数也不同)，执行时间也都不一样。但我们这里只是粗略估计，为了简单起见，我们将每一行的代码的执行时间都定义为 <code>unit_time</code>。</p>
<p>第 2, 3 行只执行需要一个 <code>unit_time</code>， 第4, 5行需要执行 N 个 <code>unit_time</code>, 可以得到</p>
<p>$$ T(n) = unit\_time * (1 + 1 + n + n) = unit\_time * (2n + 2) $$</p>
<p><strong>上述分析中，我们忽略了调用函数时入参和返回参数所需的时间</strong></p>
<p>定义 \( f(n) = 2n+2 \)，由于 <code>unit_time</code> 始终都是一个正数，<strong>我们可以得出 <code>cal</code> 函数的执行时间 \( T(n) \) 和每行代码的执行次数 \( f(n) \) 成正比</strong></p>
<p>以上关系我们可以用 字母 <code>O</code> 来表示:</p>
<ul>
<li>\( T(n) = O(f(n)) ，即代码的执行时间 T(n) 和 某个函数 f(n) 成正比。\)</li>
</ul>
<p>但是准确计算某个函数共有多少行代码需要执行，这也是一个困难的工作，我们可以将 <code>O</code> 的定义进一步精确。</p>
<ul>
<li>\( T(n) = O(f(n)) \)，代码的执行时间随着数据规模(<code>n</code>)增长的 <strong>增长趋势</strong>。所以，<code>O</code> 也叫做渐进时间复杂度( asymptotic time complexity)，简称时间复杂度。</li>
</ul>
<h3 id="复杂度的计算理念">复杂度的计算理念</h3>
<ul>
<li>我们不对某个算法进行精确的分析，只需要初略地知道它的 <strong>增长趋势</strong> 就可以了。</li>
<li>平常我们分析算法复杂度的时候，通常有分析最坏情况和平均情况两种选项，由于最坏情况易于分析，所以我们一般分析算法复杂度的最坏情况。</li>
</ul>
<h3 id="复杂度的渐进表示法">复杂度的渐进表示法</h3>
<ul>
<li>上界</li>
</ul>
<p>$$ T(n) = O(f(n)) $$</p>
<p>上述式子表示当N足够大的时候，<code>f(n)</code>函数是<code>T(n)</code>的上界。</p>
<ul>
<li>下界</li>
</ul>
<p>$$ T(n) = \Omega(h(n)) $$</p>
<p>上述式子表示当N足够大的时候，<code>h(n)</code>函数是<code>T(n)</code>的下界。</p>
<ul>
<li>上界和下界同时成立</li>
</ul>
<p>$$ T(n) = \Theta(g(n)) $$</p>
<p>上述式子表示当N足够大的时候，<code>g(n)</code>函数同时是<code>T(n)</code>的上界和下界。</p>
<ul>
<li>在上面三个式子中，<code>T(n)</code>表示的都是某个算法的时间复杂度，它们也可以应用在算法的空间复杂度<code>S(n)</code>上。</li>
<li>一个算法的上界和下界函数可能有无穷多个，为了和现实的情况更贴合，我们在使用上述式子表示算法的复杂度的时候，通常使用 <strong>最小的上界</strong> 和 <strong>最大的下界</strong> 。</li>
</ul>
<h3 id="复杂度的增长趋势比较">复杂度的增长趋势比较</h3>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2022-08-28-073000.png" alt=""></p>
<p>$$ O(1) &lt;  O(\log n) &lt; O(n) &lt; O(n \log n) &lt; O(n^2) &lt; O(n^3) &lt; O(2^n) &lt; O(n!) $$</p>
<p>上面的复杂度量级，我们可以粗略地分成两类， 多项式量级和非多项式量级。其中，非多项式量级只有两个：指数阶 \( O(2^n) \) 和 阶乘阶 \( O(n!) \)</p>
<p>我们把时间复杂度为非多项式量级的算法问题叫做 NP (Non-Deterministic Polynomial，非确定多项式) 问题。</p>
<h2 id="算法复杂度的分析规则">算法复杂度的分析规则</h2>
<h3 id="加法法则">加法法则</h3>
<p><strong>多个复杂度相加，取量级最大的时间复杂度</strong>，这个规则用公式表示为:</p>
<p>$$ T_1(n) = O(f_1(n)), T_2(n) = O(f_2(n)) $$</p>
<p>$$ T_1(n) + T_2(n) = max(O(f_1(n)), O(f_2(n))) $$</p>
<p>由于我们分析算法复杂度的时候主要是分析它的 <strong>增长趋势</strong> ，所以我们只需要分析算法复杂度的 <strong>某个主要趋势</strong> 即可。</p>
<p>有时间复杂度计算公式，</p>
<p>$$ T(n) = O(C_1 * n^2 + C_2 * n) $$</p>
<p>\( 在N进行增长的时候，n^2 对于 T(n) 增长的影响是远远大于 n 的，所以我们就可以忽略掉 n ，认为 T(n) = O(C_1 * n^2) \)，
常数项量级也可以忽略掉，最终为</p>
<p>$$ T(n) = O(n^2) $$</p>
<ul>
<li>即当 <code>n</code> 很大的时候，\( n^2 为 T(n) 的上界函数。\)</li>
<li>即随着 <code>n</code> 的增长，某个算法所用的时间 \( T(n) \) 的 <strong>增长趋势</strong> 是 \( n^2 \)</li>
</ul>
<p>\( 总结可得，当 T(n) 是关于n的k阶多项式的时候， T(n) = O(n^k) \)</p>
<p>分析代码时，可以得出:</p>
<pre tabindex="0"><code>一个if-else的复杂度 = max(条件判断式的复杂度，if分支的复杂度，else分支的复杂度)
</code></pre><h3 id="忽略常数项">忽略常数项</h3>
<p>当我们谈论时间复杂度 \( \log N \) 的时候，我们并没有说明 \( \log N \) 是以2，以10还是以<code>e</code>为底的。</p>
<p>这是因为当N很大的时候，\( \log_{2} N  和  \log_{10} N \) 它们之间相差了常数倍。</p>
<p>$$ log_2N = log_{10}N * log_2 10 $$</p>
<p>其中 \( \log_2 10 \) 是一个常数</p>
<p>\( \log N \)的增长趋势是大于常数的增长趋势的，所以我们可以忽略掉底数的差异，直接以\( \log N \) 代指一种增长趋势。</p>
<h3 id="乘法法则">乘法法则</h3>
<p><strong>嵌套代码的复杂度等一嵌套内外代码复杂度的乘积</strong>，这个规则用公式表示为</p>
<p>$$ T_1(n) = O(f_1(n)), T_2(n) = O(f_2(n)) $$</p>
<p>$$ T_1(n) * T_2(n) = O(f_1(n) * f_2(n)) $$</p>
<p>我们先看一段代码:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">cal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">n</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>   <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">ret</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">n</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>     <span style="color:#000">ret</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ret</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">f</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>   <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span> <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">f</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">n</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">sum</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">n</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">sum</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">sum</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">i</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">sum</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span> <span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>cal</code> 函数除了5行，其他地方的时间复杂度是 \( O(n) \), <code>f</code> 函数的时间复杂度是 \( O(n) \)
整个 <code>cal</code> 函数的时间复杂度就是</p>

<div class="math">$$T(n) = T1(n) * T2(n) = O(n*n) = O(n^2)$$</div><p>分析代码时，可得:</p>
<pre tabindex="0"><code>一个for循环的复杂度 = 循环体的复杂度 * 循环次数
</code></pre><h2 id="空间复杂度">空间复杂度</h2>
<p>上文说到, 时间复杂度的全称是 <strong>渐进时间复杂度，表示算法的执行时间与数据规模之间的增长关系</strong>。</p>
<p>类比一下，空间复杂度的全称就是 <strong>渐进空间复杂度 (asymptotic space complexity)，表示算法的存储空间和数据规模之间的增长关系。</strong></p>
<p>先看一段简单的代码</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">n</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">[]</span> <span style="color:#000">a</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">new</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">n</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">a</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">i</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">n</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&gt;=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#ce5c00;font-weight:bold">--</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">print</span> <span style="color:#000">out</span> <span style="color:#000">a</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>上述代码中，第二行申请了一个固定大小的内存空间，第三行申请了一个大小为 n 的 int 类型的数组，其他行都没有申请内存空间，我们可以忽略。</p>
<p>所以整段代码的空间复杂度就是 \( O(n) \)</p>
<p><strong>我们常见的空间复杂度就是 \( O(1), O(n), O(n^2) \)，像 \( O(logn), O(nlogn) \) 这样的对数阶复杂度平时都用不到</strong>。</p>
<h2 id="参考资料">参考资料</h2>
<ul>
<li>极客时间 《数据结构与算法之美》</li>
<li><a href="https://www.icourse163.org/course/ZJU-93001">浙江大学《数据结构》公开课</a></li>
</ul>
</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-b5fadaa3f5f96e8c51757851d7668a4e">2 - Redis</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-9f184c796063902888d119a9e9dbf239">2.1 - Redis 主从同步细节</h1>
    
	<blockquote>
<p>介绍了 Redis 的主从同步流程及一些配置选项</p>
</blockquote>
<hr>
<h2 id="完整的复制流程">完整的复制流程</h2>
<ol>
<li>slave 启动，获取 master 节点的信息，包括 (master run_id)</li>
<li>如果 slave 中可以找到此 master 的数据，发送 <code>PSYNC {master run id} {slave offset}</code> 指令给 master，请求开始部分复制。</li>
<li>如果 slave 找不到 master 的数据，发送 <code>PSYNC ? -1</code> 指令给 master，请求全量复制。</li>
<li>口令认证，如果 master 设置了 <code>requirepass</code>，slave 节点必须发送 <code>masterauth</code> 设置的口令去认证</li>
<li>master node 执行一次全量复制/部分复制，将数据同步到 slave 上。</li>
<li>master node 后续持续将写命令，异步地发送给 slave，同时会将命令写入到先进先出的队列 backlog 中</li>
</ol>
<p>主从复制的流程图如下</p>
<p><img src="https://passage-1253400711.cos-website.ap-beijing.myqcloud.com/2021-10-22-143417.png" alt=""></p>
<h2 id="复制过程中的参数说明">复制过程中的参数说明</h2>
<ul>
<li>offset (复制偏移量)</li>
</ul>
<p>master 和  slave 都会维护一个累加的 offset，master 还会维护每个 slave 的offset，用于沟通数据的差异。</p>
<p><code>role</code>命令可以查看复制偏移量</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># master role</span>
</span></span><span style="display:flex;"><span>127.0.0.1:6379&gt; role
</span></span><span style="display:flex;"><span>1<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;master&#34;</span>  <span style="color:#8f5902;font-style:italic"># 服务器的角色</span>
</span></span><span style="display:flex;"><span>2<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">(</span>integer<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#0000cf;font-weight:bold">98</span>  <span style="color:#8f5902;font-style:italic"># master 的复制偏移量</span>
</span></span><span style="display:flex;"><span>3<span style="color:#ce5c00;font-weight:bold">)</span> 1<span style="color:#ce5c00;font-weight:bold">)</span> 1<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;127.0.0.1&#34;</span>  <span style="color:#8f5902;font-style:italic"># slave host</span>
</span></span><span style="display:flex;"><span>      2<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;6380&#34;</span>   <span style="color:#8f5902;font-style:italic"># slave port</span>
</span></span><span style="display:flex;"><span>      3<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;98&#34;</span>     <span style="color:#8f5902;font-style:italic"># slave 的复制偏移量</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># slave role</span>
</span></span><span style="display:flex;"><span>127.0.0.1:6380&gt; role
</span></span><span style="display:flex;"><span>1<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;slave&#34;</span>  <span style="color:#8f5902;font-style:italic"># 服务器的角色</span>
</span></span><span style="display:flex;"><span>2<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;localhost&#34;</span>  <span style="color:#8f5902;font-style:italic"># master host</span>
</span></span><span style="display:flex;"><span>3<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">(</span>integer<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#0000cf;font-weight:bold">6379</span>  <span style="color:#8f5902;font-style:italic"># master port</span>
</span></span><span style="display:flex;"><span>4<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;connected&#34;</span>  <span style="color:#8f5902;font-style:italic"># 和 master 的连接状态</span>
</span></span><span style="display:flex;"><span>5<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">(</span>integer<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#0000cf;font-weight:bold">112</span>  <span style="color:#8f5902;font-style:italic"># slave 的复制偏移量</span>
</span></span></code></pre></div><p>连接状态有以下几种值:</p>
<table>
<thead>
<tr>
<th>状态</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>&ldquo;none&rdquo;</td>
<td>主从服务器尚未建立连接</td>
</tr>
<tr>
<td>&ldquo;connect&rdquo;</td>
<td>主从服务器正在握手。</td>
</tr>
<tr>
<td>&ldquo;connecting&rdquo;</td>
<td>主从服务器成功建立了连接。</td>
</tr>
<tr>
<td>&ldquo;sync&rdquo;</td>
<td>主从服务器正在进行数据同步。</td>
</tr>
<tr>
<td>&ldquo;connected&rdquo;</td>
<td>主从服务器已经进入在线更新状态。</td>
</tr>
<tr>
<td>&ldquo;unknown&rdquo;</td>
<td>主从服务器连接状态未知。</td>
</tr>
</tbody>
</table>
<ul>
<li>run id</li>
</ul>
<p>master run id 发生变化时， slave 会重新做全量复制</p>
<p>使用 <code>info server</code> 可以查看当前 Redis Server 的 run id</p>
<h3 id="full-resynchronization-全量复制">Full Resynchronization (全量复制)</h3>
<ol>
<li>master 执行 bgsave，用子进程生成 rdb 快照文件</li>
<li>master 生成快照文件的同时会将随后的操作指令写在内存缓存中</li>
<li>master 将 rdb 文件发送给 slave node，如果发送时间超过 <code>repl-timeout</code> （默认是 60s），那么 slave node 就会认为复制失败，可以适当调大这个参数.</li>
<li><code>client-output-buffer-limit slave 256M 64M 60</code>，如果在复制过程中，内存缓存区持续消耗超过 64M，或一次性超过 256M，那么停止复制，复制失败。</li>
<li>slave 将 rdb 文件落盘</li>
<li>slave 从 rdb 文件恢复数据，恢复的同时基于旧数据 serve</li>
<li>如果 slave 开启了 aof 备份，那么恢复成功后会立即执行 BGREWRITEAOF，重写 AOF</li>
<li>master 在 slave 恢复成功后将内存缓存的操作指令发送给 slave</li>
</ol>
<blockquote>
<p><strong>在数据同步时复用 rdb 文件</strong></p>
<ol>
<li>如果 master 在收到 replicaof 指令之前已经执行过一次 bgsave 命令，且数据库在执行 bgsave 之后没有任何变化，那么 master 将会直接向 slave 发送已经生成的 rdb 文件</li>
<li>如果 master 在生成 rdb 文件期间，又有多个 slave 请求同步数据，那么 master 会把请求同步的 slave 全部放到队列中，等 rdb 文件生成后，一起发送给队列中的所有 slave</li>
</ol>
</blockquote>
<h2 id="在线更新">在线更新</h2>
<p>master 和 slave 执行完全量复制后，</p>
<ol>
<li>master 会将收到的写指令发送给 slave 执行，让两边数据同步</li>
<li>master 对每个 slave 都会维护一个先进先出的队列，存储 slave 收到的写指令。可以通过 <code>repl-backlog-size</code> 设置这个队列的大小</li>
</ol>
<h2 id="部分复制-partial-resynchronization">部分复制 (partial resynchronization)</h2>
<ol start="0">
<li>在 redis 2.8 之前，如果 slave 断开连接后又重新建立连接，slave 会请求重新执行一次全量同步，这样非常浪费资源</li>
<li>redis 2.8 之后，添加了部分复制的功能</li>
<li>第一次全量复制完成后，master 每次向 slave 发送的指令都会存储到 backlog 中</li>
<li>如果 slave 因为网络原因短暂地断开了连接， slave 重新连接后会发送 replica offset 到 master 中</li>
<li>master 如果在 backlog 中找到了 replica offset，master 会将 backlog 中存储的剩余数据发送过来。</li>
<li>如果找不到，master 会开始进行全量复制</li>
</ol>
<blockquote>
<p>backlog 的容量越大，master 所能容忍的 slave 断线时间也就越长，可以通过 <code>repl-backlog-size</code> 选项更改 backlog 的大小。</p>
</blockquote>
<h2 id="无盘化复制">无盘化复制</h2>
<p>两个相关选项:</p>
<ul>
<li>repl-diskless-sync</li>
</ul>
<p>开启此选项后，rdb 文件在 master 上不会落盘，会直接发送给 slave，slave 上还是会进行落盘，redis 目前无法做到完全不依靠硬盘实现主从复制。</p>
<ul>
<li>repl-diskless-sync-delay</li>
</ul>
<p>开启无盘化复制后，新的 Slave 无法复用之前已经开始的复制任务，只能等待新的复制任务。<code>repl-diskless-sync-delay</code> 设置复制任务在收到 Slave 的请求多久后开始，以等待更多的 Slave 连接，一起发送 rdb 数据。</p>
<h2 id="降低数据不一致出现的概率">降低数据不一致出现的概率</h2>
<h3 id="因-master-挂掉出现数据不一致">因 master 挂掉出现数据不一致</h3>
<ol>
<li>master 将数据同步到 slave 是异步进行的，如果 master 还有部分数据未同步，就挂掉了。哨兵发现 master 不正常，及时切换了 master，但旧 master 中未同步的数据就会丢失掉了。</li>
<li>设置 <code>min-slaves-max-lag 10</code> 选项，表示如果超过10秒 slave 没有和 master 通信过，master 就认为 slave 和自己的数据差别太大，不再接收写操作。这样 master 挂掉后可以少丢失一些数据。</li>
</ol>
<h3 id="因集群脑裂出现数据不一致">因集群脑裂出现数据不一致</h3>
<ol>
<li>因为网络原因，集群短暂地分裂成两个，两个 master 都接收数据。网络恢复后，节点少的 master 会重新变成 slave，此时这个 master 上写的数据就会丢失。</li>
<li>设置 <code>min-slaves-to-write 3</code> 选项，表示如果 slave 个数小于3，master 就不再接收写操作，小集群的 master 不写数据，集群恢复后，也不会造成数据丢失。</li>
</ol>
<h2 id="过期-key-处理">过期 key 处理</h2>
<p>如果设置了 <code>slave-read-only=yes</code>， Slave 不会主动过期 key，master 在将 key 过期后，会发送 DEL 指令给 Slave</p>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-5e80ba3bff85aef5c731bcf3ecb0922c">2.2 - Redis 源码阅读之 dict </h1>
    
	<p>本文主要介绍了 Redis 的基础数据结构 dict 的实现，并描述了其渐进式 rehash 的操作</p>
<p><strong>注意</strong>: 本文基于 Redis 3.0.0 的代码进行分析的</p>
<h2 id="dict-介绍">dict 介绍</h2>
<p>dict 又称符号表(symbol table)，关联数组(associative array)或映射(map)，是一种用于保存键值对的抽象数据结构。</p>
<p>Redis 实现使用的C语言并没有内置 dict 这种数据类型，所以 Redis 实现了自己的 dict。dict 在 Redis 中有广泛的应用，Redis 数据库的底层就是使用字典来实现的，也就是说对数据库的增，删，改，查都是建立在字典之上的。同时，字典也是<code>hash</code>和<code>sorted set</code>等数据结构的底层实现之一。</p>
<h2 id="dict-的实现">dict 的实现</h2>
<p>在 Redis 中，dict 的代码存放在<code>src/dict.c</code>和<code>src/dict.h</code>两个文件中。在<code>src/dict.h</code>中定义了 dict 所用到的结构体，一共有四个:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 哈希表项
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">typedef</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">dictEntry</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">union</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">val</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">uint64_t</span> <span style="color:#000">u64</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">int64_t</span> <span style="color:#000">s64</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">double</span> <span style="color:#000">d</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span> <span style="color:#000">v</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">dictEntry</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">next</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// 哈希表中是通过单链表解决键索引冲突的，next用来指向同一个键索引下的下一个元素
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">dictEntry</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 这里的思想类似于Go，使用函数来定义字典类型(接口)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">typedef</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">dictType</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">hashFunction</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">keyDup</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">privdata</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">valDup</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">privdata</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">obj</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">keyCompare</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">privdata</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">key1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">const</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">key2</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">keyDestructor</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">privdata</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">key</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">valDestructor</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">privdata</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">obj</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">dictType</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">/* 哈希表结构体，每个字典都有两个哈希表，其中多的一个用来做渐进式 rehash */</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">typedef</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">dictht</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">dictEntry</span> <span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#000">table</span><span style="color:#000;font-weight:bold">;</span>       <span style="color:#8f5902;font-style:italic">// 哈希表项组成的数组
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">size</span><span style="color:#000;font-weight:bold">;</span>      <span style="color:#8f5902;font-style:italic">// 当前哈希表的大小
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">sizemask</span><span style="color:#000;font-weight:bold">;</span>  <span style="color:#8f5902;font-style:italic">// 哈希表大小的掩码，总是等于size - 1
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">unsigned</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">used</span><span style="color:#000;font-weight:bold">;</span>      <span style="color:#8f5902;font-style:italic">// 哈希表中哈希表项的数目
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">dictht</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">/* 字典的定义 */</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">typedef</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">dict</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">dictType</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">type</span><span style="color:#000;font-weight:bold">;</span>  <span style="color:#8f5902;font-style:italic">// 字典的类型
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">privdata</span><span style="color:#000;font-weight:bold">;</span>  <span style="color:#8f5902;font-style:italic">// 字典私有数据
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">dictht</span> <span style="color:#000">ht</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">];</span>    <span style="color:#8f5902;font-style:italic">// 字典中的哈希表
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">rehashidx</span><span style="color:#000;font-weight:bold">;</span>  <span style="color:#8f5902;font-style:italic">// rehashidx == -1 表示当前字典没有做 rehash，否则表示当前字典正在进行 rehash 操作
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">iterators</span><span style="color:#000;font-weight:bold">;</span>   <span style="color:#8f5902;font-style:italic">// 安全迭代器的数量
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">dict</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">/*
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 字典迭代器用来获取字典中所有的项，其中迭代器可以分为安全迭代器和非安全迭代器两种
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 安全迭代器表示在迭代过程中可以调用字典的 dictAdd(), dictFind() 等接口
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * 非安全迭代器在迭代过程中只能调用 dictNext() 接口
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * */</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">typedef</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">dictIterator</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">dict</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">d</span><span style="color:#000;font-weight:bold">;</span>             <span style="color:#8f5902;font-style:italic">// 迭代器所关联的字典
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">index</span><span style="color:#000;font-weight:bold">;</span>          <span style="color:#8f5902;font-style:italic">// 当前迭代器在字典中迭代的索引
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">table</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">safe</span><span style="color:#000;font-weight:bold">;</span>     <span style="color:#8f5902;font-style:italic">// 哈希表的索引，当前迭代器是否是安全迭代器
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">dictEntry</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">entry</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">nextEntry</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// 当前迭代器所指向的哈希表项和下一个哈希表项
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">/* unsafe iterator fingerprint for misuse detection. */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">fingerprint</span><span style="color:#000;font-weight:bold">;</span>  <span style="color:#8f5902;font-style:italic">// 字典的指纹，非安全迭代器中用于鉴别字典是否被修改过
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span> <span style="color:#000">dictIterator</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><p>他们之间的关系如图1所示:</p>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2018-03-10-054715.png" alt="图1"></p>
<p><strong>图1</strong></p>
<p>当我们向字典中存储键值对(k, v)时，字典通过一定的算法计算出k的索引值，它的计算方法如下:</p>
<pre tabindex="0"><code># 先根据哈希算法计算出键k的哈希值，哈希值为unsigned int 类型
hash = d-&gt;type-&gt;hashFunction(k)
# 然后再将哈希值和哈希表的sizemask按位与，获得键k在哈希表中的索引
idx = hash &amp; d-&gt;ht[table].sizemask
</code></pre><p>最后按照计算出来的索引值将键值对存储到字典中的哈希表中。</p>
<h2 id="dict-的哈希算法">dict 的哈希算法</h2>
<p>dict 按照使用方式的不同，所采取的哈希算法也不同。Redis目前共使用两种不同的哈希算法：</p>
<ol>
<li>MurmurHash2 32 bit 算法：这种算法的分布率和速度都非常好， 具体信息请参考 MurmurHash 的主页： <a href="http://code.google.com/p/smhasher/">http://code.google.com/p/smhasher/</a> 。</li>
<li>基于 djb 算法实现的一个大小写无关散列算法：具体信息请参考 <a href="http://www.cse.yorku.ca/~oz/hash.html">http://www.cse.yorku.ca/~oz/hash.html</a> 。</li>
</ol>
<ul>
<li>dict 在命令表以及 Lua 脚本缓存中时，使用了算法2</li>
<li>dict 在数据库，集群，哈希键和阻塞操作等功能中都使用到了算法1</li>
</ul>
<h2 id="dict-解决键冲突的方案">dict 解决键冲突的方案</h2>
<p>根据前面的内容所知，向dict中添加键值对时，dict根据键计算出来的索引值将键值对存储到哈希表中。由于哈希表的大小是有限的，所以可能会出现两个键的索引值相同的情况，这种情况也称作键冲突。</p>
<p>当出现键冲突的时候，dict会将两个键值对存放在同一个哈希表的同一个索引下，它们通过单链表的形式组合起来，如图2所示：</p>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2018-03-13-155621.jpg" alt="图2"></p>
<p><strong>图2</strong></p>
<p>其中k1和k2计算出来的索引值是相同的，他们被存放到哈希表的同一个索引下，然后通过单链表的形式组合起来。</p>
<p>在 <code>src/dict.c</code>的<code>dictEntry *dictAddRaw(dict *d, void *key)</code>函数中，我们可以看到向单链表中添加元素的过程</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">/* 哈希表通过单链表来解决键冲突，下面的代码向单链表中添加了哈希表节点 */</span>
</span></span><span style="display:flex;"><span><span style="color:#000">entry</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">zmalloc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">sizeof</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">entry</span><span style="color:#000;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span><span style="color:#000">entry</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">next</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ht</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">table</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">index</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span><span style="color:#000">ht</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">table</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">index</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">entry</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">ht</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">used</span><span style="color:#ce5c00;font-weight:bold">++</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><p>申请一个哈希表项之后，将它的地址存放在哈希表中，同时也使哈希表中原来存在的节点变成它的next节点，即新增元素在单链表的头部。</p>
<h2 id="渐进式-rehash">渐进式 rehash</h2>
<p>每个dict都有一个负载因子，计算方式如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#000">load_factor</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ht</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">used</span> <span style="color:#ce5c00;font-weight:bold">/</span> <span style="color:#000">ht</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">size</span>
</span></span></code></pre></div><p>当 dict 的负载因子过大或过小的时候，Redis 需要为这个 dict 扩展或者收缩哈希表的大小，这个过程叫做 rehash。上文中我们提到每个 dict 都有两个哈希表, <code>ht0</code>和<code>ht1</code>，在这里它们就发挥作用了。rehash 的具体操作如下:</p>
<ol>
<li>
<p>设置<code>ht1</code>的size，扩展过程中size为大于<code>ht0.size</code>的最小2次幂，收缩过程中size为大于<code>ht0.used</code>的最小2次幂</p>
</li>
<li>
<p>将 dict.rehashidx 设置为0</p>
</li>
<li>
<p>在增删改查的过程中，检查 dict.rehashidx 是否不等于 -1，如果是，那么就执行<code>_dictRehashStep</code>操作，<code>_dictRehashStep</code>的操作如下:</p>
<ul>
<li>如果当前字典上的没有安全迭代器，执行<code>dictRehash</code>操作</li>
<li><code>dictRehash</code>操作就是从<code>ht0</code>中取出值，重新计算哈希值，然后放到<code>ht1</code>中，并将<code>ht0.used</code>减少。将<code>dict.rehashidx</code>的索引加1。由于在这个过程中重新计算了 key 的哈希值，所以这个过程称为 <strong>rehash</strong></li>
<li>如果<code>ht0</code>中的所有元素都复制到了<code>ht1</code>中后，Redis 会交换<code>ht1</code>和<code>ht0</code>的地址，然后将<code>ht1</code>置为空表(即存在dictht这个结构体变量，但是里面的dictEntry指针为空，没有任何哈希表项)，同时将<code>dict.rehashidx</code>置为 -1。</li>
<li>同时<code>dictRehash</code>还有一个限制，每次 rehash 的时候存在一个 <code>empty_visits</code> 限制(empty_visits = 10 * n，n是本次<code>dictRehash</code>操作要 rehash 哈希表项的数量)。如果访问到的空的哈希表项的次数超过了<code>empty_visits</code>，本次 rehash 操作就结束了。</li>
</ul>
</li>
</ol>
<ul>
<li>
<p>由于 rehash 操作不是一次性做完的，而是在字典的操作中一点一点做的，所以这个过程称作__渐进式rehash__</p>
</li>
<li>
<p>因为在字典的增删改查操作中执行了 rehash 操作，所以这些操作的行为也会受到影响</p>
<ul>
<li>在<code>dictAdd</code>操作中，如果当前字典正在进行 rehash，那么新加的值都会加入到<code>ht1</code>中，这样保证<code>ht0</code>只会减少，不会增加，最终<code>ht0</code>会变成空表</li>
<li>在<code>dictFind</code>操作中，会在<code>ht0</code>和<code>ht1</code>两个哈希表中查询对应的键</li>
<li>在<code>dictDelete</code>操作中也回在<code>ht0</code>和<code>ht1</code>中查找对应的键</li>
<li><code>dictReplace</code>操作调用的是<code>dictFind</code>方法查找对应的键</li>
</ul>
</li>
<li>
<p>在执行 BGSAVE 和 BGREWRITEAOF 命令时，Redis 会提高字典的负载因子。因为在调用这两个命令时，Redis 会为当前进程产生子进程，而很多操作系统采用了写时复制的策略，如果不执行 rehash 操作，会避免不必要的内存写入操作，从而节省一些内存。</p>
</li>
</ul>
<h2 id="字典迭代器和-rehash-的关系">字典迭代器和 rehash 的关系</h2>
<p>在渐进式 rehash 一小节中我们提到，当字典的安全迭代器的数量为0的时候，才会执行 rehash 操作，这是为什么呢？</p>
<p>首先我们可以分析一下字典迭代器的迭代操作，它可以用如下的伪代码来表示:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">iter_dict</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">dict</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># 迭代0号哈希表</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">iter_table</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ht</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">table</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># 如果正在进行 rehash 的话，也迭代1号哈希表</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">dict</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">is_rehashing</span><span style="color:#000;font-weight:bold">():</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">iter_table</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ht</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">-&gt;</span><span style="color:#000">table</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">iter_table</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">table</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">index</span> <span style="color:#204a87;font-weight:bold">in</span> <span style="color:#000">table</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic"># 跳过空的哈希表项</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">table</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">index</span><span style="color:#000;font-weight:bold">]</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">empty</span><span style="color:#000;font-weight:bold">():</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic"># 处理当前哈希表项的单链表上所有的节点</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">node</span> <span style="color:#204a87;font-weight:bold">in</span> <span style="color:#000">table</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">node</span><span style="color:#000;font-weight:bold">]:</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">do_some_thing_with</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">node</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>假设我们在一个正在进行 rehash 操作的字典上创立了一个安全迭代器，首先执行了<code>dictNext()</code>，获取了<code>ht0</code>中的一个哈希表项<code>he1</code>。接着执行<code>dictAdd()</code>，添加了一个哈希表项。如果<code>dictAdd()</code>函数能够执行 rehash 的话，<code>he1</code>哈希表项可能被从<code>ht0</code>复制到了<code>ht1</code>，从而导致安全迭代器获取了哈希表项<code>he1</code>两次</p>
<p>所以当字典中存在安全迭代器的时候，是不能进行 rehash 操作的。</p>
<p>而对于非安全迭代器，Redis 规定在非安全迭代器的生命周期内只能执行<code>dictNext()</code>操作，不能执行其他操作，从而避免了 rehash 操作。</p>
<p>同时 Redis 在创建非安全迭代器的时候会获取 dict 的指纹，在释放非安全迭代器的时候重新获取指纹，检查两次指纹是否相同。如果不同，证明 dict 被修改过，Redis 就会抛出异常。</p>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-24908c465f52816f8bd5bc366e5a5645">2.3 - Redis Sort 命令简介</h1>
    
	<blockquote>
<p><code>sort</code>命令是Redis中最强大的命令之一，本文试图通过一些例子来总结Redis Sort的常用方法。</p>
</blockquote>
<h2 id="对列表排序的简单例子">对列表排序的简单例子</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>127.0.0.1:6379&gt; RPUSH users <span style="color:#0000cf;font-weight:bold">3</span> <span style="color:#0000cf;font-weight:bold">4</span> <span style="color:#0000cf;font-weight:bold">5</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#0000cf;font-weight:bold">33</span> <span style="color:#0000cf;font-weight:bold">8</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span>integer<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#0000cf;font-weight:bold">6</span>
</span></span><span style="display:flex;"><span>127.0.0.1:6379&gt; SORT users
</span></span><span style="display:flex;"><span>1<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;1&#34;</span>
</span></span><span style="display:flex;"><span>2<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;3&#34;</span>
</span></span><span style="display:flex;"><span>3<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;4&#34;</span>
</span></span><span style="display:flex;"><span>4<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;5&#34;</span>
</span></span><span style="display:flex;"><span>5<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;8&#34;</span>
</span></span><span style="display:flex;"><span>6<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;33&#34;</span>
</span></span></code></pre></div><p>在上面的例子中，我们对一系列的数字进行了排序，得到了排序后的结果。</p>
<h2 id="列表排序的更高级的例子">列表排序的更高级的例子</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>127.0.0.1:6379&gt; RPUSH users <span style="color:#0000cf;font-weight:bold">3</span> <span style="color:#0000cf;font-weight:bold">4</span> <span style="color:#0000cf;font-weight:bold">5</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#0000cf;font-weight:bold">33</span> <span style="color:#0000cf;font-weight:bold">8</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span>integer<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#0000cf;font-weight:bold">6</span>
</span></span><span style="display:flex;"><span>127.0.0.1:6379&gt; SORT users limit <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#0000cf;font-weight:bold">4</span> asc alpha
</span></span><span style="display:flex;"><span>1<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;3&#34;</span>
</span></span><span style="display:flex;"><span>2<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;33&#34;</span>
</span></span><span style="display:flex;"><span>3<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;4&#34;</span>
</span></span><span style="display:flex;"><span>4<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;5&#34;</span>
</span></span></code></pre></div><p>在上面的例子中，我们使用了三个参数，<code>limit</code>, <code>asc</code>和<code>alpha</code>。
<code>limit</code>表示对结果进行分页，其中<code>1</code>表示页数，<code>4</code>表示一页中元素的个数。
<code>asc</code>表示对结果进行正序排序。
<code>alpha</code>表示对结果使用字母序排序，而不是数字序。</p>
<h2 id="基于引用对象进行排序">基于引用对象进行排序</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 首先添加一组用户ID</span>
</span></span><span style="display:flex;"><span>127.0.0.1:6379&gt; RPUSH users <span style="color:#0000cf;font-weight:bold">13</span> <span style="color:#0000cf;font-weight:bold">84</span> <span style="color:#0000cf;font-weight:bold">23</span> <span style="color:#0000cf;font-weight:bold">454</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span>integer<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#0000cf;font-weight:bold">4</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 然后添加一些user_age:id key用来表示用户的年龄</span>
</span></span><span style="display:flex;"><span>127.0.0.1:6379&gt; <span style="color:#204a87">set</span> user_age:13 <span style="color:#0000cf;font-weight:bold">20</span>
</span></span><span style="display:flex;"><span>OK
</span></span><span style="display:flex;"><span>127.0.0.1:6379&gt; <span style="color:#204a87">set</span> user_age:84 <span style="color:#0000cf;font-weight:bold">23</span>
</span></span><span style="display:flex;"><span>OK
</span></span><span style="display:flex;"><span>127.0.0.1:6379&gt; <span style="color:#204a87">set</span> user_age:23 <span style="color:#0000cf;font-weight:bold">34</span>
</span></span><span style="display:flex;"><span>OK
</span></span><span style="display:flex;"><span>127.0.0.1:6379&gt; <span style="color:#204a87">set</span> user_age:454 <span style="color:#0000cf;font-weight:bold">11</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 使用sort命令基于用户年龄对用户进行排序</span>
</span></span><span style="display:flex;"><span>127.0.0.1:6379&gt; sort users by user_age:* desc
</span></span><span style="display:flex;"><span>1<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;23&#34;</span>
</span></span><span style="display:flex;"><span>2<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;84&#34;</span>
</span></span><span style="display:flex;"><span>3<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;13&#34;</span>
</span></span><span style="display:flex;"><span>4<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;454&#34;</span>
</span></span></code></pre></div><p>在上面的例子中，我们使用一些值<code>user_age:*</code>，来对列表进行排序。
我们通过<code>sort</code>命令强大的<code>by</code>参数来设置排序的规则。<code>by</code>参数除了可以指定基于键值对数据进行排序外，也可以基于哈希对象进行排序，请看下面这个例子:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 添加一组用户ID</span>
</span></span><span style="display:flex;"><span>127.0.0.1:6379&gt; RPUSH users <span style="color:#0000cf;font-weight:bold">13</span> <span style="color:#0000cf;font-weight:bold">84</span> <span style="color:#0000cf;font-weight:bold">23</span> <span style="color:#0000cf;font-weight:bold">454</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span>integer<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#0000cf;font-weight:bold">4</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 添加了一组哈希对象来表示用户</span>
</span></span><span style="display:flex;"><span>127.0.0.1:6379&gt; hmset user:13 age <span style="color:#0000cf;font-weight:bold">20</span> name user_13
</span></span><span style="display:flex;"><span>OK
</span></span><span style="display:flex;"><span>127.0.0.1:6379&gt; hmset user:84 age <span style="color:#0000cf;font-weight:bold">23</span> name user_84
</span></span><span style="display:flex;"><span>OK
</span></span><span style="display:flex;"><span>127.0.0.1:6379&gt; hmset user:23 age <span style="color:#0000cf;font-weight:bold">34</span> name user_23
</span></span><span style="display:flex;"><span>OK
</span></span><span style="display:flex;"><span>127.0.0.1:6379&gt; hmset user:454 age <span style="color:#0000cf;font-weight:bold">11</span> name user_454
</span></span><span style="display:flex;"><span>OK
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 基于哈希对象的来对上面的例子进行排序</span>
</span></span><span style="display:flex;"><span>127.0.0.1:6379&gt; sort users by user:*-&gt;age
</span></span><span style="display:flex;"><span>1<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;454&#34;</span>
</span></span><span style="display:flex;"><span>2<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;13&#34;</span>
</span></span><span style="display:flex;"><span>3<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;84&#34;</span>
</span></span><span style="display:flex;"><span>4<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;23&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 基于哈希对象的来对上面的例子进行排序，并获取用户名称</span>
</span></span><span style="display:flex;"><span>127.0.0.1:6379&gt; sort users by user:*-&gt;age get user:*-&gt;name
</span></span><span style="display:flex;"><span>1<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;user_454&#34;</span>
</span></span><span style="display:flex;"><span>2<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;user_13&#34;</span>
</span></span><span style="display:flex;"><span>3<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;user_84&#34;</span>
</span></span><span style="display:flex;"><span>4<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#4e9a06">&#34;user_23&#34;</span>
</span></span></code></pre></div><p>在这个例子中，<code>users</code>是一个列表用来表示用户ID，<code>user:*</code>为哈希对象用来表示用户。
在第一个<code>sort</code>命令中，我们基于用户哈希对象的<code>age</code>字段来进行排序，得到的结果为排序过后的用户ID列表。
如果想要取的返回值不是用户ID的话，也可以通过<code>get</code>参数来指定获取的字段。
在第二个<code>sort</code>命令中，我们还是通过用户哈希对象的<code>age</code>字段来排序，获取的结果为用户哈希对象的<code>name</code>字段组成的数组。</p>
<h2 id="存储查询结果">存储查询结果</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 添加一组用户ID</span>
</span></span><span style="display:flex;"><span>127.0.0.1:6379&gt; RPUSH users <span style="color:#0000cf;font-weight:bold">13</span> <span style="color:#0000cf;font-weight:bold">84</span> <span style="color:#0000cf;font-weight:bold">23</span> <span style="color:#0000cf;font-weight:bold">454</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 添加一组key用来表示用户年龄</span>
</span></span><span style="display:flex;"><span>127.0.0.1:6379&gt; <span style="color:#204a87">set</span> user_age:13 <span style="color:#0000cf;font-weight:bold">20</span>
</span></span><span style="display:flex;"><span>OK
</span></span><span style="display:flex;"><span>127.0.0.1:6379&gt; <span style="color:#204a87">set</span> user_age:84 <span style="color:#0000cf;font-weight:bold">23</span>
</span></span><span style="display:flex;"><span>OK
</span></span><span style="display:flex;"><span>127.0.0.1:6379&gt; <span style="color:#204a87">set</span> user_age:23 <span style="color:#0000cf;font-weight:bold">34</span>
</span></span><span style="display:flex;"><span>OK
</span></span><span style="display:flex;"><span>127.0.0.1:6379&gt; <span style="color:#204a87">set</span> user_age:454 <span style="color:#0000cf;font-weight:bold">11</span>
</span></span><span style="display:flex;"><span>OK
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 根据用户年龄对用户ID进行排序，并将排序结果存储在users_sort_result所代表的列表中</span>
</span></span><span style="display:flex;"><span>127.0.0.1:6379&gt; SORT users by user_age:* desc store users_sort_result
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span>integer<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#0000cf;font-weight:bold">4</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 为排序结果设置过期时间</span>
</span></span><span style="display:flex;"><span>127.0.0.1:6379&gt; expire users_sort_result <span style="color:#0000cf;font-weight:bold">30</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">(</span>integer<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span></code></pre></div><p>在上面的例子中，我们根据用户年龄对用户ID进行了排序，同时为排序结果设置了一个过期时间，这样我们就可以将排序结果缓存起来了。
然后每回获取排序结果的时候，我们可以先查缓存，如果缓存不存在的话，则进行排序。
需要注意的是，为了避免多个客户端同时操作排序结果，我们需要使用<code>SETNX</code>命令来为缓存结果设置一个锁，详见<a href="https://redis.io/commands/setnx">SETNX key value</a></p>
</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-af68ff2ed3e54c426ada6b1cb8e61eaa">3 - Kafka</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-c7b3f27b65643bf045308409a82ca6b8">3.1 - Consumer</h1>
    
	<h2 id="commit">Commit</h2>
<ul>
<li>
<p>当 Consumer 将 <code>enable.auto.commit</code> 设置为 true 的时候，kafka consumer 会自动提交 offset。
它在 <code>auto.commit.interval.ms</code> 选项的控制下，间隔N秒后，自动将当前 consumer 拉取到的消息 offset 提交到 kafka 中。</p>
</li>
<li>
<p>当 <code>enable.auto.commit=false</code> 时，kafka 客户端不会自动提交 offset，需要开发者通过 <code>consumer.commitSync</code> 或 <code>consumer.commitAsync</code> 提交 offset。</p>
</li>
<li>
<p>不建议每收到一条消息就提交一次 offset，<code>consumer.commitSync</code> 是有性能损耗的，如果 <code>consumer.commitSync</code> 调用的频率非常高，consumer 消费消息的速度将会变得很慢。</p>
</li>
<li>
<p><code>consumer.commitAsync</code> 是异步提交的，它相对 <code>consumer.commitSync</code> 会有一定的性能提升。<code>consumer.commitAsync</code> 还有一个回调函数参数，让开发者设定在提交失败时做什么。</p>
<ul>
<li>一般在 broker 正常时，提交失败的情况很少发生。开发者不需要做提交失败后重试的逻辑。</li>
</ul>
</li>
</ul>
<h3 id="参考链接">参考链接</h3>
<ul>
<li><a href="https://github.com/edenhill/librdkafka/blob/4992b3db321befa04ece3027f3c79f3557684db9/CONFIGURATION.md">https://github.com/edenhill/librdkafka/blob/4992b3db321befa04ece3027f3c79f3557684db9/CONFIGURATION.md</a></li>
<li><a href="https://docs.confluent.io/platform/current/clients/consumer.html#id1">https://docs.confluent.io/platform/current/clients/consumer.html#id1</a></li>
</ul>
<h2 id="offset">offset</h2>
<p>kafka 的消息以 group 为单位给 Consumer 发送。Consumer Group 在 topic 中的 offset 存储在 broker 的 <code>__consumer_offsets</code> topic 中。</p>
<p>新加入的 consumer group 默认从最新位置读取 message。可以通过修改 Consumer 的<code>auto.offset.reset=smallest</code> 选项，让 consumer 从头开始读取 message.</p>
<p>当 broker 获取 consumer group 的 offset 出错时(offset 不存在或者 offset 超出已有的 message 的范围)，也会根据 <code>auto.offset.reset</code> 的配置来决定从什么位置开始读取 message。</p>
<ul>
<li>auto.offset.reset 说明
<ul>
<li><code>smallest</code>, <code>earliest</code> 自动将 offset 设置成最小的 offset</li>
<li><code>largest</code>, <code>latest</code> 自动将 offset 设置成最大的 offset</li>
<li><code>error</code> 抛出一个错误 (ERR__AUTO_OFFSET_RESET) consumer 可以通过 <code>message-&gt;err</code> 获取到该错误</li>
</ul>
</li>
</ul>
<h3 id="参考链接-1">参考链接</h3>
<ul>
<li><a href="https://github.com/edenhill/librdkafka/blob/master/CONFIGURATION.md">https://github.com/edenhill/librdkafka/blob/master/CONFIGURATION.md</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-b0db364c520cdda052412caee9f7bb79">3.2 - Broker</h1>
    
	<h2 id="优雅地关闭-kafka-broker">优雅地关闭 Kafka Broker</h2>
<p>向进程发送 <code>TERM</code> 信号就可以优雅地关闭 Kafka Broker</p>
<p>这是 <code>bin/kafka-server-stop.sh</code> 的内容，他的思路就是通过 ps 查找 cmd 中包括 <code>kafka.Kafka</code> 的进程，来寻找进程 ID</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#000">SIGNAL</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">${</span><span style="color:#000">SIGNAL</span><span style="color:#204a87;font-weight:bold">:-</span><span style="color:#000">TERM</span><span style="color:#4e9a06">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">OSNAME</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">$(</span>uname -s<span style="color:#204a87;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#ce5c00;font-weight:bold">[[</span> <span style="color:#4e9a06">&#34;</span><span style="color:#000">$OSNAME</span><span style="color:#4e9a06">&#34;</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#34;OS/390&#34;</span> <span style="color:#ce5c00;font-weight:bold">]]</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#204a87;font-weight:bold">then</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#ce5c00;font-weight:bold">[</span> -z <span style="color:#000">$JOBNAME</span> <span style="color:#ce5c00;font-weight:bold">]</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#204a87;font-weight:bold">then</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">JOBNAME</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;KAFKSTRT&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">fi</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">PIDS</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">$(</span>ps -A -o pid,jobname,comm <span style="color:#000;font-weight:bold">|</span> grep -i <span style="color:#000">$JOBNAME</span> <span style="color:#000;font-weight:bold">|</span> grep java <span style="color:#000;font-weight:bold">|</span> grep -v grep <span style="color:#000;font-weight:bold">|</span> awk <span style="color:#4e9a06">&#39;{print $1}&#39;</span><span style="color:#204a87;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">elif</span> <span style="color:#ce5c00;font-weight:bold">[[</span> <span style="color:#4e9a06">&#34;</span><span style="color:#000">$OSNAME</span><span style="color:#4e9a06">&#34;</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#34;OS400&#34;</span> <span style="color:#ce5c00;font-weight:bold">]]</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#204a87;font-weight:bold">then</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">PIDS</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">$(</span>ps -Af <span style="color:#000;font-weight:bold">|</span> grep -i <span style="color:#4e9a06">&#39;kafka\.Kafka&#39;</span> <span style="color:#000;font-weight:bold">|</span> grep java <span style="color:#000;font-weight:bold">|</span> grep -v grep <span style="color:#000;font-weight:bold">|</span> awk <span style="color:#4e9a06">&#39;{print $2}&#39;</span><span style="color:#204a87;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">else</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">PIDS</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87;font-weight:bold">$(</span>ps ax <span style="color:#000;font-weight:bold">|</span> grep <span style="color:#4e9a06">&#39; kafka\.Kafka &#39;</span> <span style="color:#000;font-weight:bold">|</span> grep java <span style="color:#000;font-weight:bold">|</span> grep -v grep <span style="color:#000;font-weight:bold">|</span> awk <span style="color:#4e9a06">&#39;{print $1}&#39;</span><span style="color:#204a87;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">fi</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">if</span> <span style="color:#ce5c00;font-weight:bold">[</span> -z <span style="color:#4e9a06">&#34;</span><span style="color:#000">$PIDS</span><span style="color:#4e9a06">&#34;</span> <span style="color:#ce5c00;font-weight:bold">]</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#204a87;font-weight:bold">then</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87">echo</span> <span style="color:#4e9a06">&#34;No kafka server to stop&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87">exit</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">else</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87">kill</span> -s <span style="color:#000">$SIGNAL</span> <span style="color:#000">$PIDS</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">fi</span>
</span></span></code></pre></div><p>但是 Linux 内核有限制，ps 输出的一行内容不能超过页大小 <code>PAGE_SIZE</code> (4096)，所以如果 kafka 进程的 cmd 过长，可能会导致 ps + grep 失败。</p>
<p>此时就需要我们手动来找对应的进程，可以通过 <code>ps ax | grep 'kafka'</code> 来寻找对应的进程。</p>
<h2 id="存储">存储</h2>
<ul>
<li>
<p>顺序写盘的速度不仅比随机写盘的速度快，而且也比随机写内存的速度快。kafka 在设计时采用了文件追加的方式来写入消息，即只能在日志文件的尾部追加新的消息，并且也不允许修改已经写入的消息，这种方式属于典型的顺序写盘的操作。</p>
</li>
<li>
<p>kafka 大量地使用了页缓存来提高读写文件的效率，而并没有怎么使用进程内的缓存。Java 对象的内存开销非常大，是真实数据的几倍，Java 的 GC 会随着堆内数据的增多而变得越来越慢。基于以上考虑，kafka 使用 Linux 为文件 I/O 提供的页缓存，而不是使用 Java 进程内的缓存。</p>
</li>
<li>
<p>Linux 系统提供了 swap 分区的功能，将非活跃的进程调入 swap 分区，以此把内存空出来让给活跃的进程。对于大量使用系统页缓存的 kafka 而言，应避免这种内存的交换，否则会对它各方面的性能产生较大的影响。<code>vm.swappiness</code> 参数控制 swap 分区的使用率，数值在 0 - 100，数值越大使用的越多，建议设置成1，不设置成 0 防止系统在内存耗尽时 kill 进程。</p>
</li>
</ul>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-7eb9a6396b5cbd586e9b014377b38023">4 - K8S</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-656e8e58e57239aefabf9b0ac3db78e9">4.1 - Pod 状态笔记</h1>
    
	<hr>
<h2 id="pod-状态计算细节">Pod 状态计算细节</h2>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2023-03-02-093104.png" alt=""></p>
<h2 id="pod-的-qos-分类">Pod 的 QoS 分类</h2>
<blockquote>
<p>request 是最低资源需求，limit 是最高资源需求</p>
</blockquote>
<table>
<thead>
<tr>
<th>QoS 类别</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>Guaranteed(确保)</td>
<td>Pod 的资源 request 和 limit 相同</td>
</tr>
<tr>
<td>Burstable(可破裂)</td>
<td>Pod 的资源 request 小于 limit</td>
</tr>
<tr>
<td>BestEffort(尽力而为)</td>
<td>Pod 的资源没有设置任何 request 和 limit</td>
</tr>
</tbody>
</table>
<p>当计算节点上存在内存/磁盘压力时，k8s 会按照 <code>BestEffort -&gt; Burstable -&gt; Guaranteed</code> 的顺序一次驱逐 pod.</p>
<p>CPU 是可以压缩的资源，当 CPU 存在压力时，k8s 不会驱逐 pod.</p>
<p>通常情况下，Burstable 是最好的 QoS 策略，对于一些重要的核心 pod，可以设置为 Guaranteed, 确保它最后被驱逐。</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-aaf94f93d4f526a149b5434d89980c98">4.2 - K8S 中观察 CPU Throttling 情况的指标</h1>
    
	<blockquote>
<p>解释了一下观察 CPU Throttling 情况的指标</p>
</blockquote>
<hr>
<h2 id="观察容器-cpu-throttling-的指标">观察容器 CPU Throttling 的指标</h2>
<p>k8s 中为每个 Pod 提供了限制 CPU 资源的选项，当 Pod 使用的 CPU 资源超出设置的 limit 时，会发生 Throttling 的情况，即进程被分配的 CPU 时间片被夺走了。</p>
<p>cAdvisor 提供了三个关于 CPU 运行时间的指标</p>
<table>
<thead>
<tr>
<th>name</th>
<th>desc</th>
<th>解释</th>
</tr>
</thead>
<tbody>
<tr>
<td>container_cpu_cfs_throttled_periods_total</td>
<td>Number of throttled period intervals</td>
<td>容器被 Throttled 的 CPU 时间片数</td>
</tr>
<tr>
<td>container_cpu_cfs_throttled_seconds_total</td>
<td>Total time duration the container has been throttled</td>
<td>容器被 Throttled 的 CPU 时间(单位是秒)</td>
</tr>
<tr>
<td>container_cpu_cfs_periods_total</td>
<td>Number of elapsed enforcement period intervals</td>
<td>容器被分配的，应该执行的 CPU 时间片书</td>
</tr>
</tbody>
</table>
<p>以上三个指标都是 prometheus 中的 counter 类型，即只会增加的绝对值，它们的数值对于维护者的观察意义也不大。</p>
<p>我们常用的指标是</p>

<div class="math">$$\frac{rate(container-cpu-cfs-throttled-periods-total[5m])}{rate(container-cpu-cfs-periods-total[5m])}$$</div><p>它表示 CPU 被 Throttling 的时间片占总分配的时间片的比重。我们以此来判断某个容器的 CPU 资源是否不足。</p>
<h2 id="指标的去重">指标的去重</h2>
<p>以上三个指标针对每个 Pod 都有 N+1 个，</p>
<ol>
<li>pod 的总指标</li>
<li>pod 中每个容器的指标</li>
</ol>
<p>所以计算时，我们需要设置 <code>{container=&quot;&quot;}</code> 或 <code>{image=&quot;&quot;}</code> 来只保留 pod 的指标</p>
<h2 id="指标加上-pod-label">指标加上 Pod label</h2>
<p>以上的三个指标，他们中的 label 都是和容器相关的(<code>pod</code>, <code>container</code>, <code>image</code>)，我们需要根据 pod 的 label 来对指标进行聚合，观察某个 deployment 或某个 k8s job 的 CPU Throttling 情况，此时，我们就需要用到 <code>kube_pod_label</code> 指标，来和上述指标进行相乘。</p>
<p><code>kube_pod_label</code> 是 <a href="https://github.com/kubernetes/kube-state-metrics">kube-state-metrics</a> 提供的指标，它将 k8s label 转换成 prometheus 指标，每个 pod 上的 k8s label 都在 prom 指标中变成 <code>label_xx</code> 的形式。例如我们假设某个 pod 有 app 和 owner 两个 k8s label，那么它的 prom 指标如下</p>
<pre tabindex="0"><code>kube_pod_labels{
    cluster=&#34;local&#34;, container=&#34;kube-state-metrics&#34;, endpoint=&#34;http&#34;,
    instance=&#34;172.19.2.101:8080&#34;, job=&#34;kube-state-metrics&#34;, label_app=&#34;http-bin&#34;,
    label_owner=&#34;xyd&#34;, namespace=&#34;default&#34;,
    pod=&#34;http-bin-867bc77ld45d&#34;, prometheus=&#34;monitoring/kube-prom-kube-prometheus-prometheus&#34;,
    uid=&#34;7b9c5473-1455-454d-b5a3-69f08dc99bb1&#34;
}
</code></pre><p><code>instance</code> label 表示 kube-state-metrics 的 IP 地址。</p>
<pre tabindex="0"><code>rate(
    container_cpu_cfs_throttled_periods_total{pod=&#34;http-bin-867bc77ld45d&#34;, image=&#34;&#34;}[5m]
) * on(pod) group_left(label_app, label_owner) 
    kube_pod_labels{namespace=&#34;default&#34;, pod=&#34;http-bin-867bc77ld45d&#34;}
</code></pre><p>上面的计算公式中，</p>
<ul>
<li><code>* on(pod)</code> 表示左边的指标 <code>container_cpu_cfs_throttled_periods_total</code> 和右边的指标 <code>kube_pod_labels</code> 根据相同的 <code>pod</code> label，对 value 进行相乘。</li>
<li><code>group_left(label_app, label_owner)</code> 表示将右边指标的 <code>label_app</code>, <code>label_owner</code> 添加到左边指标中，生成一个新指标</li>
<li>如果写成 <code>group_right(label_app, label_owner)</code>，表示以右边的指标为基准，将 <code>label_app</code>, <code>label_owner</code> 添加上，生成一个新指标</li>
<li>注意新指标的值是左右两个指标相乘，<code>kube_pod_labels</code> 的 value 始终是1, 所以新指标的值和 <code>container_cpu_cfs_throttled_periods_total</code> 相同</li>
<li>如果针对同一个 pod label, <code>container_cpu_cfs_throttled_periods_total</code> 有多个，那么就只能写 <code>group_left(label_app, label_owner)</code>
<ul>
<li>如果写 <code>group_right(label_app, label_owner)</code>，prom 不知道如何将多个 <code>container_cpu_cfs_throttled_periods_total</code> 聚合起来，就会报错</li>
</ul>
<pre tabindex="0"><code>Error executing query: found duplicate series for the match group {pod=&#34;http-bin-867bc77ld45d&#34;} on the left hand-side of the operation: [{...}, {...}];many-to-many matching not allowed: matching labels must be unique on one side
</code></pre></li>
<li>正常情况下，<code>kube_pod_label</code> 针对同一个 pod 只有一个，但是当 kube-state-metrics 重启的时候，由于 kube-state-metrics 的 IP 地址变了，<code>kube_pod_label</code> 就会出现 pod 相同，但是 <code>instance</code> 不同的指标。所以，最好还是要保证和 <code>kube_pod_labels</code> 相乘的指标针对同一个 pod 只有一个，否则当 kube-state-metrics 重启时，相乘的计算公式就会出现以下两种错误。
<ul>
<li>many * many 的错误</li>
<li>one * group_left() many 的错误</li>
</ul>
</li>
</ul>
<p>为 cpu throttled 指标加上 pod label 后，我们再根据 k8s app sum 一下，就得到我们最终想要的结果了</p>
<pre tabindex="0"><code>sum(
    rate(container_cpu_cfs_throttled_periods_total{namespace=&#34;default&#34;, image=&#34;&#34;}[5m])
        * on(pod) group_left(label_app, label_owner)
    kube_pod_labels{namespace=&#34;default&#34;}
) by (label_app, label_owner)
  /
sum(
    rate(container_cpu_cfs_periods_total{namespace=&#34;default&#34;, image=&#34;&#34;}[5m])
        * on(pod) group_left(label_app, label_owner)
    kube_pod_labels{namespace=&#34;default&#34;}
) by (label_app, label_owner)
</code></pre><p>上述指标按 <code>label_app</code> 和 <code>label_owner</code> 这两个维度，求和了一下符合筛选标签的所有 pod 的 CPU Throttling 时间片的百分比。</p>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-ed5c1d67de01b3a316614ab9172e7934">4.3 - K8s Pod 如何结束</h1>
    
	<hr>
<h2 id="tips">Tips</h2>
<p>k8s 停止 Pod 的过程</p>
<ol>
<li>将 Pod 的状态设置为 <code>Terminating</code>，将 Pod 从 service 的 endpoints 列表中移除。</li>
<li>执行 <a href="https://kubernetes.io/docs/concepts/containers/container-lifecycle-hooks/#hook-details">preStopHook</a></li>
<li>发送 SIGTERM 信号给进程。(注意，k8s 不会等待 preStopHook 结束后再发送信号，发送 SIGTERM 和 执行 preStopHook 是同时进行的)</li>
<li>等待 Pod 正常退出，等待的时间由 <code>terminationGracePeriod</code> 设置</li>
<li>如果等待超时，会发送 SIGKILL 信号给进程。</li>
<li>清理 k8s 中存储的 Pod 信息。</li>
</ol>
<h2 id="参考链接">参考链接</h2>
<ul>
<li><a href="https://cloud.google.com/blog/products/containers-kubernetes/kubernetes-best-practices-terminating-with-grace">Kubernetes best practices: terminating with grace</a></li>
</ul>
</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-4aaad1b9f7ee3c127b91ab5b259ce456">5 - Container</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-5dd2bc857390538c171fb56a14e4efb8">5.1 - Ubuntu 中 Docker 设置容器中 DNS 服务器的地址</h1>
    
	<hr>
<h2 id="tips">Tips</h2>
<p>修改 <code>/etc/docker/daemon.json</code> 文件，写入以下配置:</p>
<pre tabindex="0"><code>{
  &#34;dns&#34;: [
    &#34;10.8.0.1&#34;,
    &#34;192.168.45.155&#34;,
  ]
  &#34;dns-opts&#34;: [ &#34;ndots:1&#34; ]
}
</code></pre><p>这样相当于在 <code>/etc/resolv.conf</code> 设置了</p>
<pre tabindex="0"><code>nameserver 10.8.0.1
nameserver 192.168.45.155
options ndots:15
</code></pre><p>修改完成后重启 docker daemon 生效</p>
<h2 id="参考链接">参考链接</h2>
<ul>
<li><a href="https://github.com/moby/moby/issues/32093">ndots:0 #32093</a></li>
</ul>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-ebcaa5066994bddfb13c8bffcd9addae">5.2 - 从 none 开始，用网桥模式启动容器的网络</h1>
    
	<p>用 none 网络模式启动的容器，创建一个可以对外通信的网络</p>
<hr>
<h2 id="目的">目的</h2>
<p>本篇文章中，我们首先使用 none 网络模式启动一个容器，然后一步步给它配置好网络，让这个容器能够正常进行网络通信。</p>
<p>最终容器的网络架构图如下图所示:</p>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2023-01-20-103416.png" alt=""></p>
<ul>
<li>enp4s0 是宿主机的网络设备</li>
<li>eth0 是 nginx 容器的网络设备, eth0 和 A 是一对 veth 设备</li>
<li>docker0 是 docker 安装时自动创建的网桥设备</li>
</ul>
<h2 id="veth-是什么">veth 是什么</h2>
<p>veth 全称是 virtual ethernet devices, 虚拟以太网设备。
它们可以作为网络 namespace 之间通信的通道，在另一个网络 namespace 创建和网络物理设备通信的桥梁。
也可以作为内部网络设备。</p>
<p>veth 设备总是成对出现，一对 veth 设备可以用如下的命令创建:</p>
<pre tabindex="0"><code>ip link add &lt;p1-name&gt; type veth peer name &lt;p2-name&gt;
</code></pre><p>在上面的代码中，p1-name 和 p2-name 是分配给两个连接的端点的名称。</p>
<p>对一个设备上传输的数据包会立即在另一个设备上接收。当任何一个设备关闭时，veth 对的链路状态就会关闭。</p>
<p>Veth 设备对用于以有趣的方式将内核的网络设施组合在一起。</p>
<p>一个特别有趣的用例是将 veth 对的一端放在一个网络 namespace 中，
另一端放在另一个网络 namepsace 中，从而允许网络 namespace 之间进行通信。</p>
<p>为此，可以在创建接口时提供 netns 参数:</p>
<pre tabindex="0"><code>ip link add &lt;p1-name&gt; netns &lt;p1-ns&gt; type veth peer &lt;p2-name&gt; netns &lt;p2-ns&gt;
</code></pre><p>或者，对于现有的 veth 对，可以将一端移动到另一个名称空间:</p>
<pre tabindex="0"><code>ip link set &lt;p2-name&gt; netns &lt;p2-ns&gt;
</code></pre><p><a href="https://man7.org/linux/man-pages/man8/ethtool.8.html">ethtool(8)</a> 可用于查找 veth 网络接口的对等点，使用类似下面这样的命令:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ ip link add ve_A <span style="color:#204a87">type</span> veth peer name ve_B   <span style="color:#8f5902;font-style:italic"># 创建一对 veth 设备</span>
</span></span><span style="display:flex;"><span>$ ethtool -S ve_A         <span style="color:#8f5902;font-style:italic"># 查找 ve_A 接口对端接口的索引</span>
</span></span><span style="display:flex;"><span>NIC statistics:
</span></span><span style="display:flex;"><span>    peer_ifindex: <span style="color:#0000cf;font-weight:bold">16</span>
</span></span><span style="display:flex;"><span>$ ip link <span style="color:#000;font-weight:bold">|</span> grep <span style="color:#4e9a06">&#39;^16:&#39;</span>   <span style="color:#8f5902;font-style:italic"># 查找索引是 16 的设备</span>
</span></span><span style="display:flex;"><span>16: ve_B@ve_A: &lt;BROADCAST,MULTICAST,M-DOWN&gt; mtu <span style="color:#0000cf;font-weight:bold">1500</span> qdisc ...
</span></span></code></pre></div><ul>
<li><strong>注意</strong>：如果 veth 的设备名太长，ethtool 会出错</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>root@Macmini:~# ethtool -S veth550bfa1@if25
</span></span><span style="display:flex;"><span>ioctl-only request, device name longer than <span style="color:#0000cf;font-weight:bold">15</span> not supported
</span></span></code></pre></div><h2 id="准备工作">准备工作</h2>
<ul>
<li>查看当前主机上的网桥设备，默认有一个 docker0</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>root@dockervbox:~# brctl show
</span></span><span style="display:flex;"><span>bridge name     bridge id               STP enabled     interfaces
</span></span><span style="display:flex;"><span>docker0         8000.02421f335f1f       no
</span></span></code></pre></div><ul>
<li>创建 /var/run/netns 目录，ip netns 操作的就是此目录中的网络 namespace</li>
<li>删除 /var/run/netns 中的所有目录</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>root@dockervbox:~# mkdir -p /var/run/netns
</span></span><span style="display:flex;"><span>root@dockervbox:~# find -L /var/run/netns -type l -delete
</span></span></code></pre></div><h2 id="启动容器">启动容器</h2>
<ul>
<li>使用 none 网络模式启动一个 nginx 容器</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>ø&gt; docker run --rm -it --network<span style="color:#ce5c00;font-weight:bold">=</span>none -d nginx
</span></span><span style="display:flex;"><span>ebcf462cbb463d41dd677a501aee5a629f587141c27632d4954017784877b7c0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ø&gt; docker ps
</span></span><span style="display:flex;"><span>CONTAINER ID   IMAGE     COMMAND                  CREATED         STATUS         PORTS     NAMES
</span></span><span style="display:flex;"><span>ebcf462cbb46   nginx     <span style="color:#4e9a06">&#34;/docker-entrypoint.…&#34;</span>   <span style="color:#0000cf;font-weight:bold">6</span> minutes ago   Up <span style="color:#0000cf;font-weight:bold">6</span> minutes             exciting_torvalds
</span></span></code></pre></div><ul>
<li>启动成功后，记录此容器的 pid 到 $pid 环境变量</li>
</ul>
<pre tabindex="0"><code>ø&gt; docker inspect ebcf462cbb463d41dd677a501aee5a629f587141c27632d4954017784877b7c0 | grep -i pid
            &#34;Pid&#34;: 119320,
            &#34;PidMode&#34;: &#34;&#34;,
            &#34;PidsLimit&#34;: null,
ø&gt; export pid=119320
ø&gt; echo $pid
119320
</code></pre><ul>
<li>进入 $pid 进程所在的网络 ns, 查看所有的网络设备，可以看到只有一个 lo 设备，没有其他的网络设备</li>
</ul>
<pre tabindex="0"><code>root@Macmini:~# nsenter -t $pid -n ip a
1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
inet 127.0.0.1/8 scope host lo
valid_lft forever preferred_lft forever
</code></pre><ul>
<li>软链接 $pid 的网络 ns 到 /var/run/netns/ 中, 使 ip netns 可以操作它</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>root@Macmini:~# ln -s <span style="color:#4e9a06">&#34;/proc/</span><span style="color:#000">$pid</span><span style="color:#4e9a06">/ns/net&#34;</span> /var/run/netns/<span style="color:#000">$pid</span>
</span></span><span style="display:flex;"><span>root@Macmini:~# ls /var/run/netns/119320
</span></span><span style="display:flex;"><span>/var/run/netns/119320
</span></span><span style="display:flex;"><span>root@Macmini:~# ip netns list
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">119320</span>
</span></span></code></pre></div><ul>
<li>使用 <code>lsns -t net</code> 查看当前系统的 network namespace, 可以看到已经有 nginx 容器的 network namespace 了</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>root@Macmini:~# lsns -t net <span style="color:#000;font-weight:bold">|</span> head -n <span style="color:#0000cf;font-weight:bold">3</span>
</span></span><span style="display:flex;"><span>        NS TYPE NPROCS    PID USER         NETNSID NSFS                           COMMAND
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">4026531840</span> net     <span style="color:#0000cf;font-weight:bold">345</span>      <span style="color:#0000cf;font-weight:bold">1</span> root      unassigned                                /sbin/init
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">4026532348</span> net      <span style="color:#0000cf;font-weight:bold">13</span> <span style="color:#0000cf;font-weight:bold">119320</span> root      unassigned /run/docker/netns/2bdfbe67a978 nginx: master process nginx -g daemon off<span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><ul>
<li>查看 <code>/proc/$pid/ns</code> 目录中的 namespace id, 能够看到 net namespace id 和 lsns 列出的 id 相同</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>root@Macmini:~# ls -l /proc/<span style="color:#000">$pid</span>/ns
</span></span><span style="display:flex;"><span>总用量 <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>lrwxrwxrwx <span style="color:#0000cf;font-weight:bold">1</span> root root <span style="color:#0000cf;font-weight:bold">0</span>  1月 <span style="color:#0000cf;font-weight:bold">20</span> 11:01 cgroup -&gt; <span style="color:#4e9a06">&#39;cgroup:[4026532904]&#39;</span>
</span></span><span style="display:flex;"><span>lrwxrwxrwx <span style="color:#0000cf;font-weight:bold">1</span> root root <span style="color:#0000cf;font-weight:bold">0</span>  1月 <span style="color:#0000cf;font-weight:bold">20</span> 11:01 ipc -&gt; <span style="color:#4e9a06">&#39;ipc:[4026532307]&#39;</span>
</span></span><span style="display:flex;"><span>lrwxrwxrwx <span style="color:#0000cf;font-weight:bold">1</span> root root <span style="color:#0000cf;font-weight:bold">0</span>  1月 <span style="color:#0000cf;font-weight:bold">20</span> 11:01 mnt -&gt; <span style="color:#4e9a06">&#39;mnt:[4026532278]&#39;</span>
</span></span><span style="display:flex;"><span>lrwxrwxrwx <span style="color:#0000cf;font-weight:bold">1</span> root root <span style="color:#0000cf;font-weight:bold">0</span>  1月 <span style="color:#0000cf;font-weight:bold">20</span> 10:50 net -&gt; <span style="color:#4e9a06">&#39;net:[4026532348]&#39;</span>
</span></span><span style="display:flex;"><span>lrwxrwxrwx <span style="color:#0000cf;font-weight:bold">1</span> root root <span style="color:#0000cf;font-weight:bold">0</span>  1月 <span style="color:#0000cf;font-weight:bold">20</span> 11:01 pid -&gt; <span style="color:#4e9a06">&#39;pid:[4026532312]&#39;</span>
</span></span><span style="display:flex;"><span>lrwxrwxrwx <span style="color:#0000cf;font-weight:bold">1</span> root root <span style="color:#0000cf;font-weight:bold">0</span>  1月 <span style="color:#0000cf;font-weight:bold">20</span> 11:01 pid_for_children -&gt; <span style="color:#4e9a06">&#39;pid:[4026532312]&#39;</span>
</span></span><span style="display:flex;"><span>lrwxrwxrwx <span style="color:#0000cf;font-weight:bold">1</span> root root <span style="color:#0000cf;font-weight:bold">0</span>  1月 <span style="color:#0000cf;font-weight:bold">20</span> 11:01 <span style="color:#204a87">time</span> -&gt; <span style="color:#4e9a06">&#39;time:[4026531834]&#39;</span>
</span></span><span style="display:flex;"><span>lrwxrwxrwx <span style="color:#0000cf;font-weight:bold">1</span> root root <span style="color:#0000cf;font-weight:bold">0</span>  1月 <span style="color:#0000cf;font-weight:bold">20</span> 11:01 time_for_children -&gt; <span style="color:#4e9a06">&#39;time:[4026531834]&#39;</span>
</span></span><span style="display:flex;"><span>lrwxrwxrwx <span style="color:#0000cf;font-weight:bold">1</span> root root <span style="color:#0000cf;font-weight:bold">0</span>  1月 <span style="color:#0000cf;font-weight:bold">20</span> 11:01 user -&gt; <span style="color:#4e9a06">&#39;user:[4026531837]&#39;</span>
</span></span><span style="display:flex;"><span>lrwxrwxrwx <span style="color:#0000cf;font-weight:bold">1</span> root root <span style="color:#0000cf;font-weight:bold">0</span>  1月 <span style="color:#0000cf;font-weight:bold">20</span> 11:01 uts -&gt; <span style="color:#4e9a06">&#39;uts:[4026532280]&#39;</span>
</span></span></code></pre></div><h2 id="创建-veth-设备">创建 veth 设备</h2>
<ul>
<li>创建一对 veth 设备，叫做 A 和 B</li>
<li>将 A 连接到 docker0 网桥上</li>
<li>启动 A</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>root@Macmini:~# ip link add A <span style="color:#204a87">type</span> veth peer name B
</span></span><span style="display:flex;"><span>root@Macmini:~# brctl addif docker0 A
</span></span><span style="display:flex;"><span>root@Macmini:~# ip link <span style="color:#204a87">set</span> A up
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># A 处于 UP 状态，但因为 A 没有完全连通，所以还是有 M-DOWN 的状态</span>
</span></span><span style="display:flex;"><span>root@Macmini:~# ip a
</span></span><span style="display:flex;"><span>23: B@A: &lt;BROADCAST,MULTICAST&gt; mtu <span style="color:#0000cf;font-weight:bold">1500</span> qdisc noop state DOWN group default qlen <span style="color:#0000cf;font-weight:bold">1000</span>
</span></span><span style="display:flex;"><span>    link/ether 16:81:96:a3:bf:27 brd ff:ff:ff:ff:ff:ff
</span></span><span style="display:flex;"><span>24: A@B: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP,M-DOWN&gt; mtu <span style="color:#0000cf;font-weight:bold">1500</span> qdisc noqueue master docker0 state LOWERLAYERDOWN group default qlen <span style="color:#0000cf;font-weight:bold">1000</span>
</span></span><span style="display:flex;"><span>    link/ether 76:8b:1a:65:f5:57 brd ff:ff:ff:ff:ff:ff
</span></span></code></pre></div><h2 id="设置-veth-设备">设置 veth 设备</h2>
<ul>
<li>将 ip, 掩码， 网关保存成环境变量</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>root@Macmini:~# <span style="color:#000">SETIP</span><span style="color:#ce5c00;font-weight:bold">=</span>172.17.0.10
</span></span><span style="display:flex;"><span>root@Macmini:~# <span style="color:#000">SETMASK</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">16</span>
</span></span><span style="display:flex;"><span>root@Macmini:~# <span style="color:#000">GATEWAY</span><span style="color:#ce5c00;font-weight:bold">=</span>172.17.0.1
</span></span></code></pre></div><ul>
<li>将 veth 设备 B 加入到 $pid 所在的 network namespace 中</li>
<li>并将 设备 B 的名字改成 eth0</li>
</ul>
<pre tabindex="0"><code>root@Macmini:~# ip link set B netns $pid
root@Macmini:~# ip netns exec $pid ip link set dev B name eth0
</code></pre><ul>
<li>此时查看 $pid network namespace 中的网络设备，可以看到 eth0 已经存在了</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>root@Macmini:~# ip netns <span style="color:#204a87">exec</span> <span style="color:#000">$pid</span> ip a
</span></span><span style="display:flex;"><span>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu <span style="color:#0000cf;font-weight:bold">65536</span> qdisc noqueue state UNKNOWN group default qlen <span style="color:#0000cf;font-weight:bold">1000</span>
</span></span><span style="display:flex;"><span>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
</span></span><span style="display:flex;"><span>    inet 127.0.0.1/8 scope host lo
</span></span><span style="display:flex;"><span>       valid_lft forever preferred_lft forever
</span></span><span style="display:flex;"><span>23: eth0@if24: &lt;BROADCAST,MULTICAST&gt; mtu <span style="color:#0000cf;font-weight:bold">1500</span> qdisc noop state DOWN group default qlen <span style="color:#0000cf;font-weight:bold">1000</span>
</span></span><span style="display:flex;"><span>    link/ether 16:81:96:a3:bf:27 brd ff:ff:ff:ff:ff:ff link-netnsid <span style="color:#0000cf;font-weight:bold">0</span>
</span></span></code></pre></div><ul>
<li>启动 eth0</li>
<li>因为 A 已经连接到了网桥上，所以直接启动成功，出现了 <code>LOWER_UP</code> 的状态</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>root@Macmini:~# ip netns <span style="color:#204a87">exec</span> <span style="color:#000">$pid</span> ip link <span style="color:#204a87">set</span> eth0 up
</span></span><span style="display:flex;"><span>root@Macmini:~# ip netns <span style="color:#204a87">exec</span> <span style="color:#000">$pid</span> ip a
</span></span><span style="display:flex;"><span>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu <span style="color:#0000cf;font-weight:bold">65536</span> qdisc noqueue state UNKNOWN group default qlen <span style="color:#0000cf;font-weight:bold">1000</span>
</span></span><span style="display:flex;"><span>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
</span></span><span style="display:flex;"><span>    inet 127.0.0.1/8 scope host lo
</span></span><span style="display:flex;"><span>       valid_lft forever preferred_lft forever
</span></span><span style="display:flex;"><span>23: eth0@if24: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span style="color:#0000cf;font-weight:bold">1500</span> qdisc noqueue state UP group default qlen <span style="color:#0000cf;font-weight:bold">1000</span>
</span></span><span style="display:flex;"><span>    link/ether 16:81:96:a3:bf:27 brd ff:ff:ff:ff:ff:ff link-netnsid <span style="color:#0000cf;font-weight:bold">0</span>
</span></span></code></pre></div><ul>
<li>设置 IP 和路由</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 设置 $pid ns 中的 eth0 设备的 ip 和 掩码</span>
</span></span><span style="display:flex;"><span>root@dockervbox:~# ip netns <span style="color:#204a87">exec</span> <span style="color:#000">$pid</span> ip addr add <span style="color:#000">$SETIP</span>/<span style="color:#000">$SETMASK</span> dev eth0
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 设置 $pid ns 中的 eth0 设备的默认路由网关</span>
</span></span><span style="display:flex;"><span>root@dockervbox:~# ip netns <span style="color:#204a87">exec</span> <span style="color:#000">$pid</span> ip route add default via <span style="color:#000">$GATEWAY</span>
</span></span></code></pre></div><ul>
<li>查看 IP 和路由</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 查看 $pid ns 中的所有设备，可以看到 eth0 已经启动成功，并且有了 ip 和子网掩码</span>
</span></span><span style="display:flex;"><span>root@Macmini:~# nsenter -t <span style="color:#000">$pid</span> -n ip a
</span></span><span style="display:flex;"><span>1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu <span style="color:#0000cf;font-weight:bold">65536</span> qdisc noqueue state UNKNOWN group default qlen <span style="color:#0000cf;font-weight:bold">1000</span>
</span></span><span style="display:flex;"><span>    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
</span></span><span style="display:flex;"><span>    inet 127.0.0.1/8 scope host lo
</span></span><span style="display:flex;"><span>       valid_lft forever preferred_lft forever
</span></span><span style="display:flex;"><span>23: eth0@if24: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span style="color:#0000cf;font-weight:bold">1500</span> qdisc noqueue state UP group default qlen <span style="color:#0000cf;font-weight:bold">1000</span>
</span></span><span style="display:flex;"><span>    link/ether 16:81:96:a3:bf:27 brd ff:ff:ff:ff:ff:ff link-netnsid <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>    inet 172.17.0.10/16 scope global eth0
</span></span><span style="display:flex;"><span>       valid_lft forever preferred_lft forever
</span></span></code></pre></div><ul>
<li>查看 $pid ns 中的路由表，可以看到 eth0 默认的路由地址是 172.17.0.1</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>root@Macmini:~# nsenter -t <span style="color:#000">$pid</span> -n ip route
</span></span><span style="display:flex;"><span>default via 172.17.0.1 dev eth0
</span></span><span style="display:flex;"><span>172.17.0.0/16 dev eth0 proto kernel scope link src 172.17.0.10
</span></span></code></pre></div><ul>
<li>查看宿主机上的网络设备，可以看到 veth A 的名字变成了 A@if23, 并且状态已经由 <code>M-DOWN</code> 变成了 <code>LOWER_UP</code></li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>root@Macmini:~# ip a
</span></span><span style="display:flex;"><span>24: A@if23: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu <span style="color:#0000cf;font-weight:bold">1500</span> qdisc noqueue master docker0 state UP group default qlen <span style="color:#0000cf;font-weight:bold">1000</span>
</span></span><span style="display:flex;"><span>    link/ether 76:8b:1a:65:f5:57 brd ff:ff:ff:ff:ff:ff link-netns <span style="color:#0000cf;font-weight:bold">119320</span>
</span></span><span style="display:flex;"><span>    inet6 fe80::748b:1aff:fe65:f557/64 scope link
</span></span><span style="display:flex;"><span>       valid_lft forever preferred_lft forever
</span></span></code></pre></div><h2 id="容器网络启动成功">容器网络启动成功</h2>
<ul>
<li>最后，我们在容器中访问互联网，能够成功访问</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>root@Macmini:~# docker <span style="color:#204a87">exec</span> ebcf462cbb46 curl -I www.baidu.com
</span></span><span style="display:flex;"><span>  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
</span></span><span style="display:flex;"><span>                                 Dload  Upload   Total   Spent    Left  Speed
</span></span><span style="display:flex;"><span>  <span style="color:#0000cf;font-weight:bold">0</span>   <span style="color:#0000cf;font-weight:bold">277</span>    <span style="color:#0000cf;font-weight:bold">0</span>     <span style="color:#0000cf;font-weight:bold">0</span>    <span style="color:#0000cf;font-weight:bold">0</span>     <span style="color:#0000cf;font-weight:bold">0</span>      <span style="color:#0000cf;font-weight:bold">0</span>      <span style="color:#0000cf;font-weight:bold">0</span> --:--:-- --:--:-- --:--:--     <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>HTTP/1.1 <span style="color:#0000cf;font-weight:bold">200</span> OK
</span></span><span style="display:flex;"><span>Accept-Ranges: bytes
</span></span><span style="display:flex;"><span>Cache-Control: private, no-cache, no-store, proxy-revalidate, no-transform
</span></span><span style="display:flex;"><span>Connection: keep-alive
</span></span><span style="display:flex;"><span>Content-Length: <span style="color:#0000cf;font-weight:bold">277</span>
</span></span><span style="display:flex;"><span>Content-Type: text/html
</span></span><span style="display:flex;"><span>Date: Fri, <span style="color:#0000cf;font-weight:bold">20</span> Jan <span style="color:#0000cf;font-weight:bold">2023</span> 03:33:01 GMT
</span></span><span style="display:flex;"><span>Etag: <span style="color:#4e9a06">&#34;575e1f60-115&#34;</span>
</span></span><span style="display:flex;"><span>Last-Modified: Mon, <span style="color:#0000cf;font-weight:bold">13</span> Jun <span style="color:#0000cf;font-weight:bold">2016</span> 02:50:08 GMT
</span></span><span style="display:flex;"><span>Pragma: no-cache
</span></span><span style="display:flex;"><span>Server: bfe/1.0.8.18
</span></span></code></pre></div><ul>
<li>在宿主机上访问 nginx 容器的 ip, 也能够正常访问</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>root@Macmini:~# curl -I <span style="color:#000">$SETIP</span>
</span></span><span style="display:flex;"><span>HTTP/1.1 <span style="color:#0000cf;font-weight:bold">200</span> OK
</span></span><span style="display:flex;"><span>Server: nginx/1.23.3
</span></span><span style="display:flex;"><span>Date: Fri, <span style="color:#0000cf;font-weight:bold">20</span> Jan <span style="color:#0000cf;font-weight:bold">2023</span> 03:28:12 GMT
</span></span><span style="display:flex;"><span>Content-Type: text/html
</span></span><span style="display:flex;"><span>Content-Length: <span style="color:#0000cf;font-weight:bold">615</span>
</span></span><span style="display:flex;"><span>Last-Modified: Tue, <span style="color:#0000cf;font-weight:bold">13</span> Dec <span style="color:#0000cf;font-weight:bold">2022</span> 15:53:53 GMT
</span></span><span style="display:flex;"><span>Connection: keep-alive
</span></span><span style="display:flex;"><span>ETag: <span style="color:#4e9a06">&#34;6398a011-267&#34;</span>
</span></span><span style="display:flex;"><span>Accept-Ranges: bytes
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-b711168a3d768a0c419283a9a611a17f">5.3 - Ubuntu 下安装 Containerd 及配置代理</h1>
    
	<blockquote>
<p>介绍了安装 containerd 的方法</p>
</blockquote>
<hr>
<h2 id="安装-containerd">安装 containerd</h2>
<ul>
<li>卸载从 apt 源安装的 containerd</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>apt-get remove -y containerd docker.io
</span></span><span style="display:flex;"><span>rm -vf /etc/systemd/system/containerd.service
</span></span><span style="display:flex;"><span>rm -rvf /etc/systemd/system/containerd.service.d
</span></span></code></pre></div><ul>
<li>安装 containerd 二进制文件</li>
</ul>
<ol>
<li>从 <a href="https://github.com/containerd/containerd/releases">containerd release 页面</a> 下载 <code>containerd-{version}-linux-amd64.tar.gz</code></li>
<li>将 containerd 的二进制文件解压到 /usr/local/bin 中</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 我下载的是 1.6.8 版本</span>
</span></span><span style="display:flex;"><span>tar Cxzvf /usr/local containerd-1.6.8-linux-amd64.tar.gz
</span></span></code></pre></div><ol start="3">
<li>从 <a href="https://github.com/containerd/containerd/blob/main/containerd.service">containerd 仓库</a> 中下载 systemd 配置文件, 并将其复制到 <code>/usr/local/lib/systemd/system/containerd.service</code> 中</li>
<li>重启令 systemd 配置文件生效</li>
</ol>
<pre tabindex="0"><code>systemctl daemon-reload
systemctl enable --now containerd
</code></pre><ul>
<li>安装 runc</li>
</ul>
<ol>
<li>从 <a href="https://github.com/opencontainers/runc/releases">runc release 页面</a> 下载 <code>runc.amd64</code></li>
<li>安装 runc,</li>
</ol>
<pre tabindex="0"><code>install -m 755 runc.amd64 /usr/local/sbin/runc
</code></pre><ul>
<li>安装 CNI 插件</li>
</ul>
<ol>
<li>从 <a href="https://github.com/containernetworking/plugins/releases">containernetworking release 页面</a> 下载 <code>cni-plugins-linux-amd64-v{vesion}.tgz</code></li>
<li>将其解压到 <code>/opt/cni/bin</code> 中</li>
</ol>
<pre tabindex="0"><code>mkdir -p /opt/cni/bin
tar Cxzvf /opt/cni/bin cni-plugins-linux-amd64-v1.1.1.tgz
</code></pre><h2 id="containerd-客户端的说明">containerd 客户端的说明</h2>
<table>
<thead>
<tr>
<th>Name</th>
<th>Community</th>
<th>API</th>
<th>Target</th>
<th>Web site</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ctr</code></td>
<td>containerd</td>
<td>Native</td>
<td>For debugging only</td>
<td>(None, see <code>ctr --help</code> to learn the usage)</td>
</tr>
<tr>
<td><code>nerdctl</code></td>
<td>containerd (non-core)</td>
<td>Native</td>
<td>General-purpose</td>
<td><a href="https://github.com/containerd/nerdctl">https://github.com/containerd/nerdctl</a></td>
</tr>
<tr>
<td><code>crictl</code></td>
<td>Kubernetes SIG-node</td>
<td>CRI</td>
<td>For debugging only</td>
<td><a href="https://github.com/kubernetes-sigs/cri-tools/blob/master/docs/crictl.md">https://github.com/kubernetes-sigs/cri-tools/blob/master/docs/crictl.md</a></td>
</tr>
</tbody>
</table>
<p>一共有三种命令行工具可以和 containerd 交互:</p>
<ul>
<li><code>ctr</code> 和 <code>nerdctl</code> 都是 containerd 社区提供的工具, <code>ctr</code> 是和 <code>containerd</code> 一起安装的.</li>
<li><code>crictl</code> 是 k8s 社区提供的符合 CRI 接口的交互工具. 在 Ubuntu 下,可以通过 <code>sudo apt get install cri-tools</code> 安装 <code>crictl</code></li>
</ul>
<h2 id="生成-containerd-配置文件">生成 containerd 配置文件</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>containerd config default <span style="color:#000;font-weight:bold">|</span> sudo tee /etc/containerd/config.toml
</span></span></code></pre></div><p>执行以上命令可以生成 containerd 的默认配置文件, 我们可以做一些自定义的修改, 例如修改 <code>[plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.runtimes.runc.options]</code>, 令 <code>SystemdCgroup = true</code>, 让 containerd 和 systemd 使用同一个 cgroups 控制器</p>
<p>crictl 默认连接的 service socket是 <code>unix:///var/run/dockershim.sock</code>, 我们可以在 <code>/etc/crictl.yaml</code> 中写入以下配置</p>
<pre tabindex="0"><code>runtime-endpoint: unix:///run/containerd/containerd.sock
</code></pre><p>让它默认连接 containerd 的 socket 接口</p>
<h2 id="设置拉取镜像的-http-代理">设置拉取镜像的 http 代理</h2>
<p>通过设置 <code>HTTP_PROXY</code>, <code>HTTPS_PROXY</code> 环境变量, 可以设置 http 代理.</p>
<blockquote>
<p><strong>注意</strong></p>
<ul>
<li><code>ctr pull ...</code> 是在客户端进程中拉取镜像的, 环境变量需要设置到客户端中</li>
<li><code>crictl pull ...</code> 是在 cri 插件中拉取镜像的, 它被集成到了 containerd 中, 所以需要在 server 端设置环境变量</li>
</ul>
</blockquote>
<h3 id="设置-server-端的环境变量">设置 server 端的环境变量</h3>
<p>修改 <code>/usr/local/lib/systemd/system/containerd.service</code> 文件, 在 <code>[Service]</code> 段加入以下内容</p>
<pre tabindex="0"><code># 设置拉取镜像的代理
Environment=HTTP_PROXY=127.0.0.1:8118
Environment=HTTPS_PROXY=127.0.0.1:8118
Environment=NO_PROXY=localhost,127.0.0.1,172.17.0.0/16,192.168.56.0/24,10.96.0.0/16
</code></pre><p>修改完以上配置后, 重启 containerd , 环境变量就生效了</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>systemctl daemon-reload
</span></span><span style="display:flex;"><span>systemctl restart containerd
</span></span></code></pre></div><p>此时再执行 <code>sudo crictl pull k8s.gcr.io/kube-controller-manager:v1.24.4</code> 就可以成功拉取到 k8s 相关的镜像了, 也能够正常地和 <code>kubeadm</code> 交互了</p>
<h3 id="设置-client-侧的环境变量">设置 client 侧的环境变量</h3>
<p>如果想通过 <code>ctr</code> 拉取镜像, 需要在 client 侧设置环境变量</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>sudo <span style="color:#000">HTTP_PROXY</span><span style="color:#ce5c00;font-weight:bold">=</span>127.0.0.1:8118 <span style="color:#000">HTTPS_PROXY</span><span style="color:#ce5c00;font-weight:bold">=</span>127.0.0.1:8118 ctr i pull k8s.gcr.io/kube-apiserver:v1.24.4
</span></span></code></pre></div><p>这样也能正常拉取镜像</p>
<h2 id="参考链接">参考链接</h2>
<ul>
<li><a href="https://github.com/containerd/containerd/blob/main/docs/getting-started.md">https://github.com/containerd/containerd/blob/main/docs/getting-started.md</a></li>
<li><a href="https://github.com/containerd/cri/issues/1169#issuecomment-501376676">https://github.com/containerd/cri/issues/1169#issuecomment-501376676</a></li>
</ul>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-72ba781c964286a98ded46d175dfee82">5.4 - Docker 客户端连接远程 Docker Daemon</h1>
    
	<blockquote>
<ul>
<li>Docker 客户端连接远程 Docker Daemon</li>
<li><a href="https://dockerlabs.collabnix.com/beginners/components/daemon/access-daemon-externally.html">参考链接 How to Connect to a Remote Docker Daemon</a></li>
</ul>
</blockquote>
<hr>
<h2 id="环境准备">环境准备</h2>
<ul>
<li>Ubuntu 18.04 运行着 Docker Daemon 19.03.6</li>
<li>MacOS 系统运行着 Docker Client 20.10.2 版本</li>
</ul>
<h2 id="设置-ubuntu-中的-docker-daemon">设置 Ubuntu 中的 Docker Daemon</h2>
<p><strong>注:</strong> 这一小节的命令都在 Ubuntu 中执行</p>
<ul>
<li>配置 Docker Daemon</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 创建 docker service 的配置文件目录</span>
</span></span><span style="display:flex;"><span>sudo mkdir -p /etc/systemd/system/docker.service.d
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 修改 docker service 的启动命令，令其监听本地套接字文件和 2375 端口</span>
</span></span><span style="display:flex;"><span>sudo cat &gt; /etc/systemd/system/docker.service.d/options.conf <span style="color:#4e9a06">&lt;&lt;EOF
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">[Service]
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">ExecStart=
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock -H tcp://0.0.0.0:2375
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">EOF</span>
</span></span></code></pre></div><ul>
<li>
<p>TODO: 配置防火墙 (由于我的 Ubuntu 是台虚拟机，我直接将防火墙关闭了)</p>
</li>
<li>
<p>重启 docker service，令配置生效</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>sudo systemctl daemon-reload <span style="color:#8f5902;font-style:italic"># 重新载入 systemd 关于 docker service 的配置</span>
</span></span><span style="display:flex;"><span>sudo systemctl restart docker.service <span style="color:#8f5902;font-style:italic"># 重启 docker service</span>
</span></span></code></pre></div><ul>
<li>执行 <code>docker version -f '{{.Server.APIVersion}}'</code>，查看 Docker API 版本，我的版本是 <code>1.40</code></li>
</ul>
<h2 id="客户端测试连接">客户端测试连接</h2>
<p><strong>注:</strong> 这一小节的命令都在 MacOS 中执行</p>
<ul>
<li>执行 <code>curl 192.168.56.23:2375/v1.40/images/json</code>，会列出所有已经下载的镜像，若返回值正确，表示 Docker Daemon 已经配置好了</li>
<li>使用 docker client 连接 Ubuntu 中的 Docker Daemon</li>
</ul>
<pre tabindex="0"><code>ø&gt; DOCKER_HOST=tcp://192.168.56.23:2375 docker images                                                                                                                                                                                                                                                     11:55:17 (05-22)
REPOSITORY                        TAG       IMAGE ID       CREATED         SIZE
ubuntu                            20.04     8e428cff54c8   8 weeks ago     72.9MB
ubuntu                            latest    8e428cff54c8   8 weeks ago     72.9MB
elasticsearch                     7.5.1     2bd69c322e98   17 months ago   779MB
docker.elastic.co/kibana/kibana   7.1.0     714b175e84e8   2 years ago     745MB
</code></pre><p>最后，我在 zshrc 中添加了一条 alias:</p>
<pre tabindex="0"><code>(( $+commands[docker] )) &amp;&amp; alias docker=&#34;DOCKER_HOST=tcp://192.168.56.23:2375 docker&#34;
</code></pre><p>这样在 MacOS 中执行 docker 命令访问的就是 Ubuntu 虚拟机中的 Docker Daemon 了。</p>
</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-5b8be070e024dee1528ca4106a3ef913">6 - HTTP</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-674980be1abe17a6cece69ef854e0dca">6.1 - HTTP 协议中带下划线的 header 说明</h1>
    
	<hr>
<h2 id="http-header-名字的规范">HTTP Header 名字的规范</h2>
<p><a href="https://www.rfc-editor.org/rfc/rfc9110.html#fields.registry">RFC9110</a> 中说，Field Name <strong>应该</strong> 仅包含字母数字，连字符(<code>-</code>), 第一个字符是字母，不区分大小写。</p>
<blockquote>
<p>The requested field name. It MUST conform to the field-name syntax defined in Section 5.1, and it SHOULD be restricted to just letters, digits, and hyphen (&rsquo;-&rsquo;) characters, with the first character being a letter.</p>
</blockquote>
<p>自定义专用的标头之前可以与 <code>X-</code> 前缀一起使用，但是这种用法被 IETF 在 2012 年 6 月发布的 <a href="https://datatracker.ietf.org/doc/html/rfc6648">RFC 6648</a> 明确弃用，原因是其会在非标准字段成为标准时造成不便；</p>
<p>一个标准的 HTTP Header 诞生要经历漫长的过程，而且我们的 Header 中如果有业务前缀的话，基本不会和标准 HTTP Header 冲突，所以很多文章说使用 <code>X-</code> 前缀也没有什么问题。</p>
<p>Nginx 的 <a href="http://nginx.org/en/docs/http/ngx_http_core_module.html#ignore_invalid_headers">ignore_invalid_headers</a> 配置文档中说，Http Header 名称由字母数字，连字符组成，<code>underscores_in_headers</code> 开启时可以包含下划线。</p>
<p>当在 Nginx 中设置了 <code>ignore_invalid_headers on;</code> 时， Nginx 会自动丢弃名称无效的 Header 。</p>
<h2 id="如何让-nginx-允许-header-名中带下划线">如何让 Nginx 允许 Header 名中带下划线</h2>
<p>Nginx 的选项 <a href="http://nginx.org/en/docs/http/ngx_http_core_module.html#underscores_in_headers">underscores_in_headers</a> 可以允许我们在 HTTP Header 的名字中带上下划线。</p>
<blockquote>
<p>Enables or disables the use of underscores in client request header fields. When the use of underscores is disabled, request header fields whose names contain underscores are marked as invalid and become subject to the ignore_invalid_headers directive.</p>
</blockquote>
<h2 id="实验">实验</h2>
<h3 id="使用-nc-启动一个-http-server">使用 nc 启动一个 http server</h3>
<ul>
<li>/tmp/index.http</li>
</ul>
<pre tabindex="0"><code>HTTP/1.1 200 OK
Content-Type: text/html; charset=UTF-8
Content-Length: 77
Server: netcat!

&lt;!doctype html&gt;
&lt;html&gt;&lt;body&gt;&lt;h1&gt;A webpage served by netcat&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;
</code></pre><ul>
<li>使用 nc 启动 web server</li>
</ul>
<pre tabindex="0"><code>while true;do cat /tmp/index.http| nc -l -p 8090 ;done
</code></pre><blockquote>
<p><strong>注意</strong>: 不能使用 flask 作为后端</p>
<p>Python 的 wsgi 解析器或 Flask 中会自动丢掉名字中带下划线的 header, 使用 flask 作为后端，就算 Nginx 传了下划线 Header 我们也看不到。</p>
<p>使用 nc 作为后端 Web Server, 它会原样输出 nginx 传输给它的内容。</p>
</blockquote>
<p>我们使用 curl 命令给 Nginx Server 发送带下划线的 Header</p>
<pre tabindex="0"><code>curl -H &#39;Some_Header: V1&#39; -s flask.bwangel.me
</code></pre><h3 id="默认不会传输带下划线的-header">默认不会传输带下划线的 Header</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">server</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">listen</span> <span style="color:#0000cf;font-weight:bold">80</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">server_name</span> <span style="color:#4e9a06">flask.bwangel.me</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">location</span> <span style="color:#4e9a06">/</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">proxy_set_header</span> <span style="color:#4e9a06">Nginx-Host</span> <span style="color:#4e9a06">&#34;flask&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">proxy_pass</span> <span style="color:#4e9a06">http://127.0.0.1:8090</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><img src="https://github.com/bwangelme/bwangelme.github.io/assets/11701497/419ee40b-ffc6-4c69-9955-4358d6e8ac36" alt="image"></p>
<p>图中上半部分是 nc web server 输出的内容，可以看到 <code>Some_Header</code> 没有被 Nginx 传输给后端.</p>
<h3 id="关闭-ignore_invalid_headers">关闭 ignore_invalid_headers</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">server</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">listen</span> <span style="color:#0000cf;font-weight:bold">80</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">server_name</span> <span style="color:#4e9a06">flask.bwangel.me</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">ignore_invalid_headers</span> <span style="color:#000">off</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">location</span> <span style="color:#4e9a06">/</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">proxy_set_header</span> <span style="color:#4e9a06">Nginx-Host</span> <span style="color:#4e9a06">&#34;flask&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">proxy_pass</span> <span style="color:#4e9a06">http://127.0.0.1:8090</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>关闭了 <code>ignore_invalid_headers</code> 之后，无效的 header 也会被 Nginx 传输给后端了</p>
<p><img src="https://github.com/bwangelme/bwangelme.github.io/assets/11701497/95b9f397-c1d7-4782-afd2-9971b45fa402" alt="image"></p>
<p>上图中，可以看到 <code>Some_Header</code> 被 Nginx 传输给了后端</p>
<h3 id="开启-underscores_in_headers">开启 underscores_in_headers</h3>
<pre tabindex="0"><code>server {
    listen 80;

    server_name flask.bwangel.me;
    underscores_in_headers on;
    ignore_invalid_headers on;

    location / {
        proxy_set_header Nginx-Host &#34;flask&#34;;
        proxy_pass http://127.0.0.1:8090;
    }
}
</code></pre><p><img src="https://github.com/bwangelme/bwangelme.github.io/assets/11701497/2bfeda6c-0c4e-4bc9-a1d7-9eb00a15fa3c" alt="image"></p>
<p>可以看到，开启了 <code>underscores_in_headers</code> 之后，带下划线的 header 就是有效的 header 了，就算开着 <code>ignore_invalid_headers</code>, nginx 也会将 <code>Some_Header</code> 传输给后端。</p>
<h2 id="参考链接">参考链接</h2>
<ul>
<li><a href="https://www.nginx.com/resources/wiki/start/topics/tutorials/config_pitfalls/?highlight=underscores#missing-disappearing-http-headers">Missing (disappearing) HTTP Headers</a></li>
<li><a href="http://nginx.org/en/docs/http/ngx_http_core_module.html#ignore_invalid_headers">ignore_invalid_headers</a></li>
<li><a href="http://nginx.org/en/docs/http/ngx_http_core_module.html#underscores_in_headers">underscores_in_headers</a></li>
<li><a href="https://trac.nginx.org/nginx/ticket/2251">#2251 closed defect (worksforme) &ldquo;underscores_in_headers on&rdquo; didn&rsquo;t work</a></li>
<li><a href="https://www.rfc-editor.org/rfc/rfc9110.html#fields.registry">rfc9110.html</a></li>
<li><a href="https://datatracker.ietf.org/doc/html/rfc6648">RFC 6648</a></li>
<li><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers">MDN HTTP 标头（header）</a></li>
</ul>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-aed2ff328139f1dc7b767eb1eb9e5077">6.2 - Nginx proxy_set_header 默认会覆盖上一层的设置</h1>
    
	<hr>
<h2 id="配置代码">配置代码</h2>
<ul>
<li><code>app.py</code></li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#!/usr/bin/env python</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">json</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">from</span> <span style="color:#000">flask</span> <span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">Flask</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">request</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">app</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">Flask</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">__name__</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#5c35cc;font-weight:bold">@app.route</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;/&#39;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">index</span><span style="color:#000;font-weight:bold">():</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">json</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">dumps</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">dict</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">request</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">headers</span><span style="color:#000;font-weight:bold">))</span>
</span></span></code></pre></div><p>Start the flask server:</p>
<pre tabindex="0"><code>FLASK_RUN_PORT=&#34;8060&#34; ~/.pyenv/versions/3.11.1/bin/flask run
</code></pre><ul>
<li><code>/etc/nginx/conf.d/flask.conf</code></li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">upstream</span> <span style="color:#4e9a06">flask</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">server</span> <span style="color:#000">localhost</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">8060</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">server</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">listen</span> <span style="color:#0000cf;font-weight:bold">80</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">server_name</span> <span style="color:#4e9a06">&#34;www.qae.com&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic"># 使用 curl 请求后端，后端能收到的 &#34;HH2&#34; &#34;HH3&#34;, 无法收到 HH0, HH1 header
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">proxy_set_header</span> <span style="color:#4e9a06">HH0</span> <span style="color:#4e9a06">&#34;value&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">proxy_set_header</span> <span style="color:#4e9a06">HH1</span> <span style="color:#4e9a06">&#34;value&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">location</span> <span style="color:#4e9a06">/</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic"># 当子块中有 proxy_set_header 指令时，父块中所有的 proxy_set_header 的值都会被丢弃
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#8f5902;font-style:italic"># include 不会创建新的块，所以 include 的配置文件中的 proxy_set_header 还能会正常使用的
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">proxy_set_header</span> <span style="color:#4e9a06">HH2</span> <span style="color:#4e9a06">&#34;value&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">proxy_set_header</span> <span style="color:#4e9a06">HHCOMMON</span> <span style="color:#4e9a06">&#34;value2&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">include</span> <span style="color:#4e9a06">conf.d/flask-component.conf</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">proxy_pass</span> <span style="color:#4e9a06">http://flask</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><ul>
<li><code>/etc/nginx/conf.d/flask-component.conf</code></li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nginx" data-lang="nginx"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">proxy_set_header</span> <span style="color:#4e9a06">HH3</span> <span style="color:#4e9a06">&#34;value&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 同一个块中多次使用 proxy_set_header 定义 HHCOMMON, 他们的值会用 `,` join 到一起
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">proxy_set_header</span> <span style="color:#4e9a06">HHCOMMON</span> <span style="color:#4e9a06">&#34;value3&#34;</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><h2 id="问题说明">问题说明</h2>
<p>以上是一个 nginx + flask 后端的配置，<code>proxy_set_header</code> 用来向后端传递 header ，我们使用 curl 来请求后端</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>ø&gt; curl -s www.qae.com <span style="color:#000;font-weight:bold">|</span> jq
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;Hh3&#34;</span>: <span style="color:#4e9a06">&#34;value&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;Hhcommon&#34;</span>: <span style="color:#4e9a06">&#34;value3,value2&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;Hh2&#34;</span>: <span style="color:#4e9a06">&#34;value&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;Host&#34;</span>: <span style="color:#4e9a06">&#34;flask&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;Connection&#34;</span>: <span style="color:#4e9a06">&#34;close&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;User-Agent&#34;</span>: <span style="color:#4e9a06">&#34;curl/7.81.0&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;Accept&#34;</span>: <span style="color:#4e9a06">&#34;*/*&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><p>可以看到后端仅收到 HH2 和 HH3, 但是 HH0 和 HH1 却消失了。这是为什么呢？</p>
<p>我翻了翻 nginx 的文档，里面这样写到</p>
<blockquote>
<p>Allows redefining or appending fields to the request header passed to the proxied server.</p>
</blockquote>
<blockquote>
<p>These directives are inherited from the previous configuration level if and <strong>only if there are no</strong> proxy_set_header directives defined on the current level.</p>
</blockquote>
<ul>
<li>如果当前配置块有 <code>proxy_set_header</code> 指令的话，就不会再继承父配置块中的 <code>proxy_set_header</code> 指令了
<ul>
<li><code>HH0</code>, <code>HH1</code> 消失, <code>HH2</code>能看到的原因</li>
</ul>
</li>
<li>include 指令不会创建新的配置块，所以 include 的文件中写的 <code>proxy_set_header</code> 会继续生效
<ul>
<li><code>HH3</code> 能正常看到</li>
</ul>
</li>
<li>如果一个块中用 <code>proxy_set_header</code> 多次设置了同一个 header, 那他们的值会放到一起
<ul>
<li><code>HHCOMMON</code> 的值是 <code>&quot;value3,value2&quot;</code></li>
</ul>
</li>
</ul>
<h2 id="参考链接">参考链接</h2>
<ul>
<li><a href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_set_header">nginx doc</a></li>
</ul>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-b21d7a632564e90b6152ef79c335936f">6.3 - CentOS 下编译安装 Nginx</h1>
    
	<p><strong>摘要</strong>:</p>
<blockquote>
<p>主要讲述了编译安装 Nginx</p>
</blockquote>
<h2 id="安装-pcre">安装 pcre</h2>
<p>pcre: 支持正则表达式，地址重写rewrite</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>tar -xvf tar_ball/pcre-8.38.tar.gz
</span></span><span style="display:flex;"><span><span style="color:#204a87">cd</span> pcre-8.38/
</span></span><span style="display:flex;"><span>./configure --prefix<span style="color:#ce5c00;font-weight:bold">=</span>/usr/local/pcre-8.38
</span></span><span style="display:flex;"><span>make <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> make install
</span></span></code></pre></div><h2 id="编译安装-nginx">编译安装 Nginx</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>yum install openssl openssl-devel
</span></span><span style="display:flex;"><span>groupadd www
</span></span><span style="display:flex;"><span>useradd -g www www -s /sbin/nologin
</span></span><span style="display:flex;"><span>tar -xvf tar_ball/nginx-1.9.12.tar.gz
</span></span><span style="display:flex;"><span><span style="color:#204a87">cd</span> nginx-1.9.12/
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 注意转义符号后面不要跟空格</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">[</span>root@localhost nginx-1.9.12<span style="color:#ce5c00;font-weight:bold">]</span><span style="color:#8f5902;font-style:italic"># ./configure \</span>
</span></span><span style="display:flex;"><span>&gt; --prefix<span style="color:#ce5c00;font-weight:bold">=</span>/usr/local/nginx-1.9.12 <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>&gt; --user<span style="color:#ce5c00;font-weight:bold">=</span>www <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>&gt; --group<span style="color:#ce5c00;font-weight:bold">=</span>www <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>&gt; --with-http_ssl_module <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>&gt; --with-http_flv_module <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>&gt; --with-http_stub_status_module <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>&gt; --with-http_gzip_static_module <span style="color:#4e9a06">\
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06"></span>&gt; --with-pcre<span style="color:#ce5c00;font-weight:bold">=</span>/root/source/pcre-8.38/  <span style="color:#8f5902;font-style:italic"># 注意要指定pcre源码包位置</span>
</span></span><span style="display:flex;"><span>   
</span></span><span style="display:flex;"><span>make
</span></span><span style="display:flex;"><span>make install
</span></span><span style="display:flex;"><span>   
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 启动并测试</span>
</span></span><span style="display:flex;"><span>/usr/local/nginx-1.9.12/sbin/nginx -t  <span style="color:#8f5902;font-style:italic"># 测试配置文件</span>
</span></span><span style="display:flex;"><span>/usr/local/nginx-1.9.12/sbin/nginx  <span style="color:#8f5902;font-style:italic"># 启动Nginx</span>
</span></span><span style="display:flex;"><span>lsof -i:80  <span style="color:#8f5902;font-style:italic"># 查看80端口占用情况</span>
</span></span><span style="display:flex;"><span>elinks -dump http://localhost  <span style="color:#8f5902;font-style:italic"># 用elinks测试本机</span>
</span></span><span style="display:flex;"><span>   
</span></span><span style="display:flex;"><span>vim /etc/profile
</span></span><span style="display:flex;"><span>  pathmunge /usr/local/nginx-1.9.12/sbin/ after  <span style="color:#8f5902;font-style:italic"># 添加Nginx可执行文件的PATH</span>
</span></span></code></pre></div>
</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-61067b04bc7fd549be32943b40ec4eac">7 - Prometheus</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-22b5afb7c5e4cb0f2b2c329578af5ecd">7.1 - Statsd Exporter 如何跳过 prom 的指标检查</h1>
    
	<hr>
<h2 id="statsd-exporter-中构造一些特殊的指标">statsd exporter 中构造一些特殊的指标</h2>
<p>statsd exporter 是 prometheus 官方提供的，将 statsd 指标转换成 prom 指标的 exporter。</p>
<p>statsd exporter 中，可以创建名字相同但 label 不同的同名指标。例如下面的这种序列，</p>
<pre tabindex="0"><code>qae_app_request_latencies_count{app=&#34;mrpink&#34;,role=&#34;web&#34;,task=&#34;default&#34;} 1
qae_app_request_latencies_count{app=&#34;mrpink&#34;,itf=&#34;count_by_item&#34;,role=&#34;service&#34;,service_type=&#34;thrift&#34;,task=&#34;ThriftSvcInstance&#34;} 1
</code></pre><p>我们用个简单例子来说明一下:</p>
<h3 id="准备-statsd-exporter-的配置文件">准备 statsd exporter 的配置文件</h3>
<ul>
<li>exporter_config.yaml</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">defaults</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#8f5902;font-style:italic"># 所有指标使用 glob 匹配的模式</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">match_type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">glob</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">glob_disable_ordering</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">ttl</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">5m</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">#</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">mappings</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">match</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;qae.*.web.*.req_time&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;qae_app_request_latencies&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">match_metric_type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">timer</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">timer_type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">histogram</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">labels</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">app</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;$1&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;web&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">      </span><span style="color:#204a87;font-weight:bold">task</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;$2&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># labels 中的 $1, $2 等是从 match 中捕获的匹配组</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">match</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;qae.*.service.*.*.*.req_time&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;qae_app_request_latencies&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">match_metric_type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">timer</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">timer_type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">histogram</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">labels</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">app</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;$1&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">role</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;service&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">task</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;$2&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">itf</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;$4&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">service_type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;thrift&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#8f5902;font-style:italic"># 其他不符合规范的指标都会被丢弃掉</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span>- <span style="color:#204a87;font-weight:bold">match</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;.&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">match_type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">regex</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">action</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">drop</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span><span style="color:#204a87;font-weight:bold">name</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#4e9a06">&#34;dropped&#34;</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><h3 id="启动-statsd-exporter">启动 statsd exporter</h3>
<p>在 statsd_exporter 的代码目录下执行 go build 命令，并启动它:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ go build -o /tmp/exporter . <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> /tmp/exporter --statsd.mapping-config<span style="color:#ce5c00;font-weight:bold">=</span>exporter_config.yaml --log.level<span style="color:#ce5c00;font-weight:bold">=</span>debug
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">ts</span><span style="color:#ce5c00;font-weight:bold">=</span>2023-05-31T23:42:11.802Z <span style="color:#000">caller</span><span style="color:#ce5c00;font-weight:bold">=</span>main.go:292 <span style="color:#000">level</span><span style="color:#ce5c00;font-weight:bold">=</span>info <span style="color:#000">msg</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;Starting StatsD -&gt; Prometheus Exporter&#34;</span> <span style="color:#000">version</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;(version=, branch=, revision=f40cab3899c8effd25a5daee6f69e30eea796a96-modified)&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">ts</span><span style="color:#ce5c00;font-weight:bold">=</span>2023-05-31T23:42:11.802Z <span style="color:#000">caller</span><span style="color:#ce5c00;font-weight:bold">=</span>main.go:293 <span style="color:#000">level</span><span style="color:#ce5c00;font-weight:bold">=</span>info <span style="color:#000">msg</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;Build context&#34;</span> <span style="color:#000">context</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;(go=go1.18.8, platform=linux/amd64, user=, date=, tags=unknown)&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">ts</span><span style="color:#ce5c00;font-weight:bold">=</span>2023-05-31T23:42:11.803Z <span style="color:#000">caller</span><span style="color:#ce5c00;font-weight:bold">=</span>main.go:342 <span style="color:#000">level</span><span style="color:#ce5c00;font-weight:bold">=</span>info <span style="color:#000">msg</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;Accepting StatsD Traffic&#34;</span> <span style="color:#000">udp</span><span style="color:#ce5c00;font-weight:bold">=</span>:9125 <span style="color:#000">tcp</span><span style="color:#ce5c00;font-weight:bold">=</span>:9125 <span style="color:#000">unixgram</span><span style="color:#ce5c00;font-weight:bold">=</span>
</span></span><span style="display:flex;"><span><span style="color:#000">ts</span><span style="color:#ce5c00;font-weight:bold">=</span>2023-05-31T23:42:11.803Z <span style="color:#000">caller</span><span style="color:#ce5c00;font-weight:bold">=</span>main.go:343 <span style="color:#000">level</span><span style="color:#ce5c00;font-weight:bold">=</span>info <span style="color:#000">msg</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;Accepting Prometheus Requests&#34;</span> <span style="color:#000">addr</span><span style="color:#ce5c00;font-weight:bold">=</span>:9102
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 可以看到，statsd server 运行在 9125 端口，prom server 运行在 9102 端口</span>
</span></span></code></pre></div><h3 id="使用-statsd-client-向-statsd-exporter-发送指标">使用 statsd client 向 statsd exporter 发送指标</h3>
<ul>
<li>发送指标的代码</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;github.com/cactus/go-statsd-client/v5/statsd&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">sendMetrics</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">client</span> <span style="color:#000">statsd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Statter</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">client</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">TimingDuration</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;web.default.req_time&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Millisecond</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#0000cf;font-weight:bold">500</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatalln</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">client</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">TimingDuration</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;service.ThriftSvcInstance.ThriftSvcInstance.count_by_item.req_time&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Millisecond</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#0000cf;font-weight:bold">300</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatalln</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">config</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">statsd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ClientConfig</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Address</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;127.0.0.1:9125&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Prefix</span><span style="color:#000;font-weight:bold">:</span>  <span style="color:#4e9a06">&#34;qae.mrpink&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">client</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">statsd</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewClientWithConfig</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">client</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Close</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">sendMetrics</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">client</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>执行上述代码，就会向 statsd exporter 发送两个 timer 指标</p>
<pre tabindex="0"><code>qae.mrpink.web.default.req_time:500|ms
qae.mrpink.service.ThriftSvcInstance.ThriftSvcInstance.count_by_item.req_time:300|ms
</code></pre><h3 id="检查-statsd-exporter-的-prom-指标">检查 statsd exporter 的 prom 指标</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ curl -s localhost:9102/metrics <span style="color:#000;font-weight:bold">|</span> rg qae_app_request_latencies_count
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>qae_app_request_latencies_count<span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#000">app</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;mrpink&#34;</span>,role<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;web&#34;</span>,task<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;default&#34;</span><span style="color:#ce5c00;font-weight:bold">}</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>qae_app_request_latencies_count<span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#000">app</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;mrpink&#34;</span>,itf<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;count_by_item&#34;</span>,role<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;service&#34;</span>,service_type<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;thrift&#34;</span>,task<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;ThriftSvcInstance&#34;</span><span style="color:#ce5c00;font-weight:bold">}</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span></code></pre></div><p>可以看到，statsd exporter 中存储了两个同名的指标序列 <code>qae_app_request_latencies_count</code>, 但是他们的 label 却不同。</p>
<h2 id="使用-prometheus-client_golang-构造同样的指标就会报错">使用 prometheus client_golang 构造同样的指标就会报错</h2>
<p>如果我们想要使用 prometheus 提供的的官方客户端 <a href="https://github.com/prometheus/client_golang/">client_golang</a>, 发送同样的指标，就会遇到错误</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;github.com/prometheus/client_golang/prometheus&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;github.com/prometheus/client_golang/prometheus/promauto&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;github.com/prometheus/client_golang/prometheus/promhttp&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;net/http&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">AppRequestLatencies</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">promauto</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewHistogramVec</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">prometheus</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HistogramOpts</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Name</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;qae_app_request_latencies&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Help</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;web request count and req time latency&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">},</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">{</span><span style="color:#4e9a06">&#34;app&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;role&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;task&#34;</span><span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ThriftAppRequestLatencies</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">promauto</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewHistogramVec</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">prometheus</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HistogramOpts</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Name</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;qae_app_request_latencies&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Help</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;service request count and req time latency&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">},</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">{</span><span style="color:#4e9a06">&#34;app&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;role&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;task&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;itf&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;service_type&#34;</span><span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">SendMetrics</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">dur1</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Duration</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">300</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Millisecond</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">AppRequestLatencies</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">With</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#4e9a06">&#34;app&#34;</span><span style="color:#000;font-weight:bold">:</span>  <span style="color:#4e9a06">&#34;mrpink&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#4e9a06">&#34;role&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;web&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#4e9a06">&#34;task&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;default&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}).</span><span style="color:#000">Observe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dur1</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Seconds</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">dur2</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Duration</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">500</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Millisecond</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ThriftAppRequestLatencies</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">With</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#4e9a06">&#34;app&#34;</span><span style="color:#000;font-weight:bold">:</span>          <span style="color:#4e9a06">&#34;mrpink&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#4e9a06">&#34;role&#34;</span><span style="color:#000;font-weight:bold">:</span>         <span style="color:#4e9a06">&#34;service&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#4e9a06">&#34;task&#34;</span><span style="color:#000;font-weight:bold">:</span>         <span style="color:#4e9a06">&#34;ThriftSvcInstance&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#4e9a06">&#34;service_type&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;thrift&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#4e9a06">&#34;itf&#34;</span><span style="color:#000;font-weight:bold">:</span>          <span style="color:#4e9a06">&#34;count_by_item&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}).</span><span style="color:#000">Observe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">dur2</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Seconds</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Send metrics done&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">addr</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#4e9a06">&#34;0.0.0.0:8090&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">promMux</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewServeMux</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">promMux</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Handle</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;/metrics&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">promhttp</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Handler</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sleep</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Second</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">SendMetrics</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ListenAndServe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">addr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">promMux</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Start prom server on %v\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">addr</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatalf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Starting the http server %v failed: %v\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">addr</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>执行以上代码，会抛出 panic 异常</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ go run prom_client/main.go
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>panic: a previously registered descriptor with the same fully-qualified name as Desc<span style="color:#ce5c00;font-weight:bold">{</span>fqName: <span style="color:#4e9a06">&#34;qae_app_request_latencies&#34;</span>, help: <span style="color:#4e9a06">&#34;service request count and req time latency&#34;</span>, constLabels: <span style="color:#ce5c00;font-weight:bold">{}</span>, variableLabels: <span style="color:#ce5c00;font-weight:bold">[{</span>app &lt;nil&gt;<span style="color:#ce5c00;font-weight:bold">}</span> <span style="color:#ce5c00;font-weight:bold">{</span>role &lt;nil&gt;<span style="color:#ce5c00;font-weight:bold">}</span> <span style="color:#ce5c00;font-weight:bold">{</span>task &lt;nil&gt;<span style="color:#ce5c00;font-weight:bold">}</span> <span style="color:#ce5c00;font-weight:bold">{</span>itf &lt;nil&gt;<span style="color:#ce5c00;font-weight:bold">}</span> <span style="color:#ce5c00;font-weight:bold">{</span>service_type &lt;nil&gt;<span style="color:#ce5c00;font-weight:bold">}]}</span> has different label names or a different <span style="color:#204a87">help</span> string
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>goroutine <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">[</span>running<span style="color:#ce5c00;font-weight:bold">]</span>:
</span></span><span style="display:flex;"><span>github.com/prometheus/client_golang/prometheus.<span style="color:#ce5c00;font-weight:bold">(</span>*Registry<span style="color:#ce5c00;font-weight:bold">)</span>.MustRegister<span style="color:#ce5c00;font-weight:bold">(</span>0x0?, <span style="color:#ce5c00;font-weight:bold">{</span>0xc000118010?, 0x1, 0x0?<span style="color:#ce5c00;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>        /home/xuyundong/.gvm/pkgsets/go1.18.8/global/pkg/mod/github.com/prometheus/client_golang@v1.15.1/prometheus/registry.go:405 +0x7f
</span></span><span style="display:flex;"><span>github.com/prometheus/client_golang/prometheus/promauto.Factory.NewHistogramVec<span style="color:#ce5c00;font-weight:bold">({{</span>0x922410?, 0xc0000a2960?<span style="color:#ce5c00;font-weight:bold">}}</span>, <span style="color:#ce5c00;font-weight:bold">{{</span>0x0, 0x0<span style="color:#ce5c00;font-weight:bold">}</span>, <span style="color:#ce5c00;font-weight:bold">{</span>0x0, 0x0<span style="color:#ce5c00;font-weight:bold">}</span>, <span style="color:#ce5c00;font-weight:bold">{</span>0x87e012, 0x19<span style="color:#ce5c00;font-weight:bold">}</span>, <span style="color:#ce5c00;font-weight:bold">{</span>0x88794e, 0x2a<span style="color:#ce5c00;font-weight:bold">}</span>, ...<span style="color:#ce5c00;font-weight:bold">}</span>, ...<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        /home/xuyundong/.gvm/pkgsets/go1.18.8/global/pkg/mod/github.com/prometheus/client_golang@v1.15.1/prometheus/promauto/auto.go:362 +0x1cc
</span></span><span style="display:flex;"><span>github.com/prometheus/client_golang/prometheus/promauto.NewHistogramVec<span style="color:#ce5c00;font-weight:bold">(</span>...<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        /home/xuyundong/.gvm/pkgsets/go1.18.8/global/pkg/mod/github.com/prometheus/client_golang@v1.15.1/prometheus/promauto/auto.go:235
</span></span><span style="display:flex;"><span>main.init<span style="color:#ce5c00;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>        /home/xuyundong/Github/Golang/statsd_client/prom_client/main.go:17 +0x269
</span></span><span style="display:flex;"><span><span style="color:#204a87">exit</span> status <span style="color:#0000cf;font-weight:bold">2</span>
</span></span></code></pre></div><h2 id="prometheus-client_golang-的检查逻辑">Prometheus client_golang 的检查逻辑</h2>
<p>于是我有些好奇，statsd exporter 是如何做到，可以发送同名不同 label 的指标的。
简单的阅读了 client_golang 和 statsd_exporter 的指标之后，我找到了答案。</p>
<p>我阅读的代码的版本是</p>
<ul>
<li><a href="https://github.com/prometheus/client_golang/tree/release-1.15">client_golang - release-1.15</a></li>
<li><a href="https://github.com/prometheus/statsd_exporter/tree/v0.23.1">statsd_exporter - 0.23.1</a></li>
</ul>
<p>client_golang 中定义了两个接口</p>
<ul>
<li><a href="https://github.com/prometheus/client_golang/blob/release-1.15/prometheus/collector.go#L27">prometheus.Collector</a></li>
<li><a href="https://github.com/prometheus/client_golang/blob/release-1.15/prometheus/registry.go#L96">prometheus.Registerer</a></li>
</ul>
<p>client_golang 中每种指标都实现了 <code>prometheus.Collector</code>, 所有的指标会注册到一个实现了 <code>prometheus.Registerer</code> 接口的实例中，再由此实例收集并输出指标。</p>
<p>我们在代码中定义指标的代码是:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">opts</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">prometheus</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">HistogramOpts</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">Name</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;qae_app_request_latencies&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">Help</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;web request count and req time latency&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000">labels</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">{</span><span style="color:#4e9a06">&#34;app&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;role&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;task&#34;</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000">AppRequestLatencies</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">promauto</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewHistogramVec</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">opts</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">labels</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>client_golang 实际执行的代码如下, 它会注册一个 Histogram 指标，并将其注册到 <code>DefaultRegisterer</code> 中。<code>DefaultRegisterer</code> 就是一个实现了 <code>prometheus.Registerer</code> 接口的实例。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">h</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">prometheus</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewHistogramVec</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">opts</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">labelNames</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">prometheus</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">DefaultRegisterer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MustRegister</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">h</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// MustRegister 底层调用了 Register 方法，在 Register 返回 err 时会 panic
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// prometheus.DefaultRegisterer.Register(h)
</span></span></span></code></pre></div><p><code>prometheus.Collector</code> 接口有一个 <code>Describe</code> 方法，它用于获取指标的信息。具体做法是传入一个 channel 参数，指标将 Desc 信息写入到 channel 中。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Collector</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a40000">#</span> <span style="color:#000">Desc</span> <span style="color:#a40000">包含指标名</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">label</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">help</span> <span style="color:#a40000">等信息</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">Describe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">chan</span><span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Desc</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">...</span><span style="color:#000;font-weight:bold">.</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>接着我们来看一下 <code>DefaultRegisterer</code> 的 <a href="https://github.com/prometheus/client_golang/blob/release-1.15/prometheus/registry.go#L270">Register</a> 函数的实现，</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 以下代码中我省略了一些无关的内容
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">r</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Registry</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Register</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#000">Collector</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// c 是 Collector 对象
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">descChan</span>           <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Desc</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">capDescChan</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Describe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">descChan</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">descChan</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">mtx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Lock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// 为了防止 goroutine 泄漏，descChan 必须被消费完
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">descChan</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">mtx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Unlock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">...</span><span style="color:#000;font-weight:bold">.</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">desc</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">descChan</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// desc.id 是根据指标名和固定 label 名算出来的 hash,
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// 如果注册的两个指标 name 和固定 label 名完全相同，则返回错误 duplicateDescErr
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">exists</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">descIDs</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">desc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">id</span><span style="color:#000;font-weight:bold">];</span> <span style="color:#000">exists</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">duplicateDescErr</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;descriptor %s already exists with the same fully-qualified name and const label values&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">desc</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// fqName 是指标名
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// dimHash 是 根据指标 label 名 + help 算出来的 hash
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// 如果注册了两个同名的指标，但是它们的 label 或者 help 信息不同的话，则会返回错误
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">dimHash</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">exists</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">r</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">dimHashesByName</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">desc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">fqName</span><span style="color:#000;font-weight:bold">];</span> <span style="color:#000">exists</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">dimHash</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">desc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">dimHash</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Errorf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;a previously registered descriptor with the same fully-qualified name as %s has different label names or a different help string&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">desc</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#ce5c00;font-weight:bold">...</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>从以上代码可以看出，<code>Register</code> 中会通过 <code>Describe</code> 方法拿到指标的信息，并进行若干检查。如果两个同名指标的 label 名不同，则会返回错误 <code>a previously registered descriptor with the same fully-qualified name as Desc... has different label names or a different help string</code>。</p>
<h2 id="statsd-exporter-中跳过检查的方法">statsd exporter 中跳过检查的方法</h2>
<p>那么 statsd exporter 是如何跳过上述检查的呢，很简单，让 <code>Describe</code> 返回空就好。statsd exporter 中的每个指标都用 <a href="https://github.com/prometheus/statsd_exporter/blob/v0.23.1/pkg/registry/registry.go#L33-L42">uncheckedCollector</a> 包裹了一下。</p>
<p><code>uncheckedCollector</code> 的定义如下</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">uncheckedCollector</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">c</span> <span style="color:#000">prometheus</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Collector</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">u</span> <span style="color:#000">uncheckedCollector</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Describe</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">_</span> <span style="color:#204a87;font-weight:bold">chan</span><span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">prometheus</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Desc</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">u</span> <span style="color:#000">uncheckedCollector</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Collect</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#204a87;font-weight:bold">chan</span><span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">prometheus</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Metric</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">u</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">c</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Collect</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>它的 <code>Describe</code> 方法什么也不返回，那么 <code>Register</code> 中的检查也会被跳过了。</p>
<p>这样最终实现了注册同名不同 label 指标的目的。</p>
</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-e5a0a7efb242ec26125e2066bad47362">8 - 编码</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-573e3337b8ecb996b3dee636fc080527">8.1 - ZigZag 变长整数编码</h1>
    
	<blockquote>
<p>变长整数编码的实现</p>
</blockquote>
<hr>
<h2 id="介绍">介绍</h2>
<p>Variants + Zigzag 是在 protobuf, thrift, kafka 中使用的一种数字编码方式，它将整数序列化成字节，整数的绝对值越小，其占用的字节数越少。</p>
<h2 id="variants-变长整数编码">Variants 变长整数编码</h2>
<p>Variants 是使用一个或多个字节来序列化整数的一种方法，数值对应的无符号数越小，其占用的字节数越少。</p>
<p>在 Variants 编码中，</p>
<ol>
<li>每个字节的最高位保留，成为 msb 位(most significant bit)，它用于表示其后的字节是否和当前字节一起来表示一个整数。</li>
<li>Variants 使用小端字节序的布局方式，整数的低位放在字节流的高位。</li>
</ol>
<p>例如整数 300，它的二进制形式是</p>
<pre tabindex="0"><code>[0000 0001] [0010 1100]
</code></pre><p>其中有效的数据只有前 9 位，即</p>
<pre tabindex="0"><code>[1] [0010 1100]
</code></pre><p>加上 msb 位，因为字节序后续还需要反转字节流，我们将 msb 位先记成 X</p>
<ul>
<li><strong>注意:</strong> 第一个字节只有前两位有效的，其他数据位我们都补0</li>
</ul>
<pre tabindex="0"><code>[X000 0010] [X010 1100]
</code></pre><p>将其按照小端字节序排列，得到</p>
<pre tabindex="0"><code>[X010 1100] [X000 0010]
</code></pre><p>再根据当前字节是否是最后一个，填充上 msb 位，得到 300 的 Variants 编码是</p>
<pre tabindex="0"><code>[1010 1100] [0000 0010]
</code></pre><h2 id="variants-编码负数遇到的问题">Variants 编码负数遇到的问题</h2>
<p>使用 Variants 对负数进行编码的时候，由于负数使用补码进行编码，越小的负数其对应的无符号数越大，Variants 编码后的字节数越多。</p>
<p>例如对于一个 64 位整数，-1 的补码用八个字节表示 <code>[1111 1111] [1111 1111] [1111 1111] [1111 1111] [1111 1111] [1111 1111] [1111 1111] [1111 1111]</code>，它经过 Variants 编码后的长度是10个字节。</p>
<p>由于小负数是很常见的数字，这样就容易造成浪费。</p>
<p>为了让编码更加高效，Variants 引入了 ZigZag 的编码方式。</p>
<h2 id="zigzag-编码">ZigZag 编码</h2>
<p>ZigZag 编码以一种锯齿形(zig-zags，或者也可以叫之字型)的方式来回穿梭正负整数，将带符号的整数映射为无符号证书，这样可以使绝对值较小的负数仍然享有较小的 Variants 编码值。</p>
<p>下表是部分数字的 ZigZag 编码结果，看了这个表格后，你应该明白它的名字为什么要叫 ZigZag 了吧 :)</p>
<table>
<thead>
<tr>
<th>原值</th>
<th>编码后的值</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>0</td>
</tr>
<tr>
<td>-1</td>
<td>1</td>
</tr>
<tr>
<td>1</td>
<td>2</td>
</tr>
<tr>
<td>-2</td>
<td>3</td>
</tr>
<tr>
<td>2</td>
<td>4</td>
</tr>
<tr>
<td>-3</td>
<td>5</td>
</tr>
<tr>
<td>3</td>
<td>6</td>
</tr>
<tr>
<td>-4</td>
<td>7</td>
</tr>
<tr>
<td>4</td>
<td>8</td>
</tr>
<tr>
<td>-5</td>
<td>9</td>
</tr>
<tr>
<td>5</td>
<td>10</td>
</tr>
<tr>
<td>-6</td>
<td>11</td>
</tr>
<tr>
<td>6</td>
<td>12</td>
</tr>
<tr>
<td>-7</td>
<td>13</td>
</tr>
<tr>
<td>7</td>
<td>14</td>
</tr>
<tr>
<td>-8</td>
<td>15</td>
</tr>
<tr>
<td>8</td>
<td>16</td>
</tr>
<tr>
<td>-9</td>
<td>17</td>
</tr>
<tr>
<td>9</td>
<td>18</td>
</tr>
<tr>
<td>-10</td>
<td>19</td>
</tr>
<tr>
<td>10</td>
<td>20</td>
</tr>
<tr>
<td>2147483647</td>
<td>4294967294</td>
</tr>
<tr>
<td>-2147483648</td>
<td>4294967295</td>
</tr>
</tbody>
</table>
<h2 id="zigzag-的实现方式">ZigZag 的实现方式</h2>
<p>编码方式: <code>(n &lt;&lt; 1) ^ (n &gt;&gt; (size(n) - 1))</code></p>
<p>解码方式: <code>(value &gt;&gt;&gt; 1) ^ -(value &amp; 1)</code></p>
<ul>
<li><code>size(n)</code> 表示的是整数 n 的位数</li>
<li><code>value &gt;&gt;&gt; 1</code> 表示将数字 value 无符号右移一位，最高位补0</li>
</ul>
<h2 id="实现代码">实现代码</h2>
<p>下面是对 32 位整数进行编码的代码</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">org.example.zigzag</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">java.nio.ByteBuffer</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">java.nio.charset.StandardCharsets</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">App</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">private</span> <span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">final</span> <span style="color:#204a87;font-weight:bold">byte</span><span style="color:#ce5c00;font-weight:bold">[]</span> <span style="color:#000">HEX_ARRAY</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;0123456789ABCDEF&#34;</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">getBytes</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">StandardCharsets</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">UTF_8</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">main</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">String</span><span style="color:#ce5c00;font-weight:bold">[]</span> <span style="color:#000">args</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">ByteBuffer</span> <span style="color:#000">buffer</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ByteBuffer</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">allocate</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">10</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">App</span> <span style="color:#000">a</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">App</span><span style="color:#ce5c00;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">a</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">writeVariant</span><span style="color:#ce5c00;font-weight:bold">(-</span><span style="color:#0000cf;font-weight:bold">23</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">buffer</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">System</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">out</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">println</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;variant bytes is `&#34;</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">bytesToHex</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">buffer</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">array</span><span style="color:#ce5c00;font-weight:bold">())</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#4e9a06">&#34;`&#34;</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">b</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">a</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">readVariant</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">buffer</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">System</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">out</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">println</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;decode value is &#34;</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">b</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">readVariant</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">ByteBuffer</span> <span style="color:#000">buffer</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">throws</span> <span style="color:#000">RuntimeException</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">b</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// 此处重置 bytebuffer 的 pos，否则不会从第0个开始读起
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">buffer</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">rewind</span><span style="color:#ce5c00;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// 从字节流中取出一个字节，如果第8位是0的话，表示读取整数结束
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">while</span> <span style="color:#ce5c00;font-weight:bold">(((</span><span style="color:#000">b</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">buffer</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">get</span><span style="color:#ce5c00;font-weight:bold">())</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#0000cf;font-weight:bold">0x80</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#8f5902;font-style:italic">// 取出低7位，并左移 7 位放到 value 中
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>            <span style="color:#000">b</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">b</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#0000cf;font-weight:bold">0x7f</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">System</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">out</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">println</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">b</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">|=</span> <span style="color:#000">b</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#0000cf;font-weight:bold">7</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#8f5902;font-style:italic">// 32 位整数最大编码结果是5个字节，在循环中最多只能读4次
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>            <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#0000cf;font-weight:bold">28</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#204a87;font-weight:bold">throw</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">RuntimeException</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;illegal bytes&#34;</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// 最后一次在循环外读取，且由于最后一位最高位是0,也不需要进行去除最高位的操作
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">|=</span> <span style="color:#000">b</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;&gt;</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">^</span> <span style="color:#ce5c00;font-weight:bold">-(</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">writeVariant</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">value</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">ByteBuffer</span> <span style="color:#000">buffer</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// 将整数 value 进行 zigzag 编码, int 是 32 位，所以这里直接写死了 31
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">v</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">^</span> <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#0000cf;font-weight:bold">31</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// 判断 v 的低7位是否是0
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#204a87;font-weight:bold">while</span> <span style="color:#ce5c00;font-weight:bold">((</span><span style="color:#000">v</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#0000cf;font-weight:bold">0xffffff80</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000">L</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#8f5902;font-style:italic">// 取出 v 的低7位，并在最高位上加上1
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>            <span style="color:#204a87;font-weight:bold">byte</span> <span style="color:#000">b</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">byte</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">((</span><span style="color:#000">v</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#0000cf;font-weight:bold">0x7f</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">|</span> <span style="color:#0000cf;font-weight:bold">0x80</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#8f5902;font-style:italic">// 放到 buffer 中
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>            <span style="color:#8f5902;font-style:italic">// 因为是先放整数的低字节位，所以这里实现了小端字节序
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>            <span style="color:#000">buffer</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">put</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">b</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>            <span style="color:#8f5902;font-style:italic">// 将 v 无符号右移 7 位，最高位补 0
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>            <span style="color:#000">v</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;&gt;=</span> <span style="color:#0000cf;font-weight:bold">7</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#8f5902;font-style:italic">// 最后取出的 7 位最高位一定是0,且它位于 variant 编码的最后一个字节，需要设置成0
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>        <span style="color:#000">buffer</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">put</span><span style="color:#ce5c00;font-weight:bold">((</span><span style="color:#204a87;font-weight:bold">byte</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#000">v</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">static</span> <span style="color:#000">String</span> <span style="color:#000">bytesToHex</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">byte</span><span style="color:#ce5c00;font-weight:bold">[]</span> <span style="color:#000">bytes</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">byte</span><span style="color:#ce5c00;font-weight:bold">[]</span> <span style="color:#000">hexChars</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#204a87;font-weight:bold">byte</span><span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#000">bytes</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">length</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#ce5c00;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#ce5c00;font-weight:bold">;</span> <span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">bytes</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">length</span><span style="color:#ce5c00;font-weight:bold">;</span> <span style="color:#000">j</span><span style="color:#ce5c00;font-weight:bold">++)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">v</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">bytes</span><span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#000">j</span><span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#0000cf;font-weight:bold">0xFF</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">hexChars</span><span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">HEX_ARRAY</span><span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#000">v</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;&gt;</span> <span style="color:#0000cf;font-weight:bold">4</span><span style="color:#ce5c00;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">hexChars</span><span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">3</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">HEX_ARRAY</span><span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#000">v</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#0000cf;font-weight:bold">0x0F</span><span style="color:#ce5c00;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">hexChars</span><span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">3</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#39; &#39;</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">String</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">hexChars</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">StandardCharsets</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">UTF_8</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><ul>
<li>Output</li>
</ul>
<pre tabindex="0"><code>variant bytes is `2D 00 00 00 00 00 00 00 00 00 `
decode value is -23
</code></pre>
</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-0d3382c151725c975fa7e12e83c234f9">9 - WireShark</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-228f2acd9c0ff088f1229559fcdd6503">9.1 - 利用 VirtualBox 和 Ubuntu 22 重现抓包实验</h1>
    
	<h2 id="实验介绍">实验介绍</h2>
<p>在 <a href="https://book.douban.com/subject/26268767/">《Wireshark网络分析就这么简单》</a> 第一章，讲述了一道面试题。</p>
<p>HostA 和 HostB 在同一个局域网中，它们的 IP 配置如下，请问这两台机器能否 ping 通?</p>
<pre tabindex="0"><code>HostA: 
    IP: 192.168.26.129/24
    Gateway: 192.168.26.2
HostB: 
    IP: 192.168.26.3/27
    Gateway: 192.168.26.2
</code></pre><p>答案是能够 ping 通，HostA 和 HostB 连同网关最终会形成一个奇怪的网络</p>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2023-08-23-103426.png" alt=""></p>
<p>具体通信过程如下:</p>
<ul>
<li>HostA(<code>192.168.26.129</code>) 发送 ping 请求给 HostB(<code>192.168.26.3</code>)
<ul>
<li>HostA 将 HostB 的 IP 和自己的掩码计算，发现 <code>192.168.26.3</code> 和自己是处于同一子网</li>
<li>HostA 通过 ARP 协议广播寻找 <code>192.168.26.3</code> 的 MAC 地址，由于 <code>192.168.26.3</code> 和它在同一局域网中，<code>192.168.26.3</code> 会应答自己的 MAC 地址</li>
<li>HostA 将 ping 请求直接发送给 <code>192.168.26.3</code>, 目的 MAC 地址使用的就是 <code>192.168.26.3</code> 的地址</li>
</ul>
</li>
<li>HostB(<code>192.168.26.3</code>) 收到 ping 请求，给 HostA 发送 ping 响应
<ul>
<li>HostB 将 HostA 的 IP 和自己的掩码计算，发现 <code>192.168.26.129</code> 和自己不是同一子网
<ul>
<li>192.168.26.3 &amp; 255.255.255.224 == 192.168.26.0</li>
<li>192.168.26.129 &amp; 255.255.255.224 == 192.168.26.128</li>
</ul>
</li>
<li>HostB 将 ping 响应发送给网关，由网关进行路由发送
<ul>
<li>HostB 通过 APR 协议广播寻找网关 <code>192.168.26.2</code> 的 MAC 地址，网关 <code>192.168.26.2</code> 告诉 HostB 自己的 MAC</li>
<li>HostB 发送 ping 响应包，目的 IP 是 <code>192.168.26.129</code>, 目的 MAC 是网关的 MAC 地址</li>
</ul>
</li>
<li>网关将 ping 响应发送给了 HostA</li>
</ul>
</li>
</ul>
<h2 id="开始实验">开始实验</h2>
<p>读完以后，感觉这个测试挺好玩，就尝试在本地复现了一下。</p>
<p>我的环境如下，3台安装了 Ubuntu 22.04 Vitualbox 虚拟机, 它们分别充当 HostA, HostB 和 网关</p>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2023-08-23-224057.png" alt=""></p>
<h3 id="配置-vagrant">配置 Vagrant</h3>
<p>我的 VirtualBox 是通过 Vagrant 启动的</p>
<ul>
<li>首先我们需要在 Vagrant 官网上下载 Ubuntu 22.04 的 Box</li>
</ul>
<p><a href="https://app.vagrantup.com/ubuntu/boxes/jammy64">ubuntu/jammy64 Vagrant box 下载地址</a></p>
<p>下载完成之后通过如下命令添加 Vagrant Box</p>
<pre tabindex="0"><code>vagrant box add ~/Downloads/jammy-server-cloudimg-amd64-vagrant.box --name ubuntu/jammy
</code></pre><p>添加完成后使用 <code>vagrant box list</code> 可以看到我们添加的 box 名字了</p>
<ul>
<li>接着我们再来安装 <code>vagrant-disksize</code> 插件</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 建议在执行命令前挂上 http 代理</span>
</span></span><span style="display:flex;"><span>vagrant plugin install vagrant-disksize
</span></span></code></pre></div><h3 id="启动并配置-vbox">启动并配置 VBox</h3>
<p>这是我的 Vagrantfile, 它启动了三个 virtualbox 虚拟机，分别命名为 vbox1, vbox2, vbox3。完整代码见 <a href="https://github.com/bwangelme/DockerVbox.git">github/bwangelme/DockerVbox.git</a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-ruby" data-lang="ruby"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># -*- mode: ruby -*-</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># vi: set ft=ruby :</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># Verify whether required plugins are installed.</span>
</span></span><span style="display:flex;"><span><span style="color:#000">required_plugins</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">[</span> <span style="color:#4e9a06">&#34;vagrant-disksize&#34;</span> <span style="color:#ce5c00;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#000">required_plugins</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">each</span> <span style="color:#204a87;font-weight:bold">do</span> <span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#000">plugin</span><span style="color:#ce5c00;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87;font-weight:bold">not</span> <span style="color:#000">Vagrant</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">has_plugin?</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">plugin</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">raise</span> <span style="color:#4e9a06">&#34;The vagrant plugin </span><span style="color:#4e9a06">#{</span><span style="color:#000">plugin</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06"> is required. Please run `vagrant plugin install </span><span style="color:#4e9a06">#{</span><span style="color:#000">plugin</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">`&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">end</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">Vagrant</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">configure</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;2&#34;</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">do</span> <span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#000">config</span><span style="color:#ce5c00;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">config</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">vm</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">box_check_update</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">$num_instances</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">3</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">..</span><span style="color:#000">$num_instances</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">each</span> <span style="color:#204a87;font-weight:bold">do</span> <span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">config</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">vm</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">define</span> <span style="color:#4e9a06">&#34;vbox</span><span style="color:#4e9a06">#{</span><span style="color:#000">i</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">&#34;</span> <span style="color:#204a87;font-weight:bold">do</span> <span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#000">node</span><span style="color:#ce5c00;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">node</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">vm</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">box</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;ubuntu/jammy&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">node</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">vm</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">hostname</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;vbox</span><span style="color:#4e9a06">#{</span><span style="color:#000">i</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">node</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">vm</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">provider</span> <span style="color:#4e9a06">&#34;virtualbox&#34;</span> <span style="color:#204a87;font-weight:bold">do</span> <span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#000">vb</span><span style="color:#ce5c00;font-weight:bold">|</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">vb</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">memory</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;1024&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">vb</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">cpus</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">vb</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">name</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;vbox</span><span style="color:#4e9a06">#{</span><span style="color:#000">i</span><span style="color:#4e9a06">}</span><span style="color:#4e9a06">&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">end</span>
</span></span><span style="display:flex;"><span>      <span style="color:#8f5902;font-style:italic"># 单独执行 vagrant provision 也会执行一遍 install.sh 脚本</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">node</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">vm</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">provision</span> <span style="color:#4e9a06">&#34;shell&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">path</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;install.sh&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">end</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">end</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">end</span>
</span></span></code></pre></div><p>将 <a href="https://github.com/bwangelme/DockerVbox.git">github/bwangelme/DockerVbox.git</a> 克隆到本地，进入目录中执行</p>
<pre tabindex="0"><code>vagrant up
</code></pre><p>就可以创建并启动三个 Ubuntu 22.04 的 VirtualBox 虚机了</p>
<p>启动完成后，我们执行</p>
<pre tabindex="0"><code>vagrant halt
</code></pre><p>将虚拟机先停止，接着我们来手动设置网络。</p>
<h3 id="设置-vbox-网络">设置 VBox 网络</h3>
<ul>
<li>第一步，打开 VirtualBox 的 <strong>管理 -&gt; 全局设定</strong> ，打开网络 Tab, 添加一个 Nat 网络，设置名字为 <code>NatNetwork</code>，设置网段为 <code>192.168.26.0/24</code></li>
</ul>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2023-08-23-225440.png" alt=""></p>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2023-08-23-225556.png" alt=""></p>
<ul>
<li>第二步，分别在每个虚拟机上执行，在 <strong>虚拟机设置 -&gt; 网络</strong> 中添加网卡，<strong>连接方式</strong> 选 <code>Nat网络</code>, <strong>界面名称</strong> 选择我们刚刚创建的 <code>NatNetwork</code></li>
</ul>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2023-08-23-225755.png" alt=""></p>
<ul>
<li>第三步，手动启动三个虚拟机。</li>
</ul>
<p><strong>注意:</strong> 不能使用 <code>vagrant up</code> 启动, 否则我们创建的网卡就被关闭了</p>
<h3 id="手动设置机器的-ip">手动设置机器的 IP</h3>
<p>虚拟机启动后，使用如下命令可以登陆到对应的虚机上</p>
<pre tabindex="0"><code>vagrant ssh vbox1
</code></pre><p>接着我们修改 <code>/etc/netplan/50-cloud-init.yaml</code> 文件，加入我们 Nat 网卡 <code>enp0s8</code> 的配置</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-diff" data-lang="diff"><span style="display:flex;"><span> vagrant@vbox1:~$ cat /etc/netplan/50-cloud-init.yaml
</span></span><span style="display:flex;"><span> # This file is generated from information provided by the datasource.  Changes
</span></span><span style="display:flex;"><span> # to it will not persist across an instance reboot.  To disable cloud-init&#39;s
</span></span><span style="display:flex;"><span> # network configuration capabilities, write a file
</span></span><span style="display:flex;"><span> # /etc/cloud/cloud.cfg.d/99-disable-network-config.cfg with the following:
</span></span><span style="display:flex;"><span> # network: {config: disabled}
</span></span><span style="display:flex;"><span> network:
</span></span><span style="display:flex;"><span>     ethernets:
</span></span><span style="display:flex;"><span>         enp0s3:
</span></span><span style="display:flex;"><span>             dhcp4: true
</span></span><span style="display:flex;"><span>             match:
</span></span><span style="display:flex;"><span>                 macaddress: 02:20:c0:fe:1f:a9
</span></span><span style="display:flex;"><span>             set-name: enp0s3
</span></span><span style="display:flex;"><span><span style="color:#00a000">+        enp0s8:
</span></span></span><span style="display:flex;"><span><span style="color:#00a000">+            dhcp4: no
</span></span></span><span style="display:flex;"><span><span style="color:#00a000">+            addresses:
</span></span></span><span style="display:flex;"><span><span style="color:#00a000">+                - 192.168.26.129/24
</span></span></span><span style="display:flex;"><span><span style="color:#00a000">+            gateway4: 192.168.26.2
</span></span></span><span style="display:flex;"><span><span style="color:#00a000">+            nameservers:
</span></span></span><span style="display:flex;"><span><span style="color:#00a000">+                addresses: [223.5.5.5]
</span></span></span><span style="display:flex;"><span><span style="color:#00a000"></span>     version: 2
</span></span></code></pre></div><p>三台主机的配置如下</p>
<table>
<thead>
<tr>
<th>Hostname</th>
<th>网卡名称</th>
<th>IP/掩码</th>
<th>MAC 地址</th>
<th>网关</th>
</tr>
</thead>
<tbody>
<tr>
<td>vbox1</td>
<td>enp0s8</td>
<td>192.168.26.129/24</td>
<td>08:00:27:4c:f0:52</td>
<td>192.168.26.2</td>
</tr>
<tr>
<td>vbox2</td>
<td>enp0s8</td>
<td>192.168.26.3/27</td>
<td>08:00:27:69:22:ae</td>
<td>192.168.26.2</td>
</tr>
<tr>
<td>vbox3</td>
<td>enp0s8</td>
<td>192.168.26.2/24</td>
<td>08:00:27:d5:b5:13</td>
<td>192.168.26.1</td>
</tr>
</tbody>
</table>
<p>修改完配置文件后，使用以下命令将配置生效</p>
<pre tabindex="0"><code>sudo netplan apply
</code></pre><p>至此，所有的网络环境都配置成功了，我们可以开始抓包了。</p>
<h2 id="问题1-192168263-地址存在两个">问题1: 192.168.26.3 地址存在两个</h2>
<p>我在 vbox1 上执行以下抓包命令</p>
<pre tabindex="0"><code>sudo tcpdump -i enp0s8 --print -en -w vbox1_ping src host 192.168.26.3 or dst host 192.168.26.3
</code></pre><p>在另一个终端中执行 ping 发送 ICMP 包</p>
<pre tabindex="0"><code>ping -c 3 192.168.26.3
</code></pre><p>此时，很奇怪的问题出现了</p>
<p><code>192.168.26.3</code> 能够 ping 通，但请求不是从 vbox2 发回来的，而是从一个 MAC 地址为 <code>08:00:27:ae:84:b6</code> 的网卡发回来的。</p>
<pre tabindex="0"><code>01:26:47.254731 08:00:27:4c:f0:52 &gt; 08:00:27:ae:84:b6, ethertype IPv4 (0x0800), length 98: 192.168.26.129 &gt; 192.168.26.3: ICMP echo request, id 9, seq 1, length 64
01:26:47.254885 08:00:27:ae:84:b6 &gt; 08:00:27:4c:f0:52, ethertype IPv4 (0x0800), length 98: 192.168.26.3 &gt; 192.168.26.129: ICMP echo reply, id 9, seq 1, length 64
01:26:48.275239 08:00:27:4c:f0:52 &gt; 08:00:27:ae:84:b6, ethertype IPv4 (0x0800), length 98: 192.168.26.129 &gt; 192.168.26.3: ICMP echo request, id 9, seq 2, length 64
01:26:48.275415 08:00:27:ae:84:b6 &gt; 08:00:27:4c:f0:52, ethertype IPv4 (0x0800), length 98: 192.168.26.3 &gt; 192.168.26.129: ICMP echo reply, id 9, seq 2, length 64
01:26:49.298910 08:00:27:4c:f0:52 &gt; 08:00:27:ae:84:b6, ethertype IPv4 (0x0800), length 98: 192.168.26.129 &gt; 192.168.26.3: ICMP echo request, id 9, seq 3, length 64
01:26:49.299089 08:00:27:ae:84:b6 &gt; 08:00:27:4c:f0:52, ethertype IPv4 (0x0800), length 98: 192.168.26.3 &gt; 192.168.26.129: ICMP echo reply, id 9, seq 3, length 64
01:26:52.370038 08:00:27:4c:f0:52 &gt; 08:00:27:ae:84:b6, ethertype ARP (0x0806), length 42: Request who-has 192.168.26.3 tell 192.168.26.129, length 28
01:26:52.370156 08:00:27:ae:84:b6 &gt; 08:00:27:4c:f0:52, ethertype ARP (0x0806), length 60: Reply 192.168.26.3 is-at 08:00:27:ae:84:b6, length 46

# 这个抓包更奇怪，vbox1 询问 192.168.26.3 的 MAC 地址，有两个地址发来了响应
vagrant@vbox1:~$ sudo tcpdump -i enp0s8 --print src host 192.168.26.3 or dst host 192.168.26.3 -w vbox1_ping
tcpdump: listening on enp0s8, link-type EN10MB (Ethernet), snapshot length 262144 bytes
16:50:54.672007 ARP, Request who-has 192.168.26.3 tell vbox1, length 28
16:50:54.672243 ARP, Reply 192.168.26.3 is-at 08:00:27:ae:84:b6 (oui Unknown), length 46
16:50:54.672243 ARP, Reply 192.168.26.3 is-at 08:00:27:69:22:ae (oui Unknown), length 46
</code></pre><p>这个困扰了我好久，我反复检查三台 vbox 的所有网卡和我宿主机所有网卡的 MAC 地址，没有一个是符合 <code>08:00:27:ae:84:b6</code> 的。</p>
<p>后来我突发奇想，这是不是 virtualbox Nat Network 默认创建的地址，于是我将 vbox2 和 vbox3 的地址全部换掉，发现</p>
<ul>
<li>192.168.26.1</li>
<li>192.168.26.2</li>
<li>192.168.26.3</li>
</ul>
<p>这三个地址依然是能够 ping 通的。</p>
<p>我用关键字 <code>vbox nat network gateway</code> 在 Google 中搜索，找到了 vbox 的一篇文档: <a href="https://www.virtualbox.org/manual/ch06.html#network_nat_service">6.4. Network Address Translation Service</a></p>
<p>文档中创建了一个 <code>192.168.15.0/24</code> 的 Nat 网络， 并说静态设置的网关默认被赋予地址 <code>192.168.15.1</code></p>
<blockquote>
<p>Here, natnet1 is the name of the internal network to be used and 192.168.15.0/24 is the network address and mask of the NAT service interface. By default in this static configuration the gateway will be assigned the address 192.168.15.1, the address following the interface address, though this is subject to change. To attach a DHCP server to the internal network, modify the example command as follows:</p>
</blockquote>
<p>这下我就明白了，<code>192.168.26.1</code>, <code>192.168.26.2</code>, <code>192.168.26.3</code> 是 Vbox Nat 网络的保留地址，<code>192.168.26.1</code> 是默认网关，<code>192.168.26.3</code> 是 DNS Server 的地址(因为它的 53 端口能用 UDP 连上), <code>192.168.26.2</code> 是干嘛的还没搞明白</p>
<p>为了不冲突，我们改一下我们三台机器的地址，新地址如下</p>
<table>
<thead>
<tr>
<th>Hostname</th>
<th>网卡名称</th>
<th>IP/掩码</th>
<th>MAC 地址</th>
<th>网关</th>
</tr>
</thead>
<tbody>
<tr>
<td>vbox1</td>
<td>enp0s8</td>
<td>192.168.26.129/24</td>
<td>08:00:27:4c:f0:52</td>
<td>192.168.26.123</td>
</tr>
<tr>
<td>vbox2</td>
<td>enp0s8</td>
<td>192.168.26.122/27</td>
<td>08:00:27:69:22:ae</td>
<td>192.168.26.123</td>
</tr>
<tr>
<td>vbox3</td>
<td>enp0s8</td>
<td>192.168.26.123/24</td>
<td>08:00:27:d5:b5:13</td>
<td>192.168.26.1</td>
</tr>
</tbody>
</table>
<h2 id="问题2-网关没有转发">问题2: 网关没有转发</h2>
<p>更新了 IP 地址后，我们接着在 vbox1 上 ping <code>192.168.26.122</code>, 此时出现的问题是 ping 不通了，看起来上一个问题解决了，但是新的问题出现了。</p>
<p>我在 vbox2 上抓了一下包，看到了如下内容</p>
<pre tabindex="0"><code>vagrant@vbox2:~$ sudo tcpdump -i enp0s8 --print -en
17:17:56.850218 08:00:27:4c:f0:52 &gt; 08:00:27:69:22:ae, ethertype IPv4 (0x0800), length 98: 192.168.26.129 &gt; 192.168.26.122: ICMP echo request, id 25, seq 8, length 64
17:17:56.850246 08:00:27:69:22:ae &gt; 08:00:27:d5:b5:13, ethertype IPv4 (0x0800), length 98: 192.168.26.122 &gt; 192.168.26.129: ICMP echo reply, id 25, seq 8, length 64
17:17:57.868013 08:00:27:4c:f0:52 &gt; 08:00:27:69:22:ae, ethertype IPv4 (0x0800), length 98: 192.168.26.129 &gt; 192.168.26.122: ICMP echo request, id 25, seq 9, length 64
17:17:57.868046 08:00:27:69:22:ae &gt; 08:00:27:d5:b5:13, ethertype IPv4 (0x0800), length 98: 192.168.26.122 &gt; 192.168.26.129: ICMP echo reply, id 25, seq 9, length 64
17:17:58.883354 08:00:27:4c:f0:52 &gt; 08:00:27:69:22:ae, ethertype IPv4 (0x0800), length 98: 192.168.26.129 &gt; 192.168.26.122: ICMP echo request, id 25, seq 10, length 64
17:17:58.883387 08:00:27:69:22:ae &gt; 08:00:27:d5:b5:13, ethertype IPv4 (0x0800), length 98: 192.168.26.122 &gt; 192.168.26.129: ICMP echo reply, id 25, seq 10, length 64
</code></pre><p>vbox2 收到了来自 vbox1 的 ping request, 并发送 ping reply 给网关 vbox3, 这和我们预期的行为一致，说明 vbox2 没问题。</p>
<p>接着我又在 vbox3 上抓了一下包</p>
<pre tabindex="0"><code>root@vbox3:~# tcpdump -i enp0s8 --print -en
listening on enp0s8, link-type EN10MB (Ethernet), snapshot length 262144 bytes
01:49:50.730850 08:00:27:69:22:ae &gt; 08:00:27:d5:b5:13, ethertype IPv4 (0x0800), length 98: 192.168.26.122 &gt; 192.168.26.129: ICMP echo reply, id 26, seq 1, length 64
01:49:51.790335 08:00:27:69:22:ae &gt; 08:00:27:d5:b5:13, ethertype IPv4 (0x0800), length 98: 192.168.26.122 &gt; 192.168.26.129: ICMP echo reply, id 26, seq 2, length 64
01:49:53.203978 08:00:27:69:22:ae &gt; 08:00:27:d5:b5:13, ethertype IPv4 (0x0800), length 98: 192.168.26.122 &gt; 192.168.26.129: ICMP echo reply, id 26, seq 3, length 64
01:49:55.993736 08:00:27:69:22:ae &gt; 08:00:27:d5:b5:13, ethertype ARP (0x0806), length 60: Request who-has 192.168.26.123 tell 192.168.26.122, length 46
01:49:55.993751 08:00:27:d5:b5:13 &gt; 08:00:27:69:22:ae, ethertype ARP (0x0806), length 42: Reply 192.168.26.123 is-at 08:00:27:d5:b5:13, length 28
01:52:10.616571 08:00:27:69:22:ae &gt; 08:00:27:d5:b5:13, ethertype IPv4 (0x0800), length 98: 192.168.26.122 &gt; 192.168.26.129: ICMP echo reply, id 27, seq 1, length 64
01:52:11.965582 08:00:27:69:22:ae &gt; 08:00:27:d5:b5:13, ethertype IPv4 (0x0800), length 98: 192.168.26.122 &gt; 192.168.26.129: ICMP echo reply, id 27, seq 2, length 64
01:52:12.992503 08:00:27:69:22:ae &gt; 08:00:27:d5:b5:13, ethertype IPv4 (0x0800), length 98: 192.168.26.122 &gt; 192.168.26.129: ICMP echo reply, id 27, seq 3, length 64
</code></pre><p>vbox3 收到了 vbox2 转发来的包，但它没有进一步的发送动作，此时我拍脑袋一想，Linux 可能默认有限制，不转发包，于是我用 <strong>ubuntu 开启路由转发</strong> 作为关键字搜了一下，找到了配置项 <code>net.ipv4.ip_forward</code>, 我又用 <strong>ubuntu ipv4_forward</strong> 作为关键字搜索了一下，找到了 <a href="https://linuxconfig.org/how-to-turn-on-off-ip-forwarding-in-linux">ubuntu 开启 IP Forward 的文章</a>。</p>
<p>我执行以下命令，在 vbox3 上临时开启了 ip 转发的功能</p>
<pre tabindex="0"><code>sysctl -w net.ipv4.ip_forward=1
</code></pre><p>改完上述配置后，在 vbox1 上 ping <code>192.168.26.122</code> 就能 ping 通了。</p>
<p>在 vbox3 上抓包也能看到转发的 ICMP reply 包</p>
<pre tabindex="0"><code>01:58:54.790382 08:00:27:d5:b5:13 &gt; 08:00:27:4c:f0:52, ethertype IPv4 (0x0800), length 98: 192.168.26.122 &gt; 192.168.26.129: ICMP echo reply, id 28, seq 1, length 64
</code></pre><p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2023-08-23-234135.png" alt=""></p>
<h2 id="参考链接">参考链接</h2>
<ul>
<li><a href="https://linux-audit.com/how-to-clear-the-arp-cache-on-linux/">How to clear the ARP cache on Linux?</a></li>
<li><a href="https://www.virtualbox.org/manual/ch06.html#network_nat_service">6.4. Network Address Translation Service</a></li>
<li><a href="https://linuxconfig.org/how-to-turn-on-off-ip-forwarding-in-linux">Linux IP forwarding – How to Disable/Enable using net.ipv4.ip_forward</a></li>
<li>其他用到的命令</li>
</ul>
<pre tabindex="0"><code># 查看 arp 表
arp -n
# 清空 arp 表
sudo ip -s -s neigh flush all
# 查看路由信息
route -n
</code></pre>
</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-fb8915bbd249021082eebe2c7dfd52f0">10 - Golang</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-c374734838a7da2e3834d1091952177f">10.1 - 泛型</h1>
    
	<h2 id="利用泛型实现的语法糖">利用泛型实现的语法糖</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Cond
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 条件表达式的简单实现，支持任意类型
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">Cond</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">T</span> <span style="color:#000">any</span><span style="color:#000;font-weight:bold">](</span><span style="color:#000">val</span> <span style="color:#204a87;font-weight:bold">bool</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">a</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">b</span> <span style="color:#000">T</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">T</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">val</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">a</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">b</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Or
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 返回 vals 中第一个不是对应类型0值的参数，如果没有，则返回对应类型的0值
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">Or</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">T</span> <span style="color:#000">comparable</span><span style="color:#000;font-weight:bold">](</span><span style="color:#000">vals</span> <span style="color:#ce5c00;font-weight:bold">...</span><span style="color:#000">T</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">T</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">val</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">vals</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">val</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#204a87">new</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">T</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">val</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#204a87">new</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">T</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><ul>
<li>用法</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">TestCond</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">testing</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">T</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">assert</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Equal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Cond</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">true</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">assert</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Equal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Cond</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">req</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Request</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">assert</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Equal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MethodGet</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Cond</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">req</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MethodGet</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">http</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MethodPost</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">TestOr</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">testing</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">T</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 范型函数可以不传类型参数
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// 我在 1.18, 1.19, 1.20 上测试均可以工作
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">assert</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Equal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Or</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">]())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">assert</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Equal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Or</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">assert</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Equal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Or</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">assert</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Equal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Or</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">assert</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Equal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Or</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-8aa7d3f7c05390359a87acf37c95a33b">10.2 - YAML</h1>
    
	<h2 id="gopkginyamlv3-在-unmarshal-时设置默认值">gopkg.in/yaml.v3 在 Unmarshal 时设置默认值</h2>
<p>使用 <a href="https://github.com/go-yaml/yaml/tree/v3.0.1">gopkg.in/yaml.v3</a> 解析 yaml 文件时，我们可以实现结构体的 UnmarshalYAML 接口</p>
<p>在 <code>UnmarshalYAML</code> 方法中，既可以在结构体创建的时候指定默认值，也可以在结构体 Decode 完成之后，设置更复杂的默认值</p>
<ul>
<li>test.yaml</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">application</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">snowave</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">runtime</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">golang</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">services</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">linaewen.fdoulist</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">handler</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">services/api/thrift.go</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">thrift</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline"></span><span style="color:#204a87;font-weight:bold">use_services</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">app</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">fm</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">grpc</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">version</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">6b15b80</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">app</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">music</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">version</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">e89b497be9ef0fb932d5e543ed866f920780750f</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">  </span>- <span style="color:#204a87;font-weight:bold">app</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">pony</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span><span style="display:flex;"><span><span style="color:#f8f8f8;text-decoration:underline">    </span><span style="color:#204a87;font-weight:bold">version</span><span style="color:#000;font-weight:bold">:</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">c5b2e21</span><span style="color:#f8f8f8;text-decoration:underline">
</span></span></span></code></pre></div><ul>
<li>main.go</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;github.com/pkg/errors&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;gopkg.in/yaml.v3&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;strings&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">UseService</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">App</span>     <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#4e9a06">`yaml:&#34;app,omitempty&#34;`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Type</span>    <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#4e9a06">`yaml:&#34;type,omitempty&#34;`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Version</span> <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#4e9a06">`yaml:&#34;version&#34;`</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// UnmarshalYAML
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//	此程序演示了，在 Decode 之前设置 Type 字段的默认值为 thrift
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">u</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">UseService</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">UnmarshalYAML</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">yaml</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Node</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">tmp</span> <span style="color:#000">UseService</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ru</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">tmp</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Type</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;thrift&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">value</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Decode</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">ru</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">errors</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Wrap</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;UseService: failed to unmarshal&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">u</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">UseService</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ru</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Service</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Name</span>      <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#4e9a06">`yaml:&#34;name&#34;`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Interface</span> <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#4e9a06">`yaml:&#34;interface&#34;`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Type</span>      <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#4e9a06">`yaml:&#34;type&#34;`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Handler</span>   <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#4e9a06">`yaml:&#34;handler&#34;`</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// UnmarshalYAML
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//	此函数演示了更复杂的情况, Name 字段的默认值是根据 Interface 的值来设置的
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Name 是 Interface 中 `.` 分割的最后一段
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 如果 Interface 中没有 `.` , 则 Name == Interface
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Service</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">UnmarshalYAML</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">yaml</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Node</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">tmp</span> <span style="color:#000">Service</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">rs</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">tmp</span><span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">value</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Decode</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">rs</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">errors</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Wrap</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Service: failed to unmarshal&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">rs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#4e9a06">&#34;&#34;</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// 注意这里，无论 rs.Interface 的值是什么， tokens 的长度一定 &gt;= 1,
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// 所以 tokens[len(tokens)-1] 不会 Panic
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">tokens</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">strings</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Split</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Interface</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;.&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">rs</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">tokens</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">tokens</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">s</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">Service</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">rs</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">AppConfig</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Application</span> <span style="color:#204a87;font-weight:bold">string</span>        <span style="color:#4e9a06">`yaml:&#34;application&#34;`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Runtime</span>     <span style="color:#204a87;font-weight:bold">string</span>        <span style="color:#4e9a06">`yaml:&#34;runtime&#34;`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Services</span>    <span style="color:#000;font-weight:bold">[]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Service</span>    <span style="color:#4e9a06">`yaml:&#34;services&#34;`</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">UseServices</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">UseService</span> <span style="color:#4e9a06">`yaml:&#34;use_services&#34;`</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">config</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">AppConfig</span><span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">content</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">_</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ReadFile</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;test.yaml&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">yaml</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Unmarshal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">content</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">config</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatalln</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 输出
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//fdoulist linaewen.fdoulist
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">svc</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Services</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">svc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">svc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Interface</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 输出
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//fm grpc
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//music thrift
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//pony thrift
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">svc</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">config</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UseServices</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">svc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">App</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">svc</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Type</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="参考链接">参考链接</h3>
<ul>
<li><a href="https://github.com/go-yaml/yaml/issues/165#issuecomment-727092641">https://github.com/go-yaml/yaml/issues/165#issuecomment-727092641</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-52ff3e8194a92d6261809dbeed07036e">10.3 - Logrus 添加预设字段</h1>
    
	<hr>
<h2 id="tips">Tips</h2>
<ul>
<li>logrus 设置自定义 formatter, 添加预设字段</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#4e9a06">&#34;github.com/sirupsen/logrus&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">L</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">logrus</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Logger</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">customLogger</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">formatter</span> <span style="color:#000">logrus</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Formatter</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">domain</span>    <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">l</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">customLogger</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Format</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">entry</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">logrus</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Entry</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">([]</span><span style="color:#204a87;font-weight:bold">byte</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">entry</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Data</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;domain&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">l</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">domain</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">l</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">formatter</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Format</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">entry</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">L</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">logrus</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">New</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">L</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SetLevel</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">logrus</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">InfoLevel</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">L</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SetFormatter</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">customLogger</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">formatter</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">logrus</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">JSONFormatter</span><span style="color:#000;font-weight:bold">{},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">domain</span><span style="color:#000;font-weight:bold">:</span>    <span style="color:#4e9a06">&#34;custom domain&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">L</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Info</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;this msg&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//{&#34;domain&#34;:&#34;custom-domain&#34;,&#34;level&#34;:&#34;info&#34;,&#34;msg&#34;:&#34;this msg&#34;,&#34;time&#34;:&#34;2023-04-27T14:59:45+08:00&#34;}
</span></span></span></code></pre></div><h2 id="参考链接">参考链接</h2>
<ul>
<li><a href="https://github.com/sirupsen/logrus/issues/444#issuecomment-831093226">logrus#444</a></li>
</ul>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-16c718411b1484a4cad9a403ef36fc6a">10.4 - Golang Build 出错: error obtaining VCS status: exit status 128</h1>
    
	<hr>
<h2 id="go-build-时遇到了-error-obtaining-vcs-status-错误">Go build 时遇到了 error obtaining VCS status 错误</h2>
<p>我们的 Golang 项目都是在 docker 中 build 的，最近在 build 的时，遇到了以下的错误:</p>
<pre tabindex="0"><code>error obtaining VCS status: exit status 128
        Use -buildvcs=false to disable VCS stamping.
</code></pre><p>build golang 项目的 dockerfile 如下，我们会先把代码目录的所有者变成 bwangel, 再执行 go build:</p>
<pre tabindex="0"><code>FROM golang:1.18-buster

RUN sed -i &#39;s/deb.debian.org/mirrors.ustc.edu.cn/g&#39; /etc/apt/sources.list
RUN apt-get update &amp;&amp; apt-get -yq install sudo &amp;&amp; rm -rf /var/lib/apt/lists/*;

RUN git clone https://github.com/bwangelme/rdcdemo.git /go/src/
RUN /usr/sbin/useradd \
        --user-group \
        --create-home \
        --uid 1001 --shell &#39;/bin/bash&#39; \
        bwangel &amp;&amp; \
    chown bwangel:bwangel -R /go/src

WORKDIR /go/src/
RUN go build .
</code></pre><p>根据 buildvcs 这个关键字，我找到了 Go 1.18 的 <a href="https://tip.golang.org/doc/go1.18">release notes</a>，其中关于 buildvcs 的描述是这样的</p>
<blockquote>
<p>The go command now embeds version control information in binaries. It includes the currently checked-out revision, commit time, and a flag indicating whether edited or untracked files are present. Version control information is embedded if the go command is invoked in a directory within a Git, Mercurial, Fossil, or Bazaar repository, and the main package and its containing main module are in the same repository. This information may be omitted using the flag -buildvcs=false.</p>
</blockquote>
<blockquote>
<p>Additionally, the go command embeds information about the build, including build and tool tags (set with -tags), compiler, assembler, and linker flags (like -gcflags), whether cgo was enabled, and if it was, the values of the cgo environment variables (like CGO_CFLAGS). Both VCS and build information may be read together with module information using go version -m file or runtime/debug.ReadBuildInfo (for the currently running binary) or the new debug/buildinfo package.</p>
</blockquote>
<p>从 1.18 开始，Golang 在执行 build 时，会将 Git Commit Revision, Commit 时间，和是否有文件 Untracked 的标记写入到二进制中，使用 <code>go version -m &lt;file&gt;</code> 能够查看这些信息。</p>
<p>例如下面的代码中我们查看了 rdcdemo 文件的信息，可以看到执行 build 时 git commit revision 是 <code>8157a03bdfd846437cd0acdc1a7391ad9a13f6b3</code>, 这个 Commit 的创建时间是 <code>2021-09-26</code>, <code>vcs.modified=true</code> 表示有修改尚未提交到 git 中。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>ø&gt; go version -m rdcdemo
</span></span><span style="display:flex;"><span>rdcdemo: go1.18.9
</span></span><span style="display:flex;"><span>        path    rdcdemo
</span></span><span style="display:flex;"><span>        mod     rdcdemo <span style="color:#ce5c00;font-weight:bold">(</span>devel<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        dep     github.com/cespare/xxhash/v2    v2.1.1  h1:6MnRN8NT7+YBpUIWxHtefFZOKTAPgGjpQSxqLNn0+qY<span style="color:#ce5c00;font-weight:bold">=</span>
</span></span><span style="display:flex;"><span>        dep     github.com/dgryski/go-rendezvous        v0.0.0-20200823014737-9f7001d12a5f      h1:lO4WD4F/rVNCu3HqELle0jiPLLBs70cWOduZpkS1E78<span style="color:#ce5c00;font-weight:bold">=</span>
</span></span><span style="display:flex;"><span>        dep     github.com/go-redis/redis/v8    v8.11.3 h1:GCjoYp8c+yQTJfc0n69iwSiHjvuAdruxl7elnZCxgt8<span style="color:#ce5c00;font-weight:bold">=</span>
</span></span><span style="display:flex;"><span>        build   -compiler<span style="color:#ce5c00;font-weight:bold">=</span>gc
</span></span><span style="display:flex;"><span>        build   <span style="color:#000">CGO_ENABLED</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>        build   <span style="color:#000">CGO_CFLAGS</span><span style="color:#ce5c00;font-weight:bold">=</span>
</span></span><span style="display:flex;"><span>        build   <span style="color:#000">CGO_CPPFLAGS</span><span style="color:#ce5c00;font-weight:bold">=</span>
</span></span><span style="display:flex;"><span>        build   <span style="color:#000">CGO_CXXFLAGS</span><span style="color:#ce5c00;font-weight:bold">=</span>
</span></span><span style="display:flex;"><span>        build   <span style="color:#000">CGO_LDFLAGS</span><span style="color:#ce5c00;font-weight:bold">=</span>
</span></span><span style="display:flex;"><span>        build   <span style="color:#000">GOARCH</span><span style="color:#ce5c00;font-weight:bold">=</span>amd64
</span></span><span style="display:flex;"><span>        build   <span style="color:#000">GOOS</span><span style="color:#ce5c00;font-weight:bold">=</span>linux
</span></span><span style="display:flex;"><span>        build   <span style="color:#000">GOAMD64</span><span style="color:#ce5c00;font-weight:bold">=</span>v1
</span></span><span style="display:flex;"><span>        build   <span style="color:#000">vcs</span><span style="color:#ce5c00;font-weight:bold">=</span>git
</span></span><span style="display:flex;"><span>        build   vcs.revision<span style="color:#ce5c00;font-weight:bold">=</span>8157a03bdfd846437cd0acdc1a7391ad9a13f6b3
</span></span><span style="display:flex;"><span>        build   vcs.time<span style="color:#ce5c00;font-weight:bold">=</span>2021-09-26T11:45:50Z
</span></span><span style="display:flex;"><span>        build   vcs.modified<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#204a87">true</span>
</span></span></code></pre></div><p>在 build 时加上 <code>-buildvcs=false</code> 可以不添加这些信息。</p>
<h2 id="获取-vcs-信息的时候为什么会出错">获取 vcs 信息的时候为什么会出错</h2>
<p>报错 <code>error obtaining VCS status</code> 表示 Golang 获取 vcs 信息时出错了，但我还想往下深究一下，具体出了什么错误。此时就可以给 go build 加上 <code>-x -v</code> 选项，这样 go build 就会输出每一步执行的操作:</p>
<p>修改上述 dockerfile, 添加 build 选项 <code>-x -v</code></p>
<pre tabindex="0"><code>FROM golang:1.18-buster

RUN sed -i &#39;s/deb.debian.org/mirrors.ustc.edu.cn/g&#39; /etc/apt/sources.list
RUN apt-get update &amp;&amp; apt-get -yq install sudo &amp;&amp; rm -rf /var/lib/apt/lists/*;

RUN git clone https://github.com/bwangelme/rdcdemo.git /go/src/
RUN /usr/sbin/useradd \
        --user-group \
        --create-home \
        --uid 1001 --shell &#39;/bin/bash&#39; \
        bwangel &amp;&amp; \
    chown bwangel:bwangel -R /go/src

WORKDIR /go/src/
RUN go build -x -v .
</code></pre><p>此时出错信息变多了，可以看到，是 Go build 在执行 <code>git status --porcelain</code> 的时候出错了，错误信息是 <code>detected dubious ownership in repository</code></p>
<pre tabindex="0"><code>WORK=/tmp/go-build975996823
cd /go/src
git status --porcelain
# cd /go/src; git status --porcelain
fatal: detected dubious ownership in repository at &#39;/go/src&#39;
To add an exception for this directory, call:

        git config --global --add safe.directory /go/src
error obtaining VCS status: exit status 128
        Use -buildvcs=false to disable VCS stamping.
</code></pre><h2 id="git-为什么要检查-git-目录的-owner">Git 为什么要检查 .git 目录的 owner</h2>
<p>根据关键字 <code>detected dubious ownership in repository</code>, 我找到了一篇文章: <a href="https://medium.com/@thecodinganalyst/git-detect-dubious-ownership-in-repository-e7f33037a8f">Git detect dubious ownership in repository</a></p>
<p>这篇文章说，Git 命令在执行时，会执行 <code>.git/</code> 目录中的文件，如果 <code>.git/</code> 目录中的文件被恶意篡改了，那么就会造成安全漏洞。</p>
<p>例如 <code>/go/src</code> 这个目录是 bwangel 用户所有的，它修改了 <code>/go/src/.git/</code> 中的文件，添加了一个窃取信息的木马。root 用户在 <code>/go/src</code> 中执行 git status 时，就会以 root 用户执行这个木马，造成信息泄漏。</p>
<p>所以 Git 在 <a href="https://github.com/git/git/commit/8959555cee7ec045958f9b6dd62e541affb7e7d9">895955</a> 中添加了安全检查，确保执行 git 命令的用户和 <code>.git/</code> 目录的 owner 是同一个人。</p>
<p>如果用户信任某个目录，不想添加这种检查，可以修改配置 <code>safe.directory</code></p>
<pre tabindex="0"><code>git config --global --add safe.directory /some/repo
</code></pre><p>那么在 <code>/some/repo</code> 中执行 git 命令时，就不会检查文件 owner 了。</p>
<h2 id="解决-docker-build-失败的方案">解决 docker build 失败的方案</h2>
<h3 id="添加--buildvcsfalse-选项">添加 -buildvcs=false 选项</h3>
<p>修改 build 命令，加上 <code>-buildvcs=false</code> 选项，这样 go 不会收集 vcs 信息，也就不会遇到 git 的错误了</p>
<pre tabindex="0"><code>RUN go build -buildvcs=false .
</code></pre><h3 id="修改执行-go-build-的用户">修改执行 go build 的用户</h3>
<p>修改执行 build 命令的用户，这样也可以 build 成功</p>
<pre tabindex="0"><code>FROM golang:1.18-buster

RUN sed -i &#39;s/deb.debian.org/mirrors.ustc.edu.cn/g&#39; /etc/apt/sources.list
RUN apt-get update &amp;&amp; apt-get -yq install sudo &amp;&amp; rm -rf /var/lib/apt/lists/*;

RUN git clone https://github.com/bwangelme/rdcdemo.git /go/src/
RUN /usr/sbin/useradd \
        --user-group \
        --create-home \
        --uid 1001 --shell &#39;/bin/bash&#39; \
        bwangel &amp;&amp; \
    chown bwangel:bwangel -R /go/src

WORKDIR /go/src/
RUN su - bwangel bash -c &#34;cd /go/src; /usr/local/go/bin/go env; /usr/local/go/bin/go build -v .&#34;
</code></pre><h3 id="git-中添加-safe-directory-的配置">Git 中添加 safe directory 的配置</h3>
<p>将代码所在目录 <code>/go/src</code> 设置成 <code>safe.directory</code>, 这样 git 执行时就不会出错了，也可以 build 成功。</p>
<pre tabindex="0"><code>FROM golang:1.18-buster

RUN sed -i &#39;s/deb.debian.org/mirrors.ustc.edu.cn/g&#39; /etc/apt/sources.list
RUN apt-get update &amp;&amp; apt-get -yq install sudo &amp;&amp; rm -rf /var/lib/apt/lists/*;

RUN git clone https://github.com/bwangelme/rdcdemo.git /go/src/
RUN /usr/sbin/useradd \
        --user-group \
        --create-home \
        --uid 1001 --shell &#39;/bin/bash&#39; \
        bwangel &amp;&amp; \
    chown bwangel:bwangel -R /go/src

WORKDIR /go/src/
RUN git config --global --add safe.directory /go/src
RUN go build .
</code></pre><ul>
<li>safe.directory 只负责一个目录，不会关心子目录中的 git 仓库</li>
<li>使用 <code>*</code> 可以让所有仓库忽略 safe.directory 的检查</li>
</ul>
<pre tabindex="0"><code>git config --global --add safe.directory &#39;*&#39;
</code></pre><h2 id="go-install-时遇到的相似问题">go install 时遇到的相似问题</h2>
<p>当 GOPATH 目录的 owner 是 bwangel， 使用 root 用户运行 <code>go install</code> 安装私有仓库的命令时，也会遇到相同的问题。</p>
<p>比较有迷惑性的是，<code>go install</code>显示的错误是 <code>fatal: 'origin' does not appear to be a git repository</code></p>
<p>表面上看起来，这是下载的 git 仓库找不到 origin 这个 remote。但我们加上 <code>-x -v</code> 参数，输出一下详细的步骤，就能找到原因了。</p>
<pre tabindex="0"><code>root@551114e99eea:/go# go install -x -v github.private.repo/org/repo/cmd/dag@latest
# get https://github.private.repo/?go-get=1
# get https://github.private.repo/org?go-get=1
# get https://github.private.repo/org/repo/cmd?go-get=1
# get https://github.private.repo/org/repo/cmd/dag?go-get=1
# get https://github.private.repo/org/repo?go-get=1
# get https://github.private.repo/org/repo/cmd?go-get=1: 200 OK (0.103s)
# get https://github.private.repo/org/repo?go-get=1: 200 OK (0.103s)
# get https://github.private.repo/org/repo/cmd/dag?go-get=1: 200 OK (0.103s)
get &#34;github.private.repo/org/repo/cmd&#34;: found meta tag vcs.metaImport{Prefix:&#34;github.private.repo/org/repo&#34;, VCS:&#34;git&#34;, RepoRoot:&#34;https://github.private.repo/org/repo.git&#34;} at //github.private.repo/org/repo/cmd?go-get=1
get &#34;github.private.repo/org/repo/cmd&#34;: verifying non-authoritative meta tag
get &#34;github.private.repo/org/repo/cmd/dag&#34;: found meta tag vcs.metaImport{Prefix:&#34;github.private.repo/org/repo&#34;, VCS:&#34;git&#34;, RepoRoot:&#34;https://github.private.repo/org/repo.git&#34;} at //github.private.repo/org/repo/cmd/dag?go-get=1
get &#34;github.private.repo/org/repo/cmd/dag&#34;: verifying non-authoritative meta tag
# get https://github.private.repo/org/repo?go-get=1
get &#34;github.private.repo/org/repo&#34;: found meta tag vcs.metaImport{Prefix:&#34;github.private.repo/org/repo&#34;, VCS:&#34;git&#34;, RepoRoot:&#34;https://github.private.repo/org/repo.git&#34;} at //github.private.repo/org/repo?go-get=1
mkdir -p /go/pkg/mod/cache/vcs # git3 https://github.private.repo/org/repo.git
# lock /go/pkg/mod/cache/vcs/a1b9ef7e71cba11b98501177ca2d4f9fd012c258b967f915f68ee79a228ddf92.lock# /go/pkg/mod/cache/vcs/a1b9ef7e71cba11b98501177ca2d4f9fd012c258b967f915f68ee79a228ddf92 for git3 https://github.private.repo/org/repo.git
cd /go/pkg/mod/cache/vcs/a1b9ef7e71cba11b98501177ca2d4f9fd012c258b967f915f68ee79a228ddf92; git ls-remote -q origin
0.003s # cd /go/pkg/mod/cache/vcs/a1b9ef7e71cba11b98501177ca2d4f9fd012c258b967f915f68ee79a228ddf92; git ls-remote -q origin
# get https://github.private.repo/org/repo.git
# get https://github.private.repo/org/repo?go-get=1: 200 OK (0.040s)
# get https://github.private.repo/?go-get=1: 200 OK (0.154s)
# get https://github.private.repo/org?go-get=1: 200 OK (0.276s)
# get https://github.private.repo/org/repo.git: 200 OK (0.171s)
go: github.private.repo/org/repo/cmd/dag@latest: module github.private.repo/org/repo/cmd/dag: git ls-remote -q origin in /go/pkg/mod/cache/vcs/a1b9ef7e71cba11b98501177ca2d4f9fd012c258b967f915f68ee79a228ddf92: exit status 128:
        fatal: &#39;origin&#39; does not appear to be a git repository
        fatal: Could not read from remote repository.

        Please make sure you have the correct access rights
        and the repository exists.
</code></pre><p>在 go install 执行过程中，会首先下载仓库到 <code>/go/pkg/mod/cache/vcs/a1b9ef7e71cba11b98501177ca2d4f9fd012c258b967f915f68ee79a228ddf92</code> 目录中</p>
<p>然后在该目录执行 <code>git ls-remote -q origin</code> 获取 tag 列表，并得到最新的 repo tag.</p>
<p>因为 <code>safe.directory</code> 的检查，导致 <code>git ls-remote -q origin</code> 执行失败，git 认为 origin remote 不存在，才会显示异常 <code>fatal: 'origin' does not appear to be a git repository</code></p>
<p>go install 安装 github 上的仓库时，就不会遇到上述问题，因为安装 github 的仓库是从 GOPROXY 上获取的缓存文件，不需要经过 git 来查询 tag 了，不执行 git 命令，也就不会遇到上述问题了。</p>
<h2 id="参考链接">参考链接</h2>
<ul>
<li><a href="https://tip.golang.org/doc/go1.18">go 1.18 release note</a></li>
<li><a href="https://medium.com/@thecodinganalyst/git-detect-dubious-ownership-in-repository-e7f33037a8f">Git detect dubious ownership in repository</a></li>
<li><a href="https://idushu.com/%E8%A7%A3%E5%86%B3-golang-%E5%8D%87%E7%BA%A7%E5%88%B0-1-18-%E7%89%88%E6%9C%AC%E5%90%8E%E5%9C%A8%E5%AE%B9%E5%99%A8%E4%B8%AD%E6%9E%84%E5%BB%BA%E6%97%B6%E5%87%BA%E7%8E%B0-error-obtaining-vcs-status-exi/">解决 Golang 升级到 1.18+ 版本后在容器中构建时出现 error obtaining VCS status: exit status 128 的问题</a></li>
</ul>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-83df69ae1444d01a6f7c0a195b54857e">10.5 - pkg/errors 和 go1.13 中 errors 库发展历史</h1>
    
	<hr>
<ul>
<li>pkg/errors 的设计思路是，将 err 设计成一个链表，每次需要返回 error 的时候，调用 <code>errors.Wrap(err, &quot;message %v&quot;, value)</code>，生成一个新的 error，并将新 error 追加到链表尾部。这个 error 可以附加一些额外的信息和栈信息，</li>
<li>pkg/errors 提供了 <code>Cause</code> 接口和 <code>errors.Cause</code> 函数，<code>Cause</code> 接口返回 err 包裹的接口，<code>errors.Cause</code> 函数返回错误链表中链表头的错误</li>
<li>golang 1.13 中，将 pkg/errors 的设计思路纳入到了标准库中 <code>errors</code>
<ul>
<li>go 标准库采用了链表链接 error 的设计思路</li>
<li>go 标准库没有使用 pkg/errors 的 <code>Cause</code> 接口，而是使用了新接口 <code>Unwrap</code>，这样导致无法和旧的使用 <code>pkg/errors</code> 的代码兼容</li>
<li>go 标准库提供了处理错误的三个函数:
<ul>
<li><code>errors.Unwrap(err error) error</code> 返回 <code>err</code> 链表头的 error (即原始 error)</li>
<li><code>errors.Is(err error, target error) bool</code> 遍历 <code>err</code> 链表中的每一个错误和 <code>target</code> 进行比较, 判断 <code>err</code> 链表中是否存在和 <code>target</code> 相等的错误，如果有，返回 <code>true</code>，否则返回 <code>false</code></li>
<li><code>errors.As(err error, target interface{}) bool</code>，从 <code>err</code> 链表中找到第一个可以赋值给 <code>target</code> 的错误，并将其赋值给 <code>target</code>，如果赋值成功，返回 <code>true</code>，否则返回 <code>fasle</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="参考链接">参考链接</h2>
<ul>
<li><a href="https://dr-knz.net/cockroachdb-errors-std-api.html">The Go standard error APIs The CockroachDB errors library, part 1/</a></li>
<li><a href="https://github.com/golang/go/blob/dev.boringcrypto.go1.17/src/errors/wrap.go">go1.17 source code errors/wrap.go</a></li>
</ul>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-434a02cf1a3ee72f31be04b770f0fabb">10.6 - Golang 的版本发布计划</h1>
    
	<blockquote>
<p>Golang 的版本发布计划</p>
</blockquote>
<hr>
<h2 id="golang-的版本发布计划">Golang 的版本发布计划</h2>
<p>在 <a href="https://github.com/golang/go/wiki/Go-Release-Cycle">Go Release Cycle</a> 中写明了</p>
<p>每半年发布一个版本，每年的02月和08月发布一个 Major 版本。但是 Go 官方好像一直没有严格遵守过这个时间。</p>
<p>在 <a href="https://go.dev/doc/devel/release">Release History</a> 中可以看到最近的版本发布日期</p>
<table>
<thead>
<tr>
<th>版本</th>
<th>发布日期</th>
<th>是否还在维护</th>
</tr>
</thead>
<tbody>
<tr>
<td>go1.19</td>
<td><a href="https://groups.google.com/g/golang-dev/c/4xsD_D5oflI">2022-11-01?</a></td>
<td>开发中</td>
</tr>
<tr>
<td>go1.18</td>
<td>2022-03-15</td>
<td>是</td>
</tr>
<tr>
<td>go1.17</td>
<td>2021-08-16</td>
<td>是</td>
</tr>
<tr>
<td>go1.16</td>
<td>2021-02-16</td>
<td>否</td>
</tr>
<tr>
<td>go1.15</td>
<td>2020-08-11</td>
<td>否</td>
</tr>
<tr>
<td>go1.14</td>
<td>2020-02-25</td>
<td>否</td>
</tr>
<tr>
<td>go.1.13</td>
<td>2019-09-03</td>
<td>否</td>
</tr>
<tr>
<td>go1.12</td>
<td>2019-02-25</td>
<td>否</td>
</tr>
<tr>
<td>go1.11</td>
<td>2018-08-24</td>
<td>否</td>
</tr>
<tr>
<td>go1.10</td>
<td>2018-02-16</td>
<td>否</td>
</tr>
<tr>
<td>go1.9</td>
<td>2017-08-24</td>
<td>否</td>
</tr>
<tr>
<td>go1.8</td>
<td>2017-02-16</td>
<td>否</td>
</tr>
<tr>
<td>go1.7</td>
<td>2016-08-15</td>
<td>否</td>
</tr>
<tr>
<td>go1.6</td>
<td>2016-02-17</td>
<td>否</td>
</tr>
<tr>
<td>go1.5</td>
<td>2015-08-19</td>
<td>否</td>
</tr>
<tr>
<td>go1.4</td>
<td>2014-12-10</td>
<td>否</td>
</tr>
<tr>
<td>go1.3</td>
<td>2014-06-18</td>
<td>否</td>
</tr>
<tr>
<td>go1.2</td>
<td>2013-12-01</td>
<td>否</td>
</tr>
<tr>
<td>go1.1</td>
<td>2013-05-13</td>
<td>否</td>
</tr>
<tr>
<td>go1</td>
<td>2012-03-28</td>
<td>否</td>
</tr>
</tbody>
</table>
<h2 id="每个版本的维护计划">每个版本的维护计划</h2>
<blockquote>
<p>Each major Go release is supported until there are two newer major releases. For example, Go 1.5 was supported until the Go 1.7 release, and Go 1.6 was supported until the Go 1.8 release. We fix critical problems, including critical security problems, in supported releases as needed by issuing minor revisions (for example, Go 1.6.1, Go 1.6.2, and so on).</p>
</blockquote>
<p>每个 Major 版本会维护到下两个 Major 版本 release 的时候，例如 Go1.18 release 的，Go1.16 就放弃维护了。所以每个 Major 版本大致的支持时间是1年</p>
<h2 id="参考链接">参考链接</h2>
<ul>
<li><a href="https://dev.golang.org/release">Golang Release dashboard</a></li>
<li><a href="https://github.com/golang/go/wiki/Go-Release-Cycle">Go Release Cycle</a></li>
<li><a href="https://go.dev/doc/devel/release">Release History</a></li>
<li><a href="https://groups.google.com/g/golang-dev/c/4xsD_D5oflI">Go 1.19 release status</a></li>
</ul>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-3e6373393d3b5fc1fcfcf9263b1f83af">10.7 - Go gcflags/ldflags 的说明</h1>
    
	<blockquote>
<p>Go 链接选项和编译选项的说明</p>
</blockquote>
<hr>
<h2 id="编译选项">编译选项</h2>
<p>go build 时可以使用 <code>-gcflags</code> 指定编译选项，<code>-gcflags</code> 参数的格式是</p>
<pre tabindex="0"><code>-gcflags=&#34;pattern=arg list&#34;
</code></pre><h3 id="pattern">pattern</h3>
<p>pattern 是选择包的模式，它可以有以下几种定义:</p>
<ul>
<li><code>main</code>: 表示 main 函数所在的顶级包路径</li>
<li><code>all</code>: 表示 GOPATH 中的所有包。如果在 modules 模式下，则表示主模块和它所有的依赖，包括 test 文件的依赖</li>
<li><code>std</code>: 表示 Go 标准库中的所有包</li>
<li><code>...</code>: <code>...</code> 是一个通配符，可以匹配任意字符串(包括空字符串)。例如:
<ul>
<li>例如: <code>net/...</code> 表示 net 模块和它的所有子模块</li>
<li><code>./...</code> 表示当前主模块和所有子模块</li>
<li><strong>注意:</strong> 如果 pattern 中包含了 <code>/</code> 和 <code>...</code>，那么就不会匹配 <code>vendor</code> 目录
<ul>
<li>例如: <code>./...</code> 不会匹配 <code>./vendor</code> 目录。可以使用 <code>./vendor/...</code> 匹配 vendor 目录和它的子模块</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>更多的模式的说明请参考 <code>go help packages</code></p>
<h3 id="arg-list">arg list</h3>
<p>arg list 是空格分割的编译选项，如果编译选项中含有空格，可以使用引号包起来</p>
<p>下面介绍几种常用的编译选项:</p>
<ul>
<li><code>-N</code>: 禁止编译器优化</li>
<li><code>-l</code>: 关闭内联 (inline)</li>
<li><code>-c int</code>: 编译过程中的并发数，默认是1</li>
</ul>
<p>更多编译选项请参考 <code>go tool compile --help</code></p>
<h3 id="举例">举例</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 为当前模块下的所有包关闭编译优化和内联</span>
</span></span><span style="display:flex;"><span>go build -gcflags<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;all=-N -l&#34;</span> .
</span></span></code></pre></div><h2 id="链接选项">链接选项</h2>
<p><code>-ldflags</code> 可以设置链接选项</p>
<ul>
<li><code>-w</code> 不生成 DWARF 调试信息</li>
<li><code>-s</code> 关闭符号表</li>
</ul>
<p><code>-w</code> 和 <code>-s</code> 通常一起使用，用来减少可执行文件的体积。但删除了调试信息后，可执行文件将无法使用 gdb/dlv 调试</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>ø&gt; go build -ldflags<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;-w -s&#34;</span> ./abc.go
</span></span><span style="display:flex;"><span>ø&gt; dlv <span style="color:#204a87">exec</span> ./abc
</span></span><span style="display:flex;"><span>could not launch process: could not open debug info
</span></span></code></pre></div><p>注意： 使用 <code>go run main.go</code> 运行的进程，也无法用 <code>dlv attach ${pid}</code> 调试，因为找不到代码的符号信息。</p>
<h2 id="参考链接">参考链接</h2>
<ul>
<li><code>go help packages</code></li>
<li><code>go tool compile --help</code></li>
<li><code>go help build</code></li>
<li><a href="https://studygolang.com/articles/22803">https://studygolang.com/articles/22803</a></li>
<li><a href="https://javasgl.github.io/go-build-args/">https://javasgl.github.io/go-build-args/</a></li>
<li><a href="https://github.com/go-delve/delve/issues/1698">https://github.com/go-delve/delve/issues/1698</a></li>
</ul>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-411c7d44b39c2c01f271102f90652135">10.8 - Go proxy 的说明</h1>
    
	<hr>
<h2 id="查看-go-proxy-中包的信息">查看 Go Proxy 中包的信息</h2>
<h3 id="查看包的版本列表">查看包的版本列表</h3>
<pre tabindex="0"><code>ø&gt; curl https://proxy.golang.org/go.etcd.io/etcd/client/v3/@v/list
v3.5.0-beta.4
v3.5.4
v3.5.2
v3.5.0-alpha.0
v3.5.0-rc.0
v3.5.3
v3.5.0
v3.5.1
v3.5.0-beta.2
v3.6.0-alpha.0
v3.5.0-rc.1
v3.5.0-beta.3
</code></pre><h3 id="查看包的版本信息">查看包的版本信息</h3>
<pre tabindex="0"><code>curl https://proxy.golang.org/go.etcd.io/etcd/client/v3/@v/v3.0.0-20201116001935-06e48f04865f.info
</code></pre><h3 id="查看包的依赖">查看包的依赖</h3>
<p>即获取 go.mod 文件</p>
<pre tabindex="0"><code>curl https://proxy.golang.org/go.etcd.io/etcd/client/v3/@v/v3.0.0-20201116001935-06e48f04865f.mod
</code></pre><pre tabindex="0"><code>module go.etcd.io/etcd/client/v3

go 1.15

require (
        github.com/dustin/go-humanize v1.0.0
        github.com/google/uuid v1.1.2
        github.com/grpc-ecosystem/go-grpc-prometheus v1.2.0
        github.com/prometheus/client_golang v1.5.1
        go.etcd.io/etcd/api/v3 v3.5.0-pre
        go.etcd.io/etcd/pkg/v3 v3.5.0-pre
        go.uber.org/zap v1.16.0
        google.golang.org/grpc v1.29.1
        sigs.k8s.io/yaml v1.2.0
)

replace (
        go.etcd.io/etcd/api/v3 =&gt; ../../api
        go.etcd.io/etcd/pkg/v3 =&gt; ../../pkg
)

// Bad imports are sometimes causing attempts to pull that code.
// This makes the error more explicit.
replace (
        go.etcd.io/etcd =&gt; ./FORBIDDEN_DEPENDENCY
        go.etcd.io/etcd/v3 =&gt; ./FORBIDDEN_DEPENDENCY
        go.etcd.io/tests/v3 =&gt; ./FORBIDDEN_DEPENDENCY
)
</code></pre><h3 id="下载包">下载包</h3>
<pre tabindex="0"><code>curl https://proxy.golang.org/go.etcd.io/etcd/client/v3/@v/v3.0.0-20201116001935-06e48f04865f.zip
</code></pre><h2 id="proxy-测速">Proxy 测速</h2>
<p>2021-12-13 日晚安装包 <code>go-git/go-git-fixtures</code> 的时候卡着不动，测了一下两个 proxy 的速度</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>ø&gt; curl https://goproxy.io/github.com/go-git/go-git-fixtures/v4/@v/v4.2.1.zip -o /tmp/pkg.zip
</span></span><span style="display:flex;"><span>  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
</span></span><span style="display:flex;"><span>                                 Dload  Upload   Total   Spent    Left  Speed
</span></span><span style="display:flex;"><span>  <span style="color:#0000cf;font-weight:bold">2</span> 93.4M    <span style="color:#0000cf;font-weight:bold">2</span> 2623k    <span style="color:#0000cf;font-weight:bold">0</span>     <span style="color:#0000cf;font-weight:bold">0</span>   181k      <span style="color:#0000cf;font-weight:bold">0</span>  0:08:48  0:00:14  0:08:34  147k
</span></span><span style="display:flex;"><span>ø&gt; curl https://goproxy.cn/github.com/go-git/go-git-fixtures/v4/@v/v4.2.1.zip -o /tmp/pkg.zip
</span></span><span style="display:flex;"><span>  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
</span></span><span style="display:flex;"><span>                                 Dload  Upload   Total   Spent    Left  Speed
</span></span><span style="display:flex;"><span> <span style="color:#0000cf;font-weight:bold">10</span> 93.4M   <span style="color:#0000cf;font-weight:bold">10</span>  9.7M    <span style="color:#0000cf;font-weight:bold">0</span>     <span style="color:#0000cf;font-weight:bold">0</span>  3712k      <span style="color:#0000cf;font-weight:bold">0</span>  0:00:25  0:00:02  0:00:23 3711k
</span></span><span style="display:flex;"><span> <span style="color:#0000cf;font-weight:bold">21</span> 93.4M   <span style="color:#0000cf;font-weight:bold">21</span> 20.2M    <span style="color:#0000cf;font-weight:bold">0</span>     <span style="color:#0000cf;font-weight:bold">0</span>  5605k      <span style="color:#0000cf;font-weight:bold">0</span>  0:00:17  0:00:03  0:00:14 5603k
</span></span></code></pre></div><p>goproxy.io 的下载速度竟然只有 147k，怪不得安装时会卡住</p>
<h2 id="参考链接">参考链接</h2>
<ul>
<li><a href="https://go.dev/ref/mod">https://go.dev/ref/mod</a></li>
</ul>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-5e7f1bf4777000a4a638a29b3b04d48f">10.9 - Golang 链接时注入额外信息</h1>
    
	<blockquote>
<p>Go 编译器注入 git 版本，时间等信息到可执行文件中</p>
</blockquote>
<hr>
<h2 id="go-链接时的--x-选项">Go 链接时的 -X 选项</h2>
<blockquote>
<p>-X importpath.name=value</p>
<p>Set the value of the string variable in importpath named name to value.
This is only effective if the variable is declared in the source code either uninitialized
or initialized to a constant string expression. -X will not work if the initializer makes
a function call or refers to other variables.
Note that before Go 1.5 this option took two separate arguments.</p>
</blockquote>
<p><strong>链接:</strong> go 编译工具读取 package main 和它的依赖(是 archive 文件或对象)，将它们组合在一起生成一个可执行文件。</p>
<p>Go 在链接时支持 <code>-X</code> 选项，它的用法为 <code>-X importpath.name=value</code>，它将会替换 <strong>字符串变量</strong> <code>importpath.name</code>的值，将其设置为<code>value</code>。</p>
<ul>
<li>
<p><strong>注意1</strong>: 只有在<code>importpath.name</code>未初始化或者初始化为常量字符串的时候才会生效。如果 <code>importpath.name</code> 是通过一个函数调用或者变量来初始化的话，<code>-X</code>选项将不会生效。</p>
</li>
<li>
<p><strong>注意2</strong>: <code>value</code>中有空格时， -X 后面的值都要用单引号包起来，例如 <code>-X '${REPO_PATH}/version.BuildTimeStamp=${BuildTimeStamp} UTC'</code></p>
</li>
<li>
<p><strong>注意3</strong>: Go 1.5 版本以下 -X 选项的格式是 <code>-X importpath.name value</code></p>
</li>
</ul>
<h2 id="运行效果">运行效果</h2>
<ul>
<li>源码: <a href="https://github.com/bwangelme/build_git_version">bwangelme/build_git_version</a></li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>ø&gt; ./build.sh <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> ./bin/runme
</span></span><span style="display:flex;"><span>Git Version c530ca1
</span></span><span style="display:flex;"><span>Build TimeStamp 2021-05-07_04:01:35AM UTC
</span></span><span style="display:flex;"><span>Build Go Version go version go1.16 darwin/amd64
</span></span></code></pre></div><h2 id="参考链接">参考链接</h2>
<ul>
<li><a href="https://golang.org/cmd/link/">Go cmd Link</a></li>
<li><a href="https://ms2008.github.io/2018/10/08/golang-build-version/">Golang -ldflags 的一个技巧 go version 信息注入</a></li>
<li><a href="https://groups.google.com/forum/#!topic/golang-nuts/aNDB4FrmEiA">v1.5 -ldflags -X change breaks when string has a space</a></li>
</ul>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-495e45c0b281c859ecdd31687f35d51b">10.10 - 《Golang Error》学习笔记</h1>
    
	<blockquote>
<p>Golang Error 学习笔记</p>
</blockquote>
<hr>
<h2 id="panic-的使用场景">Panic 的使用场景</h2>
<ol>
<li>MySQL 无法链接，redis 可以连接，这时候是可以启动 <strong>读多写少</strong> 的服务的，不用强制 panic ，因为此时服务还是能够通过缓存来工作，数据无法写入，也不会导致写入脏数据。</li>
<li>配置文件检查失败时，可以执行 Panic</li>
<li>依赖的 RPC 无法启动时，可以先启动，但是服务会大量报错。</li>
</ol>
<p>对于真正出意外的情况，表示不可恢复的程序错误，例如索引越界，不可回复的环境问题，栈溢出，我们才使用 <code>panic</code>，逻辑上的错误，我们应该使用 error 来进行判断。</p>
<blockquote>
<p>You only need to check the error value if you care about the result &ndash; Dave</p>
</blockquote>
<h2 id="sentinel-error">Sentinel Error</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">os</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ErrInvalid</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">errInvalid</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#8f5902;font-style:italic">// &#34;invalid argument&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ErrPermission</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">errPermission</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#8f5902;font-style:italic">// &#34;permission denied&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">ErrExist</span>      <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">errExist</span><span style="color:#000;font-weight:bold">()</span>      <span style="color:#8f5902;font-style:italic">// &#34;file already exists&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">ErrNotExist</span>   <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">errNotExist</span><span style="color:#000;font-weight:bold">()</span>   <span style="color:#8f5902;font-style:italic">// &#34;file does not exist&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">ErrClosed</span>     <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">errClosed</span><span style="color:#000;font-weight:bold">()</span>     <span style="color:#8f5902;font-style:italic">// &#34;file already closed&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">ErrNoDeadline</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">errNoDeadline</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#8f5902;font-style:italic">// &#34;file type does not support deadline&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>预定义的特定错误，我们叫做 <code>Sentinel Error</code>。</p>
<ol>
<li>Sentinel Error 会成为 API 的公共部分。</li>
<li>Sentinel Error 在两个包之间创建了依赖。</li>
<li>Sentinel Error 让调用者无法返回更多的信息。</li>
</ol>
<p>应该尽可能避免 Sentinel Error。</p>
<h2 id="struct-error">Struct Error</h2>
<p>定义一个结构体实现 error 接口，里面包含了相关的上下文信息</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">net</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">OpError</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// Op is the operation which caused the error, such as
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// &#34;read&#34; or &#34;write&#34;.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">Op</span> <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// Net is the network type on which this error occurred,
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// such as &#34;tcp&#34; or &#34;udp6&#34;.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">Net</span> <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// For operations involving a remote network connection, like
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// Dial, Read, or Write, Source is the corresponding local
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// network address.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">Source</span> <span style="color:#000">Addr</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// Addr is the network address for which this error occurred.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// For local operations, like Listen or SetDeadline, Addr is
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// the address of the local endpoint being manipulated.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// For operations involving a remote network connection, like
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// Dial, Read, or Write, Addr is the remote address of that
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// connection.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">Addr</span> <span style="color:#000">Addr</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// Err is the error that occurred during the operation.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">Err</span> <span style="color:#204a87;font-weight:bold">error</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="opaque-error">Opaque Error</h2>
<p>对外暴露一个函数来检测错误的信息，而不是直接暴露 Error 类型给外部。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">temporary</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">Temporary</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">bool</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">IsTemporary</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">bool</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">te</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ok</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">.(</span><span style="color:#000">temporary</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">ok</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">te</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Temporary</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="通过消除错误来优化错误处理代码">通过消除错误来优化错误处理代码</h2>
<ul>
<li>原始代码</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Header</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Value</span> <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Status</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Code</span>   <span style="color:#204a87;font-weight:bold">int</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Reason</span> <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">BadWriteResponse</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">w</span> <span style="color:#000">io</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Writer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">st</span> <span style="color:#000">Status</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">headers</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#000">Header</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">body</span> <span style="color:#000">io</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Reader</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">w</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;HTTP/1.1 %d %s\r\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">st</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Code</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">st</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Reason</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">h</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">headers</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">w</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;%s: %s\r\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">h</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">h</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Value</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">w</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;\r\n&#34;</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">io</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Copy</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">w</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">body</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><ul>
<li>优化后的代码</li>
</ul>
<p>通过将错误状态存储起来，后续的调用，如果有错误状态的话，那就不执行写入。
最后将错误状态返回，错误状态存储的是第一个遇到的错误值，所以这里的代码和原始代码的效果是一样的。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">errWriter</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">io</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Writer</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">e</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">errWriter</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Write</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">buf</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">byte</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">e</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">e</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">n</span> <span style="color:#204a87;font-weight:bold">int</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">n</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">e</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">e</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Writer</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Write</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">buf</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">n</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">GoodWriteResponse</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">w</span> <span style="color:#000">io</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Writer</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">st</span> <span style="color:#000">Status</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">headers</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#000">Header</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">body</span> <span style="color:#000">io</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Reader</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ew</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">errWriter</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">Writer</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">w</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ew</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;HTTP/1.1 %d %s\r\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">st</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Code</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">st</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Reason</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">h</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">headers</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ew</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;%s: %s\r\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">h</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Key</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">h</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Value</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ew</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;\r\n&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">io</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Copy</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ew</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">body</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">ew</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">err</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="wrap-errors">Wrap Errors</h2>
<blockquote>
<p>You should only handle errors once. Handing an error means inspecting the error value, and making a single decision.</p>
</blockquote>
<p>Go 中的错误处理有契约约定，在出现错误的情况下，不能对其他返回值的内容作出任何假设。</p>
<p>如果代码要吞掉 error，那么也要对相应的返回值负责(例如返回降级后的默认值)。</p>
<p>日志记录与错误无关且对调试没有帮助的信息应该被视为噪音，应予以质疑。
记录的原因是因为某些东西失败了，且日志中应该包含了答案。</p>
<ul>
<li>错误要被日志记录</li>
<li>应用程序通过日志记录错误，返回一个降级的值(保证100%的完整性)，且不再往上抛错误</li>
<li>应用程序单纯地将错误往上抛，不需要做任何处理</li>
</ul>
<h3 id="pkg-errors-库">pkg errors 库</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">ReadFile</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">path</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">([]</span><span style="color:#204a87;font-weight:bold">byte</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">f</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Open</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">path</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">errors</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Wrap</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;open failed&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">f</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Close</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">buf</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">ioutil</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ReadAll</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">f</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">errors</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Wrap</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;read failed&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">buf</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">nil</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">ReadConfig</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">([]</span><span style="color:#204a87;font-weight:bold">byte</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">home</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Getenv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;HOME&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">config</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">ReadFile</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">filepath</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Join</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">home</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;.settings.xml&#34;</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">config</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">errors</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WithMessage</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;counld not read config&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">ReadConfig</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#8f5902;font-style:italic">// Cause 会拿到最底层的错误
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>            <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;original error: %T %v\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">errors</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Cause</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">errors</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Cause</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>            <span style="color:#8f5902;font-style:italic">// %+v 会打印堆栈信息
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>            <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;stack trace:\n%+v\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Exit</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><ul>
<li>输出</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>ø&gt; go run pkgerror.go
</span></span><span style="display:flex;"><span>original error: *os.PathError open /home/xuyundong/.settings.xml: no such file or directory
</span></span><span style="display:flex;"><span>stack trace:
</span></span><span style="display:flex;"><span>open /home/xuyundong/.settings.xml: no such file or directory  <span style="color:#8f5902;font-style:italic"># 这是原始错误</span>
</span></span><span style="display:flex;"><span>open failed  <span style="color:#8f5902;font-style:italic"># 这是原始错误包装后的信息</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 下面是堆栈信息</span>
</span></span><span style="display:flex;"><span>main.ReadFile
</span></span><span style="display:flex;"><span>        /home/xuyundong/Github/Golang/GoDemo/pkgerror.go:15
</span></span><span style="display:flex;"><span>main.ReadConfig
</span></span><span style="display:flex;"><span>        /home/xuyundong/Github/Golang/GoDemo/pkgerror.go:28
</span></span><span style="display:flex;"><span>main.main
</span></span><span style="display:flex;"><span>        /home/xuyundong/Github/Golang/GoDemo/pkgerror.go:33
</span></span><span style="display:flex;"><span>runtime.main
</span></span><span style="display:flex;"><span>        /home/xuyundong/.local/go/src/runtime/proc.go:204
</span></span><span style="display:flex;"><span>runtime.goexit
</span></span><span style="display:flex;"><span>        /home/xuyundong/.local/go/src/runtime/asm_amd64.s:1374
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 这是在 wraperror 上又包装的信息</span>
</span></span><span style="display:flex;"><span>counld not <span style="color:#204a87">read</span> config
</span></span><span style="display:flex;"><span><span style="color:#204a87">exit</span> status <span style="color:#0000cf;font-weight:bold">1</span>
</span></span></code></pre></div><h3 id="pkg-errors-使用规则">pkg-errors 使用规则</h3>
<ul>
<li>在应用代码中，使用 errors.New 或者 errors.Errorf 返回错误</li>
<li>如果调用其他包内的函数(其他包已经保持了堆栈信息)，通常简单的直接返回</li>
<li>如果和第三方库进行协作(Github 第三方库，公司基础库, 标准库，没有保存堆栈信息)，考虑使用 <code>errors.Wrap</code> 保存根 err 和堆栈信息</li>
<li>直接返回错误，而不是在每个错误产生的地方打日志</li>
<li>在程序的顶部，或者工作的 goroutine 顶部(请求入口)，使用 <code>%+v</code> 将堆栈信息打印出来</li>
<li>可以使用 <code>errors.Cause</code> 获取根 err，将 sentinel error 进行对比</li>
</ul>
<p><strong>注意:</strong></p>
<ol>
<li><code>Packages that are reusable across many projects only return root error values</code> 基础库(重用性高)不应该 wrap error，只有应用库适合 wrap error</li>
<li><code>if the error is not going to be handled, wrap and return up the call stack</code> 如果不打算处理错误的话(降级错误)，那么应该 wrap 起来继续往上抛，额外的上下文可以是输入的参数或者失败的 SQL 语句。</li>
<li><code>Once an error is handled, it is not allowed to be passed up the call stack any longer.</code> 一旦一个错误被处理过了，那就不应该继续往上抛了，返回一个降级的值就可以了。</li>
</ol>
<h2 id="go-113-中新增的错误处理方法">Go 1.13 中新增的错误处理方法</h2>
<p>pkg-errors 的作者 <a href="https://github.com/davecheney">Dave</a> 的意见被 Go 官方采纳，Go 1.13 中新增了一些错误的处理方法 <code>Unwrap</code>，<code>Is</code> 和 <code>As</code></p>
<ul>
<li><code>Is</code> 类似于 Python 中的 <code>isubclass</code></li>
<li><code>As</code> 是检查 error 是否是某个特定类型的 error，如果是的话，那么就返回true，且将参数设置为对应类型的 error</li>
<li><code>fmt.Errorf</code> 新增 <code>%w</code> 格式字符串，可以将原始错误包裹起来。<a href="https://github.com/bwangelme/go-1.13/blob/6ece83485f77117120693f16ff516c768a31c02a/src/fmt/errors.go#L32">相关源代码</a></li>
</ul>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-6be775a3d57f960eb07e45a142768f29">10.11 - Go 的调度模型学习笔记</h1>
    
	<blockquote>
<p>阅读 <a href="https://wudaijun.com/2018/01/go-scheduler/">Go 调度模型</a> 后记的笔记</p>
</blockquote>
<hr>
<h2 id="gpm-模型">GPM 模型</h2>
<ul>
<li>G: 每个Goroutine都会对应一个 <a href="https://github.com/bwangelme/go-1.13/blob/6ece83485f77117120693f16ff516c768a31c02a/src/runtime/runtime2.go#L387-L386">G 结构体</a>，它保存了函数执行的栈。</li>
<li>P: Processor，逻辑上的处理器，对应 <a href="https://github.com/bwangelme/go-1.13/blob/6ece83485f77117120693f16ff516c768a31c02a/src/runtime/runtime2.go#L523">P 结构体</a>。在 Go 程序启动后，会创建和CPU内核数相等的 P。用户可以通过<code>GOMAXPROCS</code>调整P的数量，不过这个函数会 <a href="https://github.com/bwangelme/go-1.13/blob/6ece83485f77117120693f16ff516c768a31c02a/src/runtime/debug.go#L29">STW</a>，尽量少调用这个函数。</li>
<li>M: Machine, 对应 <a href="https://github.com/bwangelme/go-1.13/blob/6ece83485f77117120693f16ff516c768a31c02a/src/runtime/runtime2.go#L452">M 结构体</a>，通过 <a href="http://man7.org/linux/man-pages/man2/clone.2.html">clone</a> 创建的系统级线程，任务的实际执行者。G 和 P 绑定后， P 会放到 M 上执行，M 不保存 G 的状态，所以 G 可以跨 M 执行。</li>
</ul>
<ul>
<li><code>GRQ</code>: Globale Runable Queue，Goroutine 的全局运行队列</li>
<li><code>LRQ</code>: Local Runable Queue， P 本地保存的 Goroutine 运行队列</li>
</ul>
<p>Goroutine 创建后，会创建一个G对象，它会先尝试加入到 P 的 runnext中，如果不行的话，会接着尝试 P 的 LRQ，如果仍然不行，会放入到 GRQ 中，同时将当前P的 LRQ 中的一半任务放入到 GRQ 中。</p>
<p>P 运行时会从 LRQ 中取出一个 G，和它绑定到一起，在 M 上运行。
P取 G 的顺序是: <code>LRQ &gt; GRQ &gt; 从其他 P 偷 G</code></p>
<h2 id="用户态的阻塞唤醒">用户态的阻塞/唤醒</h2>
<p>当 G 在用户态阻塞的时候(例如从 channel 读/写)，会将当前 G 的状态从 Running 改为 Wait，同时将 G 放入到一个 wait 队列中(例如 channel 的 wait 队列)。</p>
<p>当 G 被另外一个 G2 唤醒时(通过 <a href="https://github.com/bwangelme/go-1.13/blob/6ece83485f77117120693f16ff516c768a31c02a/src/runtime/chan.go#L299">goready 函数</a>)，那么 G 就会尝试加入到 G2 所在 P 的 runnext 中，如果不成的话，会依次尝试 LRQ 和 GRQ。</p>
<h2 id="系统态的阻塞唤醒">系统态的阻塞/唤醒</h2>
<p>当 G 在 M 上执行系统调用后，它会阻塞，并将状态设置为 syscall 状态。M 也会进行阻塞。G 所绑定的 P 会和当前 G 和 M 解绑，寻找空闲 M，或创建新的 M，继续运行它队列中的其他 G .</p>
<p>当 M 执行完系统调用后，G 会重新寻找一个空闲的 P，进行运行，如果没有空闲的 P，那么它就会进入 GRQ。</p>
<h2 id="netpoller">NetPoller</h2>
<p>Go 将 epoll 进行了包装(使用了垂直触发)，会单独创建一个名为 NetPoller 的 M 异步处理网络IO，它不需要和 P 进行绑定。</p>
<p>当 G 执行网络 IO 的时候，G 会将当前 M 和 P 解绑，进入到 NetPoller 的 M 中，等待网络 IO 完成，这样即使执行网络 IO 的系统调用，也不会产生阻塞的 M.</p>
<p>当网络 IO 完成后，M 的 Schedule 函数，会通过 <a href="https://github.com/bwangelme/go-1.13/blob/6ece83485f77117120693f16ff516c768a31c02a/src/runtime/proc.go#L2210">findrunable函数</a> 取到这个 G，继续运行它。</p>
<h2 id="抢占式调度">抢占式调度</h2>
<p>当 G 执行的时间超过 10ms 时，一个名为 sysmon 的 M 就会向其发起抢占式调度。由于 Go 是用户态的代码，并没有时间片和硬中断的概念，所以 Go 抢占式调度的方式是运行方主动将自己挂起。</p>
<p>sysmon 如果要抢占某个 G 的执行权，那么就会设置它的抢占标记(<a href="https://github.com/bwangelme/go-1.13/blob/6ece83485f77117120693f16ff516c768a31c02a/src/runtime/runtime2.go#L396">g.stackguard0</a>)。G 在执行函数的时候(具体来说是 <a href="https://github.com/bwangelme/go-1.13/blob/6ece83485f77117120693f16ff516c768a31c02a/src/runtime/stack.go#L916">newstack函数</a>)，会检查抢占标记，如果这个标记已经被设置了，那么它就会通过 <a href="https://github.com/bwangelme/go-1.13/blob/6ece83485f77117120693f16ff516c768a31c02a/src/runtime/stack.go#L1036-L1038">Gosched</a> 的方式将自己放到 GRQ 中，重新等待执行。</p>
<h2 id="参考链接">参考链接</h2>
<ol>
<li><a href="https://wudaijun.com/2018/01/go-scheduler/">Go 调度模型</a></li>
<li><a href="https://www.youtube.com/watch?v=oFJL8S1dwsw">#64 深入浅出 Golang Runtime</a></li>
<li><a href="https://speakerdeck.com/retervision/go-runtime-scheduler">Go Runtime Scheduler</a></li>
<li><a href="https://colobu.com/2017/05/04/go-scheduler/">[译]Go 调度器: M, P 和 G</a></li>
<li><a href="https://studygolang.com/articles/16407">Golang并发原理及GPM调度策略（一）</a></li>
<li><a href="https://github.com/bwangelme/go-1.13/blob/master/src/runtime/runtime2.go">Go 代码 runtime/runtime2.go runtime/proc.go runtime/stack.go</a></li>
</ol>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-e9992c55d10cbbee93c95c796a5e0152">10.12 - Go 并发模式之发布订阅模型</h1>
    
	<blockquote>
<p>发布订阅模型的一个简易单机实现</p>
</blockquote>
<hr>
<h2 id="前言">前言</h2>
<p>这是我在阅读《Go 高级编程》中看到的一个实现发布订阅的简单例子，并不是真正的发布订阅服务器，仅供参考。</p>
<h2 id="pubsub-说明">Pub/Sub 说明</h2>
<p>发布订阅并发模型通常由两部分组成，<code>Publisher</code>和<code>Subcriber</code>，<code>Subscriber</code>可以通过<code>Topic</code>仅订阅自己关心的消息。</p>
<p>在本文的示例中，我们将<code>chan interface{}</code>定义为<code>Subscriber</code>，将一个过滤函数定义成<code>Topic</code>。
<code>Subscriber</code>和它的<code>Topic</code>一起注册到<code>Publisher</code>中。</p>
<p><code>Publisher</code>写消息的时候，会将数据发给它所有注册的订阅者，订阅者通过<code>Topic</code>过滤掉自己不感兴趣的消息，将感兴趣的消息写入到 channel 中。</p>
<h2 id="程序代码">程序代码</h2>
<ul>
<li>pubsub.go</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">pubsub</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;sync&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Subscriber</span> <span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">TopicFunc</span>  <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">v</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#204a87;font-weight:bold">bool</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Publisher</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// subscribers 是程序的核心，订阅者都会注册在这里，publisher发布消息的时候也会从这里开始
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">subscribers</span> <span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">Subscriber</span><span style="color:#000;font-weight:bold">]</span><span style="color:#000">TopicFunc</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">buffer</span>      <span style="color:#204a87;font-weight:bold">int</span>           <span style="color:#8f5902;font-style:italic">// 订阅者的缓冲区长度
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">timeout</span>     <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Duration</span> <span style="color:#8f5902;font-style:italic">// publisher 发送消息的超时时间
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// m 用来保护 subscribers
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// 当修改 subscribers 的时候(即新加订阅者或删除订阅者)使用写锁
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// 当向某个订阅者发送消息的时候(即向某个 Subscriber channel 中写入数据)，使用读锁
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">m</span> <span style="color:#000">sync</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RWMutex</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">NewPublisher</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">publishTimeout</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Duration</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">buffer</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Publisher</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">Publisher</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">buffer</span><span style="color:#000;font-weight:bold">:</span>      <span style="color:#000">buffer</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">timeout</span><span style="color:#000;font-weight:bold">:</span>     <span style="color:#000">publishTimeout</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">subscribers</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">Subscriber</span><span style="color:#000;font-weight:bold">]</span><span style="color:#000">TopicFunc</span><span style="color:#000;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Publisher</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Subscribe</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">Subscriber</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SubscribeTopic</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Publisher</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">SubscribeTopic</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">topic</span> <span style="color:#000">TopicFunc</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Subscriber</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ch</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Subscriber</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">buffer</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Lock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">subscribers</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">ch</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">topic</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Unlock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">ch</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//Evict 删除掉某个订阅者
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Publisher</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Evict</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">sub</span> <span style="color:#000">Subscriber</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Lock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Unlock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87">delete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">subscribers</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">sub</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">sub</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Publisher</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Publish</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">v</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RLock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">RUnlock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">wg</span> <span style="color:#000">sync</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WaitGroup</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 同时向所有订阅者写消息，订阅者利用 topic 过滤消息
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">sub</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">topic</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">subscribers</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">wg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">sendTopic</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">sub</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">topic</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">wg</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">wg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Wait</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">//Close 关闭 Publisher，删除所有订阅者
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Publisher</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Close</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Lock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Unlock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">sub</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">subscribers</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87">delete</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">subscribers</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">sub</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">sub</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Publisher</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">sendTopic</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">sub</span> <span style="color:#000">Subscriber</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">topic</span> <span style="color:#000">TopicFunc</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{},</span> <span style="color:#000">wg</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">sync</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WaitGroup</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">wg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Done</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">topic</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">topic</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">v</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">select</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">sub</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">v</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">After</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">timeout</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="相关测试代码">相关测试代码</h2>
<ul>
<li>pubsub_test.go</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">pubsub</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;runtime&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;strings&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;sync&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;sync/atomic&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;testing&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;github.com/stretchr/testify/assert&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">TestPubSub</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">testing</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">T</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">p</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">NewPublisher</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">100</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Millisecond</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Close</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// all 订阅者订阅所有消息
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">all</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Subscribe</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// golang 订阅者仅订阅包含 golang 的消息
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">golang</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SubscribeTopic</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">v</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#204a87;font-weight:bold">bool</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">s</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ok</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">v</span><span style="color:#000;font-weight:bold">.(</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">ok</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">strings</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Contains</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;golang&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#204a87;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Publish</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;hello, world!&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Publish</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;hello, golang!&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">wg</span> <span style="color:#000">sync</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WaitGroup</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">wg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">msg</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">all</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ok</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">msg</span><span style="color:#000;font-weight:bold">.(</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">assert</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">True</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ok</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">wg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Done</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">msg</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">golang</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">v</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ok</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">msg</span><span style="color:#000;font-weight:bold">.(</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">assert</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">True</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ok</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">assert</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">True</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">strings</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Contains</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">v</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;golang&#34;</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">wg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Done</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Close</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">wg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Wait</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="参考链接">参考链接</h2>
<ol>
<li><a href="https://chai2010.cn/advanced-go-programming-book/ch1-basic/ch1-06-goroutine.html">《Go 语言高级编程》&ndash; 常见的并发模式</a></li>
</ol>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-635fed7c7f961ced2f2b68e493f04ffb">10.13 - 关于线程同步操作的一道面试题</h1>
    
	<h2 id="前言">前言</h2>
<p>前两天在 V2EX 上发现了<a href="https://www.v2ex.com/t/547045">一道好玩的面试题</a>，兴致冲冲地写了答案出来，并发到了 <a href="https://www.v2ex.com/t/552620">V2EX</a> 上。结果发现自己实现的思路完全是错误的，遂把上篇文章推翻，重新写一篇。</p>
<h2 id="问题描述及解析">问题描述及解析</h2>
<h3 id="问题描述">问题描述</h3>
<blockquote>
<p>编写一个程序，开启 3 个线程A,B,C，这三个线程的输出分别为 A、B、C，每个线程将自己的输出在屏幕上打印 10 遍，要求输出的结果必须按顺序显示。如：ABCABCABC&hellip;.</p>
</blockquote>
<p>为了能够踩到更多的坑，我把上述问题升级了一下，线程数量和打印次数不是一个固定的值，具体如下:</p>
<blockquote>
<ul>
<li>编写一个程序，开启 N 个线程A,B,C&hellip;，这N个线程的输出分别为 A、B、C&hellip;，每个线程将自己的输出在屏幕上打印 M 遍，要求输出的结果必须按顺序显示。如：ABC&hellip;ABC&hellip;ABC&hellip;</li>
<li>其中 N &lt;= 1000, M &lt;= 1000</li>
</ul>
</blockquote>
<p><strong>注意</strong>:</p>
<ul>
<li>输出要在各自的线程中输出，不能在主线程中输出</li>
</ul>
<h3 id="题目解析">题目解析</h3>
<p>引用自 V友 <a href="https://www.v2ex.com/t/552620#r_7144214">@hjc4869</a></p>
<blockquote>
<p>这个问题本质上是在实现同步，而不是互斥。同步强调的是做事的先后顺序而不是多线程访问资源的冲突。虽然二者是包含关系并且可以互相实现，但是如果这里第一眼看到题就只是想到用 lock/mutex 而不是 semaphore/channel 去实现，那么显然是对后者的应用不熟，面试要挂的</p>
</blockquote>
<h2 id="利用-channel-做信号量的解法">利用 Channel 做信号量的解法</h2>
<p>使用信号量的话，这个题的解题思路就很简单:</p>
<ul>
<li>创建 N 个Goroutine 执行输出操作。</li>
<li>每个 Goroutine 的具体操作可用以下伪代码来表示:</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">def</span> <span style="color:#000">echo</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">threadNum</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Upstream</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Downstream</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#204a87;font-weight:bold">in</span> <span style="color:#204a87">range</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">M</span><span style="color:#000;font-weight:bold">):</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">wait</span> <span style="color:#000">Upstream</span>  <span style="color:#ce5c00;font-weight:bold">//</span> <span style="color:#000">等待上游的信号</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">threadNum</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">signal</span> <span style="color:#000">Downstream</span> <span style="color:#ce5c00;font-weight:bold">//</span> <span style="color:#000">给下游发送信号</span>
</span></span></code></pre></div><p>其中<code>Upstream</code> 和 <code>Downstream</code> 都表示信号量，<code>A</code> Goroutine 的 <code>Downstream</code> 是 <code>B</code> Goroutine 的 <code>Upstream</code>，依此类推，所有 Goroutine 会形成一个链式的关系。</p>
<p>可以使用下图来表示:</p>
<p><img src="https://passage-1253400711.cos-website.ap-beijing.myqcloud.com/2019-04-14-012629.png" alt=""></p>
<p>具体代码如下:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">N</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">5</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">M</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">wait</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">sig</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">firstWait</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">lastSig</span> <span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">wait</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">firstWait</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">wait</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#000">N</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">sig</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{})</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">lastSig</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">sig</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">echo</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">wait</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">sig</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">wait</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">sig</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#000">M</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">firstWait</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{}{}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#000">lastSig</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">firstWait</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ok</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#000">lastSig</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">ok</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatalln</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Channel not closed&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Out
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// 0: A
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// 1: B
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// 2: C
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// 3: D
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// 4: E
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// 0: A
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// 1: B
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// 2: C
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// 3: D
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// 4: E
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// 0: A
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// 1: B
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// 2: C
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// 3: D
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// 4: E
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// Close A
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// Close B
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// Close C
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// Close D
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// Close E
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">echo</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">threadNum</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">wait</span> <span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{},</span> <span style="color:#000">sig</span> <span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">threadName</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">string</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;A&#39;</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">threadNum</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">wait</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%d: %s\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">threadNum</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">threadName</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">sig</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{}{}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">sig</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 这句是我打印出来为了确认所有的 Goroutine 已经关闭了，实际不需要
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Close&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">threadName</span><span style="color:#000;font-weight:bold">)</span> 
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="fanin-的方式">FanIn 的方式</h2>
<blockquote>
<p>根据题目要求来看，在主线程中输出结果，有些不符合要求，但有个答案的实现很有意思，我就也放上来了</p>
</blockquote>
<p>经V友 @Mark3K 的<a href="https://www.v2ex.com/t/552620#r_7143193">补充</a>，还可以使用多个 channel 执行扇入(Fan In)操作，避免使用锁。</p>
<p>首先说一下扇入的定义，Go blog 中是这样描述的：</p>
<blockquote>
<p>A function can read from multiple inputs and proceed until all are closed by multiplexing the input channels onto a single channel that&rsquo;s closed when all the inputs are closed. This is called fan-in.</p>
</blockquote>
<p>通过将多个输入 channel 多路复用到单个处理 channel 的方式，一个函数能够从多个输入 channel 中读取数据并处理。当所有的输出 channel 都关闭的时候，单个处理 channel 也会关闭。这就叫做扇入。</p>
<p>在维基百科中描述的逻辑门的扇入如下(大家也可以参考这个来理解 Go 中的扇入):</p>
<blockquote>
<p>Fan-in is the number of inputs a logic gate can handle. For instance the fan-in for the AND gate shown in the figure is 3. Physical logic gates with a large fan-in tend to be slower than those with a small fan-in. This is because the complexity of the input circuitry increases the input capacitance of the device. Using logic gates with higher fan-in will help reducing the depth of a logic circuit.</p>
</blockquote>
<p><img src="https://passage-1253400711.cos-website.ap-beijing.myqcloud.com/2019-04-07-040937.jpg" alt=""></p>
<blockquote>
<p>逻辑门中的扇入定义: 一个逻辑门将多个输入处理成一个输出，它能够处理的输入数量就叫做扇入。</p>
</blockquote>
<p>理解了扇入的概念后，上述问题的答案也呼之欲出了。我们可以为<code>A,B,C,...</code>这N个 Goroutine 创建N个 channel。然后通过一个 FanIn 函数将N个 channel 的输出输入到一个 channel 中。具体代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">N</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">5</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">M</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">5</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">gen</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">v</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">times</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ch</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#204a87">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ch</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#000">times</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">ch</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">v</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">ch</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">fanIn</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">times</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">inputs</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ch</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#204a87">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ch</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#000">times</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">input</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">inputs</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">v</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#000">input</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">ch</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">v</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">ch</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">times</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">M</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">inputs</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">([]</span><span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">N</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#000">N</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">threadName</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">string</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;A&#39;</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">i</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">inputs</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">append</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">inputs</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">gen</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">threadName</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">times</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">char</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">fanIn</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">times</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">inputs</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">char</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="使用锁的解决方案">使用锁的解决方案</h2>
<p>使用锁并不是这个问题的正确解决思路，<strong>甚至会将人的思维带入歧途</strong>，所以不推荐大家使用锁解决。</p>
<p>这是我之前写的旧文，<a href="/2019/03/26/go-lock/">线程同步操作面试题使用锁的解法</a>，个人觉得某些地方还有一些参考价值，请大家酌情阅读。</p>
<h2 id="使用-atomicinteger-的解决方案">使用 AtomicInteger 的解决方案</h2>
<p>使用<code>AtomicInteger</code>并不是一种好的解决方案(因为这个解法让 CPU 持续空转)，但是通过这个解法我们可以了解到 Go 调度器阻塞的一个陷阱，所以也把这种解法放了上来，感兴趣的朋友可以查看我的另一篇文章 <a href="/2019/04/10/go-scheduler-pitfall/">Go 调度器的一个无法执行陷阱</a>。</p>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-e7414abf063a165b8718b37f17cb4f2f">10.14 - Go 调度器的一个无法执行陷阱</h1>
    
	<blockquote>
<p><strong>注意</strong>: 这篇文章的答案可以有正确的结果，但解题思路是不对的，正确的思路请参考 <a href="/2019/04/13/go-sync-channel/">关于线程同步操作的一道面试题</a></p>
</blockquote>
<h2 id="2020年03月16日补充说明">2020年03月16日补充说明</h2>
<p>Go 1.14 加入了基于信号的抢占式调度，这个问题在 go 1.14 上已经复现不了了。参考 <a href="http://xiaorui.cc/archives/6535">go1.14基于信号的抢占式调度实现原理</a></p>
<h2 id="背景说明">背景说明</h2>
<p>前两天遇到了这样一道题目:</p>
<blockquote>
<p>编写一个程序，开启 3 个线程A,B,C，这三个线程的输出分别为 A、B、C，每个线程将自己的 输出在屏幕上打印 10 遍，要求输出的结果必须按顺序显示。如：ABCABCABC&hellip;.</p>
</blockquote>
<p><strong>注意</strong>:</p>
<ul>
<li>输出要在各自的线程中输出，不能在主线程中输出</li>
</ul>
<h2 id="错误答案">错误答案</h2>
<p>当时想到一种思路是使用 Go <code>atomic</code> 包中提供的原子操作来完成上述功能。
即每个<code>Goroutine</code>原子性地获得<code>i</code>的值，如果符合<code>i % 3 == threadNum</code>的条件，则执行操作，否则作自旋。代码如下：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;sync/atomic&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">end</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">i</span>   <span style="color:#204a87;font-weight:bold">int32</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">threadPrint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">threadNum</span> <span style="color:#204a87;font-weight:bold">int32</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">threadName</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">v</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">atomic</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">LoadInt32</span><span style="color:#000;font-weight:bold">((</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#204a87;font-weight:bold">int32</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">v</span> <span style="color:#ce5c00;font-weight:bold">&gt;=</span> <span style="color:#0000cf;font-weight:bold">30</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">break</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">v</span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#0000cf;font-weight:bold">3</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">threadNum</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%d: %s\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">i</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">threadName</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">atomic</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddInt32</span><span style="color:#000;font-weight:bold">((</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#204a87;font-weight:bold">int32</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#204a87">int32</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">end</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{}{}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">names</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">{</span><span style="color:#4e9a06">&#34;A&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;B&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;C&#34;</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">idx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">name</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">names</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">threadPrint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">int32</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">idx</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">names</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#000">end</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>这个程序当时跑的是没有问题的。我把答案发到 V2EX 论坛上之后， V友 @whoisghost 指出了<a href="https://www.v2ex.com/t/552620#r_7143228">问题</a></p>
<blockquote>
<p>把 names 再追加 “ D ”, &ldquo;E&rdquo;, 把 3 =&gt; 5, 30 =&gt; 50, 还能正常运行吗？</p>
</blockquote>
<p>我照着它的说明试了一下，发现程序会阻塞起来。后来我去查了一下资料，才了解到 Go 的调度器中还有一个隐藏的陷阱。在了解这个陷阱之前，我们需要先了解一下操作系统的线程调度器和 Go 的调度器。</p>
<h2 id="操作系统线程调度器">操作系统线程调度器</h2>
<p>操作系统线程调度器的执行逻辑如下:</p>
<ul>
<li>操作系统的调度器维护了一组线程的信息，这些线程分别处于<code>running</code>, <code>runnable</code>, <code>non-runnable</code>的状态。</li>
<li>当一个线程在一个 CPU 核心上运行超过一个时间片以后，它就会被系统时钟中断给中断掉。</li>
<li>被中断的线程会保存它的上下文信息，并执行中断处理函数。</li>
<li>中断处理函数会将执行权转交给操作系统的调度器，操作系统的调度器会调取其他的线程来这个 CPU 核心上运行。</li>
</ul>
<h2 id="go-调度器">Go 调度器</h2>
<p>Go 语言中使用<code>Goroutine</code>来实现并发，<code>Goroutine</code>类似于线程，但它又是非常轻量的。一个创造成千上万个<code>Goroutine</code>的程序很常见，但是创造成千上万个线程的程序却很少见。</p>
<p><code>Goroutine</code>是在用户层实现的，当 Go 程序启动的时候，Go 的运行时会创建<code>GOMAXPROCS</code>个系统级线程，然后<code>Goroutine</code>就被它在这<code>GOMAXPROCS</code>个系统级线程上调度。</p>
<p>Go 语言实现了一个协同式的，部分中断调度器(Golang implements a co-operative partially preemptive scheduler.)。它没有基于时钟中断来实现调度，但调度器可以在系统级线程上并行地运行多个 Goroutine。</p>
<p>在<code>runtime</code>提供的构造体，库，系统调用函数中，Go 添加了钩子函数，这些钩子函数能够协同式地启动 Go 的调度器。
Go 通过这种方式来将执行权切换到 Go 调度器，从而避免通过时钟中断来将执行权切换到 Go 调度器。<code>runtime</code>提供的这些函数也成为了进入 Go 调度器的入口。
但是如果我们在<code>Goroutine</code>中没有调用 <code>runtime</code> 的任何函数会发生什么情况呢？</p>
<h2 id="代码错误原因简析">代码错误原因简析</h2>
<p>在上述代码中，我们启动了5个 Goroutine，在我的电脑上<code>GOMAXPROCS</code> 是4。
也就是说有4个<code>Goroutine</code>会各自占用一个系统级线程进行自旋操作，但因为它们没有调用<code>runtime</code>中的函数，所以它们并不会主动将执行权交给 Go 调度器。
这样始终有一个<code>Goroutine</code>无法获得执行的机会，整个程序也就被阻塞住了。</p>
<h2 id="解决方案">解决方案</h2>
<p>在生产环境中，我们遇到上述错误的机会很少。因为我们的程序基本都会执行<code>runtime</code>中提供的一些功能，例如<code>channel</code>，<code>系统调用</code>, <code>fmt.Sprint</code>, <code>Mutex</code>, <code>time.Sleep</code>等。</p>
<p>例如如果我们在上述代码第加入一句<code>time.Sleep(0)</code>，程序就不会阻塞了，因为<code>time.Sleep</code>中包含的钩子函数启动了 Go 调度器，第五个 goroutine 有了执行的机会。</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">v</span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#0000cf;font-weight:bold">3</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">threadNum</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%d: %s\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">i</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">threadName</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">atomic</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddInt32</span><span style="color:#000;font-weight:bold">((</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#204a87;font-weight:bold">int32</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#204a87">int32</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sleep</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic">// 加入这条语句
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#204a87;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span></span></span></code></pre></td></tr></table>
</div>
</div>
<p>如果我们在生产环境中遇到了这个问题的话，正确的做法应该是加入一句 <a href="https://golang.org/pkg/runtime/#Gosched">runtime.Gosched()</a>，如下所示:</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">v</span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#0000cf;font-weight:bold">3</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">threadNum</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%d: %s\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">i</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">threadName</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">atomic</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">AddInt32</span><span style="color:#000;font-weight:bold">((</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#204a87;font-weight:bold">int32</span><span style="color:#000;font-weight:bold">)(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#204a87">int32</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">runtime</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Gosched</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#8f5902;font-style:italic">// 加入这条语句
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#204a87;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span></span></span></code></pre></td></tr></table>
</div>
</div>
<p>这样当<code>Goroutine</code>自旋的时候，就会主动地去启动 Go 调度器，让其他<code>Goroutine</code>获得执行的机会。</p>
<h2 id="参考链接">参考链接</h2>
<ul>
<li><a href="http://www.sarathlakshman.com/2016/06/15/pitfall-of-golang-scheduler">A pitfall of golang scheduler</a></li>
</ul>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-fbbcf89e72ac3f247786060b50fa9d08">10.15 - Go Panic 的触发及恢复过程</h1>
    
	<blockquote>
<ul>
<li>Panic 过程</li>
<li>recover 函数</li>
<li>defer 函数</li>
</ul>
</blockquote>
<h2 id="panic-过程">Panic 过程</h2>
<ul>
<li>当代码触发<code>panic</code>的时候，<code>panic详情</code>就会被初始化。随后程序的控制权从最底端的调用函数一级一级向上传递到最顶端的调用函数。</li>
<li>到了最顶端调用函数后，控制权会被移交给 Go 语言的运行时系统，Go 语言的运行时系统打印出<code>panic详情</code>，并结束程序的运行。</li>
<li>在控制权传递的过程中<code>panic详情</code>会被逐渐积累起来。所以最后程序输出<code>panic详情</code>的时候，会从最底端的函数一直输出到最顶端的函数。我们查看调用栈的信息的时候，应该从底部<code>exit status 2</code>这一行向上看。</li>
</ul>
<h2 id="recover-函数">recover 函数</h2>
<ul>
<li>因为<code>panic</code>发生的时候，<code>panic</code>函数后面的语句都不会执行了，所以<code>recover</code>函数不能放在<code>panic</code>语句后面执行，而要放在<code>defer</code>函数中执行。</li>
</ul>
<h2 id="defer-函数">defer 函数</h2>
<ul>
<li>defer 函数的执行顺序和它的定义顺序是完全相反的</li>
<li>defer 语句每次执行的时候，Go 会把它携带的 defer 函数及其参数值存储到另一个栈中，这个栈是遵循 FILO(First Input Last Output)原则的。</li>
<li>defer 函数中也可以引发<code>panic</code>，这样可以把<code>recover</code>捕获的<code>panic</code>包装一下再抛出去。</li>
</ul>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-4b954ae7a79512193186d57a0ec102ff">10.16 - 线程同步操作面试题使用锁的解法</h1>
    
	<blockquote>
<p><strong>注意</strong>: 这篇文章的思路是不正确的，正确的思路请参考 <a href="/2019/04/13/go-sync-channel/">关于线程同步操作的一道面试题</a></p>
</blockquote>
<h2 id="前言">前言</h2>
<p>前两天在 V2ex 上看到了一篇博文，<a href="http://samray.me/%E4%B8%80%E6%9D%A1%E7%BB%8F%E5%85%B8%E9%9D%A2%E8%AF%95%E9%A2%98%E5%BC%95%E5%8F%91%E7%9A%84%E6%80%9D%E8%80%83">《一条经典面试题引发的思考》</a>，感觉很有意思，我就用 Go 把它的答案实现了一遍。</p>
<h2 id="问题描述及一个错误解法">问题描述及一个错误解法</h2>
<p>问题如下:</p>
<blockquote>
<p>编写一个程序，开启 3 个线程A,B,C，这三个线程的输出分别为 A、B、C，每个线程将自己的 输出在屏幕上打印 10 遍，要求输出的结果必须按顺序显示。如：ABCABCABC&hellip;.</p>
</blockquote>
<p>一个错误解法如下:</p>
<div class="highlight"><div style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="background-color:#dfdfdf"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span></span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="background-color:#dfdfdf"><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span></span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">68
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;display:grid;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;sync&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">mu</span> <span style="color:#000">sync</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Mutex</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">index</span> <span style="color:#204a87;font-weight:bold">int</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">endSignal</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{})</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">echoRoutine</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">routineIndex</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">routineName</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex; background-color:#dfdfdf"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">index</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">30</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">mu</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Lock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">index</span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#0000cf;font-weight:bold">3</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">routineIndex</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">index</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">routineName</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex; background-color:#dfdfdf"><span>			<span style="color:#000">index</span><span style="color:#ce5c00;font-weight:bold">++</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">mu</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Unlock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">endSignal</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{}{}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">routineNames</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">{</span><span style="color:#4e9a06">&#34;A&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;B&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;C&#34;</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">idx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">name</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">routineNames</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">echoRoutine</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">idx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">routineNames</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#000">endSignal</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">//Output:
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//0 A
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//1 B
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//2 C
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//3 A
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//4 B
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//5 C
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//6 A
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//7 B
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//8 C
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//9 A
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//10 B
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//11 C
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//12 A
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//13 B
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//14 C
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//15 A
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//16 B
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//17 C
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//18 A
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//19 B
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//20 C
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//21 A
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//22 B
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//23 C
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//24 A
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//25 B
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//26 C
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//27 A
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//28 B
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//29 C
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//30 A
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">//31 B
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span></span></span></code></pre></td></tr></table>
</div>
</div>
<p>从上面的输出可以看到，程序还额外输出了两次 A 和 B。首先说结论，这是因为检查条件<code>index &lt; 30</code> <strong>没有加锁</strong>。为了理解这个错误，首先我们需要了解一下 Go 的内存模型。</p>
<h2 id="go-语言的内存模型">Go 语言的内存模型</h2>
<p>首先说什么是 Go 的内存模型，在官方文档中是这样定义的:</p>
<blockquote>
<p>The Go memory model specifies the conditions under which reads of a variable in one goroutine can be guaranteed to observe values produced by writes to the same variable in a different goroutine.</p>
</blockquote>
<p>Go 语言的内存模型规定了一个 Goroutine 可以看见另外一个 Goroutine 修改同一个变量的值的条件，这类似于 Java 内存模型中 <strong>内存可见性</strong> 问题。</p>
<h3 id="happens-before-原则">Happens Before 原则</h3>
<p>在 Go 语言中，编译器和处理器会对执行的指令进行重排序。Go 语言会保证的是，在单个 Goroutine 内，重排序后的执行效果和未进行重排序(即在代码中定义的执行顺序)的执行效果是一样。但是在多个 Goroutine 的运行环境下，由于重排序的原因，一个 Goroutine 观察到的执行顺序可能和另外一个 Goroutine 观察到的不一样。例如一个 Goroutine 执行<code>a = 1; b = 2</code>，另一个 Goroutine 可能会在<code>a</code>被赋值之前先观察到<code>b</code>被赋值了。</p>
<p>为了规范读和写的操作，Go 定义了 <strong>happens before</strong> 原则。对于变量读写操作，我们可以将其称作是事件。事件之间的顺序可以定义为三种，E1 发生在 E2 之前，E1 发生在 E2 之后，E1 和 E2同时发生。</p>
<p>在单个 Goroutine 内，<strong>happens before</strong> 顺序就是程序执行的顺序，如果下面两个条件都被满足的话，变量<code>v</code>的读取事件<code>r</code>，可以观察到变量<code>v</code>的写入事件<code>w</code>。</p>
<ol>
<li><code>r</code>没有在<code>w</code>之前发生。</li>
<li>在<code>w</code>之后，<code>r</code>之前，没有另外一个变量<code>v</code>的写入事件<code>w'</code>发生。</li>
</ol>
<p>总的来说，在单个 Goroutine 的环境下，读事件<code>r</code>会观察到最近的一个写事件<code>w</code>。</p>
<p>在多个 Goroutine 的运行环境下，如果需要让<code>v</code>的读取事件<code>r</code>观察到其写入事件<code>w</code>。需要满足更严格的条件：</p>
<ol>
<li><code>w</code>发生在<code>r</code>之前</li>
<li>任何针对共享变量<code>v</code>的写入事件都发生在<code>w</code>之前或者<code>r</code>之后。</li>
</ol>
<p>因为在多个 Goroutine 的运行环境下，读写事件可能并行地发生，所以第一点更严格了一些，要求<code>w</code>必须在<code>r</code>之前发生，两者不能同时发生，且它们之间没有其他的写事件<code>w'</code>。
因此在多个 Goroutine 访问一个共享变量<code>v</code>的时候，我们必须使用<a href="https://golang.org/ref/mem#tmp_3">同步事件</a>去建立一个 <strong>happens before</strong> 条件来让读事件观察到目标写事件。</p>
<p>此外，还需要注意的是：</p>
<ol>
<li>在变量<code>v</code>发生写事件之前，它被初始化成对应类型的零值。</li>
<li>大于一个机器字的变量的读写事件，会表现成 <strong>未指定顺序</strong> 的多次机器字大小的读写操作。</li>
</ol>
<h2 id="正确答案-v1">正确答案 V1</h2>
<p>了解了 Go 内存模型中的 <strong>Happens Before</strong> 原则之后，我们接着再来分析上述的错误代码。</p>
<ul>
<li>在 B Goroutine 输出完28之后，A, B, C 都会再循环了一次。</li>
<li>接着会由 C 先来执行输出操作。由于 C 执行第17行<code>i++</code>的写操作和 A 和 B 执行第13行<code>index &lt; 30</code>读操作是并行发生的，所以 A 和 B 可能读取到的值是29并进入循环。</li>
<li>因为此时 A 和 B 都已经进入循环了，所以会出现多输出一次的情况。</li>
<li>A 和 B 进入循环后，由于锁的存在，它们能够获取到正确的<code>index</code>的值，所以最后多输出的结果是30和31。</li>
</ul>
<p>理解了这个错误之后，我们可以把代码稍微改一下，将<code>index &lt; 30</code>这个比较操作也置于锁的保护中，就能够得到正确的结果了。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;sync&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">i</span> <span style="color:#204a87;font-weight:bold">int</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">mu</span> <span style="color:#000">sync</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Mutex</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">endSignal</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{})</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">threadPrint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">threadNum</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">threadName</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">mu</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Lock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&gt;=</span> <span style="color:#0000cf;font-weight:bold">30</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">mu</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Unlock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">break</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#0000cf;font-weight:bold">3</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">threadNum</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%d: %s\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">i</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">threadName</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">mu</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Unlock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">endSignal</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{}{}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">names</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">{</span><span style="color:#4e9a06">&#34;A&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;B&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;C&#34;</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">idx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">name</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">names</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">threadPrint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">idx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">names</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#000">endSignal</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="正确答案-v2----公平锁">正确答案 V2 &ndash; 公平锁</h2>
<p>上述代码是得到的结果是正确的，但是还存在一些问题。我们想要的执行顺讯是有序的，
但每次解锁的时候，都是 A, B, C 三个 Goroutine 上去抢锁资源。有时候某个 Goroutine 抢到了锁资源，但是其并不符合执行要求(<code>i%3 != threadNum</code>)。它就会将锁释放，然后让大家重新再来抢。</p>
<p>这样的争抢索锁资源造成了时间上的浪费，执行了一些不必要的操作。</p>
<p>为了避免这些浪费，我们可以参考 Java 中的公平锁，让解锁的顺序和上锁的顺序匹配，每次只有一个 Goroutine 获得锁资源，大家不必每次都去争抢锁资源。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;sync&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">const</span> <span style="color:#000">endNum</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">30</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">FairLock</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">mu</span>        <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">sync</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Mutex</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">cond</span>      <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">sync</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Cond</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">isHold</span>    <span style="color:#204a87;font-weight:bold">bool</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">holdCount</span> <span style="color:#204a87;font-weight:bold">int</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">NewFairLock</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000">sync</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Locker</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">mu</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">new</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">sync</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Mutex</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">cond</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">sync</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewCond</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">mu</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">FairLock</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">holdCount</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">isHold</span><span style="color:#000;font-weight:bold">:</span>    <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">mu</span><span style="color:#000;font-weight:bold">:</span>        <span style="color:#000">mu</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">cond</span><span style="color:#000;font-weight:bold">:</span>      <span style="color:#000">cond</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">fl</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">FairLock</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Lock</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">mu</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Lock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">fl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">mu</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Unlock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">fl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">isHold</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">holdCount</span><span style="color:#ce5c00;font-weight:bold">++</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">isHold</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">holdCount</span><span style="color:#ce5c00;font-weight:bold">++</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">fl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">isHold</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cond</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Wait</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">isHold</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">fl</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">FairLock</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Unlock</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">mu</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Lock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">defer</span> <span style="color:#000">fl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">mu</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Unlock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">fl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">isHold</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatal</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;unlock of UnLocked mutex&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">fl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">holdCount</span> <span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">cond</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Signal</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">isHold</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fl</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">holdCount</span><span style="color:#ce5c00;font-weight:bold">--</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">end</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{})</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">i</span>   <span style="color:#204a87;font-weight:bold">int</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">threadPrint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">threadNum</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">threadName</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">locker</span> <span style="color:#000">sync</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Locker</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#000">endNum</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">locker</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Lock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&gt;=</span> <span style="color:#000">endNum</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">locker</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Unlock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">%</span><span style="color:#0000cf;font-weight:bold">3</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">threadNum</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">locker</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Unlock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%d: %s\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">i</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">threadName</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">locker</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Unlock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">end</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#204a87;font-weight:bold">struct</span><span style="color:#000;font-weight:bold">{}{}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">mu</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">NewFairLock</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">names</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">{</span><span style="color:#4e9a06">&#34;A&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;B&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;C&#34;</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">idx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">name</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">names</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">threadPrint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">idx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">mu</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">_</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">range</span> <span style="color:#000">names</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#000">end</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><strong>注意</strong>： 由于可见性的原因，需要在<code>70~72</code>行上锁之后加一个判断，保证<code>i</code>的值是最新的值。</p>
<p>经 V友 @hheedat 的<a href="https://www.v2ex.com/t/552620#r_7183057">提醒</a>，<code>cond.Wait</code>操作需要放在 <code>for</code> 循环中，因为阻塞的 Goroutine 可能会被误唤醒。</p>
<p>Go 的文档中也说明 <a href="https://golang.org/pkg/sync/#Cond.Wait"><code>Wait</code>需要放在<code>for</code>循环中</a>。因为在 <code>Wait</code> 的过程中，<code>cond</code> 相关的锁并没有上锁，所以<code>Wait</code>唤醒后，相关的条件不一定是正确的。</p>
<h2 id="公平锁的一个错误尝试">公平锁的一个错误尝试</h2>
<p>在之前的代码中，我尝试利用公平锁上锁和解锁的有序性，来让3个 Goroutine 顺序执行并按顺序输出<code>A,B,C</code>。后经V友 <a href="https://www.v2ex.com/t/552620#r_7173035">hheedat</a> 指出了错误，发现这样的想法是不可行的。因为以下两点是冲突的：</p>
<ol>
<li>让 Goroutine 在无法获得锁资源的时候阻塞</li>
<li>让 Goroutine 按照 <code>A,B,C</code> 的顺序上锁</li>
</ol>
<ul>
<li>因为 Goroutine 的启动时间和接收到信号量的时间都是无序的，所以正常情况下无法让 Goroutine 按顺序上锁。</li>
<li>我尝试让 Goroutine 上锁之后使用一个信号通知<code>main</code>Goroutine，让<code>main</code>Goroutine 再去通知下一个 Goroutine 去上锁。</li>
<li>但由于 Goroutine 上锁之后是阻塞的，所以使用信号通知<code>main</code>Goroutine 的方案也是不可行的。</li>
</ul>
<p>或许还有其他方案，但我认为这样思考的思路是不对的，<strong>这个同步问题本来就应该使用信号量来解决，使用锁并尝试按顺序上锁只是在歧路上越走越远</strong>。</p>
<h2 id="参考链接">参考链接</h2>
<ul>
<li><a href="http://samray.me/%E4%B8%80%E6%9D%A1%E7%BB%8F%E5%85%B8%E9%9D%A2%E8%AF%95%E9%A2%98%E5%BC%95%E5%8F%91%E7%9A%84%E6%80%9D%E8%80%83">一条经典面试题引发的思考</a></li>
<li><a href="https://en.wikipedia.org/wiki/Memory_barrier#Multithreaded_programming_and_memory_visibility">Memory barrier &ndash; Wikipedia</a></li>
<li><a href="https://www.zhihu.com/question/36964449/answer/69790971">什么是Java中的公平锁？</a></li>
<li><a href="https://golang.org/ref/mem#tmp_2">The Go Memory Model</a></li>
<li><a href="http://ifeve.com/golang-mem/">GoLang内存模型</a></li>
<li><a href="https://blog.csdn.net/u012233832/article/details/82501839">go reentrant lock(可重入锁) 简单实现</a></li>
<li><a href="https://blog.golang.org/pipelines">Go Concurrency Patterns: Pipelines and cancellation</a></li>
<li><a href="https://en.wikipedia.org/wiki/Fan-in">Fan-In Wikipedia</a></li>
<li><a href="https://www.v2ex.com/t/552620#r_7143193">V友 Mark3K的评论</a></li>
<li><a href="https://www.v2ex.com/t/552620#r_7173035">一条面试题引发的思考 Go 版本</a></li>
</ul>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-770a44637da1a99d5af0d32fd0c958e9">10.17 - Go 的测试</h1>
    
	<blockquote>
<p>主要讲了 Go 相关的测试</p>
</blockquote>
<h2 id="测试的基本规则和流程">测试的基本规则和流程</h2>
<p>单元测试分为三类：</p>
<ol>
<li>功能测试(test)</li>
<li>基准测试(benchmark)</li>
<li>示例测试(example)</li>
</ol>
<h2 id="go-test流程"><code>go test</code>流程</h2>
<ol>
<li>做准备工作（判断给出的代码包和源码文件是否有效，判断给予的标记是否合法）</li>
<li>针对每个被测试的代码包，依次地进行构建、执行包中符合要求的测试函数，清理临时文件，打印测试结果。（为了加快测试速度，go test 会并发地对多个被测代码包进行功能测试，在最后打印结果时，它会依照我们给定的顺序逐个进行）</li>
<li>为了不影响性能测试结果，性能测试都是串行地运行的。</li>
</ol>
<h2 id="功能测试">功能测试</h2>
<h3 id="测试缓存">测试缓存</h3>
<ul>
<li>go 会将构建和测试的结果缓存起来，缓存目录可以通过<code>go env GOCACHE</code>命令看到</li>
<li><code>go clean -cache</code>命令可以删除所有缓存，<code>go clean -testcache</code>可以删除所有的测试结果缓存</li>
<li>通过设置环境变量<code>GODEBUG=&quot;gocacheverify=1&quot;</code>将会导致 go 命令绕过任何的缓存数据，而真正地执行操作，并重新生成所有结果，然后再去检查新的结果与现在的缓存数据是否一致</li>
<li>我们不需要在意缓存数据的存在，因为它们肯定不会妨碍<code>go test</code>命令打印正确的测试结果</li>
<li>对于失败测试的结果，<code>go test</code>命令并不会进行缓存</li>
</ul>
<h3 id="测试日志">测试日志</h3>
<ul>
<li><code>t.Log</code>和<code>t.Logf</code>方法用来打印常规的测试日志，只有测试失败时，这类日志才会被打印。如果测试成功了，它们不会被打印。如果想在测试成功时看到这类日志，可以在<code>go test</code>命令上加上<code>-v</code>选项。</li>
</ul>
<h3 id="测试方法">测试方法</h3>
<ul>
<li><code>t.Fail</code>方法会让当前测试失败，但不会立刻终止当前测试。</li>
<li><code>t.FailNow</code>方法会让当前测试失败，且立刻终止当前测试（注意，是终止当前测试，并不是终止整个测试程序，其他测试还会继续正常运行）。</li>
</ul>
<h2 id="性能测试">性能测试</h2>
<h3 id="执行性能测试">执行性能测试</h3>
<blockquote>
<p><code>go test -bench=. -run='^$' puzzlers/article20/q3</code></p>
</blockquote>
<ul>
<li><code>-bench=.</code>表示执行任意名称的性能测试函数</li>
<li><code>-run='^$'</code>表示执行空名称的功能测试函数，即不执行任何功能测试函数。（不加<code>--run=^$'</code>的话也会执行此测试包中的功能测试函数）</li>
<li><code>-bench=</code>和<code>-run</code>都必须使用正则表达式</li>
</ul>
<h3 id="性能测试结果">性能测试结果</h3>
<pre tabindex="0"><code>&gt;&gt;&gt; go test -v -bench=. -run=&#39;^$&#39; puzzlers/article20/q3                                                               20:02:05 (03-03)
goos: darwin
goarch: amd64
pkg: puzzlers/article20/q3
BenchmarkGetPrimes-4      300000              5571 ns/op
PASS
ok      puzzlers/article20/q3   1.739s
</code></pre><ul>
<li>重点描述倒数第三行，<code>BenchmarkGetPrimes-4</code>被称为单个性能测试的名称，它表示执行了性能测试<code>BenchmarkGetPrimes</code>，并且当时所用的最大 P 的数量为4。
<ul>
<li>最大 P 的数量相当于可以同时运行 Goroutine 的逻辑 CPU 的最大个数，这里的逻辑 CPU 也可以被称为 CPU 核心，但它并不等同于计算机中真正的 CPU，只是 Go 语言运行时系统内部的一个概念，代表着它同时运行 Goroutine 的能力。</li>
<li>可以在测试时通过<code>-cpu 8</code>选项来调整最大 P 个数，它可以模拟被测程序在计算能力不同的计算机中的性能表现</li>
</ul>
</li>
<li><code>300000</code>表示被测试函数的执行次数</li>
<li><code>5571 ns/op</code>表示执行被测试函数的平均执行时间是 5571 纳秒。</li>
</ul>
<p><img src="https://static001.geekbang.org/resource/image/78/69/78d4c73a9aa9d48b59d3fd304d4b2069.png" alt=""></p>
<h3 id="性能测试过程">性能测试过程</h3>
<ul>
<li>
<p>在测试时间上限不变的情况下，<code>go test</code>会不断调整<code>b.N</code>的值，直到找到被测程序的最大执行次数。这样的过程称为 <strong>对性能测试函数的一次探索式执行</strong> 。</p>
</li>
<li>
<p>测试函数的实际执行次数</p>
</li>
</ul>
<p><img src="https://passage-1253400711.cos-website.ap-beijing.myqcloud.com/2019-03-06-235218.jpg" alt=""></p>
<h3 id="性能测试的计时器">性能测试的计时器</h3>
<ul>
<li><code>b.StopTimer</code>和<code>b.StartTimer</code>可以停止和启动计时器，将某些代码的执行过程不计入总的执行时间中</li>
<li><code>b.ResetTimer</code>用于去除在调用它之前的那些代码的执行时间</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">q3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;testing&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">BenchmarkGetPrimes</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">b</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">testing</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">B</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 你可以注释或者还原下面这四行代码中的第一行和第四行，
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// 并观察测试结果的不同。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">b</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StopTimer</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sleep</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Millisecond</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#0000cf;font-weight:bold">500</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic">// 模拟某个耗时但与被测程序关系不大的操作。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">max</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#0000cf;font-weight:bold">10000</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">b</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">StartTimer</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#000">b</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">N</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">GetPrimes</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">max</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>&gt;&gt;&gt; go <span style="color:#204a87">test</span> -count<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">2</span> -bench<span style="color:#ce5c00;font-weight:bold">=</span>. -v puzzlers/article21/q3                                                                08:10:39 <span style="color:#ce5c00;font-weight:bold">(</span>03-07<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>goos: darwin
</span></span><span style="display:flex;"><span>goarch: amd64
</span></span><span style="display:flex;"><span>pkg: puzzlers/article21/q3
</span></span><span style="display:flex;"><span>BenchmarkGetPrimes-4       <span style="color:#0000cf;font-weight:bold">20000</span>             <span style="color:#0000cf;font-weight:bold">67431</span> ns/op
</span></span><span style="display:flex;"><span>BenchmarkGetPrimes-4       <span style="color:#0000cf;font-weight:bold">20000</span>             <span style="color:#0000cf;font-weight:bold">68273</span> ns/op
</span></span><span style="display:flex;"><span>PASS
</span></span><span style="display:flex;"><span>ok      puzzlers/article21/q3   8.069s
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; go <span style="color:#204a87">test</span> -count<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#0000cf;font-weight:bold">2</span> -bench<span style="color:#ce5c00;font-weight:bold">=</span>. -v puzzlers/article21/q3                                                                08:11:00 <span style="color:#ce5c00;font-weight:bold">(</span>03-07<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>goos: darwin
</span></span><span style="display:flex;"><span>goarch: amd64
</span></span><span style="display:flex;"><span>pkg: puzzlers/article21/q3
</span></span><span style="display:flex;"><span>BenchmarkGetPrimes-4       <span style="color:#0000cf;font-weight:bold">10000</span>            <span style="color:#0000cf;font-weight:bold">113835</span> ns/op
</span></span><span style="display:flex;"><span>BenchmarkGetPrimes-4       <span style="color:#0000cf;font-weight:bold">10000</span>            <span style="color:#0000cf;font-weight:bold">115399</span> ns/op
</span></span><span style="display:flex;"><span>PASS
</span></span><span style="display:flex;"><span>ok      puzzlers/article21/q3   11.993s
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 注释掉计时器相关的代码后，程序的平均执行时间增加了500毫秒左右</span>
</span></span></code></pre></div><h2 id="思考题">思考题</h2>
<h3 id="-benchmem标记和-benchtime标记的作用分别是什么"><code>-benchmem</code>标记和<code>-benchtime</code>标记的作用分别是什么？</h3>
<p><code>-benchmem</code> 输出基准测试的内存分配统计信息。
<code>-benchtime</code> 用于指定基准测试的探索式测试执行时间上限</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ go <span style="color:#204a87">test</span> -bench<span style="color:#ce5c00;font-weight:bold">=</span>. word
</span></span><span style="display:flex;"><span>goos: linux
</span></span><span style="display:flex;"><span>goarch: amd64
</span></span><span style="display:flex;"><span>pkg: word
</span></span><span style="display:flex;"><span>BenchmarkIsPalindrome-4     <span style="color:#0000cf;font-weight:bold">2000000000</span>     0.00 ns/op
</span></span><span style="display:flex;"><span>PASS
</span></span><span style="display:flex;"><span>ok     word    0.002s
</span></span><span style="display:flex;"><span>$ go <span style="color:#204a87">test</span> -bench<span style="color:#ce5c00;font-weight:bold">=</span>. -benchmem -benchtime 10s word
</span></span><span style="display:flex;"><span>goos: linux
</span></span><span style="display:flex;"><span>goarch: amd64
</span></span><span style="display:flex;"><span>pkg: word
</span></span><span style="display:flex;"><span>BenchmarkIsPalindrome-4     <span style="color:#0000cf;font-weight:bold">10000000000</span>     0.00 ns/op     <span style="color:#0000cf;font-weight:bold">0</span> B/op     <span style="color:#0000cf;font-weight:bold">0</span> allocs/op
</span></span><span style="display:flex;"><span>PASS
</span></span><span style="display:flex;"><span>ok     word    0.003s
</span></span></code></pre></div><ul>
<li>注意输出部分多的那两部分（0 B/op，0 allocs/op）以及执行次数。</li>
</ul>
<h3 id="怎样在测试的时候开启测试覆盖度分析如果开启会有什么副作用吗">怎样在测试的时候开启测试覆盖度分析？如果开启，会有什么副作用吗？</h3>
<ul>
<li>使用<code>-coverprofile=xxxx.out</code>输出覆盖率的out文件，使用<code>go tool cover -html=xxxx.out</code>命令转换成Html的覆盖率测试报告。</li>
<li>覆盖率测试将被测试的代码拷贝一份，在每个语句块中加入bool标识变量，测试结束后统计覆盖率并输出成out文件，因此性能上会有一定的影响。</li>
<li>使用<code>-covermode=count</code>标识参数将插入的标识变量由bool类型转换为计数器，在测试过程中，记录执行次数，用于找出被频繁执行的代码块，方便优化。</li>
</ul>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-c7d2056c34effb010b85e592bf9d77d9">10.18 - Go 模板</h1>
    
	<p>关于 Go 模板的笔记</p>
<h2 id="字段操作">字段操作</h2>
<p>Go 语言的模板通过<code>{{}}</code>来插入变量，<code>{{.}}</code>表示当前对象，类似于 C++ 中的 this 或者 Python 中的 self。<code>{{ .FieldName }}</code>用来获取当前对象中的字段<code>FieldName</code>，需要注意的是字段名必须是<code>exported</code>的(即变量的首字母必须是大写)。</p>
<p>如果字段名不是<code>exported</code>的，那么就会有如下错误:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000">template</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">header</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">html</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">14</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">executing</span> <span style="color:#4e9a06">&#34;header.html&#34;</span> <span style="color:#000">at</span> <span style="color:#000;font-weight:bold">&lt;.</span><span style="color:#000">title</span><span style="color:#000;font-weight:bold">&gt;:</span> <span style="color:#000">title</span> <span style="color:#000">is</span> <span style="color:#000">an</span> <span style="color:#000">unexported</span> <span style="color:#000">field</span> <span style="color:#000">of</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#204a87;font-weight:bold">type</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#000">Env</span> <span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">title</span> <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><ul>
<li>可以用下面这种形式输出字符串变量<code>string</code></li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{{</span> <span style="color:#4e9a06">`string`</span> <span style="color:#000;font-weight:bold">}}</span>
</span></span></code></pre></div><h2 id="输出嵌套内容">输出嵌套内容</h2>
<p><code>with</code>操作可以更改当前<code>{{ . }}</code>所指向的对象。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">t</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">template</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">New</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;test_with&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Parse</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">`</span><span style="color:#8f5902;font-style:italic">{{</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">with</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#c4a000">.Env</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">}}{{</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">range</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">$key</span><span style="color:#ce5c00;font-weight:bold">,</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">$val</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">:=</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#c4a000">.</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">}}</span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    </span><span style="color:#8f5902;font-style:italic">{{</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">$key</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">}}</span><span style="color:#4e9a06">: </span><span style="color:#8f5902;font-style:italic">{{</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">$val</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">}}</span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">    </span><span style="color:#8f5902;font-style:italic">{{</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">end</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">}}{{</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#204a87;font-weight:bold">end</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#8f5902;font-style:italic">}}</span><span style="color:#4e9a06">`</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Execute</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Stdout</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">Env</span> <span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">]</span><span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">Env</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#4e9a06">&#34;Home&#34;</span><span style="color:#000;font-weight:bold">:</span>  <span style="color:#4e9a06">&#34;jc&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>            <span style="color:#4e9a06">&#34;Lover&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;xff&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="pipelines">pipelines</h2>
<ul>
<li>在 Go 语言模板中，任何<code>{{}}</code>里面的内容都是pipelines数据</li>
<li>pipelines数据之间可以通过<code>|</code>联系起来，例如: <code>{{ &quot;&lt;output&gt;&quot; | html }}</code></li>
</ul>
<h2 id="自定义函数">自定义函数</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;html/template&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;strings&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Friend</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">Fname</span> <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Person</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">UserName</span> <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">Emails</span>   <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">Friends</span>  <span style="color:#000;font-weight:bold">[]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Friend</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">EmailDealWith</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">args</span> <span style="color:#ce5c00;font-weight:bold">...</span><span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">ok</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">s</span> <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">args</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">s</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ok</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">].(</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">ok</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">s</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sprint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">args</span><span style="color:#ce5c00;font-weight:bold">...</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// find the @ symbol
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">substrs</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">strings</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Split</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;@&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">substrs</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#0000cf;font-weight:bold">2</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">s</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// replace the @ by &#34; at &#34;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">substrs</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#4e9a06">&#34; at &#34;</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">substrs</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">])</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">Upper</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">args</span> <span style="color:#ce5c00;font-weight:bold">...</span><span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">ok</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">s</span> <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">args</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">s</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ok</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">args</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">].(</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">ok</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">s</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sprint</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">args</span><span style="color:#ce5c00;font-weight:bold">...</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">strings</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ToUpper</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">s</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">EmailDealWith</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;a&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;b&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;@&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;c&#34;</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">f1</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">Friend</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">Fname</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;minux.ma&#34;</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">f2</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">Friend</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">Fname</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;xushiwei&#34;</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">t</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">template</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">New</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;fieldname example&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">t</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Funcs</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">template</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FuncMap</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;emailDeal&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">EmailDealWith</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;upper&#34;</span><span style="color:#000;font-weight:bold">:</span>     <span style="color:#000">Upper</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">t</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">_</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Parse</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">`hello </span><span style="color:#8f5902;font-style:italic">{{</span><span style="color:#c4a000">.UserName</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#000">upper</span><span style="color:#8f5902;font-style:italic">}}</span><span style="color:#4e9a06">!
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">                </span><span style="color:#8f5902;font-style:italic">{{</span><span style="color:#204a87;font-weight:bold">range</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#c4a000">.Emails</span><span style="color:#8f5902;font-style:italic">}}</span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">                    an emails </span><span style="color:#8f5902;font-style:italic">{{</span><span style="color:#c4a000">.</span><span style="color:#ce5c00;font-weight:bold">|</span><span style="color:#000">emailDeal</span><span style="color:#8f5902;font-style:italic">}}</span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">                </span><span style="color:#8f5902;font-style:italic">{{</span><span style="color:#204a87;font-weight:bold">end</span><span style="color:#8f5902;font-style:italic">}}</span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">                </span><span style="color:#8f5902;font-style:italic">{{</span><span style="color:#204a87;font-weight:bold">with</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#c4a000">.Friends</span><span style="color:#8f5902;font-style:italic">}}</span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">                </span><span style="color:#8f5902;font-style:italic">{{</span><span style="color:#204a87;font-weight:bold">range</span><span style="color:#f8f8f8;text-decoration:underline"> </span><span style="color:#c4a000">.</span><span style="color:#8f5902;font-style:italic">}}</span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">                    my friend name is </span><span style="color:#8f5902;font-style:italic">{{</span><span style="color:#c4a000">.Fname</span><span style="color:#8f5902;font-style:italic">}}</span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">                </span><span style="color:#8f5902;font-style:italic">{{</span><span style="color:#204a87;font-weight:bold">end</span><span style="color:#8f5902;font-style:italic">}}</span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">                </span><span style="color:#8f5902;font-style:italic">{{</span><span style="color:#204a87;font-weight:bold">end</span><span style="color:#8f5902;font-style:italic">}}</span><span style="color:#4e9a06">
</span></span></span><span style="display:flex;"><span><span style="color:#4e9a06">                `</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">p</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">Person</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">UserName</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Astaxie&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">Emails</span><span style="color:#000;font-weight:bold">:</span>  <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">{</span><span style="color:#4e9a06">&#34;astaxie@beego.me&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;astaxie@gmail.com&#34;</span><span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">Friends</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">Friend</span><span style="color:#000;font-weight:bold">{</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">f1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">f2</span><span style="color:#000;font-weight:bold">}}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Execute</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Stdout</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">p</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><ul>
<li>Go 模板包中还提供了许多自定义函数，<a href="https://golang.org/pkg/text/template/#hdr-Functions">相关文档</a></li>
</ul>
<h2 id="must">Must</h2>
<p><code>Must</code>是一个 helper 函数，用来检查模板编译是否正确，如果不正确就会panic。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">tErr</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">template</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">New</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;terr&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">template</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Must</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">tErr</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Parse</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">`some error </span><span style="color:#8f5902;font-style:italic">{{</span><span style="color:#000">text</span><span style="color:#a40000">}</span><span style="color:#4e9a06">`</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// panic: template: terr:1: function &#34;text&#34; not defined
</span></span></span></code></pre></div><h2 id="模板嵌套">模板嵌套</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span>// header.html
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">&lt;!DOCTYPE html&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">html</span> <span style="color:#c4a000">lang</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;en&#34;</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">head</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">meta</span> <span style="color:#c4a000">charset</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;UTF-8&#34;</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">title</span><span style="color:#000;font-weight:bold">&gt;</span>{{ .Title }}<span style="color:#000;font-weight:bold">&lt;/</span><span style="color:#204a87;font-weight:bold">title</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">&lt;/</span><span style="color:#204a87;font-weight:bold">head</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">body</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span>    {{ template &#34;body&#34; . }}
</span></span><span style="display:flex;"><span>    {{ with .Env }}
</span></span><span style="display:flex;"><span>        {{ range $key, $val := . }}
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">li</span><span style="color:#000;font-weight:bold">&gt;</span>{{ $key }} -- {{ $val }}<span style="color:#000;font-weight:bold">&lt;/</span><span style="color:#204a87;font-weight:bold">li</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span>        {{ end }}
</span></span><span style="display:flex;"><span>    {{ end }}
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">&lt;/</span><span style="color:#204a87;font-weight:bold">body</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">&lt;/</span><span style="color:#204a87;font-weight:bold">html</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>// body.html
</span></span><span style="display:flex;"><span>{{ define &#34;body&#34; }}
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">ul</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span>    {{ range $key, $val := .Env }}
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">li</span><span style="color:#000;font-weight:bold">&gt;</span>{{ $key }} -- {{ $val }}<span style="color:#000;font-weight:bold">&lt;/</span><span style="color:#204a87;font-weight:bold">li</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span>    {{ end }}
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">&lt;/</span><span style="color:#204a87;font-weight:bold">ul</span><span style="color:#000;font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span>{{ end }}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// main.go
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;log&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;os&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;text/template&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">t</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">template</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ParseFiles</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;header.html&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;body.html&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatalln</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">env</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#4e9a06">&#34;Home&#34;</span><span style="color:#000;font-weight:bold">:</span>  <span style="color:#4e9a06">&#34;/Users/michaletsui&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#4e9a06">&#34;Shell&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;/bin/bash&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Execute</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Stdout</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Env</span>   <span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">]</span><span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Title</span> <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Env</span><span style="color:#000;font-weight:bold">:</span>   <span style="color:#000">env</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">Title</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Go 模板&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatalln</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><ul>
<li><code>{{ define &quot;blockname&quot; }}...{{ end }}</code>可以定义一个 block</li>
<li><code>{{ template &quot;blockname&quot; }}</code> 将会调用一个 block</li>
<li><code>t.Execute</code>传递的对象并不会直接传递给 block，需要<code>{{ block &quot;body&quot; . }}</code>这样显示传递</li>
<li>同一个集合类的模板是互相知晓的，如果同一模板被多个集合使用，则它需要在多个集合中分别解析</li>
<li><code>template.ParseFiles</code>将第一个文件作为主模板</li>
<li><code>t.ExecuteTemplate</code>可以指定要执行的主模板</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">t</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">template</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ParseFiles</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;body.html&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;header.html&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatalln</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">env</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">]</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;Home&#34;</span><span style="color:#000;font-weight:bold">:</span>  <span style="color:#4e9a06">&#34;/Users/michaletsui&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;Shell&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;/bin/bash&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">data</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">Env</span>   <span style="color:#204a87;font-weight:bold">map</span><span style="color:#000;font-weight:bold">[</span><span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">]</span><span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">Title</span> <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">Env</span><span style="color:#000;font-weight:bold">:</span>   <span style="color:#000">env</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">Title</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Go 模板&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// 因为 body.html 作为主模板除了定义的block外没有其它内容，所以`t.Execute`没有不会输出任何内容
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// 故这里通过 `t.ExecuteTemplate` 来指定主模板
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// 也可以通过下面的方式
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// t = t.Lookup(&#34;header.html&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// err = t.Execute(os.Stdout, data)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ExecuteTemplate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">os</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Stdout</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;header.html&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">data</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">log</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Fatalln</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="参考链接">参考链接</h2>
<ul>
<li>
<p><a href="https://colobu.com/2016/10/09/Go-embedded-template-best-practices/">Go 模板嵌套最佳实践
</a></p>
</li>
<li>
<p><a href="https://github.com/astaxie/build-web-application-with-golang/blob/master/zh/07.4.md#must%E6%93%8D%E4%BD%9C">build-web-application-with-golang 07.4</a></p>
</li>
</ul>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-c6e65801f450a5190e19f70c05c579be">10.19 - Go mod 说明</h1>
    
	<p>关于 Go mod 的介绍</p>
<ul>
<li><a href="https://roberto.selbach.ca/intro-to-go-modules/">Introduction to Go Modules</a></li>
<li><a href="https://github.com/bwangelme/testmod">Github 仓库</a></li>
<li><a href="https://github.com/bwangelme/testmod_demo">使用这个仓库的Demo</a></li>
</ul>
<h2 id="版本号的说明">版本号的说明</h2>
<ul>
<li>版本号由三个部分组成: <code>主版本.副版本.修订号</code></li>
<li>修订号的增加表示修复了一些BUG</li>
<li>副版本号的增加表示修改了一些内部实现的逻辑，但是对外提供的接口没有改变</li>
<li>主版本号的增加表示修改了对外提供的接口，主版本之间是可以不兼容的</li>
</ul>
<h2 id="go-module-模式下的核心原则">Go Module 模式下的核心原则</h2>
<p>Go Module 模式是指 <code>GO111MODULE=on</code> 时:</p>
<ol>
<li>一个包的导入路径定义了该包的唯一标识。
<ul>
<li>具有不同导入路径的包被视为不同的包。</li>
<li>具有相同导入路径的包被视为相同的包（即使 VCS 标签说这些包有不同的主要版本，Go 也认为它们是同一个包）。</li>
</ul>
</li>
<li>没有 <code>/vN</code> 的导入路径被视为v1或v0模块，即使导入的包没有选择加入模块模式(无 go.mod 文件)，并且 VCS 标签显示主版本号大于1，Go 也认为其主版本号是 V0 或 V1。</li>
<li>在一个模块的 go.mod 文件的开头所声明的模块路径（如模块foo/v2）有两层含义。
<ul>
<li>对该模块身份的明确声明</li>
<li>关于该模块该如何被消费代码导入的正确声明</li>
</ul>
</li>
</ol>
<h2 id="go-mod-版本管理">Go mod 版本管理</h2>
<ul>
<li><strong>注意</strong>: 使用 go mod 进行管理的仓库必须放置在<code>GOPATH</code>外</li>
<li>Go mod 通过 Git 的标签来标记版本 <code>git tag v1.0.0 &amp;&amp; git push --tags</code></li>
<li>建议为每个主版本新建一个分支(<code>git checkout -b v1</code>)</li>
<li><code>go mod init reponame</code>可以创建一个库</li>
<li><code>go build</code>命令会自动分析代码中的依赖，并获取相应版本的库</li>
<li><code>go get -u</code>将会升级依赖的副版本号或者修订号</li>
<li><code>go get -u=patch</code>将会升级修订号，但是不会升级副版本号</li>
<li><code>go get package@version</code>表示安装特定版本的的依赖</li>
<li>Go会将依赖写在仓库下的<code>go.mod</code>和<code>go.sum</code>文件中</li>
</ul>
<h2 id="主版本升级">主版本升级</h2>
<ul>
<li>当仓库的主版本发生变化时，其导入路径也应该随之改变，具体就是将<code>go.mod</code>中的<code>github.com/user/repo</code>改成<code>github.com/user/repo/v2</code></li>
</ul>
<p>在Golang中，一个依赖可以同时存在两个主版本不同的<code>import</code>。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;github.com/user/repo&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">repov2</span> <span style="color:#4e9a06">&#34;github.com/user/repo/v2&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>故当一个仓库需要升级某个依赖的主版本时，其代码导入路径要随之改变。如果依赖的API变了，那么仓库也要进行相应的更改。</p>
<h2 id="清除依赖">清除依赖</h2>
<p><code>go mod tidy</code>命令可以移除<code>go.mod</code>中不再使用的依赖</p>
<h2 id="go-mod-和-vendoring">Go mod 和 Vendoring</h2>
<ul>
<li>Go 1.12 支持使用<code>go mod verdor</code>命令将依赖安装在仓库的<code>vendor</code>目录下</li>
<li><code>go build</code>命令会忽略掉<code>vendor</code>目录，<code>go build -mod vendor</code>命令会从当前目录的<code>vendor</code>目录下寻找依赖</li>
</ul>
<h2 id="安装位置">安装位置</h2>
<p>Go 将依赖安装在<code>GOPATH/pkg/mod</code>中，并且依赖的每个版本会分开安装</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>&gt;&gt;&gt; tree <span style="color:#000">$GOPATH</span>/pkg/mod/github.com/bwangelme/
</span></span><span style="display:flex;"><span>/Users/michaeltsui/go/pkg/mod/github.com/bwangelme/
</span></span><span style="display:flex;"><span>├── testmod
</span></span><span style="display:flex;"><span>│   └── v2@v2.0.0
</span></span><span style="display:flex;"><span>│       ├── README.md
</span></span><span style="display:flex;"><span>│       ├── go.mod
</span></span><span style="display:flex;"><span>│       └── testmod.go
</span></span><span style="display:flex;"><span>├── testmod@v1.0.0
</span></span><span style="display:flex;"><span>│   ├── README.md
</span></span><span style="display:flex;"><span>│   ├── go.mod
</span></span><span style="display:flex;"><span>│   └── testmod.go
</span></span><span style="display:flex;"><span>└── testmod@v1.0.1
</span></span><span style="display:flex;"><span>    ├── README.md
</span></span><span style="display:flex;"><span>    ├── go.mod
</span></span><span style="display:flex;"><span>    └── testmod.go
</span></span></code></pre></div><h2 id="查看依赖">查看依赖</h2>
<ul>
<li>查看当前仓库依赖的所有 module</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>go list -m -json all
</span></span></code></pre></div><ul>
<li>查看 github.com 域名下所有的 module</li>
</ul>
<pre tabindex="0"><code>go list -m -json &#39;github.com/...&#39;
</code></pre><p><code>-m</code> 选项让 go list 列出所有的 module 而不是包。在这种模式下，<code>go list</code> 的参数可以是模块或模块模式(包含 <code>...</code> 通配符)，<a href="https://go.dev/ref/mod#version-queries">Version Query</a>，或者特殊模式 <code>all</code>(匹配<a href="https://go.dev/ref/mod#glos-build-list">构建列表</a>中的所有模块)。如果没有指定参数，<a href="https://go.dev/ref/mod#glos-main-module">主模块</a>将被列出。</p>
<h2 id="关于-incompatible-版本标签的说明">关于 incompatible 版本标签的说明</h2>
<ul>
<li>被导入的包没有选择加入 module 模式，无 go.mod 文件</li>
<li>被导入的包有语义化版本号 VCS 标签，且该标签表示的版本主版本号大于1</li>
<li>Go Module 核心原则第2点生效，导入路径中没有 <code>/vN</code>，它将被视为 v1 或 v0 模块，VCS 标签不生效</li>
</ul>
<p>当 Go 处于 Module 模式时，它将假设一个非 module 模式的 V2+ 版本的包不理解 <code>语义化导入版本控制(Semantic Import Versioning)</code>，从而将其视为该包 V1 版本系列的不兼容扩展。<code>incompatible</code> 后缀即表示该包是一个不兼容 V1 旧版本的 V1 扩展版本。</p>
<h2 id="版本选择">版本选择</h2>
<p>如果你在你的代码中添加了一个新的导入，而这个导入还没有被 go.mod 中的 require 指令所覆盖。
大多数go命令如 <code>go build</code> 和 <code>go test</code> 会自动查找合适的模块，并将这个新的直接依赖的最高版本作为 require 指令添加到你的模块的 go.mod 中。</p>
<p>例如，如果你的新导入对应的依赖 M 包的最新标签发布版本是v1.2.3，你的模块的 go.mod 中将添加指令 <code>require M v1.2.3</code>，这表明模块 M 是一个允许版本 <code>&gt;= v1.2.3</code> 的依赖关系，并且 <code>&lt; v2</code>，因为v2被认为与v1不兼容。</p>
<p><code>最小版本选择算法 (Minimal Version Selection Algorithm)</code> 被用来选择在构建中使用的所有模块的版本。对于构建中的每个模块，通过最小版本选择算法所选择的版本总是语义上最高的版本，该版本由主模块或其依赖关系中的 require 指令明确列出。</p>
<p>例如，主模块依赖模块A，而模块A有一个 require D v1.0.0，主模块也依赖模块B，而模块B有一个 require D v1.1.1，那么最小版本选择算法会选择 D 的 v1.1.1 版本用来包含在构建中（因为它是列出的最高 require 版本）。
即使后来 D 的 v1.2.0 版本发布了，在构建中仍然会选择 v1.1.1。这是一个模块系统如何提供 100% 可重复构建的例子。
当准备就绪时，模块作者或用户可以选择升级到D的最新可用版本或为D选择一个明确的版本。</p>
<h2 id="参考链接">参考链接</h2>
<ul>
<li><a href="https://go.dev/ref/mod">https://go.dev/ref/mod</a></li>
<li><a href="https://github.com/golang/go/wiki/Modules">https://github.com/golang/go/wiki/Modules</a></li>
</ul>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-5d60a98a1071c1eb27363bb8fd0863bf">10.20 - Go 语言的 Type Switch 语句解析</h1>
    
	<p>讲述了Go语言中 Type Swith 的用法以及获取对应变量的一些特殊情况。</p>
<h2 id="type-switch-的基本用法">Type Switch 的基本用法</h2>
<p>Type Switch 是 Go 语言中一种特殊的 switch 语句，它比较的是类型而不是具体的值。它判断某个接口变量的类型，然后根据具体类型再做相应处理。注意，在 Type Switch 语句的 case 子句中不能使用<code>fallthrough</code>。</p>
<p>它的用法如下。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">switch</span> <span style="color:#000">x</span><span style="color:#000;font-weight:bold">.(</span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">Type1</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">doSomeThingWithType1</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">Type2</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">doSomeThingWithType2</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">default</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">doSomeDefaultThing</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>其中，<code>x</code>必须是一个接口类型的变量，而所有的<code>case</code>语句后面跟的类型必须实现了<code>x</code>的接口类型。</p>
<p>为了便于理解，我们可以结合下面这个例子来看:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;reflect&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Animal</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">shout</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Dog</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">self</span> <span style="color:#000">Dog</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">shout</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;wang wang&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Cat</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">self</span> <span style="color:#000">Cat</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">shout</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;miao miao&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">animal</span> <span style="color:#000">Animal</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">Dog</span><span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">switch</span> <span style="color:#000">animal</span><span style="color:#000;font-weight:bold">.(</span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">Dog</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;animal&#39;type is Dog&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">Cat</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;animal&#39;type is Cat&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>在上面的例子中，<code>Cat</code>和<code>Dog</code>类型都实现了接口<code>Animal</code>，所以它们可以跟在<code>case</code>语句后面，判断接口变量<code>animal</code>是否是对应的类型。</p>
<h2 id="在switch的语句表达式中声明变量">在Switch的语句表达式中声明变量</h2>
<p>如果我们不仅想要判断某个接口变量的类型，还想要获得其类型转换后的值的话，我们可以在 Switch 的语句表达式中声明一个变量来获得这个值。</p>
<p>其用法如下所示:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;reflect&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Animal</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">shout</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Dog</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">name</span> <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">self</span> <span style="color:#000">Dog</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">shout</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;wang wang&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Cat</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">name</span> <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">self</span> <span style="color:#000">Cat</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">shout</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;miao miao&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Tiger</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">name</span> <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">self</span> <span style="color:#000">Tiger</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">shout</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;hou hou&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// var animal Animal = Tiger{}
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// var animal Animal  // 验证 case nil
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// var animal Animal = Wolf{} // 验证 default
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">animal</span> <span style="color:#000">Animal</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">Dog</span><span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">switch</span> <span style="color:#000">a</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">animal</span><span style="color:#000;font-weight:bold">.(</span><span style="color:#204a87;font-weight:bold">type</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#204a87;font-weight:bold">nil</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#8f5902;font-style:italic">// a的类型是 Animal
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;nil&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">a</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">Dog</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">Cat</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#8f5902;font-style:italic">// a的类型是 Animal
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic">// 输出 {}
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#8f5902;font-style:italic">// fmt.Println(a.name) 这里会报错，因为 Animal 类型没有成员name
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">Tiger</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#8f5902;font-style:italic">// a的类型是 Tiger
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">shout</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">a</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic">// 这里可以直接取出 name 成员
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">default</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#8f5902;font-style:italic">// a的类型是 Animal
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;default&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">reflect</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">TypeOf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">a</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>在上述代码中，我们可以看到<code>a := animal.(type)</code>语句隐式地为每个<code>case</code>子句声明了一个变量<code>a</code>。</p>
<p>变量<code>a</code>类型的判定规则如下:</p>
<ul>
<li>如果<code>case</code>后面跟着<strong>一个</strong>类型，那么变量<code>a</code>在这个<code>case</code>子句中就是这个类型。例如在<code>case Tiger</code>子句中<code>a</code>的类型就是<code>Tiger</code></li>
<li>如果<code>case</code>后面跟着<strong>多个</strong>类型，那么变量<code>a</code>的类型就是接口变量<code>animal</code>的类型，例如在<code>case Dog, Cat</code>子句中<code>a</code>的类型就是<code>Animal</code></li>
<li>如果<code>case</code>后面跟着<code>nil</code>，那么变量<code>a</code>的类型就是接口变量<code>animal</code>的类型<code>Animal</code>，通常这种子句用来判断未赋值的接口变量</li>
<li><code>default</code>子句中变量<code>a</code>的类型是接口变量<code>animal</code>的类型</li>
</ul>
<p>为了更好地理解上述规则，我们可以用<code>if</code>语句和类型断言来重写这个<code>switch</code>语句，如下所示：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>	<span style="color:#000">v</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">animal</span>   <span style="color:#8f5902;font-style:italic">// animal 只会被求值一次
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">v</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#8f5902;font-style:italic">// case nil 子句
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">a</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">v</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;nil&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">a</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">a</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">isTiger</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">v</span><span style="color:#000;font-weight:bold">.(</span><span style="color:#000">Tiger</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">isTiger</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#8f5902;font-style:italic">// case Tiger 子句
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">shout</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">a</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">isDog</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">v</span><span style="color:#000;font-weight:bold">.(</span><span style="color:#000">Dog</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">isCat</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">v</span><span style="color:#000;font-weight:bold">.(</span><span style="color:#000">Cat</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">isDog</span> <span style="color:#ce5c00;font-weight:bold">||</span> <span style="color:#000">isCat</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#8f5902;font-style:italic">// case Dog, Cat 子句
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#000">a</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">v</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>			<span style="color:#8f5902;font-style:italic">// fmt.Println(a.name)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span> <span style="color:#8f5902;font-style:italic">// default 子句
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#000">a</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">v</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;default&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">reflect</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">TypeOf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">a</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">a</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="参考链接">参考链接</h2>
<ul>
<li><a href="https://golang.org/ref/spec#Type_switches">The Go Programming Language Specification</a></li>
</ul>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-05bc77af5135b5de6472208f6d8b18f0">10.21 - Go的并发编程简述</h1>
    
	<p>简述了 Go 中的 goroutine，channel 和 WaitGroup，并通过例子来展示了这些功能的用法</p>
<h2 id="goroutine-简述">Goroutine 简述</h2>
<p>Go 对于异步编程提供了语言级别的支持，我们可以使用它的 goroutine 很方便地写出异步的代码。首先我们先通过一个简单的例子来认识 Go 的 goroutine。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;runtime&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 这里设置同时执行程序的最大CPU数为逻辑CPU的数量
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">runtime</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GOMAXPROCS</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">runtime</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NumCPU</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">number</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#0000cf;font-weight:bold">10</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#000">number</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">Count</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sleep</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">10</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Second</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">Count</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">index</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">sum</span> <span style="color:#204a87;font-weight:bold">int64</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">1000000000</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">sum</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#204a87">int64</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">index</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">sum</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 程序的输出结果
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span><span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">run</span> <span style="color:#000">goroutine</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">go</span>                                                                            <span style="color:#0000cf;font-weight:bold">20</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">32</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">31</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">09</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">19</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">4</span> <span style="color:#0000cf;font-weight:bold">499999999500000000</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">2</span> <span style="color:#0000cf;font-weight:bold">499999999500000000</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">3</span> <span style="color:#0000cf;font-weight:bold">499999999500000000</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">5</span> <span style="color:#0000cf;font-weight:bold">499999999500000000</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#0000cf;font-weight:bold">499999999500000000</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#0000cf;font-weight:bold">499999999500000000</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">7</span> <span style="color:#0000cf;font-weight:bold">499999999500000000</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">8</span> <span style="color:#0000cf;font-weight:bold">499999999500000000</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">9</span> <span style="color:#0000cf;font-weight:bold">499999999500000000</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">6</span> <span style="color:#0000cf;font-weight:bold">499999999500000000</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">run</span> <span style="color:#000">goroutine</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">go</span>  <span style="color:#0000cf;font-weight:bold">7.40</span><span style="color:#000">s</span> <span style="color:#000">user</span> <span style="color:#0000cf;font-weight:bold">0.09</span><span style="color:#000">s</span> <span style="color:#000">system</span> <span style="color:#0000cf;font-weight:bold">73</span><span style="color:#ce5c00;font-weight:bold">%</span> <span style="color:#000">cpu</span> <span style="color:#0000cf;font-weight:bold">10.239</span> <span style="color:#000">total</span>
</span></span></code></pre></div><p>在上面的代码中，我们启动了10个 goroutine 计算了10次{ 1 - 1000000000 }的和，主程序睡眠了10秒钟等待10个 goroutine 的结束。</p>
<p>goroutine 类似于 Python 中的协程。Go 语言自己实现了一个调度程序，负责调度 goroutine 的执行，每当 goroutine 程序遇到阻塞操作的时候，就把程序的控制权主动交还给调度程序，并保存自己的堆栈信息。Go 语言的调度程序拥有控制权后再来启动其他的 goroutine，其他的 goroutine 继续执行，当遇到阻塞操作后再把控制权交还给调度程序，以此往复，直到程序结束。</p>
<h2 id="main-程序等待-goroutine-结束">main 程序等待 goroutine 结束</h2>
<p>在上面的代码中，我们的主程序是通过<code>time.Sleep</code>来等待其他 goroutine 的结束，但是这样的方法很笨。我们需要在所有的 goroutine 运行完成之后，通知主程序退出，而不是让主程序傻傻地等一个固定时间。要实现这样的功能，我们可以使用<code>channel</code>或者<code>sync</code>包的<code>WaitGroup</code>类型。</p>
<h3 id="channel">Channel</h3>
<p>channel 是 Go 中的数据数据类型，可以被用来接收和发送数据，它具有一下特点:</p>
<ul>
<li>channel 必须要通过<code>make</code>函数创建</li>
<li>channel 是带有是类型的，<code>ch := make(chan int)</code>表示声明一个 channel，其接收和发送的数据只能为<code>int</code>类型。</li>
<li>管道可以有缓存，<code>ch := make(chan int, 20)</code>表示管道的缓存大小为20个int类型的数据。
<ul>
<li>管道的缓存满了的时候，发送操作会阻塞</li>
<li>管道的缓存空的时候，接收操作会阻塞</li>
<li>如果整个程序所有的 goroutine 都是阻塞的，那么程序就会抛出异常，这样做是为了预防死锁</li>
</ul>
</li>
</ul>
<p>我们可以通过 channel 来改造我们上面的代码，创建一个 channel 在主程序和 goroutine 之间通信，当所有的 goroutine 都完成之后，再来通知主程序退出。改进后的程序代码如下:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;runtime&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 这里设置同时执行程序的最大CPU数为逻辑CPU的数量
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">runtime</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GOMAXPROCS</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">runtime</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NumCPU</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">number</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#0000cf;font-weight:bold">10</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 在这里创建的一个 channel，channel 的缓存大小为我们需要运行的 goroutine 的数量
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// 这样当多个 goroutine 同时向 channel 中写入数据的时候也不会阻塞
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">bool</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">number</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#000">number</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">Count</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">c</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#000">number</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// 主程序在这里会从 channel 中读取 number 个值，所有的值都被读取成功之后，主程序才会结束
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#000">c</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">Count</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">index</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">c</span> <span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">bool</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 这里需要注意，尽管我们没有显示地声明，但是 channel 传递给函数的时候，是通过引用的方式传递的，
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// 因为如果是通过值传递的话， goroutine 中对 channel 写入的数据就无法通知到主程序了。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">sum</span> <span style="color:#204a87;font-weight:bold">int64</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">1000000000</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">sum</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#204a87">int64</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">index</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">sum</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// goroutine 在这里向 channel 中写入数据
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">c</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#204a87;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 程序的输出结果
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span><span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">run</span> <span style="color:#000">channel</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">go</span>                                               <span style="color:#0000cf;font-weight:bold">22</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">54</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">39</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">09</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">19</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">5</span> <span style="color:#0000cf;font-weight:bold">499999999500000000</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">2</span> <span style="color:#0000cf;font-weight:bold">499999999500000000</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">9</span> <span style="color:#0000cf;font-weight:bold">499999999500000000</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#0000cf;font-weight:bold">499999999500000000</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">3</span> <span style="color:#0000cf;font-weight:bold">499999999500000000</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">8</span> <span style="color:#0000cf;font-weight:bold">499999999500000000</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">7</span> <span style="color:#0000cf;font-weight:bold">499999999500000000</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#0000cf;font-weight:bold">499999999500000000</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">4</span> <span style="color:#0000cf;font-weight:bold">499999999500000000</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">6</span> <span style="color:#0000cf;font-weight:bold">499999999500000000</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">run</span> <span style="color:#000">channel</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">go</span>  <span style="color:#0000cf;font-weight:bold">7.44</span><span style="color:#000">s</span> <span style="color:#000">user</span> <span style="color:#0000cf;font-weight:bold">0.14</span><span style="color:#000">s</span> <span style="color:#000">system</span> <span style="color:#0000cf;font-weight:bold">299</span><span style="color:#ce5c00;font-weight:bold">%</span> <span style="color:#000">cpu</span> <span style="color:#0000cf;font-weight:bold">2.534</span> <span style="color:#000">total</span>
</span></span></code></pre></div><p>从上述程序的输出结果中我们可以看到，程序的运行时间明显减短了，我们也不用担心某些没有运行完的 goroutine 因为主程序的退出而被强制结束。</p>
<h3 id="waitgroup">WaitGroup</h3>
<p>完成主程序和协程的同步工作，除了使用 channel 之外，我们还可以使用 Go 的<code>sync.WaitGroup</code>类型，它可以让主程序阻塞地等待一组 goroutine 的结束，它的具体用法如下所示:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;runtime&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;sync&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 这里设置同时执行程序的最大CPU数为逻辑CPU的数量
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">runtime</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GOMAXPROCS</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">runtime</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NumCPU</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">number</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#0000cf;font-weight:bold">10</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 这里使用了一个WaitGroup来演示程序的并发效果
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// wg.Add(number) 表示一共有 number 个 goroutine 需要等待完成
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// wg.Done() 表示一个 goroutine 完成了
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// wg.Wait() 表示阻塞地等待 number 个 wg.Done() 的通知
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 需要注意的是wg传递给函数的时候，需要传递指针类型
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">wg</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">sync</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WaitGroup</span><span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">wg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Add</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">number</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#000">number</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">Count</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">wg</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">wg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Wait</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">Count</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">index</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">wg</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">sync</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WaitGroup</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">sum</span> <span style="color:#204a87;font-weight:bold">int64</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">1000000000</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">sum</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#204a87">int64</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">index</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">sum</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">wg</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Done</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 程序的输出结果
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span><span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">run</span> <span style="color:#000">wait_group</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">go</span>                                            <span style="color:#0000cf;font-weight:bold">23</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">19</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">19</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">09</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">19</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">2</span> <span style="color:#0000cf;font-weight:bold">499999999500000000</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">9</span> <span style="color:#0000cf;font-weight:bold">499999999500000000</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">5</span> <span style="color:#0000cf;font-weight:bold">499999999500000000</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">7</span> <span style="color:#0000cf;font-weight:bold">499999999500000000</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#0000cf;font-weight:bold">499999999500000000</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">8</span> <span style="color:#0000cf;font-weight:bold">499999999500000000</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">3</span> <span style="color:#0000cf;font-weight:bold">499999999500000000</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">6</span> <span style="color:#0000cf;font-weight:bold">499999999500000000</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#0000cf;font-weight:bold">499999999500000000</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">4</span> <span style="color:#0000cf;font-weight:bold">499999999500000000</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">run</span> <span style="color:#000">wait_group</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">go</span>  <span style="color:#0000cf;font-weight:bold">7.38</span><span style="color:#000">s</span> <span style="color:#000">user</span> <span style="color:#0000cf;font-weight:bold">0.13</span><span style="color:#000">s</span> <span style="color:#000">system</span> <span style="color:#0000cf;font-weight:bold">302</span><span style="color:#ce5c00;font-weight:bold">%</span> <span style="color:#000">cpu</span> <span style="color:#0000cf;font-weight:bold">2.485</span> <span style="color:#000">total</span>
</span></span></code></pre></div><h2 id="使用-select-等待多个-channel">使用 select 等待多个 channel</h2>
<p>上面的代码中，我们演示的都是一个 goroutine 中操作一个 channel，当我们需要在 goroutine 中同时操作多个 channel 时该怎么办呢？这就需要用到我们的<code>select</code>语句，<code>select</code>语句和<code>switch</code>语句非常相似，只不过不同的是，<code>select</code>判断的是一个 channel 是否是可读写的，而不是表达式的值。我们可以通过下面的代码来查看<code>select</code>语句的用法:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 一下的程序演示了通过select语句动态地检查channel
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 这里创建了两个 channel c1和c2
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">c1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">c2</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 这里创建了一个判断结束的 channel o
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">o</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#204a87;font-weight:bold">bool</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#204a87;font-weight:bold">func</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// c1Close 和 c2Close 是两个标记，用来标记 goroutine 中 channel 是否已经关闭
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">c1Close</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">c2Close</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87;font-weight:bold">false</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">select</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">v</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ok</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#000">c1</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>				<span style="color:#8f5902;font-style:italic">// c1 关闭以后 ok 会为False
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>				<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">ok</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">c1Close</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>						<span style="color:#8f5902;font-style:italic">// 第一次读取到 c1 的关闭信息时执行 if 语句块内的内容，以后再次读取到的时候则忽略
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>						<span style="color:#000">o</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#204a87;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>						<span style="color:#000">c1Close</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>					<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;c1:&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">case</span> <span style="color:#000">v</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ok</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#000">c2</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">ok</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">c2Close</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>						<span style="color:#000">o</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#204a87;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>						<span style="color:#000">c2Close</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>					<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;c2:&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>			<span style="color:#8f5902;font-style:italic">// 只有当两个channel 都关闭的时候，goroutine 才会退出
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">c1Close</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">c2Close</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>				<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;c1:&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">c1Close</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;c2:&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">c2Close</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>				<span style="color:#204a87;font-weight:bold">break</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 主程序向两个 channel 中写入值
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">c1</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">c2</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#4e9a06">&#34;hi&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">c1</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#0000cf;font-weight:bold">3</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">c2</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#4e9a06">&#34;hello&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 关闭两个 channel
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">c2</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 等待 goroutine 的退出
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Close&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">v</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#000">o</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 程序的输出
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span><span style="color:#000;font-weight:bold">&gt;</span> <span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">run</span> <span style="color:#204a87;font-weight:bold">select</span><span style="color:#000;font-weight:bold">.</span><span style="color:#204a87;font-weight:bold">go</span>                                                <span style="color:#0000cf;font-weight:bold">23</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">25</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">11</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">09</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">19</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">c1</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span><span style="color:#000">c2</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">hi</span>
</span></span><span style="display:flex;"><span><span style="color:#000">c1</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">3</span>
</span></span><span style="display:flex;"><span><span style="color:#000">c2</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">hello</span>
</span></span><span style="display:flex;"><span><span style="color:#000">Close</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#204a87;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span><span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#204a87;font-weight:bold">true</span>
</span></span></code></pre></div><p>上述代码简单地展示了如何利用<code>select</code>语句来处理多个 channel，需要注意的是，<code>case v, ok := &lt;-c1</code>这条判断<code>c1</code>是否已经关闭的语句可能会执行多遍，也就是说如果<code>c1</code>关闭了，<code>case v, ok := &lt;-c1</code>还是永远可以读取出值来，且读取出来的<code>ok</code>始终为<code>false</code>。</p>
<p>如果我们不搞一个<code>c1Close</code>来进行判断的话，那么<code>o</code>中写入的两个值都可能是在判断<code>c1</code>关闭的时候写入的。</p>
<h2 id="ping-pong-示例代码">ping-pong 示例代码</h2>
<p>OK，看了上面那么多描述之后，我们可以看一个简单的例子，这个例子来自演讲<a href="https://www.youtube.com/watch?v=QDDwwePbDtw"> Advanced Go Concurrency Patterns </a></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;time&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 下面的代码演示了一个乒乓球程序，只有一个球在table上，然后两个player来获取这个球，互相获取了一段时间之后被主程序取走
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">ball</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">hits</span> <span style="color:#204a87;font-weight:bold">int</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">table</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#204a87">make</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ball</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">player</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;ping&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">table</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">go</span> <span style="color:#000">player</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;pong&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">table</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">table</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#204a87">new</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ball</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sleep</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Second</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ball</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#000">table</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;hits:&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ball</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">hits</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87">close</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">table</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">player</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">table</span> <span style="color:#204a87;font-weight:bold">chan</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">ball</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 注意这里数据写到管道里以后，
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">ball</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ok</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span><span style="color:#000">table</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">ok</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#204a87;font-weight:bold">break</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">ball</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">hits</span><span style="color:#ce5c00;font-weight:bold">++</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;total hits:&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">ball</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">hits</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sleep</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">100</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Millisecond</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// 由于创建的chan缓存大小为0，这里的写操作会阻塞，直到有另一个goroutine来读
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">table</span> <span style="color:#ce5c00;font-weight:bold">&lt;-</span> <span style="color:#000">ball</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>上述的代码也并不复杂，但是我觉得很有趣，就贴上来了。channel 可以认为是一个乒乓球桌，channel 中的数据就可以认为是一个乒乓球，每个 goroutine 接收到乒乓球以后，将球的击打次数加1，然后就将乒乓球扔回到乒乓球桌上，等待另一个 goroutine 来接收，如此往复。只有当主程序从桌子上拿走了乒乓球以后（主程序接收到了 channel 中的数据），两个协程才退出。</p>
<h2 id="参考链接">参考链接</h2>
<ol>
<li><a href="https://talks.golang.org/2013/advconc.slide#1">Advanced Go Concurrency Patterns</a></li>
<li><a href="http://www.ucai.cn/index.php?app=fullstack&amp;mod=Train&amp;act=show&amp;cid=69&amp;sid=3259&amp;chid=4708">Go 编程基础 &ndash; 无闻</a></li>
<li><a href="http://www.sizeofvoid.net/goroutine-under-the-hood/">goroutine 背后的系统知识</a></li>
</ol>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-9c00886a50ca7b0f720c54623a097403">10.22 - Go 的反射包浅析</h1>
    
	<p>本文主要介绍了反射包中的常用类型和方法，并使用了几个例子进行了说明。</p>
<h2 id="类型">类型</h2>
<p>Golang 是一种静态类型的语言，我们在代码中定义的每个变量，都会有其类型，例如<code>var a int = 10, b string = &quot;acb&quot;</code>语句中，我们定义了两个变量<code>a</code>和<code>b</code>，它们的类型分别是<code>int</code>和<code>string</code>。</p>
<p>除了系统预定义的类型之外，我们还可以自定义类型，例如下面的语句中，我们定义了一个自定义类型<code>MyInt</code>，然后我们分别定义了两个变量<code>i1</code>和<code>i2</code>，尽管这两个变量的内容是相同的，但是他们由于类型不同，并不能够直接赋值，必须要经过类型转换以后才能赋值。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">MyInt</span> <span style="color:#204a87;font-weight:bold">int</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">i1</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">i2</span> <span style="color:#000">MyInt</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">2</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">i1</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">i2</span> <span style="color:#8f5902;font-style:italic">//cannot use i2 (type MyInt) as type int in assignment
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="接口">接口</h2>
<h3 id="接口类型的定义">接口类型的定义</h3>
<p>在Golang的类型中，还有一种重要的类型叫做接口类型，一个接口类型代表了一组固定的方法。一个接口变量可以存储任意合适的值，只要这个值实现了这个接口的所有方法。</p>
<p>在下面的代码中，我们定义了一个接口类型<code>Animal</code>，然后定义了两种结构体类型<code>Cat</code>和<code>Dog</code>，由于<code>Cat</code>和<code>Dog</code>都实现了<code>Animal</code>的两个方法，所以我们定义的<code>Animal</code>接口变量<code>i</code>既能存储<code>Dog</code>类型的值，又能存储<code>Cat</code>类型的值。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Animal</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">run</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">jump</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Dog</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">d</span> <span style="color:#000">Dog</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">run</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;A dog is running&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">d</span> <span style="color:#000">Dog</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">jump</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;A dog is jumping&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Cat</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#000">Cat</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">run</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;A cat is running&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">c</span> <span style="color:#000">Cat</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">jump</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;A cat is jumping&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">i</span> <span style="color:#000">Animal</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">i</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">Dog</span><span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">i</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">jump</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">i</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">Cat</span><span style="color:#000;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">i</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">run</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="空接口">空接口</h3>
<p>在接口类型中，有一种比较特殊，那就是空接口类型<code>interface{}</code>。空接口类型的方法集合为空集，意味着任意类型都实现了空接口，也就是说空接口类型的变量能够存储任意类型的值。正是由于空接口的这个特性，我们就可以动态地获取空接口类型变量的实际类型，并更改它的值，来实现我们的反射机制。</p>
<h3 id="接口类型的底层实现">接口类型的底层实现</h3>
<p>每一个接口类型的变量，它其实是由两部分组成，被赋的值的拷贝，和被赋的值的类型描述器。例如上面代码中的<code>i</code>变量，我们可以用这样一个二元组来表示: <code>(c, Cat)</code>，代表了变量<code>c</code>和它的类型<code>Cat</code>。</p>
<h2 id="type-和-value">Type 和 Value</h2>
<p>在上文中，我们了解到一个接口变量是由值和值类型两部分组成的，我们的反射相关函数主要就是获取这两部分。当我们调用<code>reflect.ValueOf</code>方法的时候，就是获取接口中的变量，并使用一个<code>reflect.Value</code>类型的变量来代表它。同理，当我们使用<code>reflect.TypeOf</code>方法的时候，它获取的就是接口中存储的变量类型，并使用一个<code>reflect.Type</code>类型的变量来代表它。关于<code>reflect</code>包中这些常用方法的描述如下所示:</p>
<h3 id="typeof-方法">TypeOf 方法</h3>
<p><code>reflect.TypeOf</code>方法的声明如下: <code>func TypeOf(i interface{}) Type</code>。</p>
<p>它接收一个__空接口类型变量__<code>i</code>作为参数，返回一个<code>Type</code>变量，代表了传入参数的类型。由于这个函数的参数是__空接口类型__，所以即使我们传入了一个其他类型的变量，参数也首先会被转换成__空接口类型__。</p>
<h3 id="valueof-方法">ValueOf 方法</h3>
<p><code>reflect.ValueOf</code>方法的声明如下：<code>func ValueOf(i interface{}) Value</code></p>
<p>它返回一个<code>Value</code>变量代表传入参数<code>i</code>运行时的数据。</p>
<p><code>Value.Interface()</code>方法是<code>ValueOf</code>方法的逆向方法，<code>Value</code>可以通过<code>Interface()</code>转换成接口。</p>
<h3 id="zero-方法">Zero 方法</h3>
<p><code>reflect.Zero</code>方法的声明如下: <code>func Zero(typ Type) Value</code></p>
<p>它接收一个<code>Type</code>变量，并且返回一个<code>Value</code>变量代表<code>typ</code>所对应的0值。</p>
<h3 id="kind-类型">Kind 类型</h3>
<p><code>reflect.Value</code>和<code>reflect.Type</code>类型有一个<code>Kind()</code>方法，它返回一个<code>reflect.Kind</code>类型的变量，代表了反射类型<code>reflect.Type</code>的具体分类。需要注意的是，<code>Kind</code>方法返回的是底层类型，而不是静态声明的类型，如果我们声明了自定义类型<code>type MyInt int</code>，通过<code>Value.Kind()</code>获取的类型仍然为<code>int</code>。具体例子请参考下面这段代码:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;reflect&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">User</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Name</span> <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Age</span>  <span style="color:#204a87;font-weight:bold">int</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">MyInt</span> <span style="color:#204a87;font-weight:bold">int</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">u</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">User</span><span style="color:#000;font-weight:bold">{</span><span style="color:#4e9a06">&#34;xff&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">19</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">i</span> <span style="color:#000">MyInt</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">42</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">t</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">reflect</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">TypeOf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">u</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// reflect.Struct是一个reflect.Kind类型的常量，代表了结构体类型
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Kind</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">reflect</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Struct</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic">// 输出 true
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">t</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">reflect</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">TypeOf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 这里变量i的类型是我们自定义的类型MyInt，但是Type.Kind()方法返回的类型是reflect.Int
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Kind</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">reflect</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Int</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic">// 输出true
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="value-的-settable">Value 的 settable</h3>
<p><code>settable</code>就是表示一个通过空接口反射出来的<code>Value</code>变量是否是可以修改原始的值，通过调用<code>Value.CanSet()</code>方法，我们可以查看某个<code>Value</code>的<code>settable</code>属性。那么什么情况下<code>Value</code>变量可以修改原始的值呢？请参考下面这段代码:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;reflect&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">x</span> <span style="color:#204a87;font-weight:bold">float64</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">4.1</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">xPointerValue</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">reflect</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ValueOf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">xPointerValue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CanSet</span><span style="color:#000;font-weight:bold">())</span>  <span style="color:#8f5902;font-style:italic">// 输出 false
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 只有 Interface 或 Ptr 类型的 Value 才能调用 Elem 方法
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">xPointerValueElem</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">xPointerValue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Elem</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">xPointerValueElem</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CanSet</span><span style="color:#000;font-weight:bold">())</span> <span style="color:#8f5902;font-style:italic">// 输出 true
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">xValue</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">reflect</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ValueOf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">xValue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CanSet</span><span style="color:#000;font-weight:bold">())</span>  <span style="color:#8f5902;font-style:italic">// 输出 false
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">_</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">xValue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Elem</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#8f5902;font-style:italic">// 这里程序会报 panic
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>我们可以看到，变量<code>x</code>反射出来的变量<code>xValue</code>是不能修改原始值的，这是因为<code>reflect.ValueOf</code>方法其实是将<code>x</code>赋值到了一个空接口变量<code>o</code>上，<code>o</code>中保存的是<code>x</code>的拷贝和<code>x</code>的类型描述器，而<code>ValueOf()</code>方法返回的<code>xValue</code>变量指向的就是空接口变量<code>o</code>中保存的<code>x</code>的拷贝。如果<code>xValue</code>变量可以修改原始值，那么修改的也仅仅只是<code>x</code>的拷贝，并不能够修改<code>x</code>本身，所以<code>xValue</code>是不可修改的。</p>
<p>指针<code>&amp;x</code>反射出来的<code>xPointerValue</code>也是不能修改原始值的，原理和上文中讲述的类似，<code>xPointerValue</code>指向的是空接口变量<code>o</code>中保存的<code>x</code>的指针的拷贝，这个指针中保存的地址是不可修改的。</p>
<p>但是<code>xPointer</code>调用<code>Elem()</code>方法获取到的<code>xPointerValueElem</code>变量就是可以修改原始值的了，这是因为<code>xPointerValue.Elem()</code>方法返回的是这个指针指向的值，也就是<code>x</code>，也就是说<code>xPointerValueElem</code>指向的就是<code>x</code>，所以<code>xPointerValueElem</code>就是可以修改原始值的了。</p>
<p>这里的内容比较绕，理解起来可能不太容易，大家可以参考下面的图进行理解：</p>
<p><img src="http://owcwlb3jm.bkt.clouddn.com/2017-09-16-1505538303474.jpg" alt="golang-reflect"></p>
<h2 id="反射的示例">反射的示例</h2>
<p>OK，讲了一大串的理论，大家忍不住想要通过代码来验证一下自己的想法了吧，我们接下来就会通过几个例子，来演示一下 Golang 中反射的具体用法。</p>
<h3 id="简单数据的类型和内容解析">简单数据的类型和内容解析</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;reflect&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">x</span> <span style="color:#204a87;font-weight:bold">float64</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">4.1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">v</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">reflect</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ValueOf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Type:&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Type</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Kind is float64:&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Kind</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">reflect</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Float64</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;value:&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">v</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Float</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 输出内容
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// Type: float64
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// Kind is float64: true
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// value: 4.1
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>在上述代码中，我们设置了一个float64类型的变量x，并通过<code>reflect.ValueOf</code>方法来获取这个变量所对应的<code>reflect.Value</code>，并输出了这个<code>reflect.Value</code>的类型和值。</p>
<h3 id="结构体变量的类型和内容解析">结构体变量的类型和内容解析</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;reflect&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">User</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Id</span>   <span style="color:#204a87;font-weight:bold">int</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Name</span> <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Age</span>  <span style="color:#204a87;font-weight:bold">int</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">u</span> <span style="color:#000">User</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Hello</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 结构体方法的类型名参数其实就是函数的第一个参数，通过反射打印方法类型可以看出
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Hello, World.&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">u</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">User</span><span style="color:#000;font-weight:bold">{</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;wahahah&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">23</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Info</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">u</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">Info</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">o</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// TypeOf获取的某个对象的所有字段的名称和类型
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">t</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">reflect</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">TypeOf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">o</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Type:&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">t</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 由于`Type.Field()`方法只支持结构体类型，所以这里如果传入的变量不是结构体类型会直接返回。
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">k</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Kind</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#000">k</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">reflect</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Error type&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// ValueOf获取的是某个对象的所有字段的值
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Fields:&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">v</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">reflect</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ValueOf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">o</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#000">v</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NumField</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// t.Filed(i) 返回的是一个`reflect.StructField`类型的变量，描述了结构体类型中的某个字段的类型信息
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">field_type</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Field</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// v.Filed(i) 返回了一个`reflect.Value`类型的变量，代表了结构体类型中某个字段的值
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">val</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">v</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Field</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">).</span><span style="color:#000">Interface</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%6s: %v = %v\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">field_type</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">field_type</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Type</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">val</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// Method获取的某个对象的所有方法的名字和类型(即方法签名)
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#000;font-weight:bold">&lt;</span> <span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NumMethod</span><span style="color:#000;font-weight:bold">();</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">m</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Method</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">i</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%6s: %v\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">m</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Type</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>上述代码中，我们遍历了一个结构体类型，输出了它的所有字段的类型和值，还输出了它所有方法的签名。它的输出结果如下所示:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>Type: main.User
</span></span><span style="display:flex;"><span>Fields:
</span></span><span style="display:flex;"><span>    Id: <span style="color:#000">int</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>  Name: <span style="color:#000">string</span> <span style="color:#ce5c00;font-weight:bold">=</span> wahahah
</span></span><span style="display:flex;"><span>   Age: <span style="color:#000">int</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">23</span>
</span></span><span style="display:flex;"><span> Hello: func<span style="color:#ce5c00;font-weight:bold">(</span>main.User<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span></code></pre></div><h3 id="嵌套结构体变量的类型和内容解析">嵌套结构体变量的类型和内容解析</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;reflect&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">User</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Id</span>   <span style="color:#204a87;font-weight:bold">int</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Name</span> <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Age</span>  <span style="color:#204a87;font-weight:bold">int</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">Manager</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">User</span> <span style="color:#8f5902;font-style:italic">// 这是一个匿名字段，这个字段的名称也是User
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">title</span> <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">m</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">Manager</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">User</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000">User</span><span style="color:#000;font-weight:bold">{</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;xff&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">19</span><span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">title</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;manager&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">t</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">reflect</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">TypeOf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">m</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Type: %#v\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Field</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#8f5902;font-style:italic">// 这里把User类型当做一个字段
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Type: %#v\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Field</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">))</span> <span style="color:#8f5902;font-style:italic">// 这里打印的是title字段
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// t.FidleByIndex传入的是一个int的slice，第一个数字表示在大的结构体中的索引，第二个数字表示在User结构体中的索引
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// 打印 User 结构体的 ID 字段
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Type: %#v\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FieldByIndex</span><span style="color:#000;font-weight:bold">([]</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">{</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">}))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 这里获取的是User结构体的 Name 字段
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Printf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Type: %#v\n&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">t</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FieldByIndex</span><span style="color:#000;font-weight:bold">([]</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">{</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">,</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">}))</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="简单数据的内容修改">简单数据的内容修改</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;reflect&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">var</span> <span style="color:#000">x</span> <span style="color:#204a87;font-weight:bold">float64</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">4.1</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">xPointerValue</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">reflect</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ValueOf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">val</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">xPointerValue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Elem</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 检查要更改原始值的 Value 的 settable 属性
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">val</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CanSet</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">val</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SetFloat</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">3.0</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">x</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic">// 输出3.0
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>在上面的代码中，我们演示了如何通过反射来更改一个<code>float64</code>类型变量的值。</p>
<h3 id="结构体类型变量的内容修改">结构体类型变量的内容修改</h3>
<p>下面的代码演示了如何从一个结构体变量中获取字段，并改变这个字段的值。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;reflect&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 本处代码演示的是如何通过反射动态地修改结构体类型的值
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">User</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Id</span>   <span style="color:#204a87;font-weight:bold">int</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Name</span> <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Age</span>  <span style="color:#204a87;font-weight:bold">int</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">u</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">User</span><span style="color:#000;font-weight:bold">{</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;bwangel&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">23</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">u</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">u</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">u</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">Set</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">o</span> <span style="color:#204a87;font-weight:bold">interface</span><span style="color:#000;font-weight:bold">{})</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">pointerValue</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">reflect</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ValueOf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">o</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 判断类型是指针
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">pointerValue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Kind</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">reflect</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Ptr</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">pointerValue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Type</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#4e9a06">&#34;Cannot be set&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// pointerValue.Elem() 了一个Value类型的值， 代表的是这个指针所指向的值
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">pointerValue</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Elem</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">!</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">CanSet</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;is not settable&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 获取字段的名称，并且判断类型是否为字符串
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// Value.IsValid 方法判断一个 Value 类型是否有效地代表了一个值
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">field_name</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#4e9a06">&#34;Name&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">f</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">value</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">FieldByName</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">field_name</span><span style="color:#000;font-weight:bold">);</span> <span style="color:#000">f</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">IsValid</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">f</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Kind</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#000">reflect</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">String</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">f</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">reflect</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">TypeOf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">f</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>			<span style="color:#8f5902;font-style:italic">// Value.SetString 设置了这个类型所代表的对象的值
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#000">f</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SetString</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;xff&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Bad Field&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">field_name</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="结构体变量的方法调用">结构体变量的方法调用</h3>
<p>下面的代码演示了如何通过反射来实现结构体变量方法的调用</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000;font-weight:bold">(</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#4e9a06">&#34;reflect&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">User</span> <span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Id</span>   <span style="color:#204a87;font-weight:bold">int</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Name</span> <span style="color:#204a87;font-weight:bold">string</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">Age</span>  <span style="color:#204a87;font-weight:bold">int</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">u</span> <span style="color:#000">User</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Hello</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">number</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;hello,&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;my name is&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">u</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Name</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">number</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">123</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">u</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">User</span><span style="color:#000;font-weight:bold">{</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;bwangel&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">23</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">u</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Hello</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;xff&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">v</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">reflect</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ValueOf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">u</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">mv</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">v</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">MethodByName</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Hello&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 动态地调用方法传递的参数必须是 reflect.Value 组成的一个切片
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// 可以通过 reflect.ValueOf 将任意值转换成 Value 类型
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">args</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#000">reflect</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Value</span><span style="color:#000;font-weight:bold">{</span><span style="color:#000">reflect</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ValueOf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;xff2&#34;</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">reflect</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ValueOf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">)}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// mv.Call函数执行了实际的方法调用
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#8f5902;font-style:italic">// 它返回的是一个由 Value 类型变量组成的数组([]reflect.Value)，代表了所有的返回值
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">return_vals</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">mv</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Call</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">args</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Println</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">len</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">return_vals</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">return_vals</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">return_vals</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">])</span> <span style="color:#8f5902;font-style:italic">// 输出 `1 [&lt;int Value&gt;] 123`
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="参考链接">参考链接</h2>
<ol>
<li><a href="https://golang.org/pkg/reflect">Go reflect 包的文档</a></li>
<li><a href="https://blog.golang.org/laws-of-reflection">The Laws of Reflection</a></li>
<li><a href="http://www.ucai.cn/index.php?app=fullstack&amp;mod=Train&amp;act=show&amp;cid=69&amp;sid=3259&amp;chid=4707">Go编程基础（无闻）</a></li>
</ol>
</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-f0a22a813c843322c0d360d952e434ce">11 - 性能分析</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-38dd3702bb1bcc7da2f55f43923b479a">11.1 - QPS 和 RT 的关系</h1>
    
	<h2 id="术语说明">术语说明</h2>
<ul>
<li>QPS: Query Per Second</li>
<li>RT: Response Time</li>
<li>RT_CPU: 单个请求中的 CPU 时间</li>
<li>RT_WAIT: 单个请求中除了 CPU 时间外的其他时间(等待时间)</li>
</ul>
<h2 id="结论">结论</h2>
<p>单线程情况下, <code>QPS = 1000 / RT</code></p>
<p>多线程情况下，最好的情况(最佳线程数)是</p>
<blockquote>
<p>QPS = 1000 / RT_CPU</p>
</blockquote>
<blockquote>
<p>最佳线程数 = (RT_CPU+RT_WAIT) / RT_CPU * CPU核心</p>
<ul>
<li>线程数超过 最佳线程数 后, 系统的 QPS 不会再增加了，如果进一步增多，因为多个线程抢夺 CPU 资源导致的时间浪费，QPS 还会下降。</li>
</ul>
</blockquote>
<h2 id="说明">说明</h2>
<p>一个请求我们除了有 CPU 执行时间外，还有等待时间(等待IO/等待锁资源)。</p>
<ul>
<li>如果单个请求的等待时间占比很高，我们可以增加线程数，提升 CPU 的利用率，这样 QPS 也会随之增加。(CPU 利用率达到 85% 以上才比较正常)
<ul>
<li>线程本身也会消耗资源，它消耗的是 OS 级别的内存，不是进程内存，如果线程数小于 1000, 那么对于系统性能的影响可以忽略不计。</li>
</ul>
</li>
<li>如果单个请求的 CPU 时间占比很高，此时 CPU 成为系统瓶颈，那么系统整体的 QPS 已经没有提升空间了，要么优化程序，减少 CPU 指令数，要么增加 CPU 资源。</li>
<li>我们提升系统 QPS 的目的就是提升 CPU 的利用率，使 CPU 成为系统瓶颈。</li>
</ul>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-f65393dbe42ee15e5a5af9e8946cd970">12 - Thrift</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-1af692bb57d127b768eb69b3abc8a667">12.1 - Thrift golang client 如何设置超时时间</h1>
    
	<h2 id="简介">简介</h2>
<p>本文以 golang thrift binary 协议为例，讲述 thrift golang client 如何设置超时时间</p>
<h2 id="如何设置超时时间">如何设置超时时间</h2>
<p>golang thrift client 有两个超时时间</p>
<ol>
<li>socket timeout</li>
</ol>
<p>在创建 TSocket 的时候，我们可以传入 <code>ConnectTimeout</code> 和 <code>SocketTimeout</code> 两个配置。</p>
<ul>
<li><code>ConnectTimeout</code> 表示建立 TCP 连接的超时时间</li>
<li><code>SocketTimeout</code> 表示读写 Socket fd 时的超时时间</li>
</ul>
<p>当这两个超时触发时，thrift 会返回一个 <code>err.Timeout() == true</code> 的 error, 表示超时错误，thrift 会将其包装成 <code>TTransportException</code>，其 <code>typeId == thrift.TIMED_OUT</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>	<span style="color:#000">rawTransport</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">thrift</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">NewTSocketConf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">net</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">JoinHostPort</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;localhost&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;7303&#34;</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">thrift</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">TConfiguration</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">SocketTimeout</span><span style="color:#000;font-weight:bold">:</span>  <span style="color:#0000cf;font-weight:bold">5</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Second</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">ConnectTimeout</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">5</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Second</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">})</span>
</span></span></code></pre></div><ol start="2">
<li>context timeout</li>
</ol>
<p>在调用 thrift 函数时，需要传入 context 参数，我们可以在 ctx 参数中加上超时</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>		<span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cancel</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">WithTimeout</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Background</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">time</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Second</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">res</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">client</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Triple</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">27</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic">// thrift 调用
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#000">cancel</span><span style="color:#000;font-weight:bold">()</span>
</span></span></code></pre></div><p>根据 context 的工作原理，</p>
<ol>
<li><code>cancel</code> 函数被调用</li>
<li>到了设置的超时时间，golang context 内部的的 goroutine 会调用 cancel 函数</li>
</ol>
<p>当上述两个条件满足其一时，会触发两个函数</p>
<ol>
<li><code>ctx.Done()</code> 返回的 channel 会 close</li>
<li><code>ctx.Error() != nil</code></li>
</ol>
<h2 id="设置超时时间的注意事项">设置超时时间的注意事项</h2>
<ol>
<li>socket timeout 必须比 context timeout 小</li>
<li>在弱网环境下，不能将 socket timeout 设置的非常小, context timeout 设置的特别大</li>
<li>遇到超时错误后应该将连接关闭</li>
</ol>
<p>为什么要遵循这些规则，我们先了解 timeout 工作原理，最后再来解答。</p>
<h2 id="超时时间是如何工作的">超时时间是如何工作的</h2>
<p>为了了解这两个超时时间是如何工作的，我们首先需要理清楚 binary protocol 中函数的调用关系</p>
<h3 id="binary-protocol-中的函数调用关系">binary protocol 中的函数调用关系</h3>
<p>在 <code>lib/go/thrift/protocol.go</code> 函数中，实现了 <code>TProtocol</code> 接口，此接口中定义了若干 ReadXXX 函数，这些函数负责从 Transport 中读取 thrift 请求体和响应体。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">type</span> <span style="color:#000">TProtocol</span> <span style="color:#204a87;font-weight:bold">interface</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// 若干 Write 函数
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>	<span style="color:#000">ReadMessageBegin</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">typeId</span> <span style="color:#000">TMessageType</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">seqid</span> <span style="color:#204a87;font-weight:bold">int32</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ReadMessageEnd</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ReadStructBegin</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ReadStructEnd</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ReadFieldBegin</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">name</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">typeId</span> <span style="color:#000">TType</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">id</span> <span style="color:#204a87;font-weight:bold">int16</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ReadFieldEnd</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ReadMapBegin</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">keyType</span> <span style="color:#000">TType</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">valueType</span> <span style="color:#000">TType</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">size</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ReadMapEnd</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ReadListBegin</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">elemType</span> <span style="color:#000">TType</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">size</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ReadListEnd</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ReadSetBegin</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">elemType</span> <span style="color:#000">TType</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">size</span> <span style="color:#204a87;font-weight:bold">int</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ReadSetEnd</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ReadBool</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span> <span style="color:#204a87;font-weight:bold">bool</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ReadByte</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span> <span style="color:#204a87;font-weight:bold">int8</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ReadI16</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span> <span style="color:#204a87;font-weight:bold">int16</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ReadI32</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span> <span style="color:#204a87;font-weight:bold">int32</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ReadI64</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span> <span style="color:#204a87;font-weight:bold">int64</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ReadDouble</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span> <span style="color:#204a87;font-weight:bold">float64</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ReadString</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ReadBinary</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span> <span style="color:#000;font-weight:bold">[]</span><span style="color:#204a87;font-weight:bold">byte</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">ReadUUID</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">value</span> <span style="color:#000">Tuuid</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#204a87;font-weight:bold">error</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#8f5902;font-style:italic">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p><code>lib/go/thrift/binary_protocol.go</code> 文件提供了 <code>TProtocol</code> 的一种实现，它用于读取 <a href="https://github.com/apache/thrift/blob/master/doc/specs/thrift-binary-protocol.md">binary 协议格式</a>的 thrift 请求/响应。</p>
<p>其中, ReadXXX 函数的调用关系如下:</p>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2023-09-05-215706.png" alt=""></p>
<p>可以看到，除了若干以 <code>End</code> 结尾的函数，和 <code>ReadByte</code>, <code>ReadBool</code> 之外，所有的 Read 函数都调用了 <code>readAll</code> 函数。</p>
<p>而关于 thrift 超时时间的玄机就隐藏在 <code>readAll</code> 函数中</p>
<h3 id="readall-函数中如何检查超时">readAll 函数中如何检查超时</h3>
<p>这是 <code>readAll</code> 函数的代码,</p>
<p><code>read, err = io.ReadFull(p.trans, buf)</code> 表示从 protocol 底层的 transport 读取数据，读完之后进行一个复杂的 if 条件判断，决定重试还是返回错误。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span>	<span style="color:#000">_</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">deadlineSet</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Deadline</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000">read</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#000;font-weight:bold">=</span> <span style="color:#000">io</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ReadFull</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">trans</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">buf</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">deadlineSet</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">read</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">isTimeoutError</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">&amp;&amp;</span> <span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Err</span><span style="color:#000;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>			<span style="color:#8f5902;font-style:italic">// This is I/O timeout without anything read,
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#8f5902;font-style:italic">// and we still have time left, keep retrying.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>			<span style="color:#204a87;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>		<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>		<span style="color:#8f5902;font-style:italic">// For anything else, don&#39;t retry
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>		<span style="color:#204a87;font-weight:bold">break</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">NewTProtocolException</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">err</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>它的 if 条件有四个子条件</p>
<ol>
<li>ctx 设置了 deadline, 即 ctx 用 <code>WithTimeout</code>, <code>WithDeadline</code> 包裹了</li>
<li>protocol 底层的 transport 中读取的数据为0</li>
<li>protocol 底层的 transport 读取时返回的 err 是 timeout error</li>
<li>ctx 的 cancel 函数没有被调用(这也表示 WithTimeout ctx 没有超时)，<code>ctx.Err() == nil</code></li>
</ol>
<p>当四个条件都满足时，它会重新重试，重新从 tranport 中读取数据，否则会将错误返回。</p>
<p>至此，我们可以将 thrift 客户端的超时逻辑梳理清楚了，protocol 通过 transport 去读取数据，当它遇到了 timeout error，但没有读到数据且 ctx 设置的超时时间未到，会重试继续读数据。否则就会返回超时错误。</p>
<p>我们可以用下面这张图来表示</p>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2023-09-05-222326.png" alt=""></p>
<ul>
<li><strong>step1</strong> 表示从 client 开始调用到 socket fd 返回第一个字节经过的时间</li>
<li><strong>step2</strong> 表示从 client 开始接受第一个字节，到接受整个请求所花费的时间</li>
</ul>
<ol>
<li>在 <strong>step1</strong> 中，client 遇到 socket timeout 会进行重试，直到到达了 ctx 设置的时间上限</li>
<li>在 <strong>step2</strong> 中，client 遇到 socket timeout ，大多数时候都是直接返回 timeout error, 只有 <strong>特别极端的案例</strong> ，才会进行重试。</li>
</ol>
<p><strong>特别极端的案例是什么:</strong></p>
<p>假设有这样的响应，</p>
<ol>
<li>socket fd 首先发会了 thrift message header,</li>
<li>正好发完 message header 之后, 网络阻塞了</li>
<li>此时 client 正在调用 <code>ReadFieldBegin</code> 函数读取参数结构体，它遇到 socket timeout error 就会进行重试</li>
</ol>
<p>在 golang server 中，响应是一起发送的，所以不存在 server 主动卡住的请求，TCP 发送字节的情况特别随机，几乎不可能存在正好发送完 message header 就卡住的情况(而且 message header 长度还是可变的)，所以可以认为这种特别极端的情况不存在。</p>
<h2 id="回到注意事项">回到注意事项</h2>
<p>了解完实现细节后，我们再来看文章开头提到的两个注意事项</p>
<ol>
<li>socket timeout 必须比 context timeout 小</li>
</ol>
<p>在上文的 <code>readAll</code> 函数中，当 socket timeout 触发时，会检查是否达到了 context timeout 的限制，如果我们设置了 <code>socket timeout</code> &gt; <code>context timeout</code>, 那么就会存在 <code>context timeout</code> 到了限制时间，但函数仍然阻塞在 <code>transport.Read</code> 中的情况</p>
<ol start="2">
<li>弱网环境中，socket timeout 不能设置的特别小</li>
</ol>
<p>在上一节的分析中，我们知道了在 <strong>step2</strong> 中遇到了 <code>socket timeout</code>时, 请求会直接失败，返回 <code>timeout error</code>。</p>
<p>那么在弱网环境中，如果我们将 <code>socket timeout</code> 设置的很小，但是 <code>context timeout</code> 很大，那么会遇到很多在 <strong>step2</strong> 中因为 <code>socket timeout</code> 导致的超时错误，而 <code>context timeout</code> 实际上还远远达不到。</p>
<ol start="3">
<li>遇到超时错误后，应该将连接关闭</li>
</ol>
<p>如果遇到超时错误了，client 会直接返回错误，但是过了一段时间 server 又将响应发回来了，后续的 <strong>新请求</strong> 就可能读到 <strong>旧响应</strong> 。</p>
<p>此时因为 thrift 请求和响应的 seq_id 或 method name 对不上，就会返回错误</p>
<pre tabindex="0"><code>{method_name}: out of order sequence response // seq id 对不上
{method_name}: wrong method name  // 方法名对不上
</code></pre><p>这部分检查代码在 <a href="https://github.com/apache/thrift/blob/v0.18.1/lib/go/thrift/client.go#L56-L66"><code>lib/go/thrift/client.go:56</code></a> 文件的 <code>func (p *TStandardClient) Recv</code> 函数中</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">func</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">p</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">TStandardClient</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000">Recv</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Context</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">iprot</span> <span style="color:#000">TProtocol</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">seqId</span> <span style="color:#204a87;font-weight:bold">int32</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">method</span> <span style="color:#204a87;font-weight:bold">string</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">result</span> <span style="color:#000">TStruct</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">error</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000">rMethod</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rTypeId</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">rSeqId</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">:=</span> <span style="color:#000">iprot</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">ReadMessageBegin</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">ctx</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#204a87;font-weight:bold">nil</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">err</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">method</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">rMethod</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">NewTApplicationException</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">WRONG_METHOD_NAME</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%s: wrong method name&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">method</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span>	<span style="color:#000;font-weight:bold">}</span> <span style="color:#204a87;font-weight:bold">else</span> <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000">seqId</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#000">rSeqId</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>		<span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">NewTApplicationException</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">BAD_SEQUENCE_ID</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">fmt</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Sprintf</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;%s: out of order sequence response&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">method</span><span style="color:#000;font-weight:bold">))</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">...</span>
</span></span></code></pre></div>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-b127652654fb8cc62d6983427adc109f">12.2 - Thrift 协议学习笔记</h1>
    
	<p>本文主要讲了 thrift 的协议格式</p>
<hr>
<p>Thrift 是一个集序列化和服务通信功能于一身的 RPC 框架，主要包含三大部分，代码生成，序列化框架，RPC 框架。</p>
<p>Thrift 支持多种序列化协议，主要有 Binary, Compact, JSON, 本文主要讲解了 Binary 和 Compact 序列化协议。</p>
<h1 id="thrift-请求响应模型">Thrift 请求响应模型</h1>
<p>Binary 协议和 Compact 协议都假定底层的 transport 层会提供一个允许双向通信的字节流信道(例如 TCP 套接字)。它们都使用了如下的通信模式:</p>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2023-01-11-113200.png" alt=""></p>
<ol>
<li>Client 发送 Message 给 Server, Message 主要包括方法名，参数以及一些元信息</li>
<li>Client 将方法参数当作一个 Struct 发给 Server</li>
<li>Server 处理完后，发送 Message 给 Client。Message 主要包括方法名，消息类型和一些元信息</li>
<li>Server 发送 Struct 给 Client, 这个 Struct 包括响应或异常 body</li>
</ol>
<h2 id="binary-协议">Binary 协议</h2>
<h3 id="message-格式">Message 格式</h3>
<h4 id="编码格式">编码格式</h4>
<p>Binary 协议中, Message 的格式如下 (strict encoding)</p>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2023-01-11-121420.png" alt=""></p>
<table>
<thead>
<tr>
<th>字节索引</th>
<th>功能说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>第1字节的第一位固定是1, 表示使用 strict encoding</td>
</tr>
<tr>
<td>1-2</td>
<td><code>vvv</code> 前两个字节的后15位表示版本号, 固定是 1 (二进制格式是 <code>000 0000 0000 0001</code>)</td>
</tr>
<tr>
<td>3</td>
<td><code>unused</code> 第三个字节 unused 表示它不使用</td>
</tr>
<tr>
<td>4</td>
<td><code>mmm</code> 第四个字节格式为 00000mmm，后三位表示消息的类型</td>
</tr>
<tr>
<td>4-8</td>
<td><code>name length</code> 4-8 字节存储方法名的长度，它是一个32位有符号整数，使用大端序存储，这意味着方法名最长是 2^31-1</td>
</tr>
<tr>
<td>8..</td>
<td><code>name</code> 8字节后存储变长的方法名字符串，它使用 utf-8 编码</td>
</tr>
<tr>
<td>&hellip;4-end</td>
<td><code>seq id</code> 最后四个字节存储序列号</td>
</tr>
</tbody>
</table>
<h4 id="消息类型">消息类型</h4>
<table>
<thead>
<tr>
<th>Value</th>
<th>Binary</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>001</td>
<td><code>Call</code>: thrift 调用</td>
</tr>
<tr>
<td>2</td>
<td>010</td>
<td><code>Reply</code>: thrift 响应</td>
</tr>
<tr>
<td>3</td>
<td>011</td>
<td><code>Exception</code>: thrift server 返回了异常</td>
</tr>
<tr>
<td>4</td>
<td>100</td>
<td><code>Oneway</code>: thrift oneway 调用</td>
</tr>
</tbody>
</table>
<h4 id="序列号">序列号</h4>
<p>序列号是有符号的四字节整数，在一个传输层的连接上所有未完成的请求必须有唯一的序列号，客户端用序列号来处理响应的失序到达，实现请求和响应的匹配。服务端不需要检查序列号，也不应该在实现中对序列号有任何的依赖，只需要在响应的时候将其原样返回。</p>
<h4 id="old-encoding">old encoding</h4>
<p>上述讲的 binary 协议中的 strict encoding, 在 thrift 早期版本中，使用的是 old encoding 编码方式。old encoding 的编码方式如下</p>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2023-01-11-123231.png" alt=""></p>
<p>它没有版本号等信息，直接传输了方法名，类型以及 seq id</p>
<p>因为 old encoding 中，<code>name length</code> 是使用32位有符号数存储的，因为 <code>name length</code> 不能为负数，所以 old encoding 的第一位始终是0 (<code>name length</code> 在最前面)。strict encoding 中，将第一位设置成了1, 以此来区分 old encoding 和 strict encoding。</p>
<h3 id="struct-格式">struct 格式</h3>
<p>Struct 类型由两部分组成: Field + StopField</p>
<pre tabindex="0"><code>Struct := Field + StopField
Field := Field Header + Field Value
Field Header := field id + field value
</code></pre><p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2023-01-11-130322.png" alt=""></p>
<p>StopField 长度一个字节，全都置0，表示 Struct 或 Request/Response Body 的结束</p>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2023-01-11-130230.png" alt=""></p>
<p>Normal Field 的格式如上图所示，字段说明如下</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>tttttttt</td>
<td>field 类型，一个8位的有符号整数</td>
</tr>
<tr>
<td>field id</td>
<td>16位的有符号整数，使用大端字节序存储</td>
</tr>
<tr>
<td>field value</td>
<td>编码后的 field value</td>
</tr>
</tbody>
</table>
<p>field 类型的定义表</p>
<table>
<thead>
<tr>
<th>类型</th>
<th>field type number</th>
</tr>
</thead>
<tbody>
<tr>
<td>bool</td>
<td>2</td>
</tr>
<tr>
<td>byte</td>
<td>3</td>
</tr>
<tr>
<td>double</td>
<td>4</td>
</tr>
<tr>
<td>i16</td>
<td>6</td>
</tr>
<tr>
<td>i32</td>
<td>8</td>
</tr>
<tr>
<td>i64</td>
<td>10</td>
</tr>
<tr>
<td>string</td>
<td>11, used for binary and string fields</td>
</tr>
<tr>
<td>struct</td>
<td>12, used for struct and union fields</td>
</tr>
<tr>
<td>map</td>
<td>13</td>
</tr>
<tr>
<td>set</td>
<td>14</td>
</tr>
<tr>
<td>list</td>
<td>15</td>
</tr>
</tbody>
</table>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2023-01-11-130956.png" alt=""></p>
<p>上图是一个 thrift 请求的抓包，可以看到此请求的 struct 中，共有三个 Field，分别存储了 1, 0, 4 这三个 I32 整数。</p>
<h3 id="list-和-set-的格式">list 和 set 的格式</h3>
<p>list 和 set 类型使用的是相同的格式，如下图所示:</p>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2023-01-11-145100.png" alt=""></p>
<ul>
<li>tttttttt 表示集合元素类型，被编码成了 i8</li>
<li>size 表示集合中元素的格式，被编码成了 i32 (32位有符号整数)，且只允许是正数</li>
<li>elements 表示元素</li>
</ul>
<p>集合中元素的类型和 struct 中 field-types 使用相同的定义。</p>
<p>可以配置 list/set 最大的长度，默认没有设置，即是 i32 的最大值，(2^31-1, 2147483647)</p>
<h3 id="binarystring-格式">binary/string 格式</h3>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2023-01-11-170954.png" alt=""></p>
<p>binary 类型的格式如上图所示，4个字节的长度 + values。长度是 32位的有符号整数，这意味着 binary 数据的最大长度是 2^32-1, 2147483647</p>
<p>string 类型被 encode 成 utf-8 编码，然后使用 binary 的格式传输。</p>
<h3 id="map-格式">map 格式</h3>
<p>map 的格式如下:</p>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2023-01-11-145643.png" alt=""></p>
<ul>
<li>kkkkkkkk 表示 map 中 key 的元素类型，被编码成了 i8</li>
<li>vvvvvvvv 表示 map 中 value 的元素类型，被编码成了 i8</li>
<li>size 表示 map 的大小，被编码成了 i32，只允许是正数</li>
<li>key value pairs 表示被编码后的 key-value 对。</li>
</ul>
<p>可以配置 map 最大的长度，默认没有设置，即是 i32 的最大值，(2^31-1, 2147483647)</p>
<h3 id="request-格式">request 格式</h3>
<p>thrift Request 由两部分组成, Message + Data</p>
<ol>
<li>Message 的格式参考上文</li>
<li>Data 使用 struct 格式序列化的方法的参数</li>
</ol>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2023-01-11-150009.png" alt=""></p>
<p>上图是用 wireshark 抓到的 thrift 请求:</p>
<ol>
<li>它是一个 Call 消息，方法名是 <code>calculate</code>, seq id 是 0</li>
<li>它有两个参数，第一个参数是 i32 整数，第二个参数是一个结构体，这两个参数被用 struct 的方式序列化起来，变成了 Data</li>
</ol>
<h3 id="response-格式">response 格式</h3>
<p>thrift Response 由两部分组成，Message + Data</p>
<ol>
<li>Message 的格式参考上文</li>
<li>Data 是函数的返回值，它以 struct 的方式序列化，
<ul>
<li>返回值的 field id == 0 时，表示这是一个正常的响应</li>
<li>返回值的 field id == 1 时，表示这个响应是 server 抛出了一个 thrift idl 文件中定义的异常</li>
</ul>
</li>
</ol>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2023-01-11-151113.png" alt=""></p>
<p>上图抓到的 thrift 响应的包:</p>
<ul>
<li>Message 部分表示它是一个 Reply 类型的消息。</li>
<li>Data 部分，由于 field id == 1, 表示它返回了一个异常。</li>
<li>整个 Data 部分是一个 struct 格式的响应体，异常又是一个 struct 格式的数据</li>
<li>响应的异常包含了 i32 数字和 string 两个字段。</li>
</ul>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2023-01-11-151113.png" alt=""></p>
<h3 id="exception-格式">exception 格式</h3>
<p>thrift exception 响应表示 thrift server 出现了某种错误，无法正确地处理请求</p>
<p>它由两部分组成: Message + Exception</p>
<ol>
<li>Message 的格式参考上文</li>
<li>Exception 的 Data 也是按照 struct 格式来编码的</li>
</ol>
<p>下图是 thrift exception 响应抓取的包:</p>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2023-01-11-173446.png" alt=""></p>
<ul>
<li><code>00 00 00 2e</code> 是 frame 的长度</li>
<li><code>80 01 ... 6b 00 00 00 00</code> 这是 Message 的定义</li>
<li><code>0b</code> 表示第一个 field 是一个 string</li>
<li><code>00 01</code> 表示 field id == 1</li>
<li><code>00 00 00 0e</code> 表示 string 的长度是 14</li>
<li><code>49 6e 74 65 72 6e 61 6c 20 65 72 72 6f 72</code> 表示 <code>Internal error</code> 这个字符串</li>
<li><code>08</code> 表示第二个 field 是一个 i32</li>
<li><code>00 02</code> 表示 field id == 2</li>
<li><code>00 00 00 06</code> 表示 i32 的 值是6</li>
<li><code>00</code> 表示 StopField，代表这个 Struct 结束了</li>
</ul>
<p>thrift exception 中数字的含义如下:</p>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2023-01-11-173956.png" alt=""></p>
<h2 id="compact-协议">Compact 协议</h2>
<h3 id="var-int">var int</h3>
<p>Compact 协议中，使用 var int + zigzag int 的方式来将整数进行编码</p>
<ol>
<li>i32, i64 格式的整数被转换成 zigzag 格式的整数，这样所有整数都使用非负整数的格式存储</li>
<li>zigzag 整数被编码成了 var int 变长整数。i32 整数消耗 1-5 个字节，i64 整数消耗 1-10 个字节。</li>
</ol>
<ul>
<li>i16 首先被转换成 i32 之后，再进行 zigzag + var int 编码, i8 数字不会进行编码，直接进行传输。</li>
</ul>
<p>关于 zigzag 以及变长整数编码，可以参考我的另一篇文章: <a href="/2022/03/01/variant_zigzag/">ZigZag 变长整数编码</a></p>
<h3 id="message-如何编码">Message 如何编码</h3>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2023-01-11-125326.png" alt=""></p>
<p>Compact 协议中，Message 的编码格式如上图</p>
<table>
<thead>
<tr>
<th>字段</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>pppppppp</td>
<td>协议 ID, 固定是 0x82, 1000 0010</td>
</tr>
<tr>
<td>mmm</td>
<td>消息类型，和 binary 协议中的消息类型定义相同</td>
</tr>
<tr>
<td>vvvvv</td>
<td>协议版本，无符号5位整数，固定是 00001</td>
</tr>
<tr>
<td>seq id</td>
<td>序列号 ID, 一个32位有符号整数被编码成了 var int</td>
</tr>
<tr>
<td>name length</td>
<td>方法名长度，一个有符号32位整数被编码成了 var int (name length &gt;= 0)</td>
</tr>
<tr>
<td>name</td>
<td>方法名, utf-8 编码的字符串</td>
</tr>
</tbody>
</table>
<h2 id="framed-vs-unframed">framed vs unframed</h2>
<ul>
<li>
<p>unframed 会将数据直接写入到 socket</p>
</li>
<li>
<p>使用 framed 格式，client/server 先将 request/response 写入到一个 buffer 中。最后向 socket 写入时，先写入一个四字节的 request/response 长度，再写入 request/response。</p>
</li>
<li>
<p>framed 格式下，请求的最大长度是 16384000 (16M)</p>
</li>
<li>
<p>thrift 引入 framed 格式的目的是为了方便异步处理器的实现。</p>
</li>
</ul>
<h2 id="参考链接">参考链接</h2>
<ul>
<li><a href="https://andrewpqc.github.io/2019/02/24/thrift/">Thrift序列化协议浅析</a></li>
<li><a href="https://erikvanoosten.github.io/thrift-missing-specification/">Thrift specification - Remote Procedure Call</a></li>
<li><a href="https://www.bwangel.me/2022/03/01/variant_zigzag/">ZigZag 变长整数编码</a></li>
</ul>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-1bb16dc0ca8a634867ed72c7e903ba28">12.3 - Thrft</h1>
    
	<h2 id="thrift-概念">thrift 概念</h2>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2018-05-27-060022.png" alt=""></p>
<h2 id="thrift-架构">thrift 架构</h2>
<p>Thrift 的架构图如下</p>
<p><img src="https://passage-1253400711.cos-website.ap-beijing.myqcloud.com/2021-12-17-100303.png" alt=""></p>
<p>Transport 层位于最底部，用户传输字节数据。</p>
<p>Transport 层提供的接口如下:</p>
<p><img src="https://passage-1253400711.cos-website.ap-beijing.myqcloud.com/2021-12-17-100415.png" alt=""></p>
<p>Transport 层可以由多个 TTransport 类组合起来，每个 TTransport 提供不同的功能。处于 TTransport 组合层次最下方，和设备(网络，磁盘，内存)直接打交道的 TTransport 类称为 <strong>Endpoint transports</strong>。例如 <code>TSocket</code>，它使用 Socket API 在 TCP/IP 网络上传输数据。</p>
<p><code>TFramedTransport</code> 有两个作用:</p>
<ol>
<li>分帧，它在每个消息的头部加了四字节的长度，让接受者能够准确地得知消息的大小，并申请合适的 buffer</li>
<li>缓存。当 <code>flush</code> 方法调用的时候，缓存的数据才会写入下一层 Transport</li>
</ol>
<p>当不需要分帧，仅需要缓存的时候，可以使用 <code>TBufferedTransport</code>。某些语言在 Endpoint Transport 中內建了缓存机制，就没有提供 <code>TBufferedTransport</code> 类。</p>
<h2 id="参考链接">参考链接</h2>
<ul>
<li><a href="https://livebook.manning.com/book/programmers-guide-to-apache-thrift/chapter-2/18">Chapter 2. Apache Thrift architecture</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-d3ce439f30c5ecaccd3e7225d6be37c5">12.4 - 翻译《Chapter 1. Introduction to Apache Thrift》</h1>
    
	<blockquote>
<ul>
<li>原文地址: <a href="https://livebook.manning.com/book/programmers-guide-to-apache-thrift/chapter-1/">https://livebook.manning.com/book/programmers-guide-to-apache-thrift/chapter-1/</a></li>
</ul>
</blockquote>
<hr>
<h2 id="12-与apache-thrift的应用集成">1.2. 与Apache Thrift的应用集成</h2>
<p>无论你的应用程序是否使用多平台和语言，它的操作很可能基于网络和时间跨越多个进程。有时，这些进程需要通过磁盘上的文件，内存中的缓冲区，或者网络进行通信。和 IPC (Interprocess communication) 相关的两个核心概念是:</p>
<ol>
<li>类型序列化</li>
<li>服务实现</li>
</ol>
<p>让我们依次来考虑这两个问题。</p>
<h3 id="121-类型序列化">1.2.1 类型序列化</h3>
<p>序列化是任何跨平台/语言通信的基本功能。例如，想象一下一个音乐行业应用程序，使用 NATS 作为消息系统，在进程之间移动歌曲数据。使用 NATS，该团队可以在他们用 Java 或 Python 编写的远程进程之间快速发送/接收消息。问题是，当歌曲信息在进程之间传递时，程序能读懂另一个进程发送的信息吗？Python 对象和 Java 对象在内存中的表示方式不同。如果 Python 进程发送音乐轨道数据的原始内存信息，就会出现问题。</p>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com//2021-12-17-145118.png" alt=""></p>
<p>为了解决这个问题，我们需要在信息传输平台上创建一个数据序列化层。有人可能会问，为什么不用 JSON 的形式来回发送一切呢？使用标准格式(例如 JSON) 可能是解决方案的一部分; 然而，我们仍必须回答这样的问题：</p>
<p>当发送多字段消息时，数据字段如何排序？ 当字段缺失时，会发生什么？一个不直接支持某种数据类型的语言在接收该数据类型的时，会做些什么？这些以及其他的问题，JSON, YAML 或 XML 等数据布局规范都无法解决。对于同一个数据集，不同语言经常产生不同但合法的格式。</p>
<ul>
<li><strong>IDL and Types</strong></li>
</ul>
<p>Apache Thrift提供了一个模块化的序列化框架来解决这些问题。
通过Apache Thrift，开发者在接口定义语言（IDL）中定义抽象数据类型。 然后这个IDL可以被编译成任何支持的语言的源代码。 生成的代码为用户定义的所有类型提供完整的序列化和反序列化逻辑。
Apache Thrift确保任何语言编写的类型都可以被任何其他语言读取。下面的代码显示了一个假设的音乐应用程序的Apache Thrift IDL 类型定义。</p>
<pre tabindex="0"><code>namespace * music

enum PerfRightsOrg {
    ASCAP = 1
    BMI = 2
    SESAC = 3
    Other = 4
}

typedef double Minutes

struct MusicTrack {
    1: string title
    2: string artist
    3: string publisher
    4: string composer
    5: Minutes duration
    6: PerfRightsOrg pro
}
</code></pre><p>有人抱怨说创建 IDL 是一个额外的步骤，减缓了开发进程。我发现恰恰相反。IDL 强迫你独立地小心考虑你的接口设计，而无需关心嘈杂的实现代码。这可能是你花在系统设计上最终要的时间。IDL 也是轻量级，易于修改和实验，并经常作为业务方面的通信工具而发挥作用。</p>
<p>用户可能会说无模式的系统更加灵活，而 IDL 很坚硬。事实上是，无论你是否记录了你的模式，当你读取和解释数据的时候，你都会需要一个模式。隐含模式会是非常危险的线上错误的来源，而且会给想要操作数据或扩展系统的人造成负担。</p>
<p>如果，除了读取和写入的代码，除此之外你对你读写的数据没有任何定义。当你想扩展系统的时候进展就会很缓慢。整个系统有多少代码依赖于这样的隐含模式？你如何改变这样一个东西？</p>
<p>许多无模式的 NoSQL 系统的流行，为 IDL 创造了另外一个角色。你现在可以在一个地方记录你的类型，并在使用消息系统和 NoSQL 存储系统(Redis, MongoDB 或其他 NoSQL 系统)的服务调用中使用这些类型。</p>
<p>有几个系统反其道而行之，从一个给定的编码方案中生成它们的模式。注释驱动的系统，如Java的JAX-RS，就以这种方式工作。这种方法很容易让实现细节影响接口定义，使可移植性和清晰性受到限制。一般来说，修改实现代码要比修改IDL的工作量大得多。另外，你不能保证另一个供应商的代码生成器会从一个外部模式中创建兼容的代码。当多个供应商参与到一个通信解决方案中时，这就是一个问题。</p>
<p>Apache Thrift通过提供唯一定义 Schema 来源，即 IDL ，避免了许多这些问题。Apache Thrift提供了独立于供应商的支持，在广泛的编程语言中使用单一的IDL，并且Apache Thrift的跨语言测试套装随着框架的发展不断地验证互操作性。</p>
<ul>
<li><strong>Interface evolution (接口演变)</strong></li>
</ul>
<p>IDL 创建了一个各方都可以依赖的契约，代码生成器可以用来创建工作的序列化操作，确保契约得到遵守。然而，IDL模式不需要很脆(brittle)。Apache Thrift IDL支持一系列的接口演化功能，如果使用得当，允许添加和删除字段，改变类型，等等。</p>
<p>对接口进化的支持大大简化了持续的软件维护和扩展的任务。现代工程意识，如微服务、持续集成（CI）和持续交付（CD）要求系统支持增量改进，而不影响平台的其他部分。那些不提供接口进化形式的工具，在改变时往往会 &ldquo;破坏世界&rdquo;。在这样的系统中，改变接口意味着所有使用该接口的客户端和服务器必须重写或重新编译，然后在大爆炸中重新部署。</p>
<p>Apache Thrift的接口进化功能允许多个接口版本在一个操作环境中无缝共存。这使得增量更新成为可能，使CI/CD管道成为可能，并使各个敏捷团队能够以他们自己的节奏交付商业价值。</p>
<ul>
<li><strong>Modular serialization</strong></li>
</ul>
<p>Apache Thrift提供了可插拔的序列化器，被称为协议，允许你使用几种序列化格式中的任何一种进行数据交换，包括 Binary (速度快)，compact(体积小)，以及JSON(可读性好)。即使你改变了序列化协议，同样的契约（IDL）也可以保持原样。这种模块化的方法也允许添加自定义的序列化协议。由于Apache Thrift是社区管理和开源的，你可以很容易地改变或增强功能，并在需要时向上游推送（Apache Thrift项目始终欢迎补丁）。</p>
</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-e3393de7e8466911640490b15485a33d">13 - 规范</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-e0e47e08b609b222268e029cf0817880">13.1 - 日期和时间格式</h1>
    
	<h2 id="w3-时间规范">w3 时间规范</h2>
<ul>
<li>ISO 8601 定义了大量的日期/时间格式，为了简化开发 &amp; 减少 bug, <a href="https://www.w3.org/TR/NOTE-datetime">w3 规范</a>定义了一个通用的时间格式
<ul>
<li><code>YYYY-MM-DDThh:mm:ss.STZD</code>
<ul>
<li>YYYY/MM/DD 四位数年份/月/日</li>
<li>T 表示后面跟了一个时间</li>
<li>hh:mm:ss 两位数的时分秒</li>
<li>S 一位或多位小数表示秒的一部分，最小是1, 最大不限制</li>
<li>TZD 时区指示符</li>
</ul>
</li>
</ul>
</li>
<li>W3 规范规定 TZD 可以有两种形式
<ol>
<li>表示一个 UTC 时间，TZD 可以写成一个 <code>Z</code>, 例如 <code>1994-11-05T13:15:30Z</code> 表示 utc 时间</li>
<li>表示本地时间, TZD 写成 <code>+HH:MM</code> 或 <code>-HH:MM</code>，表示当地时间相对 utc 时间的偏移量, 例如 <code>1994-11-05T13:15:30+08:00</code> 表示东八区时间，即北京时间</li>
</ol>
</li>
<li>协调世界时的缩写为UTC。国际电信联盟希望协调世界时能够在所有语言有单一的缩写。英语和法语区的人同时希望各自的语言缩写－CUT (Coordinated Universal Time) 和 TUC (Temps Universel Coordonné) 能够成为国际标准，最后妥协使用UTC。</li>
</ul>
<h2 id="参考链接">参考链接</h2>
<ul>
<li><a href="https://www.w3.org/TR/NOTE-datetime">Date and Time Formats</a></li>
<li><a href="https://blog.csdn.net/hsany330/article/details/70332483">关于时间格式 2016-08-9T10:01:54.123Z 20160809100154.123Z 处理方法</a></li>
<li><a href="https://zh.m.wikipedia.org/zh-hans/%E5%8D%8F%E8%B0%83%E4%B8%96%E7%95%8C%E6%97%B6#cite_ref-29">协调世界时</a></li>
</ul>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-546aa9afbb590e86cfb9df263df9d01c">14 - 编辑器</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-e9fb0115d808edb36ba1a3f492e95c4d">14.1 - Pycharm</h1>
    
	<h2 id="tabs---open-in-opposite-group">Tabs -&gt; Open in Opposite Group</h2>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2023-08-07-122300.png" alt=""></p>
<p>如图，窗口被分成了左右两个组。如果我想在右边的窗口组打开 <code>client.go</code> 文件，<strong>同时左边的文件不关闭</strong></p>
<p>可以右键点击 Tab 选择 <code>Open In Opposite Group</code>。</p>
<p>我在设置中将这个功能的快捷键设置成了 <code>Alt+Shift+H</code></p>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-5990d373ac824b52e97a76c2b3e2ff2c">15 - Linux</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-1c2b211e34ea807b66d53c40bac236f2">15.1 - curl</h1>
    
	<h2 id="curl-post-json-数据">curl POST JSON 数据</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>curl -X PUT -H <span style="color:#4e9a06">&#34;Content-Type: application/json&#34;</span> -d <span style="color:#4e9a06">&#39;@/tmp/demo.json&#39;</span> :9200/demo
</span></span><span style="display:flex;"><span>ø&gt; cat /tmp/demo.json
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#4e9a06">&#34;settings&#34;</span>: <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;number_of_shards&#34;</span>: 1,
</span></span><span style="display:flex;"><span>        <span style="color:#4e9a06">&#34;number_of_replicas&#34;</span>: <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="使用---resolve-选项替换域名">使用 <code>--resolve</code> 选项替换域名</h2>
<ul>
<li>将 <a href="https://www.google.com">www.google.com</a> 替换成 127.0.0.1，并访问 8000 端口</li>
</ul>
<p><code>curl -v --resolve www.google.com:8000:127.0.0.1 http://www.google.com:8000/ping</code></p>
<ul>
<li>将 <a href="https://www.google.com">https://www.google.com</a> 替换成 127.0.0.1，此时 curl 会忽略证书和域名不匹配的问题</li>
</ul>
<p><code>curl -v --resolve www.google.com:443:127.0.0.1 https://www.google.com/ping</code></p>
<ul>
<li>将 <a href="http://www.google.com">http://www.google.com</a> 替换成 127.0.0.1，http 默认访问 80 端口</li>
</ul>
<p><code>curl -v --resolve www.google.com:80:127.0.0.1 http://www.google.com/ping</code></p>
<h2 id="--fail-和---fail-with-body"><code>--fail</code> 和 <code>--fail-with-body</code></h2>
<p>这两个选项都可以让 curl 在接收到 400 及以上的 HTTP 响应码的时候，将退出码设置为 22</p>
<p><code>--fail-with-body</code> 会输出服务端返回的内容到 stdout 或文件中</p>
<p><code>--fail</code> 不会有任何输出，当服务端返回的是认证相关的状态码时(401/407), 可能会让使用者误以为出错了</p>
<h3 id="使用场景">使用场景</h3>
<p>在一个 dockerfile 中，我期望下载项目的 <code>go.mod</code> 和 <code>go.sum</code> 文件，然后再执行 <code>go mod download</code>。
这样可以在 clone 代码之前，先下载 go module 文件。</p>
<p>如果项目的代码变了，但是依赖并没有变，因为 docker build 的缓存原理，可以省去下载 go module 的步骤。</p>
<pre tabindex="0"><code>...
ARG app_repo
ARG app_commit

RUN [[ ! -d /tmp/app ]] &amp;&amp; mkdir /tmp/app &amp;&amp; \
    curl -s https://raw.githubusercontent.com/${app_repo}/${app_commit}/go.mod -o /tmp/app/go.mod &amp;&amp; \
    curl -s https://raw.githubusercontent.com/${app_repo}/${app_commit}/go.sum -o /tmp/app/go.sum

RUN cd /tmp/app &amp;&amp; go mod download
...
</code></pre><p>当 app_repo 和 app_commit 参数错误，导致对应的 go.mod 文件不存在，curl 会得到 404 的 HTTP 响应码，此时我期望 docker build 出错。</p>
<p>但实际上并不会出错，docker build 会继续执行，直到 go mod download 文件无法识别 go.mod 文件，docker build 才会异常退出。</p>
<p>显示的错误内容如下:</p>
<pre tabindex="0"><code>0.467 go: errors parsing go.mod:
0.467 /tmp/app/go.mod:1: unknown directive: 404:
</code></pre><p>当我给 <code>curl</code> 加上了 <code>--fail</code> 选项之后，程序就会在下载 go.mod 出错时直接退出。显示的错误如下:</p>
<pre tabindex="0"><code>ERROR: failed to solve: 
	process &#34;
		/bin/bash -c [[ ! -d /tmp/app ]] &amp;&amp; mkdir /tmp/app &amp;&amp;
		curl --fail -s https://raw.githubusercontent.com/${app_repo}/${app_commit}/go.mod -o /tmp/app/go.mod &amp;&amp;
		curl -s https://raw.githubusercontent.com/${app_repo}/${app_commit}/go.sum -o /tmp/app/go.sum
	&#34; did not complete successfully: exit code: 22
</code></pre><p>最终的 dockerfile 代码及复现命令</p>
<pre tabindex="0"><code>FROM golang:1.19
SHELL [&#34;/bin/bash&#34;, &#34;-c&#34;]

ARG app_repo
ARG app_commit

RUN go env -w GOPROXY=https://goproxy.cn,direct

RUN [[ ! -d /tmp/app ]] &amp;&amp; mkdir /tmp/app &amp;&amp; \
    curl --fail -s https://raw.githubusercontent.com/${app_repo}/${app_commit}/go.mod -o /tmp/app/go.mod &amp;&amp; \
    curl -s https://raw.githubusercontent.com/${app_repo}/${app_commit}/go.sum -o /tmp/app/go.sum

RUN cd /tmp/app &amp;&amp; go mod download
RUN HTTP_PROXY=&#39;http://改成你自己的代理&#39; HTTPS_PROXY=&#39;http://改成你自己的代理&#39; git clone https://github.com/${app_repo}.git ~/app
RUN cd ~/app &amp;&amp; git reset --hard ${app_commit} &amp;&amp; go build .
</code></pre><ul>
<li>复现命令</li>
</ul>
<pre tabindex="0"><code># 注意这个 app_commit 是一个不存在的 commit
docker build -t curl_test --build-arg app_repo=bwangelme/rdcdemo --build-arg app_commit=2f24a0658d7feb0205e7d75b7ae218ff6495e8f3 .
</code></pre>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-a5f545a950366d730141f62b977f5c24">15.2 - lsof</h1>
    
	<h2 id="按照网络状态筛选进程的-fd">按照网络状态筛选进程的 fd</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo lsof -i -sTCP:LISTEN -a -p &lt;pid&gt;
</span></span></code></pre></div><ul>
<li>
<p><code>-a</code> 表示 and, 前后两个条件要一起生效</p>
</li>
<li>
<p><code>-i</code> 和 <code>-s</code> 一起用，表示可以按照 TCP/UDP 状态来筛选 fd</p>
</li>
<li>
<p>列出进程 <code>&lt;pid&gt;</code> 建立的所有 TCP 连接</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo lsof -i -sTCP:ESTABLISHED -a -p &lt;pid&gt;
</span></span></code></pre></div><ul>
<li>列出进程 <code>&lt;pid&gt;</code> 所有 IDLE 状态的 UDP 连接</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo lsof -i -sUDP:IDLE -a -p &lt;pid&gt;
</span></span></code></pre></div><p>根据 Unix 发行版本的不同，TCP/UDP 状态也会有不同的名字:</p>
<ul>
<li>常用的 TCP 状态是: <code>CLOSED</code>, <code>IDLE</code>, <code>BOUND</code>, <code>LISTEN</code>, <code>ESTABLISHED</code>, <code>SYN_SENT</code>, <code>SYN_RCDV</code>, <code>ESTABLISHED</code>, <code>CLOSE_WAIT</code>, <code>FIN_WAIT1</code>, <code>CLOSING</code>, <code>LAST_ACK</code>, <code>FIN_WAIT_2</code>, <code>TIME_WAIT</code>.</li>
<li>常用的 UDP 状态是: <code>Unbound</code>, <code>Idle</code></li>
</ul>
<h2 id="按照-fd-number-查找进程的-fd">按照 fd number 查找进程的 fd</h2>
<p>使用 <code>strace</code> 查看进程的系统调用的时候，经常能够看到在某个 fd 上执行读写操作，例如:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>write<span style="color:#ce5c00;font-weight:bold">(</span>267, <span style="color:#4e9a06">&#34;\1\0\0\0\0\0\0\0&#34;</span>, 8<span style="color:#ce5c00;font-weight:bold">)</span>       <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">8</span>
</span></span><span style="display:flex;"><span>read<span style="color:#ce5c00;font-weight:bold">(</span>5405, <span style="color:#4e9a06">&#34;# Kubernetes-managed hosts file &#34;</span>..., 4096<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">4096</span>
</span></span></code></pre></div><p>我们想要查一下这个 267 和 5405 具体代表了什么连接，可以用</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo lsof -d &lt;fd_number&gt; -a -p &lt;pid&gt;
</span></span></code></pre></div><p>例如我利用 strace 查看飞书 app 的系统调用，看到以下的信息</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ø&gt; sudo strace -p <span style="color:#0000cf;font-weight:bold">8261</span>
</span></span><span style="display:flex;"><span>strace: Process <span style="color:#0000cf;font-weight:bold">8261</span> attached
</span></span><span style="display:flex;"><span>restart_syscall<span style="color:#ce5c00;font-weight:bold">(</span>&lt;... resuming interrupted <span style="color:#204a87">read</span> ...&gt;<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>openat<span style="color:#ce5c00;font-weight:bold">(</span>AT_FDCWD, <span style="color:#4e9a06">&#34;/proc/self/status&#34;</span>, O_RDONLY<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">4</span>
</span></span><span style="display:flex;"><span>read<span style="color:#ce5c00;font-weight:bold">(</span>4, <span style="color:#4e9a06">&#34;Name:\tfeishu\nUmask:\t0002\nState:\t&#34;</span>..., 1024<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1024</span>
</span></span><span style="display:flex;"><span>close<span style="color:#ce5c00;font-weight:bold">(</span>4<span style="color:#ce5c00;font-weight:bold">)</span>                                <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>futex<span style="color:#ce5c00;font-weight:bold">(</span>0x7ff0a7ffead8, FUTEX_WAKE_PRIVATE, 2147483647<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>futex<span style="color:#ce5c00;font-weight:bold">(</span>0x7ff0a7ffea88, FUTEX_WAKE_PRIVATE, 1<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>recvmsg<span style="color:#ce5c00;font-weight:bold">(</span>23, <span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#000">msg_namelen</span><span style="color:#ce5c00;font-weight:bold">=</span>0<span style="color:#ce5c00;font-weight:bold">}</span>, 0<span style="color:#ce5c00;font-weight:bold">)</span>         <span style="color:#ce5c00;font-weight:bold">=</span> -1 EAGAIN <span style="color:#ce5c00;font-weight:bold">(</span>资源暂时不可用<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>recvmsg<span style="color:#ce5c00;font-weight:bold">(</span>23, <span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#000">msg_namelen</span><span style="color:#ce5c00;font-weight:bold">=</span>0<span style="color:#ce5c00;font-weight:bold">}</span>, 0<span style="color:#ce5c00;font-weight:bold">)</span>         <span style="color:#ce5c00;font-weight:bold">=</span> -1 EAGAIN <span style="color:#ce5c00;font-weight:bold">(</span>资源暂时不可用<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>poll<span style="color:#ce5c00;font-weight:bold">([{</span><span style="color:#000">fd</span><span style="color:#ce5c00;font-weight:bold">=</span>9, <span style="color:#000">events</span><span style="color:#ce5c00;font-weight:bold">=</span>POLLIN<span style="color:#ce5c00;font-weight:bold">}</span>, <span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#000">fd</span><span style="color:#ce5c00;font-weight:bold">=</span>10, <span style="color:#000">events</span><span style="color:#ce5c00;font-weight:bold">=</span>POLLIN<span style="color:#ce5c00;font-weight:bold">}</span>, <span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#000">fd</span><span style="color:#ce5c00;font-weight:bold">=</span>22, <span style="color:#000">events</span><span style="color:#ce5c00;font-weight:bold">=</span>POLLIN<span style="color:#ce5c00;font-weight:bold">}</span>, <span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#000">fd</span><span style="color:#ce5c00;font-weight:bold">=</span>23, <span style="color:#000">events</span><span style="color:#ce5c00;font-weight:bold">=</span>POLLIN<span style="color:#ce5c00;font-weight:bold">}</span>, <span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#000">fd</span><span style="color:#ce5c00;font-weight:bold">=</span>67, <span style="color:#000">events</span><span style="color:#ce5c00;font-weight:bold">=</span>POLLIN<span style="color:#ce5c00;font-weight:bold">}]</span>, 5, 0<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span> <span style="color:#ce5c00;font-weight:bold">(</span>Timeout<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>recvmsg<span style="color:#ce5c00;font-weight:bold">(</span>23, <span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#000">msg_namelen</span><span style="color:#ce5c00;font-weight:bold">=</span>0<span style="color:#ce5c00;font-weight:bold">}</span>, 0<span style="color:#ce5c00;font-weight:bold">)</span>         <span style="color:#ce5c00;font-weight:bold">=</span> -1 EAGAIN <span style="color:#ce5c00;font-weight:bold">(</span>资源暂时不可用<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>recvmsg<span style="color:#ce5c00;font-weight:bold">(</span>23, <span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#000">msg_namelen</span><span style="color:#ce5c00;font-weight:bold">=</span>0<span style="color:#ce5c00;font-weight:bold">}</span>, 0<span style="color:#ce5c00;font-weight:bold">)</span>         <span style="color:#ce5c00;font-weight:bold">=</span> -1 EAGAIN <span style="color:#ce5c00;font-weight:bold">(</span>资源暂时不可用<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>poll<span style="color:#ce5c00;font-weight:bold">([{</span><span style="color:#000">fd</span><span style="color:#ce5c00;font-weight:bold">=</span>9, <span style="color:#000">events</span><span style="color:#ce5c00;font-weight:bold">=</span>POLLIN<span style="color:#ce5c00;font-weight:bold">}</span>, <span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#000">fd</span><span style="color:#ce5c00;font-weight:bold">=</span>10, <span style="color:#000">events</span><span style="color:#ce5c00;font-weight:bold">=</span>POLLIN<span style="color:#ce5c00;font-weight:bold">}</span>, <span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#000">fd</span><span style="color:#ce5c00;font-weight:bold">=</span>22, <span style="color:#000">events</span><span style="color:#ce5c00;font-weight:bold">=</span>POLLIN<span style="color:#ce5c00;font-weight:bold">}</span>, <span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#000">fd</span><span style="color:#ce5c00;font-weight:bold">=</span>23, <span style="color:#000">events</span><span style="color:#ce5c00;font-weight:bold">=</span>POLLIN<span style="color:#ce5c00;font-weight:bold">}</span>, <span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#000">fd</span><span style="color:#ce5c00;font-weight:bold">=</span>67, <span style="color:#000">events</span><span style="color:#ce5c00;font-weight:bold">=</span>POLLIN<span style="color:#ce5c00;font-weight:bold">}]</span>, 5, 200<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#ce5c00;font-weight:bold">([{</span><span style="color:#000">fd</span><span style="color:#ce5c00;font-weight:bold">=</span>10, <span style="color:#000">revents</span><span style="color:#ce5c00;font-weight:bold">=</span>POLLIN<span style="color:#ce5c00;font-weight:bold">}])</span>
</span></span><span style="display:flex;"><span>read<span style="color:#ce5c00;font-weight:bold">(</span>10, <span style="color:#4e9a06">&#34;!&#34;</span>, 2<span style="color:#ce5c00;font-weight:bold">)</span>                        <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>futex<span style="color:#ce5c00;font-weight:bold">(</span>0x7ff0a7ffead8, FUTEX_WAKE_PRIVATE, 2147483647<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>futex<span style="color:#ce5c00;font-weight:bold">(</span>0x7ff0a7ffea88, FUTEX_WAKE_PRIVATE, 1<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>futex<span style="color:#ce5c00;font-weight:bold">(</span>0x7ff0a0001eb8, FUTEX_WAKE_PRIVATE, 1<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>openat<span style="color:#ce5c00;font-weight:bold">(</span>AT_FDCWD, <span style="color:#4e9a06">&#34;/proc/self/status&#34;</span>, O_RDONLY<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">4</span>
</span></span><span style="display:flex;"><span>read<span style="color:#ce5c00;font-weight:bold">(</span>4, <span style="color:#4e9a06">&#34;Name:\tfeishu\nUmask:\t0002\nState:\t&#34;</span>..., 1024<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1024</span>
</span></span></code></pre></div><p>我想知道 fd 4 代表了什么，执行 <code>sudo lsof -d 4 -a -p 8261</code>，可以看到它是我的电脑和 <code>220.181.131.241</code> 建立的一个 https 连接。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ø&gt; sudo lsof -d <span style="color:#0000cf;font-weight:bold">4</span> -a -p <span style="color:#0000cf;font-weight:bold">8261</span>
</span></span><span style="display:flex;"><span>COMMAND  PID      USER   FD   TYPE  DEVICE SIZE/OFF NODE NAME
</span></span><span style="display:flex;"><span>feishu  <span style="color:#0000cf;font-weight:bold">8261</span> xuyundong    4u  IPv4 <span style="color:#0000cf;font-weight:bold">2613086</span>      0t0  TCP 192.168.252.88:35810-&gt;220.181.131.241:https <span style="color:#ce5c00;font-weight:bold">(</span>ESTABLISHED<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span></code></pre></div><h2 id="查看端口占用">查看端口占用</h2>
<p>有时候我们启动程序的时候，发现端口被占用了，可以用 <code>lsof -i:xxx</code> 来查看端口被哪个进程占用了，例如:</p>
<p>下面这条命令显示 3306 端口被 <code>360702</code> 和 <code>360709</code> 两个进程占用了。</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>ø&gt; sudo lsof -i:3306
</span></span><span style="display:flex;"><span>COMMAND      PID USER   FD   TYPE  DEVICE SIZE/OFF NODE NAME
</span></span><span style="display:flex;"><span>docker-pr <span style="color:#0000cf;font-weight:bold">360702</span> root    4u  IPv4 <span style="color:#0000cf;font-weight:bold">1842886</span>      0t0  TCP *:mysql <span style="color:#ce5c00;font-weight:bold">(</span>LISTEN<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>docker-pr <span style="color:#0000cf;font-weight:bold">360709</span> root    4u  IPv6 <span style="color:#0000cf;font-weight:bold">1842889</span>      0t0  TCP *:mysql <span style="color:#ce5c00;font-weight:bold">(</span>LISTEN<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span></code></pre></div><h2 id="查看容器的网络调用">查看容器的网络调用</h2>
<h3 id="构建镜像">构建镜像</h3>
<ul>
<li>download.py</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-py" data-lang="py"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#!/usr/bin/env python3</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># -*- coding: utf-8 -*-&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">requests</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">resp</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">requests</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">get</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#39;https://releases.ubuntu.com/22.04.2/ubuntu-22.04.2-desktop-amd64.iso?_ga=2.131295240.668169970.1684741981-917190618.1681460407&#39;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87">print</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">resp</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">status_code</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><ul>
<li>Dockerfile</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">FROM</span><span style="color:#4e9a06"> python:3.10</span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#204a87;font-weight:bold">RUN</span> pip install requests<span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#204a87;font-weight:bold">COPY</span> download.py /download.py<span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000">
</span></span></span><span style="display:flex;"><span><span style="color:#a40000"></span><span style="color:#204a87;font-weight:bold">ENTRYPOINT</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;python&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;/download.py&#34;</span><span style="color:#000;font-weight:bold">]</span><span style="color:#a40000">
</span></span></span></code></pre></div><p>准备上述两个文件，然后执行</p>
<pre tabindex="0"><code>docker build -t test_download .
</code></pre><p>构建我们用于调试的镜像, <code>test_download</code> 。</p>
<h3 id="启动阻塞的容器">启动阻塞的容器</h3>
<p>执行以下命令，启动一个阻塞在网络请求中的容器。</p>
<pre tabindex="0"><code>docker run --rm test_download
</code></pre><blockquote>
<p><strong>Note</strong>:</p>
<p>这个例子不太好，因为 <code>releases.ubuntu.com</code> 还比较健康，会持续地返回内容，现实中我们遇到的情况是，服务器完全不返回内容，客户端也没有设置超时时间，完全处于阻塞的状态。</p>
</blockquote>
<h3 id="查找容器的-pid">查找容器的 pid</h3>
<p>根据容器的 ID, 我们通过 <code>docker inspect &lt;id&gt;| rg -i pid</code> 可以获得容器的进程 ID</p>
<p>如果你使用的是 containerd, 可以使用 <code>crictl inspect &lt;id&gt; | rg -i pid</code></p>
<pre tabindex="0"><code>ø&gt; docker ps
CONTAINER ID   IMAGE           COMMAND                 CREATED          STATUS          PORTS     NAMES
bf5846384913   test_download   &#34;python /download.py&#34;   37 seconds ago   Up 36 seconds             friendly_wozniak
ø&gt; docker inspect bf5846384913 | rg -i pid
            &#34;Pid&#34;: 726678,
            &#34;PidMode&#34;: &#34;&#34;,
            &#34;PidsLimit&#34;: null,
</code></pre><h3 id="利用-strace-查看进程的状态">利用 strace 查看进程的状态</h3>
<p>从 strace 的输出中可以看到，进程一直在从 3 号 fd 上读取数据</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>root@Macmini:~# strace -p <span style="color:#0000cf;font-weight:bold">726678</span>
</span></span><span style="display:flex;"><span>strace: Process <span style="color:#0000cf;font-weight:bold">726678</span> attached
</span></span><span style="display:flex;"><span>read<span style="color:#ce5c00;font-weight:bold">(</span>3, <span style="color:#4e9a06">&#34;Z\263\351\331\315\17\330\205\222\361\21\235&#39;Kp\301w\256\365|\275K\326y\350@\305\300\325\262\fk&#34;</span>..., 13131<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1448</span>
</span></span><span style="display:flex;"><span>read<span style="color:#ce5c00;font-weight:bold">(</span>3, <span style="color:#4e9a06">&#34;\317GKJ\324O)1\5\272\\\&#34;\24\360s\177\263\223#\376\360\35\360\226\240\214mf\374\243\222\335&#34;</span>..., 11683<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">11683</span>
</span></span><span style="display:flex;"><span>read<span style="color:#ce5c00;font-weight:bold">(</span>3, <span style="color:#4e9a06">&#34;\27\3\3@\21&#34;</span>, 5<span style="color:#ce5c00;font-weight:bold">)</span>               <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">5</span>
</span></span><span style="display:flex;"><span>read<span style="color:#ce5c00;font-weight:bold">(</span>3, <span style="color:#4e9a06">&#34;\22c\367U@\243\377\325\255\n0\376\79J\244\v9O4\233Kq\0233\304k\6\356dy\20&#34;</span>..., 16401<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">16401</span>
</span></span><span style="display:flex;"><span>read<span style="color:#ce5c00;font-weight:bold">(</span>3, <span style="color:#4e9a06">&#34;\27\3\3@\21&#34;</span>, 5<span style="color:#ce5c00;font-weight:bold">)</span>               <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">5</span>
</span></span><span style="display:flex;"><span>read<span style="color:#ce5c00;font-weight:bold">(</span>3, <span style="color:#4e9a06">&#34;[\244K\30\7\30?[\210\313\364\335\t\321&gt;l\270\2\365\262\307|\376\211.\376\342%\361\34\31\246&#34;</span>..., 16401<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">16401</span>
</span></span><span style="display:flex;"><span>read<span style="color:#ce5c00;font-weight:bold">(</span>3, <span style="color:#4e9a06">&#34;\27\3\3@\21&#34;</span>, 5<span style="color:#ce5c00;font-weight:bold">)</span>               <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">5</span>
</span></span><span style="display:flex;"><span>read<span style="color:#ce5c00;font-weight:bold">(</span>3, <span style="color:#4e9a06">&#34;\335\373\354\320:SF\244o#\244\377Ll\21\366AT\374vgYD\2418\305\340\313||\243;&#34;</span>..., 16401<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">16401</span>
</span></span><span style="display:flex;"><span>read<span style="color:#ce5c00;font-weight:bold">(</span>3, <span style="color:#4e9a06">&#34;\27\3\3@\21&#34;</span>, 5<span style="color:#ce5c00;font-weight:bold">)</span>               <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">5</span>
</span></span><span style="display:flex;"><span>read<span style="color:#ce5c00;font-weight:bold">(</span>3, <span style="color:#4e9a06">&#34;X \300\240\252IoZ\352W</span>$<span style="color:#4e9a06">\255\266\324\304q\306\23\226-b\212\300\271\222pI\270\33\tcn&#34;</span>..., 16401<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">16401</span>
</span></span><span style="display:flex;"><span>read<span style="color:#ce5c00;font-weight:bold">(</span>3, <span style="color:#4e9a06">&#34;\27\3\3@\21&#34;</span>, 5<span style="color:#ce5c00;font-weight:bold">)</span>               <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">5</span>
</span></span><span style="display:flex;"><span>read<span style="color:#ce5c00;font-weight:bold">(</span>3, <span style="color:#4e9a06">&#34;\213\331\225\331b\2405\204\f\213\32\r\250;\250\326.\4l\221\230^0\272{\317\32he\262V\223&#34;</span>..., 16401<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">16401</span>
</span></span><span style="display:flex;"><span>brk<span style="color:#ce5c00;font-weight:bold">(</span>0x55fba8f48000<span style="color:#ce5c00;font-weight:bold">)</span>                     <span style="color:#ce5c00;font-weight:bold">=</span> 0x55fba8f48000
</span></span><span style="display:flex;"><span>read<span style="color:#ce5c00;font-weight:bold">(</span>3, <span style="color:#4e9a06">&#34;\27\3\3@\21&#34;</span>, 5<span style="color:#ce5c00;font-weight:bold">)</span>               <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">5</span>
</span></span><span style="display:flex;"><span>read<span style="color:#ce5c00;font-weight:bold">(</span>3, <span style="color:#4e9a06">&#34;\4\317\362`-R}\360\&#34;\266nZ\33\261s,\340\345\371\300;]\347\30\237\344\305\235m\360j\357&#34;</span>..., 16401<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">16401</span>
</span></span><span style="display:flex;"><span>read<span style="color:#ce5c00;font-weight:bold">(</span>3, <span style="color:#4e9a06">&#34;\27\3\3@\21&#34;</span>, 5<span style="color:#ce5c00;font-weight:bold">)</span>               <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">5</span>
</span></span><span style="display:flex;"><span>read<span style="color:#ce5c00;font-weight:bold">(</span>3, <span style="color:#4e9a06">&#34;1v\355\312]nG\347\240\4\210\350\241\34\257\333\307\233z\261\0\6\307\2234n\21V\27\305\272\371&#34;</span>..., 16401<span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">16401</span>
</span></span><span style="display:flex;"><span>read<span style="color:#ce5c00;font-weight:bold">(</span>3, <span style="color:#4e9a06">&#34;\27\3\3@\21&#34;</span>, 5<span style="color:#ce5c00;font-weight:bold">)</span>               <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">5</span>
</span></span></code></pre></div><h3 id="利用-lsof-查看-fd-详细信息">利用 lsof 查看 fd 详细信息</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>nsenter -n -t <span style="color:#0000cf;font-weight:bold">726678</span> lsof -d <span style="color:#0000cf;font-weight:bold">3</span> -a -p <span style="color:#0000cf;font-weight:bold">726678</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>root@Macmini:~# nsenter -n -t <span style="color:#0000cf;font-weight:bold">726678</span> lsof -d <span style="color:#0000cf;font-weight:bold">3</span> -a -p <span style="color:#0000cf;font-weight:bold">726678</span>
</span></span><span style="display:flex;"><span>COMMAND    PID USER   FD   TYPE  DEVICE SIZE/OFF NODE NAME
</span></span><span style="display:flex;"><span>python  <span style="color:#0000cf;font-weight:bold">726678</span> root    3u  IPv4 <span style="color:#0000cf;font-weight:bold">9813984</span>      0t0  TCP 172.17.0.2:55378-&gt;https-services.aerodent.canonical.com:https <span style="color:#ce5c00;font-weight:bold">(</span>ESTABLISHED<span style="color:#ce5c00;font-weight:bold">)</span>
</span></span></code></pre></div><p>可以看到，3号fd 是一个TCP 连接，本地的 <code>172.17.0.2:55378</code> 连接了远端的 <code>https-services.aerodent.canonical.com:https</code></p>
<blockquote>
<p><strong>Note</strong></p>
<p>如果我们不加 nsenter -n -t <pid> 来切换 network namespace 的话，lsof 输出的信息中就没有详细的客户端和服务端的地址了</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>root@Macmini:~# lsof -d <span style="color:#0000cf;font-weight:bold">3</span> -a -p <span style="color:#0000cf;font-weight:bold">729160</span>
</span></span><span style="display:flex;"><span>COMMAND    PID USER   FD   TYPE DEVICE SIZE/OFF    NODE NAME
</span></span><span style="display:flex;"><span>python  <span style="color:#0000cf;font-weight:bold">729160</span> root    3u  sock    0,8      0t0 <span style="color:#0000cf;font-weight:bold">9829458</span> protocol: TCP
</span></span></code></pre></div><h2 id="参考链接">参考链接</h2>
<ul>
<li><a href="https://linux.die.net/man/8/lsof">man lsof</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-69dc1da95bd41a25bf26e181c6ed42e5">15.3 - DNS</h1>
    
	<h2 id="a-记录">A 记录</h2>
<p>Address Mapping records, 指示了对应名称的IPv4地址, A记录用来将域名转换为ip地址.</p>
<h2 id="aaaa-记录">AAAA 记录</h2>
<p>类似于A记录, 只不过指示的是IPv6的地址。</p>
<p>因为 IPv6 地址长度是 IPv4 的四倍，所以用 AAAA 表示 IPv6 记录</p>
<h2 id="ns-记录">NS 记录</h2>
<ul>
<li>Name Server records, 用来指定对应名称的可信名称服务器 (authoritative name server)</li>
</ul>
<p>例如这段 dig 日志是 <code>j.gtld-servers.net</code> 告诉我们，它不知道 <code>www.baidu.com</code> 的 IP, 但是它告诉我们要查询 <code>baidu.com.</code> 域的地址，可以去 ns[12345].baidu.com 这5个地址中查。</p>
<pre tabindex="0"><code>baidu.com.              172800  IN      NS      ns2.baidu.com.
baidu.com.              172800  IN      NS      ns3.baidu.com.
baidu.com.              172800  IN      NS      ns4.baidu.com.
baidu.com.              172800  IN      NS      ns1.baidu.com.
baidu.com.              172800  IN      NS      ns7.baidu.com.
;; Received 849 bytes from 192.48.79.30#53(j.gtld-servers.net) in 316 ms
</code></pre><h2 id="ptr-记录">PTR 记录</h2>
<p>Pointer records, 通过 IP 反查域名，大部分域名服务器都不支持，目前只找到了 <code>dns.google.</code> 支持 PTR 查询</p>
<pre tabindex="0"><code>ø&gt; dig -x 8.8.4.4

;; QUESTION SECTION:
;4.4.8.8.in-addr.arpa.          IN      PTR

;; ANSWER SECTION:
4.4.8.8.in-addr.arpa.   1       IN      PTR     dns.google.
</code></pre><h2 id="cname-记录">CNAME 记录</h2>
<p>又称 alias 别名，是 A 记录的别名</p>
<p>例如以下的查询说明</p>
<ol>
<li><code>www.baidu.com.</code> 是 <code>www.a.shifen.com.</code> 的别名</li>
<li><code>www.a.shifen.com.</code> 指向了 <code>220.181.38.150</code> 和 <code>220.181.38.149</code></li>
</ol>
<pre tabindex="0"><code>ø&gt; dig -4 www.baidu.com

;; QUESTION SECTION:
;www.baidu.com.                 IN      A

;; ANSWER SECTION:
www.baidu.com.          70      IN      CNAME   www.a.shifen.com.
www.a.shifen.com.       53      IN      A       220.181.38.150
www.a.shifen.com.       53      IN      A       220.181.38.149
</code></pre><h2 id="查询方式">查询方式</h2>
<h3 id="递归查询">递归查询</h3>
<p>client 发送请求给局域网 DNS, 局域网 DNS 再去上游 DNS 服务器执行进一步查询。一级一级向上递归并回到局域网 DNS , 局域网 DNS 将查询的地址返回给客户端</p>
<p>dig 命令默认执行的就是递归查询</p>
<h3 id="集中查询">集中查询</h3>
<ol>
<li>client 发送请求给局域网 DNS 获得 DNS 根服务器的地址</li>
<li>client 请求根服务器获得下一级 DNS 服务器地址</li>
<li>以此往复，一级一级直到查到目标域名的 IP 地址</li>
</ol>
<p>以下用集中查询的方式查询 <a href="https://www.baidu.com">www.baidu.com</a> IP 地址的过程</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>ø&gt; dig -4 +trace www.baidu.com
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 获取根服务器的名字列表</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;</span> &lt;&lt;&gt;&gt; DiG 9.18.12-0ubuntu0.22.04.2-Ubuntu &lt;&lt;&gt;&gt; -4 +trace www.baidu.com
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;;</span> global options: +cmd
</span></span><span style="display:flex;"><span>.                       <span style="color:#0000cf;font-weight:bold">2229</span>    IN      NS      k.root-servers.net.
</span></span><span style="display:flex;"><span>.                       <span style="color:#0000cf;font-weight:bold">2229</span>    IN      NS      b.root-servers.net.
</span></span><span style="display:flex;"><span>.                       <span style="color:#0000cf;font-weight:bold">2229</span>    IN      NS      h.root-servers.net.
</span></span><span style="display:flex;"><span>.                       <span style="color:#0000cf;font-weight:bold">2229</span>    IN      NS      i.root-servers.net.
</span></span><span style="display:flex;"><span>.                       <span style="color:#0000cf;font-weight:bold">2229</span>    IN      NS      l.root-servers.net.
</span></span><span style="display:flex;"><span>.                       <span style="color:#0000cf;font-weight:bold">2229</span>    IN      NS      c.root-servers.net.
</span></span><span style="display:flex;"><span>.                       <span style="color:#0000cf;font-weight:bold">2229</span>    IN      NS      a.root-servers.net.
</span></span><span style="display:flex;"><span>.                       <span style="color:#0000cf;font-weight:bold">2229</span>    IN      NS      d.root-servers.net.
</span></span><span style="display:flex;"><span>.                       <span style="color:#0000cf;font-weight:bold">2229</span>    IN      NS      e.root-servers.net.
</span></span><span style="display:flex;"><span>.                       <span style="color:#0000cf;font-weight:bold">2229</span>    IN      NS      m.root-servers.net.
</span></span><span style="display:flex;"><span>.                       <span style="color:#0000cf;font-weight:bold">2229</span>    IN      NS      f.root-servers.net.
</span></span><span style="display:flex;"><span>.                       <span style="color:#0000cf;font-weight:bold">2229</span>    IN      NS      g.root-servers.net.
</span></span><span style="display:flex;"><span>.                       <span style="color:#0000cf;font-weight:bold">2229</span>    IN      NS      j.root-servers.net.
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;;</span> Received <span style="color:#0000cf;font-weight:bold">239</span> bytes from 10.8.0.1#53<span style="color:#ce5c00;font-weight:bold">(</span>10.8.0.1<span style="color:#ce5c00;font-weight:bold">)</span> in <span style="color:#0000cf;font-weight:bold">4</span> ms
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 根服务器返回通用定义域名的名字列表</span>
</span></span><span style="display:flex;"><span>com.                    <span style="color:#0000cf;font-weight:bold">172800</span>  IN      NS      a.gtld-servers.net.
</span></span><span style="display:flex;"><span>com.                    <span style="color:#0000cf;font-weight:bold">172800</span>  IN      NS      b.gtld-servers.net.
</span></span><span style="display:flex;"><span>com.                    <span style="color:#0000cf;font-weight:bold">172800</span>  IN      NS      c.gtld-servers.net.
</span></span><span style="display:flex;"><span>com.                    <span style="color:#0000cf;font-weight:bold">172800</span>  IN      NS      d.gtld-servers.net.
</span></span><span style="display:flex;"><span>com.                    <span style="color:#0000cf;font-weight:bold">172800</span>  IN      NS      e.gtld-servers.net.
</span></span><span style="display:flex;"><span>com.                    <span style="color:#0000cf;font-weight:bold">172800</span>  IN      NS      f.gtld-servers.net.
</span></span><span style="display:flex;"><span>com.                    <span style="color:#0000cf;font-weight:bold">172800</span>  IN      NS      g.gtld-servers.net.
</span></span><span style="display:flex;"><span>com.                    <span style="color:#0000cf;font-weight:bold">172800</span>  IN      NS      h.gtld-servers.net.
</span></span><span style="display:flex;"><span>com.                    <span style="color:#0000cf;font-weight:bold">172800</span>  IN      NS      i.gtld-servers.net.
</span></span><span style="display:flex;"><span>com.                    <span style="color:#0000cf;font-weight:bold">172800</span>  IN      NS      j.gtld-servers.net.
</span></span><span style="display:flex;"><span>com.                    <span style="color:#0000cf;font-weight:bold">172800</span>  IN      NS      k.gtld-servers.net.
</span></span><span style="display:flex;"><span>com.                    <span style="color:#0000cf;font-weight:bold">172800</span>  IN      NS      l.gtld-servers.net.
</span></span><span style="display:flex;"><span>com.                    <span style="color:#0000cf;font-weight:bold">172800</span>  IN      NS      m.gtld-servers.net.
</span></span><span style="display:flex;"><span>com.                    <span style="color:#0000cf;font-weight:bold">86400</span>   IN      DS      <span style="color:#0000cf;font-weight:bold">30909</span> <span style="color:#0000cf;font-weight:bold">8</span> <span style="color:#0000cf;font-weight:bold">2</span> E2D3C916F6DEEAC73294E8268FB5885044A833FC5459588F4A9184CF C41A5766
</span></span><span style="display:flex;"><span>com.                    <span style="color:#0000cf;font-weight:bold">86400</span>   IN      RRSIG   DS <span style="color:#0000cf;font-weight:bold">8</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#0000cf;font-weight:bold">86400</span> <span style="color:#0000cf;font-weight:bold">20230921210000</span> <span style="color:#0000cf;font-weight:bold">20230908200000</span> <span style="color:#0000cf;font-weight:bold">11019</span> . M02FKEukwDc7T/KjNtpdCfwvkzHx1STqPt3AO/eXQxqBU7jN9vrHbJMJ PNXpBlO5p+HgnZ9w0c7sR8qnDXFl1OziNAo0el1fRq0YFwBae9BgoLCg IeZVoZmqerXpVXCrpKX1Fb+ILjuIX1bL5li2xQ/gpq4u91EijGvZg6sQ UmBiQW0JlXKR927uOm+aJHN6Ujnzd7sZrOWpSXQAOVPf4dHjvCJNohfs V9cJkjBRI+QuOpArJ+gCGKoiMidjYZBuYXIsYV7PYLQbVfVZg2E3JFXX h5BkqZUlCZbabAcVCzQ6BGZMpxcs1A/J8g/7+eguU6bJFpbiBXeHEZhx <span style="color:#000">TS1zoQ</span><span style="color:#ce5c00;font-weight:bold">==</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;;</span> Received <span style="color:#0000cf;font-weight:bold">1173</span> bytes from 192.58.128.30#53<span style="color:#ce5c00;font-weight:bold">(</span>j.root-servers.net<span style="color:#ce5c00;font-weight:bold">)</span> in <span style="color:#0000cf;font-weight:bold">8</span> ms
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 通用顶级域名返回 baidu.com. 域的 DNS 服务器名字列表</span>
</span></span><span style="display:flex;"><span>baidu.com.              <span style="color:#0000cf;font-weight:bold">172800</span>  IN      NS      ns2.baidu.com.
</span></span><span style="display:flex;"><span>baidu.com.              <span style="color:#0000cf;font-weight:bold">172800</span>  IN      NS      ns3.baidu.com.
</span></span><span style="display:flex;"><span>baidu.com.              <span style="color:#0000cf;font-weight:bold">172800</span>  IN      NS      ns4.baidu.com.
</span></span><span style="display:flex;"><span>baidu.com.              <span style="color:#0000cf;font-weight:bold">172800</span>  IN      NS      ns1.baidu.com.
</span></span><span style="display:flex;"><span>baidu.com.              <span style="color:#0000cf;font-weight:bold">172800</span>  IN      NS      ns7.baidu.com.
</span></span><span style="display:flex;"><span>CK0POJMG874LJREF7EFN8430QVIT8BSM.com. <span style="color:#0000cf;font-weight:bold">86400</span> IN NSEC3 <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#0000cf;font-weight:bold">0</span> - CK0Q2D6NI4I7EQH8NA30NS61O48UL8G5 NS SOA RRSIG DNSKEY NSEC3PARAM
</span></span><span style="display:flex;"><span>CK0POJMG874LJREF7EFN8430QVIT8BSM.com. <span style="color:#0000cf;font-weight:bold">86400</span> IN RRSIG NSEC3 <span style="color:#0000cf;font-weight:bold">8</span> <span style="color:#0000cf;font-weight:bold">2</span> <span style="color:#0000cf;font-weight:bold">86400</span> <span style="color:#0000cf;font-weight:bold">20230915042421</span> <span style="color:#0000cf;font-weight:bold">20230908031421</span> <span style="color:#0000cf;font-weight:bold">4459</span> com. ACWanRvoDIwYH40J5TjA8G6UXUldpz8+aNZdFlLO1eY9GRalvfLnpa6H RqiP03pvORSpHJEv2+HuQ1HtWTCj/nlJOeiRKG0Bk/HjcjkH9yv1b6pF ASeyvdJYN2wYPp4e1KPVe3GuoxBETq6kPKfUhR289IzQFy5vLgIfeVWK <span style="color:#000">pR6z0kgCFKTKaO21nj2LxxWsxmfuIpe8ztJuPTF7lVhXhw</span><span style="color:#ce5c00;font-weight:bold">==</span>
</span></span><span style="display:flex;"><span>HPVV0C47Q7CQMTAJM90K1FBFJBRP4B4D.com. <span style="color:#0000cf;font-weight:bold">86400</span> IN NSEC3 <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#0000cf;font-weight:bold">0</span> - HPVVAN8CFKHHHMEIDVJHFNQEOI5G6C89 NS DS RRSIG
</span></span><span style="display:flex;"><span>HPVV0C47Q7CQMTAJM90K1FBFJBRP4B4D.com. <span style="color:#0000cf;font-weight:bold">86400</span> IN RRSIG NSEC3 <span style="color:#0000cf;font-weight:bold">8</span> <span style="color:#0000cf;font-weight:bold">2</span> <span style="color:#0000cf;font-weight:bold">86400</span> <span style="color:#0000cf;font-weight:bold">20230914060727</span> <span style="color:#0000cf;font-weight:bold">20230907045727</span> <span style="color:#0000cf;font-weight:bold">4459</span> com. oUS/iAWQKq/0KHQdg18vwuUvT1Ftl8tnpHZVCwdQPEaIq3gceZnmpE2Z u8pj+JPFOUqp/DWRNlWZYMmTuhSjJil7cCpahWk3+RJbeJQIWPtNvBkl BBmM1M3he1ELoS37YqcflA8U/q4CaNdEpIS7OiNy6f4efrkZMvqRZZ9U hRgI2CugaGb6C9mDeAfThooAqsc5xFCX9KjWGsNLr0pE+Q<span style="color:#ce5c00;font-weight:bold">==</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;;</span> Received <span style="color:#0000cf;font-weight:bold">849</span> bytes from 192.48.79.30#53<span style="color:#ce5c00;font-weight:bold">(</span>j.gtld-servers.net<span style="color:#ce5c00;font-weight:bold">)</span> in <span style="color:#0000cf;font-weight:bold">316</span> ms
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># ns3.baidu.com 返回 www.baidu.com 的解析结果</span>
</span></span><span style="display:flex;"><span>www.baidu.com.          <span style="color:#0000cf;font-weight:bold">1200</span>    IN      CNAME   www.a.shifen.com.
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">;;</span> Received <span style="color:#0000cf;font-weight:bold">100</span> bytes from 153.3.238.93#53<span style="color:#ce5c00;font-weight:bold">(</span>ns3.baidu.com<span style="color:#ce5c00;font-weight:bold">)</span> in <span style="color:#0000cf;font-weight:bold">24</span> ms
</span></span></code></pre></div><p>这是集中查询的抓包过程(建议在新 tab 中打开图片对比说明查看)</p>
<p><img src="https://passage-1253400711.cos.ap-beijing.myqcloud.com/2023-09-09-143516.png" alt=""></p>
<table>
<thead>
<tr>
<th>包序号</th>
<th>包功能</th>
</tr>
</thead>
<tbody>
<tr>
<td>1, 2</td>
<td>从 10.8.0.1 DNS 服务器获得根服务器的地址</td>
</tr>
<tr>
<td>3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 24, 25, 26</td>
<td>向 192.168.1.1 和 10.8.0.1 查询根服务器的地址 (两个网卡都发送了查询请求)</td>
</tr>
<tr>
<td>14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 28, 29, 30, 31</td>
<td>10.8.0.1 和 192.168.1.1 返回 DNS 根服务器地址</td>
</tr>
<tr>
<td>26</td>
<td>向根服务器 <code>g.root-servers.net.</code> 查询 <code>www.baidu.com.</code> 的地址</td>
</tr>
<tr>
<td>32</td>
<td>根服务器 <code>g.root-servers.net.</code> 返回通用顶级域名列表及其地址 <code>[a-j].gtld-servers.net</code></td>
</tr>
<tr>
<td>33, 34, 35, 36, 37, 38, 39, 40, 42, 43, 44, 45</td>
<td>向 10.8.0.1 查询通用顶级域名的 IP</td>
</tr>
<tr>
<td>47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59</td>
<td>10.8.0.1 返回通用顶级域名的 IP</td>
</tr>
<tr>
<td>46</td>
<td>向通用顶级域名 DNS server <code>i.gtld-servers.net</code> 查询 <a href="https://www.baidu.com">www.baidu.com</a> 的 IP</td>
</tr>
<tr>
<td>60</td>
<td><code>i.gtld-servers.net</code> DNS返回 <code>baidu.com.</code> 域的 DNS 服务器 <code>ns[12347].baidu.com</code> 的名字</td>
</tr>
<tr>
<td>61, 62, 63, 64, 65, 69</td>
<td>向 192.168.1.1 和 10.8.0.1 查询 <code>ns[12347].baidu.com</code> 的 IP</td>
</tr>
<tr>
<td>66,67,68,71,72,73</td>
<td>192.168.1.1 和 10.8.0.1 返回 <code>ns[12347].baidu.com</code> 的 IP</td>
</tr>
<tr>
<td>70</td>
<td>向 <code>ns2.baidu.com</code> 查询 <code>www.baidu.com</code> 的地址</td>
</tr>
<tr>
<td>74</td>
<td><code>ns2.baidu.com</code> 返回 <code>www.baidu.com</code> 的地址，它是 <code>www.a.shifen.com</code> 地址的别名</td>
</tr>
</tbody>
</table>
<h2 id="参考链接">参考链接</h2>
<ul>
<li><a href="https://www.cnblogs.com/pannengzhi/p/6262076.html">关于DNS,你应该知道这些</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-634110a9992b6264c18b7b4beda6f789">15.4 - 在 Ubuntu 22.04 上搭建 NFS Server</h1>
    
	<h2 id="环境准备">环境准备</h2>
<p>我准备了两台机器</p>
<table>
<thead>
<tr>
<th>name</th>
<th>ip</th>
<th>user</th>
<th>user_id</th>
</tr>
</thead>
<tbody>
<tr>
<td>server</td>
<td>191.168.58.11</td>
<td>vagrant</td>
<td>1000</td>
</tr>
<tr>
<td>client</td>
<td>192.168.58.1</td>
<td>xuyundong</td>
<td>1000</td>
</tr>
</tbody>
</table>
<h2 id="安装组件">安装组件</h2>
<ul>
<li>服务端安装 nfs server</li>
</ul>
<pre tabindex="0"><code>sudo apt update
sudo apt install nfs-kernel-server
</code></pre><ul>
<li>客户端安装 nfs-common</li>
</ul>
<pre tabindex="0"><code>sudo apt update
sudo apt install nfs-common
</code></pre><h2 id="服务端创建目录并导出">服务端创建目录并导出</h2>
<h3 id="在服务端上创建挂载目录并设置权限">在服务端上创建挂载目录，并设置权限</h3>
<pre tabindex="0"><code>sudo mkdir -p /mnt/share
sudo chown vagrant:vagrant /mnt/share
sudo chmod 755 /mnt/share
</code></pre><h3 id="服务端上配置-nfs-export-目录">服务端上配置 nfs export 目录</h3>
<p>修改 <code>/etc/exports</code> 文件, 加入以下内容</p>
<pre tabindex="0"><code>/mnt/share       *(rw,async,no_subtree_check)
</code></pre><p>关于 export 选项的解释</p>
<ul>
<li><code>rw</code>: 客户端具有读和写的权限</li>
<li><code>sync</code>: 强制 nfs 在回复 client 之前将更改写入磁盘，这保证了 nfs server 的可靠性，但也降低了写入速度</li>
<li><code>no_subtree_check</code>: 此选项可防止子树检查，在子树检查过程中，主机必须为每个请求检查文件在导出的树中是否仍然可用。当客户端打开文件时重命名文件时，这可能会导致许多问题。<strong>通常建议禁用子树检查</strong>。</li>
<li><code>no_root_squash</code>: 当客户端以 root 权限写入文件时，nfs server 会将文件 owner 改成普通用户，当此选项开启时，nfs server 不修改 root 写入文件的 woner</li>
</ul>
<p>修改完以后执行以下命令载入配置</p>
<pre tabindex="0"><code>sudo systemctl restart nfs-kernel-server
</code></pre><h2 id="客户端挂载">客户端挂载</h2>
<p>客户端执行以下命令挂载</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 将服务端的 nfs 目录挂载到了客户端的 /home/xuyundong/tmp/nfs_exmaple 中</span>
</span></span><span style="display:flex;"><span>sudo mount 192.168.58.11:/mnt/share /home/xuyundong/tmp/nfs_exmaple
</span></span></code></pre></div><p>修改 <code>/etc/fstab</code> 文件，将以下内容写入可以让 client 在开机启动时自动挂载</p>
<pre tabindex="0"><code>192.168.58.11:/mnt/share   /home/xuyundong/tmp/nfs_exmaple   nfs auto,nofail,noatime,nolock,intr,tcp,actimeo=1800 0 0
</code></pre><h2 id="测试访问">测试访问</h2>
<p>在客户端的目录中，<strong>以 uid=1000 的用户执行</strong></p>
<pre tabindex="0"><code>echo &#34;abc&#34; &gt; test.txt
</code></pre><p>可以看到文件正常写入了。</p>
<p>这是因为 client 的写入的用户的 uid 是 1000, server 中目录的 owner 的 uid 也是 1000, owner 相同就能正常写入。</p>
<h2 id="取消挂载">取消挂载</h2>
<p>客户端执行以下命令可以取消挂载</p>
<pre tabindex="0"><code>sudo umount ~/tmp/nfs_exmaple
</code></pre><h2 id="参考链接">参考链接</h2>
<ul>
<li><a href="https://www.digitalocean.com/community/tutorials/how-to-set-up-an-nfs-mount-on-ubuntu-22-04">How To Set Up an NFS Mount on Ubuntu 22.04</a></li>
</ul>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-d666840fe7c4f359e7566250aad67c80">15.5 - 查看信号的快捷键</h1>
    
	<hr>
<h2 id="tips">Tips</h2>
<p><code>stty</code>命令的作用是 <code>change and print terminal line settings</code>，查看或修改 Linux 终端的配置。</p>
<p>今天遇到的需求是想查一下 <code>Ctrl-C</code> 按键发送的系统信号 ( <a href="https://man7.org/linux/man-pages/man7/signal.7.html">man 7 signal</a> )，搜了一下发现 stty 是最方便的查询命令</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>ø&gt; stty -a
</span></span><span style="display:flex;"><span>speed <span style="color:#0000cf;font-weight:bold">38400</span> baud<span style="color:#000;font-weight:bold">;</span> rows 68<span style="color:#000;font-weight:bold">;</span> columns 128<span style="color:#000;font-weight:bold">;</span> <span style="color:#000">line</span> <span style="color:#ce5c00;font-weight:bold">=</span> 0<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">####################  我们主要关心这两行的内容</span>
</span></span><span style="display:flex;"><span><span style="color:#000">intr</span> <span style="color:#ce5c00;font-weight:bold">=</span> ^C<span style="color:#000;font-weight:bold">;</span> <span style="color:#000">quit</span> <span style="color:#ce5c00;font-weight:bold">=</span> ^<span style="color:#4e9a06">\;</span> <span style="color:#000">erase</span> <span style="color:#ce5c00;font-weight:bold">=</span> ^?<span style="color:#000;font-weight:bold">;</span> <span style="color:#204a87">kill</span> <span style="color:#ce5c00;font-weight:bold">=</span> ^U<span style="color:#000;font-weight:bold">;</span> <span style="color:#000">eof</span> <span style="color:#ce5c00;font-weight:bold">=</span> ^D<span style="color:#000;font-weight:bold">;</span> <span style="color:#000">eol</span> <span style="color:#ce5c00;font-weight:bold">=</span> &lt;undef&gt;<span style="color:#000;font-weight:bold">;</span> <span style="color:#000">eol2</span> <span style="color:#ce5c00;font-weight:bold">=</span> &lt;undef&gt;<span style="color:#000;font-weight:bold">;</span> <span style="color:#000">swtch</span> <span style="color:#ce5c00;font-weight:bold">=</span> &lt;undef&gt;<span style="color:#000;font-weight:bold">;</span> <span style="color:#000">start</span> <span style="color:#ce5c00;font-weight:bold">=</span> ^Q<span style="color:#000;font-weight:bold">;</span> <span style="color:#000">stop</span> <span style="color:#ce5c00;font-weight:bold">=</span> ^S<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#000">susp</span> <span style="color:#ce5c00;font-weight:bold">=</span> ^Z<span style="color:#000;font-weight:bold">;</span> <span style="color:#000">rprnt</span> <span style="color:#ce5c00;font-weight:bold">=</span> ^R<span style="color:#000;font-weight:bold">;</span> <span style="color:#000">werase</span> <span style="color:#ce5c00;font-weight:bold">=</span> ^W<span style="color:#000;font-weight:bold">;</span> <span style="color:#000">lnext</span> <span style="color:#ce5c00;font-weight:bold">=</span> ^V<span style="color:#000;font-weight:bold">;</span> <span style="color:#000">discard</span> <span style="color:#ce5c00;font-weight:bold">=</span> ^O<span style="color:#000;font-weight:bold">;</span> <span style="color:#000">min</span> <span style="color:#ce5c00;font-weight:bold">=</span> 1<span style="color:#000;font-weight:bold">;</span> <span style="color:#204a87">time</span> <span style="color:#ce5c00;font-weight:bold">=</span> 0<span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">####################</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>-parenb -parodd -cmspar cs8 -hupcl -cstopb cread -clocal -crtscts
</span></span><span style="display:flex;"><span>-ignbrk -brkint -ignpar -parmrk -inpck -istrip -inlcr -igncr icrnl -ixon -ixoff -iuclc -ixany -imaxbel -iutf8
</span></span><span style="display:flex;"><span>opost -olcuc -ocrnl onlcr -onocr -onlret -ofill -ofdel nl0 cr0 tab0 bs0 vt0 ff0
</span></span><span style="display:flex;"><span>isig icanon iexten <span style="color:#204a87">echo</span> echoe echok -echonl -noflsh -xcase -tostop -echoprt echoctl echoke -flusho -extproc
</span></span></code></pre></div><p>stty 输出的解释如下:</p>
<ul>
<li><code>^C</code> (<code>ctrl+c</code>) 发送 interrupt 信号</li>
<li><code>^\</code> (<code>ctr+\</code>) 发送 quit 信号</li>
<li><code>^?</code> 清除上一个输入的字符</li>
<li><code>^U</code> 删除当前行</li>
<li><code>^D</code> 输入 EOF 字符(结束当前输入)</li>
<li><code>^S</code> 暂停输出</li>
<li><code>^Q</code> 在暂停输出后，重新开始输出</li>
<li><code>^Z</code> 发送一个 terminal stop 信号</li>
<li><code>^W</code> 删除最近输入的一个单词</li>
</ul>
<pre tabindex="0"><code>while true;do
    date;
    sleep 1
done
</code></pre><ul>
<li>(我用上面的代码测试 <code>^S</code> 和 <code>^Q</code>, 发现不生效)</li>
</ul>
<p>stty 其他输入的含义，请参考 <a href="https://linux.die.net/man/1/stty">man 1 stty</a></p>
<h2 id="参考链接">参考链接</h2>
<ul>
<li><a href="https://unix.stackexchange.com/a/362579/191858">List of terminal generated signals (eg Ctrl-C -&gt; SIGINT)</a></li>
<li><a href="https://linux.die.net/man/1/stty">man 1 stty</a></li>
</ul>
</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-729348d4b27273c38fd9756aca09119c">15.6 - 修复 Ubuntu 中 chrome vimium-c 插件失效的问题</h1>
    
	<blockquote>
<p>记录一次折腾 Ubuntu 的经历</p>
</blockquote>
<hr>
<p>下午升级了 Ubuntu 的一些软件之后，发现 Chrome 中的 vimium-c 插件失效了，按 k 不会向上滑动，而是像按下 tab 按键一样，选中 url 链接。weasd 等字符也是一样，同时飞书中输入不了 wkeasd 等字符。</p>
<h2 id="排查-vimium-c">排查 vimium-c</h2>
<p>最开始以为是 vimium-c 软件的 bug，于是去 github 中提 Issue。<a href="https://github.com/gdh1995/vimium-c/issues/558">#558</a></p>
<p>和作者排查了半天，使用作者提供了 <a href="https://gdh1995.cn/vimium-c/keyboard-test.html">keyboard-test</a> 工具检查按键能否正常工作，最后得出的结论是，</p>
<ol>
<li>使用 firefox, chromium 等浏览器依然会遇到这个问题</li>
<li>换一个用户后，这个问题就解决了。</li>
</ol>
<p>由此我认定一定是我的系统配置有问题，和浏览器无关。于是开始排查系统配置</p>
<h2 id="排查按键映射">排查按键映射</h2>
<p>一开始以为是 <code>xmodmap</code> 设置的问题，因为我用 <code>xmodmap</code> 改过键，将 caps-lock 改成了 Esc。</p>
<p>但是查了半天，发现我原来是用 <code>dconf</code> 改的，并不是用 <code>xmodmap</code>，我把 <code>dconf</code> 中的改键配置删除后，vimium-c 仍然不工作。</p>
<p>此时我就很无力了，用 <code>ls -al ~/</code> 和 <code>ls -al ~/.config</code> 反复看 HOME 目录下的配置文件，反复想可能是哪个配置文件导致的问题。</p>
<h2 id="最终定位问题">最终定位问题</h2>
<p>后来一想，既然这个问题能够复现，燕过留痕，肯定有个进程拦截了这些按键的事件，导致 chrome 出错了。排查进程比排查配置文件范围小了很多，就开始排查进程。</p>
<p>于是用 <code>ps aufx</code> 查看所有进程，一个一个地排查所有的进程。</p>
<p>最后发现罪魁祸首是 <code>orca</code>(Ubuntu 下屏幕阅读功能的进程) 进程，关掉 Ubuntu 阅读屏幕的辅助功能后，chrome 中就能够正常捕获这些按键的事件了。</p>
<h2 id="参考链接">参考链接</h2>
<ul>
<li><a href="https://github.com/gdh1995/vimium-c/issues/558">https://github.com/gdh1995/vimium-c/issues/558</a></li>
<li><a href="https://manpages.ubuntu.com/manpages/bionic/man1/orca.1.html">https://manpages.ubuntu.com/manpages/bionic/man1/orca.1.html</a></li>
</ul>
</div>



    
	
  

    
	
  



          </main>
        </div>
      </div>
      <footer class="td-footer row d-print-none">
  <div class="container-fluid">
    <div class="row mx-md-2">
      <div class="col-6 col-sm-4 text-xs-center order-sm-2">
        
        
        
      </div>
      <div class="col-6 col-sm-4 text-end text-xs-center order-sm-3">
        
        
        
<ul class="td-footer__links-list">
  
  <li class="td-footer__links-item" data-bs-toggle="tooltip" title="GitHub" aria-label="GitHub">
    <a target="_blank" rel="noopener" href="https://github.com/bwangelme/" aria-label="GitHub">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="td-footer__copyright-etc col-12 col-sm-4 text-center py-2 order-sm-2">
        <span>&copy; 2023 力行近乎仁，好问近乎智，知耻近乎勇 </span>
        <span class="ms-1"><a href="https://policies.google.com/privacy" target="_blank" rel="noopener"></a></span>
        
      </div>
    </div>
  </div>
</footer>
    </div>
    
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css"
      integrity="sha512-mQwom8Ns4op+H29oDkD/LXO/OsXPvCFfkgZkFAVrhhePzRLU8NUI3Nkm43NhWUSmj3p5Cca2HTEkMQmXQRwDQQ==" crossorigin="anonymous">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.js"
        integrity="sha512-sHSNLECRJSK+BFs7E8DiFc6pf6n90bLI85Emiw1jhreduZhK3VXgq9l4kAt9eTIHYAcuQBKHL01QKs4/3Xgl8g=="
        crossorigin="anonymous">
</script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/contrib/auto-render.min.js"
       integrity="sha512-iWiuBS5nt6r60fCz26Nd0Zqe0nbk1ZTIQbl3Kv7kYsX+yKMUFHzjaH2+AnM6vp2Xs+gNmaBAVWJjSmuPw76Efg==" crossorigin="anonymous"
       onload='renderMathInElement(document.body, null);'>
</script>
<script src="/647/js/main.min.6f5832c0d01e88c997eeb57e6b773ea3e1ac128fdf53739b3c750242f2355881.js" integrity="sha256-b1gywNAeiMmX7rV&#43;a3c&#43;o&#43;GsEo/fU3ObPHUCQvI1WIE=" crossorigin="anonymous"></script>
<script src='/647/js/prism.js'></script>
<script src='/647/js/tabpane-persist.js'></script>

  </body>
</html>
